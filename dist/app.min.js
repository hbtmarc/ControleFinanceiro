window.populateSelect=function(selectId,items,iconSpanSelector){try{const sel=document.getElementById(selectId);if (!sel) return;sel.innerHTML='';(items || []).forEach(it=>{const opt=document.createElement('option');opt.value=it.value;opt.textContent=it.label;opt.dataset.icon=it.icon || '';sel.appendChild(opt);});const iconSpan=sel.parentElement ? sel.parentElement.querySelector(iconSpanSelector) : null;const updateIcon=()=>{try{const cur=sel.options[sel.selectedIndex];if (iconSpan && cur && cur.dataset.icon){iconSpan.textContent=cur.dataset.icon;iconSpan.classList.add('material-symbols-outlined');}}catch(e){}};try{sel.addEventListener('change',updateIcon);}catch(e){}try{updateIcon();}catch(e){}}catch (e){console.error('early populateSelect error',e);}};try{if (typeof populateSelect==='undefined'){function populateSelect(selectId,items,iconSpanSelector){return window.populateSelect(selectId,items,iconSpanSelector);}}}catch(e){}window.mobileUtils={isMobile: function(){return window.innerWidth <=768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);},isSmartphone: function(){return window.innerWidth <=480;},isTablet: function(){return window.innerWidth > 480 && window.innerWidth <=768;},isTouch: function(){return 'ontouchstart' in window || navigator.maxTouchPoints > 0;},preventDoubleTapZoom: function(){let lastTouchEnd=0;document.addEventListener('touchend',function(event){const now=Date.now();if (now - lastTouchEnd <=300 && !event.target.matches('input,textarea,select')){event.preventDefault();}lastTouchEnd=now;},{passive: false});},fixIOSViewportHeight: function(){const setHeight=()=>{const vh=window.innerHeight * 0.01;document.documentElement.style.setProperty('--vh',`${vh}px`);};setHeight();window.addEventListener('resize',setHeight);window.addEventListener('orientationchange',setHeight);},optimizeTouchScroll: function(){document.querySelectorAll('dialog,.modal,[role="dialog"]').forEach(element=>{element.style.webkitOverflowScrolling='touch';});},addMobileClass: function(){if (this.isMobile()){document.body.classList.add('is-mobile');}if (this.isSmartphone()){document.body.classList.add('is-smartphone');}if (this.isTablet()){document.body.classList.add('is-tablet');}if (this.isTouch()){document.body.classList.add('is-touch');}},init: function(){this.addMobileClass();this.fixIOSViewportHeight();if (this.isTouch()){this.preventDoubleTapZoom();this.optimizeTouchScroll();}window.addEventListener('resize',()=>{document.body.classList.remove('is-mobile','is-smartphone','is-tablet');this.addMobileClass();});}};if (document.readyState==='loading'){document.addEventListener('DOMContentLoaded',()=> window.mobileUtils.init());}else{window.mobileUtils.init();}function updateModalTypeUI(type){function normalizeType(t){if (!t) return 'expenses';t=String(t).toLowerCase();if (t==='savings' || t==='reserve' || t==='savings' || t==='saving') return 'reserve';if (t==='incomes' || t==='income' || t==='entrada' || t==='in') return 'incomes';if (t==='expenses' || t==='expense' || t==='despesa' || t==='out') return 'expenses';return t;}const normType=normalizeType(type);const indicator=document.getElementById('modal-type-indicator');const btns=document.querySelectorAll('.modal-type-toggle');const t=normType;btns.forEach(btn=>{btn.classList.remove('selected');const btnTypeNorm=normalizeType(btn.dataset.type);if (btnTypeNorm===normType){btn.classList.add('selected');let icon=btn.querySelector('.material-symbols-outlined').outerHTML;let label=btn.querySelector('span:last-child').textContent;indicator.innerHTML=icon + ' ' + label;}});btns.forEach(b=>{b.style.borderColor='';b.style.background='';const iconEl=b.querySelector('.material-symbols-outlined');const textEl=b.querySelector('span.text-sm') || b.querySelector('span:last-child');if (iconEl) iconEl.style.color='';if (textEl) textEl.style.color='';if (b.classList.contains('selected')){if (t==='incomes'){b.style.borderColor='#16a34a';b.style.background='#d1fae5';if (iconEl) iconEl.style.color='#16a34a';if (textEl) textEl.style.color='#16a34a';}else if (t==='expenses'){b.style.borderColor='#dc2626';b.style.background='#fee2e2';if (iconEl) iconEl.style.color='#dc2626';if (textEl) textEl.style.color='#dc2626';}else{b.style.borderColor='#eab308';b.style.background='#fef9c3';if (iconEl) iconEl.style.color='#eab308';if (textEl) textEl.style.color='#eab308';}}});const saveBtn=document.getElementById('modal-save-btn');const saveIcon=document.getElementById('modal-save-icon');function setupValueListeners(container){var inputs=container.querySelectorAll('input,textarea');inputs.forEach(function (inp){function update(){if (inp.value && inp.value.trim() !==''){inp.classList.add('has-value');}else{inp.classList.remove('has-value');}}inp.addEventListener('input',update);update();});}const installmentsFieldsEl=document.getElementById('installments-fields');const financingFieldsEl=document.getElementById('financing-fields');if (installmentsFieldsEl) setupValueListeners(installmentsFieldsEl);if (financingFieldsEl) setupValueListeners(financingFieldsEl);saveBtn.classList.remove('bg-blue-600','bg-blue-500','bg-green-600','bg-green-500','bg-yellow-400','bg-yellow-500','bg-red-600','bg-red-500','','','');saveBtn.classList.remove('save-type-expenses','save-type-incomes','save-type-reserve');if (t==='expenses') saveBtn.classList.add('save-type-expenses');else if (t==='incomes') saveBtn.classList.add('save-type-incomes');else saveBtn.classList.add('save-type-reserve');if (saveBtn.classList.contains('save-type-reserve')){saveIcon.style.color='#111827';}else{saveIcon.style.color='#fff';}let color='#dc2626';let border='#b91c1c';let box='0 2px 10px #dc262644';let textCol='#fff';if (t==='incomes'){color='#16a34a';border='#15803d';box='0 2px 10px #16a34a44';}else if (t==='reserve'){color='#eab308';border='#d6a013';box='0 2px 10px #eab30844';textCol='#111827';}const styleString=`background:${color}!important;background-color:${color}!important;background-image:none !important;border:2px solid ${border}!important;box-shadow: none;color:${textCol}!important;opacity:1 !important;filter:none !important;`;try{saveBtn.setAttribute('style',styleString);}catch(e){/* ignore */}try{const installmentLabel=document.querySelector('label[for="is-installment"]');const financingLabel=document.querySelector('label[for="is-financing"]');const salarySection=document.getElementById('salary-section');const installmentLabels=document.querySelectorAll('label[for="is-installment"]');const financingLabels=document.querySelectorAll('label[for="is-financing"]');function hideLabels(nodelist){nodelist.forEach(l=>{const row=l.closest('.option-row');if (row){row.classList.add('option-collapsed');}else{l.classList.add('hidden');l.style.display='none';}});}function showLabels(nodelist){nodelist.forEach(l=>{const row=l.closest('.option-row');if (row){row.classList.remove('option-collapsed');}else{l.classList.remove('hidden');l.style.display='';}});}if (t==='incomes'){hideLabels(financingLabels);showLabels(installmentLabels);installmentLabels.forEach(lbl=>{const txt=lbl.querySelector('span.ml-2') || lbl.querySelector('span:last-child');if (txt) txt.textContent='ï¿½ uma receita parcelada?';});if (salarySection) salarySection.classList.remove('hidden');if (salarySection) salarySection.style.display='';}else if (t==='expenses'){showLabels(financingLabels);showLabels(installmentLabels);installmentLabels.forEach(lbl=>{const txt=lbl.querySelector('span.ml-2') || lbl.querySelector('span:last-child');if (txt) txt.textContent='ï¿½ uma compra parcelada?';});if (salarySection){salarySection.classList.add('hidden');salarySection.style.display='none';}}else{hideLabels(financingLabels);hideLabels(installmentLabels);if (salarySection){salarySection.classList.add('hidden');salarySection.style.display='none';}}}catch (e){}}document.addEventListener('DOMContentLoaded',function(){const typeInput=document.getElementById('transaction-type-input');updateModalTypeUI(typeInput.value);document.querySelectorAll('.modal-type-toggle').forEach(btn=>{btn.addEventListener('click',function(){typeInput.value=btn.dataset.type;updateModalTypeUI(btn.dataset.type);});});const saveBtn=document.getElementById('modal-save-btn');const observer=new MutationObserver(()=>{updateModalTypeUI(typeInput.value);});observer.observe(saveBtn,{attributes: true,attributeFilter: ['disabled']});});document.addEventListener('DOMContentLoaded',function(){window.ICON_MAPPINGS={paymentMethods: [{value: 'BB (Dï¿½ï¿½bito)',label: 'BB (Dï¿½ï¿½bito)',icon: 'account_balance'},{value: 'Inter (Dï¿½ï¿½bito)',label: 'Inter (Dï¿½ï¿½bito)',icon: 'credit_card'},{value: 'Nubank',label: 'Nubank',icon: 'credit_card'},{value: 'Porto',label: 'Porto',icon: 'credit_card'},{value: 'VR',label: 'VR',icon: 'restaurant'},{value: 'VT',label: 'VT',icon: 'directions_bus'},{value: 'Dinheiro',label: 'Dinheiro',icon: 'paid'},{value: 'PIX',label: 'PIX',icon: 'bolt'},{value: 'Transferï¿½ï¿½ncia',label: 'Transferï¿½ï¿½ncia',icon: 'swap_horiz'},{value: 'Boleto',label: 'Boleto',icon: 'receipt_long'},{value: 'Apple Pay',label: 'Apple Pay',icon: 'smartphone'},{value: 'Outro',label: 'Outro',icon: 'more_horiz'}],expenseCategories: [{value: 'Mercado',label: 'Mercado / Supermercado',icon: 'local_grocery_store'},{value: 'Alimentaï¿½ï¿½o',label: 'Alimentaï¿½ï¿½o (restaurantes,delivery)',icon: 'restaurant'},{value: 'Compras',label: 'Compras / Varejo',icon: 'shopping_bag'},{value: 'Assinaturas',label: 'Assinaturas (streaming,software)',icon: 'subscriptions'},{value: 'Contas',label: 'Contas (ï¿½ï¿½gua,luz,internet)',icon: 'receipt'},{value: 'Moradia',label: 'Moradia (aluguel,condomï¿½nio)',icon: 'home'},{value: 'Transporte',label: 'Transporte (combusTï¿½ï¿½vel,apps)',icon: 'local_taxi'},{value: 'Saï¿½ï¿½de',label: 'Saï¿½ï¿½de (remï¿½dios,consultas)',icon: 'medical_services'},{value: 'Educaï¿½ï¿½o',label: 'Educaï¿½ï¿½o (cursos,livros)',icon: 'school'},{value: 'Lazer',label: 'Lazer (cinema,bares,viagens curtas)',icon: 'local_play'},{value: 'Viagem',label: 'Viagem / Hospedagem',icon: 'flight'},{value: 'Vestuï¿½ï¿½rio',label: 'Vestuï¿½ï¿½rio / Moda',icon: 'checkroom'},{value: 'Casa',label: 'Casa / Manutenï¿½ï¿½o',icon: 'build'},{value: 'Pets',label: 'Pets',icon: 'pets'},{value: 'DoAï¿½ï¿½ES',label: 'DoAï¿½ï¿½ES / Caridade',icon: 'favorite'},{value: 'Impostos',label: 'Impostos / Taxas',icon: 'paid'},{value: 'Parcelas',label: 'Parcelas / Financiamento',icon: 'payments'},{value: 'Investimentos',label: 'Investimentos (aporte)',icon: 'trending_up'},{value: 'Outros',label: 'Outros',icon: 'category'}],expenseTypes: [{value: 'Essenciais',label: 'Essenciais',icon: 'checklist'},{value: 'nï¿½o Essenciais',label: 'nï¿½o Essenciais',icon: 'local_offer'},{value: 'Reserva',label: 'Reserva / Poupanï¿½a',icon: 'savings'},{value: 'Parcelada',label: 'Parcelada',icon: 'payments'},{value: 'Recorrente',label: 'Recorrente',icon: 'autorenew'},{value: 'ï¿½nica',label: 'ï¿½nica',icon: 'calendar_today'}],savingCategories: [{value: 'Reserva Emergï¿½ï¿½ncia',label: 'Reserva de Emergï¿½ï¿½ncia',icon: 'savings'},{value: 'Aï¿½ï¿½ES',label: 'Aï¿½ï¿½ES',icon: 'trending_up'},{value: 'Fundos Imobiliï¿½ï¿½rios',label: 'Fundos Imobiliï¿½ï¿½rios (FII)',icon: 'apartment'},{value: 'Criptomoedas',label: 'Criptomoedas',icon: 'currency_bitcoin'},{value: 'Poupanï¿½a',label: 'Poupanï¿½a',icon: 'savings'},{value: 'Tesouro Direto',label: 'Tesouro Direto',icon: 'account_balance'},{value: 'Previdï¿½ï¿½ncia',label: 'Previdï¿½ï¿½ncia Privada',icon: 'shield'},{value: 'Viagem',label: 'Viagem (meta)',icon: 'flight'},{value: 'Reforma',label: 'Reforma / Casa',icon: 'home_repair_service'},{value: 'Educaï¿½ï¿½o',label: 'Educaï¿½ï¿½o / Cursos',icon: 'school'},{value: 'Carro',label: 'Carro / Transporte',icon: 'directions_car'},{value: 'Imï¿½vel',label: 'Imï¿½vel / Entrada',icon: 'house'},{value: 'Outros',label: 'Outros',icon: 'more_horiz'}],vehicles: [{value: 'Carro',label: 'Carro',icon: 'directions_car'},{value: 'Moto',label: 'Moto',icon: 'two_wheeler'}],fuelTypes: [{value: 'Gasolina',label: 'Gasolina',icon: 'local_gas_station'},{value: 'Gasolina Aditivada',label: 'Gas. Aditivada',icon: 'local_gas_station'},{value: 'Etanol',label: 'Etanol',icon: 'eco'}]};window.getIconFor=function(kind,value){try{if (!value && value !==0) return '';const v=value.toString();const normalize=s=> (s || '').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');if (kind==='payment'){try{const methods=(state && state.appData && state.appData.settings && state.appData.settings.paymentMethods) || [];const found=(methods || []).find(m=>{try{const name=(m && (m.name || m) || '').toString();return normalize(name)===normalize(v);}catch(e){return false;}});if (found) return (found.icon || (found.type && (found.type || '').toString().indexOf('credit') !==-1 ? 'credit_card' : 'payment')) || 'paid';}catch (e){}const m=(window.ICON_MAPPINGS.paymentMethods || []).find(m=>{try{return normalize((m.value || '').toString())===normalize(v) || normalize((m.label || '').toString())===normalize(v);}catch(e){return false;}});return (m && m.icon) ? m.icon : '';}if (kind==='category'){const m=(window.ICON_MAPPINGS.expenseCategories || []).find(m=> (m.value || '')===v || m.label===v);if (m && m.icon) return m.icon;const s=(window.ICON_MAPPINGS.savingCategories || []).find(m=> (m.value || '')===v || m.label===v);if (s && s.icon) return s.icon;return 'category';}if (kind==='type'){const m=(window.ICON_MAPPINGS.expenseTypes || []).find(m=> (m.value || '')===v || m.label===v);return (m && m.icon) ? m.icon : 'tune';}}catch (e){return '';}return '';};window.getPaymentLabel=function(value){try{const normalize=s=> (s || '').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');let v='';if (value && typeof value==='object') v=(value.name || value.label || value.value || '').toString();else v=(value || '').toString();try{const methods=(state && state.appData && state.appData.settings && state.appData.settings.paymentMethods) || [];const found=(methods || []).find(m=>{try{const name=(m && (m.name || m) || '').toString();return normalize(name)===normalize(v);}catch(e){return false;}});if (found) return (found.name || found.label || found.value || v).toString();}catch(e){}try{const m=(window.ICON_MAPPINGS.paymentMethods || []).find(m=>{try{return normalize((m.value||'').toString())===normalize(v) || normalize((m.label||'').toString())===normalize(v);}catch(e){return false;}});if (m) return (m.label || m.value || v).toString();}catch(e){}return v.toString();}catch (e){return (value || '').toString();}};window.paymentMatches=function(a,b){try{const normalize=s=> (s || '').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');const extract=v=>{if (!v && v !==0) return '';if (typeof v==='object') return (v.name || v.label || v.value || '').toString();return v.toString();};const sa=normalize(extract(a));const sb=normalize(extract(b));if (!sa || !sb) return false;if (sa===sb) return true;if (sa.indexOf(sb) !==-1) return true;if (sb.indexOf(sa) !==-1) return true;return false;}catch (e){return false;}};window.iconHtml=function(iconName,extraCls){if (!iconName) return '';const cls=extraCls ? extraCls : 'text-gray-500';return `<span class="material-symbols-outlined ${cls}" style="font-size:18px;margin-right:6px;vertical-align:middle">${iconName}</span>`;};function populateSelect(selectId,items,iconSpanSelector){const sel=document.getElementById(selectId);if (!sel) return;sel.innerHTML='';items.forEach(it=>{const opt=document.createElement('option');opt.value=it.value;opt.textContent=it.label;opt.dataset.icon=it.icon;sel.appendChild(opt);});const iconSpan=sel.parentElement ? sel.parentElement.querySelector(iconSpanSelector) : null;const updateIcon=()=>{const cur=sel.options[sel.selectedIndex];if (iconSpan && cur && cur.dataset.icon){iconSpan.textContent=cur.dataset.icon;iconSpan.classList.add('material-symbols-outlined');}};sel.addEventListener('change',updateIcon);updateIcon();}populateSelect('payment-method',window.ICON_MAPPINGS.paymentMethods,'.material-symbols-outlined');populateSelect('category-expense',window.ICON_MAPPINGS.expenseCategories,'.material-symbols-outlined');populateSelect('expense-type',window.ICON_MAPPINGS.expenseTypes,null);populateSelect('category-saving',window.ICON_MAPPINGS.savingCategories,'.material-symbols-outlined');populateSelect('filter-payment-method',window.ICON_MAPPINGS.paymentMethods,'.select-icon');const combinedCategories=(window.ICON_MAPPINGS.expenseCategories || []).concat(window.ICON_MAPPINGS.savingCategories || []).map(c=> ({value: c.value,label: c.label,icon: c.icon}));populateSelect('filter-category',combinedCategories,'.select-icon');populateSelect('vt-fuel-vehicle',(window.ICON_MAPPINGS.vehicles || []).map(v=>({value: v.value,label: v.label,icon: v.icon})),'.select-icon');populateSelect('vt-filter-vehicle',[{value: '',label: 'Todos',icon: ''}].concat((window.ICON_MAPPINGS.vehicles || []).map(v=>({value: v.value,label: v.label,icon: v.icon}))),'.select-icon');populateSelect('vt-fuel-type',(window.ICON_MAPPINGS.fuelTypes || []).map(f=>({value: f.value,label: f.label,icon: f.icon})),'.select-icon');populateSelect('vt-filter-fuel',[{value: '',label: 'Todos',icon: ''}].concat((window.ICON_MAPPINGS.fuelTypes || []).map(f=>({value: f.value,label: f.label,icon: f.icon}))),'.select-icon');try{const setAndRefresh=(id,defaultValue)=>{const el=document.getElementById(id);if (!el) return;if (defaultValue !==undefined && Array.from(el.options).some(o=> o.value===defaultValue)){el.value=defaultValue;el.dispatchEvent(new Event('change',{bubbles: true}));}if (typeof el._refreshIconSelect==='function'){try{el._refreshIconSelect();}catch (e){console.error('refresh icon-select',id,e);}}};setAndRefresh('vt-fuel-vehicle','Moto');setAndRefresh('vt-fuel-type','Gasolina');setAndRefresh('vt-filter-vehicle');setAndRefresh('vt-filter-fuel');}catch (e){console.error('vt selects default/refresh error',e);}});document.addEventListener('DOMContentLoaded',function(){window.toggleRecipientForPayment=function(rawValue){try{const normalize=s=> (s || '').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');const nv=normalize(rawValue || '');const recipientWrapper=document.getElementById('payment-recipient-wrapper');const recipientInput=document.getElementById('payment-recipient');const recipientHint=document.getElementById('payment-recipient-hint');if (!recipientWrapper || !recipientInput) return;const mustShow=(nv==='pix' || nv.indexOf('transfer') !==-1 || nv==='transferencia');if (mustShow){recipientWrapper.classList.remove('hidden');recipientWrapper.setAttribute('aria-hidden','false');recipientInput.setAttribute('required','required');try{recipientInput.focus();}catch(_){}if (recipientHint){recipientHint.classList.remove('hidden');recipientHint.setAttribute('aria-hidden','false');}}else{recipientWrapper.classList.add('hidden');recipientWrapper.setAttribute('aria-hidden','true');recipientInput.removeAttribute('required');if (recipientHint){recipientHint.classList.add('hidden');recipientHint.setAttribute('aria-hidden','true');}}}catch (e){console.error('toggleRecipientForPayment',e);}};function enhanceSelectWithIcons(selectId,placeholder){const sel=document.getElementById(selectId);if (!sel) return null;const kind=(selectId && selectId.indexOf('payment') !==-1) ? 'payment' : ((selectId && selectId.indexOf('category') !==-1) ? 'category' : null);const rebuildList=(wrapper,iconSpan,labelSpan,list)=>{list.innerHTML='';Array.from(sel.options).forEach(opt=>{const item=document.createElement('div');item.className='icon-select-item';const i=document.createElement('span');i.className='material-symbols-outlined';let iconName=opt.dataset.icon || '';if ((!iconName || iconName==='') && typeof getIconFor==='function' && kind){try{iconName=getIconFor(kind,opt.value || opt.textContent || '');}catch(e){iconName='';}}i.textContent=iconName || '';const t=document.createElement('span');t.textContent=opt.textContent || opt.value;item.appendChild(i);item.appendChild(t);item.addEventListener('click',()=>{sel.value=opt.value;let selIcon=opt.dataset.icon || '';if ((!selIcon || selIcon==='') && typeof getIconFor==='function' && kind){try{selIcon=getIconFor(kind,opt.value || opt.textContent || '');}catch(e){selIcon='';}}iconSpan.textContent=selIcon || '';labelSpan.textContent=opt.textContent || opt.value;list.classList.add('hidden');caret.textContent='arrow_drop_down';sel.dispatchEvent(new Event('change',{bubbles: true}));try{if (window.toggleRecipientForPayment) window.toggleRecipientForPayment(opt.value);}catch(_){}});list.appendChild(item);});};const wrapper=document.createElement('div');wrapper.className='icon-select';sel.parentElement.insertBefore(wrapper,sel);sel.style.position='absolute';sel.style.display='none';sel.style.pointerEvents='none';sel.style.height='1px';sel.style.width='1px';const btn=document.createElement('button');btn.type='button';btn.className='icon-select-button';const iconSpan=document.createElement('span');iconSpan.className='material-symbols-outlined';let initialIcon='';if (sel.selectedOptions && sel.selectedOptions[0]) initialIcon=sel.selectedOptions[0].dataset.icon || '';if ((!initialIcon || initialIcon==='') && typeof getIconFor==='function' && kind && sel.selectedOptions && sel.selectedOptions[0]){try{initialIcon=getIconFor(kind,sel.selectedOptions[0].value || sel.selectedOptions[0].textContent || '');}catch(e){initialIcon='';}}iconSpan.textContent=initialIcon || '';const labelSpan=document.createElement('span');labelSpan.textContent=sel.selectedOptions && sel.selectedOptions[0] ? sel.selectedOptions[0].textContent : (placeholder || sel.getAttribute('placeholder') || '');const caret=document.createElement('span');caret.className='material-symbols-outlined';caret.textContent='arrow_drop_down';caret.style.marginLeft='auto';btn.appendChild(iconSpan);btn.appendChild(labelSpan);btn.appendChild(caret);const list=document.createElement('div');list.className='icon-select-list hidden';rebuildList(wrapper,iconSpan,labelSpan,list);wrapper.appendChild(btn);wrapper.appendChild(list);wrapper.appendChild(sel);btn.addEventListener('click',(ev)=>{ev.stopPropagation();list.classList.toggle('hidden');caret.textContent=list.classList.contains('hidden') ? 'arrow_drop_down' : 'arrow_drop_up';});document.addEventListener('click',()=>{if (!list.classList.contains('hidden')){list.classList.add('hidden');caret.textContent='arrow_drop_down';}});try{sel._refreshIconSelect=()=> rebuildList(wrapper,iconSpan,labelSpan,list);}catch(e){}return{wrapper,btn,list};}['payment-method','category-expense','category-saving','filter-payment-method','filter-category','vt-fuel-vehicle','vt-filter-vehicle','vt-fuel-type','vt-filter-fuel','tp-transport-type','tp-activity-type'].forEach(id=>{try{enhanceSelectWithIcons(id);}catch(e){console.error('enhanceSelectWithIcons',id,e);}});});(function(){window._pendingVtTransaction=null;function q(id){return document.getElementById(id);}function openVtFuelModal(pendingTransaction){window._pendingVtTransaction=pendingTransaction || null;const modal=q('vt-fuel-modal');if (!modal) return;activateVtTab('register');try{const tot=(pendingTransaction && pendingTransaction.amount) ? Number(pendingTransaction.amount) : '';if (tot !=='') q('vt-fuel-total').value=(Number(tot) || 0).toFixed(2).replace('.',',');else q('vt-fuel-total').value='';try{const d=new Date();q('vt-fuel-date').value=d.toISOString().slice(0,10);}catch(e){}try{const all=(typeof collectAllVtUsage==='function') ? collectAllVtUsage() : [];const last=(all && all.length) ? all[0] : null;if (last){try{if (q('vt-fuel-vehicle') && (!q('vt-fuel-vehicle').value || q('vt-fuel-vehicle').value==='')) q('vt-fuel-vehicle').value=last.vehicle || q('vt-fuel-vehicle').value;try{const sel=q('vt-fuel-vehicle');if (sel && typeof sel._refreshIconSelect==='function') sel._refreshIconSelect();}catch(e){}}catch(e){}try{if (q('vt-fuel-type') && (!q('vt-fuel-type').value || q('vt-fuel-type').value==='')) q('vt-fuel-type').value=last.fuelType || q('vt-fuel-type').value;}catch(e){}try{const t=q('vt-fuel-type');if (t && typeof t._refreshIconSelect==='function') t._refreshIconSelect();}catch(e){}try{if (q('vt-fuel-price') && (!q('vt-fuel-price').value)) q('vt-fuel-price').placeholder=(last.pricePerLiter!=null ? Number(last.pricePerLiter).toFixed(2).replace('.',',') : q('vt-fuel-price').placeholder);}catch(e){}try{if (q('vt-fuel-liters') && (!q('vt-fuel-liters').value)) q('vt-fuel-liters').placeholder=(last.liters!=null ? Number(last.liters).toFixed(3).replace('.',',') : q('vt-fuel-liters').placeholder);}catch(e){}try{if (q('vt-fuel-odometer') && (!q('vt-fuel-odometer').value)) q('vt-fuel-odometer').placeholder=(last.odometer!=null ? String(last.odometer) : q('vt-fuel-odometer').placeholder);}catch(e){}try{if (q('vt-fuel-total') && (!q('vt-fuel-total').value)) q('vt-fuel-total').placeholder=(last.amount!=null ? Number(last.amount).toFixed(2).replace('.',',') : q('vt-fuel-total').placeholder);}catch(e){}try{const f=q('vt-filter-vehicle');if (f && typeof f._refreshIconSelect==='function') f._refreshIconSelect();}catch(e){}}}catch(e){/* ignore prefill errors */}}catch(e){}try{modal.style.zIndex='200000';modal.style.display='block';if (typeof modal.showModal==='function') modal.showModal();else modal.setAttribute('open','');}catch(e){try{modal.setAttribute('open','');}catch(err){}try{modal.style.display='block';}catch(_){}}try{const pre=parseLocaleNumber(q('vt-fuel-total').value) || 0;if (pre > 0){try{q('vt-fuel-save').removeAttribute('disabled');}catch(e){}}}catch(e){}renderVtHistory();}function openVtFuelHistory(){const modal=q('vt-fuel-modal');if (!modal) return;window._pendingVtTransaction=null;activateVtTab('history');try{modal.style.zIndex='200000';modal.style.display='block';if (typeof modal.showModal==='function') modal.showModal();else modal.setAttribute('open','');}catch(e){try{modal.setAttribute('open','');modal.style.display='block';}catch(_){}}renderVtHistory();}function closeVtFuelModal(){const modal=q('vt-fuel-modal');if(!modal) return;try{if (typeof modal.close==='function') modal.close();else modal.removeAttribute('open');}catch(e){try{modal.removeAttribute('open');}catch(_){}}try{modal.style.display='none';modal.style.zIndex='';}catch(_){}window._pendingVtTransaction=null;}function activateVtTab(name){const reg=q('vt-register');const hist=q('vt-history');const btnReg=q('vt-tab-register');const btnHist=q('vt-tab-history');if(name==='register'){reg.classList.remove('hidden');hist.classList.add('hidden');btnReg.classList.add('bg-gray-100');btnHist.classList.remove('bg-gray-100');}else{reg.classList.add('hidden');hist.classList.remove('hidden');btnHist.classList.add('bg-gray-100');btnReg.classList.remove('bg-gray-100');renderVtHistory();}}function collectAllVtUsage(){try{const out=[];const data=(typeof state !=='undefined' && state.appData && state.appData.data) ? state.appData.data : ((window.state && window.state.appData && window.state.appData.data) ? window.state.appData.data :{});Object.keys(data).forEach(y=>{Object.keys(data[y] ||{}).forEach(m=>{const md=data[y][m] ||{};(md.vtUsage || []).forEach(u=> out.push(u));});});out.sort((a,b)=> new Date(b.date) - new Date(a.date));return out;}catch(e){return [];}}let vtPriceChart=null,vtAutonomyChart=null;let vtPriceResizeObserver=null,vtAutonomyResizeObserver=null;function getChartHeightForViewport(){try{return (window.innerWidth >=1024) ? 220 : 160;}catch (e){return 160;}}function attachChartResizeObserver(canvas,chartInstance,parent){if (!canvas || !chartInstance) return function(){};const resizeFn=()=>{try{const h=getChartHeightForViewport();canvas.style.height=h + 'px';try{chartInstance.resize();}catch(e){/* ignore */}}catch (e){console.error('chart resizeFn error',e);}};resizeFn();if (typeof ResizeObserver !=='undefined'){const ro=new ResizeObserver(()=> resizeFn());try{ro.observe(parent || canvas.parentElement || document.body);}catch(e){}return function(){try{ro.disconnect();}catch(e){}};}else{const handler=()=> resizeFn();window.addEventListener('resize',handler);return function(){try{window.removeEventListener('resize',handler);}catch(e){}};}}function renderVtHistory(){const all=collectAllVtUsage();try{if ((!(all && all.length) || all.length===0) && !window._vtHistoryReloadAttempted){window._vtHistoryReloadAttempted=true;if (storage && typeof storage.loadData==='function'){storage.loadData().then(d=>{try{window.state=window.state ||{};window.state.appData=d;}catch(e){}try{renderVtHistory();showToast('Dados carregados do armazenamento.','bg-green-600');}catch(e){}}).catch(err=>{console.error('storage.loadData for VT history',err);});}}}catch (e){/* ignore reload errors */}const vfEl=q('vt-filter-vehicle');const ffEl=q('vt-filter-fuel');const searchEl=q('vt-filter-search');const vf=vfEl ? (vfEl.value || '') : '';const ff=ffEl ? (ffEl.value || '') : '';const search=(searchEl && searchEl.value) ? String(searchEl.value).toLowerCase().trim() : '';const rows=all.filter(r=>{if (vf && (r.vehicle || '') !==vf) return false;if (ff && (r.fuelType || '') !==ff) return false;if (search){const desc=(r.description || '').toLowerCase();if (!desc.includes(search)) return false;}return true;});const tb=q('vt-history-tbody');if(!tb) return;tb.innerHTML='';let total=0;let liters=0;let priceSum=0;let priceCount=0;const byVehicle={};const priceSeries=[];const priceLabels=[];const autonomyIntervals=[];const rowsForCharts=(rows || []).slice().sort((a,b)=> new Date(a.date) - new Date(b.date));rows.forEach(r=>{const d=new Date(r.date || '');const tr=document.createElement('tr');function mkCell(content,field,formatter){const td=document.createElement('td');td.className='px-2 py-1';const span=document.createElement('span');span.className='vt-cell';span.textContent=formatter ? formatter(content) : (content==null? '' : String(content));span.style.cursor='pointer';span.title='Clique para editar';span.addEventListener('click',function (){if (td.querySelector('input') || td.querySelector('textarea') || td.querySelector('select')) return;let inputEl;if (field==='date'){inputEl=document.createElement('input');inputEl.type='date';inputEl.value=(content ? new Date(content).toISOString().slice(0,10) : '');}else if (field==='vehicle' || field==='fuelType'){inputEl=document.createElement('input');inputEl.type='text';inputEl.value=content || '';}else if (field==='description'){inputEl=document.createElement('input');inputEl.type='text';inputEl.value=content || '';}else if (field==='odometer'){inputEl=document.createElement('input');inputEl.type='number';inputEl.step='1';inputEl.value=content!=null? String(content) : '';}else if (field==='liters'){inputEl=document.createElement('input');inputEl.type='text';inputEl.value=content!=null? String(content) : '';}else if (field==='pricePerLiter' || field==='amount'){inputEl=document.createElement('input');inputEl.type='text';inputEl.value=content!=null? String(content) : '';}else{inputEl=document.createElement('input');inputEl.type='text';inputEl.value=content!=null? String(content) : '';}inputEl.className='w-full border rounded p-1';td.innerHTML='';td.appendChild(inputEl);inputEl.focus();const saveFn=async ()=>{try{let val=inputEl.value;const updated={id: r.id};if (field==='date') updated.date=val ? new Date(val).toISOString() : null;else if (field==='odometer') updated.odometer=val !=='' ? Number(val) : null;else if (field==='liters') updated.liters=val !=='' ? parseLocaleNumber(val) : null;else if (field==='pricePerLiter') updated.pricePerLiter=val !=='' ? parseLocaleNumber(val) : null;else if (field==='amount') updated.amount=val !=='' ? parseLocaleNumber(val) : null;else if (field==='vehicle') updated.vehicle=val;else if (field==='fuelType') updated.fuelType=val;else if (field==='description') updated.description=val;if (window.appApi && typeof window.appApi.updateVtEntry==='function'){await window.appApi.updateVtEntry(updated);}else{try{const data=window.state && window.state.appData && window.state.appData.data ? window.state.appData.data : null;if (data){Object.keys(data).forEach(y=>{Object.keys(data[y]||{}).forEach(m=>{(data[y][m].vtUsage||[]).forEach((it,idx)=>{if (it && it.id===r.id){data[y][m].vtUsage[idx]=Object.assign({},it,updated);}});});});await storage.saveData(window.state.appData);}}catch(e){console.error('fallback update inline',e);}}showToast('Abastecimento atualizado','bg-green-600');renderVtHistory();if (window.appApi && typeof window.appApi.render==='function') window.appApi.render();}catch (err){console.error('inline edit save error',err);showToast('Falha ao salvar alteraï¿½ï¿½o','bg-red-600');renderVtHistory();}};inputEl.addEventListener('blur',saveFn);inputEl.addEventListener('keydown',(ev)=>{if (ev.key==='Enter'){ev.preventDefault();inputEl.blur();}else if (ev.key==='Escape'){renderVtHistory();}});});td.appendChild(span);return td;}tr.dataset.vtId=r.id || '';tr.appendChild(mkCell(r.date,'date',c=>{try{return c ? new Date(c).toLocaleDateString() : '';}catch(e){return '';}}));tr.appendChild(mkCell(r.description || 'Abastecimento','description'));tr.appendChild(mkCell(r.vehicle || '','vehicle'));tr.appendChild(mkCell(r.odometer!=null? String(r.odometer) : '','odometer'));tr.appendChild(mkCell(r.liters!=null? Number(r.liters).toFixed(3) : '','liters'));tr.appendChild(mkCell(r.pricePerLiter!=null? r.pricePerLiter : '','pricePerLiter',v=> v ? formatCurrency(v) : ''));tr.appendChild(mkCell(r.amount!=null? r.amount : 0,'amount',v=> formatCurrency(v||0)));const actionsTd=document.createElement('td');actionsTd.className='px-2 py-1 actions-cell text-right';const delBtn=document.createElement('button');delBtn.type='button';delBtn.className='vt-delete-btn';delBtn.title='Excluir abastecimento';delBtn.style.display='none';delBtn.style.background='transparent';delBtn.style.border='none';delBtn.style.cursor='pointer';delBtn.innerHTML='<span class="material-symbols-outlined text-red-500">delete</span>';tr.addEventListener('mouseenter',()=>{try{delBtn.style.display='inline-block';}catch(e){}});tr.addEventListener('mouseleave',()=>{try{delBtn.style.display='none';}catch(e){}});delBtn.addEventListener('click',async (ev)=>{try{ev.stopPropagation();try{const ok=await confirmAsync('Excluir este abastecimento?','Confirmar exclusï¿½o');if (!ok) return;}catch(e){return;}const idToDelete=r.id;let found=false;try{const data=(typeof state !=='undefined' && state.appData && state.appData.data) ? state.appData.data : ((window.state && window.state.appData && window.state.appData.data) ? window.state.appData.data :{});Object.keys(data).forEach(y=>{Object.keys(data[y] ||{}).forEach(m=>{const md=data[y][m] ||{};if (Array.isArray(md.vtUsage)){const idx=md.vtUsage.findIndex(it=> it && it.id===idToDelete);if (idx !==-1){md.vtUsage.splice(idx,1);found=true;}}});});if (found){try{await storage.saveData(window.state.appData);}catch(e){console.error('saveData after vt delete',e);}showToast('Abastecimento excluï¿½ï¿½do','bg-green-600');}else{showToast('Abastecimento nï¿½o encontrado','bg-yellow-600');}}catch (e){console.error('delete vt inline error',e);showToast('Erro ao excluir abastecimento','bg-red-600');}try{renderVtHistory();}catch(e){}try{if (window.appApi && typeof window.appApi.render==='function') window.appApi.render();}catch(e){}}catch (err){console.error('vt delete handler',err);showToast('Falha ao excluir','bg-red-600');}});actionsTd.appendChild(delBtn);tr.appendChild(actionsTd);tb.appendChild(tr);total +=Number(r.amount||0);if (r.liters) liters +=Number(r.liters||0);if (r.pricePerLiter){priceSum +=Number(r.pricePerLiter||0);priceCount++;}const v=r.vehicle || 'unknown';if(!byVehicle[v]) byVehicle[v]=[];byVehicle[v].push(r);});rowsForCharts.forEach(r=>{const d=new Date(r.date || '');const price=Number(r.pricePerLiter || 0);if (!isNaN(d.getTime()) && price > 0){priceLabels.push(d.toLocaleDateString());priceSeries.push(price);}});if (!rows || rows.length===0){if (tb) tb.innerHTML='<tr><td colspan="7" class="p-6 text-sm text-gray-500">Nenhum abastecimento encontrado para os filtros selecionados.</td></tr>';}q('vt-stat-total').textContent=formatCurrency(total);q('vt-stat-liters').textContent=`${liters.toFixed(3)}L`;q('vt-stat-avgprice').textContent=priceCount ? formatCurrency(priceSum / priceCount) : formatCurrency(0);Object.keys(byVehicle).forEach(v=>{const arr=(byVehicle[v]||[]).slice().filter(it=> it.odometer!=null).sort((a,b)=> new Date(a.date)-new Date(b.date));for(let i=1;i<arr.length;i++){const prev=arr[i-1];const cur=arr[i];const prevOdo=Number(prev.odometer || 0);const curOdo=Number(cur.odometer || 0);const km=curOdo - prevOdo;const litersUsed=Number(cur.liters || 0);if (km > 0 && litersUsed > 0){autonomyIntervals.push({vehicle: v,km: km,liters: litersUsed,ratio: km / litersUsed,date: cur.date});}}});q('vt-stat-autonomy').textContent=autonomyIntervals.length ? `${(autonomyIntervals.reduce((s,i)=>s+i.ratio,0)/autonomyIntervals.length).toFixed(3)}km/L` : 'Insuficiente (sem pares de odï¿½ï¿½metro)';try{const autonomyEl=q('vt-stat-autonomy');if (autonomyEl){autonomyEl.setAttribute('title','A autonomia mï¿½dia ï¿½ï¿½ calculada a partir de pares de odï¿½ï¿½metro registrados entre dois abastecimentos. Preencha odï¿½ï¿½metro em dois abastecimentos para calcular.');if (!autonomyEl.querySelector('.vt-autonomy-info')){const info=document.createElement('span');info.className='vt-autonomy-info material-symbols-outlined text-xs ml-2 text-gray-400';info.style.verticalAlign='middle';info.title='A autonomia mï¿½dia ï¿½ï¿½ calculada a partir de pares de odï¿½ï¿½metro registrados entre dois abastecimentos.';info.textContent='info';autonomyEl.appendChild(info);}}}catch (e){/* ignore tooltip failures */}const vehicles=Array.from(new Set(collectAllVtUsage().map(u=> u.vehicle || '').filter(Boolean))).map(v=> ({value: v,label: v,icon: ((window.ICON_MAPPINGS && window.ICON_MAPPINGS.vehicles) || []).find(x=>x.value===v)?.icon || ''}));const vfEl2=q('vt-filter-vehicle');if (vfEl2){if (vehicles && vehicles.length) populateSelect('vt-filter-vehicle',[{value: '',label: 'Todos',icon: ''}].concat(vehicles),'.select-icon');if (vf) vfEl2.value=vf;try{if (typeof vfEl2._refreshIconSelect==='function') vfEl2._refreshIconSelect();}catch(e){/* ignore */}}try{const priceCanvas=document.getElementById('vt-chart-price');try{const priceEmptyId='vt-chart-price-empty';if (priceCanvas){const priceParent=priceCanvas.parentElement;try{if (priceParent) priceParent.style.minHeight=priceSeries && priceSeries.length ? '160px' : '';}catch(e){}if (!priceSeries || priceSeries.length===0){priceCanvas.style.display='none';if (priceParent && !priceParent.querySelector('#' + priceEmptyId)){const d=document.createElement('div');d.id=priceEmptyId;d.className='p-6 text-sm text-gray-500';d.textContent='Sem Histï¿½rico de preï¿½o por litro.';if (priceParent) priceParent.appendChild(d);}}else{try{priceCanvas.style.display='';priceCanvas.style.height='160px';}catch(e){}const existing=priceParent ? priceParent.querySelector('#' + priceEmptyId) : null;if (existing) existing.remove();}}}catch(e){}if (priceCanvas && priceCanvas.getContext){if (!priceSeries || priceSeries.length===0){try{if (vtPriceChart){vtPriceChart.destroy();vtPriceChart=null;}}catch(e){}}try{priceCanvas.height=160;priceCanvas.style.height='160px';}catch(e){}const priceCtx=priceCanvas.getContext('2d');try{if (vtPriceChart){try{vtPriceChart.destroy();}catch(e){}vtPriceChart=null;}if (vtPriceResizeObserver){try{vtPriceResizeObserver();}catch(e){}vtPriceResizeObserver=null;}if (priceSeries && priceSeries.length){vtPriceChart=new Chart(priceCtx,{type: 'line',data:{labels: priceLabels,datasets: [{label: 'R$/L',data: priceSeries,borderColor: '#3b82f6',backgroundColor: 'rgba(59,130,246,0.08)',fill: true}]},options:{responsive: false,maintainAspectRatio: false,scales:{x:{display: true},y:{display: true}}}});vtPriceResizeObserver=attachChartResizeObserver(priceCanvas,vtPriceChart,priceCanvas.parentElement);}}catch (e){console.error('vtPriceChart render error',e);}}const autonomyLabels=autonomyIntervals.map(i=> new Date(i.date).toLocaleDateString());const autonomyData=autonomyIntervals.map(i=> Number(i.ratio.toFixed(3)));const autoCanvas=document.getElementById('vt-chart-autonomy');try{const autoEmptyId='vt-chart-autonomy-empty';if (autoCanvas){const autoParent=autoCanvas.parentElement;if (!autonomyIntervals || autonomyIntervals.length===0){autoCanvas.style.display='none';if (autoParent && !autoParent.querySelector('#' + autoEmptyId)){const d=document.createElement('div');d.id=autoEmptyId;d.className='p-6 text-sm text-gray-500';d.textContent='Autonomia insuficiente para gerar grï¿½ï¿½fico.';if (autoParent) autoParent.appendChild(d);}}else{autoCanvas.style.display='';const existing=autoParent ? autoParent.querySelector('#' + autoEmptyId) : null;if (existing) existing.remove();}}}catch(e){}if (autoCanvas && autoCanvas.getContext){const autoParent=autoCanvas.parentElement;if (!autonomyIntervals || autonomyIntervals.length===0){try{if (vtAutonomyChart){vtAutonomyChart.destroy();vtAutonomyChart=null;}}catch(e){}}try{autoCanvas.height=160;autoCanvas.style.height='160px';if (autoParent) autoParent.style.minHeight=autonomyIntervals && autonomyIntervals.length ? '160px' : '';}catch(e){}const autoCtx=autoCanvas.getContext('2d');try{if (vtAutonomyChart){try{vtAutonomyChart.destroy();}catch(e){}vtAutonomyChart=null;}if (vtAutonomyResizeObserver){try{vtAutonomyResizeObserver();}catch(e){}vtAutonomyResizeObserver=null;}if (autonomyIntervals && autonomyIntervals.length){vtAutonomyChart=new Chart(autoCtx,{type: 'bar',data:{labels: autonomyLabels,datasets: [{label: 'km/L',data: autonomyData,backgroundColor: '#10b981'}]},options:{responsive: false,maintainAspectRatio: false,scales:{x:{display: true},y:{display: true}}}});vtAutonomyResizeObserver=attachChartResizeObserver(autoCanvas,vtAutonomyChart,autoCanvas.parentElement);}}catch (e){console.error('vtAutonomyChart render error',e);}}}catch(e){/* Chart.js not available or canvas not ready */}}function formatCurrency(v){try{return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL',minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(v)||0);}catch(e){return String(v);}}function escapeHtml(s){return String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}function parseLocaleNumber(s){try{if (s===undefined || s===null) return NaN;if (typeof s==='number') return s;let str=String(s).trim();if (str==='') return NaN;str=str.replace(/[R$\s\u00A0]/g,'');str=str.replace(/(?!^)-/g,'');if (str==='' || str==='-') return NaN;const hasBRDecimal=/,\d{1,2}$/.test(str);const hasUSDecimal=/\.\d{1,2}$/.test(str);if (hasBRDecimal){str=str.replace(/\./g,'').replace(',','.');}else if (hasUSDecimal){str=str.replace(/,/g,'');}else{str=str.replace(/[.,]/g,'');}str=str.replace(/[^0-9.\-]/g,'');const v=parseFloat(str);return isNaN(v) ? NaN : v;}catch (e){return NaN;}}function safeGenerateId(){try{if (typeof generateUUID==='function') return generateUUID();}catch(e){}return 'id-' + Math.random().toString(36).slice(2,10) + Date.now().toString(36);}document.addEventListener('DOMContentLoaded',function(){const modal=q('vt-fuel-modal');if(!modal) return;const btnReg=q('vt-tab-register');const btnHist=q('vt-tab-history');const btnClose=q('vt-fuel-close');const btnCancel=q('vt-fuel-cancel');const saveBtn=q('vt-fuel-save');const inpPrice=q('vt-fuel-price');const inpLiters=q('vt-fuel-liters');const inpTotal=q('vt-fuel-total');const inpVehicle=q('vt-fuel-vehicle');const inpOdo=q('vt-fuel-odometer');const inpType=q('vt-fuel-type');let programmatic=false;function validateAndToggle(){const total=parseLocaleNumber(inpTotal.value) || 0;if (total > 0){try{saveBtn.removeAttribute('disabled');}catch(e){}q('vt-error-total').classList.add('hidden');}else{try{saveBtn.setAttribute('disabled','');}catch(e){}q('vt-error-total').classList.remove('hidden');q('vt-error-total').textContent='Informe o valor total.';}}function recalcFields(trigger){if (programmatic) return;programmatic=true;try{const price=parseLocaleNumber(inpPrice.value) || 0;const liters=parseLocaleNumber(inpLiters.value) || 0;const total=parseLocaleNumber(inpTotal.value) || 0;if (price > 0 && liters > 0){const calcTotal=Math.round((price * liters + Number.EPSILON) * 100) / 100;inpTotal.value=calcTotal.toFixed(2).replace('.',',');}else if (price > 0 && total > 0){const calcLiters=total / price;inpLiters.value=calcLiters.toFixed(3).replace('.',',');}else if (liters > 0 && total > 0){const calcPrice=total / liters;inpPrice.value=calcPrice.toFixed(2).replace('.',',');}}catch (e){}finally{programmatic=false;validateAndToggle();}}inpPrice.addEventListener('input',()=> recalcFields('price'));inpLiters.addEventListener('input',()=> recalcFields('liters'));inpTotal.addEventListener('input',()=> recalcFields('total'));inpPrice.addEventListener('blur',()=>{try{const v=parseLocaleNumber(inpPrice.value);if (!isNaN(v)) inpPrice.value=v.toFixed(2).replace('.',',');recalcFields('price');}catch(e){}});inpLiters.addEventListener('blur',()=>{try{const v=parseLocaleNumber(inpLiters.value);if (!isNaN(v)) inpLiters.value=v.toFixed(3).replace('.',',');recalcFields('liters');}catch(e){}});inpTotal.addEventListener('blur',()=>{try{const v=parseLocaleNumber(inpTotal.value);if (!isNaN(v)) inpTotal.value=v.toFixed(2).replace('.',',');recalcFields('total');}catch(e){}});btnReg.addEventListener('click',()=> activateVtTab('register'));btnHist.addEventListener('click',()=> activateVtTab('history'));btnClose.addEventListener('click',()=> closeVtFuelModal());btnCancel.addEventListener('click',()=> closeVtFuelModal());q('vt-fuel-form').addEventListener('submit',function(e){e.preventDefault();const vehicle=inpVehicle.value;const odometer=inpOdo.value ? Number(inpOdo.value) : null;const fuelType=inpType.value;const price=isNaN(parseLocaleNumber(inpPrice.value)) ? null : parseLocaleNumber(inpPrice.value);const liters=isNaN(parseLocaleNumber(inpLiters.value)) ? null : parseLocaleNumber(inpLiters.value);const total=isNaN(parseLocaleNumber(inpTotal.value)) ? null : parseLocaleNumber(inpTotal.value);if (!total || total <=0){q('vt-error-total').classList.remove('hidden');q('vt-error-total').textContent='Valor total invï¿½ï¿½lido.';return;}const base=window._pendingVtTransaction ||{};const dateValue=(q('vt-fuel-date') && q('vt-fuel-date').value) ? new Date(q('vt-fuel-date').value).toISOString() : new Date().toISOString();const entry={id: (typeof safeGenerateId==='function' ? safeGenerateId() : (typeof generateUUID==='function' ? generateUUID() : ('id-' + Math.random().toString(36).slice(2,8)))),description: base.description || 'Abastecimento',amount: Number(total)||0,date: dateValue,vehicle: vehicle,odometer: odometer,fuelType: fuelType,pricePerLiter: price,liters: liters};const saveViaAppApi=(window.appApi && typeof window.appApi.saveVtEntry==='function');if (saveViaAppApi){window.appApi.saveVtEntry(entry).then(()=>{showToast('Abastecimento registrado no VT.','bg-green-600');closeVtFuelModal();(window.appApi && typeof window.appApi.render==='function' ? window.appApi.render() : (typeof render==='function' ? render() : null));}).catch(err=>{console.error('save vt fuel via appApi',err);showToast('Falha ao salvar abastecimento VT.','bg-red-600');});return;}let md=null;let winState;try{if (typeof getCurrentMonthData==='function') md=getCurrentMonthData();else if (typeof window.getCurrentMonthData==='function') md=window.getCurrentMonthData();}catch (e){md=null;}if (!md){try{const date=(window.state && window.state.currentDate) ? window.state.currentDate : new Date();const year=date.getFullYear();const month=String(date.getMonth() + 1).padStart(2,'0');winState=window.state || (window.state={currentDate: date,appData:{data:{}}});if (!winState.appData) winState.appData={data:{}};if (!winState.appData.data[year]) winState.appData.data[year]={};if (!winState.appData.data[year][month]) winState.appData.data[year][month]={incomes: [],expenses: [],savings: [],vtUsage: []};md=winState.appData.data[year][month];}catch (e){md={vtUsage: []};}}if(!Array.isArray(md.vtUsage)) md.vtUsage=[];md.vtUsage.push(entry);const appDataToSave=(window.state && window.state.appData) ? window.state.appData : (typeof winState !=='undefined' && winState.appData ? winState.appData : (window.state && window.state.appData ? window.state.appData :{data:{}}));storage.saveData(appDataToSave).then(()=>{showToast('Abastecimento registrado no VT.','bg-green-600');closeVtFuelModal();(window.appApi && typeof window.appApi.render==='function' ? window.appApi.render() : (typeof render==='function' ? render() : null));}).catch(err=>{console.error('save vt fuel',err);showToast('Falha ao salvar abastecimento VT.','bg-red-600');});});const filterVehicle=q('vt-filter-vehicle');const filterFuel=q('vt-filter-fuel');const filterSearch=q('vt-filter-search');const filterClear=q('vt-filter-clear');if(filterVehicle) filterVehicle.addEventListener('change',()=> renderVtHistory());if(filterFuel) filterFuel.addEventListener('change',()=> renderVtHistory());if(filterSearch) filterSearch.addEventListener('input',()=> renderVtHistory());if(filterClear) filterClear.addEventListener('click',()=>{if(filterSearch) filterSearch.value='';if(filterVehicle) filterVehicle.value='';if(filterFuel) filterFuel.value='';renderVtHistory();});window.openVtFuelModal=openVtFuelModal;window.closeVtFuelModal=closeVtFuelModal;window.renderVtHistory=renderVtHistory;window.openVtFuelHistory=openVtFuelHistory;window.seedVtTestData=async function(){const entries=[{description: 'Abastecimento 1',vehicle: 'Moto',odometer: 17875,fuelType: 'Gasolina',pricePerLiter: 5.79,liters: 9.51,amount: 55.06,date: new Date().toISOString()},{description: 'Abastecimento 2',vehicle: 'Moto',odometer: 18163,fuelType: 'Gasolina',pricePerLiter: 5.79,liters: 10.28,amount: 59.52,date: new Date(new Date().getTime() + 1000).toISOString()}];try{if (window.appApi && typeof window.appApi.saveVtEntry==='function'){for (const e of entries) await window.appApi.saveVtEntry(e);}else{const date=(window.state && window.state.currentDate) ? window.state.currentDate : new Date();const y=String(date.getFullYear());const m=String(String(date.getMonth()+1).padStart(2,'0'));window.state=window.state ||{currentDate: date,appData:{data:{}}};if (!window.state.appData) window.state.appData={data:{}};if (!window.state.appData.data[y]) window.state.appData.data[y]={};if (!window.state.appData.data[y][m]) window.state.appData.data[y][m]={incomes: [],expenses: [],savings: [],vtUsage: []};for (const e of entries){e.id=e.id || ('seed-' + Math.random().toString(36).slice(2,8));window.state.appData.data[y][m].vtUsage.push(e);}try{await storage.saveData(window.state.appData);}catch(e){}}showToast('Dados de teste adicionados (VT).','bg-green-600');renderVtHistory();if (window.appApi && typeof window.appApi.render==='function') window.appApi.render();else if (typeof render==='function') render();}catch (err){console.error('seedVtTestData',err);showToast('Falha ao inserir dados de teste.','bg-red-600');}};});})();function confirmAsync(message,title){if (window.showConfirm) return window.showConfirm(message,title);return Promise.resolve(window.confirm(message));}function showToast(message,color='bg-blue-600'){let toast=document.getElementById('toast');if (!toast){return;}toast.textContent=message;toast.className=`${color}text-white px-4 py-2 rounded shadow-lg`;if (toast.parentNode !==document.body){document.body.appendChild(toast);}toast.style.position='fixed';toast.style.bottom='1rem';toast.style.left='50%';toast.style.transform='translateX(-50%)';toast.style.zIndex='2147483647';toast.style.display='block';toast.style.pointerEvents='auto';if (window.__toastTimeout) clearTimeout(window.__toastTimeout);window.__toastTimeout=setTimeout(()=>{try{toast.style.display='none';}catch(e){}},2500);}function setTransactionError(msg){try{const el=document.getElementById('transaction-error');if (!el) return;el.textContent=msg || 'Erro';el.classList.remove('hidden');}catch (e){console.error('setTransactionError',e);}}function clearTransactionError(){try{const el=document.getElementById('transaction-error');if (!el) return;el.textContent='';el.classList.add('hidden');}catch (e){console.error('clearTransactionError',e);}}function ensureLoadingOverlay(){if (document.getElementById('global-loading-overlay')) return;const overlay=document.createElement('div');overlay.id='global-loading-overlay';overlay.style.position='fixed';overlay.style.left='0';overlay.style.top='0';overlay.style.right='0';overlay.style.bottom='0';overlay.style.background='rgba(0,0,0,0.45)';overlay.style.display='flex';overlay.style.alignItems='center';overlay.style.justifyContent='center';overlay.style.zIndex='120000';overlay.innerHTML=`<div style="display:flex;flex-direction:column;align-items:center;gap:12px;background:white;padding:24px;border-radius:8px;"><div style="font-size:18px;font-weight:600;color:#1d1d1f;">Salvando...</div></div>`;document.body.appendChild(overlay);}function showLoading(){try{ensureLoadingOverlay();const o=document.getElementById('global-loading-overlay');if (o) o.style.display='flex';}catch(e){console.error('showLoading',e);}}function hideLoading(){try{const o=document.getElementById('global-loading-overlay');if (o) o.style.display='none';}catch(e){console.error('hideLoading',e);}}(function(){const importBtn=document.getElementById('import-data-btn');const importModal=document.getElementById('import-json-modal');const importFileInputModal=document.getElementById('import-file-input-modal');const importFileInfo=document.getElementById('import-file-info');const parseImportBtn=document.getElementById('parse-import-btn');const clearImportBtn=document.getElementById('clear-import-btn');const importPreview=document.getElementById('import-preview');const importConfirmBtn=document.getElementById('import-confirm-btn');const importCancelBtn=document.getElementById('import-cancel-btn');const closeImportModal=document.getElementById('close-import-modal');let parsedData=null;function resetImportModal(){parsedData=null;importFileInputModal.value='';importFileInfo.textContent='Nenhum arquivo selecionado.';importPreview.textContent='Nenhum preview disponï¿½ï¿½vel.';importConfirmBtn.disabled=true;}async function parseSelectedFile(file){try{const text=await file.text();let json=null;try{json=JSON.parse(text);}catch (e){throw new Error('Arquivo JSON invï¿½ï¿½lido: ' + e.message);}const payload=json.financeAppDB_v10 ? json.financeAppDB_v10 : json;if (!payload || typeof payload !=='object') throw new Error('Estrutura invï¿½ï¿½lida no JSON. Esperado objeto principal.');parsedData=payload;const pretty=JSON.stringify(payload,null,2);importPreview.textContent=pretty.length > 20000 ? pretty.slice(0,20000) + '\n\n...Conteï¿½do truncado...' : pretty;importFileInfo.textContent=`${file.name}â€” ${Math.round(file.size/1024)}KB`;importConfirmBtn.disabled=false;showToast('Arquivo validado com sucesso. Revise o preview e confirme.','bg-green-600');}catch (err){parsedData=null;importPreview.textContent='Erro: ' + err.message;importConfirmBtn.disabled=true;showToast('Erro ao ler arquivo: ' + err.message,'bg-red-600');}}if (importBtn){importBtn.addEventListener('click',()=>{if (!importModal) return;try{importModal.showModal();}catch(e){importModal.setAttribute('open','');}resetImportModal();});}if (closeImportModal) closeImportModal.addEventListener('click',resetImportModal);if (importCancelBtn) importCancelBtn.addEventListener('click',()=>{if (!importModal) return;try{importModal.close();}catch(e){importModal.removeAttribute('open');}resetImportModal();});if (clearImportBtn) clearImportBtn.addEventListener('click',resetImportModal);if (importFileInputModal){importFileInputModal.addEventListener('change',(e)=>{const f=e.target.files && e.target.files[0];if (!f) return resetImportModal();importFileInfo.textContent=`Arquivo: ${f.name}â€” ${Math.round(f.size/1024)}KB`;importPreview.textContent='Arquivo selecionado. Clique em "Ler e Validar" para ver o preview.';importConfirmBtn.disabled=true;parsedData=null;});}if (parseImportBtn) parseImportBtn.addEventListener('click',async ()=>{const f=importFileInputModal.files && importFileInputModal.files[0];if (!f){showToast('Selecione um arquivo .json primeiro.','bg-yellow-600');return;}await parseSelectedFile(f);});if (importConfirmBtn) importConfirmBtn.addEventListener('click',async ()=>{if (!parsedData){showToast('Nenhum dado vï¿½ï¿½lido para importar.','bg-yellow-600');return;}try{showLoading();await storage.saveData(parsedData);hideLoading();showToast('Dados importados com sucesso!','bg-green-600');location.reload();}catch (err){hideLoading();showToast('Erro ao importar dados: ' + (err.message || err),'bg-red-600');}});})();document.addEventListener('DOMContentLoaded',()=>{});(function(){const modal=document.getElementById('transaction-modal');const openBtn=document.getElementById('add-transaction-btn') || document.getElementById('mobile-add-transaction-fab');const closeBtn=document.getElementById('close-transaction-modal');let lastFocused=null;function trapFocus(e){if (!modal || !modal.open) return;const focusable=modal.querySelectorAll('a[href],button:not([disabled]),input:not([disabled]),select:not([disabled]),textarea:not([disabled]),[tabindex]:not([tabindex="-1"])');if (!focusable.length) return;const first=focusable[0];const last=focusable[focusable.length - 1];if (e.key==='Tab'){if (e.shiftKey && document.activeElement===first){e.preventDefault();last.focus();}else if (!e.shiftKey && document.activeElement===last){e.preventDefault();first.focus();}}else if (e.key==='Escape'){e.preventDefault();closeModal();}}function openModal(){if (!modal) return;try{lastFocused=document.activeElement;}catch(e){lastFocused=null;}try{modal.showModal();}catch(e){modal.setAttribute('open','');}modal.classList.add('modal-expanded');const firstInput=modal.querySelector('input,select,textarea,button');if (firstInput) try{firstInput.focus();}catch(e){}document.addEventListener('keydown',trapFocus);}function closeModal(){if (!modal) return;try{modal.close();}catch(e){modal.removeAttribute('open');}modal.classList.remove('modal-expanded');document.removeEventListener('keydown',trapFocus);try{if (lastFocused && typeof lastFocused.focus==='function') lastFocused.focus();}catch(e){}}if (openBtn) openBtn.addEventListener('click',(e)=>{e.preventDefault();openModal();});if (closeBtn) closeBtn.addEventListener('click',(e)=>{e.preventDefault();closeModal();});if (modal) modal.addEventListener('close',()=>{document.removeEventListener('keydown',trapFocus);});window.openTransactionModal=openModal;window.closeTransactionModal=closeModal;})();(function(){function addDoubleClickToClose(dialog){if (!dialog || dialog._doubleClickAdded) return;dialog._doubleClickAdded=true;dialog.addEventListener('dblclick',function(e){const rect=dialog.getBoundingClientRect();const isInDialog=( e.clientX >=rect.left && e.clientX <=rect.right && e.clientY >=rect.top && e.clientY <=rect.bottom );if (e.target===dialog){try{dialog.close();}catch(err){dialog.removeAttribute('open');dialog.style.display='none';}}});}function initDoubleClickForAllModals(){const modals=document.querySelectorAll('dialog');modals.forEach(modal=> addDoubleClickToClose(modal));}if (document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initDoubleClickForAllModals);}else{initDoubleClickForAllModals();}const observer=new MutationObserver(function(mutations){mutations.forEach(function(mutation){mutation.addedNodes.forEach(function(node){if (node.nodeName==='DIALOG'){addDoubleClickToClose(node);}});});});observer.observe(document.body,{childList: true,subtree: true});window.addDoubleClickToCloseModal=addDoubleClickToClose;})();const firebaseConfig={apiKey: "AIzaSyBRce273SxZo3EMFAoTQ5I0j82eDyIrYC4",authDomain: "fluxofinanceiro-marc35.firebaseapp.com",databaseURL: "https: projectId: "fluxofinanceiro-marc35",storageBucket: "fluxofinanceiro-marc35.appspot.com",messagingSenderId: "855674664271",appId: "1:855674664271:web:85ad6887626ece0dc8813a",measurementId: "G-NKKNQFLP00"};if (!firebase.apps.length){firebase.initializeApp(firebaseConfig);}const database=firebase.database();const storage={DB_KEY: 'financeAppDB_v10',loadData: async function(){const initialData=this.getInitialData();try{const snapshot=await database.ref(this.DB_KEY).get();if (!snapshot.exists()){await this.saveData(initialData);return initialData;}(function(){if (document.getElementById('import-spreadsheet-modal')) return;const modal=document.createElement('dialog');modal.id='import-spreadsheet-modal';modal.className='p-6 rounded-2xl shadow-2xl card w-full max-w-2xl';modal.innerHTML=` <h3 class="text-lg font-semibold mb-3">Importar Planilha (.xlsx / .csv)</h3> <p class="text-sm text-gray-600 mb-3">Use o modelo simples: <strong>Data,Descriï¿½ï¿½o,Valor,FormaPagamento,Categoria,Pago</strong></p> <div class="space-y-3"> <input type="file" id="import-spreadsheet-input" accept=".xlsx,.xls,.csv" /> <div id="import-preview" style="max-height:300px;overflow:auto;border:1px solid rgba(0,0,0,0.04);padding:8px;border-radius:8px;display:none;"></div> <div class="flex justify-end gap-2 mt-3"> <button id="import-preview-cancel" class="bg-gray-100 px-3 py-1 rounded">Fechar</button> <button id="import-preview-run" class="bg-blue-600 text-white px-3 py-1 rounded" disabled>Importar para o Mï¿½s selecionado</button> </div> </div> `;document.body.appendChild(modal);const fileInput=modal.querySelector('#import-spreadsheet-input');const previewEl=modal.querySelector('#import-preview');const runBtn=modal.querySelector('#import-preview-run');const closeBtn=modal.querySelector('#import-preview-cancel');function normalizeHeader(h){return String(h||'').toLowerCase().replace(/[^a-z0-9]/g,'');}function findHeaderMap(headers){const map={};const norm=headers.map(h=> ({raw:h,n:normalizeHeader(h)}));const keys={date: ['date','data','dia'],desc: ['descricao','description','historico','hist'],amount: ['valor','amount','montante'],payment: ['formapagamento','payment','pagamento','meiopagamento'],category: ['categoria','category'],paid: ['pago','paid','ispaid']};for (const k of Object.keys(keys)){for (const candidate of keys[k]){const found=norm.find(h=> h.n===candidate || h.n.indexOf(candidate) !==-1);if (found){map[k]=found.raw;break;}}}return map;}fileInput.addEventListener('change',async (ev)=>{const f=ev.target.files && ev.target.files[0];if (!f) return;previewEl.style.display='none';previewEl.innerHTML='';runBtn.disabled=true;try{const data=await f.arrayBuffer();let wb;if (f.name.toLowerCase().endsWith('.csv')){const text=new TextDecoder('utf-8').decode(data);wb=XLSX.read(text,{type: 'string'});}else{wb=XLSX.read(data,{type: 'array'});}const sheetName=wb.SheetNames[0];const sheet=wb.Sheets[sheetName];const rows=XLSX.utils.sheet_to_json(sheet,{defval: ''});if (!rows || rows.length===0){previewEl.innerHTML='<div class="text-sm text-red-600">Planilha vazia ou invï¿½ï¿½lida.</div>';previewEl.style.display='block';return;}const headers=Object.keys(rows[0]);const map=findHeaderMap(headers);const tbl=document.createElement('table');tbl.style.width='100%';tbl.style.borderCollapse='collapse';const thead=document.createElement('thead');const trh=document.createElement('tr');['Data','Descriï¿½ï¿½o','Valor','FormaPagamento','Categoria','Pago'].forEach(h=>{const th=document.createElement('th');th.textContent=h;th.style.textAlign='left';th.style.padding='6px';trh.appendChild(th);});thead.appendChild(trh);tbl.appendChild(thead);const tb=document.createElement('tbody');const mappedRows=[];for (const r of rows){const dr={};dr.date=map.date ? r[map.date] : r['Date'] || r['Data'] || '';dr.description=map.desc ? r[map.desc] : r['Description'] || r['Descriï¿½ï¿½o'] || r['Historico'] || '';dr.amount=map.amount ? r[map.amount] : r['Amount'] || r['Valor'] || '';dr.payment=map.payment ? r[map.payment] : r['Payment'] || r['FormaPagamento'] || '';dr.category=map.category ? r[map.category] : r['Category'] || r['Categoria'] || '';dr.paid=map.paid ? r[map.paid] : r['Paid'] || r['Pago'] || '';mappedRows.push(dr);const tr=document.createElement('tr');[dr.date,dr.description,dr.amount,dr.payment,dr.category,dr.paid].forEach(v=>{const td=document.createElement('td');td.textContent=(v===null||v===undefined)?'':v;td.style.padding='6px';td.style.borderTop='1px solid rgba(0,0,0,0.04)';tr.appendChild(td);});tb.appendChild(tr);}tbl.appendChild(tb);previewEl.appendChild(tbl);previewEl.style.display='block';runBtn.disabled=false;runBtn.onclick=async ()=>{try{let targetYear=null;let targetMonth=null;for (const rr of mappedRows){const dv=new Date(rr.date);if (!isNaN(dv)){targetYear=dv.getFullYear();targetMonth=dv.getMonth()+1;break;}}if (!targetYear){targetYear=(new Date()).getFullYear();targetMonth=(new Date()).getMonth()+1;}let positives=0,negatives=0;for (const rr of mappedRows){const n=parseFloat(String(rr.amount).replace(/[^0-9-,.]/g,'').replace(',','.')) || 0;if (n>0) positives++;if (n<0) negatives++;}const targetArray=(negatives > positives) ? 'expenses' : 'incomes';const totalRows=mappedRows.length;const sum=mappedRows.reduce((acc,rr)=>{const v=parseFloat(String(rr.amount).replace(/[^0-9-,.]/g,'').replace(',','.')) || 0;return acc + v;},0);previewEl.innerHTML='';previewEl.style.display='block';const summary=document.createElement('div');summary.innerHTML=` <div class="mb-3 text-sm text-gray-700">Resumo antes de importar:</div> <ul class="text-sm text-gray-800" style="padding-left:16px;"> <li><strong>Linhas detectadas:</strong> ${totalRows}</li> <li><strong>Direï¿½ï¿½o inferida:</strong> ${targetArray}</li> <li><strong>Mï¿½s / Ano alvo:</strong> ${targetMonth}/${targetYear}</li> <li><strong>Soma (considerando sinais):</strong> ${formatCurrency(sum)}</li> </ul> `;const actions=document.createElement('div');actions.className='flex justify-end gap-2 mt-4';const backupBtn=document.createElement('button');backupBtn.className='bg-gray-100 px-3 py-1 rounded text-sm';backupBtn.textContent='Baixar backup do Mï¿½s atual';const backBtn=document.createElement('button');backBtn.className='bg-white border px-3 py-1 rounded text-sm';backBtn.textContent='Voltar';const confirmBtn=document.createElement('button');confirmBtn.className='bg-green-600 text-white px-3 py-1 rounded text-sm';confirmBtn.textContent='Confirmar importaï¿½ï¿½o';actions.appendChild(backupBtn);actions.appendChild(backBtn);actions.appendChild(confirmBtn);previewEl.appendChild(summary);previewEl.appendChild(actions);backupBtn.addEventListener('click',()=>{try{const existing=(state && state.appData && state.appData.data && state.appData.data[targetYear] && state.appData.data[targetYear][targetMonth]) ||{incomes:[],expenses:[],savings:[]};const blob=new Blob([JSON.stringify(existing,null,2)],{type: 'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`backup-${targetYear}-${String(targetMonth).padStart(2,'0')}.json`;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);}catch (e){showToast('Falha ao gerar backup: ' + (e.message||e),'bg-red-600');}});backBtn.addEventListener('click',()=>{previewEl.innerHTML='';previewEl.appendChild(tbl);previewEl.appendChild(runBtn);runBtn.disabled=false;});confirmBtn.addEventListener('click',async ()=>{try{confirmBtn.disabled=true;backupBtn.disabled=true;backBtn.disabled=true;showLoading();const items=[];for (const rr of mappedRows){const amt=Math.abs(parseFloat(String(rr.amount).replace(/[^0-9-,.]/g,'').replace(',','.') || 0));const item={id: 'imp-' + Math.random().toString(36).slice(2,9),description: String(rr.description || '').trim() || 'Importado',amount: Number((amt||0).toFixed(2)),payment: rr.payment || undefined,category: rr.category || undefined,isPaid: String(rr.paid || '').toLowerCase().indexOf('s')===0 || String(rr.paid || '').toLowerCase().indexOf('t')===0 || String(rr.paid || '')==='1'};items.push(item);}const saveTarget=JSON.parse(JSON.stringify(state.appData ||{}));saveTarget.data=saveTarget.data ||{};saveTarget.data[targetYear]=saveTarget.data[targetYear] ||{};saveTarget.data[targetYear][targetMonth]=saveTarget.data[targetYear][targetMonth] ||{incomes: [],expenses: [],savings: []};saveTarget.data[targetYear][targetMonth][targetArray]=(saveTarget.data[targetYear][targetMonth][targetArray] || []).concat(items);await storage.saveData(saveTarget);hideLoading();showToast('ImportaÃ§Ã£o concluÃ­da com sucesso!','bg-green-600');try{modal.close();}catch(e){modal.removeAttribute('open');}location.reload();}catch (err){hideLoading();showToast('Falha ao salvar: ' + (err && err.message ? err.message : String(err)),'bg-red-600');confirmBtn.disabled=false;backupBtn.disabled=false;backBtn.disabled=false;}});runBtn.disabled=true;}catch (e){hideLoading();showToast('Erro durante preparaï¿½ï¿½o da importaï¿½ï¿½o: '+ (e && e.message ? e.message : e),'bg-red-600');}};}catch (err){previewEl.innerHTML='<div class="text-sm text-red-600">Erro ao ler o arquivo: ' + (err && err.message ? err.message : err) + '</div>';previewEl.style.display='block';}});closeBtn.addEventListener('click',()=>{try{modal.close();}catch(e){modal.removeAttribute('open');}});})();const firebaseData=snapshot.val();const mergedData={settings:{...initialData.settings,...(firebaseData.settings ||{})},data: firebaseData.data || initialData.data};mergedData.settings.goals=mergedData.settings.goals || [];mergedData.settings.paymentMethods=mergedData.settings.paymentMethods || [];return mergedData;}catch (err){return initialData;}},sanitizeForFirebase: function(obj){const seen=new WeakSet();function sanitize(value){if (value===null) return null;const t=typeof value;if (t==='string' || t==='number' || t==='boolean') return value;if (value instanceof Date) return value.toISOString();if (Array.isArray(value)) return value.map(v=> sanitize(v));if (t==='object'){if (seen.has(value)) return null;seen.add(value);const out={};Object.keys(value).forEach(k=>{if (/[.#$\[\]]/.test(k)) return;const v=value[k];const sv=sanitize(v);if (typeof sv !=='undefined') out[k]=sv;});return out;}return undefined;}return sanitize(obj);},saveData: function(data){try{showLoading();const safe=this.sanitizeForFirebase(data);return database.ref(this.DB_KEY).set(safe) .then(()=>{/* saved successfully */ hideLoading();return Promise.resolve();}) .catch(e=>{hideLoading();showToast('Erro ao salvar dados no Firebase: ' + (e && e.message ? e.message : e),'bg-red-600');return Promise.reject(e);});}catch (err){hideLoading();showToast('Erro interno ao preparar dados para salvar.','bg-red-600');return Promise.reject(err);}},getInitialData: function(){return{settings:{goals: [],spendingGoals: [{type: 'Essenciais',goal: 0.50},{type: 'nï¿½o Essenciais',goal: 0.30},{type: 'Reserva',goal: 0.20}],expenseCategories: [ "Mercado","Alimentaï¿½ï¿½o","Compras","Assinaturas","Contas","Moradia","Transporte","Saï¿½ï¿½de","Educaï¿½ï¿½o","Lazer","Viagem","Vestuï¿½ï¿½rio","Casa","Pets","DoAï¿½ï¿½ES","Impostos","Parcelas","Investimentos","Outros" ],savingCategories: [ "Reserva Emergï¿½ï¿½ncia","Aï¿½ï¿½ES","Fundos Imobiliï¿½ï¿½rios","Criptomoedas","Poupanï¿½a","Tesouro Direto","Previdï¿½ï¿½ncia","Viagem","Reforma","Educaï¿½ï¿½o","Carro","Imï¿½vel","Outros" ],paymentMethods: [{name: "BB (Dï¿½ï¿½bito)",type: "debit"},{name: "Inter (Dï¿½ï¿½bito)",type: "debit"},{name: "Nubank",type: "credit_card",closeDay: 3,dueDay: 10},{name: "Porto",type: "credit_card",closeDay: 31,dueDay: 11},{name: "Dinheiro",type: "cash"},{name: "PIX",type: "pix"},{name: "Transferï¿½ï¿½ncia",type: "transfer"},{name: "Boleto",type: "boleto"},{name: "Apple Pay",type: "wallet"},{name: "Outro",type: "other"}],feedbackMessages: [{id: 'A',text: "ï¿½timo trabalho! vocï¿½ superou sua meta de reserva este Mï¿½s!"},{id: 'B',text: "Missï¿½o cumprida! Suas finanï¿½as esTï¿½o alinhadas com as metas."},{id: 'C',text: "Atenï¿½ï¿½o com os gastos nï¿½o essenciais. Eles esTï¿½o um pouco acima da meta."},{id: 'D',text: "Os gastos essenciais superaram a meta. Vale a pena revisar."},{id: 'E',text: "Sua reserva este Mï¿½s foi menor que o esperado. Foco em economizar!"},{id: 'F',text: "O saldo deste Mï¿½s ficou negativo. Vamos repensar a estraTï¿½ï¿½gia."}]},data:{}};},propagateInitialInstallments(initialData){}};const App=(function(){const state={currentDate: new Date(),appData: null,currentView: 'dashboard',sort:{key: 'description',order: 'asc'},filters:{searchTerm: ''},showGroupedExpenses: false,cardGrouped:{}};try{window.state=state;}catch (e){/* ignore if env prevents assignment */}const ui={charts:{}};ui.lastTransactionDefaults=null;function generateUUID(){return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){const r=Math.random() * 16 | 0,v=c==='x' ? r : (r & 0x3 | 0x8);return v.toString(16);});}function parseLocaleNumber(s){try{if (s===undefined || s===null) return NaN;if (typeof s==='number') return s;let str=String(s).trim();if (str==='') return NaN;str=str.replace(/[R$\s\u00A0]/g,'');str=str.replace(/(?!^)-/g,'');if (str==='' || str==='-') return NaN;const hasBRDecimal=/,\d{1,2}$/.test(str);const hasUSDecimal=/\.\d{1,2}$/.test(str);if (hasBRDecimal){str=str.replace(/\./g,'').replace(',','.');}else if (hasUSDecimal){str=str.replace(/,/g,'');}else{str=str.replace(/[.,]/g,'');}str=str.replace(/[^0-9.\-]/g,'');const v=parseFloat(str);return isNaN(v) ? NaN : v;}catch (e){return NaN;}}function safeGenerateId(){try{if (typeof generateUUID==='function') return generateUUID();}catch(e){}return 'id-' + Math.random().toString(36).slice(2,10) + Date.now().toString(36);}async function saveVtEntry(entry){try{if (!entry) throw new Error('empty entry');if (!state.appData) state.appData={data:{}};if (!state.appData.data) state.appData.data={};const date=state.currentDate || new Date();const year=String(date.getFullYear());const month=String(String(date.getMonth() + 1).padStart(2,'0'));if (!state.appData.data[year]) state.appData.data[year]={};if (!state.appData.data[year][month]) state.appData.data[year][month]={incomes: [],expenses: [],savings: [],vtUsage: []};const md=state.appData.data[year][month];if (!Array.isArray(md.vtUsage)) md.vtUsage=[];entry.id=entry.id || generateUUID();entry.date=entry.date || new Date().toISOString();md.vtUsage.push(entry);await storage.saveData(state.appData);return{success: true};}catch (e){throw e;}}async function updateVtEntry(updated){try{if (!updated || !updated.id) throw new Error('invalid update');if (!state.appData || !state.appData.data) throw new Error('no app data');let found=false;Object.keys(state.appData.data).forEach(y=>{Object.keys(state.appData.data[y] ||{}).forEach(m=>{const md=state.appData.data[y][m] ||{};if (!Array.isArray(md.vtUsage)) return;for (let i=0;i < md.vtUsage.length;i++){const it=md.vtUsage[i];if (it && it.id===updated.id){md.vtUsage[i]=Object.assign({},it,updated);found=true;break;}}});});if (!found) throw new Error('entry not found');await storage.saveData(state.appData);return{success: true};}catch (e){console.error('updateVtEntry error',e);throw e;}}try{window.appApi=window.appApi ||{};window.appApi.saveVtEntry=saveVtEntry;window.appApi.updateVtEntry=updateVtEntry;window.appApi.render=function(){try{if (typeof render==='function') return render();}catch(e){console.error('appApi.render wrapper error',e);}};}catch(e){/* ignore env failures */}function formatCurrency(value){if (typeof value !=='number') value=parseFloat(value) || 0;return value.toLocaleString('pt-BR',{style: 'currency',currency: 'BRL',minimumFractionDigits: 2,maximumFractionDigits: 2});}function propagateRecurringTransactions(){try{const today=new Date();Object.keys(state.appData.data).forEach(year=>{Object.keys(state.appData.data[year]).forEach(month=>{const monthData=state.appData.data[year][month];['incomes','expenses','savings'].forEach(type=>{if (!Array.isArray(monthData[type])) monthData[type]=[];});});});const templates={};Object.keys(state.appData.data).forEach(year=>{Object.keys(state.appData.data[year]).forEach(month=>{const monthData=state.appData.data[year][month];['expenses','savings'].forEach(type=>{(monthData[type] || []).forEach(item=>{try{if (item && item.isRecurring && item.recurringId){if (!templates[item.recurringId]){const tpl=Object.assign({},item);delete tpl.id;if (tpl.date) delete tpl.date;templates[item.recurringId]={type,template: tpl};}}}catch (e){/* ignore malformed items */}});});});});const monthsToCreate=12;const added=[];Object.keys(templates).forEach(rid=>{const info=templates[rid];for (let i=0;i < monthsToCreate;i++){const target=new Date(today.getFullYear(),today.getMonth() + i,1);const y=String(target.getFullYear());const m=String(String(target.getMonth() + 1).padStart(2,'0'));if (!state.appData.data[y]) state.appData.data[y]={};if (!state.appData.data[y][m]) state.appData.data[y][m]={incomes: [],expenses: [],savings: []};const md=state.appData.data[y][m];if (!Array.isArray(md[info.type])) md[info.type]=[];const exists=(md[info.type] || []).some(it=> it && it.recurringId===rid);if (!exists){const clone=Object.assign({},info.template);clone.id=generateUUID();clone.recurringId=rid;clone.date=new Date(target.getFullYear(),target.getMonth(),1).toISOString();clone.isPaid=!!clone.isPaid && i===0 ? clone.isPaid : false;md[info.type].push(clone);added.push({y,m,type: info.type,id: clone.id});}}});if (added.length > 0){try{storage.saveData(state.appData).catch(()=>{});}catch(e){}}}catch (e){console.error('propagateRecurringTransactions',e);}}/** * Propagate a changed amount for subscription/recurring expenses to future months. * expense: the expense object in the current month that was edited * newAmount: number */ async function propagateSubscriptionAmountChange(expense,newAmount){try{if (!expense || typeof newAmount !=='number') return;const recurringId=expense.recurringId || null;const signature=`${(expense.description||'').toString().trim().toLowerCase()}||${(expense.category||'').toString().trim().toLowerCase()}||${(expense.payment||'').toString().trim().toLowerCase()}`;const now=new Date(state.currentDate || new Date());const monthsToUpdate=24;const updated=[];for (let i=1;i <=monthsToUpdate;i++){const target=new Date(now.getFullYear(),now.getMonth() + i,1);const y=String(target.getFullYear());const m=String(String(target.getMonth() + 1).padStart(2,'0'));const md=(state.appData.data && state.appData.data[y] && state.appData.data[y][m]) ? state.appData.data[y][m] : null;if (!md) continue;if (!Array.isArray(md.expenses)) continue;md.expenses.forEach(e=>{try{if (!e) return;let match=false;if (recurringId && e.recurringId && e.recurringId===recurringId) match=true;if (!match){const sig2=`${(e.description||'').toString().trim().toLowerCase()}||${(e.category||'').toString().trim().toLowerCase()}||${(e.payment||'').toString().trim().toLowerCase()}`;if (sig2===signature) match=true;}if (match){e.amount=newAmount;updated.push({y,m,id: e.id});}}catch(ex){/* ignore */}});}if (updated.length > 0){try{await storage.saveData(state.appData);}catch(e){console.error('save propagateSubscriptionAmountChange',e);}}return updated;}catch(e){console.error('propagateSubscriptionAmountChange error',e);return [];}}async function init(){state.appData=await storage.loadData();state.currentDate=new Date();try{if (!state.appData.settings) state.appData.settings={};if (!Array.isArray(state.appData.settings.paymentMethods)) state.appData.settings.paymentMethods=[];state.appData.settings.paymentMethods.forEach(pm=>{if (pm.type==='credit_card'){if (pm.name==='Nubank' && !pm.closeDay){pm.closeDay=3;pm.dueDay=10;}else if (pm.name==='Porto' && !pm.closeDay){pm.closeDay=31;pm.dueDay=11;}}});}catch(e){console.error('credit card migration',e);}state.filters={searchTerm: ''};state.filters.expenseFilters={};if (!state.appData){return;}try{const s=state.appData.settings ||{};if (Array.isArray(s.expenseCategories)) s.expenseCategories=sortStrings(s.expenseCategories);if (Array.isArray(s.savingCategories)) s.savingCategories=sortStrings(s.savingCategories);if (Array.isArray(s.goals)) s.goals=(s.goals || []).slice().sort((a,b)=> ((a.name||'').toLowerCase() < (b.name||'').toLowerCase() ? -1 : 1));if (Array.isArray(s.paymentMethods)) s.paymentMethods=(s.paymentMethods || []).slice().sort((a,b)=> ((a.name||'').toLowerCase() < (b.name||'').toLowerCase() ? -1 : 1));state.appData.settings=s;storage.saveData(state.appData).catch(()=>{});}catch(e){/* non-fatal */}mapUI();bindEvents();try{Object.keys(state.appData.data).forEach(year=>{Object.keys(state.appData.data[year]).forEach(month=>{const md=state.appData.data[year][month];if (!md) return;if (!Array.isArray(md.incomes)) md.incomes=[];if (!Array.isArray(md.vrLedger)) md.vrLedger=[];if (!Array.isArray(md.vtLedger)) md.vtLedger=[];if (!Array.isArray(md.vrUsage)) md.vrUsage=[];if (!Array.isArray(md.vtUsage)) md.vtUsage=[];const preserved=[];md.incomes.forEach(i=>{if (i && i.source==='benefit-vr'){md.vrLedger.push({id: i.id || generateUUID(),amount: i.amount || 0,recurringId: i.recurringId || null,isRecurring: !!i.isRecurring,salaryMeta: i.salaryMeta || null});}else preserved.push(i);});md.incomes=preserved;try{if (Array.isArray(md.vrLedger) && md.vrLedger.length > 1){const seen=new Map();md.vrLedger=md.vrLedger.slice().reverse().filter(l=>{try{const key=`${JSON.stringify(l.salaryMeta||{})}::${Number(l.amount||0)}`;if (seen.has(key)) return false;seen.set(key,true);return true;}catch(e){return true;}}).reverse();}}catch(e){/* non-fatal */}});});}catch(e){console.error('VR migration',e);}try{Object.keys(state.appData.data).forEach(year=>{Object.keys(state.appData.data[year]).forEach(month=>{const md=state.appData.data[year][month];if (!md) return;if (!Array.isArray(md.incomes)) md.incomes=[];if (!Array.isArray(md.vtLedger)) md.vtLedger=[];if (!Array.isArray(md.vtUsage)) md.vtUsage=[];const preserved=[];md.incomes.forEach(i=>{if (i && i.source==='benefit-vt'){md.vtLedger.push({id: i.id || generateUUID(),amount: i.amount || 0,recurringId: i.recurringId || null,isRecurring: !!i.isRecurring,salaryMeta: i.salaryMeta || null});}else preserved.push(i);});md.incomes=preserved;try{if (Array.isArray(md.vtLedger) && md.vtLedger.length > 1){const seen2=new Map();md.vtLedger=md.vtLedger.slice().reverse().filter(l=>{try{const key=`${JSON.stringify(l.salaryMeta||{})}::${Number(l.amount||0)}`;if (seen2.has(key)) return false;seen2.set(key,true);return true;}catch(e){return true;}}).reverse();}}catch(e){/* non-fatal */}const remainingExpenses=[];md.expenses=md.expenses || [];md.expenses.forEach(exp=>{try{if (exp && (exp.payment || '').toString()==='VT'){md.vtUsage.push({id: exp.id || generateUUID(),amount: Number(exp.amount) || 0,description: exp.description || '',date: exp.date || new Date().toISOString()});}else{remainingExpenses.push(exp);}}catch (e){remainingExpenses.push(exp);}});md.expenses=remainingExpenses;});});}catch(e){console.error('VT migration',e);}try{let migratedCount=0;Object.keys(state.appData.data).forEach(year=>{Object.keys(state.appData.data[year]).forEach(month=>{const md=state.appData.data[year][month];if (!md) return;if (!Array.isArray(md.expenses)) md.expenses=[];if (!Array.isArray(md.vrUsage)) md.vrUsage=[];const remainingExpenses=[];md.expenses.forEach(exp=>{try{if (exp && (exp.payment || '').toString()==='VR'){md.vrUsage.push({id: exp.id || generateUUID(),amount: Number(exp.amount) || 0,description: exp.description || '',date: exp.date || new Date().toISOString()});migratedCount++;}else{remainingExpenses.push(exp);}}catch (e){remainingExpenses.push(exp);}});md.expenses=remainingExpenses;});});if (migratedCount > 0){try{await storage.saveData(state.appData);}catch(e){console.error('Failed to persist VR migration',e);}}}catch (e){console.error('VR expenses migration',e);}try{let incomesUpdated=0;Object.keys(state.appData.data).forEach(year=>{Object.keys(state.appData.data[year]).forEach(month=>{const md=state.appData.data[year][month];if (!md) return;if (Array.isArray(md.incomes)){md.incomes.forEach(income=>{if (income && typeof income.isPaid==='undefined'){income.isPaid=false;incomesUpdated++;}});}if (Array.isArray(md.vrLedger)){md.vrLedger.forEach(entry=>{if (entry && typeof entry.isPaid==='undefined'){entry.isPaid=false;incomesUpdated++;}});}if (Array.isArray(md.vtLedger)){md.vtLedger.forEach(entry=>{if (entry && typeof entry.isPaid==='undefined'){entry.isPaid=false;incomesUpdated++;}});}});});if (incomesUpdated > 0){try{await storage.saveData(state.appData);}catch(e){console.error('Failed to persist income isPaid migration',e);}}}catch (e){console.error('Income isPaid migration',e);}goToDate(new Date());renderDashboard();try{const lastView=localStorage.getItem('lastActiveView');if (lastView && ['dashboard','credit-cards'].includes(lastView)){changeView(lastView);}}catch(e){console.error('Error restoring lastActiveView',e);}}function mapUI(){const ids=[ 'current-month-display','prev-month-btn','next-month-btn','today-btn','month-picker','month-picker-month','month-picker-year','month-picker-apply','month-picker-cancel','income-table-body','expenses-table-body','savings-table-body','expenses-table-head','toggle-expense-grouped','toggle-expense-grouped-label','expenses-grouped-container','expenses-groups','add-transaction-btn','transaction-modal','close-transaction-modal-btn','transaction-form','expense-fields','dashboard-view','credit-cards-view','credit-cards-container','installments-section','is-installment','search-description','installments-fields','installments-current','payment-method','is-recurring','payment-recipient','payment-recipient-wrapper','saving-fields','category-expense','category-saving','transaction-type-input','advanced-options','expense-type','feedback-visual-container','feedback-message','import-data-btn','import-file-input','export-data-btn','monthly-report-btn','annual-report-btn','monthly-report-modal','annual-report-modal','desktop-dashboard-btn','desktop-creditcards-btn','expenses-filter-btn','expenses-filter-popover','filter-payment-method','filter-spending-type','filter-category','filter-type','filter-recurring','filter-installment','filter-apply-btn','filter-clear-btn','close-monthly-report-btn','close-annual-report-btn','add-goal-btn','goal-modal','close-goal-modal-btn','goal-form','goals-container','financing-section' ];ids.forEach(id=>{const element=document.getElementById(id);if (element){if (id==='installments-section') ui.installmentsSection=element;else if (id==='financing-section') ui.financingSection=element;else ui[id.replace(/-./g,m=> m[1].toUpperCase())]=element;}});ui.applyToFuture=document.getElementById('apply-to-future');ui.previewFutureBtn=document.getElementById('preview-future-btn');ui.modalTypeToggles=document.querySelectorAll('.modal-type-toggle');ui.mobileBottomNav=document.getElementById('mobile-bottom-nav');const installmentCheckbox=document.getElementById('is-installment');const installmentFields=document.getElementById('installment-fields');const installmentCount=document.getElementById('installment-count');const amountField=document.getElementById('amount');const previewCount=document.getElementById('installment-preview-count');const previewValue=document.getElementById('installment-preview-value');if (installmentCheckbox && installmentFields){installmentCheckbox.addEventListener('change',function(){if (this.checked){installmentFields.classList.remove('hidden');updateInstallmentPreview();}else{installmentFields.classList.add('hidden');}});if (installmentCount && amountField && previewCount && previewValue){const updateInstallmentPreview=()=>{const count=parseInt(installmentCount.value) || 12;const amount=parseLocaleNumber(amountField.value) || 0;const installmentValue=count > 0 ? amount / count : 0;previewCount.textContent=count;previewValue.textContent=formatCurrency(installmentValue);};installmentCount.addEventListener('input',updateInstallmentPreview);amountField.addEventListener('input',updateInstallmentPreview);}}}function bindEvents(){if (ui.prevMonthBtn) ui.prevMonthBtn.addEventListener('click',()=> changeMonth(-1));if (ui.nextMonthBtn) ui.nextMonthBtn.addEventListener('click',()=> changeMonth(1));if (ui.todayBtn) ui.todayBtn.addEventListener('click',()=> goToDate(new Date()));if (ui.currentMonthDisplay) ui.currentMonthDisplay.addEventListener('click',(e)=>{e.stopPropagation();openMonthPicker();});if (ui.monthPickerCancel) ui.monthPickerCancel.addEventListener('click',closeMonthPicker);if (ui.monthPickerApply) ui.monthPickerApply.addEventListener('click',applyMonthPicker);document.addEventListener('click',(e)=>{const picker=ui.monthPicker;if (!picker) return;if (picker.classList.contains('hidden')) return;if (!picker.contains(e.target) && e.target !==ui.currentMonthDisplay) closeMonthPicker();});if (ui.addTransactionBtn) ui.addTransactionBtn.addEventListener('click',()=>{openModal('expenses');});if (ui.closeTransactionModalBtn) ui.closeTransactionModalBtn.addEventListener('click',()=> closeModal('transaction-modal'));const attachBackdropDoubleClickToClose=(modalEl,modalId,timeoutMs=2000)=>{if (!modalEl) return;let clickCount=0;let timer=null;modalEl.addEventListener('click',(e)=>{if (e.target !==modalEl) return;clickCount++;if (clickCount===1){try{showToast('Clique novamente no fundo para fechar o modal','bg-gray-700');}catch(e){}timer=setTimeout(()=>{clickCount=0;timer=null;},timeoutMs);return;}if (clickCount >=2){if (timer){clearTimeout(timer);timer=null;}clickCount=0;closeModal(modalId);}});};if (ui.transactionModal) attachBackdropDoubleClickToClose(ui.transactionModal,'transaction-modal');if (ui.goalModal) attachBackdropDoubleClickToClose(ui.goalModal,'goal-modal');if (ui.monthlyReportModal) attachBackdropDoubleClickToClose(ui.monthlyReportModal,'monthly-report-modal');if (ui.annualReportModal) attachBackdropDoubleClickToClose(ui.annualReportModal,'annual-report-modal');const salaryModalEl=document.getElementById('salary-breakdown-modal');if (salaryModalEl){attachBackdropDoubleClickToClose(salaryModalEl,'salary-breakdown-modal');const salaryCloseBtn=document.getElementById('close-salary-breakdown');if (salaryCloseBtn) salaryCloseBtn.addEventListener('click',()=> closeSalaryBreakdown());}if (ui.transactionForm) ui.transactionForm.addEventListener('submit',(e)=> handleFormSubmit(e));const isSalaryCheckbox=document.getElementById('is-salary');const salaryFields=document.getElementById('salary-fields');let autoCheckedSalary=false;if (isSalaryCheckbox){const amountInput=document.getElementById('amount');const salaryBaseInput=document.getElementById('salary-base');let amtToSalaryHandler=null;let salaryToAmtHandler=null;const attachSync=()=>{try{if (amountInput && salaryBaseInput){amtToSalaryHandler=function(){salaryBaseInput.value=this.value || '';};salaryToAmtHandler=function(){amountInput.value=this.value || '';};amountInput.addEventListener('input',amtToSalaryHandler);salaryBaseInput.addEventListener('input',salaryToAmtHandler);}}catch (e){console.error('attachSync error',e);}};const detachSync=()=>{try{if (amountInput && amtToSalaryHandler) amountInput.removeEventListener('input',amtToSalaryHandler);if (salaryBaseInput && salaryToAmtHandler) salaryBaseInput.removeEventListener('input',salaryToAmtHandler);amtToSalaryHandler=null;salaryToAmtHandler=null;}catch (e){console.error('detachSync error',e);}};isSalaryCheckbox.addEventListener('change',function(){if (salaryFields) salaryFields.classList.toggle('hidden',!this.checked);try{const modal=document.getElementById('transaction-modal');if (modal) modal.classList.toggle('modal-expanded',this.checked);}catch(e){}if (this.checked){try{const a=parseFloat((amountInput ||{value: ''}).value) || 0;const s=parseFloat((salaryBaseInput ||{value: ''}).value) || 0;if (s===0 && a > 0) salaryBaseInput.value=amountInput.value;else if (a===0 && s > 0) amountInput.value=salaryBaseInput.value;}catch(e){}attachSync();const recurringCheckbox=document.getElementById('is-recurring');if (recurringCheckbox) recurringCheckbox.checked=true;}else{detachSync();autoCheckedSalary=false;try{const modal=document.getElementById('transaction-modal');if (modal) modal.classList.remove('modal-expanded');}catch(e){}}});}const descInput=document.getElementById('description');if (descInput){const amountInput=document.getElementById('amount');let amountSyncAttached=false;let amountSyncHandler=null;descInput.addEventListener('input',function(){try{const raw=(this.value || '');const v=raw.toLowerCase();const normalized=raw.normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();const hasSalaryWord=v.indexOf('salari') !==-1;const isExactSalary=/^\s*salario?s?\s*$/i.test(normalized);const isServicoPrefix=/^\s*servi\w*/i.test(normalized);if (hasSalaryWord){if (ui.transactionTypeInput && ui.transactionTypeInput.value !=='incomes'){toggleTransactionType('incomes');}if (isSalaryCheckbox && !isSalaryCheckbox.checked){isSalaryCheckbox.checked=true;if (salaryFields) salaryFields.classList.remove('hidden');autoCheckedSalary=true;const recurringCheckbox=document.getElementById('is-recurring');if (recurringCheckbox) recurringCheckbox.checked=true;try{isSalaryCheckbox.dispatchEvent(new Event('change'));}catch(e){}}}else{if (autoCheckedSalary && isSalaryCheckbox){isSalaryCheckbox.checked=false;if (salaryFields) salaryFields.classList.add('hidden');autoCheckedSalary=false;}}const salaryBaseInput=document.getElementById('salary-base');if (isExactSalary){const recurringCheckbox=document.getElementById('is-recurring');if (isSalaryCheckbox && !isSalaryCheckbox.checked){isSalaryCheckbox.checked=true;if (salaryFields) salaryFields.classList.remove('hidden');autoCheckedSalary=true;try{isSalaryCheckbox.dispatchEvent(new Event('change'));}catch(e){}}if (recurringCheckbox) recurringCheckbox.checked=true;}if (isServicoPrefix){if (ui.transactionTypeInput && ui.transactionTypeInput.value !=='incomes'){toggleTransactionType('incomes');}try{const instSection=document.getElementById('installments-section');if (instSection) instSection.classList.remove('hidden');}catch(e){}}if (isExactSalary && amountInput){if (salaryBaseInput) salaryBaseInput.value=amountInput.value || '';if (!amountSyncAttached){amountSyncHandler=function(){try{if (salaryBaseInput) salaryBaseInput.value=this.value || '';}catch(e){}};amountInput.addEventListener('input',amountSyncHandler);amountSyncAttached=true;}}else{if (amountSyncAttached && amountInput && amountSyncHandler){amountInput.removeEventListener('input',amountSyncHandler);amountSyncAttached=false;amountSyncHandler=null;}}}catch (e){console.error('description auto-salary detect error',e);}});}ui.modalTypeToggles.forEach(btn=> btn.addEventListener('click',(e)=> toggleTransactionType(e.currentTarget.dataset.type)));ui.incomeTableBody.addEventListener('click',(e)=> handleTableClick(e,'incomes'));ui.expensesTableBody.addEventListener('click',(e)=> handleTableClick(e,'expenses'));ui.savingsTableBody.addEventListener('click',(e)=> handleTableClick(e,'savings'));ui.importDataBtn.addEventListener('click',()=> ui.importFileInput.click());ui.importFileInput.addEventListener('change',handleImport);ui.exportDataBtn.addEventListener('click',handleExport);try{const createBackupBtn=document.getElementById('create-backup-btn');const restoreBackupBtn=document.getElementById('restore-backup-btn');const backupModal=document.getElementById('backup-restore-modal');const backupsListEl=document.getElementById('backups-list');const backupPreviewEl=document.getElementById('backup-preview');const refreshBackupsBtn=document.getElementById('refresh-backups-btn');const closeBackupModalBtn=document.getElementById('close-backup-modal');const restoreSelectedBtn=document.getElementById('restore-selected-btn');const downloadPreviewBtn=document.getElementById('download-preview-btn');const deleteBackupBtn=document.getElementById('delete-backup-btn');let currentBackupId=null;function formatTS(d){try{const pad=(n,len=2)=> String(n).padStart(len,'0');const y=d.getFullYear();const m=pad(d.getMonth()+1);const day=pad(d.getDate());const hh=pad(d.getHours());const mm=pad(d.getMinutes());const ss=pad(d.getSeconds());return `${y}${m}${day}_${hh}${mm}${ss}`;}catch(e){return String(Date.now());}}async function createBackup(){try{showLoading();const payload=JSON.parse(JSON.stringify(state.appData ||{}));const createdAt=Date.now();const project=(firebaseConfig && firebaseConfig.projectId) ? firebaseConfig.projectId : 'manual';const name=`${project}-${formatTS(new Date(createdAt))}`;const record={name,createdAt,data: payload};const ref=database.ref('/backups').push();await ref.set(record);hideLoading();showToast('Backup criado com sucesso: ' + name,'bg-green-600');return record;}catch (err){hideLoading();showToast('Falha ao criar backup: ' + (err && err.message ? err.message : String(err)),'bg-red-600');throw err;}}async function listBackups(){try{try{const snapshot=await database.ref('/backups').orderByChild('createdAt').get();const arr=[];snapshot.forEach(s=>{arr.push({id: s.key,...(s.val()||{})});});arr.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));return arr;}catch (innerErr){if (innerErr && innerErr.message && innerErr.message.indexOf && innerErr.message.indexOf('Index not defined') !==-1){try{showToast('Aviso: ï¿½ï¿½ndice ausente em /backups.createdAt â€” listagem usando ordenaï¿½ï¿½o local. Para melhor performance adicione ".indexOn": ["createdAt"] nas regras do Realtime Database.','bg-yellow-600');}catch(e){}}else if (innerErr && innerErr.code && innerErr.code==='permission-denied'){throw innerErr;}else if (innerErr && innerErr.message && innerErr.message.indexOf && innerErr.message.indexOf('.indexOn') !==-1){}else{throw innerErr;}const snapshot=await database.ref('/backups').once('value');const arr=[];snapshot.forEach(s=>{arr.push({id: s.key,...(s.val()||{})});});arr.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));return arr;}}catch (e){console.error('listBackups',e);return [];}}function renderBackupsList(list){if (!backupsListEl) return;backupsListEl.innerHTML='';if (!list || list.length===0){backupsListEl.innerHTML='<div class="text-sm text-gray-500">Nenhum backup encontrado.</div>';return;}list.forEach(item=>{const btn=document.createElement('button');btn.className='w-full text-left p-2 rounded flex justify-between items-center';btn.dataset.backupid=item.id;const left=document.createElement('div');left.innerHTML=`<div style="font-weight:600">${escapeHtml(item.name||'Sem nome')}</div><div class="text-xs text-gray-500">${new Date(item.createdAt||0).toLocaleString()}</div>`;const right=document.createElement('div');right.innerHTML='<span class="material-symbols-outlined text-gray-500">chevron_right</span>';btn.appendChild(left);btn.appendChild(right);btn.addEventListener('click',async ()=>{try{showLoading();const snap=await database.ref('/backups/' + item.id).get();const val=snap.val();hideLoading();showBackupPreview(val,item.id);}catch (err){hideLoading();showToast('Falha ao carregar backup: ' + (err && err.message ? err.message : err),'bg-red-600');}});backupsListEl.appendChild(btn);});}function showBackupPreview(val,id){if (!backupPreviewEl) return;currentBackupId=id;if (!val){backupPreviewEl.innerHTML='<div class="text-sm text-gray-500">Sem dados de backup.</div>';return;}const meta=`<div class="text-sm text-gray-600 mb-2">Nome: <strong>${escapeHtml(val.name||'')}</strong> â€” Criado: ${new Date(val.createdAt||0).toLocaleString()}</div>`;let summary='';try{const years=Object.keys(val.data && val.data.data ? val.data.data : (val.data ||{}).data ||{});const topData=val.data ||{};const countYears=topData.data ? Object.keys(topData.data).length : Object.keys(topData).length;summary +=`<div class="text-sm text-gray-700 mb-2">Anos: <strong>${countYears}</strong></div>`;}catch(e){summary +='<div class="text-sm text-gray-500">Resumo indisponï¿½ï¿½vel.</div>';}backupPreviewEl.innerHTML=meta + summary + ` <div class="flex items-center gap-2 mb-2"> <button id="render-backup-cards-btn" class="px-3 py-1 rounded bg-blue-50 border text-sm text-blue-600">Preview</button> <span class="text-xs text-gray-400">Visualizar Conteï¿½do do backup como cards para comparaï¿½ï¿½o</span> </div> <div id="backup-cards-container" style="margin-bottom:8px"></div> <pre id="backup-raw-json" style="white-space:pre-wrap;word-break:break-word;max-height:200px;overflow:auto;border-top:1px solid rgba(0,0,0,0.04);padding-top:8px">${escapeHtml(JSON.stringify(val.data || val,null,2))}</pre>`;const renderBtn=document.getElementById('render-backup-cards-btn');const cardsContainer=document.getElementById('backup-cards-container');if (renderBtn){renderBtn.addEventListener('click',function (){try{const payload=val.data || val;renderBackupDataCards(payload,cardsContainer);}catch (err){showToast('Falha ao renderizar preview: ' + (err && err.message ? err.message : err),'bg-red-600');}});}downloadPreviewBtn.onclick=()=>{try{const blob=new Blob([JSON.stringify(val.data || val,null,2)],{type: 'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`${(val.name||'backup')}.json`;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);showToast('Download iniciado','bg-gray-700');}catch (e){showToast('Falha ao baixar: ' + e.message,'bg-red-600');}};restoreSelectedBtn.onclick=async ()=>{try{try{const ok=await confirmAsync('Deseja restaurar este backup? Isso substituirï¿½ os dados atuais.','Restaurar backup');if (!ok) return;}catch(e){return;}showLoading();const payload=val.data || val;state.appData=JSON.parse(JSON.stringify(payload));await storage.saveData(state.appData);hideLoading();showToast('RestauraÃ§Ã£o concluÃ­da. Recarregando...','bg-green-600');location.reload();}catch (err){hideLoading();showToast('Falha ao restaurar: ' + (err && err.message ? err.message : err),'bg-red-600');}};}function renderBackupDataCards(payload,container){if (!container) return;container.innerHTML='';const normalized=normalizeBackupPayload(payload);if (!normalized || !normalized.data){container.innerHTML='<div class="text-sm text-gray-500">Formato inesperado: Conteï¿½do nï¿½o conTï¿½ï¿½m propriedade "data" apï¿½ï¿½s normalizaï¿½ï¿½o.</div>';return;}const years=Object.keys(normalized.data).sort((a,b)=> b - a);const diffEl=document.createElement('div');diffEl.className='mb-3';diffEl.innerHTML=renderBackupVsCurrentSummary(normalized.data,state.appData && state.appData.data ? state.appData.data :{});container.appendChild(diffEl);years.forEach(year=>{const yearEl=document.createElement('div');yearEl.className='mb-3';const months=Object.keys(payload.data[year] ||{}).sort((a,b)=> b - a);months.forEach(month=>{const m=normalized.data[year][month] ||{incomes: [],expenses: [],savings: []};const incomes=Array.isArray(m.incomes) ? m.incomes : [];const expenses=Array.isArray(m.expenses) ? m.expenses : [];const savings=Array.isArray(m.savings) ? m.savings : [];const sum=arr=> (arr || []).reduce((s,it)=> s + (Number(it.amount) || 0),0);const card=document.createElement('div');card.className='p-3 rounded-lg border bg-white mb-2';card.innerHTML=` <div class="flex items-center justify-between mb-2"> <div class="text-sm font-semibold">${escapeHtml(year)}/ ${escapeHtml(month)}</div> <div class="text-xs text-gray-500">Lanï¿½amentos: ${incomes.length + expenses.length + savings.length}</div> </div> <div class="grid grid-cols-3 gap-2 text-sm mb-2"> <div class="p-2 rounded bg-green-50">Entradas<br><strong>${formatCurrency(sum(incomes))}</strong></div> <div class="p-2 rounded bg-red-50">Despesas<br><strong>${formatCurrency(sum(expenses))}</strong></div> <div class="p-2 rounded bg-yellow-50">Reservas<br><strong>${formatCurrency(sum(savings))}</strong></div> </div> <div class="text-xs text-gray-600"> <div><strong>Amostras:</strong></div> <div class="mt-1"> ${renderSampleList(incomes,'Entrada')}${renderSampleList(expenses,'Despesa')}${renderSampleList(savings,'Reserva')}</div> </div> `;yearEl.appendChild(card);});container.appendChild(yearEl);});}function normalizeBackupPayload(p){if (!p) return null;if (p.financeAppDB_v10 && p.financeAppDB_v10.data) return{data: p.financeAppDB_v10.data};if (p.data && typeof p.data==='object') return{data: p.data};const maybeYears=Object.keys(p).filter(k=> /^\d{4}$/.test(k));if (maybeYears.length > 0) return{data: p};if (p.data && p.data.data) return{data: p.data.data};for (const k in p){if (p[k] && typeof p[k]==='object'){const subKeys=Object.keys(p[k]);if (subKeys.some(sk=> /^\d{2}$/.test(sk) || /^\d{1,2}$/.test(sk))){return{data: p};}}}return null;}function renderBackupVsCurrentSummary(backupData,currentData){const years=Array.from(new Set([].concat(Object.keys(backupData||{}),Object.keys(currentData||{})))).sort((a,b)=> b - a);if (years.length===0) return '<div class="text-sm text-gray-500">Sem dados para comparar.</div>';let html='<div class="text-sm font-medium mb-2">Resumo (Backup vs Atual)</div>';html +='<div class="space-y-2">';years.forEach(y=>{const months=Array.from(new Set([].concat(Object.keys((backupData[y]||{})),Object.keys((currentData[y]||{}))))).sort((a,b)=> b - a);months.forEach(m=>{const bM=(backupData[y] && backupData[y][m]) ||{incomes:[],expenses:[],savings:[]};const cM=(currentData[y] && currentData[y][m]) ||{incomes:[],expenses:[],savings:[]};const sum=arr=> (Array.isArray(arr) ? arr.reduce((s,it)=> s + (Number(it.amount)||0),0) : 0);const bIn=sum(bM.incomes),bEx=sum(bM.expenses),bSa=sum(bM.savings);const cIn=sum(cM.incomes),cEx=sum(cM.expenses),cSa=sum(cM.savings);html +=`<div class="flex items-center justify-between p-2 rounded bg-gray-50 border"> <div class="text-xs">${escapeHtml(y)}/ ${escapeHtml(m)}</div> <div class="text-xs grid grid-cols-3 gap-2 text-right" style="min-width:320px"> <div class="text-xs">In: ${formatCurrency(bIn)}â†’ ${formatCurrency(cIn)}</div> <div class="text-xs">Ex: ${formatCurrency(bEx)}â†’ ${formatCurrency(cEx)}</div> <div class="text-xs">Sa: ${formatCurrency(bSa)}â†’ ${formatCurrency(cSa)}</div> </div> </div>`;});});html +='</div>';return html;}function renderSampleList(arr,label){if (!Array.isArray(arr) || arr.length===0) return '';const items=arr.slice(0,3).map(it=> `<div class="truncate">${escapeHtml(label + ': ' + (it.description || it.desc || it.label || 'â€”') + ' â€” ' + (formatCurrency(Number(it.amount)||0)))}</div>`).join('');return `<div class="mt-1 text-xs">${items}</div>`;}function formatCurrency(v){try{return new Intl.NumberFormat('pt-BR',{style: 'currency',currency: 'BRL',minimumFractionDigits: 2,maximumFractionDigits: 2}).format(Number(v)||0);}catch(e){return String(v);}}function escapeHtml(s){return String(s||'').replace(/[&<>\"]/g,c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}async function openBackupModal(){if (!backupModal) return;try{backupModal.showModal();}catch(e){backupModal.setAttribute('open','');}backupModal.classList.add('modal-expanded');try{const list=await listBackups();renderBackupsList(list);}catch(e){renderBackupsList([]);}}async function deleteBackup(backupId,backupName){if (!backupId){showToast('Nenhum backup selecionado para exclusï¿½o','bg-yellow-600');return;}try{const confirmed=confirm(`Tem certeza que deseja excluir permanentemente o backup "${backupName || 'sem nome'}"?\n\nEsta aï¿½ï¿½o nï¿½o pode ser desfeita.`);if (!confirmed) return;showLoading();await database.ref('/backups/' + backupId).remove();hideLoading();showToast('Backup excluï¿½ï¿½do com sucesso!','bg-green-600');if (backupPreviewEl){backupPreviewEl.innerHTML='<div class="text-sm text-gray-500">Selecione um backup para visualizar.</div>';}currentBackupId=null;const list=await listBackups();renderBackupsList(list);}catch (err){hideLoading();showToast('Falha ao excluir backup: ' + (err && err.message ? err.message : String(err)),'bg-red-600');}}if (createBackupBtn) createBackupBtn.addEventListener('click',async ()=>{try{await createBackup();}catch(e){}});if (restoreBackupBtn) restoreBackupBtn.addEventListener('click',()=> openBackupModal());if (refreshBackupsBtn) refreshBackupsBtn.addEventListener('click',async ()=>{try{const list=await listBackups();renderBackupsList(list);}catch(e){}});if (closeBackupModalBtn) closeBackupModalBtn.addEventListener('click',()=>{try{backupModal.close();}catch(e){backupModal.removeAttribute('open');}});if (deleteBackupBtn){deleteBackupBtn.addEventListener('click',async ()=>{if (!currentBackupId){showToast('Nenhum backup selecionado','bg-yellow-600');return;}try{const snap=await database.ref('/backups/' + currentBackupId).get();const val=snap.val();const backupName=val && val.name ? val.name : 'sem nome';await deleteBackup(currentBackupId,backupName);}catch(e){showToast('Falha ao excluir: ' + (e && e.message ? e.message : String(e)),'bg-red-600');}});}}catch(e){console.error('attach backup handlers',e);}if (ui.expensesTableHead){ui.expensesTableHead.addEventListener('click',(e)=>{const header=e.target.closest('.sortable-header');if(header){if (state.sort.key===header.dataset.sort){state.sort.order=state.sort.order==='asc' ? 'desc' : 'asc';}else{state.sort.key=header.dataset.sort;state.sort.order='asc';}renderExpenseTable();}});}else{}document.querySelectorAll('.tab-button').forEach(button=> button.addEventListener('click',(e)=> changeView(e.currentTarget.dataset.view)));if (ui.mobileBottomNav){const buttons=ui.mobileBottomNav.querySelectorAll('.mobile-nav-btn');function updateMobileNavVisibility(){if (window.innerWidth <=639){ui.mobileBottomNav.classList.add('active');}else{ui.mobileBottomNav.classList.remove('active');}}updateMobileNavVisibility();window.addEventListener('resize',updateMobileNavVisibility);buttons.forEach(btn=> btn.addEventListener('click',(e)=> changeView(e.currentTarget.dataset.view)));}ui.isInstallment.addEventListener('change',()=>{try{ui.installmentsFields.classList.toggle('active',ui.isInstallment.checked);}catch (e){console.error('isInstallment change handler',e);}});try{const financingCheckbox=document.getElementById('is-financing');if (financingCheckbox){financingCheckbox.addEventListener('change',()=>{try{const ff=document.getElementById('financing-fields');if (ff) ff.classList.toggle('active',financingCheckbox.checked);}catch (e){console.error('financing change handler',e);}});}}catch (e){console.error('bindEvents attach financing handler',e);}try{if (ui['toggleExpenseGrouped']){ui['toggleExpenseGrouped'].style.display='none';}if (ui.groupExpensesBtn){ui.groupExpensesBtn.style.display='none';}const wrapped=document.getElementById('expenses-grouped-container');if (wrapped) wrapped.classList.add('hidden');state.showGroupedExpenses=false;}catch(e){/* silent */}try{if (ui.creditCardsContainer){ui.creditCardsContainer.addEventListener('click',(ev)=>{const toggle=ev.target.closest && ev.target.closest('.card-group-toggle');if (!toggle) return;ev.preventDefault();const name=toggle.dataset.cardName;const newState=!state.cardGrouped[name];state.cardGrouped[name]=newState;const container=document.getElementById('credit-cards-container');if (!container) return;const cardRoot=container.querySelector(`[data-card-root="${name}"]`);if (!cardRoot) return;try{const iconEl=cardRoot.querySelector('.card-group-toggle .material-symbols-outlined');if (iconEl) iconEl.textContent=newState ? 'vertical_split' : 'merge_type';}catch(e){}try{const exps=(getCurrentMonthData().expenses || []).filter(e=> paymentMatches(e.payment || '',name));populateCardExpenses(name,exps);}catch(e){}});}}catch(e){console.error('attach delegated card-group-toggle',e);}if (ui.paymentMethod) ui.paymentMethod.addEventListener('change',(e)=>{toggleInstallmentSection(e.target.value);try{const raw=(e.target.value || '').toString();const normalize=s=> (s || '').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');const nv=normalize(raw);const recipientWrapper=document.getElementById('payment-recipient-wrapper');const recipientInput=document.getElementById('payment-recipient');const recipientHint=document.getElementById('payment-recipient-hint');if (recipientWrapper && recipientInput){const mustShow=(nv==='pix' || nv.indexOf('transfer') !==-1 || nv==='transferencia');if (mustShow){recipientWrapper.classList.remove('hidden');recipientWrapper.setAttribute('aria-hidden','false');recipientInput.setAttribute('required','required');try{recipientInput.focus();}catch(_){}if (recipientHint){recipientHint.classList.remove('hidden');recipientHint.setAttribute('aria-hidden','false');}}else{recipientWrapper.classList.add('hidden');recipientWrapper.setAttribute('aria-hidden','true');recipientInput.removeAttribute('required');if (recipientHint){recipientHint.classList.add('hidden');recipientHint.setAttribute('aria-hidden','true');}}}}catch (recErr){console.error('recipient toggle error',recErr);}try{const pm=(e.target.value || '').toString();const settings=state.appData.settings ||{};const expenseCategories=settings.expenseCategories || [];const normalize=s=> (s || '').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');const descEl=document.getElementById('description');const descHint=document.getElementById('description-hint');const catHint=document.getElementById('category-hint');if (descHint){descHint.textContent='';descHint.classList.add('hidden');descHint.setAttribute('aria-hidden','true');}if (catHint){catHint.textContent='';catHint.classList.add('hidden');catHint.setAttribute('aria-hidden','true');}if (pm==='VR'){const foundAlim=expenseCategories.find(c=> normalize(c).includes('aliment'));if (foundAlim && ui.categoryExpense){ui.categoryExpense.value=foundAlim;try{ui.categoryExpense.disabled=true;}catch(e){}}if (ui.expenseType) ui.expenseType.value='Essenciais';try{if (descEl) descEl.disabled=false;}catch(e){}if (catHint){catHint.textContent='Categoria padronizada para VR (Alimentaï¿½ï¿½o). vocï¿½ pode alterar apï¿½ï¿½s salvar no gerenciamento de VR.';catHint.classList.remove('hidden');catHint.setAttribute('aria-hidden','false');}showToast('Pagamento via VR: categoria e tipo ajustados para Alimentaï¿½ï¿½o / Essencial.','bg-yellow-600');}else if (pm==='VT'){const foundTransp=expenseCategories.find(c=> normalize(c).includes('transport')) || expenseCategories.find(c=> normalize(c).includes('transp')) || expenseCategories.find(c=> normalize(c).includes('transporte'));if (foundTransp && ui.categoryExpense){ui.categoryExpense.value=foundTransp;try{ui.categoryExpense.disabled=true;}catch(e){}}if (ui.expenseType) ui.expenseType.value='Essenciais';try{if (descEl){descEl.value='Abastecimento';descEl.disabled=true;}}catch(e){}if (descHint){descHint.textContent='Descriï¿½ï¿½o obrigaTï¿½ï¿½ria para VT: "Abastecimento". Caso precise outra Descriï¿½ï¿½o,registre como dï¿½ï¿½bito comum.';descHint.classList.remove('hidden');descHint.setAttribute('aria-hidden','false');}if (catHint){catHint.textContent='Categoria padronizada para VT (Transporte). Para outras categorias,use mï¿½todo de pagamento diferente.';catHint.classList.remove('hidden');catHint.setAttribute('aria-hidden','false');}showToast('Pagamento via VT: categoria definida para Transporte e Descriï¿½ï¿½o definida para "Abastecimento".','bg-yellow-600');}else{try{if (ui.categoryExpense) ui.categoryExpense.disabled=false;}catch(e){}try{if (descEl) descEl.disabled=false;}catch(e){}if (descHint){descHint.textContent='';descHint.classList.add('hidden');descHint.setAttribute('aria-hidden','true');}if (catHint){catHint.textContent='';catHint.classList.add('hidden');catHint.setAttribute('aria-hidden','true');}}}catch (err){console.error('paymentMethod change enforcement error',err);}});if (ui.monthlyReportBtn) ui.monthlyReportBtn.addEventListener('click',()=> openMonthlyReport());if (ui.desktopDashboardBtn) ui.desktopDashboardBtn.addEventListener('click',()=> changeView('dashboard'));if (ui.desktopCreditcardsBtn) ui.desktopCreditcardsBtn.addEventListener('click',()=> changeView('credit-cards'));try{const kpiVr=document.getElementById('kpi-vr-card');if (kpiVr){kpiVr.style.cursor='pointer';kpiVr.addEventListener('click',()=>{changeView('credit-cards');});}}catch (e){console.error('attach kpi-vr click handler',e);}try{const kpiVt=document.getElementById('kpi-vt-card');if (kpiVt){kpiVt.style.cursor='pointer';kpiVt.addEventListener('click',()=>{changeView('credit-cards');});}}catch (e){console.error('attach kpi-vt click handler',e);}const infrequent=document.getElementById('infrequent-controls');if (infrequent && ui.monthlyReportBtn){ui.monthlyReportBtn.addEventListener('mouseenter',()=>{infrequent.classList.add('visible');});ui.monthlyReportBtn.addEventListener('mouseleave',()=>{infrequent.classList.remove('visible');});infrequent.addEventListener('mouseenter',()=>{infrequent.classList.add('visible');});infrequent.addEventListener('mouseleave',()=>{infrequent.classList.remove('visible');});}const mobileToggle=document.getElementById('mobile-infrequent-toggle');if (mobileToggle && infrequent){mobileToggle.style.display=window.innerWidth <=639 ? 'inline-flex' : 'none';mobileToggle.addEventListener('click',()=>{const isVisible=infrequent.classList.toggle('mobile-visible');if (isVisible) infrequent.classList.remove('visible');});window.addEventListener('resize',()=>{mobileToggle.style.display=window.innerWidth <=639 ? 'inline-flex' : 'none';if (window.innerWidth > 639) infrequent.classList.remove('mobile-visible');});}window.addEventListener('resize',()=>{if (ui && ui.charts){Object.values(ui.charts).forEach(c=>{try{if (c && typeof c.resize==='function') c.resize();}catch(e){}});}});if (ui.annualReportBtn) ui.annualReportBtn.addEventListener('click',()=> openAnnualReport());if (ui.closeMonthlyReportBtn) ui.closeMonthlyReportBtn.addEventListener('click',()=> closeModal('monthly-report-modal'));if (ui.closeAnnualReportBtn) ui.closeAnnualReportBtn.addEventListener('click',()=> closeModal('annual-report-modal'));if (ui.addGoalBtn) ui.addGoalBtn.addEventListener('click',()=> openGoalModal());if (ui.closeGoalModalBtn) ui.closeGoalModalBtn.addEventListener('click',()=> closeModal('goal-modal'));if (ui.goalForm) ui.goalForm.addEventListener('submit',(e)=> handleGoalFormSubmit(e));if (ui.searchDescription) ui.searchDescription.addEventListener('input',(e)=>{state.filters.searchTerm=e.target.value;renderExpenseTable();});if (ui.expensesFilterBtn && ui.expensesFilterPopover){ui.expensesFilterBtn.addEventListener('click',(e)=>{e.stopPropagation();const payments=state.appData.settings.paymentMethods || [];const paymentsSorted=sortStrings((payments || []).map(p=> p.name || ''));ui.filterPaymentMethod.innerHTML='<option value="">Todos os mï¿½todos</option>' + paymentsSorted.map(n=> `<option value="${n}">${n}</option>`).join('');const cats=state.appData.settings.expenseCategories || [];const catsSorted=sortStrings(cats);ui.filterCategory.innerHTML='<option value="">Todas as categorias</option>' + catsSorted.map(c=> `<option value="${c}">${c}</option>`).join('');try{const ef=state.filters.expenseFilters ||{};ui.filterPaymentMethod.value=ef.payment || '';ui.filterSpendingType.value=ef.spendingType || '';ui.filterCategory.value=ef.category || '';ui.filterType.value=ef.type || '';ui.filterRecurring.checked=!!ef.recurring;ui.filterInstallment.checked=!!ef.installment;}catch(e){}const backdrop=document.getElementById('filter-backdrop');if (backdrop) backdrop.classList.remove('hidden');ui.expensesFilterPopover.classList.remove('hidden');});const closeFilterModal=()=>{const backdrop=document.getElementById('filter-backdrop');if (backdrop) backdrop.classList.add('hidden');ui.expensesFilterPopover.classList.add('hidden');};const closeBtn=document.getElementById('filter-close-btn');if (closeBtn){closeBtn.addEventListener('click',closeFilterModal);}else{}const backdrop=document.getElementById('filter-backdrop');if (backdrop){backdrop.addEventListener('click',closeFilterModal);}else{}}else{}function updateFilterBadge(){try{const badge=document.getElementById('expenses-filter-badge');if (!badge) return;const ef=state.filters.expenseFilters ||{};let count=0;if (ef.payment) count++;if (ef.spendingType) count++;if (ef.category) count++;if (ef.type) count++;if (ef.recurring) count++;if (ef.installment) count++;badge.textContent=String(count);badge.style.display=count > 0 ? 'inline-flex' : 'none';}catch(e){}}try{updateFilterBadge();}catch(e){}if (ui.filterApplyBtn){ui.filterApplyBtn.addEventListener('click',()=>{state.filters.expenseFilters=state.filters.expenseFilters ||{};state.filters.expenseFilters.payment=ui.filterPaymentMethod.value || '';state.filters.expenseFilters.spendingType=ui.filterSpendingType.value || '';state.filters.expenseFilters.category=ui.filterCategory.value || '';state.filters.expenseFilters.type=ui.filterType.value || '';state.filters.expenseFilters.recurring=ui.filterRecurring.checked;state.filters.expenseFilters.installment=ui.filterInstallment.checked;const backdrop=document.getElementById('filter-backdrop');if (backdrop) backdrop.classList.add('hidden');if (ui.expensesFilterPopover) ui.expensesFilterPopover.classList.add('hidden');renderExpenseTable();updateFilterBadge();});}if (ui.filterClearBtn){ui.filterClearBtn.addEventListener('click',()=>{ui.filterPaymentMethod.value='';ui.filterCategory.value='';ui.filterType.value='';ui.filterSpendingType.value='';ui.filterRecurring.checked=false;ui.filterInstallment.checked=false;state.filters.expenseFilters={};const backdrop=document.getElementById('filter-backdrop');if (backdrop) backdrop.classList.add('hidden');if (ui.expensesFilterPopover) ui.expensesFilterPopover.classList.add('hidden');renderExpenseTable();updateFilterBadge();});}if (ui.previewFutureBtn){ui.previewFutureBtn.addEventListener('click',()=>{try{const id=document.getElementById('transaction-id').value;if (!id) return showToast('Abra uma transaÃ§Ã£o existente para ver previsÃ•ES.','bg-gray-600');const type=ui.transactionTypeInput.value;previewFutureChanges(id,type);}catch(e){console.error('previewFutureBtn click',e);}});}if (ui.categorySaving){ui.categorySaving.addEventListener('change',function(){const selected=this.value;const goals=(state.appData.settings.goals || []).map(g=> g.name);let metaName=null;if (goals.includes(selected)){metaName=selected;}else if (selected.endsWith(' (Meta)')){metaName=selected.replace(' (Meta)','');}if (metaName){document.getElementById('description').value=metaName;}});}}function handleExport(){if (!state.appData){alert("nï¿½o hï¿½ï¿½ dados para exportar.");return;}const appDataCopy=JSON.parse(JSON.stringify(state.appData));const transformedData={};for (const year in appDataCopy.data){if (Object.prototype.hasOwnProperty.call(appDataCopy.data,year)){for (const month in appDataCopy.data[year]){if (Object.prototype.hasOwnProperty.call(appDataCopy.data[year],month)){const newKey=`${year}-${month}`;transformedData[newKey]=appDataCopy.data[year][month];}}}}appDataCopy.data=transformedData;const exportObject={financeAppDB_v10: appDataCopy};const dataStr="data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObject,null,2));const downloadAnchorNode=document.createElement('a');downloadAnchorNode.setAttribute("href",dataStr);downloadAnchorNode.setAttribute("download","import.json");document.body.appendChild(downloadAnchorNode);downloadAnchorNode.click();downloadAnchorNode.remove();showToast("Dados exportados com sucesso!",'bg-green-600');}function handleImport(){const fileInput=ui.importFileInput;const file=fileInput.files[0];if (!file){return;}const reader=new FileReader();reader.onload=async (event)=>{try{const json=JSON.parse(event.target.result);const dataToSave=json.financeAppDB_v10;if (!dataToSave || !dataToSave.data){throw new Error('Estrutura do JSON invï¿½ï¿½lida. Chave "financeAppDB_v10" ou "data" nï¿½o encontrada.');}const transformedData={};for (const key in dataToSave.data){if (Object.prototype.hasOwnProperty.call(dataToSave.data,key) && key.match(/^\d{4}-\d{2}$/)){const [year,month]=key.split('-');if (!transformedData[year]){transformedData[year]={};}transformedData[year][month]=dataToSave.data[key];}}dataToSave.data=transformedData;await storage.saveData(dataToSave);alert('Dados importados com sucesso!');location.reload();}catch (e){alert('Erro ao importar dados: ' + e.message);}finally{fileInput.value='';}};reader.readAsText(file);}function render(){if (!state.appData){return;}propagateRecurringTransactions();renderMonthDisplay();switch (state.currentView){case 'dashboard': renderDashboard();break;case 'credit-cards': renderCreditCardView();break;}}function changeView(view){state.currentView=view;try{localStorage.setItem('lastActiveView',view);}catch(e){console.error('Error saving lastActiveView',e);}['dashboard','credit-cards'].forEach(v=>{const el=document.getElementById(`${v}-view`);if (el) el.classList.toggle('hidden',view !==v);const tabBtn=document.querySelector(`.tab-button[data-view="${v}"]`);if (tabBtn) tabBtn.classList.toggle('tab-active',view===v);});const activeView=document.getElementById(`${view}-view`);activeView void activeView.offsetWidth;activeView render();}function renderDashboard(){updateKPIs();renderAllTables();renderCharts();}function renderCreditCardView(){const container=ui.creditCardsContainer;container.innerHTML='';const currentMonthData=getCurrentMonthData();const normalize=s=> (s || '').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');const creditCards=((state.appData.settings.paymentMethods || []).filter(p=> p.type==='credit_card')).slice().sort((a,b)=>{const A=(a && a.name || '').toLowerCase();const B=(b && b.name || '').toLowerCase();return A < B ? -1 : A > B ? 1 : 0;});creditCards.forEach(c=>{if (state.cardGrouped[c.name]===undefined) state.cardGrouped[c.name]=false;});creditCards.forEach(card=>{let cardExpenses=(currentMonthData.expenses || []).filter(e=> normalize((typeof getPaymentLabel==='function' ? getPaymentLabel(e.payment || '') : (e.payment || '')))===normalize(card.name || ''));ui.cardSorts=ui.cardSorts ||{};if (ui.cardSorts[card.name]===undefined) ui.cardSorts[card.name]='value-desc';const sortMode=ui.cardSorts[card.name];if (!state.cardGrouped[card.name]){if (sortMode==='alf'){cardExpenses=cardExpenses.slice().sort((a,b)=>{const A=(a.description||'').toLowerCase();const B=(b.description||'').toLowerCase();return A < B ? -1 : A > B ? 1 : 0;});}else if (sortMode==='value-desc'){cardExpenses=cardExpenses.slice().sort((a,b)=> (Number(b.amount)||0) - (Number(a.amount)||0));}else if (sortMode==='value-asc'){cardExpenses=cardExpenses.slice().sort((a,b)=> (Number(a.amount)||0) - (Number(b.amount)||0));}}const totalBeforeAnticipation=cardExpenses.reduce((sum,exp)=> sum + (Number(exp.amount) || 0),0);const y=String(state.currentDate.getFullYear());const m=String(String(state.currentDate.getMonth()+1).padStart(2,'0'));if (!state.appData.data[y]) state.appData.data[y]={};if (!state.appData.data[y][m]) state.appData.data[y][m]={incomes: [],expenses: [],savings: []};const cardAnticipations=state.appData.data[y][m].cardAnticipations ||{};const anticipated=Number(cardAnticipations[card.name] || 0);const invoiceTotal=Math.round(((totalBeforeAnticipation - anticipated) + Number.EPSILON) * 100) / 100;const closeDate=new Date(state.currentDate);const dueDate=new Date(state.currentDate);const closeDay=card.closeDay || 1;const cardDueDay=card.dueDay || 1;closeDate.setDate(closeDay);if (cardDueDay < 15) dueDate.setMonth(dueDate.getMonth() + 1);dueDate.setDate(cardDueDay);container.innerHTML +=` <div class="card p-6 rounded-2xl shadow-sm flex flex-col" data-card-root="${card.name}"> <div class="flex-grow"> <div class="flex justify-between items-start mb-2"> <div class="flex items-center gap-3"> <h3 class="text-xl font-semibold card-title-sortable cursor-pointer" data-card-name="${card.name}">${card.name}</h3> <div class="flex items-center text-sm text-gray-500" style="gap:6px;"> <button class="card-sort-arrow" data-card-name="${card.name}" data-sort="value-desc" title="Ordenar por valor desc"><span class="material-symbols-outlined" style="font-size:16px">arrow_upward</span></button> <button class="card-sort-arrow" data-card-name="${card.name}" data-sort="value-asc" title="Ordenar por valor asc"><span class="material-symbols-outlined" style="font-size:16px">arrow_downward</span></button> <button class="card-group-toggle p-1 ml-1" data-card-name="${card.name}" title="Agrupar/Desagrupar"><span class="material-symbols-outlined">${state.cardGrouped[card.name] ? 'vertical_split' : 'merge_type'}</span></button> </div> </div> <div class="flex items-center gap-2"> <span class="text-xs font-medium bg-orange-100 text-orange-800 px-2 py-1 rounded-full">Fecha ${closeDate.toLocaleDateString('pt-BR',{day: '2-digit',month: '2-digit'})}</span> <span class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Venc. ${dueDate.toLocaleDateString('pt-BR',{day: '2-digit',month: '2-digit'})}</span> </div> </div> <p class="text-3xl font-bold text-blue-600 mb-1">${formatCurrency(invoiceTotal)}</p> <!-- small icon row under badges: due,anticipated,purchases --> <div class="flex items-center gap-4 text-sm text-gray-500 mt-1 mb-2"> <div class="flex items-center gap-1"><span class="material-symbols-outlined" style="font-size:16px">event_busy</span><span>Fech. dia ${closeDay}</span></div> <div class="flex items-center gap-1"><span class="material-symbols-outlined" style="font-size:16px">calendar_today</span><span>Venc. dia ${cardDueDay}</span></div> <div class="flex items-center gap-1"><span class="material-symbols-outlined" style="font-size:16px">shopping_cart</span><span>${cardExpenses.length}compras</span></div> </div> <p class="text-sm text-green-600 mb-1">- <span class="anticipation-amount cursor-pointer" data-card-name="${card.name}">${formatCurrency(anticipated)}</span> antecipado</p> <div class="space-y-1 max-h-48 overflow-y-auto pr-2 card-items-list" data-card-name="${card.name}"></div> </div> <div class="mt-6"> <div class="flex w-full items-center" style="gap:8px;"> ${(()=>{const allPaid=cardExpenses.length > 0 && cardExpenses.every(e=> e.isPaid);const btnText=allPaid ? 'Reaver Fatura' : 'Pagar Fatura';const btnClass=allPaid ? 'bg-gray-200 text-gray-800 ' : 'bg-green-500 text-white ';return `<button data-card-name="${card.name}" class="pay-invoice-btn flex-grow ${btnClass}font-semibold py-2 px-4 rounded-lg ">${btnText}</button>`;})()}<button data-card-name="${card.name}" title="Adicionar despesa neste carTï¿½o" class="add-card-expense-btn flex-shrink-0 w-12 bg-blue-500 text-white font-semibold py-2 rounded-lg flex items-center justify-center"> <span class="material-symbols-outlined" style="font-size:20px;line-height:1;">add</span></button> </div> </div> </div>`;try{populateCardExpenses(card.name,cardExpenses);}catch(e){console.error('populateCardExpenses error',e);}});try{const currentMonthData=getCurrentMonthData();const paymentsSettings=(state.appData.settings.paymentMethods || []);const normalize=s=> (s || '').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');const nonCardPayments=(paymentsSettings || []).filter(p=> ((p && p.type) || '').toString() !=='credit_card');nonCardPayments.forEach(pm=>{const pmName=(typeof getPaymentLabel==='function') ? getPaymentLabel(pm) : ((typeof pm==='string') ? pm : (pm.name || pm.label || pm.value || ''));if (!pmName) return;if (state.cardGrouped[pmName]===undefined) state.cardGrouped[pmName]=false;});nonCardPayments.forEach(pm=>{const pmName=(typeof getPaymentLabel==='function') ? getPaymentLabel(pm) : ((typeof pm==='string') ? pm : (pm.name || pm.label || pm.value || ''));if (!pmName) return;const pmNorm=normalize(pmName);let pmExpenses=(currentMonthData.expenses || []).filter(e=> normalize((typeof getPaymentLabel==='function' ? getPaymentLabel(e.payment || '') : (e.payment || '')))===pmNorm);if (!pmExpenses || pmExpenses.length===0) return;ui.cardSorts=ui.cardSorts ||{};if (ui.cardSorts[pmName]===undefined) ui.cardSorts[pmName]='value-desc';const sortMode=ui.cardSorts[pmName];if (!state.cardGrouped[pmName]){if (sortMode==='alf'){pmExpenses=pmExpenses.slice().sort((a,b)=>{const A=(a.description||'').toLowerCase();const B=(b.description||'').toLowerCase();return A < B ? -1 : A > B ? 1 : 0;});}else if (sortMode==='value-desc'){pmExpenses=pmExpenses.slice().sort((a,b)=> (Number(b.amount)||0) - (Number(a.amount)||0));}else if (sortMode==='value-asc'){pmExpenses=pmExpenses.slice().sort((a,b)=> (Number(a.amount)||0) - (Number(b.amount)||0));}}const totalPM=pmExpenses.reduce((s,e)=> s + (Number(e && e.amount) || 0),0);container.innerHTML +=` <div class="card p-6 rounded-2xl shadow-sm flex flex-col" data-card-root="${pmName}" data-payment-method="${pmName}"> <div class="flex-grow"> <div class="flex justify-between items-start mb-2"> <div class="flex items-center gap-3"> <h3 class="text-xl font-semibold card-title-sortable cursor-pointer" data-card-name="${pmName}">${pmName}</h3> <div class="flex items-center text-sm text-gray-500" style="gap:6px;"> <button class="card-sort-arrow" data-card-name="${pmName}" data-sort="value-desc" title="Ordenar por valor desc"><span class="material-symbols-outlined" style="font-size:16px">arrow_upward</span></button> <button class="card-sort-arrow" data-card-name="${pmName}" data-sort="value-asc" title="Ordenar por valor asc"><span class="material-symbols-outlined" style="font-size:16px">arrow_downward</span></button> <button class="card-group-toggle p-1 ml-1" data-card-name="${pmName}" title="Agrupar/Desagrupar"><span class="material-symbols-outlined">${state.cardGrouped[pmName] ? 'vertical_split' : 'merge_type'}</span></button> </div> </div> <span class="text-xs font-medium bg-gray-100 text-gray-800 px-2 py-1 rounded-full">${pmExpenses.length}compras</span> </div> <p class="text-3xl font-bold text-gray-800 mb-1">${formatCurrency(totalPM)}</p> <div class="space-y-1 max-h-48 overflow-y-auto pr-2 card-items-list" data-card-name="${pmName}"></div> </div> <div class="mt-4"> <div class="flex w-full items-center" style="gap:8px;"> <button data-payment="${pmName}" class="view-payment-expenses-btn flex-grow bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg">Ver Despesas</button> <button data-payment="${pmName}" class="add-payment-expense-btn flex-shrink-0 w-12 bg-green-500 text-white font-semibold py-2 rounded-lg flex items-center justify-center"> <span class="material-symbols-outlined" style="font-size:20px;line-height:1;">add</span></button> </div> </div> </div>`;try{populateCardExpenses(pmName,pmExpenses);}catch(e){console.error('populateCardExpenses error for payment method',e);}});container.querySelectorAll('.view-payment-expenses-btn').forEach(btn=> btn.addEventListener('click',(e)=>{const p=e.currentTarget.dataset.payment || e.target.dataset.payment;state.filters.expenseFilters=state.filters.expenseFilters ||{};state.filters.expenseFilters.payment=p || '';changeView('dashboard');try{updateFilterBadge();}catch(e){}try{renderExpenseTable();}catch(e){}}));container.querySelectorAll('.add-payment-expense-btn').forEach(btn=> btn.addEventListener('click',(e)=>{const p=e.currentTarget.dataset.payment || e.target.dataset.payment;const prefill={payment: p,focusDescription: true};try{if (ui.lastTransactionDefaults && ui.lastTransactionDefaults.category) prefill.category=ui.lastTransactionDefaults.category;}catch(e){}openModal('expenses',null,prefill);}));}catch (pmErr){console.error('render non-credit payment-method cards error',pmErr);}const vrAmount=getMonthVRBalance(currentMonthData);const hasLedger=Array.isArray(currentMonthData.vrLedger) && currentMonthData.vrLedger.length > 0;const hasUsage=Array.isArray(currentMonthData.vrUsage) && currentMonthData.vrUsage.length > 0;if (vrAmount > 0 || hasLedger || hasUsage){const creditedTotal=(currentMonthData.vrLedger || []).reduce((s,l)=> s + (Number(l && l.amount) || 0),0);let usageTotal=(currentMonthData.vrUsage || []).reduce((s,u)=> s + (Number(u && u.amount) || 0),0);try{const expensesVR=(currentMonthData.expenses || []).filter(e=> paymentMatches(e.payment || '','VR'));const expensesVRSum=expensesVR.reduce((s,e)=> s + (Number(e && e.amount) || 0),0);if (expensesVRSum > 0) usageTotal=Math.round((usageTotal + expensesVRSum) * 100) / 100;}catch (e){console.error('compute expenses vr usage',e);}if ((!Array.isArray(currentMonthData.vrUsage) || currentMonthData.vrUsage.length===0) && (!Array.isArray(currentMonthData.expenses) || !(currentMonthData.expenses || []).some(ex=> (ex.payment || '')==='VR')) && usageTotal > 0){usageTotal=0;}try{/* VR debug disabled in cleanup pass */}catch(e){}const displayAmount=Math.max(0,Math.round((creditedTotal - usageTotal) * 100) / 100);let vrLimit=vrAmount;try{const latestLedger=(currentMonthData.vrLedger || []).slice().reverse().find(l=> l && l.salaryMeta);if (latestLedger && latestLedger.salaryMeta && latestLedger.salaryMeta.valorDesjejumDia){const desjejumDia=Number(latestLedger.salaryMeta.valorDesjejumDia) || 0;const y=state.currentDate.getFullYear();const m=state.currentDate.getMonth() + 1;const dias=typeof diasUteisNoMes==='function' ? diasUteisNoMes(y,m) : 22;vrLimit=Math.max(vrAmount,desjejumDia * dias);}}catch(e){console.error('derive vr limit',e);}const displayYear=state.currentDate.getFullYear();const prevMonthLastDate=new Date(displayYear,state.currentDate.getMonth(),0);const lastDay=prevMonthLastDate.getDate();const prevMonthNumber=prevMonthLastDate.getMonth() + 1;const lastDayStr=String(lastDay).padStart(2,'0') + '/' + String(prevMonthNumber).padStart(2,'0');container.innerHTML +=` <div class="card p-6 rounded-2xl shadow-sm flex flex-col bg-gradient-to-br from-green-50 to-white border border-green-200"> <div class="flex-grow"> <div class="flex justify-between items-start mb-2"> <h3 class="text-xl font-semibold">VR</h3> <!-- Badge shows: Crï¿½ï¿½d. + ï¿½ltimo dia do Mï¿½s exibido (dd/MM) --> <span class="text-xs font-medium bg-green-100 text-green-800 px-2 py-1 rounded-full">Crï¿½ï¿½d. ${lastDayStr}</span> </div> <div class="vr-value-group" title="Usado: ${formatCurrency(usageTotal)}" style="position:relative;display:inline-block;"> <p class="text-3xl font-bold text-green-600 mb-4" style="margin:0;">${formatCurrency(displayAmount)}</p> <p class="text-sm text-gray-500 vr-used" style="margin:0;opacity:0;">Usado: ${formatCurrency(usageTotal)}</p> </div> <div class="mt-3 text-sm text-gray-600"> <h4 class="font-semibold text-sm text-gray-700 flex items-center gap-2"> <span>Compras</span> <button id="add-vr-usage-btn" type="button" class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-white border border-gray-200 text-gray-700 " title="Adicionar compra VR"> <span class="material-symbols-outlined" style="font-size:18px;">add</span> </button> </h4> ${(currentMonthData.vrUsage && currentMonthData.vrUsage.length > 0) ? (()=>{const usagesSorted=(currentMonthData.vrUsage || []).slice().sort((a,b)=>{const A=(a.description||'').toLowerCase();const B=(b.description||'').toLowerCase();return A < B ? -1 : A > B ? 1 : 0;});return `<div class="space-y-1 mt-2">${usagesSorted.map(u=> `<div class="flex justify-between items-center text-sm"><div class="flex items-center"><span class="truncate pr-2 cursor-pointer edit-vr-usage-trigger" data-vr-usage-edit-id="${u.id}">${u.description || 'Despesa VR'}</span></div><div class="flex items-center"><span class="font-medium mr-2">${formatCurrency(Number(u.amount)||0)}</span><button data-vr-usage-edit-id="${u.id}" class="ml-1 text-gray-600 edit-vr-usage-btn" title="Editar"><span class="material-symbols-outlined">edit</span></button><button data-vr-usage-id="${u.id}" class="ml-3 text-red-600 delete-vr-usage-btn" title="Excluir"><span class="material-symbols-outlined">delete</span></button></div></div>`).join('')}</div>`;})() : '<div class="text-sm text-gray-500 mt-1">Nenhuma compra registrada.</div>'}</div> </div> <!-- Gerenciar VR button removed per UX: VR works as dï¿½ï¿½bito somente --> </div>`;}const vtAmount=getMonthVTBalance(currentMonthData);const hasVtLedger=Array.isArray(currentMonthData.vtLedger) && currentMonthData.vtLedger.length > 0;const hasVtUsage=Array.isArray(currentMonthData.vtUsage) && currentMonthData.vtUsage.length > 0;if (vtAmount > 0 || hasVtLedger || hasVtUsage){const vtCreditedTotal=(currentMonthData.vtLedger || []).reduce((s,l)=> s + (Number(l && l.amount) || 0),0);let vtUsageTotal=(currentMonthData.vtUsage || []).reduce((s,u)=> s + (Number(u && u.amount) || 0),0);try{const expensesVT=(currentMonthData.expenses || []).filter(e=> paymentMatches(e.payment || '','VT'));const expensesVTSum=expensesVT.reduce((s,e)=> s + (Number(e && e.amount) || 0),0);if (expensesVTSum > 0) vtUsageTotal=Math.round((vtUsageTotal + expensesVTSum) * 100) / 100;}catch (e){console.error('compute expenses vt usage',e);}if ((!Array.isArray(currentMonthData.vtUsage) || currentMonthData.vtUsage.length===0) && (!Array.isArray(currentMonthData.expenses) || !(currentMonthData.expenses || []).some(ex=> (ex.payment || '')==='VT')) && vtUsageTotal > 0){vtUsageTotal=0;}const vtDisplayAmount=Math.max(0,Math.round((vtCreditedTotal - vtUsageTotal) * 100) / 100);const latestVtLedger=(currentMonthData.vtLedger || []).slice().reverse().find(l=> l && l.salaryMeta);const vtYear=state.currentDate.getFullYear();const vtMonthIndex=state.currentDate.getMonth();const daysInMonth=new Date(vtYear,vtMonthIndex + 1,0).getDate();let businessCount=0;let vtDay=1;for (;vtDay <=daysInMonth;vtDay++){const d=new Date(vtYear,vtMonthIndex,vtDay);const wd=d.getDay();if (wd !==0 && wd !==6) businessCount++;if (businessCount >=5) break;}const lastDayVT=vtDay;const prevMonthNumberVT=vtMonthIndex + 1;const lastDayStrVT=String(lastDayVT).padStart(2,'0') + '/' + String(prevMonthNumberVT).padStart(2,'0');container.innerHTML +=` <div class="card p-6 rounded-2xl shadow-sm flex flex-col bg-gradient-to-br from-yellow-50 to-white border border-yellow-200"> <div class="flex-grow"> <div class="flex justify-between items-start mb-2"> <h3 class="text-xl font-semibold">VT</h3> <span class="text-xs font-medium bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">Crï¿½ï¿½d. ${lastDayStrVT}</span> </div> <div class="vr-value-group" title="Usado: ${formatCurrency(vtUsageTotal)}" style="position:relative;display:inline-block;"> <p class="text-3xl font-bold text-yellow-600 mb-4" style="margin:0;">${formatCurrency(vtDisplayAmount)}</p> <p class="text-sm text-gray-500 vr-used" style="margin:0;opacity:0;">Usado: ${formatCurrency(vtUsageTotal)}</p> </div> <div class="mt-3 text-sm text-gray-600"> <h4 class="font-semibold text-sm text-gray-700 flex items-center gap-2"> <span>Compras</span> <button id="open-vt-history-btn" type="button" class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-white border border-gray-200 text-gray-700 mr-1" title="Abrir Histï¿½rico VT"> <span class="material-symbols-outlined" style="font-size:18px;">history</span> </button> <button id="add-vt-usage-btn" type="button" class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-white border border-gray-200 text-gray-700 " title="Adicionar compra VT"> <span class="material-symbols-outlined" style="font-size:18px;">add</span> </button> </h4> ${(currentMonthData.vtUsage && currentMonthData.vtUsage.length > 0) ? (()=>{const usagesSorted=(currentMonthData.vtUsage || []).slice().sort((a,b)=>{const A=(a.description||'').toLowerCase();const B=(b.description||'').toLowerCase();return A < B ? -1 : A > B ? 1 : 0;});return `<div class="space-y-1 mt-2">${usagesSorted.map(u=> `<div class="flex justify-between items-center text-sm"><div class="flex items-center"><span class="truncate pr-2 cursor-pointer edit-vt-usage-trigger" data-vt-usage-edit-id="${u.id}">${u.description || 'Despesa VT'}</span></div><div class="flex items-center"><span class="font-medium mr-2">${formatCurrency(Number(u.amount)||0)}</span><button data-vt-usage-edit-id="${u.id}" class="ml-1 text-gray-600 edit-vt-usage-btn" title="Editar"><span class="material-symbols-outlined">edit</span></button><button data-vt-usage-id="${u.id}" class="ml-3 text-red-600 delete-vt-usage-btn" title="Excluir"><span class="material-symbols-outlined">delete</span></button></div></div>`).join('')}</div>`;})() : '<div class="text-sm text-gray-500 mt-1">Nenhuma compra registrada.</div>'}</div> </div> </div>`;}try{const addVrBtn=container.querySelector('#add-vr-usage-btn');if (addVrBtn) addVrBtn.addEventListener('click',(ev)=>{openModal('expenses',null,{payment: 'VR',focusDescription: true});});}catch(e){console.error('attach add-vr-usage handler',e);}container.querySelectorAll('.pay-invoice-btn').forEach(btn=> btn.addEventListener('click',(e)=> payCardInvoice(e.target.dataset.cardName)));container.querySelectorAll('.add-card-expense-btn').forEach(btn=> btn.addEventListener('click',(e)=>{const cardName=e.currentTarget.dataset.cardName || e.target.dataset.cardName;const prefill={payment: cardName,focusDescription: true};try{if (ui.lastTransactionDefaults && ui.lastTransactionDefaults.category) prefill.category=ui.lastTransactionDefaults.category;}catch(e){/* ignore */}showToast(`Criando despesa para ${cardName}...`,'bg-blue-600');openModal('expenses',null,prefill);}));container.querySelectorAll('.edit-anticipation-btn').forEach(btn=> btn.addEventListener('click',(ev)=>{ev.stopPropagation();const cardName=ev.currentTarget.dataset.cardName || ev.target.dataset.cardName;const y=String(state.currentDate.getFullYear());const m=String(String(state.currentDate.getMonth()+1).padStart(2,'0'));if (!state.appData.data[y]) state.appData.data[y]={};if (!state.appData.data[y][m]) state.appData.data[y][m]={incomes: [],expenses: [],savings: []};const md=state.appData.data[y][m];md.cardAnticipations=md.cardAnticipations ||{};const currentVal=Number(md.cardAnticipations[cardName] || 0);const input=prompt(`Valor antecipado para ${cardName}(R$):`,currentVal || '0');if (input===null) return;const v=parseFloat(String(input).replace(',','.')) || 0;if (v <=0) delete md.cardAnticipations[cardName];else md.cardAnticipations[cardName]=Math.round((v + Number.EPSILON) * 100) / 100;try{storage.saveData(state.appData);showToast('Valor antecipado atualizado.','bg-green-600');}catch(e){console.error('save anticipation',e);showToast('Falha ao salvar antecipaï¿½ï¿½o.','bg-red-600');}render();}));try{container.querySelectorAll('.delete-vr-usage-btn').forEach(btn=> btn.addEventListener('click',async (ev)=>{const id=ev.currentTarget.getAttribute('data-vr-usage-id');if (!id) return;try{const ok=await confirmAsync('Excluir este uso de VR?','Confirmar exclusï¿½o');if (!ok) return;}catch(e){return;}const md=getCurrentMonthData();if (!Array.isArray(md.vrUsage)) md.vrUsage=[];const idx=md.vrUsage.findIndex(u=> u.id===id);if (idx > -1) md.vrUsage.splice(idx,1);try{await storage.saveData(state.appData);showToast('Uso de VR excluï¿½ï¿½do.','bg-green-600');}catch(e){console.error('delete vr usage save',e);showToast('Falha ao salvar exclusï¿½o.','bg-red-600');}render();}));try{const addVtBtn=container.querySelector('#add-vt-usage-btn');const openVtHistBtn=container.querySelector('#open-vt-history-btn');if (openVtHistBtn) openVtHistBtn.addEventListener('click',(ev)=>{if (typeof window.openVtFuelHistory==='function'){try{window.openVtFuelHistory();return;}catch(e){console.error('openVtFuelHistory failed',e);}}if (typeof window.openVtFuelModal==='function'){try{window.openVtFuelModal(null);return;}catch(e){console.error('openVtFuelModal failed',e);}}showToast('Modal de VT indisponï¿½ï¿½vel no momento.','bg-yellow-600');});if (addVtBtn) addVtBtn.addEventListener('click',(ev)=>{if (typeof window.openVtFuelModal==='function'){try{window.openVtFuelModal(null);return;}catch(e){console.error('openVtFuelModal failed',e);}}showToast('Modal de VT indisponï¿½ï¿½vel no momento.','bg-yellow-600');});container.querySelectorAll('.delete-vt-usage-btn').forEach(btn=> btn.addEventListener('click',async (ev)=>{const id=ev.currentTarget.getAttribute('data-vt-usage-id');if (!id) return;try{const ok=await confirmAsync('Excluir este uso de VT?','Confirmar exclusï¿½o');if (!ok) return;}catch(e){return;}const md=getCurrentMonthData();if (!Array.isArray(md.vtUsage)) md.vtUsage=[];const idx=md.vtUsage.findIndex(u=> u.id===id);if (idx > -1) md.vtUsage.splice(idx,1);try{await storage.saveData(state.appData);showToast('Uso de VT excluï¿½ï¿½do.','bg-green-600');}catch(e){console.error('delete vt usage save',e);showToast('Falha ao salvar exclusï¿½o.','bg-red-600');}render();}));container.querySelectorAll('.edit-vt-usage-btn,.edit-vt-usage-trigger').forEach(el=> el.addEventListener('click',(ev)=>{const id=ev.currentTarget.getAttribute('data-vt-usage-edit-id') || ev.currentTarget.closest('[data-vt-usage-edit-id]')?.getAttribute('data-vt-usage-edit-id');if (!id) return;openVTUsageEdit(id);}));}catch(e){console.error('attach vt usage item handlers',e);}container.querySelectorAll('.edit-vr-usage-btn,.edit-vr-usage-trigger').forEach(el=> el.addEventListener('click',(ev)=>{const id=ev.currentTarget.getAttribute('data-vr-usage-edit-id') || ev.currentTarget.closest('[data-vr-usage-edit-id]')?.getAttribute('data-vr-usage-edit-id');if (!id) return;openVRUsageEdit(id);}));}catch(e){console.error('attach vr usage item handlers',e);}try{container.querySelectorAll('.vr-amount').forEach(el=> el.addEventListener('click',(e)=> (typeof startInlineVREdit==='function') ? startInlineVREdit(e.currentTarget,e.currentTarget.dataset.vrId) : null));}catch(e){/* ignore if nothing to bind */}try{container.querySelectorAll('.card-exp-amount').forEach(span=> span.addEventListener('click',(ev)=>{ev.stopPropagation();const expId=span.dataset.expId;if (!expId) return;openModal('expenses',expId);}));}catch(e){console.error('attach card-exp-amount handlers',e);}container.querySelectorAll('.last-installment-btn').forEach(el=> el.addEventListener('click',(ev)=>{const financingId=el.dataset.financingId || null;const installmentId=el.dataset.installmentId || null;goToLastInstallment({financingId,installmentId});}));container.querySelectorAll('.card-title-sortable').forEach(el=> el.addEventListener('click',(ev)=>{const cardName=ev.currentTarget.dataset.cardName;ui.cardSorts=ui.cardSorts ||{};const current=ui.cardSorts[cardName] || 'alf';ui.cardSorts[cardName]=current==='alf' ? 'value-desc' : 'alf';renderCreditCardView();}));container.querySelectorAll('.card-sort-arrow').forEach(btn=> btn.addEventListener('click',(ev)=>{ev.stopPropagation();const cardName=ev.currentTarget.dataset.cardName;const sort=ev.currentTarget.dataset.sort;ui.cardSorts=ui.cardSorts ||{};ui.cardSorts[cardName]=sort;renderCreditCardView();}));container.querySelectorAll('.anticipation-amount').forEach(el=> el.addEventListener('click',(ev)=>{ev.stopPropagation();const cardName=ev.currentTarget.dataset.cardName || ev.target.dataset.cardName;const y=String(state.currentDate.getFullYear());const m=String(String(state.currentDate.getMonth()+1).padStart(2,'0'));if (!state.appData.data[y]) state.appData.data[y]={};if (!state.appData.data[y][m]) state.appData.data[y][m]={incomes: [],expenses: [],savings: []};const md=state.appData.data[y][m];md.cardAnticipations=md.cardAnticipations ||{};const currentVal=Number(md.cardAnticipations[cardName] || 0);const input=prompt(`Valor antecipado para ${cardName}(R$):`,currentVal || '0');if (input===null) return;const v=parseFloat(String(input).replace(',','.')) || 0;if (v <=0) delete md.cardAnticipations[cardName];else md.cardAnticipations[cardName]=Math.round((v + Number.EPSILON) * 100) / 100;try{storage.saveData(state.appData);showToast('Valor antecipado atualizado.','bg-green-600');}catch(e){console.error('save anticipation',e);showToast('Falha ao salvar antecipaï¿½ï¿½o.','bg-red-600');}render();}));container.querySelectorAll('.group-header').forEach(h=> h.addEventListener('click',(ev)=>{const cardName=h.dataset.cardName;const desc=decodeURIComponent(h.dataset.descEnc || '');ui.cardGroups=ui.cardGroups ||{};ui.cardGroups[cardName]=ui.cardGroups[cardName] ||{};const current=ui.cardGroups[cardName][desc] || false;ui.cardGroups[cardName][desc]=!current;const root=h.closest('.expense-group');if (root){const items=root.querySelector('.group-items');const caret=root.querySelector('.group-caret');if (items) items.classList.toggle('hidden');if (caret) caret.textContent=(!current) ? 'â–¸' : 'â–¾';}}));try{container.querySelectorAll('.desc-wrap').forEach(wrap=>{wrap.addEventListener('mouseenter',(ev)=>{const btn=wrap.querySelector('.edit-cat-btn');const rem=wrap.querySelector('.remaining-total');if (btn) btn.classList.remove('invisible');if (rem) rem.classList.remove('hidden');});wrap.addEventListener('mouseleave',(ev)=>{const btn=wrap.querySelector('.edit-cat-btn');const rem=wrap.querySelector('.remaining-total');if (btn) btn.classList.add('invisible');if (rem) rem.classList.add('hidden');});});container.querySelectorAll('.edit-cat-btn').forEach(btn=> btn.addEventListener('click',(ev)=>{ev.stopPropagation();const expId=btn.dataset.expId;if (!expId) return;openModal('expenses',expId);}));}catch(e){console.error('attach card desc hover/edit handlers',e);}}function populateCardExpenses(cardName,cardExpenses){try{const root=document.querySelector(`#credit-cards-container [data-card-root="${cardName}"]`);if (!root) return;const listEl=root.querySelector(`.card-items-list[data-card-name="${cardName}"]`);if (!listEl) return;listEl.innerHTML='';const groups={};cardExpenses.forEach(exp=>{const key=(exp.description || '').trim() || (exp.category || 'Sem Descriï¿½ï¿½o');groups[key]=groups[key] || [];groups[key].push(exp);});const groupedKeys=[];const singleExpenses=[];Object.keys(groups).forEach(k=>{if (groups[k].length > 1) groupedKeys.push(k);else singleExpenses.push(groups[k][0]);});const isGrouped=!!state.cardGrouped[cardName];try{const btn=root.querySelector('.card-group-toggle .material-symbols-outlined');if (btn) btn.textContent=isGrouped ? 'vertical_split' : 'merge_type';}catch(e){}if (isGrouped){if (groupedKeys.length===0){listEl.innerHTML='<p class="text-sm text-gray-500">Nenhum grupo com mais de 1 lanï¿½amento.</p>';}else{try{const cardSortMode=(ui.cardSorts && ui.cardSorts[cardName]) || 'alf';if (cardSortMode==='alf') groupedKeys.sort((a,b)=> a.localeCompare(b));else if (cardSortMode==='value-desc') groupedKeys.sort((a,b)=>{const sa=groups[a].reduce((s,i)=> s + (Number(i.amount)||0),0);const sb=groups[b].reduce((s,i)=> s + (Number(i.amount)||0),0);return sb - sa;});else if (cardSortMode==='value-asc') groupedKeys.sort((a,b)=>{const sa=groups[a].reduce((s,i)=> s + (Number(i.amount)||0),0);const sb=groups[b].reduce((s,i)=> s + (Number(i.amount)||0),0);return sa - sb;});}catch(e){groupedKeys.sort((a,b)=> a.localeCompare(b));}const unified=[];groupedKeys.forEach(k=>{const items=groups[k];const total=items.reduce((s,i)=> s + (Number(i.amount)||0),0);unified.push({type: 'group',key: k,items: items,total: total,count: items.length});});singleExpenses.forEach(exp=> unified.push({type: 'single',expense: exp,total: Number(exp.amount) || 0}));const cardSortMode=(ui.cardSorts && ui.cardSorts[cardName]) || 'alf';if (cardSortMode==='value-desc') unified.sort((a,b)=> (Number(b.total)||0) - (Number(a.total)||0));else if (cardSortMode==='value-asc') unified.sort((a,b)=> (Number(a.total)||0) - (Number(b.total)||0));else unified.sort((a,b)=>{const aLabel=a.type==='group' ? (a.key||'') : (a.expense && a.expense.description ? a.expense.description : '');const bLabel=b.type==='group' ? (b.key||'') : (b.expense && b.expense.description ? b.expense.description : '');return aLabel.toString().toLowerCase().localeCompare(bLabel.toString().toLowerCase());});unified.forEach(item=>{if (item.type==='group'){const items=item.items;const sum=item.total;const count=item.count;const key=item.key;const row=document.createElement('div');row.className='flex w-full justify-between text-sm items-center group-item py-0.5 grouped-row';row._items=items;row.title=items.map(it=> `${formatCurrency(it.amount)}â€” ${escapeHtml(it.description || '')}`).join('\n');row.innerHTML=`<div class="desc-wrap flex items-center truncate pr-2" data-group-key="${encodeURIComponent(key)}" style="gap:6px;"><span class="desc-text truncate">${escapeHtml(key)}<span class="text-xs text-gray-500">(${count}â€¢ ${formatCurrency(sum)})</span></span><button class="group-info-btn invisible ml-2" data-group-key="${encodeURIComponent(key)}" title="Detalhes do grupo"><span class="material-symbols-outlined" style="font-size:16px;">info</span></button></div><span class="card-exp-amount font-medium flex-shrink-0">${formatCurrency(sum)}</span>`;row.addEventListener('click',()=>{try{const lines=items.map(it=> `${formatCurrency(it.amount)}â€” ${escapeHtml(it.description || '')}`);showModalList(`Detalhes: ${key}`,lines.join('\n'));}catch(e){console.error('group click',e);}});const btn=row.querySelector('.group-info-btn');if (btn){let tt=null;function showTip(){if (tt) return;tt=document.createElement('div');tt.className='expense-tooltip';const linesArr=items.map(it=> `${formatCurrency(it.amount)}â€” ${escapeHtml(it.description || '')}`);const totalVal=items.reduce((s,i)=>s+(Number(i.amount)||0),0);tt.innerHTML=linesArr.join('<br>') + '<br><hr style="opacity:.12;margin:6px 0">' + '<strong>Total: ' + formatCurrency(totalVal) + '</strong>';document.body.appendChild(tt);const r=btn.getBoundingClientRect();tt.style.position='fixed';tt.style.left=(r.left + 8) + 'px';tt.style.top=(r.top + r.height + 6) + 'px';tt.style.zIndex=4000;}function hideTip(){if (tt){try{tt.remove();}catch(e){}tt=null;}}btn.addEventListener('mouseenter',showTip);btn.addEventListener('mouseleave',hideTip);btn.addEventListener('click',(ev)=>{ev.stopPropagation();const lines=items.map(it=> `${formatCurrency(it.amount)}â€” ${escapeHtml(it.description || '')}`);showModalList(`Detalhes: ${key}`,lines.join('\n'));});}listEl.appendChild(row);}else{const exp=item.expense;const inst=exp.totalInstallments ? `<span class="text-xs text-gray-500">(${exp.currentInstallment}/<span class="last-installment-btn" data-installment-id="${exp.installmentId}" data-total="${exp.totalInstallments}">${exp.totalInstallments}</span>)</span>` : '';const fin=(exp.financingId && exp.totalFinancing) ? `<span class="text-xs text-gray-500">(${exp.currentFinancing}/<span class="last-installment-btn" data-financing-id="${exp.financingId}" data-total="${exp.totalFinancing}">${exp.totalFinancing}</span>)</span>` : '';const remainingHtml=exp.totalInstallments ? (()=>{const remainingCount=(exp.totalInstallments - (exp.currentInstallment || 1) + 1);const remainingTotal=(Number(exp.amount) || 0) * remainingCount;return `<span class="remaining-total text-xs text-gray-500 ml-2 hidden">${formatCurrency(remainingTotal)}</span>`;})() : '';const row=document.createElement('div');row.className='flex w-full justify-between text-sm items-center group-item py-0.5';row.innerHTML=`<div class="desc-wrap flex items-center truncate pr-2" data-exp-id="${exp.id}" style="gap:6px;"><span class="desc-text truncate">${escapeHtml(exp.description)}${inst}${fin}</span>${remainingHtml}<button class="edit-cat-btn invisible ml-2" data-exp-id="${exp.id}" title="Editar categoria"><span class="material-symbols-outlined" style="font-size:16px;">edit</span></button></div><span class="card-exp-amount font-medium flex-shrink-0" data-exp-id="${exp.id}">${formatCurrency(exp.amount)}</span>`;listEl.appendChild(row);}});}}else{if (cardExpenses.length===0){listEl.innerHTML='<p class="text-sm text-gray-500">Nenhum gasto este Mï¿½s.</p>';}else{cardExpenses.forEach(exp=>{const inst=exp.totalInstallments ? `<span class="text-xs text-gray-500">(${exp.currentInstallment}/<span class="last-installment-btn" data-installment-id="${exp.installmentId}" data-total="${exp.totalInstallments}">${exp.totalInstallments}</span>)</span>` : '';const fin=(exp.financingId && exp.totalFinancing) ? `<span class="text-xs text-gray-500">(${exp.currentFinancing}/<span class="last-installment-btn" data-financing-id="${exp.financingId}" data-total="${exp.totalFinancing}">${exp.totalFinancing}</span>)</span>` : '';const remainingHtml=exp.totalInstallments ? (()=>{const remainingCount=(exp.totalInstallments - (exp.currentInstallment || 1) + 1);const remainingTotal=(Number(exp.amount) || 0) * remainingCount;return `<span class="remaining-total text-xs text-gray-500 ml-2 hidden">${formatCurrency(remainingTotal)}</span>`;})() : '';const div=document.createElement('div');div.className='flex w-full justify-between text-sm items-center group-item py-0.5';div.innerHTML=`<div class="desc-wrap flex items-center truncate pr-2" data-exp-id="${exp.id}" style="gap:6px;"><span class="desc-text truncate">${escapeHtml(exp.description)}${inst}${fin}</span>${remainingHtml}<button class="edit-cat-btn invisible ml-2" data-exp-id="${exp.id}" title="Editar categoria"><span class="material-symbols-outlined" style="font-size:16px;">edit</span></button></div><span class="card-exp-amount font-medium flex-shrink-0" data-exp-id="${exp.id}">${formatCurrency(exp.amount)}</span>`;listEl.appendChild(div);});}}try{listEl.querySelectorAll('.desc-wrap').forEach(wrap=>{wrap.addEventListener('mouseenter',(ev)=>{const btn=wrap.querySelector('.edit-cat-btn');const rem=wrap.querySelector('.remaining-total');if (btn) btn.classList.remove('invisible');if (rem) rem.classList.remove('hidden');});wrap.addEventListener('mouseleave',(ev)=>{const btn=wrap.querySelector('.edit-cat-btn');const rem=wrap.querySelector('.remaining-total');if (btn) btn.classList.add('invisible');if (rem) rem.classList.add('hidden');});});}catch(e){console.error('attach desc hover handlers for card',e);}try{listEl.querySelectorAll('.last-installment-btn').forEach(btn=> btn.addEventListener('click',(ev)=>{const financingId=btn.dataset.financingId || null;const installmentId=btn.dataset.installmentId || null;goToLastInstallment({financingId,installmentId});}));listEl.querySelectorAll('.edit-cat-btn').forEach(btn=> btn.addEventListener('click',(ev)=>{ev.stopPropagation();const groupKeyEnc=btn.dataset.groupKey;if (groupKeyEnc){const key=decodeURIComponent(groupKeyEnc);let row=btn.closest('.group-item');let items=row && row._items;if (!items) items=groups && groups[key] ? groups[key] : [];if (items && items.length > 0){const lines=items.map(it=> `${formatCurrency(it.amount)}â€” ${escapeHtml(it.description || '')}`);showModalList(`Detalhes: ${key}`,lines.join('\n'));}else{showToast('Nenhum item encontrado para este grupo.','bg-yellow-600');}return;}const expId=btn.dataset.expId;if (!expId) return;openModal('expenses',expId);}));}catch(e){console.error('attach card action handlers',e);}try{const toggle=root.querySelector('.card-group-toggle');if (toggle && !toggle._attached){toggle._attached=true;}}catch(e){console.error('attach card toggle handler',e);}}catch(e){console.error('populateCardExpenses',e);}}function escapeHtml(s){return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}function sumSavingsForGoal(goalId){try{const allSavings=Object.values(state.appData.data).flatMap(y=> Object.values(y)).flatMap(m=> m.savings || []);return allSavings.filter(s=> s.goalId===goalId).reduce((sum,s)=> sum + (Number(s.amount) || 0),0);}catch (e){return 0;}}function auditSync(action,details){try{state.appData.metaSyncLog=state.appData.metaSyncLog || [];state.appData.metaSyncLog.push({id: generateUUID(),ts: new Date().toISOString(),action: action,details});}catch (e){console.error('auditSync error',e);}}async function applySavedToSavings(goalId,targetAmount){try{const current=sumSavingsForGoal(goalId);const diff=Math.round((Number(targetAmount) || 0) * 100) / 100 - Math.round((current) * 100) / 100;if (Math.abs(diff) < 0.01) return{created:0,removed:0,adjusted:0};if (diff > 0){const md=getCurrentMonthData();if (!Array.isArray(md.savings)) md.savings=[];const amt=Math.round(diff * 100) / 100;const entry={id: generateUUID(),description: `Aporte p/ meta`,category: (state.appData.settings.goals.find(g=>g.id===goalId)||{}).name || '',amount: amt,date: new Date().toISOString(),goalId};md.savings.push(entry);auditSync('create_saving',{goalId,amount: amt,entryId: entry.id});window.__autoCreateUndoStack=window.__autoCreateUndoStack || [];const undoItem={createdEntries: [{entryId: entry.id,year: state.currentDate.getFullYear(),month: (state.currentDate.getMonth()+1)}],ts: new Date().toISOString()};window.__autoCreateUndoStack.push(undoItem);if (typeof showToast==='function'){const message=`Aporte automï¿½tico de ${formatCurrency(amt)}criado para a meta. `;showToast(message + 'Clique para desfazer.','bg-green-600');try{const toast=document.getElementById('toast');if (toast){const clickHandler=async function(){try{for (const e of undoItem.createdEntries){const y=String(e.year);const m=String(e.month).padStart(2,'0');const md2=(state.appData.data && state.appData.data[y] && state.appData.data[y][m]) ? state.appData.data[y][m] : null;if (md2 && Array.isArray(md2.savings)){const idx=md2.savings.findIndex(s=> s.id===e.entryId);if (idx >=0) md2.savings.splice(idx,1);}}auditSync('undo_create_saving',{goalId,entryIds: undoItem.createdEntries.map(x=>x.entryId)});try{if (storage && storage.saveData) await storage.saveData(state.appData);}catch(e){}toast.style.display='none';render();}catch(err){console.error('undo auto-create',err);}};toast.addEventListener('click',clickHandler,{once:true});setTimeout(()=>{try{toast.removeEventListener('click',clickHandler);}catch(e){}},7000);}}catch(e){/* ignore toast wiring errors */}}return{created:1,removed:0,adjusted:0};}else{let remainingToRemove=Math.abs(diff);const entries=[];Object.keys(state.appData.data).forEach(year=>{Object.keys(state.appData.data[year]).forEach(month=>{const md=state.appData.data[year][month];if (Array.isArray(md.savings)){md.savings.forEach(s=>{if (s.goalId===goalId) entries.push({entry: s,md});});}});});entries.sort((a,b)=>{const da=new Date(a.entry.date || 0);const db=new Date(b.entry.date || 0);return db - da;});const plan=[];let tempRem=remainingToRemove;for (const item of entries){if (tempRem <=0) break;const amt=Number(item.entry.amount) || 0;if (amt <=tempRem + 0.0001){plan.push({type:'remove',id: item.entry.id,amount: amt,date: item.entry.date});tempRem=Math.round((tempRem - amt) * 100) / 100;}else{plan.push({type:'decrement',id: item.entry.id,from: amt,to: Math.round((amt - tempRem) * 100) / 100,date: item.entry.date});tempRem=0;}}const summary=plan.map(p=> p.type==='remove' ? `Remover ${formatCurrency(p.amount)}(${p.date||'â€”'})` : `Reduzir ${formatCurrency(p.from)}â†’ ${formatCurrency(p.to)}(${p.date||'â€”'})`).join('\n');try{const ok=await confirmAsync(`A meta esTï¿½ï¿½ maior do que os aportes registrados. Aplicar ajustes automï¿½ticos?\n\n${summary}`,'Ajustar aportes');if (!ok) return{created:0,removed:0,adjusted:0};}catch(e){return{created:0,removed:0,adjusted:0};}let removed=0,adjusted=0;for (const p of plan){if (p.type==='remove'){for (const year of Object.keys(state.appData.data)){for (const month of Object.keys(state.appData.data[year])){const md=state.appData.data[year][month];if (!Array.isArray(md.savings)) continue;const idx=md.savings.findIndex(x=> x.id===p.id);if (idx >=0){md.savings.splice(idx,1);removed++;break;}}}}else if (p.type==='decrement'){for (const year of Object.keys(state.appData.data)){for (const month of Object.keys(state.appData.data[year])){const md=state.appData.data[year][month];if (!Array.isArray(md.savings)) continue;const e=md.savings.find(x=> x.id===p.id);if (e){e.amount=p.to;adjusted++;break;}}}}}auditSync('adjust_savings',{goalId,removed,adjusted,plan});if (typeof showToast==='function') showToast(`Ajustes automï¿½ticos aplicados: removidos ${removed},ajustados ${adjusted}.`,'bg-yellow-600');return{created:0,removed,adjusted};}}catch (e){console.error('applySavedToSavings error',e);return{created:0,removed:0,adjusted:0};}}function showFieldError(fieldId,msg){try{const errEl=document.getElementById(fieldId + '-error');if (!errEl) return;if (msg){errEl.textContent=msg;errEl.classList.remove('hidden');}else{errEl.textContent='';errEl.classList.add('hidden');}}catch (e){/* ignore */}}function attachCurrencyHandlers(){try{const curIds=['tp-cost','tp-saved'];curIds.forEach(id=>{const el=document.getElementById(id);if (!el || el._currencyAttached) return;el._currencyAttached=true;el.addEventListener('focus',function(){const n=parseLocaleNumber(this.value);if (Number.isFinite(n) && !isNaN(n) && n !==0) this.value=(n % 1===0 ? String(n) : String(n));else this.value='';});el.addEventListener('input',function(e){const pos=this.selectionStart;let v=this.value || '';v=v.replace(/\u00A0/g,' ');v=v.replace(/[^0-9,\.\-]/g,'');if (v.indexOf('.') !==-1 && v.indexOf(',') !==-1){v=v.replace(/\./g,'').replace(/,/g,'.');}const parts=v.split(/[,\.]/);let intPart=parts[0] || '';let decPart=parts.length > 1 ? parts.slice(1).join('') : '';intPart=intPart.replace(/^0+(?=\d)/,'') || '0';intPart=intPart.replace(/\B(?=(\d{3})+(?!\d))/g,'.');this.value=decPart ? (intPart + ',' + decPart.slice(0,2)) : intPart;try{this.selectionStart=this.selectionEnd=this.value.length;}catch(e){}});el.addEventListener('blur',function(){const n=parseLocaleNumber(this.value);if (Number.isFinite(n) && !isNaN(n)) this.value=formatCurrency(n);else this.value='';});const init=parseLocaleNumber(el.value);if (Number.isFinite(init) && !isNaN(init)) el.value=formatCurrency(init);});}catch (e){console.error('attachCurrencyHandlers',e);}}async function payCardInvoice(cardName){try{if (!cardName) return;const monthData=getCurrentMonthData();const cardExpenses=(monthData.expenses || []).filter(exp=> exp.payment===cardName);if (cardExpenses.length===0) return;const allPaid=cardExpenses.every(exp=> exp.isPaid);cardExpenses.forEach(exp=>{exp.isPaid=!allPaid;});try{await storage.saveData(state.appData);if (allPaid) showToast(`Fatura ${cardName}revertida (desmarcada).`,'bg-gray-600');else showToast(`Fatura ${cardName}marcada como paga neste Mï¿½s.`,'bg-green-600');}catch (e){showToast('Falha ao salvar status da fatura no Firebase.','bg-red-600');}render();}catch (e){console.error('payCardInvoice',e);}}async function deleteGoal(id){if (!id) return;try{const ok=await confirmAsync('Tem certeza que deseja excluir esta meta?','Confirmar exclusï¿½o');if (!ok) return;}catch(e){return;}const idx=(state.appData.settings.goals || []).findIndex(g=> g.id===id);if (idx > -1){state.appData.settings.goals.splice(idx,1);try{await storage.saveData(state.appData);showToast('Meta excluï¿½ï¿½da','bg-red-600');}catch (e){showToast('Falha ao excluir meta no Firebase.','bg-red-600');}}}/** * Retorna o nï¿½mero de dias ï¿½ï¿½teis (segunda a sexta) de um Mï¿½s especï¿½ï¿½fico. * year - ano (ex: 2025) * month - Mï¿½s 1-12 */ function diasUteisNoMes(year,month){const m=month - 1;const primeiro=new Date(year,m,1);const ultimo=new Date(year,m + 1,0);let diasUteis=0;for (let d=1;d <=ultimo.getDate();d++){const dt=new Date(year,m,d);const dia=dt.getDay();if (dia !==0 && dia !==6) diasUteis++;}return diasUteis;}/** * calcularSalarioLiquido(params) * Calcula salï¿½ï¿½rio lï¿½ï¿½quido e detalhamento conforme regras fornecidas (INSS/IRRF 2025). * Parï¿½ï¿½metro params (obj): * - salarioBase (number) * - percentualPericulosidade (number) - ex: 30 * - outrosProventosTributaveis (number) - default 0 * - numeroDependentes (int) - default 0 * - valorDesjejumDia (number) - default 0 * - valorTransporteDia (number) - default 0 * - diasTrabalhados (int) - default 22 (pode ser calculado por year/month) * - horasExtrasSabado (number horas) - default 0 * - horasExtrasDomingo (number horas) - default 0 * - jornadaMensalHoras (number) - default 220 * - hourlyRate (number) - valor por hora,opcional * - hoursWorked (number) - horas trabalhadas no Mï¿½s,opcional * - year,month (opcionais) para calcular dias ï¿½ï¿½teis automaticamente * Retorna objeto JSON com resumo e detalhamento. */ function calcularSalarioLiquido(params={}){const p=Object.assign({salarioBase: 0,percentualPericulosidade: 0,outrosProventosTributaveis: 0,numeroDependentes: 0,valorDesjejumDia: 0,valorTransporteDia: 0,diasTrabalhados: undefined,horasExtrasSabado: 0,horasExtrasDomingo: 0,jornadaMensalHoras: 220,year: undefined,month: undefined},params);if (!p.hoursTrabalhadas || p.hoursTrabalhadas===0){p.hoursTrabalhadas=p.jornadaMensalHoras;}const baseDiasUteis=(p.year && p.month) ? diasUteisNoMes(p.year,p.month) : 22;if ((typeof p.diasTrabalhados==='undefined' || p.diasTrabalhados===null) && p.hoursTrabalhadas && p.hoursTrabalhadas > 0){const horasPorDia=p.jornadaMensalHoras > 0 ? (p.jornadaMensalHoras / baseDiasUteis) : 8;p.diasTrabalhados=p.hoursTrabalhadas / horasPorDia;p._diasTrabalhadosRoundedForDisplay=Math.round(p.diasTrabalhados);}if ((typeof p.diasTrabalhados==='undefined' || p.diasTrabalhados===null) && p.year && p.month){p.diasTrabalhados=baseDiasUteis;}if (typeof p.diasTrabalhados==='undefined' || p.diasTrabalhados===null) p.diasTrabalhados=22;const INSS_BRACKETS=[{upTo: 1518.00,rate: 0.075},{upTo: 2793.88,rate: 0.09},{upTo: 4190.83,rate: 0.12},{upTo: 8157.41,rate: 0.14}];const IRRF_BRACKETS=[{upTo: 2259.20,rate: 0.0,deduction: 0.00},{upTo: 2826.65,rate: 0.075,deduction: 169.44},{upTo: 3751.05,rate: 0.15,deduction: 381.44},{upTo: 4664.68,rate: 0.225,deduction: 662.77},{upTo: Infinity,rate: 0.275,deduction: 896.00}];const DEPENDENT_DEDUCTION=189.59;const fullMonthDias=(p.year && p.month) ? diasUteisNoMes(p.year,p.month) : 22;const diasWorked=(typeof p.diasTrabalhados !=='undefined' && p.diasTrabalhados !==null) ? p.diasTrabalhados : fullMonthDias;const proporcao=(fullMonthDias > 0) ? Math.min(1,diasWorked / fullMonthDias) : 1;let proporcaoHoras=1;if (p.hoursTrabalhadas && p.hoursTrabalhadas > 0){proporcaoHoras=Math.min(1,p.hoursTrabalhadas / p.jornadaMensalHoras);}const finalProporcao=(p.hoursTrabalhadas && p.hoursTrabalhadas > 0) ? proporcaoHoras : proporcao;const salarioBaseProrata=p.salarioBase * finalProporcao;const adicionalPericulosidade=(salarioBaseProrata * (p.percentualPericulosidade || 0)) / 100;const brutoTributavelSemExtras=salarioBaseProrata + adicionalPericulosidade + (p.outrosProventosTributaveis || 0);const valorHora=(p.jornadaMensalHoras > 0) ? (salarioBaseProrata / p.jornadaMensalHoras) : ((p.hoursTrabalhadas && p.hoursTrabalhadas > 0) ? (salarioBaseProrata / p.hoursTrabalhadas) : 0);const valorHorasExtras=(p.horasExtrasSabado || 0) * (valorHora * 1.5) + (p.horasExtrasDomingo || 0) * (valorHora * 2.0);const salarioBrutoTributavel=brutoTributavelSemExtras + valorHorasExtras;let remaining=salarioBrutoTributavel;let inssTotal=0;const inssPorFaixa=[];let lower=0;for (let i=0;i < INSS_BRACKETS.length;i++){const faixa=INSS_BRACKETS[i];const upper=faixa.upTo;const taxable=Math.max(0,Math.min(remaining,upper - lower));const desconto=taxable * faixa.rate;inssPorFaixa.push({lower: lower + 0.01,upper,taxable: round(taxable),rate: faixa.rate,desconto: round(desconto)});inssTotal +=desconto;remaining -=taxable;lower=upper;if (remaining <=0) break;}inssTotal=round(inssTotal);const totalDependenteDeduction=(p.numeroDependentes || 0) * DEPENDENT_DEDUCTION;const baseIRRF=Math.max(0,salarioBrutoTributavel - inssTotal - totalDependenteDeduction);let irrfRate=0,irrfDeduction=0,irrfValue=0;for (let i=0;i < IRRF_BRACKETS.length;i++){const b=IRRF_BRACKETS[i];if (baseIRRF <=b.upTo){irrfRate=b.rate;irrfDeduction=b.deduction;break;}}irrfValue=round(Math.max(0,baseIRRF * irrfRate - irrfDeduction));const totalDescontos=round(inssTotal + irrfValue);const salarioLiquido=round(salarioBrutoTributavel - totalDescontos);const beneficiosDiasBase=(p.year && p.month) ? (diasUteisNoMes(p.year,p.month) + 1) : (p.diasTrabalhados || fullMonthDias);const beneficiosVR=round((p.valorDesjejumDia || 0) * (beneficiosDiasBase || 0));const beneficiosVT=round((p.valorTransporteDia || 0) * (beneficiosDiasBase || 0));const beneficiosTotaisResumo=beneficiosVT;const beneficiosTotaisCombined=round(beneficiosVR + beneficiosVT);const remuneracaoTotal=round(salarioLiquido + beneficiosVT);const fgts=round(0.08 * salarioBrutoTributavel);const result={resumo:{salarioBase: formatNumber(salarioBaseProrata),adicionalPericulosidade: formatNumber(adicionalPericulosidade),valorHorasExtras: formatNumber(valorHorasExtras),salarioBrutoTributavel: formatNumber(salarioBrutoTributavel),totalDescontos: formatNumber(totalDescontos),salarioLiquido: formatNumber(salarioLiquido),beneficiosTotais: formatNumber(beneficiosTotaisResumo),remuneracaoTotal: formatNumber(remuneracaoTotal),fgts: formatNumber(fgts)},detalhe:{proventos:{salarioBase: formatNumber(salarioBaseProrata),adicionalPericulosidade: formatNumber(adicionalPericulosidade),outrosProventosTributaveis: formatNumber(p.outrosProventosTributaveis || 0),valorHorasExtras: formatNumber(valorHorasExtras)},descontos:{inssPorFaixa,inssTotal: formatNumber(inssTotal),baseIRRF: formatNumber(baseIRRF),irrfRate,irrfDeduction: formatNumber(irrfDeduction),irrfValue: formatNumber(irrfValue)},beneficios:{valorDesjejumDia: formatNumber(p.valorDesjejumDia || 0),valorTransporteDia: formatNumber(p.valorTransporteDia || 0),diasTrabalhados: p.diasTrabalhados,diasBaseParaBeneficios: beneficiosDiasBase,beneficiosVR: formatNumber(beneficiosVR),beneficiosVT: formatNumber(beneficiosVT),beneficiosTotais: formatNumber(beneficiosTotaisCombined)},encargos:{fgts: formatNumber(fgts)}}};return result;function round(v){return Math.round((v + Number.EPSILON) * 100) / 100;}function formatNumber(v){return (typeof v==='number') ? v.toFixed(2) : Number(v || 0).toFixed(2);}}function renderAllTables(){renderIncomeTable();renderExpenseTable();renderSavingsTable();try{attachSalaryTooltipHandlers();}catch(e){/* ignore */}}(function(){let salaryTooltipEl=null;function ensureTooltip(){if (salaryTooltipEl) return salaryTooltipEl;salaryTooltipEl=document.createElement('div');salaryTooltipEl.className='salary-tooltip';salaryTooltipEl.innerHTML=`<h4>Resumo do Salï¿½ï¿½rio</h4> <div class="row"><div class="label">Bruto tribuTï¿½ï¿½vel</div><div class="value" data-key="bruto">R$ 0,00</div></div> <div class="row"><div class="label">INSS</div><div class="value negative" data-key="inss">R$ 0,00</div></div> <div class="row"><div class="label">IRRF</div><div class="value negative" data-key="irrf">R$ 0,00</div></div> <div class="divider"></div> <div class="row"><div class="label">Total de descontos</div><div class="value negative" data-key="descontos">R$ 0,00</div></div> <div class="divider"></div> <div class="row summary"><div class="label">Remuneraï¿½ï¿½o total</div><div class="value positive" data-key="remuneracao">R$ 0,00</div></div>`;document.body.appendChild(salaryTooltipEl);return salaryTooltipEl;}function positionTooltip(target,el){const rect=target.getBoundingClientRect();const tooltipRect=el.getBoundingClientRect();let top=window.scrollY + rect.top - tooltipRect.height - 8;let left=window.scrollX + rect.right - tooltipRect.width;if (top < window.scrollY + 8) top=window.scrollY + rect.bottom + 8;left=Math.max(window.scrollX + 8,Math.min(left,window.scrollX + document.documentElement.clientWidth - tooltipRect.width - 8));el.style.top=top + 'px';el.style.left=left + 'px';}window.attachSalaryTooltipHandlers=function attachSalaryTooltipHandlers(){const el=ensureTooltip();const items=Array.from(document.querySelectorAll('.salary-breakdown-hidden'));items.forEach(item=>{item.onmouseenter=null;item.onmouseleave=null;item.onmousemove=null;item.addEventListener('mouseenter',(ev)=>{try{const id=item.dataset.id;const md=getCurrentMonthData();let income=null;if (md && Array.isArray(md.incomes)) income=md.incomes.find(i=> i.id===id) || null;const y=(state.currentDate && state.currentDate.getFullYear()) ? state.currentDate.getFullYear() : (new Date()).getFullYear();const m=(state.currentDate && typeof state.currentDate.getMonth==='function') ? (state.currentDate.getMonth() + 1) : ((new Date()).getMonth() + 1);const cacheKey=id ? `${id}@${y}-${m}` : null;let calc=(window.salaryCalcCache && cacheKey && window.salaryCalcCache[cacheKey]) ? window.salaryCalcCache[cacheKey] : null;if (!calc){let params=null;if (income && income.salaryMeta) params=Object.assign({},income.salaryMeta);else if (income && income.amount) params={salarioBase: income.amount};if (params){params.year=y;params.month=m;}const parseHours=(v)=>{if (v===undefined || v===null || v==='') return undefined;if (typeof v==='number') return v;let s=String(v).trim();const mcol=/^\s*-?\d{1,3}:[0-5]?\d\s*$/.exec(s);if (mcol){const parts=s.split(':');const hh=parseInt(parts[0],10) || 0;const mm=parseInt(parts[1],10) || 0;return hh + (mm / 60);}s=s.replace(',','.');const fv=parseFloat(s);return isNaN(fv) ? undefined : fv;};if (params){const rawHours=params.hoursTrabalhadas || params.horasTrabalhadas || params.hoursWorked || params.hours || params.horasTrabalhadasRaw || '';const ph=parseHours(rawHours);if (typeof ph !=='undefined') params.hoursTrabalhadas=ph;if (typeof params.jornadaMensalHoras==='undefined' || params.jornadaMensalHoras===null) params.jornadaMensalHoras=220;}if (params && typeof calcularSalarioLiquido==='function'){calc=calcularSalarioLiquido(params);try{window.salaryCalcCache=window.salaryCalcCache ||{};if (cacheKey) window.salaryCalcCache[cacheKey]=calc;}catch(e){}}}if (!calc) return;const brutoVal=Number((calc.resumo && (calc.resumo.salarioBrutoTributavel || calc.resumo.salarioBruto)) || 0);const inssVal=Number((calc.detalhe && calc.detalhe.descontos && (Number(calc.detalhe.descontos.inssTotal) || 0)) || (Number(calc.resumo && calc.resumo.inssTotal) || 0));const irrfVal=Number((calc.detalhe && calc.detalhe.descontos && (Number(calc.detalhe.descontos.irrfValue) || 0)) || (Number(calc.resumo && calc.resumo.irrfValue) || 0));const descontosVal=Number((calc.resumo && (Number(calc.resumo.totalDescontos) || 0)) || (inssVal + irrfVal));const remuneracaoVal=Number((calc.resumo && (Number(calc.resumo.remuneracaoTotal) || Number(calc.resumo.remuneracao) || 0)) || 0);const map={bruto: brutoVal,inss: inssVal,irrf: irrfVal,descontos: descontosVal,remuneracao: remuneracaoVal};Object.keys(map).forEach(k=>{const node=el.querySelector(`[data-key="${k}"]`);if (node) node.textContent=formatCurrency(Number(map[k] || 0));});el.style.display='block';positionTooltip(item,el);}catch (e){console.error('salary tooltip show',e);}});item.addEventListener('mouseleave',()=>{try{el.style.display='none';}catch(e){}});item.addEventListener('mousemove',(ev)=>{try{positionTooltip(item,el);}catch(e){}});});};})();function renderIncomeTable(){const monthData=getCurrentMonthData();if (!Array.isArray(monthData.incomes)) monthData.incomes=[];if (!Array.isArray(monthData.vrLedger)) monthData.vrLedger=[];if (!Array.isArray(monthData.vrUsage)) monthData.vrUsage=[];const incomes=monthData.incomes;ui.incomeTableBody.innerHTML='';if (incomes.length > 0){incomes.filter(i=> (i.source || '').toString() !=='benefit-vr' && (i.source || '').toString() !=='benefit-vt').forEach(income=> renderIncomeRow(income));}else{ui.incomeTableBody.innerHTML='<tr><td colspan="4" class="text-center text-gray-500 py-4">Nenhuma entrada registrada.</td></tr>';}try{function renderBenefitLedgerRows(type){const md=monthData;const keyLedger=(type==='vt') ? 'vtLedger' : 'vrLedger';const ledger=Array.isArray(md[keyLedger]) ? md[keyLedger] : [];ledger.forEach(l=>{const r=ui.incomeTableBody.insertRow();r.dataset.id=l.id || '';r.dataset[`${type}Id`]=l.id || '';const baseClass=(type==='vt') ? 'border-b border-gray-100 bg-yellow-50 text-yellow-700' : 'border-b border-gray-100 bg-green-50 text-green-700';r.className=baseClass + '';const descDefault=(type==='vt') ? 'Benefï¿½ï¿½cio - VT' : 'Benefï¿½ï¿½cio - VR';const recurringIcon=l.isRecurring ? '<span class="material-symbols-outlined text-xs text-gray-400" title="Recorrente">autorenew</span>' : '';const amountSpan=(type==='vt') ? `<span class="vt-amount" data-vt-id="${l.id}">${formatCurrency(l.amount || 0)}</span>` : `<span class="vr-amount" data-vr-id="${l.id}">${formatCurrency(l.amount || 0)}</span>`;const editBtn=(type==='vt') ? `<button class="edit-vt-btn text-gray-500 " data-vt-id="${l.id}"><span class="material-symbols-outlined text-xl">edit</span></button>` : `<button class="edit-vr-btn text-gray-500 " data-vr-id="${l.id}"><span class="material-symbols-outlined text-xl">edit</span></button>`;const deleteBtn=(type==='vt') ? `<button class="delete-vt-btn text-gray-500 " data-vt-id="${l.id}"><span class="material-symbols-outlined text-xl">delete</span></button>` : `<button class="delete-vr-btn text-gray-500 " data-vr-id="${l.id}"><span class="material-symbols-outlined text-xl">delete</span></button>`;const checkboxHtml=`<input type="checkbox" class="paid-checkbox h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500 cursor-pointer" ${l.isPaid ? 'checked' : ''}>`;r.innerHTML=` <td class="py-3 text-center checkbox-cell" style="padding-left: 12px;padding-right: 12px;">${checkboxHtml}</td> <td class="py-3 text-left" style="padding-left: 12px;padding-right: 12px;">${l.description || descDefault}${recurringIcon}</td> <td class="py-3 text-right font-medium" style="padding-left: 12px;padding-right: 12px;">${amountSpan}</td> <td class="py-3 text-center actions-cell" style="padding-left: 12px;padding-right: 12px;">${editBtn}${deleteBtn}</td>`;});}renderBenefitLedgerRows('vr');renderBenefitLedgerRows('vt');ui.incomeTableBody.querySelectorAll('.vr-amount').forEach(el=> el.addEventListener('click',(e)=> (typeof startInlineVREdit==='function') ? startInlineVREdit(e.currentTarget,e.currentTarget.dataset.vrId) : null));ui.incomeTableBody.querySelectorAll('.edit-vr-btn').forEach(b=> b.addEventListener('click',(e)=>{const id=e.currentTarget.dataset.vrId;openVREdit(id);}));ui.incomeTableBody.querySelectorAll('.delete-vr-btn').forEach(b=> b.addEventListener('click',async (e)=>{const id=e.currentTarget.dataset.vrId;if (!id) return;const md=getCurrentMonthData();const entry=(md.vrLedger || []).find(v=> v.id===id) || null;if (!entry) return;try{if (entry.isRecurring && entry.recurringId){const delAll=await confirmAsync('Este benefï¿½ï¿½cio ï¿½ï¿½ recorrente. Deseja excluir este e todas as recorrï¿½ï¿½ncias futuras?','Confirmar exclusï¿½o');if (!delAll) return;await deleteVRLedgerEntry(id);render();}else{const ok=await confirmAsync('Excluir lanï¿½amento de VR?','Confirmar exclusï¿½o');if (!ok) return;await deleteVRLedgerEntry(id);render();}}catch (e){return;}}));ui.incomeTableBody.querySelectorAll('.vt-amount').forEach(el=> el.addEventListener('click',(e)=> (typeof startInlineVTEdit==='function') ? startInlineVTEdit(e.currentTarget,e.currentTarget.dataset.vtId) : null));ui.incomeTableBody.querySelectorAll('.edit-vt-btn').forEach(b=> b.addEventListener('click',(e)=>{const id=e.currentTarget.dataset.vtId;openVTEdit(id);}));ui.incomeTableBody.querySelectorAll('.delete-vt-btn').forEach(b=> b.addEventListener('click',async (e)=>{const id=e.currentTarget.dataset.vtId;if (!id) return;const md=getCurrentMonthData();const entry=(md.vtLedger || []).find(v=> v.id===id) || null;if (!entry) return;try{if (entry.isRecurring && entry.recurringId){const delAll=await confirmAsync('Este benefï¿½ï¿½cio ï¿½ï¿½ recorrente. Deseja excluir este e todas as recorrï¿½ï¿½ncias futuras?','Confirmar exclusï¿½o');if (!delAll) return;await deleteVTLedgerEntry(id);render();}else{const ok=await confirmAsync('Excluir lanï¿½amento de VT?','Confirmar exclusï¿½o');if (!ok) return;await deleteVTLedgerEntry(id);render();}}catch (e){return;}}));}catch(e){console.error('renderIncomeTable benefit rows',e);}}function getMonthVRBalance(monthData){if (!monthData) monthData=getCurrentMonthData();const ledger=Array.isArray(monthData.vrLedger) ? monthData.vrLedger : [];const usage=Array.isArray(monthData.vrUsage) ? monthData.vrUsage : [];const sumLedger=ledger.reduce((s,l)=> s + (Number(l && l.amount) || 0),0);const sumUsage=usage.reduce((s,u)=> s + (Number(u && u.amount) || 0),0);const bal=Math.round((sumLedger - sumUsage + Number.EPSILON) * 100) / 100;return Math.max(0,bal);}function getMonthVTBalance(monthData){if (!monthData) monthData=getCurrentMonthData();const ledger=Array.isArray(monthData.vtLedger) ? monthData.vtLedger : [];const usage=Array.isArray(monthData.vtUsage) ? monthData.vtUsage : [];const sumLedger=ledger.reduce((s,l)=> s + (Number(l && l.amount) || 0),0);const sumUsage=usage.reduce((s,u)=> s + (Number(u && u.amount) || 0),0);const bal=Math.round((sumLedger - sumUsage + Number.EPSILON) * 100) / 100;return Math.max(0,bal);}function sortStrings(arr){if (!Array.isArray(arr)) return [];return arr.slice().sort((a,b)=>{const sa=(a||'').toString().toLowerCase();const sb=(b||'').toString().toLowerCase();return sa < sb ? -1 : sa > sb ? 1 : 0;});}function renderExpenseTable(){let expenses=Array.isArray(getCurrentMonthData().expenses) ? [...getCurrentMonthData().expenses] : [];if (state.filters.searchTerm){expenses=expenses.filter(exp=> exp.description.toLowerCase().includes(state.filters.searchTerm.toLowerCase()));}const ef=state.filters.expenseFilters ||{};if (ef){const norm=s=> (s || '').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');if (ef.payment){const want=norm(ef.payment);expenses=expenses.filter(exp=> (norm(exp.payment) || '').includes(want));}if (ef.category){const wantCat=norm(ef.category);expenses=expenses.filter(exp=> (norm(exp.category) || '').includes(wantCat));}if (ef.type){if (ef.type==='expense') expenses=expenses.filter(exp=> !exp.isSaving && (exp.source || '') !=='saving');if (ef.type==='saving') expenses=expenses.filter(exp=> !!exp.isSaving || (state.appData && state.appData.settings && Array.isArray(state.appData.settings.savingCategories) && state.appData.settings.savingCategories.map(c=>norm(c)).includes(norm(exp.category))));}if (ef.recurring) expenses=expenses.filter(exp=> !!exp.isRecurring);if (ef.installment) expenses=expenses.filter(exp=> !!exp.installmentId || !!exp.financingId || !!exp.totalInstallments || !!exp.totalFinancing || !!exp.isInstallment);if (ef.spendingType){const settings=state.appData && state.appData.settings ? state.appData.settings :{};const groups=settings.categoryGroups ||{};let essencials=groups.essencial || groups.essenciais || [];let reservas=groups.reserva || groups.reservas || [];if (!essencials || essencials.length===0){essencials=['Contas','Mercado','Saï¿½ï¿½de','Transporte','Assinaturas'];}if (!reservas || reservas.length===0){reservas=settings.savingCategories || ['Reserva de Emergï¿½ï¿½ncia','Poupanï¿½a'];}const normArr=arr=> (Array.isArray(arr) ? arr.map(x=> (x||'').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'')) : []);essencials=normArr(essencials);reservas=normArr(reservas);const expTypeCheck=(exp)=>{if (exp && exp.type && typeof exp.type==='string') return norm(exp.type);return null;};if (ef.spendingType==='essencial'){expenses=expenses.filter(exp=>{const t=expTypeCheck(exp);if (t) return t.includes('essencial');return essencials.includes(norm(exp.category));});}else if (ef.spendingType==='nao-essencial'){expenses=expenses.filter(exp=>{const t=expTypeCheck(exp);if (t){if (t.includes('essencial')) return false;if (t.includes('reserva') || t.includes('saving')) return false;return true;}const catNorm=norm(exp.category);return (!essencials.includes(catNorm) && !reservas.includes(catNorm));});}else if (ef.spendingType==='reserva'){expenses=expenses.filter(exp=>{const t=expTypeCheck(exp);if (t) return t.includes('reserva') || t.includes('saving');return reservas.includes(norm(exp.category));});}}}expenses.sort((a,b)=>{const key=state.sort.key;const order=state.sort.order==='asc' ? 1 : -1;if (key==='amount') return (a.amount - b.amount) * order;if (key==='isPaid'){return ((!!a.isPaid) - (!!b.isPaid)) * order;}const valA=a[key] || '';const valB=b[key] || '';return valA.localeCompare(valB) * order;});ui.expensesTableBody.innerHTML='';if (expenses.length > 0){expenses.forEach(expense=> renderExpenseRow(expense));}else{ui.expensesTableBody.innerHTML='<tr><td colspan="6" class="text-center text-gray-500 py-4">Nenhuma despesa registrada.</td></tr>';}updateSortHeaders();}function renderExpenseGroupedView(expenses){const groupsEl=document.getElementById('expenses-groups');const wrapper=document.getElementById('expenses-grouped-container');if (!groupsEl || !wrapper) return;const tableWrapper=ui.expensesTableBody ? ui.expensesTableBody.closest('.overflow-x-auto') : null;groupsEl.innerHTML='';if (!expenses || expenses.length===0){groupsEl.innerHTML='<div class="text-sm text-gray-500">Nenhuma despesa registrada.</div>';if (tableWrapper) tableWrapper.style.display='none';wrapper.classList.toggle('hidden',!state.showGroupedExpenses);return;}const normalize=v=> (v || '').toString().trim();const byDesc={};expenses.forEach(exp=>{const key=normalize(exp.description) || normalize(exp.category) || 'Sem Descriï¿½ï¿½o';if (!byDesc[key]) byDesc[key]=[];byDesc[key].push(exp);});const groupedKeys=[];const singleExpenses=[];Object.keys(byDesc).forEach(k=>{if (byDesc[k].length > 1) groupedKeys.push(k);else singleExpenses.push(byDesc[k][0]);});const unified=[];groupedKeys.forEach(k=>{const items=byDesc[k];const total=items.reduce((s,i)=> s + (Number(i.amount) || 0),0);unified.push({type: 'group',key: k,items: items,total: total,count: items.length});});singleExpenses.forEach(exp=> unified.push({type: 'single',expense: exp,total: Number(exp.amount) || 0}));try{if (state.sort && state.sort.key==='amount'){if (state.sort.order==='asc') unified.sort((a,b)=> (Number(a.total)||0) - (Number(b.total)||0));else unified.sort((a,b)=> (Number(b.total)||0) - (Number(a.total)||0));}else{unified.sort((a,b)=>{const aLabel=a.type==='group' ? (a.key||'') : (a.expense && a.expense.description ? a.expense.description : '');const bLabel=b.type==='group' ? (b.key||'') : (b.expense && b.expense.description ? b.expense.description : '');const cmp=aLabel.toString().toLowerCase().localeCompare(bLabel.toString().toLowerCase());return (state.sort && state.sort.order==='desc') ? -cmp : cmp;});}}catch(e){unified.sort((a,b)=>{const al=a.type==='group' ? (a.key||'') : (a.expense && a.expense.description ? a.expense.description : '');const bl=b.type==='group' ? (b.key||'') : (b.expense && b.expense.description ? b.expense.description : '');return al.toString().toLowerCase().localeCompare(bl.toString().toLowerCase());});}groupsEl.innerHTML='';unified.forEach(item=>{if (item.type==='group'){const items=item.items;const total=item.total;const count=item.count;const key=item.key;const row=document.createElement('div');row.className='flex w-full justify-between text-sm items-center group-item py-0.5 grouped-row';row._items=items;const breakdown=items.map(it=> `${formatCurrency(it.amount)}â€” ${escapeHtml(it.description || '')}`).join('\n');row.title=breakdown;const groupIcon=(typeof getIconFor==='function') ? getIconFor('category',key) : '';const groupLabel=(groupIcon && typeof iconHtml==='function') ? iconHtml(groupIcon,'text-sm text-gray-500') + `<span class="desc-text truncate">${escapeHtml(key)}<span class="text-xs text-gray-500">(${count}â€¢ ${formatCurrency(total)})</span></span>` : `<span class="desc-text truncate">${escapeHtml(key)}<span class="text-xs text-gray-500">(${count}â€¢ ${formatCurrency(total)})</span></span>`;row.innerHTML=`<div class="desc-wrap flex items-center truncate pr-2" data-group-key="${encodeURIComponent(key)}" style="gap:6px;">${groupLabel}<button class="group-info-btn invisible ml-2" data-group-key="${encodeURIComponent(key)}" title="Detalhes do grupo"><span class="material-symbols-outlined" style="font-size:16px;">info</span></button></div><span class="card-exp-amount font-medium flex-shrink-0">${formatCurrency(total)}</span>`;row.addEventListener('click',()=>{try{const lines=items.map(it=> `${formatCurrency(it.amount)}â€” ${escapeHtml(it.description || '')}(${escapeHtml(it.payment || it.category || '')})`);showModalList(`Detalhes: ${key}`,lines.join('\n'));}catch(e){console.error('group click',e);}});setTimeout(()=>{const infoBtn=row.querySelector('.group-info-btn');if (!infoBtn){groupsEl.appendChild(row);return;}let tt=null;function showTT(){if (tt) return;tt=document.createElement('div');tt.className='expense-tooltip';const lines=items.map(it=> `${formatCurrency(it.amount)}â€” ${escapeHtml(it.description || '')}`);const totalLine=`<strong>Total: ${formatCurrency(items.reduce((s,i)=>s+(Number(i.amount)||0),0))}</strong>`;tt.innerHTML=lines.join('<br>') + '<br><hr style="opacity:.12;margin:6px 0">' + totalLine;document.body.appendChild(tt);const r=infoBtn.getBoundingClientRect();tt.style.position='fixed';tt.style.left=(r.left + 8) + 'px';tt.style.top=(r.top + r.height + 6) + 'px';tt.style.zIndex=4000;}function hideTT(){if (tt){try{tt.remove();}catch(e){}tt=null;}}infoBtn.addEventListener('mouseenter',showTT);infoBtn.addEventListener('mouseleave',hideTT);infoBtn.addEventListener('click',(ev)=>{ev.stopPropagation();const lines=items.map(it=> `${formatCurrency(it.amount)}â€” ${escapeHtml(it.description || '')}(${escapeHtml(it.payment || it.category || '')})`);showModalList(`Detalhes: ${key}`,lines.join('\n'));});groupsEl.appendChild(row);},0);}else{const exp=item.expense;const inst=exp.totalInstallments ? `<span class="text-xs text-gray-500">(${exp.currentInstallment}/<span class="last-installment-btn" data-installment-id="${exp.installmentId}" data-total="${exp.totalInstallments}">${exp.totalInstallments}</span>)</span>` : '';const fin=(exp.financingId && exp.totalFinancing) ? `<span class="text-xs text-gray-500">(${exp.currentFinancing}/<span class="last-installment-btn" data-financing-id="${exp.financingId}" data-total="${exp.totalFinancing}">${exp.totalFinancing}</span>)</span>` : '';const remainingHtml=exp.totalInstallments ? (()=>{const remainingCount=(exp.totalInstallments - (exp.currentInstallment || 1) + 1);const remainingTotal=(Number(exp.amount) || 0) * remainingCount;return `<span class="remaining-total text-xs text-gray-500 ml-2 hidden">${formatCurrency(remainingTotal)}</span>`;})() : '';const row=document.createElement('div');row.className='flex justify-between text-sm items-center group-item py-0.5';row.dataset.expId=exp.id || '';const smallCatIcon=(typeof getIconFor==='function') ? getIconFor('category',exp.category || '') : '';const leftLabel=(smallCatIcon && typeof iconHtml==='function') ? iconHtml(smallCatIcon,'text-sm text-gray-500') + `<span class="desc-text truncate">${escapeHtml(exp.description)}${inst}${fin}</span>` : `<span class="desc-text truncate">${escapeHtml(exp.description)}${inst}${fin}</span>`;row.innerHTML=`<div class="desc-wrap flex items-center truncate pr-2" data-exp-id="${exp.id}" style="gap:6px;">${leftLabel}${remainingHtml}<button class="edit-cat-btn invisible ml-2" data-exp-id="${exp.id}" title="Editar categoria"><span class="material-symbols-outlined" style="font-size:16px;">edit</span></button></div><span class="card-exp-amount font-medium flex-shrink-0" data-exp-id="${exp.id}">${formatCurrency(exp.amount)}</span>`;groupsEl.appendChild(row);}});if (tableWrapper) tableWrapper.style.display='none';wrapper.classList.toggle('hidden',!state.showGroupedExpenses);try{groupsEl.querySelectorAll('.desc-wrap').forEach(wrap=>{wrap.addEventListener('mouseenter',(ev)=>{const btn=wrap.querySelector('.edit-cat-btn');const rem=wrap.querySelector('.remaining-total');if (btn) btn.classList.remove('invisible');if (rem) rem.classList.remove('hidden');});wrap.addEventListener('mouseleave',(ev)=>{const btn=wrap.querySelector('.edit-cat-btn');const rem=wrap.querySelector('.remaining-total');if (btn) btn.classList.add('invisible');if (rem) rem.classList.add('hidden');});});groupsEl.querySelectorAll('.last-installment-btn').forEach(btn=> btn.addEventListener('click',(ev)=>{ev.stopPropagation();const financingId=btn.dataset.financingId || null;const installmentId=btn.dataset.installmentId || null;goToLastInstallment({financingId,installmentId});}));groupsEl.querySelectorAll('.edit-cat-btn').forEach(btn=> btn.addEventListener('click',(ev)=>{ev.stopPropagation();const groupKeyEnc=btn.dataset.groupKey;if (groupKeyEnc){const key=decodeURIComponent(groupKeyEnc);let row=btn.closest('.group-item');let items=row && row._items;if (!items) items=byDesc && byDesc[key] ? byDesc[key] : [];if (items && items.length > 0){const lines=items.map(it=> `${formatCurrency(it.amount)}â€” ${escapeHtml(it.description || '')}`);showModalList(`Detalhes: ${key}`,lines.join('\n'));}else{showToast('Nenhum item encontrado para este grupo.','bg-yellow-600');}return;}const expId=btn.dataset.expId;if (!expId) return;openModal('expenses',expId);}));}catch(e){console.error('attach grouped view handlers',e);}}function escapeHtml(str){return (str || '').toString().replace(/[&<>"']/g,function(m){return{'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m];});}function showModalList(title,content){try{const modal=document.getElementById('transaction-modal');if (!modal){alert(title + '\n\n' + content);return;}let container=modal.querySelector('.group-modal-content');if (!container){container=document.createElement('div');container.className='group-modal-content p-4';container.style.maxHeight='60vh';container.style.overflow='auto';const body=modal.querySelector('.modal-body') || modal;body.appendChild(container);}container.innerHTML=`<h3 class="text-lg font-semibold mb-2">${escapeHtml(title)}</h3><pre style="white-space:pre-wrap">${escapeHtml(content)}</pre>`;openModal();}catch(e){alert(title + '\n\n' + content);}}function renderSavingsTable(){const savings=Array.isArray(getCurrentMonthData().savings) ? getCurrentMonthData().savings : [];ui.savingsTableBody.innerHTML='';if(savings.length > 0){savings.forEach(saving=> renderSavingRow(saving));}else{ui.savingsTableBody.innerHTML='<tr><td colspan="4" class="text-center text-gray-500 py-4">Nenhuma reserva registrada.</td></tr>';}}function renderIncomeRow(income){const row=ui.incomeTableBody.insertRow();row.dataset.id=income.id;row.className=`border-b border-gray-200 ${income.isPaid ? 'opacity-60' : ''}`;const isSalary=!!income.isSalary || !!income.salaryMeta || /salari/i.test(String(income.description || ''));const amountHtml=`<span class="amount salary-breakdown-hidden text-green-600 font-medium" data-id="${income.id}">${formatCurrency(income.amount)}</span>`;const payIcon=(typeof getIconFor==='function') ? getIconFor('payment',income.payment || '') : '';const descLabel=(payIcon && typeof iconHtml==='function') ? iconHtml(payIcon,'text-sm text-gray-500') + `<span>${escapeHtml(income.description || '')}</span>` : escapeHtml(income.description || '');{row.innerHTML=` <td class="py-3 text-center checkbox-cell" style="padding-left: 12px;padding-right: 12px;" data-label="Confirmado"><input type="checkbox" class="paid-checkbox h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500 cursor-pointer" ${income.isPaid ? 'checked' : ''}></td> <td class="py-3 text-left description-cell" style="padding-left: 12px;padding-right: 12px;" data-label="Descriï¿½ï¿½o" title="${escapeHtml(income.description)}">${descLabel}${income.isRecurring ? '<span class="material-symbols-outlined text-xs text-gray-400" title="Recorrente">autorenew</span>' : ''}</td> <td class="py-3 text-right font-medium text-green-600" style="padding-left: 12px;padding-right: 12px;" data-label="Valor">${amountHtml}</td> <td class="py-3 text-center actions-cell" style="padding-left: 12px;padding-right: 12px;"> <button class="edit-btn text-gray-500 " title="Editar" aria-label="Editar transaï¿½ï¿½o"><span class="material-symbols-outlined text-xl">edit</span></button> <button class="delete-btn text-gray-500 " title="Excluir"><span class="material-symbols-outlined text-xl">delete</span></button> </td>`;}if (isSalary){try{const span=row.querySelector('.salary-breakdown-hidden');if (span) span.addEventListener('click',(ev)=>{ev.preventDefault();openSalaryBreakdown(income);});}catch (e){console.error('attach salary breakdown click',e);}}}function renderExpenseRow(expense){const row=ui.expensesTableBody.insertRow();row.dataset.id=expense.id;row.className=`border-b border-gray-200 ${expense.isPaid ? 'opacity-60' : ''}`;const installmentHtml=expense.totalInstallments ? `<span class="text-xs text-gray-500">(${expense.currentInstallment}/<span class="last-installment-btn" data-installment-id="${expense.installmentId}" data-total="${expense.totalInstallments}">${expense.totalInstallments}</span>)</span>` : '';const financingHtml=(expense.financingId && expense.totalFinancing) ? `<span class="text-xs text-gray-500">(${expense.currentFinancing}/<span class="last-installment-btn" data-financing-id="${expense.financingId}" data-total="${expense.totalFinancing}">${expense.totalFinancing}</span>)</span>` : '';const displayPaymentLabel=(typeof getPaymentLabel==='function') ? getPaymentLabel(expense.payment || '') : (expense.payment || '');const paymentIcon=(typeof getIconFor==='function') ? getIconFor('payment',displayPaymentLabel || expense.payment || '') : '';const categoryIcon=(typeof getIconFor==='function') ? getIconFor('category',expense.category || '') : '';const paymentHtml=(typeof iconHtml==='function' && paymentIcon) ? iconHtml(paymentIcon,'text-sm text-gray-500') + `<span>${escapeHtml(displayPaymentLabel || expense.payment || '')}</span>` : escapeHtml(displayPaymentLabel || expense.payment || '');const categoryHtml=(typeof iconHtml==='function' && categoryIcon) ? iconHtml(categoryIcon,'text-sm text-gray-500') + `<span>${escapeHtml(expense.category || '')}</span>` : escapeHtml(expense.category || '');{row.innerHTML=` <td class="py-3 text-center checkbox-cell" style="padding-left: 12px;padding-right: 12px;" data-label="Pago"><input type="checkbox" class="paid-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer" ${expense.isPaid ? 'checked' : ''}></td> <td class="py-3 text-left description-cell" style="padding-left: 12px;padding-right: 12px;" data-label="Descriï¿½ï¿½o" title="${escapeHtml(expense.description)}">${escapeHtml(expense.description)}${expense.isRecurring ? '<span class="material-symbols-outlined text-xs text-gray-400" title="Recorrente">autorenew</span>' : ''}${installmentHtml}${financingHtml}</td> <td class="py-3 text-left text-gray-600" style="padding-left: 12px;padding-right: 12px;" data-label="Pagamento">${paymentHtml}</td> <td class="py-3 text-left text-gray-600" style="padding-left: 12px;padding-right: 12px;" data-label="Categoria">${categoryHtml}</td> <td class="py-3 text-right text-red-600 font-medium" style="padding-right: 12px;" data-label="Valor">${formatCurrency(expense.amount)}</td> <td class="py-3 text-center actions-cell align-middle" style="padding-left: 12px;padding-right: 12px;"> <button class="edit-btn text-gray-500 disabled:opacity-30 disabled:cursor-not-allowed" title="Editar" aria-label="Editar despesa" ${expense.installmentId ? 'disabled' : ''}><span class="material-symbols-outlined text-xl">${expense.installmentId ? 'lock' : 'edit'}</span></button> <button class="delete-btn text-gray-500 " title="Excluir"><span class="material-symbols-outlined text-xl">delete</span></button> </td>`;}const lastBtn=row.querySelector('.last-installment-btn');if (lastBtn){lastBtn.addEventListener('click',(ev)=>{const financingId=lastBtn.dataset.financingId || null;const installmentId=lastBtn.dataset.installmentId || null;goToLastInstallment({financingId,installmentId});});}}function renderSavingRow(saving){const row=ui.savingsTableBody.insertRow();row.dataset.id=saving.id;row.className='border-b border-gray-200 ';const catIcon=(typeof getIconFor==='function') ? getIconFor('category',saving.category || '') : '';const catLabel=(state.appData.settings.goals||[]).some(g=>g.name===saving.category) ? 'Meta' : escapeHtml(saving.category || '');const catHtml=(catIcon && typeof iconHtml==='function') ? iconHtml(catIcon,'text-sm text-gray-500') + `<span>${catLabel}</span>` : catLabel;row.innerHTML=` <td class="py-3 px-3" data-label="Descriï¿½ï¿½o">${escapeHtml(saving.description)}${saving.isRecurring ? '<span class="material-symbols-outlined text-xs text-gray-400" title="Recorrente">autorenew</span>' : ''}</td> <td class="py-3 px-3 text-gray-600" data-label="Categoria">${catHtml}</td> <td class="py-3 px-3 font-medium text-indigo-600" data-label="Valor">${formatCurrency(saving.amount)}</td> <td class="py-3 px-3 text-right actions-cell align-middle"> <button class="edit-btn text-gray-500 " title="Editar" aria-label="Editar transaï¿½ï¿½o"><span class="material-symbols-outlined text-xl">edit</span></button> <button class="delete-btn text-gray-500 " title="Excluir"><span class="material-symbols-outlined text-xl">delete</span></button> </td>`;}function renderGoals(){const container=ui.goalsContainer;const goals=(state.appData.settings.goals || []).slice().sort((a,b)=>{const A=(a.name||'').toLowerCase();const B=(b.name||'').toLowerCase();return A < B ? -1 : A > B ? 1 : 0;});const allSavings=Object.values(state.appData.data).flatMap(y=> Object.values(y)).flatMap(m=> m.savings || []);container.innerHTML=``;if (goals.length===0) container.innerHTML +='<p class="text-center text-gray-500">Nenhuma meta definida.</p>';goals.forEach(goal=>{const totalSavedForGoal=allSavings.filter(s=> ((s.category===goal.name) || (s.goalId && s.goalId===goal.id))).reduce((sum,s)=> sum + s.amount,0);const percentage=Math.min((totalSavedForGoal / goal.amount) * 100,100);const isCompleted=percentage >=100;if (isCompleted){showToast(`Meta atingida: ${goal.name}! Parabï¿½ns!`,'bg-green-600');if (window.confetti) window.confetti();}container.innerHTML +=` <div class="goal-item"> <div class="flex justify-between items-center mb-1"> <span class="font-semibold">${goal.name}${isCompleted ? 'ðŸŽ‰' : ''}</span> <div class="flex items-center gap-2"> <span class="text-sm text-gray-600">${formatCurrency(totalSavedForGoal)}/ ${formatCurrency(goal.amount)}</span> <button data-id="${goal.id}" class="quick-add-goal-btn p-1.5 text-green-600 rounded " title="Adicionar valor"> <span class="material-symbols-outlined text-lg">add_circle</span> </button> <button data-id="${goal.id}" class="delete-goal-btn p-1 text-gray-400 "><span class="material-symbols-outlined text-lg">delete</span></button> </div> </div> <div class="progress-bar"> <div class="bg-green-500" style="width: ${percentage}%"></div> </div> </div>`;});container.querySelectorAll('.delete-goal-btn').forEach(btn=> btn.addEventListener('click',(e)=> deleteGoal(e.currentTarget.dataset.id)));container.querySelectorAll('.quick-add-goal-btn').forEach(btn=> btn.addEventListener('click',(e)=>{e.stopPropagation();const goalId=e.currentTarget.dataset.id;const goal=(state.appData.settings.goals || []).find(g=> g.id===goalId);if (!goal) return;try{const modal=document.getElementById('transaction-modal');if (!modal) return;if (typeof resetTransactionForm==='function') resetTransactionForm();if (typeof modal.showModal==='function'){modal.showModal();}else{modal.setAttribute('open','');}setTimeout(()=>{const savingsTypeBtn=document.querySelector('[data-type="savings"]');if (savingsTypeBtn){savingsTypeBtn.click();setTimeout(()=>{const categorySelect=document.getElementById('category-saving');if (categorySelect){let found=false;for (let i=0;i < categorySelect.options.length;i++){const optionValue=categorySelect.options[i].value;const optionText=categorySelect.options[i].text;if (optionValue===goal.name || optionText===goal.name || optionText.includes(goal.name) || optionValue.includes(goal.name)){categorySelect.selectedIndex=i;categorySelect.value=optionValue;categorySelect.dispatchEvent(new Event('change',{bubbles: true}));found=true;break;}}if (!found){}}else{}const descInput=document.getElementById('description');if (descInput && !descInput.value){descInput.value=`Reserva para ${goal.name}`;}const amountInput=document.getElementById('amount');if (amountInput){amountInput.focus();amountInput.select();}},200);}},50);}catch(error){showToast('Erro ao abrir formulï¿½ï¿½rio de reserva','bg-red-600');}}));}function updateKPIs(){try{const monthData=getCurrentMonthData();const totalIncome=(monthData.incomes || []).reduce((s,t)=> s + (t.amount || 0),0);const expensesAll=monthData.expenses || [];const paymentMethods=(state.appData.settings && state.appData.settings.paymentMethods) || [];const cardMethods=paymentMethods.filter(p=> p.type==='credit_card');const cardAnticipations=monthData.cardAnticipations ||{};const byPayment=expensesAll.reduce((acc,e)=>{const k=(typeof getPaymentLabel==='function') ? getPaymentLabel(e.payment || '') : (e.payment || '_none_');(acc[k]=acc[k] || []).push(e);return acc;},{});let totalExpenses=0;for (const [payment,group] of Object.entries(byPayment)){const isCardPayment=cardMethods.some(c=> paymentMatches(payment || '',c.name));if (isCardPayment){const paidCount=group.filter(g=> g.isPaid).length;if (group.length > 0 && paidCount===group.length){const sumAll=group.reduce((s,x)=> s + (Number(x.amount) || 0),0);const anticipatedForCard=Number(cardAnticipations[payment] || 0);totalExpenses +=Math.round((sumAll - anticipatedForCard + Number.EPSILON) * 100) / 100;}else{totalExpenses +=group.filter(g=> g.isPaid).reduce((s,x)=> s + (Number(x.amount) || 0),0);}}else{totalExpenses +=group.filter(g=> g.isPaid).reduce((s,x)=> s + (Number(x.amount) || 0),0);}}const totalSavings=(monthData.savings || []).reduce((s,t)=> s + (t.amount || 0),0);const balance=totalIncome - totalExpenses - totalSavings;animateKPINumber('kpi-total-income',totalIncome);animateKPINumber('kpi-total-expenses',totalExpenses);animateKPINumber('kpi-total-savings',totalSavings);animateKPINumber('kpi-balance',balance);const totalProjectedExpenses=(monthData.expenses || []).reduce((s,e)=> s + (Number(e && e.amount) || 0),0);const totalAnticipations=Object.values(monthData.cardAnticipations ||{}).reduce((s,a)=> s + (Number(a) || 0),0);const adjustedProjectedExpenses=totalProjectedExpenses - totalAnticipations;const projectedBalance=totalIncome - adjustedProjectedExpenses - totalSavings;const projEl=document.getElementById('kpi-projected-balance');if (projEl){animateKPINumber('kpi-projected-balance',projectedBalance);projEl.classList.toggle('text-red-600',projectedBalance < 0);projEl.classList.toggle('text-green-600',projectedBalance >=0);}const projExpEl=document.getElementById('kpi-projected-expenses');if (projExpEl) animateKPINumber('kpi-projected-expenses',adjustedProjectedExpenses);const expenses=monthData.expenses || [];const totalMonthExpenses=expenses.reduce((s,exp)=> s + (Number(exp.amount) || 0),0);const container=document.getElementById('kpi-expense-percentuals');if (container){container.innerHTML='';if (!expenses || expenses.length===0 || totalMonthExpenses===0){container.innerHTML='<span class="text-gray-400 text-xs">Nenhuma despesa registrada.</span>';}else{const groupsMap=new Map();expenses.forEach(exp=>{const rawDesc=(exp.description || exp.category || 'Sem Descriï¿½ï¿½o').toString().trim();const key=rawDesc.toLowerCase();const amount=Number(exp.amount) || 0;if (!groupsMap.has(key)) groupsMap.set(key,{description: rawDesc,amount: 0,count: 0});const g=groupsMap.get(key);g.amount +=amount;g.count +=1;});const grouped=Array.from(groupsMap.values()).map(g=> ({description: g.description,amount: g.amount,count: g.count,percent: totalMonthExpenses > 0 ? (g.amount / totalMonthExpenses) * 100 : 0}));grouped.sort((a,b)=> b.percent - a.percent);grouped.forEach(g=>{const percentStr=g.percent.toFixed(1);const countStr=g.count > 1 ? ` <span class="text-gray-400">(${g.count})</span>` : '';const left=`${escapeHtml(g.description)}${countStr}`;const right=`<span class="text-sm text-gray-600">${percentStr}%</span> <span class="ml-3 font-medium">${formatCurrency(g.amount)}</span>`;container.innerHTML +=`<div class="flex justify-between items-center text-sm"> <div class="truncate pr-4">${left}</div><div class="flex items-center">${right}</div></div>`;});}}getFeedback(totalIncome,totalExpenses,totalSavings);try{const creditedTotal=(monthData.vrLedger || []).reduce((s,l)=> s + (Number(l && l.amount) || 0),0);let usedTotal=(monthData.vrUsage || []).reduce((s,u)=> s + (Number(u && u.amount) || 0),0);try{const expensesVR=(monthData.expenses || []).filter(e=> paymentMatches(e.payment || '','VR'));usedTotal +=expensesVR.reduce((s,e)=> s + (Number(e && e.amount) || 0),0);}catch(e){}const usedRounded=Math.round((usedTotal + Number.EPSILON) * 100) / 100;const creditRounded=Math.round((creditedTotal + Number.EPSILON) * 100) / 100;const displayAmount=Math.max(0,Math.round((creditRounded - usedRounded) * 100) / 100);const valuesEl=document.getElementById('kpi-vr-values');if (valuesEl) valuesEl.textContent=formatCurrency(displayAmount);const progressEl=document.getElementById('kpi-vr-progress');const barTextEl=document.getElementById('kpi-vr-bar-text');if (progressEl){const pctRaw=creditRounded > 0 ? (usedRounded / creditRounded) : 0;const pct=Math.min(1,Math.max(0,pctRaw));progressEl.style.width=`${Math.round(pct * 100)}%`;progressEl.classList.remove('bg-green-500','bg-yellow-400','bg-red-500');if (pctRaw >=1) progressEl.classList.add('bg-red-500');else if (pctRaw >=0.75) progressEl.classList.add('bg-yellow-400');else progressEl.classList.add('bg-green-500');try{progressEl.title=`${Math.round((pctRaw)*100)}% utilizado (${formatCurrency(usedRounded)}de ${formatCurrency(creditRounded)})`;}catch(e){}}if (barTextEl){const pctDisplay=Math.round((creditRounded > 0 ? (usedRounded / creditRounded) : 0) * 100);barTextEl.textContent=`${formatCurrency(usedRounded)}(${pctDisplay}% gasto)`;}}catch(e){console.error('updateKPIs vr kpi',e);}try{const vtCredited=(monthData.vtLedger || []).reduce((s,l)=> s + (Number(l && l.amount) || 0),0);let vtUsed=(monthData.vtUsage || []).reduce((s,u)=> s + (Number(u && u.amount) || 0),0);try{const expensesVT=(monthData.expenses || []).filter(e=> paymentMatches(e.payment || '','VT'));vtUsed +=expensesVT.reduce((s,e)=> s + (Number(e && e.amount) || 0),0);}catch(e){}const vtUsedRounded=Math.round((vtUsed + Number.EPSILON) * 100) / 100;const vtCreditRounded=Math.round((vtCredited + Number.EPSILON) * 100) / 100;const vtDisplay=Math.max(0,Math.round((vtCreditRounded - vtUsedRounded) * 100) / 100);const vtValuesEl=document.getElementById('kpi-vt-values');if (vtValuesEl) vtValuesEl.textContent=formatCurrency(vtDisplay);const vtProgressEl=document.getElementById('kpi-vt-progress');const vtBarTextEl=document.getElementById('kpi-vt-bar-text');if (vtProgressEl){const pctRaw=vtCreditRounded > 0 ? (vtUsedRounded / vtCreditRounded) : 0;const pct=Math.min(1,Math.max(0,pctRaw));vtProgressEl.style.width=`${Math.round(pct * 100)}%`;vtProgressEl.classList.remove('bg-yellow-500','bg-yellow-400','bg-red-500');if (pctRaw >=1) vtProgressEl.classList.add('bg-red-500');else if (pctRaw >=0.75) vtProgressEl.classList.add('bg-yellow-500');else vtProgressEl.classList.add('bg-yellow-400');try{vtProgressEl.title=`${Math.round((pctRaw)*100)}% utilizado (${formatCurrency(vtUsedRounded)}de ${formatCurrency(vtCreditRounded)})`;}catch(e){}}if (vtBarTextEl){const pctDisplayVT=Math.round((vtCreditRounded > 0 ? (vtUsedRounded / vtCreditRounded) : 0) * 100);vtBarTextEl.textContent=`${formatCurrency(vtUsedRounded)}(${pctDisplayVT}% gasto)`;}}catch(e){console.error('updateKPIs vt kpi',e);}}catch (e){}}function getFeedback(income,expenses,savings){try{const settings=state.appData && state.appData.settings ? state.appData.settings :{};const feedbackMessages=settings.feedbackMessages || [];const spendingGoals=settings.spendingGoals || [];let feedbackId='B';if (income > 0){const savingGoal=(spendingGoals.find(g=> g.type==='Reserva') ||{}).goal || 0;const nonEssentialGoal=(spendingGoals.find(g=> g.type==='nï¿½o Essenciais') ||{}).goal || 0;const essentialGoal=(spendingGoals.find(g=> g.type==='Essenciais') ||{}).goal || 0;if ((income - expenses - savings) < 0) feedbackId='F';else if (savings < income * savingGoal) feedbackId='E';else if (expenses > income * (nonEssentialGoal + essentialGoal)) feedbackId='C';else feedbackId='B';}const msg=(feedbackMessages.find(m=> m.id===feedbackId) ||{}).text || '';if (ui.feedbackMessage) ui.feedbackMessage.textContent=msg;}catch (e){}}function animateKPINumber(id,newValue){const el=document.getElementById(id);if (!el) return;const last=typeof el._lastValue==='number' ? el._lastValue : (parseFloat((el.textContent || '0').replace(/[\D]/g,'').replace(',','.')) || 0);const duration=700;const frameRate=30;const steps=Math.max(1,Math.round(duration / (1000 / frameRate)));let step=0;const diff=newValue - last;if (diff > 0){el.classList.add('kpi-animate-up');}else if (diff < 0){el.classList.add('kpi-animate-down');}else{el.classList.add('kpi-animate');}const animate=()=>{step++;const val=last + diff * (step / steps);el.textContent=formatCurrency(val);if (step < steps){setTimeout(animate,1000 / frameRate);}else{el.textContent=formatCurrency(newValue);el._lastValue=newValue;el.classList.remove('kpi-animate');el.classList.remove('kpi-animate-up');el.classList.remove('kpi-animate-down');}};animate();}function destroyChart(chartId){if (ui.charts && ui.charts[chartId]){try{ui.charts[chartId].destroy();}catch(e){/* ignore */}delete ui.charts[chartId];}}function renderCharts(){if (typeof Chart==='undefined') return;renderCategorySpendingChart();renderPaymentMethodChart();renderAnnualSummaryChart();}function renderCategorySpendingChart(){try{destroyChart('category-spending-chart');const monthData=getCurrentMonthData();const expenses=monthData.expenses || [];const categorySpending=expenses.reduce((acc,exp)=>{acc[exp.category]=(acc[exp.category] || 0) + (exp.amount || 0);return acc;},{});const ctx=document.getElementById('category-spending-chart');if (!ctx) return;ui.charts['category-spending-chart']=new Chart(ctx.getContext('2d'),{type:'pie',data:{labels:Object.keys(categorySpending),datasets:[{data:Object.values(categorySpending),backgroundColor:['#EF4444','#F97316','#84CC16','#22C55E','#14B8A6','#06B6D4','#6366F1','#D946EF']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});}catch(e){console.error('renderCategorySpendingChart',e)}}function renderPaymentMethodChart(){try{destroyChart('payment-method-chart');const monthData=getCurrentMonthData();const expenses=monthData.expenses || [];const paymentSpending=expenses.reduce((acc,exp)=>{const k=(typeof getPaymentLabel==='function') ? getPaymentLabel(exp.payment || '') : (exp.payment || '');acc[k]=(acc[k] || 0) + (exp.amount || 0);return acc;},{});const ctx=document.getElementById('payment-method-chart');if (!ctx) return;ui.charts['payment-method-chart']=new Chart(ctx.getContext('2d'),{type:'pie',data:{labels:Object.keys(paymentSpending),datasets:[{data:Object.values(paymentSpending),backgroundColor:['#6D28D9','#BE185D','#047857','#B45309','#1E3A8A']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});}catch(e){console.error('renderPaymentMethodChart',e)}}function invoiceAwareOutcomeForMonth(year,month,monthData){try{const expenses=(monthData && monthData.expenses) || [];const savingsSum=(monthData && monthData.savings || []).reduce((s,t)=>s+(t.amount||0),0);const paymentMethods=(state.appData.settings && state.appData.settings.paymentMethods) || [];const cardMethods=paymentMethods.filter(p=> p.type==='credit_card');const nonCardExpensesSum=expenses.filter(e=> !cardMethods.some(c=> paymentMatches(e.payment || '',c.name))).reduce((s,t)=>s+(t.amount||0),0);const cardAnticipations=(state.appData.data[year] && state.appData.data[year][month] && state.appData.data[year][month].cardAnticipations) ||{};let totalInvoices=0;cardMethods.forEach(card=>{const cardExpenses=expenses.filter(e=> paymentMatches(e.payment || '',card.name));const totalBeforeAnticipation=cardExpenses.reduce((s,t)=>s+(t.amount||0),0);const anticipated=Number(cardAnticipations[card.name] || 0);const invoiceTotal=Math.round(((totalBeforeAnticipation - anticipated) + Number.EPSILON) * 100) / 100;totalInvoices +=invoiceTotal;});return nonCardExpensesSum + totalInvoices + savingsSum;}catch(e){console.error('invoiceAwareOutcomeForMonth',e);return ((monthData.expenses||[]).reduce((s,t)=>s+(t.amount||0),0)) + ((monthData.savings||[]).reduce((s,t)=>s+(t.amount||0),0));}}function renderAnnualSummaryChart(){try{const year=state.currentDate.getFullYear();destroyChart('annual-summary-chart');const yearData=state.appData.data[state.currentDate.getFullYear()] ||{};const months=Array.from({length:12},(_,i)=>String(i+1).padStart(2,'0'));const monthlyTotals={incomes: [],expenses: [],balance: []};months.forEach(month=>{const monthData=yearData[month] ||{};const income=(monthData.incomes || []).reduce((s,t)=>s+(t.amount||0),0);const expense=invoiceAwareOutcomeForMonth(year,month,monthData);monthlyTotals.incomes.push(income);monthlyTotals.expenses.push(expense);monthlyTotals.balance.push(income-expense);});const ctx=document.getElementById('annual-summary-chart');if (!ctx) return;const asData={labels: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],datasets: [{label: 'Entradas',data: monthlyTotals.incomes,backgroundColor: '#22C55E'},{label: 'Saï¿½ï¿½das',data: monthlyTotals.expenses,backgroundColor: '#EF4444'}]};const asOptions={responsive: true,maintainAspectRatio: false,plugins:{legend:{position: 'bottom',labels:{generateLabels: function(chart){try{const ds=chart.data.datasets || [];return ds.map((d,idx)=>{const sum=(d.data || []).reduce((s,v)=> s + (v || 0),0);return{text: d.label + ' (' + formatCurrency(sum) + ')',fillStyle: d.backgroundColor,hidden: chart.getDatasetMeta(idx).hidden,index: idx};});}catch (e){return Chart.defaults.plugins.legend.labels.generateLabels(chart);}}}}},scales:{x:{stacked: true,grid:{display: false}},y:{stacked: true,ticks:{callback: function(v){return formatCurrency(v);}},beginAtZero: true}},elements:{bar:{borderRadius: 6}},layout:{padding:{top: 6,bottom: 6}}};ui.charts['annual-summary-chart']=new Chart(ctx.getContext('2d'),{type: 'bar',data: asData,options: asOptions});}catch(e){console.error('renderAnnualSummaryChart',e)}}function renderMonthlyReportCategoryChart(){try{destroyChart('mr-category-breakdown-chart');const monthData=getCurrentMonthData();const expenses=monthData.expenses || [];const byCategory=expenses.reduce((acc,e)=>{acc[e.category]=(acc[e.category]||0) + (e.amount||0);return acc;},{});const entries=Object.keys(byCategory).map(k=> ({category: k,value: byCategory[k]}));entries.sort((a,b)=> (b.value||0) - (a.value||0));const labels=entries.map(e=> e.category);const dataVals=entries.map(e=> e.value);const colors=['#EF4444','#F97316','#84CC16','#22C55E','#14B8A6','#06B6D4','#6366F1','#D946EF'];const ctx=document.getElementById('mr-category-breakdown-chart');if (!ctx || labels.length===0 || typeof Chart==='undefined') return;const mrData={labels: labels,datasets: [{data: dataVals,backgroundColor: colors.slice(0,labels.length)}]};const mrOptions={responsive: true,maintainAspectRatio: false,plugins:{legend:{position: 'right',labels:{generateLabels: function(chart){try{const data=chart.data;const ds=(data.datasets && data.datasets[0] && data.datasets[0].data) || [];const total=ds.reduce((s,v)=>s+(v||0),0) || 1;return (data.labels || []).map((lab,i)=>{const val=ds[i] || 0;const pct=Math.round((val/total)*100);return{text: lab + ' (' + pct + '%)',fillStyle: (data.datasets[0].backgroundColor||[])[i],hidden: chart.getDataVisibility(i)===false,index: i};});}catch (e){return Chart.defaults.plugins.legend.labels.generateLabels(chart);}}}}}};ui.charts['mr-category-breakdown-chart']=new Chart(ctx.getContext('2d'),{type: 'pie',data: mrData,options: mrOptions});}catch(e){console.error('renderMonthlyReportCategoryChart',e)}}function renderAnnualBalanceEvolutionChart(){try{destroyChart('ar-balance-evolution-chart');const year=state.currentDate.getFullYear();const yearData=state.appData.data[year] ||{};const months=Array.from({length:12},(_,i)=>String(i+1).padStart(2,'0'));const balances=months.map(m=>{const md=yearData[m] ||{incomes: [],expenses: [],savings: []};const inc=(md.incomes || []).reduce((s,t)=>s+(t.amount||0),0);const out=invoiceAwareOutcomeForMonth(year,m,md);return inc - out;});const ctx=document.getElementById('ar-balance-evolution-chart');if (!ctx || typeof Chart==='undefined') return;const arData={labels: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],datasets: [{label: 'Saldo Mensal',data: balances,borderColor: '#2563EB',tension: 0.2,pointRadius: 3,pointHoverRadius: 6}]};const arOptions={responsive: true,maintainAspectRatio: false,plugins:{legend:{position: 'bottom',labels:{generateLabels: function(chart){try{const d=chart.data.datasets && chart.data.datasets[0];const last=(d && d.data && d.data.length) ? d.data[d.data.length-1] : 0;return [{text: d.label + ' (ï¿½ltimo: ' + formatCurrency(last) + ')',fillStyle: d.borderColor,hidden: chart.getDatasetMeta(0).hidden,index: 0}];}catch(e){return Chart.defaults.plugins.legend.labels.generateLabels(chart);}}}}},scales:{y:{ticks:{callback: function(v){return formatCurrency(v);}}},x:{ticks:{maxRotation: 0,autoSkip: true}}},elements:{line:{tension: 0.2}},layout:{padding:{top: 8,bottom: 6}}};ui.charts['ar-balance-evolution-chart']=new Chart(ctx.getContext('2d'),{type: 'line',data: arData,options: arOptions});}catch(e){console.error('renderAnnualBalanceEvolutionChart',e)}}function renderAnnualAvgCategoryChart(){try{destroyChart('ar-avg-category-spending-chart');const year=state.currentDate.getFullYear();const yearData=state.appData.data[year] ||{};const categories={};const months=Object.keys(yearData);months.forEach(m=>{const md=yearData[m] ||{expenses: []};(md.expenses || []).forEach(e=>{categories[e.category]=(categories[e.category]||0) + (e.amount||0);});});const avg={};months.forEach(()=>{});Object.keys(categories).forEach(cat=>{avg[cat]=categories[cat] / Math.max(1,months.length);});const ctx=document.getElementById('ar-avg-category-spending-chart');if (!ctx || Object.keys(avg).length===0 || typeof Chart==='undefined') return;const acData={labels: Object.keys(avg),datasets: [{label: 'mï¿½dia Mensal',data: Object.values(avg),backgroundColor: '#F59E0B'}]};const acOptions={responsive: true,maintainAspectRatio: false,plugins:{legend:{position: 'bottom',labels:{generateLabels: function(chart){try{const d=chart.data.datasets && chart.data.datasets[0];const sum=(d && d.data) ? d.data.reduce((s,v)=>s+(v||0),0) : 0;return [{text: d.label + ' (' + formatCurrency(sum) + ')',fillStyle: d.backgroundColor,hidden: chart.getDatasetMeta(0).hidden,index: 0}];}catch(e){return Chart.defaults.plugins.legend.labels.generateLabels(chart);}}}}},scales:{y:{ticks:{callback: function(v){return formatCurrency(v);}},beginAtZero: true},x:{ticks:{autoSkip: true}}},layout:{padding:{top: 6,bottom: 6}}};ui.charts['ar-avg-category-spending-chart']=new Chart(ctx.getContext('2d'),{type: 'bar',data: acData,options: acOptions});}catch(e){console.error('renderAnnualAvgCategoryChart',e)}}function renderMonthDisplay(){ui.currentMonthDisplay.textContent=state.currentDate.toLocaleString('pt-BR',{month: 'long',year: 'numeric'}).replace(/^\w/,c=> c.toUpperCase());}function populateMonthPicker(){try{const yearSelect=ui.monthPickerYear;if (!yearSelect) return;yearSelect.innerHTML='';const currentYear=state.currentDate.getFullYear();for (let y=currentYear - 5;y <=currentYear + 5;y++){const opt=document.createElement('option');opt.value=y;opt.textContent=y;yearSelect.appendChild(opt);}if (ui.monthPickerMonth) ui.monthPickerMonth.value=String(state.currentDate.getMonth());yearSelect.value=String(currentYear);}catch (e){console.error('populateMonthPicker',e);}}(function(){let _originalParent=null;let _originalNext=null;window.__monthPickerDetached=false;function _attachToBody(picker,trigger){if (!picker) return;if (!_originalParent){_originalParent=picker.parentNode;_originalNext=picker.nextSibling;}document.body.appendChild(picker);if (window.innerWidth <=639){picker.style.position='fixed';picker.style.left='50%';picker.style.top='18%';picker.style.transform='translateX(-50%)';picker.style.width='calc(100% - 2rem)';picker.style.maxWidth='360px';picker.style.right='';}else{picker.style.position='absolute';try{const rect=trigger.getBoundingClientRect();const top=rect.bottom + window.scrollY + 8;const right=window.innerWidth - (rect.right + window.scrollX);picker.style.top=top + 'px';picker.style.right=right + 'px';picker.style.transform='';}catch (e){/* ignore */}}window.__monthPickerDetached=true;}function _restoreParent(picker){if (!picker || !_originalParent) return;picker.style.position='';picker.style.top='';picker.style.right='';picker.style.zIndex='';if (_originalNext && _originalNext.parentNode===_originalParent){_originalParent.insertBefore(picker,_originalNext);}else{_originalParent.appendChild(picker);}_originalParent=null;_originalNext=null;window.__monthPickerDetached=false;}window.openMonthPicker=function(){try{const picker=ui.monthPicker;if (!picker || !ui.currentMonthDisplay) return;populateMonthPicker();_attachToBody(picker,ui.currentMonthDisplay);picker.classList.remove('hidden');if (ui.monthPickerMonth) ui.monthPickerMonth.focus();}catch (e){console.error('openMonthPicker',e);}};window.closeMonthPicker=function(){try{const picker=ui.monthPicker;if (!picker) return;picker.classList.add('hidden');if (window.__monthPickerDetached) _restoreParent(picker);}catch (e){console.error('closeMonthPicker',e);}};})();function closeMonthPicker(){try{if (ui.monthPicker) ui.monthPicker.classList.add('hidden');}catch (e){console.error('closeMonthPicker',e);}}function applyMonthPicker(){try{if (!ui.monthPickerMonth || !ui.monthPickerYear) return;const month=parseInt(ui.monthPickerMonth.value,10);const year=parseInt(ui.monthPickerYear.value,10);if (isNaN(month) || isNaN(year)) return;state.currentDate=new Date(year,month,1);render();closeMonthPicker();}catch (e){console.error('applyMonthPicker',e);}}function updateSortHeaders(){ui.expensesTableHead.querySelectorAll('.sortable-header').forEach(header=>{const icon=header.querySelector('.sort-icon');if (!icon) return;if (header.dataset.sort===state.sort.key){header.classList.add('sorted');icon.textContent=state.sort.order==='asc' ? 'arrow_upward' : 'arrow_downward';}else{header.classList.remove('sorted');icon.textContent='';}});}function goToDate(date){state.currentDate=new Date(date.getFullYear(),date.getMonth(),1);render();}function changeMonth(direction){state.currentDate.setMonth(state.currentDate.getMonth() + direction);render();}function goToLastInstallment({financingId=null,installmentId=null}={}){try{let last=null;Object.keys(state.appData.data).forEach(year=>{Object.keys(state.appData.data[year]).forEach(month=>{const monthData=state.appData.data[year][month];const expenses=monthData.expenses || [];expenses.forEach(exp=>{if (financingId && exp.financingId===financingId){const candidate={year: Number(year),month: Number(month)};if (!last || candidate.year > last.year || (candidate.year===last.year && candidate.month > last.month)){last={year: candidate.year,month: candidate.month,id: exp.id};}}else if (installmentId && exp.installmentId===installmentId){const candidate={year: Number(year),month: Number(month)};if (!last || candidate.year > last.year || (candidate.year===last.year && candidate.month > last.month)){last={year: candidate.year,month: candidate.month,id: exp.id};}}});});});if (!last) return;const target=new Date(last.year,last.month - 1,1);goToDate(target);const row=ui.expensesTableBody.querySelector(`tr[data-id="${last.id}"]`);if (row){row.classList.add('ring-2','ring-blue-300');window.scrollTo({top: 0,behavior: 'auto'});}}catch (e){}}function getCurrentMonthData(date=state.currentDate){const year=date.getFullYear();const month=String(date.getMonth() + 1).padStart(2,'0');if (!state.appData.data[year]){state.appData.data[year]={};}if (!state.appData.data[year][month]){state.appData.data[year][month]={incomes: [],expenses: [],savings: []};}return state.appData.data[year][month];}function handleSort(key){if (state.sort.key===key){state.sort.order=state.sort.order==='asc' ? 'desc' : 'asc';}else{state.sort.key=key;state.sort.order='asc';}renderExpenseTable();}function handleTableClick(event,type){const row=event.target.closest('tr');if (!row) return;const id=row.dataset.id;if (event.target.closest('.edit-btn') && !event.target.closest('.edit-btn').disabled){openModal(type,id);}else if (event.target.closest('.delete-btn')){deleteTransaction(type,id);}else if (event.target.classList.contains('paid-checkbox')){togglePaidStatus(id,type);}}async function togglePaidStatus(id,type='expenses'){if (type==='expenses'){const expense=getCurrentMonthData().expenses.find(exp=> exp.id===id);if (expense){expense.isPaid=!expense.isPaid;try{await storage.saveData(state.appData);}catch (e){showToast('Falha ao atualizar status no Firebase.','bg-red-600');}render();}}else if (type==='incomes'){const monthData=getCurrentMonthData();let income=monthData.incomes.find(inc=> inc.id===id);if (income){income.isPaid=!income.isPaid;try{await storage.saveData(state.appData);}catch (e){showToast('Falha ao atualizar status no Firebase.','bg-red-600');}render();return;}let vrEntry=(monthData.vrLedger || []).find(v=> v.id===id);if (vrEntry){vrEntry.isPaid=!vrEntry.isPaid;try{await storage.saveData(state.appData);}catch (e){showToast('Falha ao atualizar status no Firebase.','bg-red-600');}render();return;}let vtEntry=(monthData.vtLedger || []).find(v=> v.id===id);if (vtEntry){vtEntry.isPaid=!vtEntry.isPaid;try{await storage.saveData(state.appData);}catch (e){showToast('Falha ao atualizar status no Firebase.','bg-red-600');}render();}}}function openModal(type,id=null,prefill=null){try{const modal=ui.transactionModal;if (!modal) return;if (ui.transactionForm) ui.transactionForm.reset();clearTransactionError();if (document.getElementById('transaction-id')) document.getElementById('transaction-id').value='';populateDropdowns();toggleTransactionType(type || 'expenses');if (id){document.getElementById('modal-title').textContent='Editar transaï¿½ï¿½o';populateModal(type,id);}else{document.getElementById('modal-title').textContent='Nova transaï¿½ï¿½o';if (!prefill) prepareModalForNextEntry();}modal.showModal();try{if (prefill && typeof prefill==='object'){const pm=document.getElementById('payment-method');const desc=document.getElementById('description');const cat=document.getElementById('category-expense');if (pm && prefill.payment){pm.value=prefill.payment;try{pm.dispatchEvent(new Event('change',{bubbles: true}));}catch (e){try{pm.dispatchEvent(new Event('change'));}catch(e){}}}if (cat && prefill.category){try{cat.value=prefill.category;}catch(e){}}if ((prefill.payment==='VT') && desc && (prefill.description===undefined || prefill.description===null || prefill.description==='')){try{desc.value='Abastecimento';}catch(e){}}else if (desc && (prefill.description !==undefined)){desc.value=prefill.description;}if (prefill.amount !==undefined){const amt=document.getElementById('amount');if (amt) amt.value=prefill.amount;}if (prefill.recipient){const r=document.getElementById('payment-recipient');if (r) r.value=prefill.recipient;}if (desc && (prefill.focusDescription || prefill.description !==undefined)){try{desc.focus();desc.select();}catch (_){}}}}catch (e){console.error('openModal apply prefill',e);}try{const descInput=document.getElementById('description');if (descInput){const ev=new Event('input',{bubbles: true});descInput.dispatchEvent(ev);}}catch (e){console.error('openModal run description detector',e);}}catch (e){console.error('openModal',e);}}function closeModal(modalId){try{const el=document.getElementById(modalId);if (el && typeof el.close==='function') el.close();clearTransactionError();const btn=document.getElementById('conclude-financing-btn');if (btn && btn.parentNode) btn.parentNode.removeChild(btn);}catch (e){console.error('closeModal',e);}}function populateDropdowns(){try{const settings=state.appData.settings ||{};const paymentMethods=settings.paymentMethods || [];const md=getCurrentMonthData();const vrAmount=md ? getMonthVRBalance(md) : 0;const vrOptionObj={name: 'VR',type: 'vr',available: vrAmount};const mergedPayments=(paymentMethods || []).slice();if (!mergedPayments.find(p=> (p && p.name)==='VR')) mergedPayments.push(vrOptionObj);const vtAmount=md ? getMonthVTBalance(md) : 0;const vtOptionObj={name: 'VT',type: 'vt',available: vtAmount};if (!mergedPayments.find(p=> (p && p.name)==='VT')) mergedPayments.push(vtOptionObj);const expenseCategories=settings.expenseCategories || [];const savingCategories=settings.savingCategories || [];const goals=settings.goals || [];const normalize=s=> (s || '').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');const hasAlim=expenseCategories.some(c=> normalize(c).includes('aliment'));if (!hasAlim){try{settings.expenseCategories=settings.expenseCategories || [];settings.expenseCategories.push('Alimentaï¿½ï¿½o');state.appData.settings=settings;storage.saveData(state.appData).then(()=>{showToast('Categoria Alimentaï¿½ï¿½o adicionada ï¿½ï¿½s configurAï¿½ï¿½ES.','bg-green-600');}).catch(()=>{});}catch (e){console.error('failed to persist alimentaï¿½ï¿½o category',e);}}const paymentsSorted=sortStrings((mergedPayments || []).map(p=> p.name || ''));const expenseCatsSorted=sortStrings(expenseCategories || []);const savingCatsSorted=sortStrings(savingCategories || []);const goalsSorted=sortStrings(goals.map(g=> g.name || ''));if (ui.paymentMethod){ui.paymentMethod.innerHTML=paymentsSorted.map(n=> `<option value="${n}">${n}</option>`).join('');try{if (typeof ui.paymentMethod._refreshIconSelect==='function') ui.paymentMethod._refreshIconSelect();}catch(e){}try{if (window.toggleRecipientForPayment) window.toggleRecipientForPayment(ui.paymentMethod.value);}catch(e){}}if (ui.categoryExpense) ui.categoryExpense.innerHTML=expenseCatsSorted.map(c=> `<option value="${c}">${c}</option>`).join('');if (ui.categorySaving){let savingOptions=savingCatsSorted.map(c=> `<option value="${c}">${c}</option>`);if (goalsSorted.length) savingOptions=savingOptions.concat(goalsSorted.map(g=> `<option value="${g}">${g}(Meta)</option>`));ui.categorySaving.innerHTML=savingOptions.join('');}try{if (ui.categoryExpense && typeof ui.categoryExpense._refreshIconSelect==='function') ui.categoryExpense._refreshIconSelect();}catch(e){}try{if (ui.categorySaving && typeof ui.categorySaving._refreshIconSelect==='function') ui.categorySaving._refreshIconSelect();}catch(e){}try{const fpm=document.getElementById('filter-payment-method');if (fpm && typeof fpm._refreshIconSelect==='function') fpm._refreshIconSelect();}catch(e){}try{const fcat=document.getElementById('filter-category');if (fcat && typeof fcat._refreshIconSelect==='function') fcat._refreshIconSelect();}catch(e){}}catch (e){console.error('populateDropdowns',e);}}function toggleTransactionType(type){try{if (!ui.transactionTypeInput) return;ui.transactionTypeInput.value=type;if (ui.modalTypeToggles) ui.modalTypeToggles.forEach(btn=> btn.classList.toggle('tab-active',btn.dataset.type===type));if (ui.expenseFields){ui.expenseFields.classList.toggle('hidden',type !=='expenses');ui.expenseFields.classList.toggle('section-hidden-smooth',type !=='expenses');}if (ui.savingFields){ui.savingFields.classList.toggle('hidden',type !=='savings');ui.savingFields.classList.toggle('section-hidden-smooth',type !=='savings');}const salarySection=document.getElementById('salary-section');const isSalaryCheckbox=document.getElementById('is-salary');const salaryFields=document.getElementById('salary-fields');if (salarySection) salarySection.classList.toggle('hidden',type !=='incomes');if (type !=='incomes' && isSalaryCheckbox){isSalaryCheckbox.checked=false;if (salaryFields) salaryFields.classList.add('hidden');try{const modal=document.getElementById('transaction-modal');if (modal) modal.classList.remove('modal-expanded');}catch(e){}}if (type==='incomes' && isSalaryCheckbox && isSalaryCheckbox.checked){try{const modal=document.getElementById('transaction-modal');if (modal) modal.classList.add('modal-expanded');}catch(e){}}if (ui.advancedOptions) ui.advancedOptions.classList.remove('hidden');if (ui.installmentsSection) ui.installmentsSection.classList.toggle('hidden',type !=='expenses');if (ui.financingSection) ui.financingSection.classList.toggle('hidden',type !=='expenses');}catch (e){console.error('toggleTransactionType',e);}}function openSalaryBreakdown(income){try{const modal=document.getElementById('salary-breakdown-modal');const contentEl=document.getElementById('salary-breakdown-content');const titleEl=document.getElementById('salary-breakdown-title');if (!modal || !contentEl || !titleEl) return;const year=state.currentDate.getFullYear();const month=state.currentDate.getMonth() + 1;const md=getCurrentMonthData();let meta=null;try{const combined=[];if (Array.isArray(md.incomes)) combined.push(...md.incomes);if (Array.isArray(md.vrLedger)) combined.push(...md.vrLedger);if (Array.isArray(md.vtLedger)) combined.push(...md.vtLedger);const found=combined.slice().reverse().find(x=> x && x.salaryMeta);if (found) meta=found.salaryMeta;}catch (e){/* ignore search errors */}if (!meta && income && income.salaryMeta) meta=income.salaryMeta;if (!meta) meta={};function parseHoursRaw(v){if (v===undefined || v===null || v==='') return undefined;if (typeof v==='number') return v;const s=String(v).trim();const m=/^\s*(\d{1,3}):([0-5]?\d)\s*$/.exec(s);if (m){const hh=parseInt(m[1],10);const mm=parseInt(m[2],10);return hh + (mm / 60);}const dec=parseFloat(s.replace(/,/g,'.'));if (!isNaN(dec)) return dec;return undefined;}const parsedHours=parseHoursRaw(meta.hoursTrabalhadas || meta.horasTrabalhadas || meta.hoursWorked || meta.hours || '');const params={salarioBase: Number(meta.salarioBase || income.amount || 0),percentualPericulosidade: Number(meta.percentualPericulosidade || 0),outrosProventosTributaveis: Number(meta.outrosProventosTributaveis || 0),numeroDependentes: Number(meta.numeroDependentes || 0),valorDesjejumDia: Number(meta.valorDesjejumDia || 0),valorTransporteDia: Number(meta.valorTransporteDia || 0),diasTrabalhados: (typeof meta.diasTrabalhados !=='undefined') ? Number(meta.diasTrabalhados) : undefined,horasExtrasSabado: Number(meta.horasExtrasSabado || 0),horasExtrasDomingo: Number(meta.horasExtrasDomingo || 0),jornadaMensalHoras: Number(meta.jornadaMensalHoras || 220),hoursTrabalhadas: parsedHours,year,month};const calc=calcularSalarioLiquido(params);try{window.salaryCalcCache=window.salaryCalcCache ||{};if (income && income.id) window.salaryCalcCache[income.id]=calc;}catch(e){}const resumo=calc.resumo ||{};const detalhe=calc.detalhe ||{};try{const _d=state.currentDate || new Date();const monthNamesAbbrev=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];const monthLabel=`${monthNamesAbbrev[_d.getMonth()]}${_d.getFullYear()}`;titleEl.innerHTML=`${income.description || 'Salï¿½ï¿½rio'}â€” <span id="salary-breakdown-month-label">${monthLabel}</span>`;let navWrap=document.getElementById('salary-breakdown-nav-wrap');if (!navWrap){navWrap=document.createElement('span');navWrap.id='salary-breakdown-nav-wrap';navWrap.className='ml-3 inline-flex items-center';titleEl.appendChild(navWrap);}let leftBtn=document.getElementById('salary-breakdown-prev');let todayBtn=document.getElementById('salary-breakdown-today');let rightBtn=document.getElementById('salary-breakdown-next');if (!leftBtn){leftBtn=document.createElement('button');leftBtn.id='salary-breakdown-prev';leftBtn.className='p-1.5 rounded-full ';leftBtn.title='Mï¿½s anterior';leftBtn.innerHTML='<span class="material-symbols-outlined">chevron_left</span>';navWrap.appendChild(leftBtn);}if (!todayBtn){todayBtn=document.createElement('button');todayBtn.id='salary-breakdown-today';todayBtn.className='p-1.5 rounded-full mx-1';todayBtn.title='Voltar para o Mï¿½s atual';todayBtn.innerHTML='<span class="material-symbols-outlined">today</span>';navWrap.appendChild(todayBtn);}if (!rightBtn){rightBtn=document.createElement('button');rightBtn.id='salary-breakdown-next';rightBtn.className='p-1.5 rounded-full ';rightBtn.title='prï¿½ximo Mï¿½s';rightBtn.innerHTML='<span class="material-symbols-outlined">chevron_right</span>';navWrap.appendChild(rightBtn);}const refreshModalForCurrentMonth=()=>{try{const yearNow=state.currentDate.getFullYear();const monthNow=state.currentDate.getMonth() + 1;const lbl=document.getElementById('salary-breakdown-month-label');if (lbl) lbl.textContent=state.currentDate.toLocaleString('pt-BR',{month: 'long',year: 'numeric'});const parsedHoursNow=parseHoursRaw(meta.hoursTrabalhadas || meta.horasTrabalhadas || meta.hoursWorked || meta.hours || '');const paramsNow=Object.assign({},params,{year: yearNow,month: monthNow,hoursTrabalhadas: parsedHoursNow});const newCalc=calcularSalarioLiquido(paramsNow);contentEl.innerHTML='';openSalaryBreakdown(income);}catch (e){console.error('refreshModalForCurrentMonth',e);}};leftBtn.onclick=(ev)=>{ev.preventDefault();changeMonth(-1);refreshModalForCurrentMonth();};rightBtn.onclick=(ev)=>{ev.preventDefault();changeMonth(1);refreshModalForCurrentMonth();};todayBtn.onclick=(ev)=>{ev.preventDefault();const now=new Date();state.currentDate=new Date(now.getFullYear(),now.getMonth(),1);refreshModalForCurrentMonth();};}catch(e){console.error('build modal title with nav',e);}const roundLocal=(v)=> Math.round((Number(v) + Number.EPSILON) * 100) / 100;const findVREntry=(Array.isArray(md.vrLedger) ? md.vrLedger.find(l=> l && l.salaryMeta && JSON.stringify(l.salaryMeta)===JSON.stringify(meta)) : null) || (Array.isArray(md.vrLedger) ? md.vrLedger.find(l=> l && (l.description || '').toLowerCase().includes('benefï¿½ï¿½cio') && (l.description || '').toLowerCase().includes('vr')) : null);const findVTEntry=(Array.isArray(md.vtLedger) ? md.vtLedger.find(l=> l && l.salaryMeta && JSON.stringify(l.salaryMeta)===JSON.stringify(meta)) : null) || (Array.isArray(md.vtLedger) ? md.vtLedger.find(l=> l && (l.description || '').toLowerCase().includes('benefï¿½ï¿½cio') && (l.description || '').toLowerCase().includes('vt')) : null);const benDiasBase=diasUteisNoMes(year,month) + 1;const vrPerDay=Number(detalhe.beneficios && detalhe.beneficios.valorDesjejumDia || params.valorDesjejumDia || 0);const vtPerDay=Number(detalhe.beneficios && detalhe.beneficios.valorTransporteDia || params.valorTransporteDia || 0);const vrDefault=Math.round((vrPerDay * benDiasBase + Number.EPSILON) * 100) / 100;const vtDefault=Math.round((vtPerDay * benDiasBase + Number.EPSILON) * 100) / 100;const vrEdited=!!findVREntry && roundLocal(Number(findVREntry.amount || 0)) !==roundLocal(vrDefault);const vtEdited=!!findVTEntry && roundLocal(Number(findVTEntry.amount || 0)) !==roundLocal(vtDefault);const showDaysIcon=vrEdited || vtEdited;const pencilSvg='<svg class="inline-block ml-1" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http: const vrIconHtml=vrEdited ? pencilSvg : '';const vtIconHtml=vtEdited ? pencilSvg : '';const daysIconHtml=showDaysIcon ? pencilSvg : '';let html='';html +=`<div class="grid grid-cols-1 md:grid-cols-2 gap-3">`;html +=`<div class="p-3 bg-white rounded shadow-sm">`;html +=`<h4 class="font-semibold mb-2">Resumo</h4>`;html +=`<div class="mb-1"><strong>Salï¿½ï¿½rio base:</strong> ${formatCurrency(Number(params.salarioBase) || 0)}</div>`;if (typeof params.hoursTrabalhadas !=='undefined'){const hh=Math.floor(params.hoursTrabalhadas);const mm=Math.round((params.hoursTrabalhadas - hh) * 60);const mmPadded=String(mm).padStart(2,'0');html +=`<div class="mb-1 text-sm text-gray-600">Horas consideradas: ${params.hoursTrabalhadas.toFixed(2)}h (${hh}:${mmPadded})</div>`;}const perc=Number(params.percentualPericulosidade || 0);if (perc && perc > 0){try{const percVal=roundLocal((Number(params.salarioBase || 0) * perc) / 100);html +=`<div class="mb-1"><strong>Periculosidade (${perc}%):</strong> ${formatCurrency(percVal)}</div>`;}catch(e){/* ignore periculosidade render errors */}}html +=`<div class="mb-1"><strong>Salï¿½ï¿½rio bruto tribuTï¿½ï¿½vel:</strong> ${formatCurrency(Number(resumo.salarioBrutoTributavel || 0))}</div>`;const inssTotal=Number(detalhe.descontos && detalhe.descontos.inssTotal || detalhe.inssTotal || 0);const inssPercent=resumo.salarioBrutoTributavel ? ((inssTotal / Number(resumo.salarioBrutoTributavel)) * 100) : 0;html +=`<div class="mb-1"><strong>INSS (total):</strong> ${formatCurrency(inssTotal)}(${inssPercent.toFixed(2)}%)</div>`;const irrfValue=Number(detalhe.descontos && detalhe.descontos.irrfValue || detalhe.irrfValue || 0);html +=`<div class="mb-1"><strong>IRRF:</strong> ${formatCurrency(irrfValue)}</div>`;html +=`<div class="mb-1"><strong>Total descontos:</strong> ${formatCurrency(Number(resumo.totalDescontos || 0))}</div>`;html +=`<div class="mb-2"><strong>Salï¿½ï¿½rio lï¿½ï¿½quido:</strong> <span class="text-indigo-600 font-semibold">${formatCurrency(Number(resumo.salarioLiquido || 0))}</span></div>`;html +=`<div class="mb-1"><strong>Benefï¿½ï¿½cios (total):</strong> ${formatCurrency(Number(resumo.beneficiosTotais || 0))}</div>`;html +=`<div class="mb-1"><strong>Remuneraï¿½ï¿½o total:</strong> ${formatCurrency(Number(resumo.remuneracaoTotal || 0))}</div>`;html +=`<div class="mt-2 text-xs text-gray-500">FGTS (8% sobre o bruto tribuTï¿½ï¿½vel): ${formatCurrency(Number(detalhe.encargos && detalhe.encargos.fgts || 0))}</div>`;html +=`</div>`;html +=`<div class="space-y-3">`;html +=`<div class="p-3 bg-white rounded shadow-sm">`;html +=`<h4 class="font-semibold mb-2">Benefï¿½ï¿½cio VR (Desjejum)</h4>`;html +=`<div class="mb-1">Valor por dia: ${formatCurrency(vrPerDay)}</div>`;html +=`<div class="mb-1">Dias considerados: <span id="salary-days" class="text-indigo-600 cursor-pointer inline-block ml-2">${benDiasBase}${daysIconHtml ? ' ' + daysIconHtml : ''}</span></div>`;html +=`<div class="mb-1"><label class="text-sm text-gray-600 inline">Total VR:</label> <span id="salary-vr-total" class="font-semibold text-indigo-600 cursor-pointer inline-block ml-2">${formatCurrency(vrDefault)}${vrIconHtml ? ' ' + vrIconHtml : ''}</span></div>`;html +=`</div>`;html +=`<div class="p-3 bg-white rounded shadow-sm">`;html +=`<h4 class="font-semibold mb-2">Benefï¿½ï¿½cio VT (Transporte)</h4>`;html +=`<div class="mb-1">Valor por dia: ${formatCurrency(vtPerDay)}</div>`;html +=`<div class="mb-1">Dias considerados: <span class="salary-days-display text-indigo-600 cursor-pointer inline-block ml-2">${benDiasBase}${daysIconHtml ? ' ' + daysIconHtml : ''}</span></div>`;html +=`<div class="mb-1"><label class="text-sm text-gray-600 inline">Total VT:</label> <span id="salary-vt-total" class="font-semibold text-indigo-600 cursor-pointer inline-block ml-2">${formatCurrency(vtDefault)}${vtIconHtml ? ' ' + vtIconHtml : ''}</span></div>`;html +=`</div>`;html +=`<div class="p-3 bg-white rounded shadow-sm">`;html +=`<h4 class="font-semibold mb-2">Benefï¿½ï¿½cios - Total</h4>`;html +=`<div class="mb-1 font-semibold">VR + VT=<span id="salary-benefits-total">${formatCurrency(Math.round((vrDefault + vtDefault) * 100) / 100)}</span></div>`;html +=`</div>`;html +=`</div>`;html +=`</div>`;contentEl.innerHTML=html;try{const vrEl=document.getElementById('salary-vr-total');const vtEl=document.getElementById('salary-vt-total');const daysEl=document.getElementById('salary-days');const benefitsTotalEl=document.getElementById('salary-benefits-total');const roundMoney=(v)=> Math.round((Number(v) + Number.EPSILON) * 100) / 100;const getNumericFromSpan=(el,fallback)=>{if (!el) return fallback || 0;const txt=(el.textContent || '').replace(/[R$\s\.]/g,'').replace(',','.');const n=parseFloat(txt);return isNaN(n) ? (fallback || 0) : n;};const setSpanCurrency=(el,value)=>{if (!el) return;el.textContent=formatCurrency(roundMoney(value));};const setDaysDisplay=(v)=>{const els=document.querySelectorAll('.salary-days-display');els.forEach(e=>{e.textContent=String(v);});if (daysEl) daysEl.textContent=String(v);};const recalcBenefitsTotal=()=>{const vr=getNumericFromSpan(vrEl,vrDefault);const vt=getNumericFromSpan(vtEl,vtDefault);if (benefitsTotalEl) benefitsTotalEl.textContent=formatCurrency(roundMoney(vr + vt));};const upsertLedger=async (typeName,amount)=>{try{const mdNow=getCurrentMonthData();if (!mdNow) return;if (typeName==='VR'){if (!Array.isArray(mdNow.vrLedger)) mdNow.vrLedger=[];let entry=mdNow.vrLedger.find(l=> l && l.salaryMeta && JSON.stringify(l.salaryMeta)===JSON.stringify(meta));if (!entry) entry=mdNow.vrLedger.find(l=> l && (l.description || '').toLowerCase().includes('benefï¿½ï¿½cio') && (l.description || '').toLowerCase().includes('vr'));if (entry) entry.amount=roundMoney(amount);else mdNow.vrLedger.push({id: generateUUID(),description: 'Benefï¿½ï¿½cio - VR',amount: roundMoney(amount),recurringId: null,isRecurring: false,salaryMeta: meta || null});}else if (typeName==='VT'){if (!Array.isArray(mdNow.vtLedger)) mdNow.vtLedger=[];let entry=mdNow.vtLedger.find(l=> l && l.salaryMeta && JSON.stringify(l.salaryMeta)===JSON.stringify(meta));if (!entry) entry=mdNow.vtLedger.find(l=> l && (l.description || '').toLowerCase().includes('benefï¿½ï¿½cio') && (l.description || '').toLowerCase().includes('vt'));if (entry) entry.amount=roundMoney(amount);else mdNow.vtLedger.push({id: generateUUID(),description: 'Benefï¿½ï¿½cio - VT',amount: roundMoney(amount),recurringId: null,isRecurring: false,salaryMeta: meta || null});}try{await storage.saveData(state.appData);showToast('Benefï¿½ï¿½cio salvo para o Mï¿½s.','bg-green-600');}catch(e){console.error('save benefit',e);showToast('Falha ao salvar benefï¿½ï¿½cio.','bg-red-600');}render();}catch(e){console.error('upsertLedger',e);}};const makeEditor=(anchorEl,initialValue,onCommit,opts)=>{opts=opts ||{};if (!anchorEl) return;const input=document.createElement('input');input.type=opts.type==='number' ? 'number' : 'text';if (opts.step) input.step=opts.step;input.value=initialValue;input.className='inline-edit-input border px-1 py-0 rounded text-right';input.style.minWidth='80px';const anchorId=anchorEl.id || '';const anchorClass=anchorEl.className || '';const anchorParent=anchorEl.parentNode;anchorEl.replaceWith(input);input.focus();input.select();const commit=async ()=>{let v=input.value;try{if (opts.type==='number') v=parseFloat(String(v).replace(',','.')) || 0;else v=v;}catch(e){/* pass */}let commitResult=null;try{commitResult=await onCommit(v);}catch(e){console.error('onCommit editor',e);}try{const displayText=(opts.type==='number') ? (typeof commitResult==='object' && commitResult.display ? commitResult.display : formatCurrency(Number(v) || 0)) : String(v);const span=document.createElement('span');if (anchorId) span.id=anchorId;span.className=anchorClass;span.style.minWidth=input.style.minWidth;span.textContent=displayText;if (commitResult && commitResult.showIconHtml){const wrap=document.createElement('span');wrap.innerHTML=' ' + commitResult.showIconHtml;if (wrap.firstChild) span.appendChild(wrap.firstChild);}if (anchorParent) anchorParent.replaceChild(span,input);if (opts.onRestore && typeof opts.onRestore==='function'){try{opts.onRestore(span,v,commitResult);}catch(e){console.error('onRestore',e);}}}catch(e){console.error('restore anchor after edit',e);}render();};input.addEventListener('blur',commit);input.addEventListener('keydown',(e)=>{if (e.key==='Enter'){e.preventDefault();input.blur();}if (e.key==='Escape'){render();}});};if (vrEl){const attachVREdit=(el)=>{try{el.addEventListener('click',(ev)=>{ev.preventDefault();const cur=getNumericFromSpan(el,vrDefault);makeEditor(el,String(cur),async (newVal)=>{const num=parseFloat(String(newVal).replace(',','.')) || 0;await upsertLedger('VR',num);return{display: formatCurrency(num),showIconHtml: pencilSvg};},{type: 'number',step: '0.01',onRestore: (span)=>{attachVREdit(span);try{setSpanCurrency(document.getElementById('salary-vr-total'),parseFloat((span.textContent||'').replace(/[R$\s\.]/g,'').replace(',','.'))||0);}catch(e){}recalcBenefitsTotal();}});});}catch(e){console.error('attachVREdit',e);}};attachVREdit(vrEl);}if (vtEl){const attachVTEdit=(el)=>{try{el.addEventListener('click',(ev)=>{ev.preventDefault();const cur=getNumericFromSpan(el,vtDefault);makeEditor(el,String(cur),async (newVal)=>{const num=parseFloat(String(newVal).replace(',','.')) || 0;await upsertLedger('VT',num);return{display: formatCurrency(num),showIconHtml: pencilSvg};},{type: 'number',step: '0.01',onRestore: (span)=>{attachVTEdit(span);try{setSpanCurrency(document.getElementById('salary-vt-total'),parseFloat((span.textContent||'').replace(/[R$\s\.]/g,'').replace(',','.'))||0);}catch(e){}recalcBenefitsTotal();}});});}catch(e){console.error('attachVTEdit',e);}};attachVTEdit(vtEl);}const daysDisplays=[];if (daysEl) daysDisplays.push(daysEl);document.querySelectorAll('.salary-days-display').forEach(d=> daysDisplays.push(d));daysDisplays.forEach(dd=>{try{const attachDaysEdit=(el)=>{el.addEventListener('click',(ev)=>{ev.preventDefault();const cur=parseInt((el.textContent || String(benDiasBase)).replace(/[^0-9\-]/g,''),10) || benDiasBase;makeEditor(el,String(cur),async (newVal)=>{const num=parseInt(String(newVal).replace(/[^0-9\-]/g,''),10) || benDiasBase;const vrPer=vrPerDay || 0;const vtPer=vtPerDay || 0;const newVR=Math.round((vrPer * num + Number.EPSILON) * 100) / 100;const newVT=Math.round((vtPer * num + Number.EPSILON) * 100) / 100;await upsertLedger('VR',newVR);await upsertLedger('VT',newVT);return{display: String(num),showIconHtml: pencilSvg};},{type: 'number',step: '1',onRestore: (span,v,commitResult)=>{attachDaysEdit(span);try{const mdNow=getCurrentMonthData();const vrEntry=(Array.isArray(mdNow.vrLedger) ? mdNow.vrLedger.find(l=> l && l.salaryMeta && JSON.stringify(l.salaryMeta)===JSON.stringify(meta)) : null) || (Array.isArray(mdNow.vrLedger) ? mdNow.vrLedger.find(l=> l && (l.description||'').toLowerCase().includes('vr')) : null);const vtEntry=(Array.isArray(mdNow.vtLedger) ? mdNow.vtLedger.find(l=> l && l.salaryMeta && JSON.stringify(l.salaryMeta)===JSON.stringify(meta)) : null) || (Array.isArray(mdNow.vtLedger) ? mdNow.vtLedger.find(l=> l && (l.description||'').toLowerCase().includes('vt')) : null);if (vrEntry) setSpanCurrency(document.getElementById('salary-vr-total'),Number(vrEntry.amount || 0));if (vtEntry) setSpanCurrency(document.getElementById('salary-vt-total'),Number(vtEntry.amount || 0));}catch(e){console.error('restore days display',e);}recalcBenefitsTotal();}});});};attachDaysEdit(dd);}catch(e){console.error('attach days editor',e);}});recalcBenefitsTotal();}catch (e){console.error('wire salary vr/vt click-to-edit',e);}try{modal.showModal();}catch(e){console.error('openSalaryBreakdown show',e);}}catch (e){console.error('openSalaryBreakdown',e);}}function closeSalaryBreakdown(){try{const m=document.getElementById('salary-breakdown-modal');if (m && typeof m.close==='function') m.close();}catch(e){console.error('closeSalaryBreakdown',e);}}function toggleInstallmentSection(paymentMethodName){try{const method=(state.appData.settings.paymentMethods || []).find(p=> p.name===paymentMethodName);if (ui.installmentsSection) ui.installmentsSection.classList.toggle('hidden',!method || method.type !=='credit_card');if (ui.financingSection && ui.transactionTypeInput && ui.transactionTypeInput.value==='expenses'){ui.financingSection.classList.remove('hidden');const financingCheckbox=document.getElementById('is-financing');if (financingCheckbox){financingCheckbox.addEventListener && financingCheckbox.addEventListener('change',function(){const ff=document.getElementById('financing-fields');if (ff) ff.classList.toggle('active',this.checked);});}}}catch (e){console.error('toggleInstallmentSection',e);}}function resetTransactionModalDefaults(){try{const payments=(state.appData.settings && state.appData.settings.paymentMethods) || [];let defaultPayment='';try{const debit=payments.find(p=> (p.type || '').toString().toLowerCase()==='debit');if (debit) defaultPayment=debit.name;}catch(e){}if (!defaultPayment && payments.length) defaultPayment=payments[0].name || '';if (!defaultPayment) defaultPayment='Pix';if (document.getElementById('payment-method')) document.getElementById('payment-method').value=defaultPayment;const expenseCats=(state.appData.settings && state.appData.settings.expenseCategories) || [];let defaultCat=expenseCats.find(c=> (c||'').toString().toLowerCase().includes('conta')) || expenseCats[0] || 'Contas';if (document.getElementById('category-expense')) document.getElementById('category-expense').value=defaultCat;const recurring=document.getElementById('is-recurring');if (recurring) recurring.checked=false;const instFields=document.getElementById('installments-fields');if (instFields) instFields.classList.remove('active');const financFields=document.getElementById('financing-fields');if (financFields) financFields.classList.remove('active');const desc=document.getElementById('description');if (desc) desc.value='';const amt=document.getElementById('amount');if (amt) amt.value='';try{const modal=document.getElementById('transaction-modal');if (modal) modal.classList.remove('modal-expanded');}catch(e){}}catch (e){console.error('resetTransactionModalDefaults',e);}}function prepareModalForNextEntry(){try{if (ui.lastTransactionDefaults && typeof ui.lastTransactionDefaults==='object'){const d=ui.lastTransactionDefaults;if (document.getElementById('payment-method') && d.payment) document.getElementById('payment-method').value=d.payment;if (document.getElementById('category-expense') && d.category) document.getElementById('category-expense').value=d.category;return;}resetTransactionModalDefaults();}catch (e){console.error('prepareModalForNextEntry',e);}}function populateModal(type,id){try{const transaction=getCurrentMonthData()[type].find(t=> t.id===id);if (!transaction) return;document.getElementById('transaction-id').value=transaction.id || '';document.getElementById('description').value=transaction.description || '';document.getElementById('amount').value=transaction.amount || '';document.getElementById('is-recurring').checked=!!transaction.isRecurring;try{if (ui.applyToFuture) ui.applyToFuture.checked=false;}catch(e){}if (type==='expenses'){if (document.getElementById('payment-method')) document.getElementById('payment-method').value=transaction.payment || '';if (document.getElementById('category-expense')) document.getElementById('category-expense').value=transaction.category || '';if (transaction.financingId){const financingCheckbox=document.getElementById('is-financing');if (financingCheckbox){financingCheckbox.checked=true;if (typeof financingCheckbox.onchange==='function') financingCheckbox.onchange();const ff=document.getElementById('financing-fields');if (ff) ff.classList.add('active');}const ft=document.getElementById('financing-total');if (ft) ft.value=transaction.totalFinancing || '';const fc=document.getElementById('financing-current');if (fc) fc.value=transaction.currentFinancing || '';}}else if (type==='savings'){if (document.getElementById('category-saving')) document.getElementById('category-saving').value=transaction.category || '';}else if (type==='incomes'){if (transaction.source && transaction.salaryMeta){const isSalaryCheckbox=document.getElementById('is-salary');const salaryFields=document.getElementById('salary-fields');try{if (isSalaryCheckbox){isSalaryCheckbox.checked=true;if (salaryFields) salaryFields.classList.remove('hidden');const modal=document.getElementById('transaction-modal');if (modal) modal.classList.add('modal-expanded');}}catch(e){}const meta=transaction.salaryMeta ||{};if (transaction.source==='salary'){document.getElementById('salary-base').value=meta.salarioBase || '';document.getElementById('salary-periculosidade').value=meta.percentualPericulosidade || '';document.getElementById('salary-outros-proventos').value=meta.outrosProventosTributaveis || '';document.getElementById('salary-dependentes').value=meta.numeroDependentes || '';document.getElementById('salary-desjejum-dia').value=meta.valorDesjejumDia || '';document.getElementById('salary-transporte-dia').value=meta.valorTransporteDia || '';document.getElementById('salary-dias-trabalhados').value=meta.diasTrabalhados || '';document.getElementById('salary-jornada-horas').value=meta.jornadaMensalHoras || '';document.getElementById('salary-horas-trabalhadas').value=meta.horasTrabalhadasRaw || meta.horasTrabalhadas || '';}}}}catch (e){console.error('populateModal',e);}}function openGoalModal(id=null){try{const modal=ui.goalModal;if (!modal) return;const form=ui.goalForm;if (form) form.reset();if (id){const goal=(state.appData.settings.goals || []).find(g=> g.id===id);if (goal){document.getElementById('goal-id').value=goal.id;document.getElementById('goal-name').value=goal.name || '';document.getElementById('goal-amount').value=goal.amount || '';document.getElementById('goal-modal-title').textContent='Editar Meta';}}else{document.getElementById('goal-modal-title').textContent='Nova Meta';}modal.showModal();}catch (e){console.error('openGoalModal',e);}}function openMonthlyReport(){try{const monthData=getCurrentMonthData();const totalIncome=(monthData.incomes || []).reduce((s,t)=>s+(t.amount||0),0);const expenses=monthData.expenses || [];const year=state.currentDate.getFullYear();const month=String(state.currentDate.getMonth() + 1).padStart(2,'0');const paymentMethods=(state.appData.settings && state.appData.settings.paymentMethods) || [];const cardMethods=paymentMethods.filter(p=> p.type==='credit_card');const nonCardExpensesSum=expenses.filter(e=> !cardMethods.some(c=> paymentMatches(e.payment || '',c.name))).reduce((s,t)=>s+(t.amount||0),0);const cardAnticipations=(state.appData.data[year] && state.appData.data[year][month] && state.appData.data[year][month].cardAnticipations) ||{};let totalInvoices=0;cardMethods.forEach(card=>{const cardExpenses=expenses.filter(e=> paymentMatches(e.payment || '',card.name));const totalBeforeAnticipation=cardExpenses.reduce((s,t)=>s+(t.amount||0),0);const anticipated=Number(cardAnticipations[card.name] || 0);const invoiceTotal=Math.round(((totalBeforeAnticipation - anticipated) + Number.EPSILON) * 100) / 100;totalInvoices +=invoiceTotal;});const savingsSum=(monthData.savings || []).reduce((s,t)=>s+(t.amount||0),0);const totalOutcome=nonCardExpensesSum + totalInvoices + savingsSum;const finalBalance=totalIncome - totalOutcome;const title=document.getElementById('monthly-report-title');if (title) title.textContent=state.currentDate.toLocaleString('pt-BR',{month: 'long',year: 'numeric'});const inEl=document.getElementById('mr-total-income');if (inEl) inEl.textContent=formatCurrency(totalIncome);const outEl=document.getElementById('mr-total-outcome');if (outEl) outEl.textContent=formatCurrency(totalOutcome);const finEl=document.getElementById('mr-final-balance');if (finEl) finEl.textContent=formatCurrency(finalBalance);renderMonthlyReportCategoryChart();try{const topList=document.getElementById('mr-top-expenses-list');if (topList){topList.innerHTML='';const contributors=[];(expenses || []).filter(e=> !cardMethods.some(c=> paymentMatches(e.payment || '',c.name))).forEach(e=>{contributors.push({id: `exp-${generateUUID()}`,label: e.description || 'Despesa',amount: Number(e.amount)||0,count: 1,kind: 'expense'});});cardMethods.forEach(card=>{const cardExpenses=(expenses || []).filter(e=> paymentMatches(e.payment || '',card.name));const totalBeforeAnticipation=cardExpenses.reduce((s,t)=>s+(t.amount||0),0);const anticipated=Number(cardAnticipations[card.name] || 0);const invoiceTotal=Math.round(((totalBeforeAnticipation - anticipated) + Number.EPSILON) * 100) / 100;if ((invoiceTotal !==0) || cardExpenses.length > 0){contributors.push({id: `card-${card.name}`,label: `Fatura ${card.name}`,amount: invoiceTotal,count: cardExpenses.length,kind: 'invoice'});}});const topContributors=contributors.slice().sort((a,b)=> (b.amount||0) - (a.amount||0)).slice(0,8);if (topContributors.length===0) topList.innerHTML='<li class="text-gray-500">Nenhuma despesa registrada.</li>';topContributors.forEach(c=>{const li=document.createElement('li');li.className='flex justify-between items-center gap-3';const left=document.createElement('span');left.className='flex items-center gap-2';let iconName='';if (c.kind==='invoice'){const m=c.id && c.id.startsWith('card-') ? c.id.replace(/^card-/,'') : (c.label || '').replace(/^Fatura\s*/i,'');iconName=(typeof getIconFor==='function') ? getIconFor('payment',m) : '';}else if (c.kind==='expense'){const match=(expenses || []).find(e=> (e.description || '').toString()===c.label || (c.label || '').indexOf(e.description || '') !==-1);iconName=(typeof getIconFor==='function') ? getIconFor('category',match ? match.category : '') : '';}if (iconName && typeof iconHtml==='function'){left.innerHTML=iconHtml(iconName,'text-sm text-gray-500') + escapeHtml(c.count > 1 && c.kind==='invoice' ? `${c.label}(${c.count})` : c.label);}else{left.textContent=c.count > 1 && c.kind==='invoice' ? `${c.label}(${c.count})` : c.label;}const right=document.createElement('span');right.className='font-medium';right.textContent=formatCurrency(c.amount);li.appendChild(left);li.appendChild(right);topList.appendChild(li);});}}catch(e){console.error('populate top expenses',e)}const modal=ui.monthlyReportModal;if (modal) modal.showModal();}catch(e){console.error('openMonthlyReport',e)}}function openAnnualReport(){try{const year=state.currentDate.getFullYear();document.getElementById('annual-report-title').textContent=year;const yearData=state.appData.data[year] ||{};const months=Object.keys(yearData);let totalInc=0,totalOut=0;months.forEach(m=>{const md=yearData[m] ||{incomes: [],expenses: [],savings: []};totalInc +=(md.incomes || []).reduce((s,t)=>s+(t.amount||0),0);totalOut +=invoiceAwareOutcomeForMonth(year,m,md);});const final=totalInc - totalOut;const inEl=document.getElementById('ar-total-income');if (inEl) inEl.textContent=formatCurrency(totalInc);const outEl=document.getElementById('ar-total-outcome');if (outEl) outEl.textContent=formatCurrency(totalOut);const finEl=document.getElementById('ar-final-balance');if (finEl) finEl.textContent=formatCurrency(final);renderAnnualBalanceEvolutionChart();renderAnnualAvgCategoryChart();const modal=ui.annualReportModal;if (modal) modal.showModal();}catch(e){console.error('openAnnualReport',e)}}async function handleGoalFormSubmit(e){try{e.preventDefault();const id=document.getElementById('goal-id').value;const name=document.getElementById('goal-name').value;const amount=parseLocaleNumber(document.getElementById('goal-amount').value) || 0;if (!state.appData.settings.goals) state.appData.settings.goals=[];if (id){const g=state.appData.settings.goals.find(x=>x.id===id);if (g){g.name=name;g.amount=amount;}}else{state.appData.settings.goals.push({id: generateUUID(),name,amount});}try{await storage.saveData(state.appData);}catch (e){showToast('Falha ao salvar meta no Firebase.','bg-red-600');}closeModal('goal-modal');}catch(e){console.error('handleGoalFormSubmit',e)}}async function updateFutureRecurrences(recurringId,newTransaction,type){const affectedGoals=new Set();Object.keys(state.appData.data).forEach(year=>{Object.keys(state.appData.data[year]).forEach(month=>{const monthData=state.appData.data[year][month];if (monthData[type] && Array.isArray(monthData[type])){monthData[type]=monthData[type].map(item=>{const itemDate=new Date(year,month - 1);if (item.recurringId===recurringId && itemDate > state.currentDate){if (type==='savings' && (item.goalId || newTransaction.goalId)){if (item.goalId) affectedGoals.add(item.goalId);if (newTransaction.goalId) affectedGoals.add(newTransaction.goalId);}return{...item,description: newTransaction.description,amount: newTransaction.amount,category: newTransaction.category,payment: newTransaction.payment,type: newTransaction.type,goalId: newTransaction.goalId || item.goalId};}return item;});}});});}function updateAllFinancing(financingId,originalCurrentFinancing,newTransaction){try{const newCurrent=Number(newTransaction.currentFinancing) || originalCurrentFinancing;const newTotal=Number(newTransaction.totalFinancing) || null;if (!newTotal || newTotal < newCurrent) return;const editedMonthStart=new Date(state.currentDate.getFullYear(),state.currentDate.getMonth(),1);Object.keys(state.appData.data).forEach(year=>{Object.keys(state.appData.data[year]).forEach(month=>{const monthStart=new Date(Number(year),Number(month) - 1,1);const monthData=state.appData.data[year][month];if (monthData.expenses && Array.isArray(monthData.expenses)){monthData.expenses=monthData.expenses.filter(exp=>{if (exp.financingId !==financingId) return true;return monthStart <=editedMonthStart;});}});});for (let k=newCurrent + 1;k <=newTotal;k++){const monthOffset=k - newCurrent;const targetDate=new Date(editedMonthStart);targetDate.setMonth(editedMonthStart.getMonth() + monthOffset);const targetMonthData=getCurrentMonthData(targetDate);if (!Array.isArray(targetMonthData.expenses)) targetMonthData.expenses=[];const newInst={...newTransaction,id: generateUUID(),financingId: financingId,currentFinancing: k,totalFinancing: newTotal,isPaid: false};targetMonthData.expenses.push(newInst);}}catch (e){console.error('updateAllFinancing (rebuild) error',e);}}async function createInstallments(baseTransaction,count,start=1){const installmentId=generateUUID();let installmentAmount;const rawAmount=parseFloat(baseTransaction.amount) || 0;if (start && start > 1){installmentAmount=parseFloat(rawAmount.toFixed(2));}else{installmentAmount=parseFloat((rawAmount / count).toFixed(2));}for (let i=start;i <=count;i++){const monthOffset=i - start;const installmentDate=new Date(state.currentDate);installmentDate.setMonth(state.currentDate.getMonth() + monthOffset);const futureMonthData=getCurrentMonthData(installmentDate);if ((baseTransaction.payment || '')==='VR'){if (!Array.isArray(futureMonthData.vrUsage)) futureMonthData.vrUsage=[];futureMonthData.vrUsage.push({id: generateUUID(),amount: installmentAmount,description: baseTransaction.description || 'Despesa VR',date: new Date(installmentDate).toISOString(),installmentId,currentInstallment: i,totalInstallments: count,isPaid: i < start ? true : false});}else if ((baseTransaction.payment || '')==='VT'){if (!Array.isArray(futureMonthData.vtUsage)) futureMonthData.vtUsage=[];futureMonthData.vtUsage.push({id: generateUUID(),amount: installmentAmount,description: baseTransaction.description || 'Despesa VT',date: new Date(installmentDate).toISOString(),installmentId,currentInstallment: i,totalInstallments: count,isPaid: i < start ? true : false});}else{if (!Array.isArray(futureMonthData.expenses)) futureMonthData.expenses=[];futureMonthData.expenses.push({...baseTransaction,id: generateUUID(),amount: installmentAmount,installmentId,currentInstallment: i,totalInstallments: count,isPaid: i < start ? true : false});}}try{await storage.saveData(state.appData);showToast(`${count}parcelas criadas com sucesso!`,'bg-green-600');}catch (e){showToast('Falha ao salvar parcelas no Firebase.','bg-red-600');}}async function createFinancing(baseTransaction,total,current){const financingId=generateUUID();for (let i=current;i <=total;i++){const installmentDate=new Date(state.currentDate);installmentDate.setMonth(state.currentDate.getMonth() + (i - current));const futureMonthData=getCurrentMonthData(installmentDate);if ((baseTransaction.payment || '')==='VR'){if (!Array.isArray(futureMonthData.vrUsage)) futureMonthData.vrUsage=[];futureMonthData.vrUsage.push({id: generateUUID(),amount: parseFloat(baseTransaction.amount) || 0,description: baseTransaction.description || 'Despesa VR',date: new Date(installmentDate).toISOString(),financingId,currentFinancing: i,totalFinancing: total});}else if ((baseTransaction.payment || '')==='VT'){if (!Array.isArray(futureMonthData.vtUsage)) futureMonthData.vtUsage=[];futureMonthData.vtUsage.push({id: generateUUID(),amount: parseFloat(baseTransaction.amount) || 0,description: baseTransaction.description || 'Despesa VT',date: new Date(installmentDate).toISOString(),financingId,currentFinancing: i,totalFinancing: total});}else{if (!Array.isArray(futureMonthData.expenses)) futureMonthData.expenses=[];futureMonthData.expenses.push({...baseTransaction,id: generateUUID(),financingId,currentFinancing: i,totalFinancing: total});}}try{await storage.saveData(state.appData);showToast(`Financiamento de ${total}parcelas criado!`,'bg-green-600');}catch (e){showToast('Falha ao salvar financiamento no Firebase.','bg-red-600');}}async function createIncomeFinancing(baseTransaction,total,current){const financingId=generateUUID();for (let i=current;i <=total;i++){const installmentDate=new Date(state.currentDate);installmentDate.setMonth(state.currentDate.getMonth() + (i - current));const futureMonthData=getCurrentMonthData(installmentDate);if (!Array.isArray(futureMonthData.incomes)) futureMonthData.incomes=[];futureMonthData.incomes.push({...baseTransaction,id: generateUUID(),financingId,currentFinancing: i,totalFinancing: total,isPaid: false});}try{await storage.saveData(state.appData);showToast(`Financiamento de entrada criado (${total}x).`,'bg-green-600');}catch(e){console.error('createIncomeFinancing save',e);showToast('Falha ao salvar financiamento de entrada.','bg-red-600');}}async function createIncomeInstallments(baseTransaction,count,start=1){const installmentId=generateUUID();let installmentAmount;const rawAmount=parseFloat(baseTransaction.amount) || 0;if (start && start > 1) installmentAmount=parseFloat(rawAmount.toFixed(2));else installmentAmount=parseFloat((rawAmount / count).toFixed(2));for (let i=start;i <=count;i++){const monthOffset=i - start;const d=new Date(state.currentDate);d.setMonth(state.currentDate.getMonth() + monthOffset);const md=getCurrentMonthData(d);if (!Array.isArray(md.incomes)) md.incomes=[];md.incomes.push({id: generateUUID(),description: baseTransaction.description || 'Serviï¿½o',amount: installmentAmount,installmentId,currentInstallment: i,totalInstallments: count,isPaid: false,isRecurring: !!baseTransaction.isRecurring});}try{await storage.saveData(state.appData);showToast(`${count}parcelas de entrada criadas.`,'bg-green-600');}catch(e){console.error('createIncomeInstallments save',e);showToast('Falha ao salvar parcelas de entrada.','bg-red-600');}}async function deleteFutureInstallments(installmentId,currentInstallment){const deletedSavingsGoals=new Set();Object.keys(state.appData.data).forEach(year=>{Object.keys(state.appData.data[year]).forEach(month=>{const monthData=state.appData.data[year][month];if (monthData.expenses && Array.isArray(monthData.expenses)){monthData.expenses=monthData.expenses.filter(exp=> !(exp.installmentId===installmentId && exp.currentInstallment >=currentInstallment) );}if (monthData.savings && Array.isArray(monthData.savings)){monthData.savings.forEach(saving=>{if (saving.installmentId===installmentId && saving.currentInstallment >=currentInstallment && saving.goalId){deletedSavingsGoals.add(saving.goalId);}});monthData.savings=monthData.savings.filter(saving=> !(saving.installmentId===installmentId && saving.currentInstallment >=currentInstallment) );}});});}async function deleteFutureFinancing(financingId,fromCurrentFinancing){const deletedSavingsGoals=new Set();Object.keys(state.appData.data).forEach(year=>{Object.keys(state.appData.data[year]).forEach(month=>{const monthData=state.appData.data[year][month];if (monthData.expenses && Array.isArray(monthData.expenses)){monthData.expenses=monthData.expenses.filter(exp=> !(exp.financingId===financingId && (exp.currentFinancing || 0) >=fromCurrentFinancing) );}if (monthData.incomes && Array.isArray(monthData.incomes)){monthData.incomes=monthData.incomes.filter(inc=> !(inc.financingId===financingId && (inc.currentFinancing || 0) >=fromCurrentFinancing) );}if (monthData.savings && Array.isArray(monthData.savings)){monthData.savings.forEach(saving=>{if (saving.financingId===financingId && (saving.currentFinancing || 0) >=fromCurrentFinancing && saving.goalId){deletedSavingsGoals.add(saving.goalId);}});monthData.savings=monthData.savings.filter(saving=> !(saving.financingId===financingId && (saving.currentFinancing || 0) >=fromCurrentFinancing) );}});});}async function deleteFutureRecurrences(recurringId){const currentMonthStart=new Date(state.currentDate.getFullYear(),state.currentDate.getMonth(),1);const deletedSavingsGoals=new Set();Object.keys(state.appData.data).forEach(year=>{Object.keys(state.appData.data[year]).forEach(month=>{const monthStart=new Date(year,month - 1,1);if (monthStart >=currentMonthStart){const monthData=state.appData.data[year][month];['incomes','expenses','savings'].forEach(type=>{if (monthData[type] && Array.isArray(monthData[type])){if (type==='savings'){monthData[type].forEach(item=>{if (item.recurringId===recurringId && item.goalId){deletedSavingsGoals.add(item.goalId);}});}monthData[type]=monthData[type].filter(item=> item.recurringId !==recurringId);}});}});});}async function saveTransaction(transaction,type,id){const currentMonthData=getCurrentMonthData();if (!Array.isArray(currentMonthData[type])) currentMonthData[type]=[];if (id){const index=currentMonthData[type].findIndex(t=> t.id===id);if (index > -1){const originalTransaction=currentMonthData[type][index];transaction.recurringId=originalTransaction.recurringId;transaction.financingId=originalTransaction.financingId;transaction.installmentId=originalTransaction.installmentId;const applyToFutureChecked=(ui.applyToFuture && ui.applyToFuture.checked) ? true : null;if (originalTransaction.recurringId){if (applyToFutureChecked===true){await updateFutureRecurrences(originalTransaction.recurringId,transaction,type);}else if (applyToFutureChecked===null){try{const ok=await confirmAsync('Esta ï¿½ï¿½ uma transaï¿½ï¿½o recorrente. Deseja atualizar as futuras tambï¿½m?','Aplicar ï¿½ï¿½s futuras');if (ok) await updateFutureRecurrences(originalTransaction.recurringId,transaction,type);}catch(e){/* user cancelled */}}}if (originalTransaction.financingId){if (applyToFutureChecked===true){updateAllFinancing(originalTransaction.financingId,originalTransaction.currentFinancing,transaction);}else if (applyToFutureChecked===null){try{const okf=await confirmAsync('Esta ï¿½ï¿½ uma transaï¿½ï¿½o de financiamento. Deseja atualizar as parcelas futuras tambï¿½m?','Aplicar ï¿½ï¿½s futuras parcelas');if (okf) updateAllFinancing(originalTransaction.financingId,originalTransaction.currentFinancing,transaction);}catch(e){/* cancelled */}}}if (type==='savings'){try{const goals=state.appData.settings.goals || [];let linkedGoalId=originalTransaction.goalId || null;if (transaction.category){const g=goals.find(x=> (x.name || '').toString().toLowerCase()===(transaction.category || '').toString().toLowerCase());if (g) linkedGoalId=g.id;}if (!linkedGoalId && transaction.description){const desc=(transaction.description || '').toString().toLowerCase();const g2=goals.find(x=> desc.indexOf((x.name || '').toString().toLowerCase()) !==-1 || (transaction.description||'').toString().trim()===(x.name||''));if (g2) linkedGoalId=g2.id;}if (linkedGoalId) transaction.goalId=linkedGoalId;}catch (e){/* ignore linking errors */}}currentMonthData[type][index]={...originalTransaction,...transaction};try{await storage.saveData(state.appData);showToast('transaï¿½ï¿½o editada com sucesso!','bg-green-600');}catch (e){showToast('Falha ao salvar transaï¿½ï¿½o no Firebase.','bg-red-600');}}}else{if (transaction.isRecurring){transaction.recurringId=generateUUID();}if (type==='savings'){try{const goals=state.appData.settings.goals || [];let linked=null;if (transaction.category){linked=goals.find(g=> (g.name || '').toString().toLowerCase()===(transaction.category || '').toString().toLowerCase());}if (!linked && transaction.description){const desc=(transaction.description || '').toString().toLowerCase();linked=goals.find(g=> desc.indexOf((g.name || '').toString().toLowerCase()) !==-1 || (transaction.description||'').toString().trim()===(g.name||''));}if (linked) transaction.goalId=linked.id;}catch (e){/* ignore */}}currentMonthData[type].push(transaction);try{await storage.saveData(state.appData);showToast('transaï¿½ï¿½o salva com sucesso!','bg-green-600');try{const lastPayment=document.getElementById('payment-method') ? document.getElementById('payment-method').value : null;const lastCat=document.getElementById('category-expense') ? document.getElementById('category-expense').value : null;ui.lastTransactionDefaults={payment: lastPayment,category: lastCat};}catch(e){/* ignore */}try{prepareModalForNextEntry();}catch(e){console.error('prepare next after save',e);}}catch (e){showToast('Falha ao salvar transaï¿½ï¿½o no Firebase.','bg-red-600');}}}function previewFutureChanges(id,type){try{if (!id) return showToast('ID da transaï¿½ï¿½o nï¿½o informado para prï¿½ï¿½-visualizaï¿½ï¿½o.','bg-gray-600');const affected=[];Object.keys(state.appData.data ||{}).forEach(year=>{Object.keys(state.appData.data[year] ||{}).forEach(month=>{const md=state.appData.data[year][month];if (!md || !Array.isArray(md[type])) return;md[type].forEach(item=>{if (!item) return;if (item.recurringId && item.recurringId===id) affected.push({year: Number(year),month: Number(month),amount: item.amount});if (item.financingId && item.financingId===id) affected.push({year: Number(year),month: Number(month),amount: item.amount});});});});if (affected.length===0) return showToast('Nenhuma recorrï¿½ï¿½ncia futura encontrada para esta transaï¿½ï¿½o.','bg-gray-600');const lines=affected.slice(0,20).map(a=> `${String(a.month).padStart(2,'0')}/${a.year}: ${formatCurrency(a.amount)}`);const more=affected.length > 20 ? `\n...e mais ${affected.length - 20}meses` : '';alert('Recorrï¿½ï¿½ncias afetadas:\n' + lines.join('\n') + more);}catch (e){console.error('previewFutureChanges',e);showToast('Erro ao gerar prï¿½ï¿½-visualizaï¿½ï¿½o.','bg-red-600');}}async function deleteTransaction(type,id){const currentMonthData=getCurrentMonthData();if (!Array.isArray(currentMonthData[type])) return;const transaction=currentMonthData[type].find(t=> t.id===id);if (!transaction) return;let confirmMessage='Tem certeza que deseja excluir esta transaï¿½ï¿½o?';let action=()=>{const index=currentMonthData[type].findIndex(t=> t.id===id);if (index > -1) currentMonthData[type].splice(index,1);return 'transaï¿½ï¿½o excluï¿½ï¿½da com sucesso!';};if (transaction.installmentId){try{const deleteOnlyThis=await confirmAsync('Esta ï¿½ï¿½ uma transaï¿½ï¿½o parcelada. Deseja excluir apenas esta parcela? (OK=Sim,Cancel=nï¿½o)','Excluir parcela');if (deleteOnlyThis){confirmMessage='Confirma exclusï¿½o desta parcela?';action=()=>{const index=currentMonthData[type].findIndex(t=> t.id===id);if (index > -1) currentMonthData[type].splice(index,1);return 'Parcela excluï¿½ï¿½da com sucesso!';};}else{const deleteFuture=await confirmAsync('Deseja excluir esta e todas as parcelas futuras? (OK=Sim,Cancel=nï¿½o)','Excluir parcelas futuras');if (deleteFuture){confirmMessage='Confirma exclusï¿½o desta e das parcelas futuras?';action=async ()=>{await deleteFutureInstallments(transaction.installmentId,transaction.currentInstallment);return 'Parcelas excluï¿½ï¿½das com sucesso!';};}else{return;}}}catch(e){return;}}else if (transaction.financingId){try{const delOnly=await confirmAsync('Esta ï¿½ï¿½ uma parcela de financiamento. Deseja excluir apenas esta parcela? (OK=Sim,Cancel=nï¿½o)','Excluir parcela de financiamento');if (delOnly){confirmMessage='Confirma exclusï¿½o desta parcela?';action=()=>{const index=currentMonthData[type].findIndex(t=> t.id===id);if (index > -1) currentMonthData[type].splice(index,1);return 'Parcela excluï¿½ï¿½da com sucesso!';};}else{const delFuture=await confirmAsync('Deseja excluir esta e todas as parcelas futuras do financiamento? (OK=Sim,Cancel=nï¿½o)','Excluir parcelas de financiamento futuras');if (delFuture){confirmMessage='Confirma exclusï¿½o desta e das parcelas futuras do financiamento?';action=async ()=>{await deleteFutureFinancing(transaction.financingId,transaction.currentFinancing);return 'Parcelas de financiamento excluï¿½ï¿½das com sucesso!';};}else{return;}}}catch(e){return;}}else if (transaction.recurringId){confirmMessage='Esta ï¿½ï¿½ uma transaï¿½ï¿½o recorrente. Deseja excluir esta e todas as futuras recorrï¿½ï¿½ncias (a partir deste Mï¿½s)?';action=async ()=>{await deleteFutureRecurrences(transaction.recurringId);return 'Recorrï¿½ï¿½ncias excluï¿½ï¿½das com sucesso!';};}try{const ok=await confirmAsync(confirmMessage,'Confirmar exclusï¿½o');if (!ok) return;const toastMessage=await action();try{await storage.saveData(state.appData);showToast(toastMessage,'bg-red-600');}catch (e){showToast('Falha ao salvar exclusï¿½o no Firebase.','bg-red-600');}render();}catch(e){return;}}async function handleFormSubmit(e){e.preventDefault();const id=document.getElementById('transaction-id').value;const type=ui.transactionTypeInput.value;const transactionData={description: document.getElementById('description').value,amount: parseLocaleNumber(document.getElementById('amount').value) || 0,isRecurring: document.getElementById('is-recurring').checked};if (!id) transactionData.id=generateUUID();if (type==='expenses'){Object.assign(transactionData,{payment: document.getElementById('payment-method').value,category: document.getElementById('category-expense').value,type: document.getElementById('expense-type').value,isPaid: false});try{const pmVal=(transactionData.payment || '').toString();const recipientEl=document.getElementById('payment-recipient');if ((pmVal==='PIX' || pmVal==='Transferï¿½ï¿½ncia') && recipientEl){const recVal=(recipientEl.value || '').toString().trim();if (!recVal){setTransactionError('Informe o destinaTï¿½ï¿½rio para PIX ou Transferï¿½ï¿½ncia.');return;}transactionData.recipient=recVal;}else if (recipientEl && recipientEl.value){transactionData.recipient=recipientEl.value;}}catch (rErr){console.error('recipient collect error',rErr);}const financingCheckbox=document.getElementById('is-financing');if (financingCheckbox && financingCheckbox.checked){const totalFin=parseInt(document.getElementById('financing-total').value,10);const currentFin=parseInt(document.getElementById('financing-current').value,10);if (!isNaN(totalFin)) transactionData.totalFinancing=totalFin;if (!isNaN(currentFin)) transactionData.currentFinancing=currentFin;const existingFId=document.getElementById('transaction-id').value;if (existingFId) transactionData.financingId=currentFin ? (transactionData.financingId || null) : transactionData.financingId;}const pm=transactionData.payment || '';if (pm==='VR'){transactionData.isPaid=true;const settings=state.appData.settings ||{};const expenseCategories=settings.expenseCategories || [];const normalize=s=> (s || '').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');const foundAlim=expenseCategories.find(c=> normalize(c).includes('aliment'));const currentCat=transactionData.category || '';if (!normalize(currentCat).includes('aliment')){if (foundAlim){transactionData.category=foundAlim;showToast('Pagamento via VR: categoria ajustada para Alimentaï¿½ï¿½o.','bg-yellow-600');}else{try{const ok=await confirmAsync('vocï¿½ selecionou VR como forma de pagamento,mas a categoria nï¿½o parece ser Alimentaï¿½ï¿½o. Deseja prosseguir?','Confirmar VR');if (!ok) return;}catch(e){return;}}}try{transactionData.type='Essenciais';}catch(e){/* ignore */}const mdCheck=getCurrentMonthData();let availableVR=getMonthVRBalance(mdCheck);if (id){try{const existing=mdCheck.expenses && mdCheck.expenses.find(e=> e.id===id);if (existing && existing.payment==='VR'){availableVR=Math.round((availableVR + (Number(existing.amount) || 0)) * 100) / 100;}}catch (e){console.error('adjust availableVR for edit',e);}}const spendAmount=Number(transactionData.amount) || 0;if (spendAmount > availableVR){setTransactionError('Valor superior ao saldo disponï¿½ï¿½vel de VR para este Mï¿½s. Verifique o saldo no card de VR.');return;}else{clearTransactionError();}const md=getCurrentMonthData();if (!Array.isArray(md.vrUsage)) md.vrUsage=[];const usageEntry={id: generateUUID(),amount: Number(transactionData.amount) || 0,description: transactionData.description || '',date: new Date().toISOString()};md.vrUsage.push(usageEntry);try{await storage.saveData(state.appData);showToast('Despesa registrada no VR (lanï¿½amento separado).','bg-green-600');}catch (e){showToast('Falha ao salvar uso de VR no Firebase.','bg-red-600');}closeModal('transaction-modal');render();return;}if (pm==='VT'){transactionData.isPaid=true;try{const settings=state.appData.settings ||{};const expenseCategories=settings.expenseCategories || [];const normalize=s=> (s || '').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');const foundTransp=expenseCategories.find(c=> normalize(c).includes('transport')) || expenseCategories.find(c=> normalize(c).includes('transp')) || expenseCategories.find(c=> normalize(c).includes('transporte'));const currentCat=transactionData.category || '';if (!normalize(currentCat).includes('transp') && foundTransp){transactionData.category=foundTransp;showToast('Pagamento via VT: categoria ajustada para Transporte.','bg-yellow-600');}}catch (e){console.error('vt category enforcement',e);}if (!transactionData.description || transactionData.description.trim()===''){transactionData.description='Abastecimento';}const mdCheck=getCurrentMonthData();let availableVT=getMonthVTBalance(mdCheck);if (id){try{const existing=(mdCheck.expenses || []).find(e=> e.id===id);if (existing && existing.payment==='VT'){availableVT=Math.round((availableVT + (Number(existing.amount) || 0)) * 100) / 100;}}catch (e){console.error('adjust availableVT for edit',e);}}const spendAmount=Number(transactionData.amount) || 0;if (spendAmount > availableVT){setTransactionError('Valor superior ao saldo disponï¿½ï¿½vel de VT para este Mï¿½s. Verifique o saldo no card de VT.');return;}else{clearTransactionError();}const md=getCurrentMonthData();if (!Array.isArray(md.vtUsage)) md.vtUsage=[];const usageEntry={id: generateUUID(),amount: Number(transactionData.amount) || 0,description: transactionData.description || '',date: new Date().toISOString()};md.vtUsage.push(usageEntry);try{await storage.saveData(state.appData);showToast('Despesa registrada no VT (lanï¿½amento separado).','bg-green-600');}catch (e){showToast('Falha ao salvar uso de VT no Firebase.','bg-red-600');}closeModal('transaction-modal');render();return;}}else if (type==='savings'){try{transactionData.category=document.getElementById('category-saving').value;}catch(e){transactionData.category=''}delete transactionData.goalId;}const isInstallment=document.getElementById('is-installment').checked;const installmentsCount=parseInt(document.getElementById('installment-count')?.value || document.getElementById('installments-count')?.value,10);const isFinancing=document.getElementById('is-financing').checked;const financingTotal=parseInt(document.getElementById('financing-total').value,10);const financingCurrent=parseInt(document.getElementById('financing-current').value,10);try{const currentMonthData=getCurrentMonthData();if (id && type==='expenses'){const original=currentMonthData.expenses.find(t=> t.id===id);if (original){if (isInstallment && installmentsCount > 1 && !original.installmentId && !original.financingId){const idx=currentMonthData.expenses.findIndex(t=> t.id===id);if (idx > -1) currentMonthData.expenses.splice(idx,1);const startInstallment=parseInt(document.getElementById('installment-start')?.value || document.getElementById('installments-current')?.value || '1',10) || 1;await createInstallments(transactionData,installmentsCount,startInstallment);closeModal('transaction-modal');render();return;}if (isFinancing && financingTotal > 1 && financingCurrent >=1 && !original.financingId && !original.installmentId){const idx=currentMonthData.expenses.findIndex(t=> t.id===id);if (idx > -1) currentMonthData.expenses.splice(idx,1);await createFinancing(transactionData,financingTotal,financingCurrent);closeModal('transaction-modal');render();return;}}}if (type==='expenses' && isInstallment && installmentsCount > 1 && !id){const startInstallment=parseInt(document.getElementById('installment-start')?.value || document.getElementById('installments-current')?.value || '1',10) || 1;await createInstallments(transactionData,installmentsCount,startInstallment);}else if (type==='expenses' && isFinancing && financingTotal > 1 && financingCurrent >=1 && !id){await createFinancing(transactionData,financingTotal,financingCurrent);}else if (type==='incomes' && isFinancing && financingTotal > 1 && financingCurrent >=1 && !id){await createIncomeFinancing(transactionData,financingTotal,financingCurrent);}else if (type==='incomes' && isInstallment && installmentsCount > 1 && !id){const startInstallment=parseInt(document.getElementById('installment-start')?.value || document.getElementById('installments-current')?.value || '1',10) || 1;await createIncomeInstallments(transactionData,installmentsCount,startInstallment);}else if (type==='incomes' && document.getElementById('is-salary') && document.getElementById('is-salary').checked){try{const year=state.currentDate.getFullYear();const month=state.currentDate.getMonth() + 1;const amountFieldVal=parseLocaleNumber((document.getElementById('amount') ||{value: 0}).value) || 0;const providedSalaryBase=parseLocaleNumber((document.getElementById('salary-base') ||{value: 0}).value) || 0;const salarioBaseToUse=providedSalaryBase > 0 ? providedSalaryBase : amountFieldVal;const isRecurringNow=document.getElementById('is-recurring') ? document.getElementById('is-recurring').checked : !!transactionData.isRecurring;const parseHoursString=(raw)=>{try{if (raw===undefined || raw===null) return 0;if (typeof raw==='number') return raw;let s=String(raw).trim();if (s==='') return 0;const colonMatch=s.match(/^(-?\d+):([0-5]?\d)$/);if (colonMatch){const h=parseInt(colonMatch[1],10) || 0;const m=parseInt(colonMatch[2],10) || 0;const totalMinutes=h * 60 + (h < 0 ? -m : m);return Math.round((totalMinutes / 60) * 1000000) / 1000000;}s=s.replace(',','.');const fv=parseFloat(s);return isNaN(fv) ? 0 : fv;}catch (e){return 0;}};const rawHoursRaw=(document.getElementById('salary-horas-trabalhadas') ||{value: ''}).value;const params={salarioBase: salarioBaseToUse,percentualPericulosidade: parseLocaleNumber((document.getElementById('salary-periculosidade') ||{value: 0}).value) || 0,outrosProventosTributaveis: parseLocaleNumber((document.getElementById('salary-outros-proventos') ||{value: 0}).value) || 0,numeroDependentes: parseInt((document.getElementById('salary-dependentes') ||{value: 0}).value,10) || 0,valorDesjejumDia: parseLocaleNumber((document.getElementById('salary-desjejum-dia') ||{value: 0}).value) || 0,valorTransporteDia: parseLocaleNumber((document.getElementById('salary-transporte-dia') ||{value: 0}).value) || 0,diasTrabalhados: parseInt((document.getElementById('salary-dias-trabalhados') ||{value: ''}).value,10) || undefined,hoursTrabalhadas: parseHoursString(rawHoursRaw) || 0,horasTrabalhadasRaw: rawHoursRaw || '',horasExtrasSabado: parseHoursString((document.getElementById('salary-h-extra-sab') ||{value: 0}).value) || 0,horasExtrasDomingo: parseHoursString((document.getElementById('salary-h-extra-dom') ||{value: 0}).value) || 0,jornadaMensalHoras: parseHoursString((document.getElementById('salary-jornada-horas') ||{value: 220}).value) || 220,year,month};const calc=calcularSalarioLiquido(params);const parseNum=(s)=>{try{return typeof s==='number' ? s : parseFloat(String(s).replace(/\./g,'').replace(',','.')) || parseFloat(s);}catch(e){return parseFloat(s) || 0;}};const salarioLiquido=parseFloat(calc.resumo.salarioLiquido) || 0;const beneficiosTotais=parseFloat(calc.resumo.beneficiosTotais) || 0;const valorHorasExtras=parseFloat(calc.resumo.valorHorasExtras) || 0;const buildValuesFor=(pMonthly)=>{const calcMonth=calcularSalarioLiquido(pMonthly);const salarioLiquidoM=parseFloat(calcMonth.resumo.salarioLiquido) || 0;const valorHorasExtrasM=parseFloat(calcMonth.resumo.valorHorasExtras) || 0;const nextDate=new Date(pMonthly.year,pMonthly.month,1);const nextY2=nextDate.getFullYear();const nextM2=nextDate.getMonth() + 1;const roundLocal=(v)=> Math.round((v + Number.EPSILON) * 100) / 100;const beneficiosVTM=roundLocal((pMonthly.valorTransporteDia || 0) * (diasUteisNoMes(pMonthly.year,pMonthly.month) + 1));const beneficiosVRM=roundLocal((pMonthly.valorDesjejumDia || 0) * (diasUteisNoMes(pMonthly.year,pMonthly.month) + 1));return{salarioLiquido: salarioLiquidoM,beneficiosVT: beneficiosVTM,beneficiosVR: beneficiosVRM,valorHorasExtras: valorHorasExtrasM};};const removeSalaryItemsFromMonth=(monthDataObj,opts)=>{if (!monthDataObj) return;const oldMetaStr=opts.oldMetaStr || null;const rid=opts.recurringId || null;if (!Array.isArray(monthDataObj.incomes)) monthDataObj.incomes=[];if (!Array.isArray(monthDataObj.vrLedger)) monthDataObj.vrLedger=[];if (!Array.isArray(monthDataObj.vtLedger)) monthDataObj.vtLedger=[];if (rid){monthDataObj.incomes=monthDataObj.incomes.filter(i=> i.recurringId !==rid);monthDataObj.vrLedger=monthDataObj.vrLedger.filter(l=> l.recurringId !==rid);monthDataObj.vtLedger=monthDataObj.vtLedger.filter(l=> l.recurringId !==rid);}else if (oldMetaStr){monthDataObj.incomes=monthDataObj.incomes.filter(i=> !(i.salaryMeta && JSON.stringify(i.salaryMeta)===oldMetaStr));monthDataObj.vrLedger=monthDataObj.vrLedger.filter(l=> !(l.salaryMeta && JSON.stringify(l.salaryMeta)===oldMetaStr));monthDataObj.vtLedger=monthDataObj.vtLedger.filter(l=> !(l.salaryMeta && JSON.stringify(l.salaryMeta)===oldMetaStr));}};const pushEntriesToMonth=(monthDataObj,rId,values,meta)=>{if (!Array.isArray(monthDataObj.incomes)) monthDataObj.incomes=[];if (!Array.isArray(monthDataObj.vrLedger)) monthDataObj.vrLedger=[];if (!Array.isArray(monthDataObj.vtLedger)) monthDataObj.vtLedger=[];const toPush=[];if (values.salarioLiquido > 0) toPush.push({id: generateUUID(),description: `Salï¿½ï¿½rio (Lï¿½ï¿½quido)`,amount: values.salarioLiquido,isRecurring: !!transactionData.isRecurring,recurringId: rId,source: 'salary',salaryMeta: meta || null});if (values.beneficiosVT > 0){monthDataObj.vtLedger.push({id: generateUUID(),description: 'Benefï¿½ï¿½cio - VT',amount: values.beneficiosVT,recurringId: rId || null,isRecurring: !!rId,salaryMeta: meta || null});}if (values.beneficiosVR > 0){monthDataObj.vrLedger.push({id: generateUUID(),description: 'Benefï¿½ï¿½cio - VR',amount: values.beneficiosVR,recurringId: rId || null,isRecurring: !!rId,salaryMeta: meta || null});}if (values.valorHorasExtras > 0) toPush.push({id: generateUUID(),description: `Horas Extras`,amount: values.valorHorasExtras,isRecurring: !!transactionData.isRecurring,recurringId: rId,source: 'overtime',salaryMeta: meta || null});toPush.forEach(en=> monthDataObj.incomes.push(en));};if (id){const original=currentMonthData.incomes.find(t=> t.id===id);const oldMetaStr=original && original.salaryMeta ? JSON.stringify(original.salaryMeta) : null;const origRecurringId=original && original.recurringId ? original.recurringId : null;let applyToFuture=false;if (origRecurringId){try{applyToFuture=await confirmAsync('Essa ï¿½ï¿½ uma entrada recorrente. Deseja aplicar as alterAï¿½ï¿½ES ï¿½ï¿½s recorrï¿½ï¿½ncias futuras? (OK=Sim)','Aplicar ï¿½ï¿½s futuras');}catch(e){applyToFuture=false;}}if (origRecurringId && applyToFuture){Object.keys(state.appData.data).forEach(yearKey=>{Object.keys(state.appData.data[yearKey]).forEach(monthKey=>{const monthStart=new Date(Number(yearKey),Number(monthKey) - 1,1);const editedMonthStart=new Date(state.currentDate.getFullYear(),state.currentDate.getMonth(),1);if (monthStart >=editedMonthStart){const md=state.appData.data[yearKey][monthKey];removeSalaryItemsFromMonth(md,{recurringId: origRecurringId});const pMonthly=Object.assign({},params,{year: Number(yearKey),month: Number(monthKey)});const vals=buildValuesFor(pMonthly);const meta={salarioBase: pMonthly.salarioBase,percentualPericulosidade: pMonthly.percentualPericulosidade,outrosProventosTributaveis: pMonthly.outrosProventosTributaveis,numeroDependentes: pMonthly.numeroDependentes,valorDesjejumDia: pMonthly.valorDesjejumDia,valorTransporteDia: pMonthly.valorTransporteDia,diasTrabalhados: pMonthly.diasTrabalhados,horasTrabalhadas: pMonthly.hoursTrabalhadas,jornadaMensalHoras: pMonthly.jornadaMensalHoras};pushEntriesToMonth(md,origRecurringId,vals,meta);}});});}else{removeSalaryItemsFromMonth(currentMonthData,{oldMetaStr,recurringId: origRecurringId && !applyToFuture ? origRecurringId : null});const pMonthlyNow=Object.assign({},params,{year: state.currentDate.getFullYear(),month: state.currentDate.getMonth() + 1});const valsNow=buildValuesFor(pMonthlyNow);const metaNow={salarioBase: pMonthlyNow.salarioBase,percentualPericulosidade: pMonthlyNow.percentualPericulosidade,outrosProventosTributaveis: pMonthlyNow.outrosProventosTributaveis,numeroDependentes: pMonthlyNow.numeroDependentes,valorDesjejumDia: pMonthlyNow.valorDesjejumDia,valorTransporteDia: pMonthlyNow.valorTransporteDia,diasTrabalhados: pMonthlyNow.diasTrabalhados,horasTrabalhadas: pMonthlyNow.hoursTrabalhadas,jornadaMensalHoras: pMonthlyNow.jornadaMensalHoras};const targetRid=origRecurringId || (transactionData.isRecurring ? generateUUID() : null);pushEntriesToMonth(currentMonthData,targetRid,valsNow,metaNow);}try{await storage.saveData(state.appData);showToast('Salï¿½ï¿½rio atualizado com sucesso!','bg-green-600');}catch(e){console.error('save edited salary',e);showToast('Falha ao salvar salï¿½ï¿½rio editado.','bg-red-600');}}else{const recurringId=transactionData.isRecurring ? generateUUID() : null;if (transactionData.isRecurring){const rId=recurringId;for (let i=0;i < 12;i++){const d=new Date(state.currentDate.getFullYear(),state.currentDate.getMonth() + i,1);const y=d.getFullYear();const m=d.getMonth() + 1;const pMonthly=Object.assign({},params,{year: y,month: m});const vals=buildValuesFor(pMonthly);const md=getCurrentMonthData(new Date(y,m - 1,1));const meta={salarioBase: pMonthly.salarioBase,percentualPericulosidade: pMonthly.percentualPericulosidade,outrosProventosTributaveis: pMonthly.outrosProventosTributaveis,numeroDependentes: pMonthly.numeroDependentes,valorDesjejumDia: pMonthly.valorDesjejumDia,valorTransporteDia: pMonthly.valorTransporteDia,diasTrabalhados: pMonthly.diasTrabalhados,horasTrabalhadas: pMonthly.hoursTrabalhadas,jornadaMensalHoras: pMonthly.jornadaMensalHoras};pushEntriesToMonth(md,rId,vals,meta);}}else{const pMonthlyNow=Object.assign({},params,{year: state.currentDate.getFullYear(),month: state.currentDate.getMonth() + 1});const valsNow=buildValuesFor(pMonthlyNow);const metaNow={salarioBase: pMonthlyNow.salarioBase,percentualPericulosidade: pMonthlyNow.percentualPericulosidade,outrosProventosTributaveis: pMonthlyNow.outrosProventosTributaveis,numeroDependentes: pMonthlyNow.numeroDependentes,valorDesjejumDia: pMonthlyNow.valorDesjejumDia,valorTransporteDia: pMonthlyNow.valorTransporteDia,diasTrabalhados: pMonthlyNow.diasTrabalhados,horasTrabalhadas: pMonthlyNow.hoursTrabalhadas,jornadaMensalHoras: pMonthlyNow.jornadaMensalHoras};pushEntriesToMonth(currentMonthData,null,valsNow,metaNow);}try{await storage.saveData(state.appData);showToast('Salï¿½ï¿½rio salvo com sucesso!','bg-green-600');}catch(e){console.error('save new salary',e);showToast('Falha ao salvar salï¿½ï¿½rio no Firebase.','bg-red-600');}}try{await storage.saveData(state.appData);showToast('Salï¿½ï¿½rio salvo com sucesso!','bg-green-600');}catch (err){showToast('Falha ao salvar salï¿½ï¿½rio no Firebase.','bg-red-600');}}catch (err){showToast('Erro ao processar salï¿½ï¿½rio: ' + (err && err.message ? err.message : ''),'bg-red-600');}}else{await saveTransaction(transactionData,type,id);}}catch (e){showToast('Erro ao salvar transaï¿½ï¿½o: ' + (e && e.message ? e.message : ''),'bg-red-600');}closeModal('transaction-modal');render();}function startInlineVREdit(el,vrId){try{if (!el) return;const current=el.textContent || '';const input=document.createElement('input');input.type='number';input.step='0.01';input.value=parseFloat(String(current).replace(/[R$\.\s]/g,'').replace(',','.')) || 0;input.className='inline-vr-input border px-1 py-0 rounded text-right';input.style.minWidth='80px';el.replaceWith(input);input.focus();input.select();const commit=async ()=>{const v=parseFloat(input.value) || 0;await commitInlineVREdit(vrId,v,input);};input.addEventListener('blur',commit);input.addEventListener('keydown',(e)=>{if (e.key==='Enter'){input.blur();}if (e.key==='Escape'){render();}});}catch(e){console.error('startInlineVREdit',e);}}async function commitInlineVREdit(vrId,newAmount,inputEl){try{const md=getCurrentMonthData();if (!Array.isArray(md.vrLedger)) md.vrLedger=[];const idx=md.vrLedger.findIndex(l=> l.id===vrId);if (idx===-1) return render();const entry=md.vrLedger[idx];const oldAmount=entry.amount || 0;entry.amount=Math.round((Number(newAmount) + Number.EPSILON) * 100) / 100;try{await storage.saveData(state.appData);}catch(e){console.error('commitInlineVREdit save',e);}render();}catch(e){console.error('commitInlineVREdit',e);}}function applyToFutureVREntries(recurringId,newAmount){try{Object.keys(state.appData.data).forEach(year=>{Object.keys(state.appData.data[year]).forEach(month=>{const md=state.appData.data[year][month];if (!md || !Array.isArray(md.vrLedger)) return;md.vrLedger=md.vrLedger.map(l=>{if (l.recurringId===recurringId){return{...l,amount: newAmount};}return l;});});});try{storage.saveData(state.appData);}catch(e){console.error('applyToFutureVREntries save',e);}showToast('AlterAï¿½ï¿½ES aplicadas ï¿½ï¿½s recorrï¿½ï¿½ncias futuras.','bg-green-600');}catch(e){console.error('applyToFutureVREntries',e);}}function startInlineVTEdit(el,vtId){try{if (!el) return;const current=el.textContent || '';const input=document.createElement('input');input.type='number';input.step='0.01';input.value=parseFloat(String(current).replace(/[R$\.\s]/g,'').replace(',','.')) || 0;input.className='inline-vt-input border px-1 py-0 rounded text-right';input.style.minWidth='80px';el.replaceWith(input);input.focus();input.select();const commit=async ()=>{const v=parseFloat(input.value) || 0;await commitInlineVTEdit(vtId,v,input);};input.addEventListener('blur',commit);input.addEventListener('keydown',(e)=>{if (e.key==='Enter'){input.blur();}if (e.key==='Escape'){render();}});}catch(e){console.error('startInlineVTEdit',e);}}async function commitInlineVTEdit(vtId,newAmount,inputEl){try{const md=getCurrentMonthData();if (!Array.isArray(md.vtLedger)) md.vtLedger=[];const idx=md.vtLedger.findIndex(l=> l.id===vtId);if (idx===-1) return render();const entry=md.vtLedger[idx];const oldAmount=entry.amount || 0;entry.amount=Math.round((Number(newAmount) + Number.EPSILON) * 100) / 100;try{await storage.saveData(state.appData);}catch(e){console.error('commitInlineVTEdit save',e);}render();}catch(e){console.error('commitInlineVTEdit',e);}}function applyToFutureVTEntries(recurringId,newAmount){try{Object.keys(state.appData.data).forEach(year=>{Object.keys(state.appData.data[year]).forEach(month=>{const md=state.appData.data[year][month];if (!md || !Array.isArray(md.vtLedger)) return;md.vtLedger=md.vtLedger.map(l=>{if (l.recurringId===recurringId){return{...l,amount: newAmount};}return l;});});});try{storage.saveData(state.appData);}catch(e){console.error('applyToFutureVTEntries save',e);}showToast('AlterAï¿½ï¿½ES aplicadas ï¿½ï¿½s recorrï¿½ï¿½ncias futuras.','bg-green-600');}catch(e){console.error('applyToFutureVTEntries',e);}}async function deleteVRLedgerEntry(id,yearContext,monthContext){try{if (!id) return;const y=yearContext || state.currentDate.getFullYear();const m=monthContext || (state.currentDate.getMonth() + 1);const monthData=getCurrentMonthData(new Date(y,m - 1,1));if (!monthData || !Array.isArray(monthData.vrLedger)) return;const idx=monthData.vrLedger.findIndex(v=> v.id===id);if (idx===-1) return;const entry=monthData.vrLedger[idx];let removeFuture=false;if (entry && entry.recurringId){try{removeFuture=await confirmAsync('Este VR ï¿½ï¿½ recorrente. Deseja excluir tambï¿½m as recorrï¿½ï¿½ncias futuras? (OK=Sim)','Excluir recorrï¿½ï¿½ncias VR');}catch(e){removeFuture=false;}}monthData.vrLedger.splice(idx,1);if (removeFuture && entry && entry.recurringId){const rid=entry.recurringId;const currentMonthStart=new Date(y,m - 1,1);Object.keys(state.appData.data).forEach(yearKey=>{Object.keys(state.appData.data[yearKey]).forEach(monthKey=>{const yearNum=Number(yearKey);const monthNum=Number(monthKey);const candidate=new Date(yearNum,monthNum - 1,1);if (candidate >=currentMonthStart){const md=state.appData.data[yearKey][monthKey];if (md && Array.isArray(md.vrLedger)){md.vrLedger=md.vrLedger.filter(v=> v.recurringId !==rid);}}});});}try{await storage.saveData(state.appData);showToast('VR excluï¿½ï¿½do.');}catch (e){console.error('delete vr save',e);showToast('Falha ao excluir VR.','bg-red-600');}}catch (e){console.error('deleteVRLedgerEntry',e);}}async function deleteVTLedgerEntry(id,yearContext,monthContext){try{if (!id) return;const y=yearContext || state.currentDate.getFullYear();const m=monthContext || (state.currentDate.getMonth() + 1);const monthData=getCurrentMonthData(new Date(y,m - 1,1));if (!monthData || !Array.isArray(monthData.vtLedger)) return;const idx=monthData.vtLedger.findIndex(v=> v.id===id);if (idx===-1) return;const entry=monthData.vtLedger[idx];let removeFuture=false;if (entry && entry.recurringId){try{removeFuture=await confirmAsync('Este VT ï¿½ï¿½ recorrente. Deseja excluir tambï¿½m as recorrï¿½ï¿½ncias futuras? (OK=Sim)','Excluir recorrï¿½ï¿½ncias VT');}catch(e){removeFuture=false;}}monthData.vtLedger.splice(idx,1);if (removeFuture && entry && entry.recurringId){const rid=entry.recurringId;const currentMonthStart=new Date(y,m - 1,1);Object.keys(state.appData.data).forEach(yearKey=>{Object.keys(state.appData.data[yearKey]).forEach(monthKey=>{const yearNum=Number(yearKey);const monthNum=Number(monthKey);const candidate=new Date(yearNum,monthNum - 1,1);if (candidate >=currentMonthStart){const md=state.appData.data[yearKey][monthKey];if (md && Array.isArray(md.vtLedger)){md.vtLedger=md.vtLedger.filter(v=> v.recurringId !==rid);}}});});}try{await storage.saveData(state.appData);showToast('VT excluï¿½ï¿½do.');}catch (e){console.error('delete vt save',e);showToast('Falha ao excluir VT.','bg-red-600');}}catch (e){console.error('deleteVTLedgerEntry',e);}}function openVREdit(id){try{const modal=document.getElementById('vr-modal');if (!modal) return;const md=getCurrentMonthData();const entry=(md.vrLedger || []).find(v=> v.id===id) || null;if (entry){document.getElementById('vr-entry-id').value=entry.id || '';document.getElementById('vr-entry-desc').value=entry.description || 'Benefï¿½ï¿½cio - VR';document.getElementById('vr-entry-amount').value=entry.amount || 0;}else{document.getElementById('vr-entry-id').value='';document.getElementById('vr-entry-desc').value='Benefï¿½ï¿½cio - VR';document.getElementById('vr-entry-amount').value='';}try{modal.showModal();}catch(e){console.error('openVREdit showModal',e);}}catch (e){console.error('openVREdit',e);}}function closeVRModal(){try{const m=document.getElementById('vr-modal');if (m && typeof m.close==='function') m.close();}catch(e){console.error('closeVRModal',e);}}async function saveVRLedgerEntry(){try{const id=document.getElementById('vr-entry-id').value;const desc=document.getElementById('vr-entry-desc').value || 'Benefï¿½ï¿½cio - VR';const amount=parseLocaleNumber(document.getElementById('vr-entry-amount').value) || 0;const md=getCurrentMonthData();if (!Array.isArray(md.vrLedger)) md.vrLedger=[];if (id){const idx=md.vrLedger.findIndex(v=> v.id===id);if (idx > -1){md.vrLedger[idx].description=desc;md.vrLedger[idx].amount=amount;}}else{md.vrLedger.push({id: generateUUID(),description: desc,amount: amount,recurringId: null,isRecurring: false});}await storage.saveData(state.appData);closeVRModal();render();showToast('VR salvo.','bg-green-600');}catch (e){console.error('saveVRLedgerEntry',e);showToast('Falha ao salvar VR.','bg-red-600');}}function openVRUsageEdit(id){try{const md=getCurrentMonthData();const entry=(md.vrUsage || []).find(u=> u.id===id);const modal=document.getElementById('vr-usage-modal');if (!modal) return;if (entry){document.getElementById('vr-usage-id').value=entry.id || '';document.getElementById('vr-usage-desc').value=entry.description || '';document.getElementById('vr-usage-amount').value=entry.amount || 0;}else{document.getElementById('vr-usage-id').value='';document.getElementById('vr-usage-desc').value='';document.getElementById('vr-usage-amount').value='';}try{modal.showModal();}catch(e){console.error('openVRUsageEdit showModal',e);}}catch(e){console.error('openVRUsageEdit',e);}}function closeVRUsageModal(){try{const m=document.getElementById('vr-usage-modal');if (m && typeof m.close==='function') m.close();}catch(e){console.error('closeVRUsageModal',e);}}async function saveVRUsageEdit(e){try{if (e && typeof e.preventDefault==='function') e.preventDefault();const id=document.getElementById('vr-usage-id').value;const desc=document.getElementById('vr-usage-desc').value || '';const amount=parseLocaleNumber(document.getElementById('vr-usage-amount').value) || 0;const md=getCurrentMonthData();if (!Array.isArray(md.vrUsage)) md.vrUsage=[];const ledgerTotal=(Array.isArray(md.vrLedger) ? md.vrLedger.reduce((s,l)=> s + (Number(l && l.amount) || 0),0) : 0);const currentUsageExcludingThis=(md.vrUsage || []).reduce((s,u)=> s + (Number(u && u.amount) || 0),0) - ((id && md.vrUsage.find(u=> u.id===id)) ? Number(md.vrUsage.find(u=> u.id===id).amount || 0) : 0);const projectedUsage=Math.round((currentUsageExcludingThis + amount) * 100) / 100;if (projectedUsage > Math.round((ledgerTotal + Number.EPSILON) * 100) / 100){try{setTransactionError('Valor superior ao saldo disponï¿½ï¿½vel de VR para este Mï¿½s. Verifique o saldo no card de VR.');}catch(e){/* ignore */}showToast('Saldo de VR insuficiente para esta ediï¿½ï¿½o.','bg-red-600');return;}if (id){const idx=md.vrUsage.findIndex(u=> u.id===id);if (idx > -1){md.vrUsage[idx].description=desc;md.vrUsage[idx].amount=amount;}}else{md.vrUsage.push({id: generateUUID(),description: desc,amount: amount,date: new Date().toISOString()});}try{await storage.saveData(state.appData);showToast('Compra VR salva.','bg-green-600');}catch(e){console.error('saveVRUsageEdit save',e);showToast('Falha ao salvar compra VR.','bg-red-600');}closeVRUsageModal();render();}catch(e){console.error('saveVRUsageEdit',e);}}function openVTEdit(id){try{const modal=document.getElementById('vt-modal');if (!modal) return;const md=getCurrentMonthData();const entry=(md.vtLedger || []).find(v=> v.id===id) || null;if (entry){document.getElementById('vt-entry-id').value=entry.id || '';document.getElementById('vt-entry-desc').value=entry.description || 'Benefï¿½ï¿½cio - VT';document.getElementById('vt-entry-amount').value=entry.amount || 0;}else{document.getElementById('vt-entry-id').value='';document.getElementById('vt-entry-desc').value='Benefï¿½ï¿½cio - VT';document.getElementById('vt-entry-amount').value='';}try{modal.showModal();}catch(e){console.error('openVTEdit showModal',e);}}catch (e){console.error('openVTEdit',e);}}function closeVTModal(){try{const m=document.getElementById('vt-modal');if (m && typeof m.close==='function') m.close();}catch(e){console.error('closeVTModal',e);}}async function saveVTLedgerEntry(){try{const id=document.getElementById('vt-entry-id').value;const desc=document.getElementById('vt-entry-desc').value || 'Benefï¿½ï¿½cio - VT';const amount=parseLocaleNumber(document.getElementById('vt-entry-amount').value) || 0;const md=getCurrentMonthData();if (!Array.isArray(md.vtLedger)) md.vtLedger=[];if (id){const idx=md.vtLedger.findIndex(v=> v.id===id);if (idx > -1){md.vtLedger[idx].description=desc;md.vtLedger[idx].amount=amount;}}else{md.vtLedger.push({id: generateUUID(),description: desc,amount: amount,recurringId: null,isRecurring: false});}await storage.saveData(state.appData);closeVTModal();render();showToast('VT salvo.','bg-green-600');}catch (e){console.error('saveVTLedgerEntry',e);showToast('Falha ao salvar VT.','bg-red-600');}}function openVTUsageEdit(id){try{const md=getCurrentMonthData();const entry=(md.vtUsage || []).find(u=> u.id===id);const modal=document.getElementById('vt-usage-modal');if (!modal) return;if (entry){document.getElementById('vt-usage-id').value=entry.id || '';document.getElementById('vt-usage-desc').value=entry.description || '';document.getElementById('vt-usage-amount').value=entry.amount || 0;}else{document.getElementById('vt-usage-id').value='';document.getElementById('vt-usage-desc').value='';document.getElementById('vt-usage-amount').value='';}try{modal.showModal();}catch(e){console.error('openVTUsageEdit showModal',e);}}catch(e){console.error('openVTUsageEdit',e);}}function closeVTUsageModal(){try{const m=document.getElementById('vt-usage-modal');if (m && typeof m.close==='function') m.close();}catch(e){console.error('closeVTUsageModal',e);}}async function saveVTUsageEdit(e){try{if (e && typeof e.preventDefault==='function') e.preventDefault();const id=document.getElementById('vt-usage-id').value;const desc=document.getElementById('vt-usage-desc').value || '';const amount=parseLocaleNumber(document.getElementById('vt-usage-amount').value) || 0;const md=getCurrentMonthData();if (!Array.isArray(md.vtUsage)) md.vtUsage=[];const ledgerTotal=(Array.isArray(md.vtLedger) ? md.vtLedger.reduce((s,l)=> s + (Number(l && l.amount) || 0),0) : 0);const currentUsageExcludingThis=(md.vtUsage || []).reduce((s,u)=> s + (Number(u && u.amount) || 0),0) - ((id && md.vtUsage.find(u=> u.id===id)) ? Number(md.vtUsage.find(u=> u.id===id).amount || 0) : 0);const projectedUsage=Math.round((currentUsageExcludingThis + amount) * 100) / 100;if (projectedUsage > Math.round((ledgerTotal + Number.EPSILON) * 100) / 100){try{setTransactionError('Valor superior ao saldo disponï¿½ï¿½vel de VT para este Mï¿½s. Verifique o saldo no card de VT.');}catch(e){}showToast('Saldo de VT insuficiente para esta ediï¿½ï¿½o.','bg-red-600');return;}if (id){const idx=md.vtUsage.findIndex(u=> u.id===id);if (idx > -1){md.vtUsage[idx].description=desc;md.vtUsage[idx].amount=amount;}}else{md.vtUsage.push({id: generateUUID(),description: desc,amount: amount,date: new Date().toISOString()});}try{await storage.saveData(state.appData);showToast('Compra VT salva.','bg-green-600');}catch(e){console.error('saveVTUsageEdit save',e);showToast('Falha ao salvar compra VT.','bg-red-600');}closeVTUsageModal();render();}catch(e){console.error('saveVTUsageEdit',e);}}return{init,openVRUsageEdit,closeVRUsageModal,saveVRUsageEdit,saveVRLedgerEntry,closeVRModal,openVTUsageEdit,closeVTUsageModal,saveVTUsageEdit,saveVTLedgerEntry,closeVTModal,openVTEdit};})();document.addEventListener('DOMContentLoaded',()=>{try{const vrSaveBtn=document.getElementById('vr-entry-save');if (vrSaveBtn) vrSaveBtn.addEventListener('click',(e)=>{e.preventDefault();App.saveVRLedgerEntry();});const vrCancel=document.getElementById('vr-entry-cancel');if (vrCancel) vrCancel.addEventListener('click',(e)=>{e.preventDefault();document.getElementById('vr-entry-id').value='';document.getElementById('vr-entry-desc').value='';document.getElementById('vr-entry-amount').value='';});const vrClose=document.getElementById('close-vr-modal');if (vrClose) vrClose.addEventListener('click',()=> App.closeVRModal());const vruSave=document.getElementById('vr-usage-save');if (vruSave) vruSave.addEventListener('click',(e)=>{e.preventDefault();App.saveVRUsageEdit(e);});const vruCancel=document.getElementById('vr-usage-cancel');if (vruCancel) vruCancel.addEventListener('click',(e)=>{e.preventDefault();App.closeVRUsageModal();});const vruClose=document.getElementById('vr-usage-close');if (vruClose) vruClose.addEventListener('click',()=> App.closeVRUsageModal());const vruForm=document.getElementById('vr-usage-form');if (vruForm) vruForm.addEventListener('submit',(e)=>{e.preventDefault();App.saveVRUsageEdit(e);});const vrEntryForm=document.getElementById('vr-entry-form');if (vrEntryForm) vrEntryForm.addEventListener('submit',(e)=>{e.preventDefault();App.saveVRLedgerEntry();});const vtSaveBtn=document.getElementById('vt-entry-save');if (vtSaveBtn) vtSaveBtn.addEventListener('click',(e)=>{e.preventDefault();App.saveVTLedgerEntry();});const vtCancel=document.getElementById('vt-entry-cancel');if (vtCancel) vtCancel.addEventListener('click',(e)=>{e.preventDefault();document.getElementById('vt-entry-id').value='';document.getElementById('vt-entry-desc').value='';document.getElementById('vt-entry-amount').value='';});const vtClose=document.getElementById('close-vt-modal');if (vtClose) vtClose.addEventListener('click',()=> App.closeVTModal());const vtuSave=document.getElementById('vt-usage-save');if (vtuSave) vtuSave.addEventListener('click',(e)=>{e.preventDefault();App.saveVTUsageEdit(e);});const vtuCancel=document.getElementById('vt-usage-cancel');if (vtuCancel) vtuCancel.addEventListener('click',(e)=>{e.preventDefault();App.closeVTUsageModal();});const vtuClose=document.getElementById('vt-usage-close');if (vtuClose) vtuClose.addEventListener('click',()=> App.closeVTUsageModal());const vtuForm=document.getElementById('vt-usage-form');if (vtuForm) vtuForm.addEventListener('submit',(e)=>{e.preventDefault();App.saveVTUsageEdit(e);});const vtEntryForm=document.getElementById('vt-entry-form');if (vtEntryForm) vtEntryForm.addEventListener('submit',(e)=>{e.preventDefault();App.saveVTLedgerEntry();});try{const mobileFab=document.getElementById('mobile-add-transaction-fab');const desktopAddBtn=document.getElementById('add-transaction-btn');if (mobileFab && desktopAddBtn){mobileFab.addEventListener('click',(e)=>{if (window.innerWidth <=639){try{desktopAddBtn.click();}catch (err){openModal('expenses');}}else{mobileFab.style.display='none';}});}}catch(e){console.error('attach mobile FAB',e);}}catch(e){console.error('attach vr modal buttons',e);}});(function(){function initConfirmDialog(){try{const dlg=document.getElementById('confirm-dialog');const ok=document.getElementById('confirm-dialog-ok');const cancel=document.getElementById('confirm-dialog-cancel');if (!dlg || !ok || !cancel) return;ok.addEventListener('click',function(){try{dlg.returnValue='ok';dlg.close('ok');}catch(e){}});cancel.addEventListener('click',function(){try{dlg.returnValue='cancel';dlg.close('cancel');}catch(e){}});}catch(e){console.error('initConfirmDialog',e);}}if (document.readyState==='loading') document.addEventListener('DOMContentLoaded',initConfirmDialog);else initConfirmDialog();window.showConfirm=function(message,title){return new Promise(function(resolve){try{const dlg=document.getElementById('confirm-dialog');if (!dlg){resolve(window.confirm(message));return;}const body=document.getElementById('confirm-dialog-body');const titleEl=document.getElementById('confirm-dialog-title');body.textContent=message || 'Tem certeza?';if (title && titleEl) titleEl.textContent=title;dlg.showModal();function onClose(){try{resolve(dlg.returnValue==='ok');}catch(e){resolve(false);}dlg.removeEventListener('close',onClose);}dlg.addEventListener('close',onClose);}catch(e){console.error('showConfirm',e);resolve(false);}});};})();(function(){function isMobile(){return window.innerWidth <=768 || /iPhone|Android/.test(navigator.userAgent || '');}document.addEventListener('DOMContentLoaded',function(){try{const mobileNav=document.getElementById('mobile-bottom-nav');if (mobileNav && isMobile()) mobileNav.classList.remove('hidden');const actionSheet=document.getElementById('mobile-action-sheet');const masSheet=document.getElementById('mas-sheet');const masBackdrop=document.getElementById('mas-backdrop');const masCancel=document.getElementById('mas-cancel');const masNewTransaction=document.getElementById('mas-new-transaction');const masNewIncome=document.getElementById('mas-new-income');const masNewExpense=document.getElementById('mas-new-expense');const masImport=document.getElementById('mas-import');function openActionSheet(){if (!actionSheet || !masSheet) return;actionSheet.classList.add('show');masSheet.classList.add('open');document.documentElement.style.overflow='hidden';}function closeActionSheet(){if (!actionSheet || !masSheet) return;masSheet.classList.remove('open');actionSheet.classList.remove('show');document.documentElement.style.overflow='';}const fab=document.getElementById('mobile-add-transaction-fab');const addBtn=document.getElementById('add-transaction-btn');if (fab && isMobile()){fab.style.display='inline-flex';fab.setAttribute('role','button');fab.setAttribute('aria-pressed','false');fab.addEventListener('click',function(e){e.preventDefault();try{openActionSheet();}catch(err){try{if (addBtn) addBtn.click();else openModal && openModal('expenses');}catch(e){}}});}if (masCancel) masCancel.addEventListener('click',closeActionSheet);if (masBackdrop) masBackdrop.addEventListener('click',closeActionSheet);if (masNewTransaction) masNewTransaction.addEventListener('click',function(){closeActionSheet();try{if (addBtn) addBtn.click();else openModal && openModal('expenses');}catch(e){}});if (masNewIncome) masNewIncome.addEventListener('click',function(){closeActionSheet();try{const inc=document.getElementById('add-income-btn');if (inc) inc.click();else openModal && openModal('incomes');}catch(e){}});if (masNewExpense) masNewExpense.addEventListener('click',function(){closeActionSheet();try{const exp=document.getElementById('add-expense-btn');if (exp) exp.click();else openModal && openModal('expenses');}catch(e){}});if (masImport) masImport.addEventListener('click',function(){closeActionSheet();try{const imp=document.getElementById('open-import-modal-btn');if (imp) imp.click();else{const el=document.getElementById('import-spreadsheet-modal');if (el && typeof el.showModal==='function') el.showModal();}}catch(e){}});try{const nav=document.getElementById('mobile-bottom-nav');if (nav){nav.querySelectorAll('.mobile-nav-btn').forEach(b=> b.addEventListener('click',function(){const v=this.dataset.view;try{changeView(v);}catch(e){const ev=new Event('click');const el=document.querySelector(`.tab-button[data-view="${v}"]`);if (el) el.dispatchEvent(ev);}}));}}catch(e){}/* (function(){let startX=0,startY=0,startTime=0;const threshold=60;const restraint=80;const allowedTime=500;document.addEventListener('touchstart',function(e){const t=e.changedTouches[0];startX=t.pageX;startY=t.pageY;startTime=new Date().getTime();},{passive: true});document.addEventListener('touchend',function(e){try{const t=e.changedTouches[0];const distX=t.pageX - startX;const distY=t.pageY - startY;const elapsed=new Date().getTime() - startTime;if (elapsed <=allowedTime && Math.abs(distX) >=threshold && Math.abs(distY) <=restraint){if (distX < 0){const next=document.getElementById('next-month-btn');if (next) next.click();}else{const prev=document.getElementById('prev-month-btn');if (prev) prev.click();}}}catch(e){}},{passive: true});})();*/ try{document.querySelectorAll('dialog').forEach(d=>{d.addEventListener('click',function(e){if (e.target===d && isMobile()){try{d.close();}catch(_){d.removeAttribute('open');}}});});}catch(e){}try{document.body.addEventListener('focusin',function(e){if (!isMobile()) return;try{e.target.scrollIntoView({block: 'center',behavior: 'auto'});}catch(_){}});}catch(e){}try{if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) document.documentElement.classList.add('reduced-motion');}catch(e){}}catch(e){console.error('mobile-enhancements init',e);}});})();document.addEventListener('DOMContentLoaded',function(){const observerOptions={threshold: 0.1,rootMargin: '0px 0px -50px 0px'};const observer=new IntersectionObserver(function(entries){entries.forEach(entry=>{if (entry.isIntersecting){entry.target.style.opacity='1';entry.target.style.transform='translateY(0)';}});},observerOptions);function initScrollAnimations(){const animatedElements=document.querySelectorAll('.animate-slide-up,.animate-fade-in,.animate-scale-in');animatedElements.forEach(el=>{el.style.opacity='0';el.style.transform='translateY(20px)';observer.observe(el);});}function enhanceButtonFeedback(){const buttons=document.querySelectorAll('.modern-btn,.kpi-card,.modern-card');buttons.forEach(button=>{button.addEventListener('mouseenter',function(){this.style.transform='translateY(-2px)';});button.addEventListener('mouseleave',function(){this.style.transform='translateY(0)';});button.addEventListener('mousedown',function(){this.style.transform='translateY(0) scale(0.98)';});button.addEventListener('mouseup',function(){this.style.transform='translateY(-2px) scale(1)';});});}function animateNumbers(){const numbers=document.querySelectorAll('.kpi-value');numbers.forEach(numberEl=>{const observer=new IntersectionObserver(function(entries){entries.forEach(entry=>{if (entry.isIntersecting){const text=entry.target.textContent;const matches=text.match(/[\d.,]+/);if (matches){const numStr=matches[0].replace(/[.,]/g,'');const targetNum=parseInt(numStr);if (!isNaN(targetNum) && targetNum > 0){animateCounter(entry.target,0,targetNum,text);}}observer.unobserve(entry.target);}});},{threshold: 0.5});observer.observe(numberEl);});}function animateCounter(element,start,end,originalText){const formattedValue=originalText.replace(/[\d.,]+/,Math.floor(end).toLocaleString('pt-BR'));element.textContent=formattedValue;}function enhanceLoadingStates(){const tables=document.querySelectorAll('.modern-table tbody');tables.forEach(tbody=>{if (tbody.children.length===0){const skeletonRows=3;for (let i=0;i < skeletonRows;i++){const tr=document.createElement('tr');const td=document.createElement('td');td.colSpan=6;td.innerHTML='<div class="loading-shimmer h-4 rounded"></div>';tr.appendChild(td);tbody.appendChild(tr);}}});}function enhanceToasts(){const originalShowToast=window.showToast;if (originalShowToast){window.showToast=function(message,bgClass='bg-gray-800'){const toast=document.createElement('div');toast.className=`fixed top-4 right-4 z-50 p-4 rounded-lg text-white shadow-lg ${bgClass}`;toast.innerHTML=` <div class="flex items-center gap-2"> <span class="material-symbols-outlined">check_circle</span> <span>${message}</span> </div> `;document.body.appendChild(toast);setTimeout(()=>{toast.remove();},3000);};}}function enhanceSmoothScroll(){const links=document.querySelectorAll('a[href^="#"]');links.forEach(link=>{link.addEventListener('click',function(e){e.preventDefault();const target=document.querySelector(this.getAttribute('href'));if (target){target.scrollIntoView({behavior: 'auto',block: 'start'});}});});}function enhanceKeyboardNavigation(){const clickableCards=document.querySelectorAll('.kpi-card,.modern-card[onclick],.modern-card[data-click]');clickableCards.forEach(card=>{card.setAttribute('tabindex','0');card.setAttribute('role','button');card.addEventListener('keydown',function(e){if (e.key==='Enter' || e.key===' '){e.preventDefault();this.click();}});});}function isMobile(){return window.innerWidth <=768;}function optimizeForMobile(){if (isMobile()){document.documentElement.style.setProperty('--transition-normal','200ms ease');document.documentElement.style.setProperty('--transition-slow','300ms ease');document.body.classList.add('mobile-device');}}function enhanceTouchSupport(){if ('ontouchstart' in window){document.body.classList.add('touch-device');const hoverElements=document.querySelectorAll('.modern-btn,.kpi-card,.modern-card');hoverElements.forEach(el=>{el.addEventListener('touchstart',function(){this.classList.add('touch-hover');});el.addEventListener('touchend',function(){setTimeout(()=>{this.classList.remove('touch-hover');},300);});});}}try{initScrollAnimations();enhanceButtonFeedback();animateNumbers();enhanceLoadingStates();enhanceToasts();enhanceSmoothScroll();enhanceKeyboardNavigation();optimizeForMobile();enhanceTouchSupport();}catch (error){}const domObserver=new MutationObserver(function(mutations){let shouldReapply=false;mutations.forEach(mutation=>{if (mutation.type==='childList' && mutation.addedNodes.length > 0){mutation.addedNodes.forEach(node=>{if (node.nodeType===Node.ELEMENT_NODE && (node.classList?.contains('kpi-card') || node.classList?.contains('modern-card') || node.classList?.contains('modern-btn'))){shouldReapply=true;}});}});if (shouldReapply){setTimeout(()=>{initScrollAnimations();enhanceButtonFeedback();enhanceKeyboardNavigation();},100);}});domObserver.observe(document.body,{childList: true,subtree: true});});const auth=firebase.auth();auth.onAuthStateChanged(async (user)=>{const loginScreen=document.getElementById('loginScreen');const mainApp=document.getElementById('mainApp');if (user){loginScreen.style.display='none';mainApp.style.display='block';mainApp.classList.add('authenticated');if (App && typeof App.init==='function'){await App.init();}}else{loginScreen.style.display='flex';mainApp.style.display='none';mainApp.classList.remove('authenticated');}});async function handleLogin(e){e.preventDefault();const email=document.getElementById('loginEmail').value.trim();const password=document.getElementById('loginPassword').value;const loginError=document.getElementById('loginError');const loginBtn=document.getElementById('loginBtn');if (!email || !password){showLoginError('Por favor,preencha email e senha.');return;}loginBtn.disabled=true;loginBtn.textContent='Entrando...';loginError.style.display='none';try{await auth.signInWithEmailAndPassword(email,password);document.getElementById('loginEmail').value='';document.getElementById('loginPassword').value='';}catch (error){let errorMessage='Erro ao fazer login. Tente novamente.';switch (error.code){case 'auth/user-not-found': errorMessage='Usuï¿½rio nï¿½o encontrado.';break;case 'auth/wrong-password': errorMessage='Senha incorreta.';break;case 'auth/invalid-email': errorMessage='Email invï¿½lido.';break;case 'auth/user-disabled': errorMessage='Esta conta foi desabilitada.';break;case 'auth/too-many-requests': errorMessage='Muitas tentativas. Tente novamente mais tarde.';break;case 'auth/network-request-failed': errorMessage='Erro de conexï¿½o. Verifique sua internet.';break;case 'auth/invalid-credential': errorMessage='Credenciais invï¿½lidas. Verifique email e senha.';break;default: errorMessage=`Erro: ${error.message}`;}showLoginError(errorMessage);}finally{loginBtn.disabled=false;loginBtn.textContent='Entrar';}}function showLoginError(message){const loginError=document.getElementById('loginError');loginError.textContent=message;loginError.style.display='block';loginError.classList.add('show');setTimeout(()=>{loginError.classList.remove('show');},5000);}async function handleLogout(){try{await auth.signOut();}catch (error){alert('Erro ao fazer logout. Tente novamente.');}}window.addEventListener('DOMContentLoaded',()=>{const loginBtn=document.getElementById('loginBtn');if (loginBtn){loginBtn.addEventListener('click',handleLogin);}const loginEmail=document.getElementById('loginEmail');const loginPassword=document.getElementById('loginPassword');if (loginEmail){loginEmail.addEventListener('keypress',(e)=>{if (e.key==='Enter'){e.preventDefault();handleLogin(e);}});}if (loginPassword){loginPassword.addEventListener('keypress',(e)=>{if (e.key==='Enter'){e.preventDefault();handleLogin(e);}});}const logoutBtn=document.getElementById('logoutBtn');if (logoutBtn){logoutBtn.addEventListener('click',handleLogout);}});