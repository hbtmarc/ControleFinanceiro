        <style>
        /* ===== BARRAS DE ROLAGEM PERSONALIZADAS ===== */
        /* Estilização global para todas as barras de rolagem */
        * {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }
        
        /* Webkit browsers (Chrome, Safari, Edge) */
        *::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        *::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        
        *::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #cbd5e1 0%, #94a3b8 100%);
            border-radius: 10px;
            border: 2px solid #f1f5f9;
            transition: all 0.3s ease;
        }
        
        *::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #94a3b8 0%, #64748b 100%);
            border-color: #e2e8f0;
        }
        
        *::-webkit-scrollbar-thumb:active {
            background: linear-gradient(180deg, #64748b 0%, #475569 100%);
        }
        
        /* Barras de rolagem para modais e dialogs */
        dialog::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        dialog::-webkit-scrollbar-track {
            background: #f8fafc;
            border-radius: 10px;
        }
        
        dialog::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 10px;
            border: 2px solid #f8fafc;
        }
        
        dialog::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #2563eb 0%, #1d4ed8 100%);
        }
        
        /* Barras de rolagem para tabelas */
        .overflow-x-auto::-webkit-scrollbar,
        .overflow-y-auto::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .overflow-x-auto::-webkit-scrollbar-thumb,
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #10b981 0%, #059669 100%);
            border-radius: 6px;
        }
        
        .overflow-x-auto::-webkit-scrollbar-thumb:hover,
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #059669 0%, #047857 100%);
        }
        /* ===== FIM DAS BARRAS DE ROLAGEM ===== */
        
        /* Animação de foco nos inputs */
        .modal-group input:focus, .modal-group select:focus {
            box-shadow: 0 0 0 2px #2563eb44;
            transition: box-shadow 0.2s;
        }
        /* Botão de ação destacado */
        .modal-action-btn {
            color: #fff;
            font-weight: 600;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px #2563eb22;
            padding: 0.75rem 2.5rem;
            font-size: 1.15rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.2s, box-shadow 0.2s;
            background-color: #e5e7eb;
            opacity: 1;
        }
        /* Deterministic save button type classes */
        .modal-action-btn.save-type-expenses {
            background-color: #dc2626 !important; /* red */
            border: 2px solid #b91c1c !important;
            box-shadow: 0 2px 10px #dc262644 !important;
            color: #fff !important;
        }
        .modal-action-btn.save-type-incomes {
            background-color: #16a34a !important; /* green */
            border: 2px solid #15803d !important;
            box-shadow: 0 2px 10px #16a34a44 !important;
            color: #fff !important;
        }
        .modal-action-btn.save-type-reserve {
            background-color: #eab308 !important; /* yellow */
            border: 2px solid #d6a013 !important;
            box-shadow: 0 2px 10px #eab30844 !important;
            color: #111827 !important;
        }
        /* Keep colors when disabled */
        .modal-action-btn.save-type-expenses:disabled,
        .modal-action-btn.save-type-expenses[disabled] {
            background-color: #dc2626 !important;
            border-color: #b91c1c !important;
            box-shadow: 0 2px 10px #dc262644 !important;
            color: #fff !important;
            opacity: 1 !important;
        }
        .modal-action-btn.save-type-incomes:disabled,
        .modal-action-btn.save-type-incomes[disabled] {
            background-color: #16a34a !important;
            border-color: #15803d !important;
            box-shadow: 0 2px 10px #16a34a44 !important;
            color: #fff !important;
            opacity: 1 !important;
        }
        .modal-action-btn.save-type-reserve:disabled,
        .modal-action-btn.save-type-reserve[disabled] {
            background-color: #eab308 !important;
            border-color: #d6a013 !important;
            box-shadow: 0 2px 10px #eab30844 !important;
            color: #111827 !important;
            opacity: 1 !important;
        }

        /* ID-specific rules with higher specificity to override other styles */
        #modal-save-btn.save-type-expenses,
        #modal-save-btn.save-type-expenses[disabled] {
            background-color: #dc2626 !important;
            border-color: #b91c1c !important;
            box-shadow: 0 2px 10px #dc262644 !important;
            color: #fff !important;
            opacity: 1 !important;
        }
        #modal-save-btn.save-type-incomes,
        #modal-save-btn.save-type-incomes[disabled] {
            background-color: #16a34a !important;
            border-color: #15803d !important;
            box-shadow: 0 2px 10px #16a34a44 !important;
            color: #fff !important;
            opacity: 1 !important;
        }
        #modal-save-btn.save-type-reserve,
        #modal-save-btn.save-type-reserve[disabled] {
            background-color: #eab308 !important;
            border-color: #d6a013 !important;
            box-shadow: 0 2px 10px #eab30844 !important;
            color: #111827 !important;
            opacity: 1 !important;
        }
        /* Force native appearance off and clip background to avoid gradient leaks */
        #modal-save-btn {
            -webkit-appearance: none !important;
            appearance: none !important;
            background-clip: padding-box !important;
            -webkit-background-clip: padding-box !important;
        }
        .modal-action-btn:disabled {
            cursor: not-allowed;
        }
        .modal-action-btn:hover {
            box-shadow: 0 4px 16px #2563eb33;
            filter: brightness(0.95);
        }
        /* Tooltip */
        .modal-tooltip {
            position: relative;
            cursor: help;
        }
        .modal-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            top: 110%;
            transform: translateX(-50%);
            background: #1e293b;
            color: #fff;
            padding: 0.3em 0.7em;
            border-radius: 0.5em;
            font-size: 0.85em;
            white-space: nowrap;
            z-index: 10;
        }
        /* Transaction modal spacing adjustments for a more airy layout */
    #transaction-modal .modal-title-row { padding: 0.5rem 0.75rem; }
    /* Increased bottom padding so the save button fits inside the modal without overlapping content */
    #transaction-modal form { padding: 0.5rem 0.75rem 3.5rem 0.75rem; }
        #transaction-modal .modal-group { padding: 0.9rem; }
        #transaction-modal .flex.justify-end { padding: 0.75rem 0.5rem 0 0; }
        @media (max-width: 639px) {
            /* On narrow screens keep modal full-bleed and allow page scrolling instead of inner scroll */
            #transaction-modal { width: 100vw !important; left: 0 !important; right: 0 !important; max-width: 100vw !important; border-radius: 0.75rem !important; }
            #transaction-modal { padding: 1rem !important; }
            #transaction-modal .modal-group { padding: 0.75rem !important; }
        }
        /* Select icon helper: leaves space and positions an icon inside select */
        .select-with-icon { position: relative; }
        .select-with-icon .select-icon {
            position: absolute; left: 10px; top: 50%; transform: translateY(-50%); pointer-events: none; font-size: 1.05rem; opacity: 0.95;
        }
        /* Custom icon-enabled select (replaces native dropdown visually but keeps native select hidden for form semantics) */
        .icon-select { position: relative; display: inline-block; width: 100%; }
        .icon-select-button {
            display: flex; align-items: center; gap: 0.5rem; width: 100%; text-align: left; padding: .5rem .75rem; border: 1px solid #e5e7eb; background: white; border-radius: .5rem; cursor: pointer;
        }
        .icon-select-button .material-symbols-outlined { font-size: 18px; margin-right: 6px; color: #6b7280; }
        .icon-select-list { position: absolute; left: 0; right: 0; z-index: 50; background: white; border: 1px solid rgba(0,0,0,0.06); box-shadow: 0 6px 18px rgba(2,6,23,0.08); border-radius: 8px; margin-top: 6px; max-height: 260px; overflow: auto; }
        .icon-select-list.hidden { display: none; }
        .icon-select-item { display:flex; align-items:center; gap:0.5rem; padding: 0.55rem .75rem; cursor: pointer; }
        .icon-select-item:hover { background: #f8fafc; }
        .icon-select-item .material-symbols-outlined { font-size: 18px; color: #6b7280; }
        /* Entradas table specific styling: keep rows single-line and prevent action icons from wrapping */
        #income-table td, #income-table th {
            white-space: nowrap;
            vertical-align: middle;
        }
        /* Make first column (description) truncate with ellipsis and take remaining space */
        #income-table td:first-child { 
            min-width: 0; 
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Make value column (second column) display full values without truncation */
        #income-table td:nth-child(2), #income-table th:nth-child(2) {
            overflow: visible;
            text-overflow: clip;
            white-space: nowrap;
            text-align: right;
            font-weight: 600;
        }
    /* Keep actions cell compact and keep icons on one line; width adjusted so both icons fit */
    #income-table td:last-child, #income-table th:last-child { 
        width: 80px; 
        text-align: right;
        padding-right: 8px !important;
    }
    /* Ensure actions cell content is not truncated with ellipsis */
    #income-table td.actions-cell, #income-table th.actions-cell { 
        overflow: visible; 
        text-overflow: clip; 
        white-space: nowrap;
        display: flex !important;
        justify-content: flex-end !important;
        align-items: center !important;
        gap: 2px !important;
        padding-right: 8px !important;
    }
    #income-table td.actions-cell .edit-btn, #income-table td.actions-cell .delete-btn, #income-table td.actions-cell button { 
        display: inline-flex !important; 
        align-items: center !important; 
        justify-content: center !important; 
        padding: 0.25rem !important;
        width: 32px !important;
        height: 32px !important;
        margin: 0 !important;
    }
    
    /* Estilos consistentes para todas as outras tabelas - Despesas e Poupanças */
    .modern-table td.actions-cell, .modern-table th.actions-cell,
    #expenses-table td.actions-cell, #expenses-table th.actions-cell,
    #savings-table td.actions-cell, #savings-table th.actions-cell { 
        display: flex !important;
        justify-content: flex-end !important;
        align-items: center !important;
        gap: 2px !important;
        overflow: visible !important;
        text-overflow: clip !important;
        white-space: nowrap !important;
        padding-right: 8px !important;
    }
    
    .modern-table td.actions-cell .edit-btn, .modern-table td.actions-cell .delete-btn, .modern-table td.actions-cell button,
    #expenses-table td.actions-cell .edit-btn, #expenses-table td.actions-cell .delete-btn, #expenses-table td.actions-cell button,
    #savings-table td.actions-cell .edit-btn, #savings-table td.actions-cell .delete-btn, #savings-table td.actions-cell button { 
        display: inline-flex !important; 
        align-items: center !important; 
        justify-content: center !important; 
        padding: 0.25rem !important;
        width: 32px !important;
        height: 32px !important;
        border-radius: 4px !important;
        transition: all 0.2s ease !important;
        margin: 0 !important;
    }
    
    /* Ajuste específico para a coluna de ações na tabela de despesas */
    #expenses-table td:last-child, #expenses-table th:last-child {
        width: 80px;
        text-align: right;
        padding-right: 8px !important;
    }
    
    /* Toast sempre acima de tudo - z-index máximo */
    #toast {
        z-index: 2147483647 !important;
        position: fixed !important;
    }
    
    /* Estilos baseados em classes JavaScript de detecção mobile */
    .is-touch button:hover,
    .is-touch .btn:hover {
        /* Remove efeitos hover em dispositivos touch para melhor performance */
        background-color: inherit;
    }
    
    .is-mobile {
        /* Ajustes globais para mobile */
        font-size: 16px; /* Previne zoom no iOS */
    }
    
    .is-smartphone dialog {
        /* Modais em tela cheia em smartphones */
        border-radius: 0 !important;
    }
    
    /* Altura do viewport corrigida para iOS */
    .is-mobile dialog,
    .is-mobile .modal {
        max-height: calc(var(--vh, 1vh) * 100) !important;
    }
        </style>
        <style>
        /* Modal mobile layout fixes: ensure modal content stacks and buttons fit on small screens */
        @media (max-width: 639px) {
            #transaction-modal { padding: 0.75rem !important; border-radius: 0.75rem !important; }
            #transaction-modal .modal-group { padding: 0.6rem !important; }
            #transaction-modal form { max-width: 100% !important; padding: 0.6rem !important; }
            /* Stack the modal-type toggles horizontally in small buttons to save space */
            .modal-type-toggle { padding: 0.5rem !important; gap: 6px !important; }
            .modal-type-toggle span.text-sm { font-size: 0.85rem !important; }
            /* Make inputs full width and avoid extra right padding that pushed elements off-screen */
            #transaction-modal input, #transaction-modal select, #transaction-modal textarea { width: 100% !important; box-sizing: border-box !important; }
            /* Ensure advanced option checkboxes layout in column for narrow screens */
            #advanced-options .flex { flex-direction: column !important; }
            /* Make save button full-width and pinned at bottom with comfortable margin */
            #transaction-modal .modal-footer { position: sticky; bottom: 0; background: linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,1)); padding-top: 0.75rem; margin-top: 0.5rem; }
            #modal-save-btn { width: 100% !important; display: inline-flex; justify-content: center; }
            /* Reduce card shadows and borders to keep content readable on tiny screens */
            #transaction-modal .card { box-shadow: none !important; border: none !important; }
        }
        /* Visible focus ring improvements for keyboard users */
        #transaction-modal :focus { outline: 3px solid rgba(59,130,246,0.25); outline-offset: 2px; }
        /* Make inputs inside installments/financing cards cleaner by removing extra bottom borders */
        #installments-section .bg-white input, #installments-section .bg-white select, #installments-section .bg-white textarea {
            border-bottom: none !important;
        }
        /* Show both cards but low-opacity by default; when .active is set, make them fully opaque */
        #installments-fields, #financing-fields {
            opacity: 0.1;
            transition: opacity 160ms ease-in-out, box-shadow 160ms ease-in-out;
            pointer-events: none; /* prevent interaction when not active */
        }
        #installments-fields.active, #financing-fields.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Make placeholder / input text inside the small cards low-opacity until user types */
        #installments-fields input, #financing-fields input {
            color: rgba(17,24,39,0.10); /* very light text for placeholders/initial state */
            transition: color 120ms ease;
        }
        #installments-fields input::placeholder, #financing-fields input::placeholder {
            color: rgba(17,24,39,0.12);
            opacity: 1; /* use explicit color above */
        }
        /* If the input has a value (placeholder not shown) show full opacity text */
        #installments-fields input:not(:placeholder-shown), #financing-fields input:not(:placeholder-shown) {
            color: #111827;
        }
        /* Fallback when :placeholder-shown isn't available: use .has-value class toggled by JS */
        #installments-fields input.has-value, #financing-fields input.has-value { color: #111827 !important; }
        /* Animated show/hide for advanced option rows (tighter spacing) */
        #advanced-options .option-row {
            overflow: hidden;
            transition: opacity 220ms cubic-bezier(.22,.9,.25,1), max-height 260ms cubic-bezier(.22,.9,.25,1), margin 180ms ease, padding 180ms ease, transform 220ms ease;
            opacity: 1;
            max-height: 56px; /* enough to contain a label */
            margin: 0.25rem 0; /* tighter spacing */
            padding: 0.25rem 0.15rem;
            display: block;
            transform: translateY(0);
            background: transparent !important;
        }
        #advanced-options .option-row.option-collapsed {
            opacity: 0;
            max-height: 0 !important;
            margin: 0 !important;
            padding-top: 0 !important; padding-bottom: 0 !important;
            pointer-events: none;
            transform: translateY(-4px);
        }
        /* Ensure label inside option-row has no border/shadow and is vertically centered */
        #advanced-options .option-row label {
            display: flex; align-items: center; gap: 0.45rem; width: 100%; background: transparent !important; border: none !important; box-shadow: none !important; padding: 0.1rem 0.4rem;
            line-height: 1.15;
        }
        #advanced-options .option-row label span.ml-2 { line-height: 1.15; }
        /* Avoid accidental underlines or after pseudo-elements affecting option rows */
        #advanced-options .option-row label::after, #advanced-options .option-row label::before { content: none !important; }
        /* Reduce the gap used by the flex column container inside advanced options */
        #advanced-options .flex.flex-col.gap-2 { gap: 0.35rem !important; }

        /* ===== MELHORIAS UX/UI PARA CUSTOS TOTAIS - PLANEJADORA DE VIAGENS ===== */
        
        /* Sistema de Abas da Planejadora */
        .travel-planner-tabs-container {
            background: #fff;
            border-radius: 12px 12px 0 0;
            border: 1px solid #e2e8f0;
            border-bottom: none;
            overflow: hidden;
        }

        .travel-planner-tabs {
            display: flex;
            background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
            border-bottom: 2px solid #e2e8f0;
            overflow-x: hidden; /* Removido auto para nunca mostrar scroll */
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            flex-wrap: nowrap; /* Garante que as abas fiquem em uma linha */
        }

        .travel-tab {
            flex: 1 1 0%; /* Distribui igualmente o espaço */
            min-width: 0; /* Permite que as abas encolham */
            padding: 10px 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #64748b;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .travel-tab:hover {
            background: rgba(59, 130, 246, 0.05);
            color: #3b82f6;
        }

        .travel-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .travel-tab .material-symbols-outlined {
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .travel-tab span:not(.material-symbols-outlined) {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .travel-tab-content {
            display: none;
        }

        .travel-tab-content.active {
            display: block;
        }

        /* Container principal da seção de custos totais */
        .travel-planner-costs {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Título da seção de custos */
        .travel-costs-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .travel-costs-title::before {
            content: "💰";
            font-size: 20px;
        }

        /* KPIs principais - melhor distribuição */
        .travel-kpis-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            border: 1px solid #f1f5f9;
        }

        .travel-kpi-item {
            text-align: center;
            padding: 16px 12px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .travel-kpi-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }

        .travel-kpi-item:hover::before {
            transform: translateX(0);
        }

        .travel-kpi-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.1);
        }

        .travel-kpi-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            margin-bottom: 6px;
        }

        .travel-kpi-value {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .travel-kpi-description {
            font-size: 10px;
            color: #94a3b8;
            line-height: 1.3;
            min-height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        /* Cores específicas para cada KPI */
        .travel-kpi-item.estimated .travel-kpi-value {
            color: #3b82f6;
        }

        .travel-kpi-item.realized .travel-kpi-value {
            color: #10b981;
        }

        .travel-kpi-item.paid .travel-kpi-value {
            color: #8b5cf6;
        }

        /* Barra de progresso aprimorada */
        .travel-progress-container {
            margin: 24px 0;
            padding: 16px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            border: 1px solid #f1f5f9;
        }

        .travel-progress-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .travel-progress-bar {
            width: 100%;
            height: 12px;
            background: #f1f5f9;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .travel-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #34d399 50%, #6ee7b7 100%);
            border-radius: 8px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .travel-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: progressShimmer 2s infinite;
        }

        @keyframes progressShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Blocos de custos melhorados */
        .travel-cost-blocks {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        .travel-cost-block {
            padding: 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .travel-cost-block:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px -2px rgba(59, 130, 246, 0.15);
        }

        .travel-cost-block-label {
            font-size: 10px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 4px;
        }

        .travel-cost-block-value {
            font-size: 14px;
            font-weight: 700;
            color: #1e293b;
        }

        /* Resumo final melhorado */
        .travel-final-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 24px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .travel-summary-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #f1f5f9;
        }

        .travel-summary-item.costs .travel-kpi-value {
            color: #ef4444;
        }

        .travel-summary-item.remaining .travel-kpi-value {
            color: #10b981;
            font-size: 18px;
        }

        /* Responsividade mobile */
        @media (max-width: 640px) {
            .travel-planner-costs {
                padding: 16px;
                margin: 8px;
                border-radius: 12px;
            }

            .travel-kpis-container {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 12px;
            }

            .travel-kpi-item {
                padding: 12px 8px;
            }

            .travel-kpi-value {
                font-size: 14px;
            }

            .travel-cost-blocks {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .travel-final-summary {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .travel-progress-container {
                padding: 12px;
            }
            
            /* Abas responsivas em mobile */
            .travel-tab {
                min-width: 70px;
                padding: 8px 4px;
                font-size: 10px;
                flex-direction: column;
                gap: 2px;
            }
            
            .travel-tab span:not(.material-symbols-outlined) {
                font-size: 9px;
            }
            
            .travel-tab .material-symbols-outlined {
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .travel-cost-blocks {
                grid-template-columns: 1fr;
            }
            
            .travel-kpis-container {
                padding: 8px;
            }
            
            .travel-kpi-item {
                padding: 10px 6px;
            }
            
            /* Modal do planejador de viagens em mobile */
            #travel-planner-modal {
                width: 95vw !important;
                max-width: 95vw !important;
                margin: 10px auto;
                padding: 0;
            }
            
            #travel-planner-modal > div:first-child {
                padding: 12px;
            }
            
            .travel-planner-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none; /* Firefox */
                -ms-overflow-style: none;  /* IE and Edge */
            }
            
            .travel-planner-tabs::-webkit-scrollbar {
                display: none; /* Chrome, Safari, Opera */
            }
        }

        /* ===== SISTEMA DE DESIGN MODERNO - UX/UI COMPLETO ===== */
        
        /* Variáveis CSS para consistência do design */
        :root {
            /* Cores principais */
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            
            /* Cores semânticas melhoradas */
            --success-50: #f0fdf4;
            --success-100: #dcfce7;
            --success-500: #22c55e;
            --success-600: #16a34a;
            --success-700: #15803d;
            
            --warning-50: #fffbeb;
            --warning-100: #fef3c7;
            --warning-500: #f59e0b;
            --warning-600: #d97706;
            
            --error-50: #fef2f2;
            --error-100: #fee2e2;
            --error-500: #ef4444;
            --error-600: #dc2626;
            
            /* Cores neutras */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Sombras modernas */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            /* Raios de borda */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            
            /* Espaçamentos */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            
            /* Transições */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ===== CARDS MODERNOS ===== */
        .modern-card {
            background: linear-gradient(145deg, #ffffff 0%, #fafbfc 100%);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .modern-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
            transform: translateX(-100%);
            transition: transform var(--transition-normal);
        }

        .modern-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
            border-color: var(--gray-300);
        }

        .modern-card:hover::before {
            transform: translateX(0);
        }

        /* KPI Cards melhorados */
        .kpi-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, var(--primary-100), var(--primary-50));
            border-radius: 50%;
            transform: translate(30px, -30px);
            opacity: 0.6;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-300);
        }

        .kpi-card .kpi-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--spacing-sm);
        }

        .kpi-card .kpi-value {
            font-size: 1.875rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: var(--spacing-xs);
            position: relative;
            z-index: 1;
        }

        .kpi-card .kpi-trend {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Cores específicas dos KPIs */
        .kpi-income {
            border-left: 4px solid var(--success-500);
        }

        .kpi-income .kpi-value {
            color: var(--success-600);
        }

        .kpi-income::after {
            background: linear-gradient(45deg, var(--success-100), var(--success-50));
        }

        .kpi-expenses {
            border-left: 4px solid var(--error-500);
        }

        .kpi-expenses .kpi-value {
            color: var(--error-600);
        }

        .kpi-expenses::after {
            background: linear-gradient(45deg, var(--error-100), var(--error-50));
        }

        .kpi-savings {
            border-left: 4px solid var(--primary-500);
        }

        .kpi-savings .kpi-value {
            color: var(--primary-600);
        }

        .kpi-savings::after {
            background: linear-gradient(45deg, var(--primary-100), var(--primary-50));
        }

        .kpi-balance {
            border-left: 4px solid var(--gray-500);
        }

        .kpi-balance .kpi-value {
            color: var(--gray-700);
        }

        .kpi-balance::after {
            background: linear-gradient(45deg, var(--gray-100), var(--gray-50));
        }

        /* ===== TABELAS MODERNAS ===== */
        .modern-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .modern-table thead {
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
        }

        .modern-table th {
            padding: var(--spacing-md) var(--spacing-lg);
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--gray-700);
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .modern-table td {
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--gray-100);
            vertical-align: middle;
            transition: background-color var(--transition-fast);
        }

        .modern-table tbody tr:hover {
            background-color: var(--gray-50);
        }

        .modern-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* ===== BOTÕES MODERNOS ===== */
        .modern-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            font-weight: 600;
            font-size: 0.875rem;
            border-radius: var(--radius-md);
            border: 1px solid transparent;
            transition: all var(--transition-fast);
            cursor: pointer;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .modern-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: translateX(-100%);
            transition: transform var(--transition-normal);
        }

        .modern-btn:hover::before {
            transform: translateX(100%);
        }

        .modern-btn-primary {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .modern-btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .modern-btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border-color: var(--gray-300);
        }

        .modern-btn-secondary:hover {
            background: var(--gray-200);
            border-color: var(--gray-400);
            transform: translateY(-1px);
        }

        .modern-btn-success {
            background: linear-gradient(135deg, var(--success-500), var(--success-600));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .modern-btn-success:hover {
            background: linear-gradient(135deg, var(--success-600), var(--success-700));
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .modern-btn-danger {
            background: linear-gradient(135deg, var(--error-500), var(--error-600));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .modern-btn-danger:hover {
            background: linear-gradient(135deg, var(--error-600), #b91c1c);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        /* ===== INPUTS MODERNOS ===== */
        .modern-input {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            transition: all var(--transition-fast);
            background: white;
            color: var(--gray-800);
        }

        .modern-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px var(--primary-100);
        }

        .modern-input::placeholder {
            color: var(--gray-400);
        }

        .modern-input-group {
            position: relative;
        }

        .modern-input-icon {
            position: absolute;
            left: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            pointer-events: none;
        }

        .modern-input-group .modern-input {
            padding-left: 2.5rem;
        }

        /* ===== BADGES E INDICATORS ===== */
        .modern-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: var(--radius-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .modern-badge-success {
            background: var(--success-100);
            color: var(--success-700);
        }

        .modern-badge-warning {
            background: var(--warning-100);
            color: var(--warning-700);
        }

        .modern-badge-error {
            background: var(--error-100);
            color: var(--error-700);
        }

        .modern-badge-info {
            background: var(--primary-100);
            color: var(--primary-700);
        }

        /* ===== ANIMAÇÕES GLOBAIS ===== */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-slide-up {
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .animate-scale-in {
            animation: scaleIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* ===== RESPONSIVIDADE APRIMORADA ===== */
        @media (max-width: 640px) {
            .kpi-card {
                padding: var(--spacing-md);
            }
            
            .kpi-card .kpi-value {
                font-size: 1.5rem;
            }
            
            .modern-table th,
            .modern-table td {
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: 0.8rem;
            }
            
            .modern-btn {
                padding: var(--spacing-sm);
                font-size: 0.8rem;
            }
        }

        /* ===== GRÁFICOS E VISUALIZAÇÕES MODERNOS ===== */
        .modern-chart-container {
            background: linear-gradient(145deg, #ffffff 0%, #fafbfc 100%);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .modern-chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-500), var(--success-500), var(--warning-500));
        }

        .modern-chart-header {
            display: flex;
            align-items: center;
            justify-content: between;
            margin-bottom: var(--spacing-lg);
        }

        .modern-chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .modern-chart-subtitle {
            font-size: 0.875rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .chart-canvas-wrapper {
            position: relative;
            padding: var(--spacing-md);
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* ===== MICROINTERAÇÕES E ANIMAÇÕES ===== */
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .pulse-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        .success-pulse { background-color: var(--success-500); }
        .error-pulse { background-color: var(--error-500); }
        .warning-pulse { background-color: var(--warning-500); }

        /* Feedback visual para ações do usuário */
        .success-feedback {
            background: var(--success-50);
            border: 1px solid var(--success-200);
            color: var(--success-800);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            animation: slideUp 0.3s ease-out;
        }

        .error-feedback {
            background: var(--error-50);
            border: 1px solid var(--error-200);
            color: var(--error-800);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            animation: slideUp 0.3s ease-out;
        }

        /* ===== NAVEGAÇÃO MOBILE APRIMORADA ===== */
        .modern-fab {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            border: none;
            border-radius: 50%;
            box-shadow: var(--shadow-xl);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1000;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modern-fab:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px -8px var(--primary-500);
        }

        .modern-fab:active {
            transform: translateY(0) scale(0.95);
        }

        .modern-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border-top: 1px solid var(--gray-200);
            padding: var(--spacing-sm) var(--spacing-md);
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .modern-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            text-decoration: none;
            color: var(--gray-600);
        }

        .modern-nav-item:hover,
        .modern-nav-item.active {
            background: var(--primary-50);
            color: var(--primary-600);
            transform: translateY(-1px);
        }

        .modern-nav-item .material-symbols-outlined {
            font-size: 1.25rem;
        }

        .modern-nav-item span {
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* ===== ACESSIBILIDADE APRIMORADA ===== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .focus-visible:focus {
            outline: 2px solid var(--primary-500);
            outline-offset: 2px;
        }

        /* Estados de loading melhorados */
        .loading-state {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-xl);
            color: var(--gray-500);
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-200);
            border-top: 2px solid var(--primary-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== RESPONSIVIDADE GLOBAL MELHORADA ===== */
        @media (max-width: 1024px) {
            .modern-card {
                padding: var(--spacing-md);
            }
            
            .kpi-card {
                padding: var(--spacing-md);
            }
        }

        @media (max-width: 768px) {
            .modern-chart-container {
                padding: var(--spacing-md);
            }
            
            .modern-chart-title {
                font-size: 1rem;
            }
            
            .modern-fab {
                bottom: 5rem;
                right: 1rem;
                width: 56px;
                height: 56px;
            }
        }

        @media (max-width: 640px) {
            :root {
                --spacing-xs: 0.125rem;
                --spacing-sm: 0.375rem;
                --spacing-md: 0.75rem;
                --spacing-lg: 1rem;
                --spacing-xl: 1.25rem;
            }
            
            .modern-card {
                border-radius: var(--radius-lg);
                margin: var(--spacing-xs);
            }
            
            .kpi-card {
                padding: var(--spacing-sm);
            }
            
            .kpi-card .kpi-value {
                font-size: 1.5rem;
            }
        }

        /* ===== ESTILOS PARA DISPOSITIVOS TOUCH ===== */
        .touch-device .modern-btn.touch-hover,
        .touch-device .kpi-card.touch-hover,
        .touch-device .modern-card.touch-hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        /* ===== MELHORIAS DE PERFORMANCE MOBILE ===== */
        .mobile-device .animate-slide-up,
        .mobile-device .animate-fade-in,
        .mobile-device .animate-scale-in {
            animation-duration: 0.3s;
        }

        .mobile-device .modern-btn::before,
        .mobile-device .kpi-card::after {
            display: none; /* Remove animações complexas em mobile */
        }

        /* ===== ESTADOS DE FOCO MELHORADOS ===== */
        .modern-btn:focus-visible,
        .kpi-card:focus-visible,
        .modern-card:focus-visible {
            outline: 2px solid var(--primary-500);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px var(--primary-100);
        }

        /* ===== SKELETON LOADING ===== */
        .loading-shimmer {
            background: linear-gradient(90deg, 
                var(--gray-200) 25%, 
                var(--gray-100) 50%, 
                var(--gray-200) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-sm);
        }
        </style>
        <style>
        /* Salary breakdown tooltip card */
        .salary-tooltip {
            position: absolute;
            z-index: 99999;
            min-width: 260px;
            max-width: 360px;
            background: linear-gradient(180deg, #ffffff, #fbfdff);
            border: 1px solid rgba(16,24,40,0.06);
            box-shadow: 0 10px 30px rgba(2,6,23,0.12);
            border-radius: 12px;
            padding: 12px 14px;
            color: #0f172a;
            display: none;
            font-size: 0.95rem;
        }
        .salary-tooltip h4 { margin: 0 0 6px 0; font-size: 0.98rem; font-weight: 700; color: #0f172a; }
        .salary-tooltip .row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; }
        .salary-tooltip .label { color: #6b7280; font-weight: 600; }
        .salary-tooltip .value { font-weight: 700; }
        .salary-tooltip .value.negative { color: #dc2626; }
        .salary-tooltip .value.positive { color: #16a34a; }
        .salary-tooltip .divider { height: 1px; background: rgba(0,0,0,0.04); margin: 8px 0; border-radius: 1px; }
        .salary-tooltip .summary { display:flex; align-items:center; gap:8px; }
        
        /* ===== MOBILE OTIMIZADO - CENTRALIZADO E SEM SOBREPOSIÇÃO ===== */
        
        @media (max-width: 768px) {
            /* Reset básico para mobile */
            * {
                box-sizing: border-box !important;
            }
            
            html, body {
                overflow-x: hidden !important;
                width: 100% !important;
                max-width: 100vw !important;
            }
            
            body {
                padding: 0 !important;
                margin: 0 !important;
                padding-bottom: 70px !important;
            }
            
            /* Container principal centralizado */
            body > div,
            #app,
            main,
            .container {
                width: 100% !important;
                max-width: 100vw !important;
                padding: 0.75rem !important;
                margin: 0 auto !important;
                overflow-x: hidden !important;
            }
            
            /* Modais centralizados e responsivos */
            dialog {
                position: fixed !important;
                width: 90vw !important;
                max-width: 90vw !important;
                max-height: 85vh !important;
                padding: 1rem !important;
                border-radius: 0.75rem !important;
                overflow-y: auto !important;
                left: 50% !important;
                top: 50% !important;
                transform: translate(-50%, -50%) !important;
                margin: 0 !important;
                box-sizing: border-box !important;
            }
            
            /* Cards perfeitamente centralizados */
            .card,
            .modern-card {
                width: calc(100% - 1.5rem) !important;
                max-width: calc(100% - 1.5rem) !important;
                padding: 1rem !important;
                margin: 0 auto 1rem auto !important;
                overflow: hidden !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                box-sizing: border-box !important;
            }
            
            /* Headers de cards sem sobreposição */
            .modern-card h2,
            .card h2 {
                font-size: 1.125rem !important;
                margin-bottom: 0.75rem !important;
                line-height: 1.4 !important;
                word-wrap: break-word !important;
            }
            
            /* Conteúdo de cards centralizado */
            .modern-card > *,
            .card > * {
                max-width: 100% !important;
                margin-left: auto !important;
                margin-right: auto !important;
            }
            
            /* Flex items sem sobreposição */
            .flex {
                flex-wrap: wrap !important;
                gap: 0.5rem !important;
                max-width: 100% !important;
            }
            
            .flex > * {
                min-width: 0 !important;
                flex-shrink: 1 !important;
            }
            
            /* Grid centralizado */
            .grid {
                display: flex !important;
                flex-direction: column !important;
                gap: 1rem !important;
                align-items: center !important;
                width: 100% !important;
            }
            
            .grid > * {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* KPI Cards perfeitamente centralizados */
            [class*="kpi"],
            .kpi-card {
                width: calc(100% - 1.5rem) !important;
                max-width: calc(100% - 1.5rem) !important;
                margin: 0 auto 0.75rem auto !important;
                padding: 1rem !important;
                text-align: center !important;
                box-sizing: border-box !important;
            }
            
            /* KPI VR/VT cards específicos */
            #kpi-vr-card,
            #kpi-vt-card {
                width: calc(100% - 1.5rem) !important;
                max-width: calc(100% - 1.5rem) !important;
                margin: 0 auto 0.75rem auto !important;
                padding: 0.75rem !important;
                box-sizing: border-box !important;
            }
            
            #kpi-vr-card .flex,
            #kpi-vt-card .flex {
                flex-wrap: nowrap !important;
                align-items: center !important;
                justify-content: space-between !important;
                gap: 0.5rem !important;
            }
            
            #kpi-vr-card h4,
            #kpi-vt-card h4 {
                font-size: 0.75rem !important;
                text-align: left !important;
                margin: 0 !important;
            }
            
            #kpi-vr-values,
            #kpi-vt-values {
                font-size: 0.875rem !important;
                text-align: right !important;
                white-space: nowrap !important;
            }
            
            #kpi-vr-card .mt-2,
            #kpi-vt-card .mt-2 {
                margin-top: 0.5rem !important;
                width: 100% !important;
            }
            
            #kpi-vr-progress,
            #kpi-vt-progress {
                min-width: 0 !important;
                max-width: 100% !important;
            }
            
            #kpi-vr-bar-text,
            #kpi-vt-bar-text {
                font-size: 0.625rem !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
            
            /* Títulos legíveis e centralizados */
            h1 { 
                font-size: 1.5rem !important;
                text-align: center !important;
                margin: 0.5rem auto !important;
            }
            h2 { 
                font-size: 1.25rem !important;
                line-height: 1.4 !important;
            }
            h3 { 
                font-size: 1.1rem !important;
                line-height: 1.4 !important;
            }
            
            /* Inputs e botões funcionais */
            input:not([type="checkbox"]):not([type="radio"]),
            select,
            textarea {
                width: 100% !important;
                max-width: 100% !important;
                padding: 0.75rem !important;
                font-size: 16px !important;
                min-height: 44px !important;
                box-sizing: border-box !important;
            }
            
            button,
            .btn,
            .modern-btn {
                padding: 0.75rem 1rem !important;
                min-height: 44px !important;
                font-size: 1rem !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
            
            /* Checkboxes normais */
            input[type="checkbox"] {
                width: 20px !important;
                height: 20px !important;
                min-width: 20px !important;
                min-height: 20px !important;
                flex-shrink: 0 !important;
            }
            
            /* Tabelas scrolláveis e legíveis */
            .overflow-x-auto {
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            table {
                min-width: 100% !important;
                table-layout: auto !important;
                font-size: 0.875rem !important;
                margin: 0 auto !important;
            }
            
            table colgroup {
                display: none !important;
            }
            
            table th {
                padding: 0.75rem 0.5rem !important;
                font-size: 0.875rem !important;
                white-space: normal !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                vertical-align: middle !important;
                text-align: center !important;
            }
            
            table td {
                padding: 0.75rem 0.5rem !important;
                font-size: 0.875rem !important;
                white-space: normal !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                vertical-align: top !important;
                text-align: left !important;
            }
            
            table th:first-child,
            table td:first-child {
                min-width: 30px !important;
                width: 30px !important;
                text-align: center !important;
            }
            
            table th:nth-child(2),
            table td:nth-child(2) {
                min-width: 150px !important;
            }
            
            table th:last-child,
            table td:last-child {
                min-width: 80px !important;
                width: 80px !important;
                text-align: center !important;
            }
            
            #income-table th:nth-child(1),
            #income-table td:nth-child(1) {
                min-width: 200px !important;
            }
            
            #income-table th:nth-child(2),
            #income-table td:nth-child(2) {
                min-width: 120px !important;
                text-align: right !important;
                font-weight: 600 !important;
            }
            
            /* Credit Cards Container */
            #credit-cards-container {
                display: flex !important;
                flex-direction: column !important;
                gap: 1rem !important;
                padding: 0 !important;
            }
            
            #credit-cards-container > div {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 auto !important;
                box-sizing: border-box !important;
            }
            
            /* Credit Card individual cards */
            [data-card-root] {
                width: calc(100% - 1.5rem) !important;
                max-width: calc(100% - 1.5rem) !important;
                margin: 0 auto 1rem auto !important;
                padding: 1rem !important;
                box-sizing: border-box !important;
            }
            
            /* Credit card header */
            [data-card-root] h3 {
                font-size: 1.125rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            /* Credit card values */
            [data-card-root] .text-2xl,
            [data-card-root] .text-3xl {
                font-size: 1.5rem !important;
            }
            
            [data-card-root] .text-sm {
                font-size: 0.875rem !important;
            }
            
            /* Credit card buttons */
            [data-card-root] button {
                width: 100% !important;
                margin-top: 0.5rem !important;
                padding: 0.75rem !important;
            }
            
            /* Percentual de despesas card */
            #kpi-expense-percentuals {
                max-height: 400px !important;
                overflow-y: auto !important;
            }
            
            #kpi-expense-percentuals > div {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                padding: 0.5rem 0 !important;
                gap: 0.75rem !important;
                flex-wrap: nowrap !important;
            }
            
            #kpi-expense-percentuals .text-sm {
                flex: 1 !important;
                min-width: 0 !important;
                font-size: 0.8125rem !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                white-space: nowrap !important;
            }
            
            #kpi-expense-percentuals .text-xs {
                flex-shrink: 0 !important;
                font-size: 0.75rem !important;
                text-align: right !important;
                min-width: 60px !important;
            }
            
            #kpi-expense-percentuals .font-semibold {
                flex-shrink: 0 !important;
                font-size: 0.875rem !important;
                text-align: right !important;
                min-width: 80px !important;
                white-space: nowrap !important;
            }
            
            /* Bottom navigation */
            #mobile-bottom-nav {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: 60px !important;
                background: white !important;
                border-top: 1px solid #e5e7eb !important;
                z-index: 1000 !important;
                display: flex !important;
                justify-content: space-around !important;
                align-items: center !important;
                padding: 0.5rem !important;
            }
            
            .mobile-nav-btn {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                padding: 0.5rem !important;
                min-height: 50px !important;
                font-size: 0.75rem !important;
                gap: 0.25rem !important;
                text-align: center !important;
            }
            
            .mobile-nav-btn .material-symbols-outlined {
                font-size: 24px !important;
            }
            
            /* FAB */
            button[onclick*="showModal"],
            [class*="fab"] {
                position: fixed !important;
                bottom: 70px !important;
                right: 1rem !important;
                width: 56px !important;
                height: 56px !important;
                border-radius: 50% !important;
                z-index: 999 !important;
            }
            
            /* Toast centralizado */
            #toast {
                position: fixed !important;
                bottom: 75px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                width: calc(100% - 2rem) !important;
                max-width: 400px !important;
                margin: 0 !important;
                text-align: center !important;
            }
            
            /* Esconde elementos desktop */
            .hide-on-mobile {
                display: none !important;
            }
            
            /* Evita texto sobreposto */
            p, span, div {
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
            }
            
            /* Labels e textos espaçados */
            label {
                display: block !important;
                margin-bottom: 0.5rem !important;
                line-height: 1.5 !important;
            }
        }
        
        @media (max-width: 480px) {
            body > div,
            #app {
                padding: 0.5rem !important;
            }
            
            .card,
            .modern-card {
                width: calc(100% - 1rem) !important;
                max-width: calc(100% - 1rem) !important;
                padding: 0.75rem !important;
                margin: 0 auto 0.75rem auto !important;
            }
            
            [class*="kpi"],
            .kpi-card {
                width: calc(100% - 1rem) !important;
                max-width: calc(100% - 1rem) !important;
                margin: 0 auto 0.75rem auto !important;
                padding: 0.75rem !important;
            }
            
            #kpi-vr-card,
            #kpi-vt-card {
                width: calc(100% - 1rem) !important;
                max-width: calc(100% - 1rem) !important;
                padding: 0.5rem !important;
            }
            
            [data-card-root] {
                width: calc(100% - 1rem) !important;
                max-width: calc(100% - 1rem) !important;
                margin: 0 auto 0.75rem auto !important;
                padding: 0.75rem !important;
            }
            
            dialog {
                width: 95vw !important;
                max-width: 95vw !important;
                padding: 0.75rem !important;
            }
            
            h1 { font-size: 1.25rem !important; }
            h2 { font-size: 1.1rem !important; }
            h3 { font-size: 1rem !important; }
            
            table th,
            table td {
                padding: 0.5rem 0.375rem !important;
                font-size: 0.8125rem !important;
            }
            
            .overflow-x-auto {
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
        }
        
        /* Touch feedback suave */
        @media (hover: none) and (pointer: coarse) {
            button:active,
            .btn:active {
                transform: scale(0.98) !important;
                opacity: 0.92 !important;
                transition: transform 0.1s ease !important;
            }
        }
        
        </style>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#3b82f6">
    <title>Fluxo Financeiro</title>

    <script>
        // Suprimir avisos desnecessários do console
        (function() {
            const originalWarn = console.warn;
            const originalError = console.error;
            
            console.warn = function(...args) {
                const message = args.join(' ');
                // Filtrar avisos do Tailwind CDN e source maps
                if (message.includes('cdn.tailwindcss.com') || 
                    message.includes('source map') || 
                    message.includes('sourcemaps.d.musta.ch') ||
                    message.includes('Deprecation warning')) {
                    return;
                }
                originalWarn.apply(console, args);
            };
            
            console.error = function(...args) {
                const message = args.join(' ');
                // Filtrar erros de source maps do Airbnb
                if (message.includes('Could not read source map') || 
                    message.includes('sourcemaps.d.musta.ch') ||
                    message.includes('Bad Gateway')) {
                    return;
                }
                originalError.apply(console, args);
            };
        })();
        
        window.populateSelect = function(selectId, items, iconSpanSelector){
            try{
                const sel = document.getElementById(selectId);
                if (!sel) return;
                sel.innerHTML = '';
                (items || []).forEach(it => {
                    const opt = document.createElement('option'); opt.value = it.value; opt.textContent = it.label; opt.dataset.icon = it.icon || '';
                    sel.appendChild(opt);
                });
                const iconSpan = sel.parentElement ? sel.parentElement.querySelector(iconSpanSelector) : null;
                const updateIcon = () => {
                    try { const cur = sel.options[sel.selectedIndex]; if (iconSpan && cur && cur.dataset.icon) { iconSpan.textContent = cur.dataset.icon; iconSpan.classList.add('material-symbols-outlined'); } } catch(e){}
                };
                try { sel.addEventListener('change', updateIcon); } catch(e){}
                try { updateIcon(); } catch(e){}
            } catch (e) { console.error('early populateSelect error', e); }
        };
        // Provide a global function name as well (some code calls populateSelect unqualified)
        try { if (typeof populateSelect === 'undefined') {
            function populateSelect(selectId, items, iconSpanSelector) { return window.populateSelect(selectId, items, iconSpanSelector); }
        } } catch(e) {}
    </script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <!-- Mobile Detection & Optimizations -->
    <script>
        // Sistema de detecção e otimização mobile
        window.mobileUtils = {
            // Detecta se é dispositivo mobile
            isMobile: function() {
                return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            },
            
            // Detecta se é smartphone (tela pequena)
            isSmartphone: function() {
                return window.innerWidth <= 480;
            },
            
            // Detecta se é tablet
            isTablet: function() {
                return window.innerWidth > 480 && window.innerWidth <= 768;
            },
            
            // Detecta se suporta touch
            isTouch: function() {
                return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            },
            
            // Previne zoom indesejado em duplo clique (exceto em inputs)
            preventDoubleTapZoom: function() {
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(event) {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300 && !event.target.matches('input, textarea, select')) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, { passive: false });
            },
            
            // Ajusta altura do viewport para dispositivos iOS (barra de endereço)
            fixIOSViewportHeight: function() {
                const setHeight = () => {
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                };
                setHeight();
                window.addEventListener('resize', setHeight);
                window.addEventListener('orientationchange', setHeight);
            },
            
            // Otimiza scroll em dispositivos touch
            optimizeTouchScroll: function() {
                document.querySelectorAll('dialog, .modal, [role="dialog"]').forEach(element => {
                    element.style.webkitOverflowScrolling = 'touch';
                });
            },
            
            // Adiciona classe mobile ao body para controle CSS
            addMobileClass: function() {
                if (this.isMobile()) {
                    document.body.classList.add('is-mobile');
                }
                if (this.isSmartphone()) {
                    document.body.classList.add('is-smartphone');
                }
                if (this.isTablet()) {
                    document.body.classList.add('is-tablet');
                }
                if (this.isTouch()) {
                    document.body.classList.add('is-touch');
                }
            },
            
            // Inicializa todas as otimizações
            init: function() {
                this.addMobileClass();
                this.fixIOSViewportHeight();
                if (this.isTouch()) {
                    this.preventDoubleTapZoom();
                    this.optimizeTouchScroll();
                }
                
                // Re-avalia em resize
                window.addEventListener('resize', () => {
                    document.body.classList.remove('is-mobile', 'is-smartphone', 'is-tablet');
                    this.addMobileClass();
                });
            }
        };
        
        // Inicializa quando o DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => window.mobileUtils.init());
        } else {
            window.mobileUtils.init();
        }
    </script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Confetti.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <!-- SheetJS for client-side XLSX/CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
/* Animações para KPIs principais */
.kpi-animate {
    animation: kpiPulse 0.7s;
}
@keyframes kpiPulse {
    0% { transform: scale(1); }
    30% { transform: scale(1.15); }
    60% { transform: scale(0.97); }
    100% { transform: scale(1); }
}
.kpi-animate-up {
    animation: kpiColorUp 0.7s;
    color: #16a34a !important; /* verde entradas */
}
.kpi-animate-down {
    animation: kpiColorDown 0.7s;
    color: #dc2626 !important; /* vermelho */
}
@keyframes kpiColorUp {
    0% { color: #16a34a; }
    80% { color: #16a34a; }
    100% { color: #1d1d1f; }
}
@keyframes kpiColorDown {
    0% { color: #dc2626; }
    80% { color: #dc2626; }
    100% { color: #1d1d1f; }
}
        /* Deduplicated KPI animations (defined above) */
        :root {
            --background-color: #f8f8fa;
            --card-background: rgba(255, 255, 255, 0.9);
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --accent-blue: #0A84FF;
            --accent-blue-hover: #0077ED;
            --progress-bar-bg: #e5e7eb;
        }

        

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
        }

        dialog, .report-modal {
            /* Slightly larger max-height to allow more content without inner scroll */
            max-height: 95vh;
        }

        /* Class applied to expand the transaction modal vertically when needed (e.g., salary details) */
        .modal-expanded {
            /* Allow modal to grow with content but cap to avoid overflowing the viewport */
            max-height: 90vh !important;
            overflow: auto;
            transition: max-height 220ms ease;
        }
        
        dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
        }
        
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            vertical-align: middle;
        }

        .card {
            background-color: var(--card-background);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            transition: box-shadow 0.25s ease-in-out;
        }

        .card:hover {
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }
        
        .btn-primary {
            background-color: var(--accent-blue);
            color: white;
            transition: background-color 0.2s ease;
        }
        .btn-primary:hover {
            background-color: var(--accent-blue-hover);
        }

        .hidden { display: none !important; }

        /* Infrequent controls (import/export) are hidden by default and shown on hover of the monthly report */
        .infrequent-controls {
            opacity: 0;
            pointer-events: none;
            transform: translateY(6px);
            transition: opacity .15s ease, transform .15s ease;
        }

        /* Make visible when JS toggles .visible on desktop */
        .infrequent-controls.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .material-symbols-outlined {
            display: inline-block;
            width: 1.2em;
            font-size: 1em;
            vertical-align: text-bottom;
        }
        .sortable-header.sorted .sort-icon {
            opacity: 1;
        }
        .progress-bar {
            background-color: var(--progress-bar-bg);
            border-radius: 9999px;
            overflow: hidden;
            height: 0.75rem;
        }
    /* Grouped expenses visual cards */
    .expenses-groups { display: flex; flex-wrap: wrap; gap: 12px; }
    .expense-group-card { background: linear-gradient(180deg, #ffffff 0%, #fbfbff 100%); border: 1px solid rgba(99,102,241,0.08); padding: 14px 16px; border-radius: 12px; min-width: 220px; max-width: 340px; box-shadow: 0 6px 20px rgba(16,24,40,0.04); cursor: pointer; position: relative; transition: transform 0.12s ease, box-shadow 0.12s ease; }
    .expense-group-card:hover { transform: translateY(-6px); box-shadow: 0 14px 36px rgba(16,24,40,0.08); }
    .expense-group-title { font-weight: 700; color: var(--text-primary); font-size: 1rem; }
    .expense-group-sub { color: var(--text-secondary); font-size: 0.88rem; margin-top: 6px; display:flex; align-items:center; gap:8px; }
    .expense-category-badge { background: rgba(10,132,255,0.08); color: #0A84FF; padding: 4px 8px; border-radius: 999px; font-size: 0.78rem; font-weight:600; }
    .expense-group-amount { font-weight: 800; margin-top: 8px; font-size: 1.08rem; color: #111827; }
    .expense-group-count { font-size: 0.82rem; color: #6b7280; background: rgba(0,0,0,0.04); padding: 2px 6px; border-radius: 999px; }
    /* Tooltip with breakdown on hover */
    .expense-tooltip { position: absolute; z-index: 3000; background: #0f172a; color: #f8fafc; padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; box-shadow: 0 10px 30px rgba(2,6,23,0.6); white-space: nowrap; display: none; transform-origin: bottom left; }
    .expense-tooltip::after { content: ''; position: absolute; left: 14px; bottom: -6px; width: 12px; height: 12px; background: #0f172a; transform: rotate(45deg); border-radius: 2px; }
    .expense-group-card.show-tooltip .expense-tooltip { display: block; }
        .progress-bar > div {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        tbody tr {
            transition: background-color 0.2s ease;
        }
        tbody tr:hover {
            background-color: #f0f0f5;
        }

        /* Responsive Tables - Mobile First */
        /* Mobile UX - Melhor experiência, sem impactar desktop */
        @media (max-width: 639px) {
            body {
                padding: 0 !important;
                font-size: 15px;
            }
            .max-w-7xl {
                padding: 0.5rem !important;
            }
            /* Header icon group: tighter spacing on mobile */
            header .flex.items-center.gap-4 > div { gap: 0.5rem !important; }
            #current-month-display { max-width: 180px; overflow: hidden; text-overflow: ellipsis; }
            header {
                flex-direction: column !important;
                gap: 0.5rem !important;
                margin-bottom: 1.5rem !important;
            }
            h1 {
                font-size: 1.3rem !important;
            }
            .card {
                border-radius: 1rem !important;
                box-shadow: none !important;
                padding: 1rem !important;
            }
            .tab-button {
                font-size: 0.95rem !important;
                padding: 0.7rem 0 !important;
            }
            .grid-cols-4, .sm\:grid-cols-2, .lg\:grid-cols-4 {
                grid-template-columns: 1fr !important;
            }
            #kpi-projected-balance {
                font-size: 1rem !important;
            }
            .responsive-table thead { display: none !important; }
            /* Make each table row a full-width block on mobile so transactions stack vertically. */
            .responsive-table, .responsive-table table {
                width: 100% !important;
                border-collapse: separate !important;
                table-layout: auto !important;
                overflow-x: hidden !important;
            }
            .responsive-table tbody, .responsive-table tr {
                display: block !important;
                width: 100% !important;
                margin: 6px 0 !important; /* small spacing between rows */
                padding: 0 !important;
                background: transparent !important;
            }
            /* Each cell inside mobile row should be hidden except the full-width mobile-row-cell (rendered by JS with colspan). */
            .responsive-table td { display: none !important; }
            .mobile-row-cell { display: block !important; width: 100% !important; padding: 8px 10px !important; box-sizing: border-box !important; background: white !important; border-radius: 8px; border: 1px solid rgba(0,0,0,0.04); }
            .mobile-row { display:flex; align-items:center; justify-content:space-between; gap:12px; width:100%; min-width:0; }
            .mobile-row .mobile-left { min-width:0; overflow:hidden; }
            .mobile-row .mobile-left > div, .mobile-row .mobile-left span { display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
            .mobile-row .mobile-right { flex-shrink:0; display:flex; align-items:center; gap:8px; }
            /* Prevent any overflow on wrappers that used to be scrollable */
            .overflow-x-auto { overflow-x: hidden !important; }
            /* Constrain amount and action buttons to avoid forcing horizontal scroll */
            .mobile-row .mobile-right .amount, .mobile-row .mobile-right span { max-width: 160px; overflow: visible; text-overflow: clip; white-space: nowrap; display:inline-block; }
            .mobile-row .mobile-right button { min-width:36px; width:36px; height:36px; padding:6px; }
            /* Hide top tabs and enable bottom navigation on mobile */
            #tabs { display: none !important; }
            #mobile-bottom-nav { display: none; }
            #mobile-bottom-nav.active { display: flex !important; }
            .responsive-table td.actions-cell::before {
                display: none !important;
            }
            .responsive-table td.checkbox-cell {
                padding-top: 0.4rem !important;
                padding-bottom: 0.4rem !important;
            }
            .responsive-table td.checkbox-cell::before {
                display: none !important;
            }
            .responsive-table td.checkbox-cell input {
                margin-left: auto !important;
                width: 1.3em !important;
                height: 1.3em !important;
            }
            .btn-primary, button, input[type="submit"] {
                font-size: 1.1rem !important;
                padding: 1rem 0.5rem !important;
                border-radius: 0.7rem !important;
            }
            input, select, textarea {
                font-size: 1.1rem !important;
                padding: 0.8rem !important;
            }
            /* Mobile improvements: spacing, touch targets and mobile infrequent-controls presentation */
            .card { padding: 1rem !important; }
            .kpi-label { font-size: 0.9rem !important; }
            .kpi-value { font-size: 1.25rem !important; font-weight: 700 !important; }
            .fab { width: 56px !important; height: 56px !important; right: 1rem !important; bottom: 1.2rem !important; }
            canvas { height: 220px !important; }
            /* Make the infrequent controls appear as a bottom-sheet on mobile when visible */
            .infrequent-controls.mobile-visible {
                position: fixed !important;
                left: 0.6rem !important;
                right: 0.6rem !important;
                bottom: 0.9rem !important;
                display: flex !important;
                justify-content: center !important;
                gap: 0.5rem !important;
                padding: 0.6rem !important;
                background: white !important;
                border-radius: 12px !important;
                box-shadow: 0 -10px 30px rgba(0,0,0,0.08) !important;
                z-index: 99999 !important;
                opacity: 1 !important;
                pointer-events: auto !important;
            }
            label {
                font-size: 1rem !important;
            }
            .modal, dialog, .report-modal {
                width: 100vw !important;
                min-width: unset !important;
                border-radius: 0 !important;
                padding: 0.5rem !important;
                left: 0 !important;
                margin: 0 !important;
                max-width: 100vw !important;
            }
            .modal .absolute.top-2.right-2, dialog .absolute.top-2.right-2 {
                top: 0.5rem !important;
                right: 0.5rem !important;
                font-size: 2rem !important;
            }
            .rounded-2xl, .rounded-xl, .rounded-lg {
                border-radius: 1rem !important;
            }
            #feedback-card {
                margin-top: 0.5rem !important;
                padding: 1rem !important;
            }
            /* Center the month display and make the month-picker popover centered on mobile */
            .relative { display: block; }
            #current-month-display { display: inline-block; margin: 0 auto; text-align: center; }
            #month-picker {
                position: fixed !important;
                left: 50% !important;
                top: 18% !important;
                transform: translateX(-50%) !important;
                right: auto !important;
                width: calc(100% - 2rem) !important;
                max-width: 360px !important;
                z-index: 100000 !important;
            }
            /* Unified KPI dashboard: stack KPIs inside a single card on mobile */
            .grid.grid-cols-1.sm\:grid-cols-2.lg\:grid-cols-4.gap-6 {
                display: block !important;
            }
            .grid.grid-cols-1.sm\:grid-cols-2.lg\:grid-cols-4.gap-6 > .card {
                border-radius: 0 !important;
                border-left: none !important;
                border-right: none !important;
                margin: 0 !important;
                box-shadow: none !important;
                padding: 0.9rem 1rem !important;
                border-bottom: 1px solid rgba(0,0,0,0.04) !important;
                background: white !important;
            }
            .grid.grid-cols-1.sm\:grid-cols-2.lg\:grid-cols-4.gap-6 > .card:first-child { border-top-left-radius: 0.75rem !important; border-top-right-radius: 0.75rem !important; }
            .grid.grid-cols-1.sm\:grid-cols-2.lg\:grid-cols-4.gap-6 > .card:last-child { border-bottom-left-radius: 0.75rem !important; border-bottom-right-radius: 0.75rem !important; border-bottom: none !important; }
            .grid.grid-cols-1.sm\:grid-cols-2.lg\:grid-cols-4.gap-6 h3 { margin-bottom: 0.15rem !important; }
            .grid.grid-cols-1.sm\:grid-cols-2.lg\:grid-cols-4.gap-6 p { margin-top: 0 !important; }
            canvas {
                height: 180px !important;
            }
            html, body {
                overflow-x: hidden !important;
            }
            /* Hide desktop quick links on small screens */
            #desktop-quick-links { display: none !important; }
        }
        /* Desktop: make the expenses selector column narrow (just big enough for checkbox) */
        @media (min-width: 640px) {
            /* header cell that shows the check icon for expenses only */
            #expenses-table-head th:first-child {
                width: 36px; /* narrow column */
                padding-left: 8px;
                padding-right: 8px;
                text-align: center;
            }
            /* body checkbox cells */
            .checkbox-cell {
                width: 36px;
                padding-left: 8px;
                padding-right: 8px;
                text-align: center;
            }
            .checkbox-cell input[type="checkbox"] { margin: 0 auto; display: inline-block; }
        }
    </style>
    <style>
        /* Mobile table-friendly styles: keep transactions as one-line rows, prevent horizontal scrolling, increase touch targets */
        @media (max-width: 640px) {
            /* Hide table header on small screens for compact list-like display */
            .responsive-table thead th { display: none !important; }
            /* Keep cells single-line and truncate long descriptions */
            .responsive-table tbody td { white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; vertical-align: middle !important; }
            /* Ensure the table wrapper does not allow horizontal scroll */
            .overflow-x-auto { overflow-x: hidden !important; }
            .responsive-table colgroup col { width: auto !important; }
            /* Make action buttons larger for touch (applies in mobile and desktop when table collapses) */
            .responsive-table td.actions-cell button, .responsive-table td.actions-cell .edit-btn, .responsive-table td.actions-cell .delete-btn { width:44px; height:44px; padding:8px; display:inline-flex !important; align-items:center; justify-content:center; }
            /* Add clearer spacing for table rows on mobile */
            .responsive-table tr { padding: 0.6rem 0 !important; }
            .responsive-table td { padding: 0.6rem 0.6rem !important; }
        }
    </style>
    <style>
    /* ===== OTIMIZAÇÕES MOBILE - iPhone 15 Pro Max (430x932px) ===== */
    /* Melhorias abrangentes para experiência mobile excepcional */
    @media (max-width: 639px) {
        /* ===== CENTRALIZAÇÃO DO CONTEÚDO ===== */
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100vw;
            overflow-x: hidden !important;
        }
        
        html {
            overflow-x: hidden !important;
            width: 100vw;
        }
        
        #app,
        main,
        #app-content {
            width: 100%;
            max-width: 100vw;
            margin: 0 auto;
            padding-left: 1rem;
            padding-right: 1rem;
            box-sizing: border-box;
        }
        
        /* Centralizar header */
        header {
            width: 100%;
            max-width: 100vw;
            margin: 0 auto;
            padding-left: 1rem;
            padding-right: 1rem;
            box-sizing: border-box;
            text-align: center;
        }
        
        /* ===== MELHORIAS NO HEADER E INÍCIO ===== */
        header .flex.items-center.justify-between {
            flex-direction: column;
            gap: 0.75rem;
            align-items: center;
        }
        
        header h1 {
            font-size: 1.5rem !important;
            margin: 0;
            text-align: center;
        }
        
        /* Controles de calendário centralizados */
        .card.flex.items-center.gap-1 {
            justify-content: center;
            flex-wrap: wrap;
            width: 100%;
            padding: 0.5rem !important;
        }
        
        #current-month-display {
            font-size: 0.875rem !important;
            padding: 0.5rem !important;
            text-align: center;
            min-width: 120px;
        }
        
        /* ===== TABELAS - CORRIGIR SOBREPOSIÇÃO ===== */
        .modern-table,
        .responsive-table {
            width: 100%;
            font-size: 0.75rem !important;
            table-layout: fixed;
        }
        
        .modern-table th,
        .modern-table td,
        .responsive-table th,
        .responsive-table td {
            padding: 0.5rem 0.25rem !important;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: middle;
        }
        
        /* Larguras específicas para colunas */
        .modern-table td:first-child,
        .responsive-table td:first-child {
            max-width: 120px;
        }
        
        .modern-table td:nth-child(2),
        .responsive-table td:nth-child(2) {
            max-width: 80px;
            text-align: right;
        }
        
        .modern-table td:last-child,
        .responsive-table td:last-child {
            max-width: 70px;
            text-align: center;
        }
        
        /* Descrições truncadas */
        .modern-table .desc-text,
        .responsive-table .desc-text {
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }
        
        /* Valores com melhor espaçamento */
        .amount-text {
            font-size: 0.75rem !important;
            white-space: nowrap;
        }
        
        /* ===== MODAIS MOBILE - REFORMULAÇÃO COMPLETA ===== */
        dialog {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            max-width: 92vw !important;
            max-height: 85vh !important;
            width: 92vw !important;
            margin: 0 !important;
            padding: 1rem !important;
            border-radius: 1rem !important;
            overflow-y: auto !important;
            box-sizing: border-box;
        }
        
        /* Header do modal */
        dialog .modal-title-row,
        dialog .flex.items-center.justify-between {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            gap: 0.5rem;
        }
        
        dialog h3,
        dialog .modal-title {
            font-size: 1.125rem !important;
            margin: 0;
            flex: 1;
            text-align: left;
        }
        
        /* Formulários em modais */
        dialog .modal-group,
        dialog .modern-form-group {
            margin-bottom: 0.875rem;
            width: 100%;
        }
        
        dialog label,
        dialog .modal-label,
        dialog .modern-form-label {
            font-size: 0.875rem !important;
            margin-bottom: 0.375rem !important;
            display: block;
            font-weight: 500;
        }
        
        dialog input,
        dialog select,
        dialog textarea {
            width: 100% !important;
            padding: 0.75rem !important;
            font-size: 1rem !important;
            min-height: 44px !important;
            box-sizing: border-box !important;
            border-radius: 0.5rem !important;
        }
        
        /* Grids em modais */
        dialog .grid {
            display: flex !important;
            flex-direction: column !important;
            gap: 0.75rem !important;
        }
        
        /* Botões de ação do modal */
        dialog .modal-action-btn,
        dialog button[type="submit"],
        dialog .btn-primary {
            width: 100% !important;
            padding: 0.875rem !important;
            font-size: 1rem !important;
            min-height: 48px !important;
            margin-top: 0.5rem;
            border-radius: 0.75rem !important;
        }
        
        /* Footer do modal */
        dialog .flex.justify-end,
        dialog .modal-footer {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        dialog .flex.justify-end button,
        dialog .modal-footer button {
            width: 100% !important;
        }
        
        /* Modal de transação específico */
        #transaction-modal {
            max-height: 90vh !important;
        }
        
        #transaction-modal .transaction-type-selector {
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        #transaction-modal .transaction-type-selector button {
            flex: 1;
            min-height: 48px;
        }
        
        /* Prevenir zoom indesejado em inputs */
        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="email"],
        select,
        textarea {
            font-size: 16px !important; /* Evita zoom automático no iOS */
        }
        
        /* Melhorar área de toque para todos os botões */
        button,
        .btn-primary,
        .tab-button,
        .kpi-card {
            min-height: 44px; /* Tamanho mínimo recomendado pela Apple */
            touch-action: manipulation; /* Melhora responsividade de toque */
        }
        
        /* KPIs otimizados para mobile */
        .kpi-card {
            padding: 1rem !important;
            margin-bottom: 0.75rem;
            text-align: center;
            width: 100%;
        }
        
        .kpi-title {
            font-size: 0.875rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        .kpi-value {
            font-size: 1.75rem !important;
            font-weight: 700 !important;
            margin-bottom: 0.25rem !important;
            word-break: break-word;
        }
        
        .kpi-trend {
            font-size: 0.75rem !important;
            justify-content: center;
        }
        
        /* Cards e containers com melhor espaçamento */
        .card {
            padding: 1rem !important;
            margin-bottom: 1rem !important;
            border-radius: 1rem !important;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Títulos de seções mais compactos e centralizados */
        h2 {
            font-size: 1.25rem !important;
            margin-bottom: 0.75rem !important;
            text-align: center;
        }
        
        h3 {
            font-size: 1.125rem !important;
            text-align: center;
        }
        
        /* Melhorar navegação por tabs */
        #tabs {
            width: 100%;
            max-width: 100%;
            justify-content: center;
            padding: 0.5rem !important;
        }
        
        #tabs .tab-button {
            padding: 0.75rem 0.5rem !important;
            font-size: 0.7rem !important;
            min-height: 44px;
            flex: 1;
            text-align: center;
        }
        
        /* Otimizar header do calendário */
        #current-month-display {
            font-size: 0.875rem !important;
            padding: 0.5rem !important;
        }
        
        .p-1\.5 {
            padding: 0.5rem !important;
        }
        
        /* Melhorar visualização de metas */
        .goal-item {
            padding: 1rem !important;
            margin-bottom: 0.75rem !important;
            width: 100%;
            box-sizing: border-box;
        }
        
        .goal-item .font-semibold {
            font-size: 0.95rem !important;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .goal-item .flex.items-center.gap-2 {
            flex-wrap: nowrap;
            gap: 0.25rem !important;
        }
        
        .goal-item .text-sm {
            font-size: 0.75rem !important;
        }
        
        .progress-bar {
            height: 10px !important;
            margin-top: 0.5rem !important;
        }
        
        /* Otimizar tabelas para mobile */
        .modern-table {
            font-size: 0.875rem !important;
            width: 100%;
            display: table;
        }
        
        .modern-table thead {
            display: table-header-group;
        }
        
        .modern-table tbody {
            display: table-row-group;
        }
        
        .modern-table tr {
            display: table-row;
        }
        
        .modern-table th,
        .modern-table td {
            display: table-cell;
            padding: 0.75rem 0.5rem !important;
            vertical-align: middle;
        }
        
        .modern-table th:first-child,
        .modern-table td:first-child {
            padding-left: 0.25rem !important;
        }
        
        .modern-table th:last-child,
        .modern-table td:last-child {
            padding-right: 0.25rem !important;
            text-align: right;
        }
        
        /* Wrapper de tabelas com scroll controlado */
        .overflow-x-auto {
            overflow-x: auto !important;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }
        
        /* Melhorar visualização de gráficos */
        canvas {
            max-height: 250px !important;
        }
        
        /* Espaçamento do container principal */
        #app-content {
            padding: 0 0.75rem !important;
        }
        
        /* Otimizar grid de KPIs */
        .grid.grid-cols-1 {
            gap: 0.75rem !important;
        }
        
        /* Melhorar botão de adicionar meta/viagem */
        .btn-primary {
            padding: 0.75rem 1rem !important;
            font-size: 0.875rem !important;
        }
        
        .btn-primary .material-symbols-outlined {
            font-size: 1.25rem !important;
        }
        
        /* Planejadora de viagens mais compacta */
        #tp-plans .card {
            padding: 0.875rem !important;
        }
        
        /* Melhorar seletores com ícones */
        .select-with-icon select {
            padding-left: 2.5rem !important;
        }
        
        .select-icon {
            left: 0.75rem !important;
        }
        
        /* Otimizar barra de navegação inferior */
        #mobile-bottom-nav {
            padding: 0.5rem 0.75rem !important;
            bottom: 1rem !important;
            gap: 0.5rem !important;
        }
        
        .mobile-nav-btn {
            width: 52px !important;
            height: 52px !important;
        }
        
        /* Melhorar FAB de adicionar transação */
        #mobile-add-transaction-fab {
            width: 56px !important;
            height: 56px !important;
            bottom: 5rem !important;
            right: 1rem !important;
        }
        
        /* Melhorar touch targets para ícones de ação */
        .quick-add-goal-btn,
        .delete-goal-btn,
        .edit-btn,
        .delete-btn {
            min-width: 44px !important;
            min-height: 44px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        /* Otimizar visualização de investimentos */
        #investments-view .card {
            padding: 1rem !important;
        }
        
        /* Melhorar filtros de despesas */
        #expenses-filter-popover {
            left: 0.5rem !important;
            right: 0.5rem !important;
            max-width: calc(100vw - 1rem) !important;
        }
        
        /* Month picker otimizado */
        #month-picker {
            right: 0 !important;
            left: auto !important;
            width: 90vw !important;
            max-width: 280px !important;
        }
        
        /* Melhorar spacing entre elementos */
        .space-y-4 > * + * {
            margin-top: 0.75rem !important;
        }
        
        .space-y-6 > * + * {
            margin-top: 1rem !important;
        }
        
        .space-y-8 > * + * {
            margin-top: 1.25rem !important;
        }
    }
    
    /* Otimizações específicas para iPhone 15 Pro Max (430px width) */
    @media (max-width: 430px) {
        /* Ajustes finos para tela exata do iPhone 15 Pro Max */
        .container,
        main {
            max-width: 100% !important;
            padding-left: 0.75rem !important;
            padding-right: 0.75rem !important;
        }
        
        /* KPI values ligeiramente menores */
        .kpi-value {
            font-size: 1.375rem !important;
        }
        
        /* Tabs ainda mais compactas */
        #tabs .tab-button {
            font-size: 0.6875rem !important;
            padding: 0.625rem 0.375rem !important;
        }
        
        /* Calendário header compacto */
        .flex.items-center.gap-1 {
            gap: 0.25rem !important;
        }
    }
    
    /* Melhorias para landscape em mobile */
    @media (max-width: 932px) and (orientation: landscape) {
        /* Ajustar altura de elementos em landscape */
        dialog {
            max-height: 85vh !important;
        }
        
        .kpi-card {
            padding: 0.75rem !important;
        }
        
        #mobile-bottom-nav {
            padding: 0.375rem 0.5rem !important;
        }
        
        .mobile-nav-btn {
            width: 44px !important;
            height: 44px !important;
        }
    }
    </style>
    <style>
    /* Mobile-only UI polish: floating action button, larger touch targets, clearer bottom nav spacing */
    @media (max-width: 639px) {
        /* Floating Add button for mobile (visible only on small screens) */
        #mobile-add-transaction-fab {
            display: inline-flex !important;
            position: fixed;
            right: 1rem;
            bottom: 5.6rem; /* above the mobile bottom nav */
            width: 64px;
            height: 64px;
            border-radius: 9999px;
            background: linear-gradient(180deg,#0ea5e9,#0369a1);
            color: white;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(2,6,23,0.18);
            z-index: 140000;
            border: none;
            font-size: 28px;
        }
        #mobile-add-transaction-fab:active { transform: translateY(1px); }

        /* Make small header icons and list actions larger for touch */
        header .material-symbols-outlined, .mobile-nav-btn .material-symbols-outlined { font-size: 22px !important; }
        .responsive-table td .material-symbols-outlined, .responsive-table td button { padding: 10px !important; }

        /* Improve spacing inside responsive table rows for readability */
        .responsive-table tr { padding: 0.85rem !important; }
        .responsive-table td { padding: 0.9rem 0.6rem !important; }

        /* Ensure month-picker and filter bottom-sheets have comfortable margins */
        #month-picker, #expenses-filter-popover { left: 0.6rem !important; right: 0.6rem !important; bottom: 4.6rem !important; max-height: 52vh !important; }
    }
    /* Hidden by default (desktop) - shown only on mobile via media query above */
    #mobile-add-transaction-fab { display: none; }
    </style>
</head>
<body class="antialiased">

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Cabeçalho (compact) -->
        <header class="flex flex-col sm:flex-row items-center justify-between mb-6 gap-2">
            <div class="flex items-center gap-1">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                    <span>Fluxo Financeiro</span>
                </h1>
                <div id="desktop-quick-links" class="inline-flex items-center gap-1 ml-1">
                    <button id="desktop-dashboard-btn" class="bg-white/80 p-2 rounded-full shadow-sm hover:bg-gray-100 transition-colors" title="Dashboard">
                        <span class="material-symbols-outlined text-gray-600">dashboard</span>
                    </button>
                    <button id="desktop-creditcards-btn" class="bg-white/80 p-2 rounded-full shadow-sm hover:bg-gray-100 transition-colors" title="Cartões">
                        <span class="material-symbols-outlined text-gray-600">credit_card</span>
                    </button>
                    <button id="desktop-investments-btn" class="bg-white/80 p-2 rounded-full shadow-sm hover:bg-gray-100 transition-colors" title="Investimentos">
                        <span class="material-symbols-outlined text-gray-600">trending_up</span>
                    </button>
                        <button id="desktop-travelplanner-btn" class="bg-white/80 p-2 rounded-full shadow-sm hover:bg-gray-100 transition-colors" title="Planejadora de viagens" aria-label="Planejadora de viagens">
                            <span class="material-symbols-outlined text-gray-600">flight</span>
                        </button>
                    <button id="add-transaction-btn" class="bg-blue-600 p-2 rounded-full shadow-sm hover:bg-blue-700 transition-colors text-white ml-1" title="Nova Transação">
                        <span class="material-symbols-outlined">add</span>
                    </button>
                </div>
                <!-- VR KPI moved to right column (below 'Projetado' and above feedback) -->
            </div>
          <div class="flex items-center gap-2">
              <div class="flex items-center gap-2">
                    <div id="infrequent-controls" class="infrequent-controls flex items-center gap-1">
                        <button id="import-data-btn" class="bg-white/80 p-2 rounded-full shadow-sm hover:bg-gray-100 transition-colors" title="Importar dados (JSON)">
                            <span class="material-symbols-outlined text-gray-600">upload</span>
                        </button>
                        <button id="create-backup-btn" class="bg-white/80 p-2 rounded-full shadow-sm hover:bg-gray-100 transition-colors" title="Criar backup completo" aria-label="Criar backup">
                            <span class="material-symbols-outlined text-gray-600">save</span>
                        </button>
                        <button id="restore-backup-btn" class="bg-white/80 p-2 rounded-full shadow-sm hover:bg-gray-100 transition-colors" title="Restaurar backup" aria-label="Restaurar backup">
                            <span class="material-symbols-outlined text-gray-600">restore_from_trash</span>
                        </button>
                        <button id="export-data-btn" class="bg-white/80 p-2 rounded-full shadow-sm hover:bg-gray-100 transition-colors" title="Exportar dados (JSON)">
                            <span class="material-symbols-outlined text-gray-600">download</span>
                        </button>
                    </div>
                    <input type="file" id="import-file-input" class="hidden" accept=".json">
                    <!-- Mobile toggle for import/export (visible on small screens) -->
                    <button id="mobile-infrequent-toggle" class="bg-white/80 p-2 rounded-full shadow-sm hover:bg-gray-100 transition-colors hidden sm:inline-flex" title="Mais opções" aria-label="Abrir opções">
                        <span class="material-symbols-outlined text-gray-600">more_horiz</span>
                    </button>
                    <button id="monthly-report-btn" class="bg-white/80 p-2 rounded-full shadow-sm hover:bg-gray-100 transition-colors" title="Relatório Mensal" aria-label="Relatório Mensal">
                        <span class="material-symbols-outlined text-gray-600">assessment</span>
                    </button>
                     <button id="annual-report-btn" class="bg-white/80 p-2 rounded-full shadow-sm hover:bg-gray-100 transition-colors" title="Relatório Anual" aria-label="Relatório Anual">
                        <span class="material-symbols-outlined text-gray-600">calendar_month</span>
                    </button>
                    <!-- quick links removed from this position (moved next to title) -->
                </div>
                <!-- Backup / Restore Modal (hidden by default) -->
                <dialog id="backup-restore-modal" class="p-4 rounded-2xl shadow-2xl card w-full max-w-3xl">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold">Gerenciar Backups</h3>
                        <button id="close-backup-modal" class="px-2 py-1 rounded bg-gray-100">Fechar</button>
                    </div>
                    <div class="flex gap-4">
                        <div style="flex:1;min-width:260px;max-width:420px;">
                            <div class="flex items-center justify-between mb-2">
                                <strong>Backups</strong>
                                <button id="refresh-backups-btn" class="px-2 py-0.5 rounded bg-gray-100 text-sm">Atualizar</button>
                            </div>
                            <div id="backups-list" style="max-height:420px;overflow:auto;border:1px solid rgba(0,0,0,0.04);padding:8px;border-radius:8px;">
                                <div class="text-sm text-gray-500">Nenhum backup encontrado.</div>
                            </div>
                        </div>
                        <div style="flex:1;min-width:320px;">
                            <div class="flex items-center justify-between mb-2">
                                <strong>Preview</strong>
                                <div>
                                    <button id="download-preview-btn" class="px-2 py-0.5 rounded bg-gray-100 text-sm">Baixar</button>
                                    <button id="delete-backup-btn" class="px-2 py-0.5 ml-2 rounded bg-red-100 text-red-700 text-sm hover:bg-red-200" title="Excluir backup permanentemente">Excluir</button>
                                    <button id="restore-selected-btn" class="px-2 py-0.5 ml-2 rounded bg-red-600 text-white text-sm">Restaurar</button>
                                </div>
                            </div>
                            <div id="backup-preview" style="max-height:420px;overflow:auto;border:1px solid rgba(0,0,0,0.04);padding:8px;border-radius:8px;background:#fff"></div>
                        </div>
                    </div>
                </dialog>
                <!-- Import JSON Modal -->
                <dialog id="import-json-modal" class="p-4 rounded-2xl shadow-2xl card w-full max-w-3xl">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold">Importar Dados (.json)</h3>
                        <button id="close-import-modal" class="px-2 py-1 rounded bg-gray-100">Fechar</button>
                    </div>
                    <div class="space-y-3">
                        <p class="text-sm text-gray-600">Selecione um arquivo <strong>.json</strong> exportado pelo aplicativo. O arquivo pode conter o objeto principal <code>financeAppDB_v10</code> ou diretamente a estrutura de dados da aplicação. O processo irá substituir os dados locais.</p>
                        <div class="flex gap-4">
                            <div style="flex:1;min-width:260px;max-width:420px;">
                                <label class="block text-sm font-medium mb-1">Arquivo (.json)</label>
                                <input type="file" id="import-file-input-modal" accept=".json,application/json" class="w-full border rounded p-2" />
                                <div id="import-file-info" class="text-xs text-gray-500 mt-2">Nenhum arquivo selecionado.</div>
                                <div class="mt-3">
                                    <button id="parse-import-btn" class="px-3 py-1 rounded bg-blue-600 text-white">Ler e Validar</button>
                                    <button id="clear-import-btn" class="px-3 py-1 ml-2 rounded bg-gray-100">Limpar</button>
                                </div>
                            </div>
                            <div style="flex:1;min-width:320px;">
                                <label class="block text-sm font-medium mb-1">Preview / Validação</label>
                                <div id="import-preview" style="max-height:420px;overflow:auto;border:1px solid rgba(0,0,0,0.04);padding:8px;border-radius:8px;background:#fff;font-family:monospace;font-size:12px;white-space:pre-wrap;">Nenhum preview disponível.</div>
                            </div>
                        </div>
                        <div class="flex justify-end gap-2">
                            <button id="import-cancel-btn" class="px-3 py-1 rounded bg-gray-100">Cancelar</button>
                            <button id="import-confirm-btn" class="px-3 py-1 rounded bg-red-600 text-white" disabled>Importar e Substituir</button>
                        </div>
                    </div>
                </dialog>
                <div class="flex items-center gap-1 card !shadow-sm !hover:scale-100 rounded-full p-0.5">
                    <button id="prev-month-btn" class="p-1.5 rounded-full transition-colors hover:bg-gray-200 active:bg-gray-300">
                        <span class="material-symbols-outlined">chevron_left</span>
                    </button>
                    <div class="relative">
                        <span id="current-month-display" class="w-36 text-center font-semibold text-gray-700 whitespace-nowrap cursor-pointer text-sm">Setembro 2025</span>
                        <!-- Month picker popover (hidden by default) -->
                        <div id="month-picker" class="hidden absolute z-50 mt-2 right-0 w-56 bg-white rounded-lg shadow-lg border border-gray-200 p-3">
                            <div class="space-y-2">
                                <label class="block text-xs text-gray-500">Mês</label>
                                <select id="month-picker-month" class="w-full border-gray-200 rounded-md p-1 text-sm">
                                    <option value="0">Janeiro</option>
                                    <option value="1">Fevereiro</option>
                                    <option value="2">Março</option>
                                    <option value="3">Abril</option>
                                    <option value="4">Maio</option>
                                    <option value="5">Junho</option>
                                    <option value="6">Julho</option>
                                    <option value="7">Agosto</option>
                                    <option value="8">Setembro</option>
                                    <option value="9">Outubro</option>
                                    <option value="10">Novembro</option>
                                    <option value="11">Dezembro</option>
                                </select>
                                <label class="block text-xs text-gray-500">Ano</label>
                                <select id="month-picker-year" class="w-full border-gray-200 rounded-md p-1 text-sm"></select>
                                <div class="flex justify-end gap-2 pt-2">
                                    <button id="month-picker-cancel" type="button" class="px-3 py-1 text-sm rounded bg-gray-100 hover:bg-gray-200">Cancelar</button>
                                    <button id="month-picker-apply" type="button" class="px-3 py-1 text-sm rounded bg-blue-600 text-white hover:bg-blue-700">Ir</button>
                                </div>
                            </div>
                        </div>
                        <!-- Expenses Filter Popover (responsive) -->
                        <div id="expenses-filter-popover" class="hidden absolute z-50 bg-white rounded-lg shadow-lg border border-gray-200 p-4 w-auto max-w-xs md:max-w-md lg:max-w-lg" style="max-width:calc(100vw - 2rem); right:0;">
                            <h3 class="text-sm font-semibold mb-2">Filtrar Despesas</h3>
                            <div class="space-y-2 text-sm">
                                <div class="grid grid-cols-1 gap-3">
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                        <div class="relative select-with-icon">
                                            <label class="block text-xs text-gray-500">Pagamento</label>
                                            <span class="material-symbols-outlined select-icon text-gray-400">payment</span>
                                            <select id="filter-payment-method" class="w-full border-gray-200 rounded-md p-1 text-sm pl-8">
                                                <option value="">Todos</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-500">Essencialidade</label>
                                            <select id="filter-spending-type" class="w-full border-gray-200 rounded-md p-1 text-sm">
                                                <option value="">Todos</option>
                                                <option value="essencial">Essencial</option>
                                                <option value="nao-essencial">Não Essencial</option>
                                                <option value="reserva">Reserva</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                        <div class="relative select-with-icon">
                                            <label class="block text-xs text-gray-500">Categoria</label>
                                            <span class="material-symbols-outlined select-icon text-gray-400">category</span>
                                            <select id="filter-category" class="w-full border-gray-200 rounded-md p-1 text-sm pl-8">
                                                <option value="">Todas</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-500">Tipo</label>
                                            <select id="filter-type" class="w-full border-gray-200 rounded-md p-1 text-sm">
                                                <option value="">Todos</option>
                                                <option value="expense">Despesa</option>
                                                <option value="saving">Reserva</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2">
                                        <div class="flex items-center gap-2"><input type="checkbox" id="filter-recurring" /> <label for="filter-recurring" class="text-sm">Recorrente</label></div>
                                        <div class="flex items-center gap-2"><input type="checkbox" id="filter-installment" /> <label for="filter-installment" class="text-sm">Parcelada / Financiamento</label></div>
                                    </div>
                                </div>
                                <div class="flex justify-end gap-2 pt-2">
                                    <button id="filter-clear-btn" class="px-3 py-1 text-sm rounded bg-gray-100 hover:bg-gray-200">Limpar</button>
                                    <button id="filter-apply-btn" class="px-3 py-1 text-sm rounded bg-blue-600 text-white hover:bg-blue-700">Aplicar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button id="next-month-btn" class="p-1.5 rounded-full transition-colors hover:bg-gray-200 active:bg-gray-300">
                        <span class="material-symbols-outlined">chevron_right</span>
                    </button>
                     <button id="today-btn" class="p-1.5 rounded-full transition-colors hover:bg-gray-200 active:bg-gray-300" title="Voltar para o mês atual">
                        <span class="material-symbols-outlined">today</span>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Abas de Navegação -->
        <div class="mb-6">
            <div id="tabs" class="flex sm:hidden items-center p-0.5 space-x-1 bg-gray-200 rounded-lg max-w-lg mx-auto">
                 <button data-view="dashboard" class="tab-button w-full py-1.5 text-sm font-semibold text-gray-600 rounded-md transition-colors">Visão Geral</button>
                 <button data-view="credit-cards" class="tab-button w-full py-1.5 text-sm font-semibold text-gray-600 rounded-md transition-colors">Faturas</button>
                 <button data-view="investments" class="tab-button w-full py-1.5 text-sm font-semibold text-gray-600 rounded-md transition-colors">Investimentos</button>
                 <button data-view="travel-planner" class="tab-button w-full py-1.5 text-sm font-semibold text-gray-600 rounded-md transition-colors">Planejadora</button>
            </div>
        </div>
        
        <main id="app-content">
            <!-- Conteúdo da Visão Geral (Dashboard) -->
            <div id="dashboard-view" class="space-y-8">
                <!-- KPIs Modernos -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 animate-slide-up">
                    <div class="kpi-card kpi-income">
                        <div class="kpi-title">Total de Entradas</div>
                        <div id="kpi-total-income" class="kpi-value">R$ 0,00</div>
                        <div class="kpi-trend">
                            <span class="material-symbols-outlined" style="font-size: 16px;">trending_up</span>
                            <span>Receitas do mês</span>
                        </div>
                    </div>
                    <div class="kpi-card kpi-expenses">
                        <div class="kpi-title">Despesas (Pagas)</div>
                        <div id="kpi-total-expenses" class="kpi-value">R$ 0,00</div>
                        <div class="kpi-trend">
                            <span class="material-symbols-outlined" style="font-size: 16px;">trending_down</span>
                            <span>Gastos realizados</span>
                        </div>
                    </div>
                    <div class="kpi-card kpi-savings">
                        <div class="kpi-title">Reservado / Investido</div>
                        <div id="kpi-total-savings" class="kpi-value">R$ 0,00</div>
                        <div class="kpi-trend">
                            <span class="material-symbols-outlined" style="font-size: 16px;">savings</span>
                            <span>Valor poupado</span>
                        </div>
                    </div>
                    <div class="kpi-card kpi-balance">
                        <div class="kpi-title">Saldo Disponível</div>
                        <div id="kpi-balance" class="kpi-value">R$ 0,00</div>
                        <div class="kpi-trend">
                            <span class="material-symbols-outlined" style="font-size: 16px;">account_balance_wallet</span>
                            <span>Disponível agora</span>
                        </div>
                    </div>
                </div>
                <!-- Conteúdo Principal: Tabelas e Gráficos -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Coluna de Transações -->
                    <div class="lg:col-span-2 space-y-8">
                        <!-- Movimentações do Mês header removed; add button moved to header -->

                        <!-- Tabela de Entradas Modernizada -->
                        <div class="modern-card p-6 animate-fade-in">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-success-100 rounded-lg">
                                        <span class="material-symbols-outlined text-success-600">trending_up</span>
                                    </div>
                                    <div>
                                        <h2 class="text-xl font-semibold text-gray-800">Entradas</h2>
                                        <p class="text-sm text-gray-500">Receitas do período atual</p>
                                    </div>
                                </div>
                                <div id="vr-badge" class="modern-badge modern-badge-success"></div>
                            </div>
                             <div class="overflow-x-auto">
                                <table id="income-table" class="modern-table" style="table-layout:fixed;">
                                    <colgroup>
                                        <col style="width:calc(100% - 266px)"> <!-- descrição (auto, ocupa o restante) -->
                                        <col style="width:170px"> <!-- valor (aumentado para mostrar valores completos) -->
                                        <col style="width:96px"> <!-- ações (reduced to fit two icons) -->
                                    </colgroup>
                                    <thead>
                                        <tr>
                                            <th>Descrição</th>
                                            <th>Valor</th>
                                            <th style="text-align: right;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="income-table-body"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tabela de Despesas Modernizada -->
                        <div class="modern-card p-6 animate-fade-in">
                             <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-error-100 rounded-lg">
                                        <span class="material-symbols-outlined text-error-600">trending_down</span>
                                    </div>
                                    <div>
                                        <h2 class="text-xl font-semibold text-gray-800">Despesas</h2>
                                        <p class="text-sm text-gray-500">Gastos do período atual</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class="modern-input-group" style="width: 200px;">
                                        <span class="modern-input-icon material-symbols-outlined">search</span>
                                        <input type="search" id="search-description" placeholder="Pesquisar despesas..." class="modern-input">
                                    </div>
                                    <button id="expenses-filter-btn" class="modern-btn modern-btn-secondary relative" title="Filtrar despesas">
                                        <span class="material-symbols-outlined">filter_list</span>
                                        <span id="expenses-filter-badge" class="absolute -top-1 -right-1 inline-flex items-center justify-center px-1.5 py-0.5 text-xs font-medium leading-none text-white bg-red-600 rounded-full">0</span>
                                    </button>
                                    <!-- Toggle: Agrupar despesas por descrição -->
                                    <button id="toggle-expense-grouped" class="modern-btn modern-btn-secondary" title="Alternar visão agrupada">
                                        <span class="material-symbols-outlined">view_module</span>
                                        <span id="toggle-expense-grouped-label">Agrupar</span>
                                    </button>
                                </div>
                             </div>
                             <div class="overflow-x-auto">
                                <table class="modern-table" style="table-layout:fixed;">
                                    <colgroup>
                                        <col style="width:36px"> <!-- checkbox -->
                                        <col> <!-- descrição (auto, ocupa o restante) -->
                                        <col style="width:120px"> <!-- pagamento -->
                                        <col style="width:120px"> <!-- categoria -->
                                        <col style="width:120px"> <!-- valor -->
                                        <col style="width:80px"> <!-- ações -->
                                    </colgroup>
                                    <thead id="expenses-table-head">
                                        <tr>
                                            <th class="sortable-header" data-sort="isPaid" title="Ordenar por pago/não pago" style="cursor:pointer">
                                                <span class="material-symbols-outlined text-gray-500 text-base">done</span>
                                            </th>
                                            <th class="sortable-header" data-sort="description" style="cursor:pointer">
                                                Descrição <span class="sort-icon material-symbols-outlined"></span>
                                            </th>
                                            <th class="sortable-header" data-sort="payment" style="cursor:pointer">
                                                Pagamento <span class="sort-icon material-symbols-outlined"></span>
                                            </th>
                                            <th class="sortable-header" data-sort="category" style="cursor:pointer">
                                                Categoria <span class="sort-icon material-symbols-outlined"></span>
                                            </th>
                                            <th class="sortable-header" data-sort="amount" style="cursor:pointer">
                                                Valor <span class="sort-icon material-symbols-outlined"></span>
                                            </th>
                                            <th style="text-align: right;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expenses-table-body"></tbody>
                                </table>
                            </div>
                            <!-- Grouped view container (hidden by default) -->
                            <div id="expenses-grouped-container" class="mt-4 hidden">
                                <div id="expenses-groups" class="expenses-groups"></div>
                            </div>
                        </div>
                        
                        <!-- Tabela de Reservas Modernizada -->
                        <div class="modern-card p-6 animate-fade-in">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="p-2 bg-primary-100 rounded-lg">
                                    <span class="material-symbols-outlined text-primary-600">savings</span>
                                </div>
                                <div>
                                    <h2 class="text-xl font-semibold text-gray-800">Reservas e Investimentos</h2>
                                    <p class="text-sm text-gray-500">Valores poupados e investidos</p>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="modern-table">
                                    <thead>
                                        <tr>
                                            <th>Descrição</th>
                                            <th>Categoria</th>
                                            <th>Valor</th>
                                            <th style="text-align: right;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="savings-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    
                    </div>
                     <!-- Coluna de Gráficos e Insights -->
                    <div class="lg:col-span-1 space-y-8">
                        <!-- Projeções do Mês -->
                        <div class="modern-card p-4 animate-scale-in">
                            <div class="flex items-center gap-2 mb-4">
                                <span class="material-symbols-outlined text-primary-600">trending_up</span>
                                <h3 class="font-semibold text-gray-800">Projeções</h3>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <div class="w-2 h-2 bg-success-500 rounded-full"></div>
                                        <span class="text-sm text-gray-600">Saldo Projetado</span>
                                    </div>
                                    <span id="kpi-projected-balance" class="text-base font-semibold text-success-600">R$ 0,00</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <div class="w-2 h-2 bg-error-500 rounded-full"></div>
                                        <span class="text-sm text-gray-600">Despesas Projetadas</span>
                                    </div>
                                    <span id="kpi-projected-expenses" class="text-base font-semibold text-error-600">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                        <!-- VR KPI: minimal — shows available balance and spent progress -->
                        <div id="kpi-vr-card" class="card p-2 rounded-xl mb-2">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="text-xs font-medium text-gray-500">VR - Uso</h4>
                                </div>
                                <div class="text-right">
                                    <!-- Show available balance (credited - used), same value as the VR card in Faturas -->
                                    <p id="kpi-vr-values" class="text-sm font-semibold text-green-600">R$ 0,00</p>
                                </div>
                            </div>
                            <div class="mt-2">
                                <div class="w-full bg-gray-200 rounded h-4 overflow-hidden relative">
                                    <div id="kpi-vr-progress" class="h-4 w-0 flex items-center justify-end pr-1 text-xs text-white" style="transition: width 360ms ease;"></div>
                                    <div id="kpi-vr-bar-text" class="absolute inset-0 flex items-center justify-center text-xs text-gray-700 pointer-events-none"></div>
                                </div>
                            </div>
                        </div>
                        <!-- VT KPI: mirror VR immediately below -->
                        <div id="kpi-vt-card" class="card p-2 rounded-xl mb-2">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="text-xs font-medium text-gray-500">VT - Uso</h4>
                                </div>
                                <div class="text-right">
                                    <p id="kpi-vt-values" class="text-sm font-semibold text-yellow-600">R$ 0,00</p>
                                </div>
                            </div>
                            <div class="mt-2">
                                <div class="w-full bg-gray-200 rounded h-4 overflow-hidden relative">
                                    <div id="kpi-vt-progress" class="h-4 w-0 flex items-center justify-end pr-1 text-xs text-white" style="transition: width 360ms ease;"></div>
                                    <div id="kpi-vt-bar-text" class="absolute inset-0 flex items-center justify-center text-xs text-gray-700 pointer-events-none"></div>
                                </div>
                            </div>
                        </div>
                        <div id="feedback-card" class="card p-6 rounded-xl">
                             <h2 class="text-xl font-semibold mb-2">Feedback do Mês</h2>
                             <p id="feedback-message" class="text-gray-600 text-sm mb-4">...</p>
                             <div id="feedback-visual-container" class="space-y-3"></div>
                        </div>
                        <!-- Metas de Gastos removed per request -->
                        <!-- Gráficos Modernizados -->
                        <div class="modern-chart-container animate-fade-in">
                            <div class="modern-chart-header">
                                <div>
                                    <div class="modern-chart-title">
                                        <span class="material-symbols-outlined text-warning-600">pie_chart</span>
                                        Gastos por Categoria
                                    </div>
                                    <div class="modern-chart-subtitle">Distribuição das despesas por categoria</div>
                                </div>
                            </div>
                            <div class="chart-canvas-wrapper">
                                <div class="h-56"><canvas id="category-spending-chart"></canvas></div>
                            </div>
                        </div>
                        
                        <div class="modern-chart-container animate-fade-in">
                            <div class="modern-chart-header">
                                <div>
                                    <div class="modern-chart-title">
                                        <span class="material-symbols-outlined text-primary-600">payment</span>
                                        Gastos por Pagamento
                                    </div>
                                    <div class="modern-chart-subtitle">Análise por forma de pagamento</div>
                                </div>
                            </div>
                            <div class="chart-canvas-wrapper">
                                <div class="h-56"><canvas id="payment-method-chart"></canvas></div>
                            </div>
                        </div>
                        
                        <div class="modern-chart-container animate-fade-in">
                            <div class="modern-chart-header">
                                <div>
                                    <div class="modern-chart-title">
                                        <span class="material-symbols-outlined text-success-600">trending_up</span>
                                        Resumo Anual
                                    </div>
                                    <div class="modern-chart-subtitle">Visão geral das finanças do ano</div>
                                </div>
                            </div>
                            <div class="chart-canvas-wrapper">
                                <div class="h-56"><canvas id="annual-summary-chart"></canvas></div>
                            </div>
                        </div>
                        <!-- KPI Percentual de cada despesa do mês -->
                        <div class="card p-4 rounded-lg mb-4 bg-gray-50 border border-gray-200">
                            <h3 class="text-sm font-medium text-gray-500 mb-2">Percentual de cada despesa do mês</h3>
                            <div id="kpi-expense-percentuals" class="space-y-1"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Conteúdo das Faturas de Cartão -->
            <div id="credit-cards-view" class="hidden">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-8" id="credit-cards-container"></div>
            </div>

            <!-- Conteúdo de Investimentos -->
            <div id="investments-view" class="hidden space-y-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="card p-5 rounded-xl col-span-1 sm:col-span-2 lg:col-span-2">
                        <h3 class="text-sm font-medium text-gray-500">Patrimônio Total Acumulado</h3>
                        <p id="kpi-total-invested" class="text-3xl font-bold text-indigo-600 mt-1">R$ 0,00</p>
                    </div>
                    <div class="card p-5 rounded-xl">
                        <h3 class="text-sm font-medium text-gray-500">Aporte no Mês</h3>
                        <p id="kpi-monthly-investment" class="text-2xl font-semibold text-green-600 mt-1">R$ 0,00</p>
                    </div>
                    <div class="card p-5 rounded-xl">
                        <h3 class="text-sm font-medium text-gray-500">Média Mensal de Aportes</h3>
                        <p id="kpi-avg-monthly-investment" class="text-2xl font-semibold text-gray-800 mt-1">R$ 0,00</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6 rounded-xl">
                        <h2 class="text-xl font-semibold mb-4">Evolução dos Aportes (Ano)</h2>
                        <div class="h-80"><canvas id="monthly-savings-chart"></canvas></div>
                    </div>
                    <div class="card p-6 rounded-xl">
                        <h2 class="text-xl font-semibold mb-4">Composição da Carteira</h2>
                        <div class="h-80"><canvas id="portfolio-composition-chart"></canvas></div>
                    </div>
                </div>
                
                <div class="card p-6 rounded-xl">
                     <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold">Metas e Sonhos</h2>
                        <button id="add-goal-btn" class="btn-primary font-medium py-2 px-4 rounded-lg flex items-center gap-2 transition-transform active:scale-95">
                            <span class="material-symbols-outlined">add</span>
                            <span>Nova Meta</span>
                        </button>
                    </div>
                    <div id="goals-container" class="space-y-4"></div>
                </div>

                <div class="card p-6 rounded-xl">
                    <h2 class="text-xl font-semibold mb-4">Projeção de Crescimento (Juros de 8% a.a.)</h2>
                    <p class="text-sm text-gray-600 mb-4">Com base na sua média de aportes, seu patrimônio pode chegar a:</p>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-2xl font-bold text-indigo-600" id="projection-1y">R$ 0,00</p>
                            <p class="text-sm text-gray-500">em 1 ano</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-indigo-600" id="projection-5y">R$ 0,00</p>
                            <p class="text-sm text-gray-500">em 5 anos</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-indigo-600" id="projection-10y">R$ 0,00</p>
                            <p class="text-sm text-gray-500">em 10 anos</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Conteúdo da Planejadora de Viagens -->
            <div id="travel-planner-view" class="hidden space-y-6">
                <div class="card p-6 rounded-xl">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold">Planejadora de Viagens</h2>
                        <button id="tp-add-plan-btn" class="btn-primary font-medium py-2 px-3 rounded-lg flex items-center gap-2">
                            <span class="material-symbols-outlined">flight_takeoff</span>
                            <span>Adicionar Viagem</span>
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">Planeje seus próximos sonhos: defina destino, custo estimado e data alvo. Aqui você pode acompanhar quanto precisa poupar.</p>
                    <div id="tp-plans" class="space-y-3"></div>
                    <div id="tp-form" class="mt-4 hidden">
                        <input type="hidden" id="tp-id" />
                        <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                            <div>
                                <input id="tp-destination" placeholder="Destino" class="border p-2 rounded w-full" />
                                <div id="tp-destination-error" class="text-xs text-red-600 mt-1 hidden"></div>
                            </div>
                            <div>
                                <input id="tp-date" type="date" class="border p-2 rounded w-full" />
                                <div id="tp-date-error" class="text-xs text-red-600 mt-1 hidden"></div>
                            </div>
                            <div>
                                <input id="tp-cost" placeholder="Custo estimado (R$)" class="border p-2 rounded w-full" />
                                <div id="tp-cost-error" class="text-xs text-red-600 mt-1 hidden"></div>
                            </div>
                            <div>
                                <input id="tp-saved" placeholder="Já poupado (R$)" class="border p-2 rounded w-full" />
                                <div id="tp-saved-error" class="text-xs text-red-600 mt-1 hidden"></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mt-3">
                            <button id="tp-save-btn" class="px-3 py-1 rounded bg-indigo-600 text-white">Salvar</button>
                            <button id="tp-cancel-btn" class="px-3 py-1 rounded bg-gray-100">Cancelar</button>
                        </div>
                    </div>
                </div>

                <!-- Dashboard do Plano Selecionado -->
                <div id="tp-selected-dashboard" class="hidden">
                    <!-- Cabeçalho do Dashboard -->
                    <div class="card p-6 rounded-xl mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="p-3 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl shadow-lg">
                                    <span class="material-symbols-outlined text-white" style="font-size: 40px; font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 48;">luggage</span>
                                </div>
                                <div>
                                    <h2 id="tp-dash-title" class="text-2xl font-bold text-gray-800">Destino</h2>
                                    <p id="tp-dash-subtitle" class="text-sm text-gray-500">Data da viagem</p>
                                </div>
                            </div>
                            <button id="tp-dash-close" class="p-2 rounded-lg hover:bg-gray-100 transition-colors" title="Fechar dashboard">
                                <span class="material-symbols-outlined text-gray-600">close</span>
                            </button>
                        </div>
                    </div>

                    <!-- Cards de Resumo Financeiro -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="kpi-card kpi-income">
                            <div class="kpi-title">Orçado</div>
                            <div id="tp-dash-budget" class="kpi-value">R$ 0,00</div>
                            <div class="kpi-trend">
                                <span class="material-symbols-outlined" style="font-size: 16px;">savings</span>
                                <span>Planejado</span>
                            </div>
                        </div>

                        <div class="kpi-card kpi-savings">
                            <div class="kpi-title">Realizado</div>
                            <div id="tp-dash-realized" class="kpi-value">R$ 0,00</div>
                            <div class="kpi-trend">
                                <span class="material-symbols-outlined" style="font-size: 16px;">account_balance_wallet</span>
                                <span>Reservado (meta)</span>
                            </div>
                        </div>

                        <div class="kpi-card" style="border-left: 4px solid #8B5CF6;">
                            <div class="kpi-title">Pago</div>
                            <div id="tp-dash-paid" class="kpi-value" style="color: #8B5CF6;">R$ 0,00</div>
                            <div class="kpi-trend" style="color: #8B5CF6;">
                                <span class="material-symbols-outlined" style="font-size: 16px;">paid</span>
                                <span>Já pago</span>
                            </div>
                        </div>

                        <div class="kpi-card" style="border-left: 4px solid #F59E0B;">
                            <div class="kpi-title">Restante</div>
                            <div id="tp-dash-remaining" class="kpi-value" style="color: #F59E0B;">R$ 0,00</div>
                            <div class="kpi-trend" style="color: #F59E0B;">
                                <span class="material-symbols-outlined" style="font-size: 16px;">trending_up</span>
                                <span>A poupar</span>
                            </div>
                        </div>
                    </div>

                    <!-- Progresso da Viagem -->
                    <div class="modern-card p-6 mb-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="p-2 bg-indigo-100 rounded-lg">
                                <span class="material-symbols-outlined text-indigo-600">moving</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-semibold text-gray-800">Progresso do Plano</h3>
                                    <span id="tp-dash-progress-pct" class="text-lg font-bold text-indigo-600">0%</span>
                                </div>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div id="tp-dash-progress-bar" class="h-full rounded-full transition-all duration-500" style="width: 0%; background-color: #818CF8;"></div>
                        </div>
                    </div>

                    <!-- Breakdown de Custos -->
                    <div class="modern-card p-6 mb-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="p-2 bg-orange-100 rounded-lg">
                                <span class="material-symbols-outlined text-orange-600">account_balance</span>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-800">Custos Totais</h3>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="tp-dash-costs">
                            <!-- Gerado dinamicamente -->
                        </div>
                    </div>

                    <!-- Roteiro da Viagem (Resumido) -->
                    <div class="modern-card p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-sky-100 rounded-lg">
                                    <span class="material-symbols-outlined text-sky-600">event</span>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">Roteiro da Viagem</h3>
                            </div>
                            <span id="tp-dash-events-count" class="modern-badge modern-badge-info">0 eventos</span>
                        </div>
                        <div id="tp-dash-itinerary" class="space-y-2 max-h-96 overflow-y-auto">
                            <!-- Gerado dinamicamente -->
                        </div>
                    </div>

                    <!-- Seções (Transportes, Hospedagem, Atividades) -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Transportes -->
                        <div class="modern-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-sky-100 rounded-lg">
                                        <span class="material-symbols-outlined text-sky-600">directions_car</span>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-800">Transportes</h3>
                                </div>
                                <span id="tp-dash-transport-count" class="modern-badge modern-badge-info">0</span>
                            </div>
                            <div id="tp-dash-transports" class="space-y-2">
                                <!-- Gerado dinamicamente -->
                            </div>
                        </div>

                        <!-- Hospedagens -->
                        <div class="modern-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-rose-100 rounded-lg">
                                        <span class="material-symbols-outlined text-rose-600">hotel</span>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-800">Hospedagens</h3>
                                </div>
                                <span id="tp-dash-accommodation-count" class="modern-badge modern-badge-error">0</span>
                            </div>
                            <div id="tp-dash-accommodations" class="space-y-2">
                                <!-- Gerado dinamicamente -->
                            </div>
                        </div>

                        <!-- Atividades -->
                        <div class="modern-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-purple-100 rounded-lg">
                                        <span class="material-symbols-outlined text-purple-600">tour</span>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-800">Atividades</h3>
                                </div>
                                <span id="tp-dash-activity-count" class="modern-badge modern-badge-warning">0</span>
                            </div>
                            <div id="tp-dash-activities" class="space-y-2">
                                <!-- Gerado dinamicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Checklist -->
                    <div class="modern-card p-6 mt-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-success-100 rounded-lg">
                                    <span class="material-symbols-outlined text-success-600">checklist</span>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">Checklist da Viagem</h3>
                            </div>
                            <span id="tp-dash-checklist-progress" class="modern-badge modern-badge-success">0%</span>
                        </div>
                        <div id="tp-dash-checklist" class="space-y-2">
                            <!-- Gerado dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Transação Modernizado -->
    <dialog id="transaction-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="transaction-error" class="modern-card p-6 w-full max-w-4xl animate-scale-in" style="max-height:98vh;overflow:auto !important;">
        <div class="flex items-center justify-between mb-6 modal-title-row">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-primary-100 rounded-lg">
                    <span class="material-symbols-outlined text-primary-600">receipt_long</span>
                </div>
                <div>
                    <h2 id="modal-title" class="text-2xl font-bold text-gray-800">Nova Transação</h2>
                    <p class="text-sm text-gray-500">Adicione receitas, despesas ou reservas</p>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:12px">
                <span id="modal-type-indicator" class="modern-badge modern-badge-info"></span>
                <button id="close-transaction-modal" type="button" class="modern-btn modern-btn-secondary" aria-label="Fechar janela de nova transação">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
        </div>
    <form id="transaction-form" class="space-y-5 text-base mx-auto max-w-3xl">
            <input type="hidden" id="transaction-id">
            <div id="transaction-error" role="alert" aria-live="assertive" aria-atomic="true" class="hidden text-sm text-red-700 bg-red-50 border border-red-100 p-2 rounded">&nbsp;</div>
            <!-- Seletor de Tipo de Transação Modernizado -->
            <div class="bg-gray-50 p-4 rounded-xl mb-6">
                <h3 class="text-sm font-semibold text-gray-700 mb-3">Tipo de Transação</h3>
                <div class="grid grid-cols-3 gap-3">
                    <button type="button" data-type="expenses" class="modal-type-toggle modern-transaction-type flex flex-col items-center p-4 rounded-lg border-2 border-gray-200 bg-white hover:border-error-300 transition-all focus:outline-none group">
                        <div class="p-2 bg-error-100 rounded-lg mb-2 group-hover:bg-error-200 transition-colors">
                            <span class="material-symbols-outlined text-xl text-error-600">trending_down</span>
                        </div>
                        <span class="text-sm font-semibold text-gray-700">Despesa</span>
                        <span class="text-xs text-gray-500">Gastos realizados</span>
                    </button>
                    <button type="button" data-type="incomes" class="modal-type-toggle modern-transaction-type flex flex-col items-center p-4 rounded-lg border-2 border-gray-200 bg-white hover:border-success-300 transition-all focus:outline-none group">
                        <div class="p-2 bg-success-100 rounded-lg mb-2 group-hover:bg-success-200 transition-colors">
                            <span class="material-symbols-outlined text-xl text-success-600">trending_up</span>
                        </div>
                        <span class="text-sm font-semibold text-gray-700">Entrada</span>
                        <span class="text-xs text-gray-500">Receitas obtidas</span>
                    </button>
                    <button type="button" data-type="savings" class="modal-type-toggle modern-transaction-type flex flex-col items-center p-4 rounded-lg border-2 border-gray-200 bg-white hover:border-primary-300 transition-all focus:outline-none group">
                        <div class="p-2 bg-primary-100 rounded-lg mb-2 group-hover:bg-primary-200 transition-colors">
                            <span class="material-symbols-outlined text-xl text-primary-600">savings</span>
                        </div>
                        <span class="text-sm font-semibold text-gray-700">Reserva</span>
                        <span class="text-xs text-gray-500">Valores poupados</span>
                    </button>
                </div>
            </div>
        <style>
        /* Estilos modernos para seletor de tipo de transação */
        .modern-transaction-type.selected[data-type="expenses"] {
            border-color: var(--error-500) !important;
            background: var(--error-50) !important;
            box-shadow: 0 0 0 3px var(--error-100) !important;
        }
        
        .modern-transaction-type.selected[data-type="incomes"] {
            border-color: var(--success-500) !important;
            background: var(--success-50) !important;
            box-shadow: 0 0 0 3px var(--success-100) !important;
        }
        
        .modern-transaction-type.selected[data-type="savings"] {
            border-color: var(--primary-500) !important;
            background: var(--primary-50) !important;
            box-shadow: 0 0 0 3px var(--primary-100) !important;
        }

        /* Melhor feedback para campos de formulário no modal */
        #transaction-modal .modern-form-group {
            margin-bottom: 1.5rem;
        }

        #transaction-modal .modern-form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        #transaction-modal .modern-form-description {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        #transaction-modal .modern-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        /* Animação para os campos quando preenchidos */
        #transaction-modal .modern-input:not(:placeholder-shown),
        #transaction-modal .modern-select:not([value=""]) {
            border-color: var(--primary-300);
            background-color: var(--primary-50);
        }
        #modal-type-indicator {
            min-width: 90px;
            text-align: center;
        }
        </style>
        <script>
        // Modal UX: update type indicator and highlight selected type
        function updateModalTypeUI(type) {
            // normalize various possible type strings into one of: 'expenses','incomes','reserve'
            function normalizeType(t) {
                if (!t) return 'expenses';
                t = String(t).toLowerCase();
                if (t === 'savings' || t === 'reserve' || t === 'savings' || t === 'saving') return 'reserve';
                if (t === 'incomes' || t === 'income' || t === 'entrada' || t === 'in') return 'incomes';
                if (t === 'expenses' || t === 'expense' || t === 'despesa' || t === 'out') return 'expenses';
                return t;
            }
            const normType = normalizeType(type);
            const indicator = document.getElementById('modal-type-indicator');
            const btns = document.querySelectorAll('.modal-type-toggle');
            // use normalized type early so subsequent code can rely on it
            const t = normType;
            btns.forEach(btn => {
                btn.classList.remove('selected');
                // compare normalized dataset type to normalized input type
                const btnTypeNorm = normalizeType(btn.dataset.type);
                if (btnTypeNorm === normType) {
                    btn.classList.add('selected');
                    let icon = btn.querySelector('.material-symbols-outlined').outerHTML;
                    let label = btn.querySelector('span:last-child').textContent;
                    indicator.innerHTML = icon + ' ' + label;
                }
            });
            // Also set inline styles on the selected toggle to guarantee highlight (override any other rules)
            btns.forEach(b => {
                // reset inline visual styles
                b.style.borderColor = '';
                b.style.background = '';
                const iconEl = b.querySelector('.material-symbols-outlined');
                const textEl = b.querySelector('span.text-sm') || b.querySelector('span:last-child');
                if (iconEl) iconEl.style.color = '';
                if (textEl) textEl.style.color = '';
                // apply to the selected one
                if (b.classList.contains('selected')) {
                    if (t === 'incomes') {
                        b.style.borderColor = '#16a34a';
                        b.style.background = '#d1fae5';
                        if (iconEl) iconEl.style.color = '#16a34a';
                        if (textEl) textEl.style.color = '#16a34a';
                    } else if (t === 'expenses') {
                        b.style.borderColor = '#dc2626';
                        b.style.background = '#fee2e2';
                        if (iconEl) iconEl.style.color = '#dc2626';
                        if (textEl) textEl.style.color = '#dc2626';
                    } else { // reserve/savings
                        b.style.borderColor = '#eab308';
                        b.style.background = '#fef9c3';
                        if (iconEl) iconEl.style.color = '#eab308';
                        if (textEl) textEl.style.color = '#eab308';
                    }
                }
            });
            // Atualiza classe do botão de salvar (determinístico)
            const saveBtn = document.getElementById('modal-save-btn');
            const saveIcon = document.getElementById('modal-save-icon');
            // remove any tailwind background classes that could override our styles
            // Keep input text dimmed until user types — add/remove .has-value for browsers without :placeholder-shown
            function setupValueListeners(container) {
                var inputs = container.querySelectorAll('input, textarea');
                inputs.forEach(function (inp) {
                    function update() {
                        if (inp.value && inp.value.trim() !== '') {
                            inp.classList.add('has-value');
                        }
                        else {
                            inp.classList.remove('has-value');
                        }
                    }
                    inp.addEventListener('input', update);
                    // initialize
                    update();
                });
            }
            // Prefer direct element lookup so this function can run before the `ui` map is initialized
            const installmentsFieldsEl = document.getElementById('installments-fields');
            const financingFieldsEl = document.getElementById('financing-fields');
            if (installmentsFieldsEl) setupValueListeners(installmentsFieldsEl);
            if (financingFieldsEl) setupValueListeners(financingFieldsEl);
            saveBtn.classList.remove('bg-blue-600','bg-blue-500','bg-green-600','bg-green-500','bg-yellow-400','bg-yellow-500','bg-red-600','bg-red-500','hover:bg-blue-700','hover:bg-green-700','hover:bg-red-700');
            saveBtn.classList.remove('save-type-expenses', 'save-type-incomes', 'save-type-reserve');
            if (t === 'expenses') saveBtn.classList.add('save-type-expenses');
            else if (t === 'incomes') saveBtn.classList.add('save-type-incomes');
            else saveBtn.classList.add('save-type-reserve');
            // icon color: dark for reserve (yellow background), white otherwise
            if (saveBtn.classList.contains('save-type-reserve')) {
                saveIcon.style.color = '#111827';
            } else {
                saveIcon.style.color = '#fff';
            }
            // Build a stable inline style string and set it directly to avoid CSS precedence issues
            let color = '#dc2626';
            let border = '#b91c1c';
            let box = '0 2px 10px #dc262644';
            let textCol = '#fff';
            if (t === 'incomes') { color = '#16a34a'; border = '#15803d'; box = '0 2px 10px #16a34a44'; }
            else if (t === 'reserve') { color = '#eab308'; border = '#d6a013'; box = '0 2px 10px #eab30844'; textCol = '#111827'; }
            const styleString = `background:${color} !important; background-color:${color} !important; background-image:none !important; border:2px solid ${border} !important; box-shadow:${box} !important; color:${textCol} !important; opacity:1 !important; filter:none !important;`;
            try { saveBtn.setAttribute('style', styleString); } catch(e) { /* ignore */ }

            // Adjust advanced options visibility and labels depending on the selected type
            try {
                // Select labels deterministically by for="..." so we don't depend on DOM nesting
                const installmentLabel = document.querySelector('label[for="is-installment"]');
                const financingLabel = document.querySelector('label[for="is-financing"]');
                const salarySection = document.getElementById('salary-section');
                // Recurrence label stays visible always, no change needed
                // Use querySelectorAll to handle duplicated labels and set style.display to override other CSS
                const installmentLabels = document.querySelectorAll('label[for="is-installment"]');
                const financingLabels = document.querySelectorAll('label[for="is-financing"]');
                function hideLabels(nodelist) {
                    nodelist.forEach(l => {
                        const row = l.closest('.option-row');
                        if (row) {
                            row.classList.add('option-collapsed');
                        } else {
                            l.classList.add('hidden'); l.style.display = 'none';
                        }
                    });
                }
                function showLabels(nodelist) {
                    nodelist.forEach(l => {
                        const row = l.closest('.option-row');
                        if (row) {
                            row.classList.remove('option-collapsed');
                        } else {
                            l.classList.remove('hidden'); l.style.display = '';
                        }
                    });
                }
                if (t === 'incomes') {
                    // Hide financing
                    hideLabels(financingLabels);
                    // Show installment but change text to 'receita'
                    showLabels(installmentLabels);
                    installmentLabels.forEach(lbl => {
                        const txt = lbl.querySelector('span.ml-2') || lbl.querySelector('span:last-child');
                        if (txt) txt.textContent = 'É uma receita parcelada?';
                    });
                    if (salarySection) salarySection.classList.remove('hidden');
                    if (salarySection) salarySection.style.display = '';
                } else if (t === 'expenses') {
                    // Show financing and installment with expense wording
                    showLabels(financingLabels);
                    showLabels(installmentLabels);
                    installmentLabels.forEach(lbl => {
                        const txt = lbl.querySelector('span.ml-2') || lbl.querySelector('span:last-child');
                        if (txt) txt.textContent = 'É uma compra parcelada?';
                    });
                    if (salarySection) { salarySection.classList.add('hidden'); salarySection.style.display = 'none'; }
                } else { // reserve
                    // Hide both
                    hideLabels(financingLabels);
                    hideLabels(installmentLabels);
                    if (salarySection) { salarySection.classList.add('hidden'); salarySection.style.display = 'none'; }
                }
            } catch (e) {
                console.error('updateModalTypeUI advanced options adjust error', e);
            }
        }
        // Initial call and event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const typeInput = document.getElementById('transaction-type-input');
            updateModalTypeUI(typeInput.value);
            document.querySelectorAll('.modal-type-toggle').forEach(btn => {
                btn.addEventListener('click', function() {
                    typeInput.value = btn.dataset.type;
                    updateModalTypeUI(btn.dataset.type);
                });
            });
            // Observa mudanças de habilitação do botão
            const saveBtn = document.getElementById('modal-save-btn');
            const observer = new MutationObserver(() => {
                updateModalTypeUI(typeInput.value);
            });
            observer.observe(saveBtn, { attributes: true, attributeFilter: ['disabled'] });
        });
        // Populate select controls with icons and update icon spans
        document.addEventListener('DOMContentLoaded', function() {
            // Expose a global set of icon mappings so renderers across the app can
            // show an icon whenever a payment method / category / type is rendered.
            window.ICON_MAPPINGS = {
                // Expanded and curated list of payment methods commonly used in a personal finance app
                paymentMethods: [
                    { value: 'BB (Débito)', label: 'BB (Débito)', icon: 'account_balance' },
                    { value: 'Inter (Débito)', label: 'Inter (Débito)', icon: 'credit_card' },
                    { value: 'Nubank', label: 'Nubank', icon: 'credit_card' },
                    { value: 'Porto', label: 'Porto', icon: 'credit_card' },
                    { value: 'VR', label: 'VR', icon: 'restaurant' },
                    { value: 'VT', label: 'VT', icon: 'directions_bus' },
                    { value: 'Dinheiro', label: 'Dinheiro', icon: 'paid' },
                    { value: 'PIX', label: 'PIX', icon: 'bolt' },
                    { value: 'Transferência', label: 'Transferência', icon: 'swap_horiz' },
                    { value: 'Boleto', label: 'Boleto', icon: 'receipt_long' },
                    { value: 'Apple Pay', label: 'Apple Pay', icon: 'smartphone' },
                    { value: 'Outro', label: 'Outro', icon: 'more_horiz' }
                ],

                // Curated expense categories covering typical household, lifestyle and financial items
                expenseCategories: [
                    { value: 'Mercado', label: 'Mercado / Supermercado', icon: 'local_grocery_store' },
                    { value: 'Alimentação', label: 'Alimentação (restaurantes, delivery)', icon: 'restaurant' },
                    { value: 'Compras', label: 'Compras / Varejo', icon: 'shopping_bag' },
                    { value: 'Assinaturas', label: 'Assinaturas (streaming, software)', icon: 'subscriptions' },
                    { value: 'Contas', label: 'Contas (água, luz, internet)', icon: 'receipt' },
                    { value: 'Moradia', label: 'Moradia (aluguel, condomínio)', icon: 'home' },
                    { value: 'Transporte', label: 'Transporte (combustível, apps)', icon: 'local_taxi' },
                    { value: 'Saúde', label: 'Saúde (remédios, consultas)', icon: 'medical_services' },
                    { value: 'Educação', label: 'Educação (cursos, livros)', icon: 'school' },
                    { value: 'Lazer', label: 'Lazer (cinema, bares, viagens curtas)', icon: 'local_play' },
                    { value: 'Viagem', label: 'Viagem / Hospedagem', icon: 'flight' },
                    { value: 'Vestuário', label: 'Vestuário / Moda', icon: 'checkroom' },
                    { value: 'Casa', label: 'Casa / Manutenção', icon: 'build' },
                    { value: 'Pets', label: 'Pets', icon: 'pets' },
                    { value: 'Doações', label: 'Doações / Caridade', icon: 'favorite' },
                    { value: 'Impostos', label: 'Impostos / Taxas', icon: 'paid' },
                    { value: 'Parcelas', label: 'Parcelas / Financiamento', icon: 'payments' },
                    { value: 'Investimentos', label: 'Investimentos (aporte)', icon: 'trending_up' },
                    { value: 'Outros', label: 'Outros', icon: 'category' }
                ],

                // Expense types to help budgeting and classification
                expenseTypes: [
                    { value: 'Essenciais', label: 'Essenciais', icon: 'checklist' },
                    { value: 'Não Essenciais', label: 'Não Essenciais', icon: 'local_offer' },
                    { value: 'Reserva', label: 'Reserva / Poupança', icon: 'savings' },
                    { value: 'Parcelada', label: 'Parcelada', icon: 'payments' },
                    { value: 'Recorrente', label: 'Recorrente', icon: 'autorenew' },
                    { value: 'Única', label: 'Única', icon: 'calendar_today' }
                ],

                // Saving categories that a typical personal finance project would include
                savingCategories: [
                    { value: 'Reserva Emergência', label: 'Reserva de Emergência', icon: 'savings' },
                    { value: 'Ações', label: 'Ações', icon: 'trending_up' },
                    { value: 'Fundos Imobiliários', label: 'Fundos Imobiliários (FII)', icon: 'apartment' },
                    { value: 'Criptomoedas', label: 'Criptomoedas', icon: 'currency_bitcoin' },
                    { value: 'Poupança', label: 'Poupança', icon: 'savings' },
                    { value: 'Tesouro Direto', label: 'Tesouro Direto', icon: 'account_balance' },
                    { value: 'Previdência', label: 'Previdência Privada', icon: 'shield' },
                    { value: 'Viagem', label: 'Viagem (meta)', icon: 'flight' },
                    { value: 'Reforma', label: 'Reforma / Casa', icon: 'home_repair_service' },
                    { value: 'Educação', label: 'Educação / Cursos', icon: 'school' },
                    { value: 'Carro', label: 'Carro / Transporte', icon: 'directions_car' },
                    { value: 'Imóvel', label: 'Imóvel / Entrada', icon: 'house' },
                    { value: 'Outros', label: 'Outros', icon: 'more_horiz' }
                ]
                ,
                // Vehicle mappings for VT modal (used to show icons next to vehicle options)
                vehicles: [
                    { value: 'Carro', label: 'Carro', icon: 'directions_car' },
                    { value: 'Moto', label: 'Moto', icon: 'two_wheeler' }
                ]
                ,
                    // Transport type mappings used by the Travel Planner
                    transportTypes: [
                        { value: 'voo', label: 'Voos', icon: 'flight' },
                        { value: 'carro', label: 'Carro/Moto', icon: 'directions_car' },
                        { value: 'aluguel', label: 'Aluguel de Carro', icon: 'car_rental' },
                        { value: 'uber', label: 'Uber/Taxi', icon: 'local_taxi' },
                        { value: 'publico', label: 'Transportes Públicos', icon: 'directions_bus' }
                    ]
                    ,
                // Fuel type mappings for VT modal
                fuelTypes: [
                    { value: 'Gasolina', label: 'Gasolina', icon: 'local_gas_station' },
                    { value: 'Gasolina Aditivada', label: 'Gas. Aditivada', icon: 'local_gas_station' },
                    { value: 'Etanol', label: 'Etanol', icon: 'eco' }
                ]
            };

            // Helper: return an icon name for a given kind and value
            window.getIconFor = function(kind, value) {
                try {
                    if (!value && value !== 0) return '';
                    const v = value.toString();
                    const normalize = s => (s || '').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
                    if (kind === 'payment') {
                        // prefer configured payment methods (cards) from settings when available
                        try {
                            const methods = (state && state.appData && state.appData.settings && state.appData.settings.paymentMethods) || [];
                            // Methods may be strings or objects { name, type, icon }
                            const found = (methods || []).find(m => {
                                try {
                                    const name = (m && (m.name || m) || '').toString();
                                    return normalize(name) === normalize(v);
                                } catch(e) { return false; }
                            });
                            if (found) return (found.icon || (found.type && (found.type || '').toString().indexOf('credit') !== -1 ? 'credit_card' : 'payment')) || 'paid';
                        } catch (e) {}
                        const m = (window.ICON_MAPPINGS.paymentMethods || []).find(m => {
                            try { return normalize((m.value || '').toString()) === normalize(v) || normalize((m.label || '').toString()) === normalize(v); } catch(e) { return false; }
                        });
                        return (m && m.icon) ? m.icon : '';
                    }
                // NOTE: rendering of non-credit payment-method cards was previously misplaced inside this helper.
                // That logic was moved into renderCreditCardView so DOM mutations happen in the proper view renderer.
                    if (kind === 'category') {
                        const m = (window.ICON_MAPPINGS.expenseCategories || []).find(m => (m.value || '') === v || m.label === v);
                        if (m && m.icon) return m.icon;
                        const s = (window.ICON_MAPPINGS.savingCategories || []).find(m => (m.value || '') === v || m.label === v);
                        if (s && s.icon) return s.icon;
                        return 'category';
                    }
                    if (kind === 'type') {
                        const m = (window.ICON_MAPPINGS.expenseTypes || []).find(m => (m.value || '') === v || m.label === v);
                        return (m && m.icon) ? m.icon : 'tune';
                    }
                } catch (e) { return ''; }
                return '';
            };

            // Helper: return a human-friendly payment label for display (handles objects, settings and ICON_MAPPINGS)
            window.getPaymentLabel = function(value) {
                try {
                    const normalize = s => (s || '').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
                    let v = '';
                    if (value && typeof value === 'object') v = (value.name || value.label || value.value || '').toString();
                    else v = (value || '').toString();
                    // prefer configured settings names when available
                    try {
                        const methods = (state && state.appData && state.appData.settings && state.appData.settings.paymentMethods) || [];
                        const found = (methods || []).find(m => {
                            try { const name = (m && (m.name || m) || '').toString(); return normalize(name) === normalize(v); } catch(e){ return false; }
                        });
                        if (found) return (found.name || found.label || found.value || v).toString();
                    } catch(e){}
                    // fallback to ICON_MAPPINGS labels
                    try {
                        const m = (window.ICON_MAPPINGS.paymentMethods || []).find(m => {
                            try { return normalize((m.value||'').toString()) === normalize(v) || normalize((m.label||'').toString()) === normalize(v); } catch(e){ return false; }
                        });
                        if (m) return (m.label || m.value || v).toString();
                    } catch(e){}
                    return v.toString();
                } catch (e) { return (value || '').toString(); }
            };

            // Helper: tolerant match between expense payment value and a configured payment name
            window.paymentMatches = function(a, b) {
                try {
                    const normalize = s => (s || '').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
                    const extract = v => {
                        if (!v && v !== 0) return '';
                        if (typeof v === 'object') return (v.name || v.label || v.value || '').toString();
                        return v.toString();
                    };
                    const sa = normalize(extract(a));
                    const sb = normalize(extract(b));
                    if (!sa || !sb) return false;
                    if (sa === sb) return true;
                    // allow substring matches (handles cases where stored value has extra metadata)
                    if (sa.indexOf(sb) !== -1) return true;
                    if (sb.indexOf(sa) !== -1) return true;
                    return false;
                } catch (e) { return false; }
            };

            // Helper: return an HTML fragment for a material-symbol icon (small inline)
            window.iconHtml = function(iconName, extraCls) {
                if (!iconName) return '';
                const cls = extraCls ? extraCls : 'text-gray-500';
                return `<span class="material-symbols-outlined ${cls}" style="font-size:18px;margin-right:6px;vertical-align:middle">${iconName}</span>`;
            };

            function populateSelect(selectId, items, iconSpanSelector) {
                const sel = document.getElementById(selectId);
                if (!sel) return;
                // clear
                sel.innerHTML = '';
                items.forEach(it => {
                    const opt = document.createElement('option');
                    opt.value = it.value;
                    opt.textContent = it.label;
                    opt.dataset.icon = it.icon;
                    sel.appendChild(opt);
                });
                const iconSpan = sel.parentElement ? sel.parentElement.querySelector(iconSpanSelector) : null;
                const updateIcon = () => {
                    const cur = sel.options[sel.selectedIndex];
                    if (iconSpan && cur && cur.dataset.icon) {
                        iconSpan.textContent = cur.dataset.icon;
                        iconSpan.classList.add('material-symbols-outlined');
                    }
                };
                sel.addEventListener('change', updateIcon);
                updateIcon();
            }

                populateSelect('payment-method', window.ICON_MAPPINGS.paymentMethods, '.material-symbols-outlined');
            populateSelect('category-expense', window.ICON_MAPPINGS.expenseCategories, '.material-symbols-outlined');
            populateSelect('expense-type', window.ICON_MAPPINGS.expenseTypes, null);
            populateSelect('category-saving', window.ICON_MAPPINGS.savingCategories, '.material-symbols-outlined');
            // (goal-selector removed)
            // Also populate filter selects so they contain the same options (icons stored on option.dataset)
            populateSelect('filter-payment-method', window.ICON_MAPPINGS.paymentMethods, '.select-icon');
            // build a category list for filters that includes expense + saving categories
            const combinedCategories = (window.ICON_MAPPINGS.expenseCategories || []).concat(window.ICON_MAPPINGS.savingCategories || []).map(c => ({ value: c.value, label: c.label, icon: c.icon }));
            populateSelect('filter-category', combinedCategories, '.select-icon');
            // Populate vehicle selects for VT feature (add a 'Todos' option for the filter)
            populateSelect('vt-fuel-vehicle', (window.ICON_MAPPINGS.vehicles || []).map(v=>({ value: v.value, label: v.label, icon: v.icon })), '.select-icon');
            populateSelect('vt-filter-vehicle', [{ value: '', label: 'Todos', icon: '' }].concat((window.ICON_MAPPINGS.vehicles || []).map(v=>({ value: v.value, label: v.label, icon: v.icon }))), '.select-icon');
            // Populate fuel type select for VT and filter
            populateSelect('vt-fuel-type', (window.ICON_MAPPINGS.fuelTypes || []).map(f=>({ value: f.value, label: f.label, icon: f.icon })), '.select-icon');
            populateSelect('vt-filter-fuel', [{ value: '', label: 'Todos', icon: '' }].concat((window.ICON_MAPPINGS.fuelTypes || []).map(f=>({ value: f.value, label: f.label, icon: f.icon }))), '.select-icon');
            // Populate travel planner transport types
            try { populateSelect('tp-transport-type', (window.ICON_MAPPINGS.transportTypes || []).map(t=>({ value: t.value, label: t.label, icon: t.icon })), '.select-icon'); } catch(e) { }

            // Ensure default selections and refresh any visual icon-select overlays created by enhanceSelectWithIcons
            try {
                const setAndRefresh = (id, defaultValue) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    if (defaultValue !== undefined && Array.from(el.options).some(o => o.value === defaultValue)) {
                        el.value = defaultValue;
                        el.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    if (typeof el._refreshIconSelect === 'function') {
                        try { el._refreshIconSelect(); } catch (e) { console.error('refresh icon-select', id, e); }
                    }
                };
                // Set defaults: Moto for vehicle, Gasolina for fuel when available
                setAndRefresh('vt-fuel-vehicle', 'Moto');
                setAndRefresh('vt-fuel-type', 'Gasolina');
                // Refresh filters as well so their placeholders/icons appear
                setAndRefresh('vt-filter-vehicle');
                setAndRefresh('vt-filter-fuel');
            } catch (e) { console.error('vt selects default/refresh error', e); }
        });
        // Enhancer: replace visual select with icon-enabled custom dropdown while keeping native select for data
        document.addEventListener('DOMContentLoaded', function() {
            // Small helper to toggle the payment recipient field from other UI entry points
            window.toggleRecipientForPayment = function(rawValue) {
                try {
                    const normalize = s => (s || '').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
                    const nv = normalize(rawValue || '');
                    const recipientWrapper = document.getElementById('payment-recipient-wrapper');
                    const recipientInput = document.getElementById('payment-recipient');
                    const recipientHint = document.getElementById('payment-recipient-hint');
                    if (!recipientWrapper || !recipientInput) return;
                    const mustShow = (nv === 'pix' || nv.indexOf('transfer') !== -1 || nv === 'transferencia');
                    if (mustShow) {
                        recipientWrapper.classList.remove('hidden');
                        recipientWrapper.setAttribute('aria-hidden', 'false');
                        recipientInput.setAttribute('required', 'required');
                        try { recipientInput.focus(); } catch(_) {}
                        if (recipientHint) { recipientHint.classList.remove('hidden'); recipientHint.setAttribute('aria-hidden', 'false'); }
                    } else {
                        recipientWrapper.classList.add('hidden');
                        recipientWrapper.setAttribute('aria-hidden', 'true');
                        recipientInput.removeAttribute('required');
                        if (recipientHint) { recipientHint.classList.add('hidden'); recipientHint.setAttribute('aria-hidden', 'true'); }
                    }
                } catch (e) { console.error('toggleRecipientForPayment', e); }
            };
            function enhanceSelectWithIcons(selectId, placeholder) {
                const sel = document.getElementById(selectId);
                if (!sel) return null;
                // small helper to rebuild the visual list from current native select options
                // detect kind to allow getIconFor fallback (payment vs category)
                const kind = (selectId && selectId.indexOf('payment') !== -1) ? 'payment' : ((selectId && selectId.indexOf('category') !== -1) ? 'category' : null);
                const rebuildList = (wrapper, iconSpan, labelSpan, list) => {
                    list.innerHTML = '';
                    Array.from(sel.options).forEach(opt => {
                        const item = document.createElement('div'); item.className = 'icon-select-item';
                        const i = document.createElement('span'); i.className = 'material-symbols-outlined';
                        // compute icon: prefer dataset.icon, fallback to getIconFor(kind, value)
                        let iconName = opt.dataset.icon || '';
                        if ((!iconName || iconName === '') && typeof getIconFor === 'function' && kind) {
                            try { iconName = getIconFor(kind, opt.value || opt.textContent || ''); } catch(e) { iconName = '';} 
                        }
                        i.textContent = iconName || '';
                        const t = document.createElement('span'); t.textContent = opt.textContent || opt.value;
                        item.appendChild(i); item.appendChild(t);
                        item.addEventListener('click', () => {
                            sel.value = opt.value; // keep native select in sync
                            // update visible button (use same resolution logic)
                            let selIcon = opt.dataset.icon || '';
                            if ((!selIcon || selIcon === '') && typeof getIconFor === 'function' && kind) {
                                try { selIcon = getIconFor(kind, opt.value || opt.textContent || ''); } catch(e) { selIcon = ''; }
                            }
                            iconSpan.textContent = selIcon || '';
                            labelSpan.textContent = opt.textContent || opt.value;
                            // close
                            list.classList.add('hidden'); caret.textContent = 'arrow_drop_down';
                            // dispatch change and also call toggle helper so visual overlay selections update recipient reliably
                            sel.dispatchEvent(new Event('change', { bubbles: true }));
                            try { if (window.toggleRecipientForPayment) window.toggleRecipientForPayment(opt.value); } catch(_){}}
                        );
                        list.appendChild(item);
                    });
                };
                // build wrapper
                const wrapper = document.createElement('div');
                wrapper.className = 'icon-select';
                // copy computed classes for width if needed
                sel.parentElement.insertBefore(wrapper, sel);
                // hide native select visually but keep it for form
                sel.style.position = 'absolute'; sel.style.opacity = 0; sel.style.pointerEvents = 'none'; sel.style.height = '1px'; sel.style.width = '1px';
                // create button
                const btn = document.createElement('button'); btn.type = 'button'; btn.className = 'icon-select-button';
                const iconSpan = document.createElement('span'); iconSpan.className = 'material-symbols-outlined';
                // determine initial icon for selected option (prefer dataset, fallback to getIconFor)
                let initialIcon = '';
                if (sel.selectedOptions && sel.selectedOptions[0]) initialIcon = sel.selectedOptions[0].dataset.icon || '';
                if ((!initialIcon || initialIcon === '') && typeof getIconFor === 'function' && kind && sel.selectedOptions && sel.selectedOptions[0]) {
                    try { initialIcon = getIconFor(kind, sel.selectedOptions[0].value || sel.selectedOptions[0].textContent || ''); } catch(e) { initialIcon = ''; }
                }
                iconSpan.textContent = initialIcon || '';
                const labelSpan = document.createElement('span'); labelSpan.textContent = sel.selectedOptions && sel.selectedOptions[0] ? sel.selectedOptions[0].textContent : (placeholder || sel.getAttribute('placeholder') || '');
                const caret = document.createElement('span'); caret.className = 'material-symbols-outlined'; caret.textContent = 'arrow_drop_down'; caret.style.marginLeft = 'auto';
                btn.appendChild(iconSpan); btn.appendChild(labelSpan); btn.appendChild(caret);
                // build list
                const list = document.createElement('div'); list.className = 'icon-select-list hidden';
                // initial build
                rebuildList(wrapper, iconSpan, labelSpan, list);
                wrapper.appendChild(btn);
                wrapper.appendChild(list);
                // move native select inside wrapper (keeps form semantics/labels)
                wrapper.appendChild(sel);
                // toggle
                btn.addEventListener('click', (ev) => { ev.stopPropagation(); list.classList.toggle('hidden'); caret.textContent = list.classList.contains('hidden') ? 'arrow_drop_down' : 'arrow_drop_up'; });
                // close on outside
                document.addEventListener('click', () => { if (!list.classList.contains('hidden')) { list.classList.add('hidden'); caret.textContent = 'arrow_drop_down'; } });
                // Expose a small refresh hook so callers that replace native select options can rebuild the visual list
                try { sel._refreshIconSelect = () => rebuildList(wrapper, iconSpan, labelSpan, list); } catch(e){}
                return { wrapper, btn, list };
            }

            // (vehicle selects populated earlier where populateSelect is defined)

            // Enhance the main modal selects and filters where we want prefixed icons
            ['payment-method','category-expense','category-saving','filter-payment-method','filter-category','vt-fuel-vehicle','vt-filter-vehicle','vt-fuel-type','vt-filter-fuel','tp-transport-type','tp-activity-type'].forEach(id => {
                try { enhanceSelectWithIcons(id); } catch(e) { console.error('enhanceSelectWithIcons', id, e); }
            });
        });
        </script>
            <input type="hidden" id="transaction-type-input" value="expenses">
            <!-- Campos Básicos Modernizados -->
            <div class="bg-white p-6 rounded-xl border-2 border-gray-100">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary-600">info</span>
                    Informações Básicas
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="modern-form-group">
                        <label for="description" class="modern-form-label flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary-600">edit_note</span>
                            Descrição
                        </label>
                        <div class="modern-input-group">
                            <input type="text" id="description" required class="modern-input" placeholder="Ex: Supermercado, Salário..." list="description-suggestions">
                            <datalist id="description-suggestions"></datalist>
                        </div>
                        <p class="modern-form-description">Descreva brevemente a transação</p>
                        <p id="description-hint" class="text-xs text-gray-500 mt-1 hidden" aria-hidden="true">&nbsp;</p>
                    </div>
                    <div class="modern-form-group">
                        <label for="amount" class="modern-form-label flex items-center gap-2">
                            <span class="material-symbols-outlined text-success-600">attach_money</span>
                            Valor (R$)
                        </label>
                        <div class="modern-input-group">
                            <span class="modern-input-icon">R$</span>
                            <input type="number" id="amount" step="0.01" required class="modern-input" placeholder="0,00">
                        </div>
                        <p class="modern-form-description">Valor da transação em reais</p>
                    </div>
                </div>
            </div>


            <!-- Campos de Despesas Modernizados -->
            <div id="expense-fields" class="bg-white p-6 rounded-xl border-2 border-error-100">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-error-600">trending_down</span>
                    Detalhes da Despesa
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="modern-form-group">
                        <label for="payment-method" class="modern-form-label flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary-600">credit_card</span>
                            Forma de Pagamento
                        </label>
                        <div class="modern-input-group">
                            <span class="modern-input-icon material-symbols-outlined">credit_card</span>
                            <select id="payment-method" class="modern-input modern-select">
                            </select>
                        </div>
                        <p class="modern-form-description">Como foi paga a despesa?</p>
                        
                        <!-- Destinatário (obrigatório para PIX / Transferência) -->
                        <div id="payment-recipient-wrapper" class="mt-4 hidden">
                            <label for="payment-recipient" class="modern-form-label flex items-center gap-2">
                                <span class="material-symbols-outlined text-gray-500">person</span>
                                Destinatário
                            </label>
                            <div class="modern-input-group">
                                <span class="modern-input-icon material-symbols-outlined">person</span>
                                <input type="text" id="payment-recipient" class="modern-input" placeholder="Nome do destinatário">
                            </div>
                            <p id="payment-recipient-hint" class="modern-form-description text-warning-600 hidden">Obrigatório para PIX e Transferência</p>
                        </div>
                    </div>
                    <div class="modern-form-group">
                        <label for="category-expense" class="modern-form-label flex items-center gap-2">
                            <span class="material-symbols-outlined text-warning-600">category</span>
                            Categoria
                        </label>
                        <div class="modern-input-group">
                            <span class="modern-input-icon material-symbols-outlined">category</span>
                            <select id="category-expense" class="modern-input modern-select"></select>
                        </div>
                        <p class="modern-form-description">Classifique sua despesa para melhor controle</p>
                        <p id="category-hint" class="text-xs text-gray-500 mt-1 hidden" aria-hidden="true">&nbsp;</p>
                    </div>
                </div>
                <div>
                    <label for="expense-type" class="block text-base font-semibold text-gray-700 flex items-center gap-2 modal-tooltip" data-tooltip="Tipo de despesa">
                        <span class="material-symbols-outlined text-blue-400">tune</span>
                        Tipo
                    </label>
                    <select id="expense-type" class="mt-1 block w-full border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 px-3 py-2 text-base appearance-none">
                        <option value="Essenciais">Essencial</option>
                        <option value="Não Essenciais">Não Essencial</option>
                    </select>
                </div>
            </div>

            <div id="saving-fields" class="hidden modal-group space-y-2 bg-gray-50 rounded-xl p-3 shadow-md">
                <div>
                    <label for="category-saving" class="block text-base font-semibold text-gray-700 flex items-center gap-2 modal-tooltip" data-tooltip="Classifique sua reserva">
                        <span class="material-symbols-outlined text-orange-400">category</span>
                        Categoria da Reserva
                    </label>
                    <div class="relative">
                        <span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-orange-300 pointer-events-none">category</span>
                        <select id="category-saving" class="pl-8 mt-1 block w-full border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 px-3 py-2 text-base appearance-none"></select>
                    </div>
                </div>
                <!-- goal-selector removed: not functional -->
            </div>

            <!-- Opções Avançadas -->
            <div id="advanced-options" class="modal-group border-t pt-2 mt-2 space-y-2 bg-gray-50 rounded-xl p-3 shadow-md">
                <div class="option-row">
                    <label class="flex items-center cursor-pointer gap-2 modal-tooltip" data-tooltip="Marque para repetir mensalmente">
                        <input type="checkbox" id="is-recurring" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="material-symbols-outlined text-blue-400">autorenew</span>
                        <span class="ml-2 text-base text-gray-700">Tornar esta transação recorrente? (mensal)</span>
                    </label>
                </div>
                <div class="flex flex-col gap-2 text-base">
                    <!-- opção 'aplicar também às futuras' removida -->
                    <div class="option-row">
                        <label for="is-installment" class="flex items-center cursor-pointer gap-2 modal-tooltip" data-tooltip="Marque se for uma compra parcelada">
                            <input type="checkbox" id="is-installment" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="material-symbols-outlined text-indigo-400">payments</span>
                            <span class="ml-2 text-base text-gray-700">É uma compra parcelada?</span>
                        </label>
                    </div>
                    <div id="installment-fields" class="hidden ml-8 space-y-2 bg-indigo-50 rounded-lg p-3">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label for="installment-count" class="block text-sm text-gray-700">Número de parcelas</label>
                                <input type="number" id="installment-count" min="2" max="48" value="12" class="w-full border rounded px-2 py-1 text-sm" />
                            </div>
                            <div>
                                <label for="installment-start" class="block text-sm text-gray-700">Parcela inicial</label>
                                <input type="number" id="installment-start" min="1" value="1" class="w-full border rounded px-2 py-1 text-sm" />
                            </div>
                        </div>
                        <div class="text-xs text-gray-600">
                            O valor total será dividido automaticamente em <span id="installment-preview-count">12</span> parcelas de <span id="installment-preview-value" class="font-medium">R$ 0,00</span>
                        </div>
                    </div>
                    <div class="option-row">
                        <label for="is-financing" class="flex items-center cursor-pointer gap-2 modal-tooltip" data-tooltip="Marque se for um financiamento">
                            <input type="checkbox" id="is-financing" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="material-symbols-outlined text-amber-400">account_balance</span>
                            <span class="ml-2 text-base text-gray-700">É um financiamento?</span>
                        </label>
                    </div>
                </div>
                <!-- Campos específicos para Entrada: Salário (posicionados abaixo da opção recorrente) -->
                <div id="salary-section" class="hidden mt-2 space-y-1 modal-group bg-gray-50 rounded-xl p-3 shadow-md">
                    <label class="flex items-center gap-2 modal-tooltip" data-tooltip="Marque se for salário">
                        <input type="checkbox" id="is-salary" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="material-symbols-outlined text-green-400">work</span>
                        <span class="ml-2 text-base text-gray-700">É salário?</span>
                    </label>
                    <div id="salary-fields" class="hidden">
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label for="salary-base" class="sr-only">Valor bruto do salário</label>
                                <input type="number" id="salary-base" step="0.01" placeholder="Valor bruto do salário" title="Valor bruto do salário" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-1">
                            </div>
                            <div>
                                <label for="salary-periculosidade" class="sr-only">Percentual de periculosidade</label>
                                <input type="number" id="salary-periculosidade" step="0.1" placeholder="% Periculosidade" title="Percentual de periculosidade" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-1">
                            </div>
                            <div>
                                <label for="salary-outros-proventos" class="sr-only">Outros valores recebidos</label>
                                <input type="number" id="salary-outros-proventos" step="0.01" placeholder="Outros proventos" title="Outros valores recebidos" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-1">
                            </div>
                            <div>
                                <label for="salary-dependentes" class="sr-only">Número de dependentes</label>
                                <input type="number" id="salary-dependentes" placeholder="Dependentes" title="Número de dependentes" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-1" min="0">
                            </div>
                            <div>
                                <label for="salary-desjejum-dia" class="sr-only">Valor diário de desjejum</label>
                                <input type="number" id="salary-desjejum-dia" step="0.01" placeholder="Desjejum (R$/dia)" title="Valor diário de desjejum" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-1">
                            </div>
                            <div>
                                <label for="salary-transporte-dia" class="sr-only">Valor diário de transporte</label>
                                <input type="number" id="salary-transporte-dia" step="0.01" placeholder="Transporte (R$/dia)" title="Valor diário de transporte" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-1">
                            </div>
                        </div>

                        <details class="mt-2">
                            <summary class="cursor-pointer text-sm text-gray-700">Mais opções do salário</summary>
                            <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-1">
                                <div>
                                    <label for="salary-dias-trabalhados" class="sr-only">Dias Trabalhados</label>
                                    <input type="number" id="salary-dias-trabalhados" placeholder="Dias Trabalhados" title="Dias Trabalhados" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-1" min="0">
                                </div>
                                <div>
                                    <label for="salary-h-extra-sab" class="sr-only">HE Sáb (h)</label>
                                    <input type="number" id="salary-h-extra-sab" step="0.1" placeholder="HE Sáb (h)" title="Horas extras sábado (h)" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-1" min="0">
                                </div>
                                <div>
                                    <label for="salary-h-extra-dom" class="sr-only">HE Dom (h)</label>
                                    <input type="number" id="salary-h-extra-dom" step="0.1" placeholder="HE Dom (h)" title="Horas extras domingo (h)" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-1" min="0">
                                </div>
                                <div>
                                    <label for="salary-jornada-horas" class="sr-only">Jornada (h/mês)</label>
                                    <input type="number" id="salary-jornada-horas" step="1" placeholder="Jornada (h/mês)" title="Jornada (h/mês)" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-1" value="220">
                                </div>
                                <div>
                                    <label for="salary-horas-trabalhadas" class="sr-only">Horas trabalhadas (h)</label>
                                    <input type="text" id="salary-horas-trabalhadas" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-1" placeholder="Horas trabalhadas (Ex: 117:20)" title="Horas trabalhadas (Ex: 117:20 h:mm)">
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
                <div id="installments-section" class="hidden">
                    <!-- Compact visual for installments & financing (preserve fields/IDs for JS) -->
                    <div class="mt-3">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div id="installments-fields" class="bg-white border border-gray-200 rounded-lg p-3 flex items-start gap-3">
                                <span class="material-symbols-outlined text-indigo-500" style="font-size:28px; margin-top:4px">payments</span>
                                <div class="flex-1">
                                    <div class="text-sm font-semibold text-gray-700">Parcelamento</div>
                                    <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3 items-start">
                                        <div>
                                            <label for="installments-count" class="block text-xs text-gray-500 mb-1">Total</label>
                                            <input type="number" id="installments-count" min="2" max="48" class="block w-full sm:w-28 text-center border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Total" title="Número de parcelas">
                                        </div>
                                        <div>
                                            <label for="installments-current" class="block text-xs text-gray-500 mb-1">Atual</label>
                                            <input type="number" id="installments-current" min="1" max="48" class="block w-full sm:w-28 text-center border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Atual" title="Parcela atual (se em andamento)">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="financing-fields" class="bg-white border border-gray-200 rounded-lg p-3 flex items-start gap-3">
                                <span class="material-symbols-outlined text-amber-500" style="font-size:28px; margin-top:4px">account_balance</span>
                                <div class="flex-1">
                                    <div class="text-sm font-semibold text-gray-700">Financiamento</div>
                                    <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3 items-start">
                                        <div>
                                            <label for="financing-total" class="block text-xs text-gray-500 mb-1">Total</label>
                                            <input type="number" id="financing-total" min="2" max="120" class="block w-full sm:w-28 text-center border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Total" title="Total de parcelas (financiamento)">
                                        </div>
                                        <div>
                                            <label for="financing-current" class="block text-xs text-gray-500 mb-1">Atual</label>
                                            <input type="number" id="financing-current" min="1" max="120" class="block w-full sm:w-28 text-center border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Atual" title="Parcela atual (financiamento)">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Modernizado -->
            <div class="flex justify-end mt-8 modal-footer bg-gray-50 -mx-6 -mb-6 p-6 rounded-b-xl border-t border-gray-200">
                <button type="submit" class="modern-btn modern-btn-success px-8 py-3 text-base" id="modal-save-btn">
                    <span class="material-symbols-outlined" id="modal-save-icon">check_circle</span>
                    <span>Salvar Transação</span>
                </button>
            </div>
        
        </form>
    </dialog>

     <dialog id="goal-modal" class="p-8 rounded-2xl shadow-2xl card w-full max-w-lg">
        <h2 id="goal-modal-title" class="text-2xl font-bold mb-6">Nova Meta</h2>
        <form id="goal-form" class="space-y-4">
            <input type="hidden" id="goal-id">
            <div>
                <label for="goal-name" class="block text-sm font-medium text-gray-700">Nome da Meta</label>
                <input type="text" id="goal-name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Viagem para o Japão">
            </div>
            <div>
                <label for="goal-amount" class="block text-sm font-medium text-gray-700">Valor Total (R$)</label>
                <input type="number" id="goal-amount" step="0.01" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: 15000">
            </div>
             <div class="flex justify-end gap-4 pt-4">
                <button type="button" id="close-goal-modal-btn" class="bg-gray-200 text-gray-800 hover:bg-gray-300 font-medium py-2 px-5 rounded-lg transition-colors">Cancelar</button>
                <button type="submit" class="btn-primary font-medium py-2 px-5 rounded-lg transition-transform active:scale-95">Salvar Meta</button>
            </div>
        </form>
    </dialog>

    <dialog id="monthly-report-modal" class="report-modal p-8 rounded-2xl shadow-2xl card w-full max-w-4xl overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Relatório Mensal - <span id="monthly-report-title"></span></h2>
            <button type="button" id="close-monthly-report-btn" class="p-2 rounded-full hover:bg-gray-200">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card p-4 rounded-lg text-center !hover:scale-100">
                    <h3 class="text-sm font-medium text-gray-500">Total Entradas</h3>
                    <p id="mr-total-income" class="text-xl font-semibold text-green-600 mt-1"></p>
                </div>
                 <div class="card p-4 rounded-lg text-center !hover:scale-100">
                    <h3 class="text-sm font-medium text-gray-500">Total Saídas</h3>
                    <p id="mr-total-outcome" class="text-xl font-semibold text-red-600 mt-1"></p>
                </div>
                 <div class="card p-4 rounded-lg text-center !hover:scale-100">
                    <h3 class="text-sm font-medium text-gray-500">Saldo Final</h3>
                    <p id="mr-final-balance" class="text-xl font-semibold mt-1"></p>
                </div>
            </div>
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card p-6 rounded-xl !hover:scale-100">
                    <h3 class="text-lg font-semibold mb-4">Onde seu dinheiro foi parar?</h3>
                    <div class="h-64"><canvas id="mr-category-breakdown-chart"></canvas></div>
                </div>
                <div class="card p-6 rounded-xl !hover:scale-100">
                    <h3 class="text-lg font-semibold mb-4">Maiores Despesas do Mês</h3>
                    <ul id="mr-top-expenses-list" class="space-y-2 text-sm"></ul>
                </div>
            </div>
        </div>
    </dialog>

    <dialog id="annual-report-modal" class="report-modal p-8 rounded-2xl shadow-2xl card w-full max-w-4xl overflow-y-auto">
         <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Relatório Anual - <span id="annual-report-title"></span></h2>
            <button type="button" id="close-annual-report-btn" class="p-2 rounded-full hover:bg-gray-200">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
         <div class="space-y-8">
             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card p-4 rounded-lg text-center !hover:scale-100">
                    <h3 class="text-sm font-medium text-gray-500">Total Entradas no Ano</h3>
                    <p id="ar-total-income" class="text-xl font-semibold text-green-600 mt-1"></p>
                </div>
                 <div class="card p-4 rounded-lg text-center !hover:scale-100">
                    <h3 class="text-sm font-medium text-gray-500">Total Saídas no Ano</h3>
                    <p id="ar-total-outcome" class="text-xl font-semibold text-red-600 mt-1"></p>
                </div>
                 <div class="card p-4 rounded-lg text-center !hover:scale-100">
                    <h3 class="text-sm font-medium text-gray-500">Balanço Final do Ano</h3>
                    <p id="ar-final-balance" class="text-xl font-semibold mt-1"></p>
                </div>
            </div>
             <div class="card p-6 rounded-xl !hover:scale-100">
                <h3 class="text-lg font-semibold mb-4">Evolução do Saldo Mensal</h3>
                <div class="h-80"><canvas id="ar-balance-evolution-chart"></canvas></div>
            </div>
             <div class="card p-6 rounded-xl !hover:scale-100">
                <h3 class="text-lg font-semibold mb-4">Média de Gastos Mensais por Categoria</h3>
                <div class="h-80"><canvas id="ar-avg-category-spending-chart"></canvas></div>
            </div>
        </div>
    </dialog>

    <!-- VR Ledger Modal -->
    <dialog id="vr-modal" class="p-6 rounded-2xl shadow-2xl card w-full max-w-md">
        <h2 class="text-xl font-bold mb-4">Gerenciar VR</h2>
        <form id="vr-entry-form" class="space-y-3">
            <input type="hidden" id="vr-entry-id">
            <div>
                <label class="block text-sm text-gray-700">Descrição</label>
                <input id="vr-entry-desc" class="mt-1 block w-full border-gray-300 rounded-md p-2" />
            </div>
            <div>
                <label class="block text-sm text-gray-700">Valor (R$)</label>
                <input id="vr-entry-amount" type="number" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md p-2" />
            </div>
            <div class="flex justify-end gap-2 pt-2">
                <button id="vr-entry-cancel" type="button" class="bg-gray-100 px-3 py-1 rounded">Cancelar</button>
                <button id="vr-entry-save" type="submit" class="btn-primary px-3 py-1 rounded">Salvar</button>
            </div>
        </form>
        <button id="close-vr-modal" class="absolute top-3 right-3 p-1"> <span class="material-symbols-outlined">close</span></button>
    </dialog>
    
    <!-- VR Usage Edit Modal -->
    <dialog id="vr-usage-modal" class="p-6 rounded-2xl shadow-2xl card w-full max-w-md">
        <h2 class="text-xl font-bold mb-4">Editar Compra (VR)</h2>
        <form id="vr-usage-form" class="space-y-3">
            <input type="hidden" id="vr-usage-id">
            <div>
                <label class="block text-sm text-gray-700">Descrição</label>
                <input id="vr-usage-desc" class="mt-1 block w-full border-gray-300 rounded-md p-2" />
            </div>
            <div>
                <label class="block text-sm text-gray-700">Valor (R$)</label>
                <input id="vr-usage-amount" type="number" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md p-2" />
            </div>
            <div class="flex justify-end gap-2 pt-2">
                <button id="vr-usage-cancel" type="button" class="bg-gray-100 px-3 py-1 rounded">Cancelar</button>
                <button id="vr-usage-save" type="submit" class="btn-primary px-3 py-1 rounded">Salvar</button>
            </div>
        </form>
        <button id="vr-usage-close" class="absolute top-3 right-3 p-1"> <span class="material-symbols-outlined">close</span></button>
    </dialog>
    
    <!-- VT Ledger Modal -->
    <dialog id="vt-modal" class="p-6 rounded-2xl shadow-2xl card w-full max-w-md">
        <h2 class="text-xl font-bold mb-4">Gerenciar VT</h2>
        <form id="vt-entry-form" class="space-y-3">
            <input type="hidden" id="vt-entry-id">
            <div>
                <label class="block text-sm text-gray-700">Descrição</label>
                <input id="vt-entry-desc" class="mt-1 block w-full border-gray-300 rounded-md p-2" />
            </div>
            <div>
                <label class="block text-sm text-gray-700">Valor (R$)</label>
                <input id="vt-entry-amount" type="number" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md p-2" />
            </div>
            <div class="flex justify-end gap-2 pt-2">
                <button id="vt-entry-cancel" type="button" class="bg-gray-100 px-3 py-1 rounded">Cancelar</button>
                <button id="vt-entry-save" type="submit" class="btn-primary px-3 py-1 rounded">Salvar</button>
            </div>
        </form>
        <button id="close-vt-modal" class="absolute top-3 right-3 p-1"> <span class="material-symbols-outlined">close</span></button>
    </dialog>

    <!-- Salary breakdown modal (step-by-step ilustrative calculation) -->
    <dialog id="salary-breakdown-modal" class="p-6 rounded-2xl shadow-2xl card w-full max-w-2xl">
        <div class="modal-body">
            <div class="flex justify-between items-start mb-4">
                <h3 id="salary-breakdown-title" class="text-lg font-semibold">Detalhamento do Salário</h3>
                <button id="close-salary-breakdown" class="text-gray-500 hover:text-gray-700">Fechar ✕</button>
            </div>
            <div id="salary-breakdown-content" class="space-y-3 text-sm text-gray-700">
                <!-- dynamic content injected by JS -->
            </div>
        </div>
    </dialog>
    
    <!-- VT Usage Edit Modal -->
    <dialog id="vt-usage-modal" class="p-6 rounded-2xl shadow-2xl card w-full max-w-md">
        <h2 class="text-xl font-bold mb-4">Editar Compra (VT)</h2>
        <form id="vt-usage-form" class="space-y-3">
            <input type="hidden" id="vt-usage-id">
            <div>
                <label class="block text-sm text-gray-700">Descrição</label>
                <input id="vt-usage-desc" class="mt-1 block w-full border-gray-300 rounded-md p-2" />
            </div>
            <div>
                <label class="block text-sm text-gray-700">Valor (R$)</label>
                <input id="vt-usage-amount" type="number" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md p-2" />
            </div>
            <div class="flex justify-end gap-2 pt-2">
                <button id="vt-usage-cancel" type="button" class="bg-gray-100 px-3 py-1 rounded">Cancelar</button>
                <button id="vt-usage-save" type="submit" class="btn-primary px-3 py-1 rounded">Salvar</button>
            </div>
        </form>
        <button id="vt-usage-close" class="absolute top-3 right-3 p-1"> <span class="material-symbols-outlined">close</span></button>
    </dialog>
    
    <!-- VT Fuel Detail Modal (Registrar + Histórico) -->
    <dialog id="vt-fuel-modal" class="p-6 rounded-2xl shadow-2xl card w-full max-w-4xl" style="max-height:92vh;overflow:auto;max-width:900px;">
        <div class="flex items-start justify-between mb-4">
            <h2 class="text-xl font-bold">VT — Abastecimentos</h2>
            <div class="flex items-center gap-2">
                <button id="vt-fuel-close" class="p-2 rounded-full hover:bg-gray-100" aria-label="Fechar modal"><span class="material-symbols-outlined">close</span></button>
            </div>
        </div>

        <div class="mb-4">
            <div class="flex gap-2">
                <button id="vt-tab-register" class="px-3 py-1 rounded bg-gray-100 font-semibold">Registrar</button>
                <button id="vt-tab-history" class="px-3 py-1 rounded bg-white font-semibold">Histórico</button>
            </div>
        </div>

        <div id="vt-tab-content">
            <!-- Registrar -->
            <div id="vt-register" class="space-y-3">
                <form id="vt-fuel-form" class="space-y-3">
                    <input type="hidden" id="vt-fuel-id">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700">Veículo</label>
                            <div class="relative select-with-icon">
                                <span class="select-icon material-symbols-outlined">directions_car</span>
                                <select id="vt-fuel-vehicle" class="pl-8 mt-1 block w-full border-gray-300 rounded-md p-2">
                                    <option value="Carro">Carro</option>
                                    <option value="Moto" selected>Moto</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700">Data do abastecimento</label>
                            <div class="relative">
                                <span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">calendar_today</span>
                                <input id="vt-fuel-date" type="date" class="pl-8 mt-1 block w-full border-gray-300 rounded-md p-2" />
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700">Odômetro (km)</label>
                            <div class="relative">
                                <span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">speed</span>
                                <input id="vt-fuel-odometer" type="number" step="1" class="pl-8 mt-1 block w-full border-gray-300 rounded-md p-2" placeholder="Ex: 12345" />
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700">Combustível</label>
                            <div class="relative select-with-icon">
                                <span class="select-icon material-symbols-outlined">local_gas_station</span>
                                <select id="vt-fuel-type" class="pl-8 mt-1 block w-full border-gray-300 rounded-md p-2">
                                    <option value="Gasolina">Gasolina</option>
                                    <option value="Gasolina Aditivada">Gas. Aditivada</option>
                                    <option value="Etanol">Etanol</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700">Preço / L (R$)</label>
                            <div class="relative">
                                <span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">attach_money</span>
                                <input id="vt-fuel-price" type="text" class="pl-8 mt-1 block w-full border-gray-300 rounded-md p-2" placeholder="Ex: 5,49" />
                            </div>
                            <p id="vt-error-price" class="text-xs text-red-600 hidden"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700">Litros (L)</label>
                            <div class="relative">
                                <span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">opacity</span>
                                <input id="vt-fuel-liters" type="text" class="pl-8 mt-1 block w-full border-gray-300 rounded-md p-2" placeholder="Ex: 30,0" />
                            </div>
                            <p id="vt-error-liters" class="text-xs text-red-600 hidden"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700">Valor total (R$)</label>
                            <div class="relative">
                                <span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">payments</span>
                                <input id="vt-fuel-total" type="text" class="pl-8 mt-1 block w-full border-gray-300 rounded-md p-2" placeholder="Ex: 164,70" />
                            </div>
                            <p id="vt-error-total" class="text-xs text-red-600 hidden"></p>
                        </div>
                    </div>

                    <p id="vt-fuel-hint" class="text-xs text-gray-500">Estes dados serão usados para relatórios de consumo, autonomia e histórico de preços.</p>

                    <div class="flex justify-end gap-2 pt-2">
                        <button id="vt-fuel-cancel" type="button" class="bg-gray-100 px-3 py-1 rounded">Cancelar</button>
                        <button id="vt-fuel-save" type="submit" class="btn-primary px-3 py-1 rounded" disabled>Salvar Abastecimento</button>
                    </div>
                </form>
            </div>

            <!-- Histórico (hidden por padrão, mostrado pela aba) -->
            <div id="vt-history" class="hidden">
                <div class="flex flex-col md:flex-row md:items-center md:gap-4 mb-3">
                    <div class="flex gap-2 items-center flex-1">
                        <label class="text-sm text-gray-600">Veículo</label>
                        <div class="relative select-with-icon">
                            <span class="select-icon material-symbols-outlined">directions_car</span>
                            <select id="vt-filter-vehicle" class="pl-8 border-gray-200 rounded p-1"></select>
                        </div>
                        <label class="text-sm text-gray-600 ml-3">Combustível</label>
                        <div class="relative select-with-icon">
                            <span class="select-icon material-symbols-outlined">local_gas_station</span>
                            <select id="vt-filter-fuel" class="pl-8 border-gray-200 rounded p-1">
                                <option value="">Todos</option>
                                <option value="Gasolina">Gasolina</option>
                                <option value="Gasolina Aditivada">Gas. Aditivada</option>
                                <option value="Etanol">Etanol</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 mt-2 md:mt-0">
                        <div class="relative">
                            <span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">search</span>
                            <input id="vt-filter-search" class="pl-8 border-gray-200 rounded p-1" placeholder="Pesquisar descrição..." />
                        </div>
                        <button id="vt-filter-clear" class="bg-gray-100 px-2 py-1 rounded">Limpar</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                    <div class="p-3 rounded bg-white border">
                        <div class="text-sm text-gray-500">Total Gasto</div>
                        <div id="vt-stat-total" class="text-lg font-semibold">R$ 0,00</div>
                    </div>
                    <div class="p-3 rounded bg-white border">
                        <div class="text-sm text-gray-500">Total Litros</div>
                        <div id="vt-stat-liters" class="text-lg font-semibold">0.00 L</div>
                    </div>
                    <div class="p-3 rounded bg-white border">
                        <div class="text-sm text-gray-500">Média Preço/L</div>
                        <div id="vt-stat-avgprice" class="text-lg font-semibold">R$ 0,00</div>
                    </div>
                </div>

                <div class="p-3 rounded bg-white border mb-3">
                    <div class="text-sm text-gray-500">Autonomia (média km/L calculada a partir de odômetros)</div>
                    <div id="vt-stat-autonomy" class="text-lg font-semibold">—</div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-3">
                    <div class="p-3 rounded bg-white border">
                        <div class="text-sm text-gray-500 mb-2">Histórico de Preço / L</div>
                        <canvas id="vt-chart-price" height="160"></canvas>
                    </div>
                    <div class="p-3 rounded bg-white border">
                        <div class="text-sm text-gray-500 mb-2">Autonomia por intervalo (km/L)</div>
                        <canvas id="vt-chart-autonomy" height="160"></canvas>
                    </div>
                </div>

                <div class="overflow-auto max-h-64 rounded border bg-white p-2">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-xs text-gray-500">
                                <th class="px-2 py-1">Data</th>
                                <th class="px-2 py-1">Descrição</th>
                                <th class="px-2 py-1">Veículo</th>
                                <th class="px-2 py-1">Km</th>
                                <th class="px-2 py-1">L</th>
                                <th class="px-2 py-1">R$ / L</th>
                                <th class="px-2 py-1">Total</th>
                                <th class="px-2 py-1 text-right">&nbsp;</th>
                            </tr>
                        </thead>
                        <tbody id="vt-history-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </dialog>

    <script>
    (function(){
        window._pendingVtTransaction = null;
        // helpers
        function q(id){ return document.getElementById(id); }

        function openVtFuelModal(pendingTransaction){
            window._pendingVtTransaction = pendingTransaction || null;
            const modal = q('vt-fuel-modal'); if (!modal) return;
            // show register tab
            activateVtTab('register');
            // prefill total if present (format to pt-BR style)
            try {
                const tot = (pendingTransaction && pendingTransaction.amount) ? Number(pendingTransaction.amount) : '';
                if (tot !== '') q('vt-fuel-total').value = (Number(tot) || 0).toFixed(2).replace('.', ',');
                else q('vt-fuel-total').value = '';
                // pref-fill date to today if available
                try { const d = new Date(); q('vt-fuel-date').value = d.toISOString().slice(0,10); } catch(e){}
                // Prefill other fields from last recorded VT entry for convenience
                try {
                    const all = (typeof collectAllVtUsage === 'function') ? collectAllVtUsage() : [];
                    const last = (all && all.length) ? all[0] : null;
                    if (last) {
                        // vehicle and fuel type defaults
                        try {
                            if (q('vt-fuel-vehicle') && (!q('vt-fuel-vehicle').value || q('vt-fuel-vehicle').value === '')) q('vt-fuel-vehicle').value = last.vehicle || q('vt-fuel-vehicle').value;
                            // if the enhanced icon-select overlay exists, refresh its button/label
                            try { const sel = q('vt-fuel-vehicle'); if (sel && typeof sel._refreshIconSelect === 'function') sel._refreshIconSelect(); } catch(e){}
                        } catch(e){}
                        try { if (q('vt-fuel-type') && (!q('vt-fuel-type').value || q('vt-fuel-type').value === '')) q('vt-fuel-type').value = last.fuelType || q('vt-fuel-type').value; } catch(e){}
                        try { const t = q('vt-fuel-type'); if (t && typeof t._refreshIconSelect === 'function') t._refreshIconSelect(); } catch(e){}
                        // placeholders for numeric fields so user sees last values
                        try { if (q('vt-fuel-price') && (!q('vt-fuel-price').value)) q('vt-fuel-price').placeholder = (last.pricePerLiter!=null ? Number(last.pricePerLiter).toFixed(2).replace('.', ',') : q('vt-fuel-price').placeholder); } catch(e){}
                        try { if (q('vt-fuel-liters') && (!q('vt-fuel-liters').value)) q('vt-fuel-liters').placeholder = (last.liters!=null ? Number(last.liters).toFixed(3).replace('.', ',') : q('vt-fuel-liters').placeholder); } catch(e){}
                        try { if (q('vt-fuel-odometer') && (!q('vt-fuel-odometer').value)) q('vt-fuel-odometer').placeholder = (last.odometer!=null ? String(last.odometer) : q('vt-fuel-odometer').placeholder); } catch(e){}
                        try { if (q('vt-fuel-total') && (!q('vt-fuel-total').value)) q('vt-fuel-total').placeholder = (last.amount!=null ? Number(last.amount).toFixed(2).replace('.', ',') : q('vt-fuel-total').placeholder); } catch(e){}
                        try { const f = q('vt-filter-vehicle'); if (f && typeof f._refreshIconSelect === 'function') f._refreshIconSelect(); } catch(e){}
                    }
                } catch(e) { /* ignore prefill errors */ }
            } catch(e){}
            // ensure the dialog is visible and on top. Some environments may not support showModal
            try {
                modal.style.zIndex = '200000';
                modal.style.display = 'block';
                if (typeof modal.showModal === 'function') modal.showModal();
                else modal.setAttribute('open','');
            } catch(e){
                console.warn('openVtFuelModal: showModal failed, applying fallback open attribute and styles', e);
                try { modal.setAttribute('open',''); } catch(err){}
                try { modal.style.display = 'block'; } catch(_){}
            }
            // If total prefilled, enable save button
            try { const pre = parseLocaleNumber(q('vt-fuel-total').value) || 0; if (pre > 0) { try { q('vt-fuel-save').removeAttribute('disabled'); } catch(e){} } } catch(e){}
            renderVtHistory();
        }

        // Open VT modal and switch to the history tab
        function openVtFuelHistory(){
            const modal = q('vt-fuel-modal'); if (!modal) return;
            // Clear any pending transaction context
            window._pendingVtTransaction = null;
            activateVtTab('history');
            try { modal.style.zIndex = '200000'; modal.style.display = 'block'; if (typeof modal.showModal === 'function') modal.showModal(); else modal.setAttribute('open',''); } catch(e) { try { modal.setAttribute('open',''); modal.style.display = 'block'; } catch(_){} }
            renderVtHistory();
        }

        function closeVtFuelModal(){
            const modal = q('vt-fuel-modal'); if(!modal) return;
            try{
                if (typeof modal.close === 'function') modal.close();
                else modal.removeAttribute('open');
            }catch(e){
                console.warn('closeVtFuelModal: modal.close failed, removing open attribute', e);
                try { modal.removeAttribute('open'); } catch(_){}
            }
            // hide and reset styles as an extra fallback
            try { modal.style.display = 'none'; modal.style.zIndex = ''; } catch(_){}
            window._pendingVtTransaction = null;
        }

        // Tab handling
        function activateVtTab(name){
            const reg = q('vt-register'); const hist = q('vt-history'); const btnReg = q('vt-tab-register'); const btnHist = q('vt-tab-history');
            if(name === 'register'){ reg.classList.remove('hidden'); hist.classList.add('hidden'); btnReg.classList.add('bg-gray-100'); btnHist.classList.remove('bg-gray-100'); }
            else { reg.classList.add('hidden'); hist.classList.remove('hidden'); btnHist.classList.add('bg-gray-100'); btnReg.classList.remove('bg-gray-100'); renderVtHistory(); }
        }

        // collect all vtUsage entries across appData
        function collectAllVtUsage(){
            try{
                const out = [];
                // Be defensive: prefer internal `state`, fallback to `window.state`, otherwise empty
                const data = (typeof state !== 'undefined' && state.appData && state.appData.data) ? state.appData.data : ((window.state && window.state.appData && window.state.appData.data) ? window.state.appData.data : {});
                Object.keys(data).forEach(y => { Object.keys(data[y] || {}).forEach(m => { const md = data[y][m] || {}; (md.vtUsage || []).forEach(u => out.push(u)); }); });
                // sort desc by date
                out.sort((a,b) => new Date(b.date) - new Date(a.date));
                return out;
            }catch(e){ return []; }
        }

        // render history table and stats (with filters and charts)
        let vtPriceChart = null, vtAutonomyChart = null;
        // ResizeObservers for charts so we can control size manually and avoid Chart.js resize feedback loops
        let vtPriceResizeObserver = null, vtAutonomyResizeObserver = null;

        // Compute chart height based on breakpoint (desktop larger)
        function getChartHeightForViewport() {
            try {
                return (window.innerWidth >= 1024) ? 220 : 160;
            } catch (e) { return 160; }
        }

        // Attach a ResizeObserver to keep the chart sized correctly. Returns a disconnect function.
        function attachChartResizeObserver(canvas, chartInstance, parent) {
            if (!canvas || !chartInstance) return function(){};
            const resizeFn = () => {
                try {
                    const h = getChartHeightForViewport();
                    // set CSS height and request chart resize
                    canvas.style.height = h + 'px';
                    // let Chart.js recalculate with current CSS size
                    try { chartInstance.resize(); } catch(e) { /* ignore */ }
                } catch (e) { console.error('chart resizeFn error', e); }
            };
            // Call once to set initial size
            resizeFn();
            // Observe parent size changes; fallback to window resize if ResizeObserver not available
            if (typeof ResizeObserver !== 'undefined') {
                const ro = new ResizeObserver(() => resizeFn());
                try { ro.observe(parent || canvas.parentElement || document.body); } catch(e){}
                return function(){ try{ ro.disconnect(); }catch(e){} };
            } else {
                const handler = () => resizeFn();
                window.addEventListener('resize', handler);
                return function(){ try{ window.removeEventListener('resize', handler); }catch(e){} };
            }
        }
        function renderVtHistory(){
            const all = collectAllVtUsage();
            // If there are no records in memory, attempt a one-time reload from persistent storage
            try {
                if ((!(all && all.length) || all.length === 0) && !window._vtHistoryReloadAttempted) {
                    window._vtHistoryReloadAttempted = true;
                    if (storage && typeof storage.loadData === 'function') {
                        storage.loadData().then(d => {
                            try { window.state = window.state || {}; window.state.appData = d; } catch(e){}
                            try { renderVtHistory(); showToast('Dados carregados do armazenamento.', 'bg-green-600'); } catch(e){}
                        }).catch(err => { console.error('storage.loadData for VT history', err); });
                    }
                }
            } catch (e) { /* ignore reload errors */ }
            // apply filters (defensive DOM access)
            const vfEl = q('vt-filter-vehicle');
            const ffEl = q('vt-filter-fuel');
            const searchEl = q('vt-filter-search');
            const vf = vfEl ? (vfEl.value || '') : '';
            const ff = ffEl ? (ffEl.value || '') : '';
            const search = (searchEl && searchEl.value) ? String(searchEl.value).toLowerCase().trim() : '';
            const rows = all.filter(r => {
                if (vf && (r.vehicle || '') !== vf) return false;
                if (ff && (r.fuelType || '') !== ff) return false;
                if (search) {
                    const desc = (r.description || '').toLowerCase();
                    if (!desc.includes(search)) return false;
                }
                return true;
            });

            const tb = q('vt-history-tbody'); if(!tb) return; tb.innerHTML = '';
            let total = 0; let liters = 0; let priceSum = 0; let priceCount = 0; const byVehicle = {};
            // prepare series for charts (use chronological order)
            const priceSeries = []; const priceLabels = [];
            const autonomyIntervals = [];

            // Use a chronological copy for charts/metrics
            const rowsForCharts = (rows || []).slice().sort((a,b) => new Date(a.date) - new Date(b.date));

            rows.forEach(r => {
                const d = new Date(r.date || '');
                const tr = document.createElement('tr');
                // create editable cells (click to edit). We'll use data-id attr to identify the entry
                function mkCell(content, field, formatter) {
                    const td = document.createElement('td'); td.className = 'px-2 py-1';
                    const span = document.createElement('span'); span.className = 'vt-cell'; span.textContent = formatter ? formatter(content) : (content==null? '' : String(content));
                    span.style.cursor = 'pointer';
                    span.title = 'Clique para editar';
                    span.addEventListener('click', function () {
                        // prevent multiple inputs
                        if (td.querySelector('input') || td.querySelector('textarea') || td.querySelector('select')) return;
                        // create appropriate editor based on field
                        let inputEl;
                        if (field === 'date') {
                            inputEl = document.createElement('input'); inputEl.type = 'date'; inputEl.value = (content ? new Date(content).toISOString().slice(0,10) : '');
                        } else if (field === 'vehicle' || field === 'fuelType') {
                            inputEl = document.createElement('input'); inputEl.type = 'text'; inputEl.value = content || '';
                        } else if (field === 'description') {
                            inputEl = document.createElement('input'); inputEl.type = 'text'; inputEl.value = content || '';
                        } else if (field === 'odometer') {
                            inputEl = document.createElement('input'); inputEl.type = 'number'; inputEl.step = '1'; inputEl.value = content!=null? String(content) : '';
                        } else if (field === 'liters') {
                            inputEl = document.createElement('input'); inputEl.type = 'text'; inputEl.value = content!=null? String(content) : '';
                        } else if (field === 'pricePerLiter' || field === 'amount') {
                            inputEl = document.createElement('input'); inputEl.type = 'text'; inputEl.value = content!=null? String(content) : '';
                        } else {
                            inputEl = document.createElement('input'); inputEl.type = 'text'; inputEl.value = content!=null? String(content) : '';
                        }
                        inputEl.className = 'w-full border rounded p-1';
                        td.innerHTML = ''; td.appendChild(inputEl);
                        inputEl.focus();
                        // save on blur or Enter
                        const saveFn = async () => {
                            try {
                                let val = inputEl.value;
                                const updated = { id: r.id };
                                if (field === 'date') updated.date = val ? new Date(val).toISOString() : null;
                                else if (field === 'odometer') updated.odometer = val !== '' ? Number(val) : null;
                                else if (field === 'liters') updated.liters = val !== '' ? parseLocaleNumber(val) : null;
                                else if (field === 'pricePerLiter') updated.pricePerLiter = val !== '' ? parseLocaleNumber(val) : null;
                                else if (field === 'amount') updated.amount = val !== '' ? parseLocaleNumber(val) : null;
                                else if (field === 'vehicle') updated.vehicle = val;
                                else if (field === 'fuelType') updated.fuelType = val;
                                else if (field === 'description') updated.description = val;
                                // call appApi.updateVtEntry if available
                                if (window.appApi && typeof window.appApi.updateVtEntry === 'function') {
                                    await window.appApi.updateVtEntry(updated);
                                } else {
                                    // fallback: modify window.state directly
                                    try {
                                        const data = window.state && window.state.appData && window.state.appData.data ? window.state.appData.data : null;
                                        if (data) {
                                            Object.keys(data).forEach(y => { Object.keys(data[y]||{}).forEach(m => { (data[y][m].vtUsage||[]).forEach((it, idx) => { if (it && it.id === r.id) { data[y][m].vtUsage[idx] = Object.assign({}, it, updated); } }); }); });
                                            await storage.saveData(window.state.appData);
                                        }
                                    } catch(e){ console.error('fallback update inline', e); }
                                }
                                showToast('Abastecimento atualizado', 'bg-green-600');
                                // refresh UI
                                renderVtHistory(); if (window.appApi && typeof window.appApi.render === 'function') window.appApi.render();
                            } catch (err) { console.error('inline edit save error', err); showToast('Falha ao salvar alteração', 'bg-red-600'); renderVtHistory(); }
                        };
                        inputEl.addEventListener('blur', saveFn);
                        inputEl.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') { ev.preventDefault(); inputEl.blur(); } else if (ev.key === 'Escape') { renderVtHistory(); } });
                    });
                    td.appendChild(span);
                    return td;
                }

                tr.dataset.vtId = r.id || '';
                tr.appendChild(mkCell(r.date, 'date', c => { try { return c ? new Date(c).toLocaleDateString() : ''; } catch(e){ return ''; } }));
                tr.appendChild(mkCell(r.description || 'Abastecimento', 'description'));
                tr.appendChild(mkCell(r.vehicle || '', 'vehicle'));
                tr.appendChild(mkCell(r.odometer!=null? String(r.odometer) : '', 'odometer'));
                tr.appendChild(mkCell(r.liters!=null? Number(r.liters).toFixed(3) : '', 'liters'));
                tr.appendChild(mkCell(r.pricePerLiter!=null? r.pricePerLiter : '', 'pricePerLiter', v => v ? formatCurrency(v) : ''));
                tr.appendChild(mkCell(r.amount!=null? r.amount : 0, 'amount', v => formatCurrency(v||0)));
                // Actions cell: delete button (appears on row hover)
                const actionsTd = document.createElement('td'); actionsTd.className = 'px-2 py-1 actions-cell text-right';
                const delBtn = document.createElement('button');
                delBtn.type = 'button';
                delBtn.className = 'vt-delete-btn';
                delBtn.title = 'Excluir abastecimento';
                delBtn.style.opacity = '0';
                delBtn.style.transition = 'opacity 160ms ease';
                delBtn.style.background = 'transparent';
                delBtn.style.border = 'none';
                delBtn.style.cursor = 'pointer';
                delBtn.innerHTML = '<span class="material-symbols-outlined text-red-500">delete</span>';
                // show/hide on hover
                tr.addEventListener('mouseenter', () => { try{ delBtn.style.opacity = '1'; } catch(e){} });
                tr.addEventListener('mouseleave', () => { try{ delBtn.style.opacity = '0'; } catch(e){} });
                // deletion handler
                delBtn.addEventListener('click', async (ev) => {
                    try {
                        ev.stopPropagation();
                        try { const ok = await confirmAsync('Excluir este abastecimento?', 'Confirmar exclusão'); if (!ok) return; } catch(e) { return; }
                        const idToDelete = r.id;
                        let found = false;
                        try {
                            const data = (typeof state !== 'undefined' && state.appData && state.appData.data) ? state.appData.data : ((window.state && window.state.appData && window.state.appData.data) ? window.state.appData.data : {});
                            Object.keys(data).forEach(y => { Object.keys(data[y] || {}).forEach(m => { const md = data[y][m] || {}; if (Array.isArray(md.vtUsage)) { const idx = md.vtUsage.findIndex(it => it && it.id === idToDelete); if (idx !== -1) { md.vtUsage.splice(idx,1); found = true; } } }); });
                            if (found) {
                                try { await storage.saveData(window.state.appData); } catch(e){ console.error('saveData after vt delete', e); }
                                showToast('Abastecimento excluído', 'bg-green-600');
                            } else {
                                showToast('Abastecimento não encontrado', 'bg-yellow-600');
                            }
                        } catch (e) { console.error('delete vt inline error', e); showToast('Erro ao excluir abastecimento', 'bg-red-600'); }
                        // refresh UI
                        try { renderVtHistory(); } catch(e){}
                        try { if (window.appApi && typeof window.appApi.render === 'function') window.appApi.render(); } catch(e){}
                    } catch (err) { console.error('vt delete handler', err); showToast('Falha ao excluir', 'bg-red-600'); }
                });
                actionsTd.appendChild(delBtn);
                tr.appendChild(actionsTd);
                tb.appendChild(tr);
                total += Number(r.amount||0);
                if (r.liters) liters += Number(r.liters||0);
                if (r.pricePerLiter) { priceSum += Number(r.pricePerLiter||0); priceCount++; }
                const v = r.vehicle || 'unknown'; if(!byVehicle[v]) byVehicle[v] = []; byVehicle[v].push(r);
            });

            // Build chart series from chronological data, skipping invalid values
            rowsForCharts.forEach(r => {
                const d = new Date(r.date || '');
                const price = Number(r.pricePerLiter || 0);
                if (!isNaN(d.getTime()) && price > 0) {
                    priceLabels.push(d.toLocaleDateString());
                    priceSeries.push(price);
                }
            });

            // If there are no rows, show a friendly empty message in the table
            if (!rows || rows.length === 0) {
                if (tb) tb.innerHTML = '<tr><td colspan="7" class="p-6 text-sm text-gray-500">Nenhum abastecimento encontrado para os filtros selecionados.</td></tr>';
            }

            q('vt-stat-total').textContent = formatCurrency(total);
            q('vt-stat-liters').textContent = `${liters.toFixed(3)} L`;
            q('vt-stat-avgprice').textContent = priceCount ? formatCurrency(priceSum / priceCount) : formatCurrency(0);

            // compute autonomy intervals per vehicle using chronological order
            Object.keys(byVehicle).forEach(v => {
                const arr = (byVehicle[v]||[]).slice().filter(it => it.odometer!=null).sort((a,b)=> new Date(a.date)-new Date(b.date));
                for(let i=1;i<arr.length;i++){
                    const prev = arr[i-1]; const cur = arr[i];
                    const prevOdo = Number(prev.odometer || 0);
                    const curOdo = Number(cur.odometer || 0);
                    const km = curOdo - prevOdo;
                    // liters consumed between prev and cur is generally the liters recorded in cur
                    const litersUsed = Number(cur.liters || 0);
                    if (km > 0 && litersUsed > 0) {
                        autonomyIntervals.push({ vehicle: v, km: km, liters: litersUsed, ratio: km / litersUsed, date: cur.date });
                    }
                }
            });
            q('vt-stat-autonomy').textContent = autonomyIntervals.length ? `${(autonomyIntervals.reduce((s,i)=>s+i.ratio,0)/autonomyIntervals.length).toFixed(3)} km/L` : 'Insuficiente (sem pares de odômetro)';

            // Add a small informative tooltip/icon next to the autonomy stat to explain 'Insuficiente'
            try {
                const autonomyEl = q('vt-stat-autonomy');
                if (autonomyEl) {
                    autonomyEl.setAttribute('title', 'A autonomia média é calculada a partir de pares de odômetro registrados entre dois abastecimentos. Preencha odômetro em dois abastecimentos para calcular.');
                    // append a subtle info icon if not present
                    if (!autonomyEl.querySelector('.vt-autonomy-info')) {
                        const info = document.createElement('span');
                        info.className = 'vt-autonomy-info material-symbols-outlined text-xs ml-2 text-gray-400';
                        info.style.verticalAlign = 'middle';
                        info.title = 'A autonomia média é calculada a partir de pares de odômetro registrados entre dois abastecimentos.';
                        info.textContent = 'info';
                        autonomyEl.appendChild(info);
                    }
                }
            } catch (e) { /* ignore tooltip failures */ }

            // populate vehicle filter options
            const vehicles = Array.from(new Set(collectAllVtUsage().map(u => u.vehicle || '').filter(Boolean))).map(v => ({ value: v, label: v, icon: ((window.ICON_MAPPINGS && window.ICON_MAPPINGS.vehicles) || []).find(x=>x.value===v)?.icon || '' }));
            const vfEl2 = q('vt-filter-vehicle'); if (vfEl2) {
                if (vehicles && vehicles.length) populateSelect('vt-filter-vehicle', [{ value: '', label: 'Todos', icon: '' }].concat(vehicles), '.select-icon');
                if (vf) vfEl2.value = vf;
                try { if (typeof vfEl2._refreshIconSelect === 'function') vfEl2._refreshIconSelect(); } catch(e) { /* ignore */ }
            }

            // Draw charts using Chart.js (if available). Guard canvas lookup to avoid exceptions.
            try{
                const priceCanvas = document.getElementById('vt-chart-price');
                // Friendly empty-state overlay handling for charts
                try {
                    const priceEmptyId = 'vt-chart-price-empty';
                    if (priceCanvas) {
                        const priceParent = priceCanvas.parentElement;
                        // Prevent Chart.js from growing the canvas by enforcing a min-height on the parent
                        try { if (priceParent) priceParent.style.minHeight = priceSeries && priceSeries.length ? '160px' : ''; } catch(e){}
                        // show/hide canvas based on data
                        if (!priceSeries || priceSeries.length === 0) {
                            priceCanvas.style.display = 'none';
                            if (priceParent && !priceParent.querySelector('#' + priceEmptyId)) {
                                const d = document.createElement('div'); d.id = priceEmptyId; d.className = 'p-6 text-sm text-gray-500'; d.textContent = 'Sem histórico de preço por litro.'; if (priceParent) priceParent.appendChild(d);
                            }
                        } else {
                            // ensure canvas has an explicit height so Chart.js doesn't compute a problematic size
                            try { priceCanvas.style.display = ''; priceCanvas.style.height = '160px'; } catch(e){}
                            const existing = priceParent ? priceParent.querySelector('#' + priceEmptyId) : null; if (existing) existing.remove();
                        }
                    }
                } catch(e){}
                if (priceCanvas && priceCanvas.getContext) {
                    // If there's no data, ensure any existing chart is destroyed and canvas hidden
                    if (!priceSeries || priceSeries.length === 0) {
                        try { if (vtPriceChart) { vtPriceChart.destroy(); vtPriceChart = null; } } catch(e){}
                    }
                    // Prepare the canvas for a stable rendering: set drawing buffer height and CSS height
                    try { priceCanvas.height = 160; priceCanvas.style.height = '160px'; } catch(e){}
                    const priceCtx = priceCanvas.getContext('2d');
                    try {
                        // Always recreate chart to avoid stale/responsive resize loops; destroy first if exists
                        if (vtPriceChart) { try { vtPriceChart.destroy(); } catch(e){} vtPriceChart = null; }
                        if (vtPriceResizeObserver) { try { vtPriceResizeObserver(); } catch(e){} vtPriceResizeObserver = null; }
                        if (priceSeries && priceSeries.length) {
                            vtPriceChart = new Chart(priceCtx, {
                                type: 'line',
                                data: { labels: priceLabels, datasets: [{ label: 'R$/L', data: priceSeries, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.08)', fill: true }] },
                                options: {
                                    // we manage resizing externally via ResizeObserver to avoid feedback loops
                                    responsive: false,
                                    maintainAspectRatio: false,
                                    scales: { x: { display: true }, y: { display: true } }
                                }
                            });
                            // attach observer to resize chart when parent changes
                            vtPriceResizeObserver = attachChartResizeObserver(priceCanvas, vtPriceChart, priceCanvas.parentElement);
                        }
                    } catch (e) { console.error('vtPriceChart render error', e); }
                }

                // autonomy chart: show each interval ratio in chronological order
                const autonomyLabels = autonomyIntervals.map(i => new Date(i.date).toLocaleDateString());
                const autonomyData = autonomyIntervals.map(i => Number(i.ratio.toFixed(3)));
                const autoCanvas = document.getElementById('vt-chart-autonomy');
                try {
                    const autoEmptyId = 'vt-chart-autonomy-empty';
                    if (autoCanvas) {
                        const autoParent = autoCanvas.parentElement;
                        if (!autonomyIntervals || autonomyIntervals.length === 0) {
                            autoCanvas.style.display = 'none';
                            if (autoParent && !autoParent.querySelector('#' + autoEmptyId)) {
                                const d = document.createElement('div'); d.id = autoEmptyId; d.className = 'p-6 text-sm text-gray-500'; d.textContent = 'Autonomia insuficiente para gerar gráfico.'; if (autoParent) autoParent.appendChild(d);
                            }
                        } else {
                            autoCanvas.style.display = '';
                            const existing = autoParent ? autoParent.querySelector('#' + autoEmptyId) : null; if (existing) existing.remove();
                        }
                    }
                } catch(e){}
                if (autoCanvas && autoCanvas.getContext) {
                    const autoParent = autoCanvas.parentElement;
                    // If no data, destroy any existing chart and hide canvas
                    if (!autonomyIntervals || autonomyIntervals.length === 0) {
                        try { if (vtAutonomyChart) { vtAutonomyChart.destroy(); vtAutonomyChart = null; } } catch(e){}
                    }
                    // enforce a stable drawing buffer height and CSS height
                    try { autoCanvas.height = 160; autoCanvas.style.height = '160px'; if (autoParent) autoParent.style.minHeight = autonomyIntervals && autonomyIntervals.length ? '160px' : ''; } catch(e){}
                    const autoCtx = autoCanvas.getContext('2d');
                    try {
                        // Recreate chart freshly to avoid responsive resize feedback problems
                        if (vtAutonomyChart) { try { vtAutonomyChart.destroy(); } catch(e){} vtAutonomyChart = null; }
                        if (vtAutonomyResizeObserver) { try { vtAutonomyResizeObserver(); } catch(e){} vtAutonomyResizeObserver = null; }
                        if (autonomyIntervals && autonomyIntervals.length) {
                            vtAutonomyChart = new Chart(autoCtx, {
                                type: 'bar',
                                data: { labels: autonomyLabels, datasets: [{ label: 'km/L', data: autonomyData, backgroundColor: '#10b981' }] },
                                options: {
                                    responsive: false,
                                    maintainAspectRatio: false,
                                    scales: { x: { display: true }, y: { display: true } }
                                }
                            });
                            vtAutonomyResizeObserver = attachChartResizeObserver(autoCanvas, vtAutonomyChart, autoCanvas.parentElement);
                        }
                    } catch (e) { console.error('vtAutonomyChart render error', e); }
                }
            }catch(e){ /* Chart.js not available or canvas not ready */ }
        }

        // helpers: formatting & escape
        function formatCurrency(v){ try{ return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(Number(v)||0); }catch(e){ return String(v); } }
        function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

            // Parse numbers entered in pt-BR style (e.g. "1.234,56", "R$ 1.234,56", or "59,52") into JS numbers
            function parseLocaleNumber(s) {
                try {
                    if (s === undefined || s === null) return NaN;
                    if (typeof s === 'number') return s;
                    let str = String(s).trim();
                    if (str === '') return NaN;
                    
                    // Remove currency symbols and spaces
                    str = str.replace(/[R$\s\u00A0]/g, '');
                    
                    // Protect minus: allow only leading minus
                    str = str.replace(/(?!^)-/g, '');
                    if (str === '' || str === '-') return NaN;
                    
                    // Detect format: if there's a comma followed by 1-2 digits at the end, it's BR format (123.456,78)
                    // Otherwise, if there's a dot followed by 1-2 digits at the end, it's US format (123,456.78)
                    const hasBRDecimal = /,\d{1,2}$/.test(str); // ends with ,XX or ,X
                    const hasUSDecimal = /\.\d{1,2}$/.test(str); // ends with .XX or .X
                    
                    if (hasBRDecimal) {
                        // Brazilian format: 1.234.567,89 -> remove dots, replace comma with dot
                        str = str.replace(/\./g, '').replace(',', '.');
                    } else if (hasUSDecimal) {
                        // US format: 1,234,567.89 -> remove commas, keep dot
                        str = str.replace(/,/g, '');
                    } else {
                        // No clear decimal separator, or integer - just remove all separators
                        str = str.replace(/[.,]/g, '');
                    }
                    
                    // Remove any remaining non-numeric characters except dot and minus
                    str = str.replace(/[^0-9.\-]/g, '');
                    
                    const v = parseFloat(str);
                    return isNaN(v) ? NaN : v;
                } catch (e) { return NaN; }
            }

            // Safe id generator: prefer global generateUUID if available, otherwise fallback
            function safeGenerateId() {
                try { if (typeof generateUUID === 'function') return generateUUID(); } catch(e) {}
                // fallback simple id
                return 'id-' + Math.random().toString(36).slice(2, 10) + Date.now().toString(36);
            }

        // auto-calculation and validation wiring
        document.addEventListener('DOMContentLoaded', function(){
            const modal = q('vt-fuel-modal'); if(!modal) return;
            const btnReg = q('vt-tab-register'); const btnHist = q('vt-tab-history');
            const btnClose = q('vt-fuel-close'); const btnCancel = q('vt-fuel-cancel');
            const saveBtn = q('vt-fuel-save');
            const inpPrice = q('vt-fuel-price'); const inpLiters = q('vt-fuel-liters'); const inpTotal = q('vt-fuel-total');
            const inpVehicle = q('vt-fuel-vehicle'); const inpOdo = q('vt-fuel-odometer'); const inpType = q('vt-fuel-type');

            let programmatic = false;

            function validateAndToggle(){
                const total = parseLocaleNumber(inpTotal.value) || 0;
                if (total > 0) { try{ saveBtn.removeAttribute('disabled'); }catch(e){} q('vt-error-total').classList.add('hidden'); }
                else { try{ saveBtn.setAttribute('disabled',''); }catch(e){} q('vt-error-total').classList.remove('hidden'); q('vt-error-total').textContent = 'Informe o valor total.'; }
            }

            // Unified recalculation: works regardless of which field the user edits first.
            function recalcFields(trigger){
                if (programmatic) return;
                programmatic = true;
                try{
                    const price = parseLocaleNumber(inpPrice.value) || 0;
                    const liters = parseLocaleNumber(inpLiters.value) || 0;
                    const total = parseLocaleNumber(inpTotal.value) || 0;

                    // Priority: when we have price and liters => total
                    if (price > 0 && liters > 0) {
                        const calcTotal = Math.round((price * liters + Number.EPSILON) * 100) / 100;
                        inpTotal.value = calcTotal.toFixed(2).replace('.', ',');
                    }
                    // If not enough for above, but have price and total => liters
                    else if (price > 0 && total > 0) {
                        const calcLiters = total / price;
                        inpLiters.value = calcLiters.toFixed(3).replace('.', ',');
                    }
                    // If not above, but have liters and total => price (2 decimals)
                    else if (liters > 0 && total > 0) {
                        const calcPrice = total / liters;
                        inpPrice.value = calcPrice.toFixed(2).replace('.', ',');
                    }
                    // If user cleared fields, leave inputs as-is
                } catch (e) {
                    console.error('recalcFields error', e);
                } finally {
                    programmatic = false;
                    validateAndToggle();
                }
            }

            inpPrice.addEventListener('input', () => recalcFields('price'));
            inpLiters.addEventListener('input', () => recalcFields('liters'));
            inpTotal.addEventListener('input', () => recalcFields('total'));

            // Format values on blur (local pt-BR style)
            inpPrice.addEventListener('blur', () => {
                try {
                    const v = parseLocaleNumber(inpPrice.value);
                    if (!isNaN(v)) inpPrice.value = v.toFixed(2).replace('.', ',');
                    recalcFields('price');
                } catch(e){}
            });
            inpLiters.addEventListener('blur', () => {
                try {
                    const v = parseLocaleNumber(inpLiters.value);
                    if (!isNaN(v)) inpLiters.value = v.toFixed(3).replace('.', ',');
                    recalcFields('liters');
                } catch(e){}
            });
            inpTotal.addEventListener('blur', () => {
                try {
                    const v = parseLocaleNumber(inpTotal.value);
                    if (!isNaN(v)) inpTotal.value = v.toFixed(2).replace('.', ',');
                    recalcFields('total');
                } catch(e){}
            });

            btnReg.addEventListener('click', () => activateVtTab('register'));
            btnHist.addEventListener('click', () => activateVtTab('history'));
            btnClose.addEventListener('click', () => closeVtFuelModal());
            btnCancel.addEventListener('click', () => closeVtFuelModal());

            // Save handler
            q('vt-fuel-form').addEventListener('submit', function(e){
                e.preventDefault();
                const vehicle = inpVehicle.value; const odometer = inpOdo.value ? Number(inpOdo.value) : null; const fuelType = inpType.value;
                const price = isNaN(parseLocaleNumber(inpPrice.value)) ? null : parseLocaleNumber(inpPrice.value);
                const liters = isNaN(parseLocaleNumber(inpLiters.value)) ? null : parseLocaleNumber(inpLiters.value);
                const total = isNaN(parseLocaleNumber(inpTotal.value)) ? null : parseLocaleNumber(inpTotal.value);
                if (!total || total <= 0) { q('vt-error-total').classList.remove('hidden'); q('vt-error-total').textContent = 'Valor total inválido.'; return; }
                const base = window._pendingVtTransaction || {};
                    const dateValue = (q('vt-fuel-date') && q('vt-fuel-date').value) ? new Date(q('vt-fuel-date').value).toISOString() : new Date().toISOString();
                    const entry = { id: (typeof safeGenerateId === 'function' ? safeGenerateId() : (typeof generateUUID === 'function' ? generateUUID() : ('id-' + Math.random().toString(36).slice(2,8)))), description: base.description || 'Abastecimento', amount: Number(total)||0, date: dateValue, vehicle: vehicle, odometer: odometer, fuelType: fuelType, pricePerLiter: price, liters: liters };

                // Prefer App API save wrapper when available (clean dependency on internal state)
                const saveViaAppApi = (window.appApi && typeof window.appApi.saveVtEntry === 'function');
                if (saveViaAppApi) {
                    window.appApi.saveVtEntry(entry).then(()=>{
                            showToast('Abastecimento registrado no VT.', 'bg-green-600');
                            closeVtFuelModal(); (window.appApi && typeof window.appApi.render === 'function' ? window.appApi.render() : (typeof render === 'function' ? render() : null));
                    }).catch(err=>{ console.error('save vt fuel via appApi', err); showToast('Falha ao salvar abastecimento VT.', 'bg-red-600'); });
                    return;
                }

                // Fallback: replicate previous best-effort save behavior if App API not present
                let md = null; let winState;
                try {
                    if (typeof getCurrentMonthData === 'function') md = getCurrentMonthData();
                    else if (typeof window.getCurrentMonthData === 'function') md = window.getCurrentMonthData();
                } catch (e) { md = null; }
                if (!md) {
                    try {
                        const date = (window.state && window.state.currentDate) ? window.state.currentDate : new Date();
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        winState = window.state || (window.state = { currentDate: date, appData: { data: {} } });
                        if (!winState.appData) winState.appData = { data: {} };
                        if (!winState.appData.data[year]) winState.appData.data[year] = {};
                        if (!winState.appData.data[year][month]) winState.appData.data[year][month] = { incomes: [], expenses: [], savings: [], vtUsage: [] };
                        md = winState.appData.data[year][month];
                    } catch (e) {
                        md = { vtUsage: [] };
                    }
                }
                if(!Array.isArray(md.vtUsage)) md.vtUsage = [];
                md.vtUsage.push(entry);
                const appDataToSave = (window.state && window.state.appData) ? window.state.appData : (typeof winState !== 'undefined' && winState.appData ? winState.appData : (window.state && window.state.appData ? window.state.appData : { data: {} }));
                storage.saveData(appDataToSave).then(()=>{
                    showToast('Abastecimento registrado no VT.', 'bg-green-600');
                    closeVtFuelModal(); (window.appApi && typeof window.appApi.render === 'function' ? window.appApi.render() : (typeof render === 'function' ? render() : null));
                }).catch(err=>{ console.error('save vt fuel', err); showToast('Falha ao salvar abastecimento VT.', 'bg-red-600'); });
            });

            // Filters wiring
            const filterVehicle = q('vt-filter-vehicle'); const filterFuel = q('vt-filter-fuel'); const filterSearch = q('vt-filter-search'); const filterClear = q('vt-filter-clear');
            if(filterVehicle) filterVehicle.addEventListener('change', () => renderVtHistory());
            if(filterFuel) filterFuel.addEventListener('change', () => renderVtHistory());
            if(filterSearch) filterSearch.addEventListener('input', () => renderVtHistory());
            if(filterClear) filterClear.addEventListener('click', () => { if(filterSearch) filterSearch.value = ''; if(filterVehicle) filterVehicle.value = ''; if(filterFuel) filterFuel.value = ''; renderVtHistory(); });

            // expose helpers
            window.openVtFuelModal = openVtFuelModal; window.closeVtFuelModal = closeVtFuelModal; window.renderVtHistory = renderVtHistory; window.openVtFuelHistory = openVtFuelHistory;
            // Test helper: seed two VT fuel entries (useful to reproduce charts/autonomy)
            window.seedVtTestData = async function(){
                const entries = [
                    { description: 'Abastecimento 1', vehicle: 'Moto', odometer: 17875, fuelType: 'Gasolina', pricePerLiter: 5.79, liters: 9.51, amount: 55.06, date: new Date().toISOString()},
                    { description: 'Abastecimento 2', vehicle: 'Moto', odometer: 18163, fuelType: 'Gasolina', pricePerLiter: 5.79, liters: 10.28, amount: 59.52, date: new Date(new Date().getTime() + 1000).toISOString() }
                ];
                try {
                    if (window.appApi && typeof window.appApi.saveVtEntry === 'function') {
                        for (const e of entries) await window.appApi.saveVtEntry(e);
                    } else {
                        // fallback: directly push to window.state if present
                        const date = (window.state && window.state.currentDate) ? window.state.currentDate : new Date();
                        const y = String(date.getFullYear()); const m = String(String(date.getMonth()+1).padStart(2,'0'));
                        window.state = window.state || { currentDate: date, appData: { data: {} } };
                        if (!window.state.appData) window.state.appData = { data: {} };
                        if (!window.state.appData.data[y]) window.state.appData.data[y] = {};
                        if (!window.state.appData.data[y][m]) window.state.appData.data[y][m] = { incomes: [], expenses: [], savings: [], vtUsage: [] };
                        for (const e of entries) {
                            e.id = e.id || ('seed-' + Math.random().toString(36).slice(2,8));
                            window.state.appData.data[y][m].vtUsage.push(e);
                        }
                        try { await storage.saveData(window.state.appData); } catch(e) {}
                    }
                    showToast('Dados de teste adicionados (VT).', 'bg-green-600');
                    renderVtHistory(); if (window.appApi && typeof window.appApi.render === 'function') window.appApi.render(); else if (typeof render === 'function') render();
                } catch (err) { console.error('seedVtTestData', err); showToast('Falha ao inserir dados de teste.', 'bg-red-600'); }
            };
        });
        // VT KPI card click handler intentionally removed to avoid multiple access points to the VT modal.
        // Access to the VT — Abastecimentos modal is restricted to the '+' button inside the VT card on the
        // credit-cards (Faturas) view to prevent conflicts.
    })();
    // Async confirm helper used across the app; uses modal when available
    function confirmAsync(message, title) {
        if (window.showConfirm) return window.showConfirm(message, title);
        return Promise.resolve(window.confirm(message));
    }
    </script>
    
    <script>
    // Global toast helper para feedback visual (disponível antes do init)
    function showToast(message, color = 'bg-blue-600') {
        let toast = document.getElementById('toast');
        if (!toast) {
            // console.debug('[toast]', message);
            return;
        }
        toast.textContent = message;
        toast.className = `${color} text-white px-4 py-2 rounded shadow-lg`;
        
        // SEMPRE manter o toast no body
        if (toast.parentNode !== document.body) {
            document.body.appendChild(toast);
        }

        // Configurar posicionamento com z-index MÁXIMO para ficar acima de TUDO
        // incluindo dialogs e seus backdrops
        toast.style.position = 'fixed';
        toast.style.bottom = '1rem';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.zIndex = '2147483647'; // Máximo z-index possível (32-bit integer max)
        
        toast.style.display = 'block';
        toast.style.opacity = '1';
        toast.style.pointerEvents = 'auto';
        if (window.__toastTimeout) clearTimeout(window.__toastTimeout);
        window.__toastTimeout = setTimeout(() => { try { toast.style.display = 'none'; } catch(e){} }, 2500);
    }

    // Transaction modal inline error helpers
    function setTransactionError(msg) {
        try {
            const el = document.getElementById('transaction-error');
            if (!el) return;
            el.textContent = msg || 'Erro';
            el.classList.remove('hidden');
        } catch (e) { console.error('setTransactionError', e); }
    }
    function clearTransactionError() {
        try {
            const el = document.getElementById('transaction-error');
            if (!el) return;
            el.textContent = '';
            el.classList.add('hidden');
        } catch (e) { console.error('clearTransactionError', e); }
    }

    // Loading overlay helpers (blocks UI during long operations like sanitization/save)
    function ensureLoadingOverlay() {
        if (document.getElementById('global-loading-overlay')) return;
        const overlay = document.createElement('div');
        overlay.id = 'global-loading-overlay';
        overlay.style.position = 'fixed';
        overlay.style.left = '0';
        overlay.style.top = '0';
        overlay.style.right = '0';
        overlay.style.bottom = '0';
        overlay.style.background = 'rgba(0,0,0,0.45)';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        overlay.style.zIndex = '120000';
    overlay.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;gap:12px;"><div class="loader" style="width:56px;height:56px;border-radius:50%;border:6px solid rgba(255,255,255,0.15);border-top-color:white;animation: spin 1s linear infinite"></div><div style="color:white;font-weight:600">Salvando...</div></div>`;
        document.body.appendChild(overlay);
        // inject spin keyframes if not present
        if (!document.getElementById('global-loading-style')) {
            const s = document.createElement('style');
            s.id = 'global-loading-style';
            s.textContent = `@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }`;
            document.head.appendChild(s);
        }
    }
    function showLoading() { try { ensureLoadingOverlay(); const o = document.getElementById('global-loading-overlay'); if (o) o.style.display = 'flex'; } catch(e) { console.error('showLoading', e); } }
    function hideLoading() { try { const o = document.getElementById('global-loading-overlay'); if (o) o.style.display = 'none'; } catch(e) { console.error('hideLoading', e); } }

    // File-based JSON import flow (opens modal, parse, preview, validate, import)
    (function(){
        const importBtn = document.getElementById('import-data-btn');
        const importModal = document.getElementById('import-json-modal');
        const importFileInputModal = document.getElementById('import-file-input-modal');
        const importFileInfo = document.getElementById('import-file-info');
        const parseImportBtn = document.getElementById('parse-import-btn');
        const clearImportBtn = document.getElementById('clear-import-btn');
        const importPreview = document.getElementById('import-preview');
        const importConfirmBtn = document.getElementById('import-confirm-btn');
        const importCancelBtn = document.getElementById('import-cancel-btn');
        const closeImportModal = document.getElementById('close-import-modal');

        let parsedData = null;

        function resetImportModal() {
            parsedData = null;
            importFileInputModal.value = '';
            importFileInfo.textContent = 'Nenhum arquivo selecionado.';
            importPreview.textContent = 'Nenhum preview disponível.';
            importConfirmBtn.disabled = true;
        }

        async function parseSelectedFile(file) {
            try {
                const text = await file.text();
                let json = null;
                try { json = JSON.parse(text); } catch (e) { throw new Error('Arquivo JSON inválido: ' + e.message); }
                // Accept either { financeAppDB_v10: {...} } or the direct payload
                const payload = json.financeAppDB_v10 ? json.financeAppDB_v10 : json;
                // Basic validation: expect an object with keys (accounts, transactions or similar)
                if (!payload || typeof payload !== 'object') throw new Error('Estrutura inválida no JSON. Esperado objeto principal.');
                // store parsed
                parsedData = payload;
                // show preview (first 2000 chars)
                const pretty = JSON.stringify(payload, null, 2);
                importPreview.textContent = pretty.length > 20000 ? pretty.slice(0,20000) + '\n\n...conteúdo truncado...' : pretty;
                importFileInfo.textContent = `${file.name} — ${Math.round(file.size/1024)} KB`;
                importConfirmBtn.disabled = false;
                showToast('Arquivo validado com sucesso. Revise o preview e confirme.', 'bg-green-600');
            } catch (err) {
                parsedData = null;
                importPreview.textContent = 'Erro: ' + err.message;
                importConfirmBtn.disabled = true;
                showToast('Erro ao ler arquivo: ' + err.message, 'bg-red-600');
            }
        }

        if (importBtn) {
            importBtn.addEventListener('click', () => {
                if (!importModal) return;
                try { importModal.showModal(); } catch(e) { importModal.setAttribute('open',''); }
                resetImportModal();
            });
        }

        if (closeImportModal) closeImportModal.addEventListener('click', resetImportModal);
        if (importCancelBtn) importCancelBtn.addEventListener('click', () => { if (!importModal) return; try { importModal.close(); } catch(e){ importModal.removeAttribute('open'); } resetImportModal(); });
        if (clearImportBtn) clearImportBtn.addEventListener('click', resetImportModal);

        if (importFileInputModal) {
            importFileInputModal.addEventListener('change', (e) => {
                const f = e.target.files && e.target.files[0];
                if (!f) return resetImportModal();
                importFileInfo.textContent = `Arquivo: ${f.name} — ${Math.round(f.size/1024)} KB`;
                // do not auto-parse until user clicks 'Ler e Validar'
                importPreview.textContent = 'Arquivo selecionado. Clique em "Ler e Validar" para ver o preview.';
                importConfirmBtn.disabled = true;
                parsedData = null;
            });
        }

        if (parseImportBtn) parseImportBtn.addEventListener('click', async () => {
            const f = importFileInputModal.files && importFileInputModal.files[0];
            if (!f) { showToast('Selecione um arquivo .json primeiro.', 'bg-yellow-600'); return; }
            await parseSelectedFile(f);
        });

        if (importConfirmBtn) importConfirmBtn.addEventListener('click', async () => {
            if (!parsedData) { showToast('Nenhum dado válido para importar.', 'bg-yellow-600'); return; }
            try {
                showLoading();
                // Persist using existing storage API
                await storage.saveData(parsedData);
                hideLoading();
                showToast('Dados importados com sucesso! Aplicando alterações...', 'bg-green-600');
                setTimeout(() => location.reload(), 1100);
            } catch (err) {
                hideLoading();
                showToast('Erro ao importar dados: ' + (err.message || err), 'bg-red-600');
            }
        });

    })();

    document.addEventListener('DOMContentLoaded', () => {
        // Legacy import button is wired to open the import modal (handled above)
    });

    // Transaction modal open/close + accessibility helpers
    (function(){
        const modal = document.getElementById('transaction-modal');
        const openBtn = document.getElementById('add-transaction-btn') || document.getElementById('mobile-add-transaction-fab');
        const closeBtn = document.getElementById('close-transaction-modal');
        let lastFocused = null;

        function trapFocus(e) {
            if (!modal || !modal.open) return;
            const focusable = modal.querySelectorAll('a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');
            if (!focusable.length) return;
            const first = focusable[0];
            const last = focusable[focusable.length - 1];
            if (e.key === 'Tab') {
                if (e.shiftKey && document.activeElement === first) {
                    e.preventDefault(); last.focus();
                } else if (!e.shiftKey && document.activeElement === last) {
                    e.preventDefault(); first.focus();
                }
            } else if (e.key === 'Escape') {
                e.preventDefault(); closeModal();
            }
        }

        function openModal() {
            if (!modal) return;
            try { lastFocused = document.activeElement; } catch(e) { lastFocused = null; }
            try { modal.showModal(); } catch(e) { modal.setAttribute('open',''); }
            modal.classList.add('modal-expanded');
            // focus first input for quick entry
            const firstInput = modal.querySelector('input, select, textarea, button');
            if (firstInput) try { firstInput.focus(); } catch(e) {}
            document.addEventListener('keydown', trapFocus);
        }

        function closeModal() {
            if (!modal) return;
            try { modal.close(); } catch(e) { modal.removeAttribute('open'); }
            modal.classList.remove('modal-expanded');
            document.removeEventListener('keydown', trapFocus);
            // restore focus
            try { if (lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus(); } catch(e) {}
        }

        if (openBtn) openBtn.addEventListener('click', (e) => { e.preventDefault(); openModal(); });
        if (closeBtn) closeBtn.addEventListener('click', (e) => { e.preventDefault(); closeModal(); });
        // close tappable backdrop or programmatic close if a cancel/close button inside form is used
        // close on dialog close event to cleanup
        if (modal) modal.addEventListener('close', () => { document.removeEventListener('keydown', trapFocus); });
        // Also expose helpers globally if needed by other modules
        window.openTransactionModal = openModal;
        window.closeTransactionModal = closeModal;
    })();
    
    // ===== FUNCIONALIDADE DE DUPLO CLIQUE PARA FECHAR MODAIS =====
    (function(){
        // Função para adicionar comportamento de duplo clique em um modal
        function addDoubleClickToClose(dialog) {
            if (!dialog || dialog._doubleClickAdded) return;
            dialog._doubleClickAdded = true;
            
            dialog.addEventListener('dblclick', function(e) {
                // Verifica se o clique foi no backdrop (fora do conteúdo do modal)
                const rect = dialog.getBoundingClientRect();
                const isInDialog = (
                    e.clientX >= rect.left &&
                    e.clientX <= rect.right &&
                    e.clientY >= rect.top &&
                    e.clientY <= rect.bottom
                );
                
                // Se o clique foi no backdrop (dialog::backdrop)
                if (e.target === dialog) {
                    try {
                        dialog.close();
                    } catch(err) {
                        dialog.removeAttribute('open');
                        dialog.style.display = 'none';
                    }
                }
            });
        }
        
        // Adiciona duplo clique a todos os modais existentes
        function initDoubleClickForAllModals() {
            const modals = document.querySelectorAll('dialog');
            modals.forEach(modal => addDoubleClickToClose(modal));
        }
        
        // Inicializa quando o DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDoubleClickForAllModals);
        } else {
            initDoubleClickForAllModals();
        }
        
        // Observa novos modais adicionados dinamicamente
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeName === 'DIALOG') {
                        addDoubleClickToClose(node);
                    }
                });
            });
        });
        
        observer.observe(document.body, { childList: true, subtree: true });
        
        // Expõe globalmente para uso manual se necessário
        window.addDoubleClickToCloseModal = addDoubleClickToClose;
    })();
    // ===== FIM DA FUNCIONALIDADE DE DUPLO CLIQUE =====
    
    // ETAPA 2: COLE A CONFIGURAÇÃO DO SEU FIREBASE AQUI
    // Substitua o conteúdo abaixo pelas credenciais do seu projeto Firebase.
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBRce273SxZo3EMFAoTQ5I0j82eDyIrYC4",
  authDomain: "fluxofinanceiro-marc35.firebaseapp.com",
  databaseURL: "https://fluxofinanceiro-marc35-default-rtdb.firebaseio.com",
  projectId: "fluxofinanceiro-marc35",
  storageBucket: "fluxofinanceiro-marc35.appspot.com", // CORRIGIDO
  messagingSenderId: "855674664271",
  appId: "1:855674664271:web:85ad6887626ece0dc8813a",
  measurementId: "G-NKKNQFLP00"
};


    // Inicializa o Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const storage = {
        DB_KEY: 'financeAppDB_v10',
        loadData: async function() {
            try {
                // Ensure we have the default structure available
                const initialData = this.getInitialData();
                // console.debug('storage.loadData: fetching data from Firebase...');
                const snapshot = await database.ref(this.DB_KEY).get();
                if (!snapshot.exists()) {
                    // console.debug("Firebase está vazio. Inicializando com dados padrão e salvando no banco.");
                    await this.saveData(initialData);
                    return initialData;
                }

                // --- Client-side XLSX/CSV import modal and logic ---
                (function(){
                    if (document.getElementById('import-spreadsheet-modal')) return;
                    const modal = document.createElement('dialog');
                    modal.id = 'import-spreadsheet-modal';
                    modal.className = 'p-6 rounded-2xl shadow-2xl card w-full max-w-2xl';
                    modal.innerHTML = `
                        <h3 class="text-lg font-semibold mb-3">Importar Planilha (.xlsx / .csv)</h3>
                        <p class="text-sm text-gray-600 mb-3">Use o modelo simples: <strong>Data, Descrição, Valor, FormaPagamento, Categoria, Pago</strong></p>
                        <div class="space-y-3">
                            <input type="file" id="import-spreadsheet-input" accept=".xlsx,.xls,.csv" />
                            <div id="import-preview" style="max-height:300px;overflow:auto;border:1px solid rgba(0,0,0,0.04);padding:8px;border-radius:8px;display:none;"></div>
                            <div class="flex justify-end gap-2 mt-3">
                                <button id="import-preview-cancel" class="bg-gray-100 px-3 py-1 rounded">Fechar</button>
                                <button id="import-preview-run" class="bg-blue-600 text-white px-3 py-1 rounded" disabled>Importar para o mês selecionado</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);

                    const fileInput = modal.querySelector('#import-spreadsheet-input');
                    const previewEl = modal.querySelector('#import-preview');
                    const runBtn = modal.querySelector('#import-preview-run');
                    const closeBtn = modal.querySelector('#import-preview-cancel');

                    function normalizeHeader(h) { return String(h||'').toLowerCase().replace(/[^a-z0-9]/g,''); }
                    function findHeaderMap(headers) {
                        const map = {};
                        const norm = headers.map(h => ({ raw:h, n:normalizeHeader(h) }));
                        const keys = {
                            date: ['date','data','dia'],
                            desc: ['descricao','description','historico','hist'],
                            amount: ['valor','amount','montante'],
                            payment: ['formapagamento','payment','pagamento','meiopagamento'],
                            category: ['categoria','category'],
                            paid: ['pago','paid','ispaid']
                        };
                        for (const k of Object.keys(keys)) {
                            for (const candidate of keys[k]) {
                                const found = norm.find(h => h.n === candidate || h.n.indexOf(candidate) !== -1);
                                if (found) { map[k] = found.raw; break; }
                            }
                        }
                        return map;
                    }

                    fileInput.addEventListener('change', async (ev) => {
                        const f = ev.target.files && ev.target.files[0];
                        if (!f) return;
                        previewEl.style.display = 'none'; previewEl.innerHTML = '';
                        runBtn.disabled = true;
                        try {
                            const data = await f.arrayBuffer();
                            let wb;
                            if (f.name.toLowerCase().endsWith('.csv')) {
                                const text = new TextDecoder('utf-8').decode(data);
                                wb = XLSX.read(text, { type: 'string' });
                            } else {
                                wb = XLSX.read(data, { type: 'array' });
                            }
                            const sheetName = wb.SheetNames[0];
                            const sheet = wb.Sheets[sheetName];
                            const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                            if (!rows || rows.length === 0) { previewEl.innerHTML = '<div class="text-sm text-red-600">Planilha vazia ou inválida.</div>'; previewEl.style.display = 'block'; return; }
                            const headers = Object.keys(rows[0]);
                            const map = findHeaderMap(headers);
                            const tbl = document.createElement('table'); tbl.style.width='100%'; tbl.style.borderCollapse='collapse';
                            const thead = document.createElement('thead'); const trh = document.createElement('tr');
                            ['Data','Descrição','Valor','FormaPagamento','Categoria','Pago'].forEach(h => { const th = document.createElement('th'); th.textContent = h; th.style.textAlign='left'; th.style.padding='6px'; trh.appendChild(th); });
                            thead.appendChild(trh); tbl.appendChild(thead);
                            const tb = document.createElement('tbody');
                            const mappedRows = [];
                            for (const r of rows) {
                                const dr = {};
                                dr.date = map.date ? r[map.date] : r['Date'] || r['Data'] || '';
                                dr.description = map.desc ? r[map.desc] : r['Description'] || r['Descrição'] || r['Historico'] || '';
                                dr.amount = map.amount ? r[map.amount] : r['Amount'] || r['Valor'] || '';
                                dr.payment = map.payment ? r[map.payment] : r['Payment'] || r['FormaPagamento'] || '';
                                dr.category = map.category ? r[map.category] : r['Category'] || r['Categoria'] || '';
                                dr.paid = map.paid ? r[map.paid] : r['Paid'] || r['Pago'] || '';
                                mappedRows.push(dr);
                                const tr = document.createElement('tr');
                                [dr.date, dr.description, dr.amount, dr.payment, dr.category, dr.paid].forEach(v => { const td = document.createElement('td'); td.textContent = (v===null||v===undefined)?'':v; td.style.padding='6px'; td.style.borderTop='1px solid rgba(0,0,0,0.04)'; tr.appendChild(td); });
                                tb.appendChild(tr);
                            }
                            tbl.appendChild(tb);
                            previewEl.appendChild(tbl);
                            previewEl.style.display = 'block';
                            runBtn.disabled = false;

                            // Instead of saving immediately, show a confirmation step with counts and backup
                            runBtn.onclick = async () => {
                                try {
                                    // compute target year/month and target array
                                    let targetYear = null; let targetMonth = null;
                                    for (const rr of mappedRows) {
                                        const dv = new Date(rr.date);
                                        if (!isNaN(dv)) { targetYear = dv.getFullYear(); targetMonth = dv.getMonth()+1; break; }
                                    }
                                    if (!targetYear) { targetYear = (new Date()).getFullYear(); targetMonth = (new Date()).getMonth()+1; }

                                    let positives=0, negatives=0;
                                    for (const rr of mappedRows) { const n = parseFloat(String(rr.amount).replace(/[^0-9-,.]/g,'').replace(',','.')) || 0; if (n>0) positives++; if (n<0) negatives++; }
                                    const targetArray = (negatives > positives) ? 'expenses' : 'incomes';

                                    // Build a summary and show confirmation UI
                                    const totalRows = mappedRows.length;
                                    const sum = mappedRows.reduce((acc, rr) => { const v = parseFloat(String(rr.amount).replace(/[^0-9-,.]/g,'').replace(',','.')) || 0; return acc + v; }, 0);
                                    previewEl.innerHTML = '';
                                    previewEl.style.display = 'block';
                                    const summary = document.createElement('div');
                                    summary.innerHTML = `
                                        <div class="mb-3 text-sm text-gray-700">Resumo antes de importar:</div>
                                        <ul class="text-sm text-gray-800" style="padding-left:16px;">
                                            <li><strong>Linhas detectadas:</strong> ${totalRows}</li>
                                            <li><strong>Direção inferida:</strong> ${targetArray}</li>
                                            <li><strong>Mês / Ano alvo:</strong> ${targetMonth}/${targetYear}</li>
                                            <li><strong>Soma (considerando sinais):</strong> ${formatCurrency(sum)}</li>
                                        </ul>
                                    `;
                                    const actions = document.createElement('div'); actions.className = 'flex justify-end gap-2 mt-4';

                                    const backupBtn = document.createElement('button'); backupBtn.className = 'bg-gray-100 px-3 py-1 rounded text-sm'; backupBtn.textContent = 'Baixar backup do mês atual';
                                    const backBtn = document.createElement('button'); backBtn.className = 'bg-white border px-3 py-1 rounded text-sm'; backBtn.textContent = 'Voltar';
                                    const confirmBtn = document.createElement('button'); confirmBtn.className = 'bg-green-600 text-white px-3 py-1 rounded text-sm'; confirmBtn.textContent = 'Confirmar importação';

                                    actions.appendChild(backupBtn); actions.appendChild(backBtn); actions.appendChild(confirmBtn);
                                    previewEl.appendChild(summary); previewEl.appendChild(actions);

                                    // backup function: download current month data as JSON
                                    backupBtn.addEventListener('click', () => {
                                        try {
                                            const existing = (state && state.appData && state.appData.data && state.appData.data[targetYear] && state.appData.data[targetYear][targetMonth]) || { incomes:[], expenses:[], savings:[] };
                                            const blob = new Blob([JSON.stringify(existing, null, 2)], { type: 'application/json' });
                                            const url = URL.createObjectURL(blob);
                                            const a = document.createElement('a'); a.href = url; a.download = `backup-${targetYear}-${String(targetMonth).padStart(2,'0')}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                                        } catch (e) { showToast('Falha ao gerar backup: ' + (e.message||e), 'bg-red-600'); }
                                    });

                                    backBtn.addEventListener('click', () => { previewEl.innerHTML = ''; previewEl.appendChild(tbl); previewEl.appendChild(runBtn); runBtn.disabled = false; });

                                    confirmBtn.addEventListener('click', async () => {
                                        try {
                                            confirmBtn.disabled = true; backupBtn.disabled = true; backBtn.disabled = true; showLoading();
                                            // Build payload items
                                            const items = [];
                                            for (const rr of mappedRows) {
                                                const amt = Math.abs(parseFloat(String(rr.amount).replace(/[^0-9-,.]/g,'').replace(',','.') || 0));
                                                const item = {
                                                    id: 'imp-' + Math.random().toString(36).slice(2,9),
                                                    description: String(rr.description || '').trim() || 'Importado',
                                                    amount: Number((amt||0).toFixed(2)),
                                                    payment: rr.payment || undefined,
                                                    category: rr.category || undefined,
                                                    isPaid: String(rr.paid || '').toLowerCase().indexOf('s') === 0 || String(rr.paid || '').toLowerCase().indexOf('t') === 0 || String(rr.paid || '') === '1'
                                                };
                                                items.push(item);
                                            }

                                            // Merge into existing app data safely
                                            const saveTarget = JSON.parse(JSON.stringify(state.appData || {}));
                                            saveTarget.data = saveTarget.data || {};
                                            saveTarget.data[targetYear] = saveTarget.data[targetYear] || {};
                                            saveTarget.data[targetYear][targetMonth] = saveTarget.data[targetYear][targetMonth] || { incomes: [], expenses: [], savings: [] };
                                            saveTarget.data[targetYear][targetMonth][targetArray] = (saveTarget.data[targetYear][targetMonth][targetArray] || []).concat(items);
                                            await storage.saveData(saveTarget);
                                            hideLoading(); showToast('Importação concluída com sucesso!', 'bg-green-600');
                                            try { modal.close(); } catch(e) { modal.removeAttribute('open'); }
                                            setTimeout(() => location.reload(), 900);
                                        } catch (err) {
                                            hideLoading(); showToast('Falha ao salvar: ' + (err && err.message ? err.message : String(err)), 'bg-red-600');
                                            confirmBtn.disabled = false; backupBtn.disabled = false; backBtn.disabled = false;
                                        }
                                    });

                                    // disable main runBtn while confirmation is visible
                                    runBtn.disabled = true;

                                } catch (e) { hideLoading(); showToast('Erro durante preparação da importação: '+ (e && e.message ? e.message : e), 'bg-red-600'); }
                            };

                        } catch (err) {
                            previewEl.innerHTML = '<div class="text-sm text-red-600">Erro ao ler o arquivo: ' + (err && err.message ? err.message : err) + '</div>';
                            previewEl.style.display = 'block';
                        }
                    });

                    closeBtn.addEventListener('click', () => { try { modal.close(); } catch(e){ modal.removeAttribute('open'); } });
                })();
                const firebaseData = snapshot.val();
                // Garante que a estrutura base (settings, data) exista, mesclando com o padrão.
                // Isso previne erros se os dados no Firebase estiverem incompletos.
                const mergedData = {
                    settings: { ...initialData.settings, ...(firebaseData.settings || {}) },
                    data: firebaseData.data || initialData.data
                };
                // Garante que sub-propriedades críticas de settings existam
                mergedData.settings.goals = mergedData.settings.goals || [];
                mergedData.settings.paymentMethods = mergedData.settings.paymentMethods || [];
                
                // console.debug("Dados do Firebase carregados e validados com sucesso.");
                return mergedData;
            } catch (err) {
                console.error("Erro crítico ao carregar dados do Firebase. Usando estrutura de dados inicial.", err);
                return initialData; // Retorna a estrutura padrão em caso de qualquer erro de conexão/leitura.
            }
        },
        // Ensure data is safe for Firebase Realtime Database (no functions, no Dates, no circular refs)
        sanitizeForFirebase: function(obj) {
            const seen = new WeakSet();
            function sanitize(value) {
                if (value === null) return null;
                const t = typeof value;
                if (t === 'string' || t === 'number' || t === 'boolean') return value;
                if (value instanceof Date) return value.toISOString();
                if (Array.isArray(value)) return value.map(v => sanitize(v));
                if (t === 'object') {
                    if (seen.has(value)) return null; // break cycles
                    seen.add(value);
                    const out = {};
                    Object.keys(value).forEach(k => {
                        // Firebase keys cannot contain . # $ [ ]
                        if (/[.#$\[\]]/.test(k)) return; // skip invalid key
                        const v = value[k];
                        const sv = sanitize(v);
                        // Skip undefined and functions
                        if (typeof sv !== 'undefined') out[k] = sv;
                    });
                    return out;
                }
                // functions, symbols, undefined -> skip
                return undefined;
            }
            return sanitize(obj);
        },

        saveData: function(data) {
            try {
                // console.debug("Sanitizing data before saving to Firebase...");
                showLoading();
                const safe = this.sanitizeForFirebase(data);
                // Persist without verbose logging of the entire object
                return database.ref(this.DB_KEY).set(safe)
                    .then(() => { /* saved successfully */ hideLoading(); return Promise.resolve(); })
                    .catch(e => {
                        console.error("Erro ao salvar no Firebase:", e);
                        hideLoading();
                        showToast('Erro ao salvar dados no Firebase: ' + (e && e.message ? e.message : e), 'bg-red-600');
                        return Promise.reject(e);
                    });
            } catch (err) {
                console.error('Erro ao sanitizar dados antes de salvar:', err);
                hideLoading();
                showToast('Erro interno ao preparar dados para salvar.', 'bg-red-600');
                return Promise.reject(err);
            }
        },
        getInitialData: function() {
            return {
                settings: {
                    goals: [],
                    spendingGoals: [{ type: 'Essenciais', goal: 0.50 }, { type: 'Não Essenciais', goal: 0.30 }, { type: 'Reserva', goal: 0.20 }],
                    expenseCategories: [
                        "Mercado",
                        "Alimentação",
                        "Compras",
                        "Assinaturas",
                        "Contas",
                        "Moradia",
                        "Transporte",
                        "Saúde",
                        "Educação",
                        "Lazer",
                        "Viagem",
                        "Vestuário",
                        "Casa",
                        "Pets",
                        "Doações",
                        "Impostos",
                        "Parcelas",
                        "Investimentos",
                        "Outros"
                    ],
                    savingCategories: [
                        "Reserva Emergência",
                        "Ações",
                        "Fundos Imobiliários",
                        "Criptomoedas",
                        "Poupança",
                        "Tesouro Direto",
                        "Previdência",
                        "Viagem",
                        "Reforma",
                        "Educação",
                        "Carro",
                        "Imóvel",
                        "Outros"
                    ],
                    paymentMethods: [
                        { name: "BB (Débito)", type: "debit" },
                        { name: "Inter (Débito)", type: "debit" },
                        { name: "Nubank", type: "credit_card" },
                        { name: "Porto", type: "credit_card" },
                        { name: "Dinheiro", type: "cash" },
                        { name: "PIX", type: "pix" },
                        { name: "Transferência", type: "transfer" },
                        { name: "Boleto", type: "boleto" },
                        { name: "Apple Pay", type: "wallet" },
                        { name: "Outro", type: "other" }
                    ],
                    feedbackMessages: [
                        { id: 'A', text: "Ótimo trabalho! Você superou sua meta de reserva este mês!" },
                        { id: 'B', text: "Missão cumprida! Suas finanças estão alinhadas com as metas." },
                        { id: 'C', text: "Atenção com os gastos não essenciais. Eles estão um pouco acima da meta." },
                        { id: 'D', text: "Os gastos essenciais superaram a meta. Vale a pena revisar." },
                        { id: 'E', text: "Sua reserva este mês foi menor que o esperado. Foco em economizar!" },
                        { id: 'F', text: "O saldo deste mês ficou negativo. Vamos repensar a estratégia." }
                    ]
                },
                data: {}
            };
        },
        propagateInitialInstallments(initialData) {}
    };
    
    const App = (function() {
    // showToast is defined globally above so it can be used before App.init()
        // STATE & UI (Private variables)
        const state = {
            currentDate: new Date(),
            appData: null,
            currentView: 'dashboard',
            sort: { key: 'description', order: 'asc' },
            filters: { searchTerm: '' },
            // UX: control whether Despesas are shown grouped by descrição
            showGroupedExpenses: false,
            // Per-card grouping state for credit card invoices
            cardGrouped: {}
        };
        // defensive default for travelPlans (some edits add/remove this field)
        if (!Array.isArray(state.travelPlans)) state.travelPlans = [];

    // Expose the internal state globally so legacy/global handlers can access it safely
    try { window.state = state; } catch (e) { /* ignore if env prevents assignment */ }

        const ui = {
            charts: {}
        };
        // in-memory session defaults for the transaction modal (do not persist)
        ui.lastTransactionDefaults = null;

        // --- HELPERS ---
        function generateUUID() {
            // Simple UUID v4 generator for local IDs
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

            // Parse numbers entered in pt-BR style (e.g. "1.234,56" or "59,52") into JS numbers
            function parseLocaleNumber(s) {
                try {
                    if (s === undefined || s === null) return NaN;
                    if (typeof s === 'number') return s;
                    let str = String(s).trim();
                    if (str === '') return NaN;
                    
                    // Remove currency symbols and spaces
                    str = str.replace(/[R$\s\u00A0]/g, '');
                    
                    // Protect minus: allow only leading minus
                    str = str.replace(/(?!^)-/g, '');
                    if (str === '' || str === '-') return NaN;
                    
                    // Detect format: if there's a comma followed by 1-2 digits at the end, it's BR format (123.456,78)
                    // Otherwise, if there's a dot followed by 1-2 digits at the end, it's US format (123,456.78)
                    const hasBRDecimal = /,\d{1,2}$/.test(str); // ends with ,XX or ,X
                    const hasUSDecimal = /\.\d{1,2}$/.test(str); // ends with .XX or .X
                    
                    if (hasBRDecimal) {
                        // Brazilian format: 1.234.567,89 -> remove dots, replace comma with dot
                        str = str.replace(/\./g, '').replace(',', '.');
                    } else if (hasUSDecimal) {
                        // US format: 1,234,567.89 -> remove commas, keep dot
                        str = str.replace(/,/g, '');
                    } else {
                        // No clear decimal separator, or integer - just remove all separators
                        str = str.replace(/[.,]/g, '');
                    }
                    
                    // Remove any remaining non-numeric characters except dot and minus
                    str = str.replace(/[^0-9.\-]/g, '');
                    
                    const v = parseFloat(str);
                    return isNaN(v) ? NaN : v;
                } catch (e) { return NaN; }
            }

            // Safe id generator: prefer global generateUUID if available, otherwise fallback
            function safeGenerateId() {
                try { if (typeof generateUUID === 'function') return generateUUID(); } catch(e) {}
                // fallback simple id
                return 'id-' + Math.random().toString(36).slice(2, 10) + Date.now().toString(36);
            }

        // Public API: save a VT fuel entry using App's internal state and storage.
        // This avoids callers needing direct access to `state` or to replicate
        // month/data lookup logic. Returns a Promise.
        async function saveVtEntry(entry) {
            try {
                if (!entry) throw new Error('empty entry');
                // Normalize state.appData structure
                if (!state.appData) state.appData = { data: {} };
                if (!state.appData.data) state.appData.data = {};
                const date = state.currentDate || new Date();
                const year = String(date.getFullYear());
                const month = String(String(date.getMonth() + 1).padStart(2, '0'));
                if (!state.appData.data[year]) state.appData.data[year] = {};
                if (!state.appData.data[year][month]) state.appData.data[year][month] = { incomes: [], expenses: [], savings: [], vtUsage: [] };
                const md = state.appData.data[year][month];
                if (!Array.isArray(md.vtUsage)) md.vtUsage = [];
                // Ensure id and normalized fields
                entry.id = entry.id || generateUUID();
                entry.date = entry.date || new Date().toISOString();
                // push and persist
                md.vtUsage.push(entry);
                await storage.saveData(state.appData);
                return { success: true };
            } catch (e) {
                console.error('saveVtEntry error', e);
                throw e;
            }
        }

        async function updateVtEntry(updated) {
            try {
                if (!updated || !updated.id) throw new Error('invalid update');
                if (!state.appData || !state.appData.data) throw new Error('no app data');
                // find entry by id across months
                let found = false;
                Object.keys(state.appData.data).forEach(y => {
                    Object.keys(state.appData.data[y] || {}).forEach(m => {
                        const md = state.appData.data[y][m] || {};
                        if (!Array.isArray(md.vtUsage)) return;
                        for (let i = 0; i < md.vtUsage.length; i++) {
                            const it = md.vtUsage[i];
                            if (it && it.id === updated.id) {
                                // merge changes
                                md.vtUsage[i] = Object.assign({}, it, updated);
                                found = true;
                                break;
                            }
                        }
                    });
                });
                if (!found) throw new Error('entry not found');
                await storage.saveData(state.appData);
                return { success: true };
            } catch (e) { console.error('updateVtEntry error', e); throw e; }
        }

        // Expose a small app API so isolated UI modules can call saving without
        // relying on window.state or internal helpers. This is intentionally
        // minimal and keeps the implementation inside App.
    try { window.appApi = window.appApi || {}; window.appApi.saveVtEntry = saveVtEntry; window.appApi.updateVtEntry = updateVtEntry; window.appApi.render = function(){ try { if (typeof render === 'function') return render(); } catch(e){ console.error('appApi.render wrapper error', e); } }; } catch(e) { /* ignore env failures */ }

        function formatCurrency(value) {
            if (typeof value !== 'number') value = parseFloat(value) || 0;
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function propagateRecurringTransactions() {
            // Ensure recurring transactions exist for months and propagate future recurrences for expenses and savings
            try {
                const today = new Date();
                // Ensure arrays exist for each month
                Object.keys(state.appData.data).forEach(year => {
                    Object.keys(state.appData.data[year]).forEach(month => {
                        const monthData = state.appData.data[year][month];
                        ['incomes','expenses','savings'].forEach(type => {
                            if (!Array.isArray(monthData[type])) monthData[type] = [];
                        });
                    });
                });

                // Collect recurring templates from existing months (only for expenses and savings)
                const templates = {}; // recurringId -> { type, template }
                Object.keys(state.appData.data).forEach(year => {
                    Object.keys(state.appData.data[year]).forEach(month => {
                        const monthData = state.appData.data[year][month];
                        ['expenses','savings'].forEach(type => {
                            (monthData[type] || []).forEach(item => {
                                try {
                                    if (item && item.isRecurring && item.recurringId) {
                                        if (!templates[item.recurringId]) {
                                            // create a minimal template
                                            const tpl = Object.assign({}, item);
                                            // remove id/date to avoid duplicates
                                            delete tpl.id;
                                            if (tpl.date) delete tpl.date;
                                            templates[item.recurringId] = { type, template: tpl };
                                        }
                                    }
                                } catch (e) { /* ignore malformed items */ }
                            });
                        });
                    });
                });

                // Propagate each template into the next 12 months (including current month)
                const monthsToCreate = 12;
                const added = [];
                Object.keys(templates).forEach(rid => {
                    const info = templates[rid];
                    for (let i = 0; i < monthsToCreate; i++) {
                        const target = new Date(today.getFullYear(), today.getMonth() + i, 1);
                        const y = String(target.getFullYear());
                        const m = String(String(target.getMonth() + 1).padStart(2, '0'));
                        if (!state.appData.data[y]) state.appData.data[y] = {};
                        if (!state.appData.data[y][m]) state.appData.data[y][m] = { incomes: [], expenses: [], savings: [] };
                        const md = state.appData.data[y][m];
                        // Ensure the array exists
                        if (!Array.isArray(md[info.type])) md[info.type] = [];
                        // If an entry with same recurringId already exists in that month, skip
                        const exists = (md[info.type] || []).some(it => it && it.recurringId === rid);
                        if (!exists) {
                            const clone = Object.assign({}, info.template);
                            clone.id = generateUUID();
                            clone.recurringId = rid;
                            // prefer to set a normalized date on the transaction (first day of month)
                            clone.date = new Date(target.getFullYear(), target.getMonth(), 1).toISOString();
                            // default isPaid to false for future months
                            clone.isPaid = !!clone.isPaid && i === 0 ? clone.isPaid : false;
                            md[info.type].push(clone);
                            added.push({ y, m, type: info.type, id: clone.id });
                        }
                    }
                });
                if (added.length > 0) {
                    try { storage.saveData(state.appData).catch(() => {}); } catch(e){}
                }
            } catch (e) { console.error('propagateRecurringTransactions', e); }
        }

        /**
         * Propagate a changed amount for subscription/recurring expenses to future months.
         * expense: the expense object in the current month that was edited
         * newAmount: number
         */
        async function propagateSubscriptionAmountChange(expense, newAmount) {
            try {
                if (!expense || typeof newAmount !== 'number') return;
                const recurringId = expense.recurringId || null;
                const signature = `${(expense.description||'').toString().trim().toLowerCase()}||${(expense.category||'').toString().trim().toLowerCase()}||${(expense.payment||'').toString().trim().toLowerCase()}`;
                const now = new Date(state.currentDate || new Date());
                // update future months (including next month onward)
                const monthsToUpdate = 24; // reasonable window
                const updated = [];
                for (let i = 1; i <= monthsToUpdate; i++) {
                    const target = new Date(now.getFullYear(), now.getMonth() + i, 1);
                    const y = String(target.getFullYear());
                    const m = String(String(target.getMonth() + 1).padStart(2, '0'));
                    const md = (state.appData.data && state.appData.data[y] && state.appData.data[y][m]) ? state.appData.data[y][m] : null;
                    if (!md) continue;
                    if (!Array.isArray(md.expenses)) continue;
                    md.expenses.forEach(e => {
                        try {
                            if (!e) return;
                            let match = false;
                            if (recurringId && e.recurringId && e.recurringId === recurringId) match = true;
                            // fallback: match by signature if recurringId not available
                            if (!match) {
                                const sig2 = `${(e.description||'').toString().trim().toLowerCase()}||${(e.category||'').toString().trim().toLowerCase()}||${(e.payment||'').toString().trim().toLowerCase()}`;
                                if (sig2 === signature) match = true;
                            }
                            if (match) {
                                e.amount = newAmount;
                                updated.push({ y, m, id: e.id });
                            }
                        } catch(ex) { /* ignore */ }
                    });
                }
                if (updated.length > 0) {
                    try { await storage.saveData(state.appData); } catch(e) { console.error('save propagateSubscriptionAmountChange', e); }
                }
                return updated;
            } catch(e) { console.error('propagateSubscriptionAmountChange error', e); return []; }
        }

        // --- CORE FUNCTIONS ---

        async function init() {
            // console.debug("App.init() iniciado.");
            // A nova função `loadData` é robusta e sempre retorna um objeto de estado válido.
            // O `await` garante que o código abaixo só execute após o carregamento completo.
            state.appData = await storage.loadData();
            // MIGRATE: if there are any transient travel plans on the in-memory state, move them to persisted settings
            try {
                if (!state.appData.settings) state.appData.settings = {};
                if ((!Array.isArray(state.appData.settings.travelPlans) || state.appData.settings.travelPlans.length === 0) && Array.isArray(state.travelPlans) && state.travelPlans.length > 0) {
                    state.appData.settings.travelPlans = (state.appData.settings.travelPlans || []).concat(state.travelPlans);
                    try { await storage.saveData(state.appData); } catch(e) { /* non-fatal */ }
                }
                // ensure settings.travelPlans exists
                state.appData.settings.travelPlans = state.appData.settings.travelPlans || [];
            } catch(e) { console.error('travelPlans migration', e); }
            // Limpa todos os filtros ao iniciar
            state.filters = { searchTerm: '' };
            state.filters.expenseFilters = {};
            if (!state.appData) {
                console.error("Falha crítica: não foi possível carregar ou criar os dados da aplicação.");
                // Idealmente, exibir uma mensagem de erro visível para o usuário aqui.
                return;
            }
            // Normalize settings lists (alphabetical) to keep UX consistent
            try {
                const s = state.appData.settings || {};
                if (Array.isArray(s.expenseCategories)) s.expenseCategories = sortStrings(s.expenseCategories);
                if (Array.isArray(s.savingCategories)) s.savingCategories = sortStrings(s.savingCategories);
                if (Array.isArray(s.goals)) s.goals = (s.goals || []).slice().sort((a,b) => ((a.name||'').toLowerCase() < (b.name||'').toLowerCase() ? -1 : 1));
                if (Array.isArray(s.paymentMethods)) s.paymentMethods = (s.paymentMethods || []).slice().sort((a,b)=> ((a.name||'').toLowerCase() < (b.name||'').toLowerCase() ? -1 : 1));
                state.appData.settings = s;
                // Persist normalized settings in background
                storage.saveData(state.appData).catch(() => {});
            } catch(e) { /* non-fatal */ }
            // console.debug("Dados prontos para uso na aplicação:", state.appData);
            mapUI();
            bindEvents();
            // Migrate any existing VR income items into a dedicated vrLedger per month
            try {
                Object.keys(state.appData.data).forEach(year => {
                    Object.keys(state.appData.data[year]).forEach(month => {
                        const md = state.appData.data[year][month];
                        if (!md) return;
                        if (!Array.isArray(md.incomes)) md.incomes = [];
                        if (!Array.isArray(md.vrLedger)) md.vrLedger = [];
                        // Ensure VT ledger exists
                        if (!Array.isArray(md.vtLedger)) md.vtLedger = [];
                        if (!Array.isArray(md.vrUsage)) md.vrUsage = [];
                        if (!Array.isArray(md.vtUsage)) md.vtUsage = [];
                        const preserved = [];
                        md.incomes.forEach(i => {
                            if (i && i.source === 'benefit-vr') {
                                md.vrLedger.push({ id: i.id || generateUUID(), amount: i.amount || 0, recurringId: i.recurringId || null, isRecurring: !!i.isRecurring, salaryMeta: i.salaryMeta || null });
                            } else preserved.push(i);
                        });
                        md.incomes = preserved;
                        // Deduplicate vrLedger entries by salaryMeta+amount to avoid legacy duplicates
                        try {
                            if (Array.isArray(md.vrLedger) && md.vrLedger.length > 1) {
                                const seen = new Map();
                                md.vrLedger = md.vrLedger.slice().reverse().filter(l => {
                                    try {
                                        const key = `${JSON.stringify(l.salaryMeta||{})}::${Number(l.amount||0)}`;
                                        if (seen.has(key)) return false;
                                        seen.set(key, true);
                                        return true;
                                    } catch(e){ return true; }
                                }).reverse();
                            }
                        } catch(e){ /* non-fatal */ }
                    });
                });
            } catch(e){ console.error('VR migration', e); }
            // Migrate any existing VT income items into vtLedger and legacy VT expenses into vtUsage
            try {
                Object.keys(state.appData.data).forEach(year => {
                    Object.keys(state.appData.data[year]).forEach(month => {
                        const md = state.appData.data[year][month];
                        if (!md) return;
                        if (!Array.isArray(md.incomes)) md.incomes = [];
                        if (!Array.isArray(md.vtLedger)) md.vtLedger = [];
                        if (!Array.isArray(md.vtUsage)) md.vtUsage = [];
                        const preserved = [];
                        md.incomes.forEach(i => {
                            if (i && i.source === 'benefit-vt') {
                                md.vtLedger.push({ id: i.id || generateUUID(), amount: i.amount || 0, recurringId: i.recurringId || null, isRecurring: !!i.isRecurring, salaryMeta: i.salaryMeta || null });
                            } else preserved.push(i);
                        });
                        md.incomes = preserved;
                        // Deduplicate vtLedger entries by salaryMeta+amount to avoid legacy duplicates
                        try {
                            if (Array.isArray(md.vtLedger) && md.vtLedger.length > 1) {
                                const seen2 = new Map();
                                md.vtLedger = md.vtLedger.slice().reverse().filter(l => {
                                    try {
                                        const key = `${JSON.stringify(l.salaryMeta||{})}::${Number(l.amount||0)}`;
                                        if (seen2.has(key)) return false;
                                        seen2.set(key, true);
                                        return true;
                                    } catch(e){ return true; }
                                }).reverse();
                            }
                        } catch(e){ /* non-fatal */ }
                        // move legacy expenses paid with VT into vtUsage
                        const remainingExpenses = [];
                        md.expenses = md.expenses || [];
                        md.expenses.forEach(exp => {
                            try {
                                if (exp && (exp.payment || '').toString() === 'VT') {
                                    md.vtUsage.push({ id: exp.id || generateUUID(), amount: Number(exp.amount) || 0, description: exp.description || '', date: exp.date || new Date().toISOString() });
                                } else {
                                    remainingExpenses.push(exp);
                                }
                            } catch (e) { remainingExpenses.push(exp); }
                        });
                        md.expenses = remainingExpenses;
                    });
                });
            } catch(e) { console.error('VT migration', e); }
            // Additionally migrate any legacy expenses that used payment === 'VR' into the vrUsage ledger
            try {
                let migratedCount = 0;
                Object.keys(state.appData.data).forEach(year => {
                    Object.keys(state.appData.data[year]).forEach(month => {
                        const md = state.appData.data[year][month];
                        if (!md) return;
                        if (!Array.isArray(md.expenses)) md.expenses = [];
                        if (!Array.isArray(md.vrUsage)) md.vrUsage = [];
                        // Find expenses paid with VR and move them to vrUsage
                        const remainingExpenses = [];
                        md.expenses.forEach(exp => {
                            try {
                                if (exp && (exp.payment || '').toString() === 'VR') {
                                    // preserve id if present
                                    md.vrUsage.push({ id: exp.id || generateUUID(), amount: Number(exp.amount) || 0, description: exp.description || '', date: exp.date || new Date().toISOString() });
                                    migratedCount++;
                                } else {
                                    remainingExpenses.push(exp);
                                }
                            } catch (e) { remainingExpenses.push(exp); }
                        });
                        md.expenses = remainingExpenses;
                    });
                });
                if (migratedCount > 0) {
                    // console.debug('[VR MIGRATION] moved', migratedCount, 'expenses -> vrUsage across months. Persisting migration to Firebase.');
                    // Persist state so the migration is saved
                    try { await storage.saveData(state.appData); } catch(e) { console.error('Failed to persist VR migration', e); }
                }
            } catch (e) { console.error('VR expenses migration', e); }
            goToDate(new Date());
            // console.debug("App.init() finalizado.");
        }

        function mapUI() {
            const ids = [
                'current-month-display', 'prev-month-btn', 'next-month-btn', 'today-btn', 'month-picker', 'month-picker-month', 'month-picker-year', 'month-picker-apply', 'month-picker-cancel', 
                'income-table-body', 'expenses-table-body', 'savings-table-body', 'expenses-table-head', 
                'toggle-expense-grouped', 'toggle-expense-grouped-label', 'expenses-grouped-container', 'expenses-groups',
                'add-transaction-btn', 'transaction-modal', 'close-transaction-modal-btn', 'transaction-form', 
                'expense-fields', 'dashboard-view', 'credit-cards-view', 'investments-view', 'travel-planner-view', 
                'credit-cards-container', 'installments-section', 'is-installment', 'search-description',
                'installments-fields', 'installments-current', 'payment-method', 'is-recurring', 
                'payment-recipient', 'payment-recipient-wrapper',
                'saving-fields', 'category-expense', 'category-saving', 'transaction-type-input', 
                'advanced-options', 'expense-type', 'feedback-visual-container', 'feedback-message',
                'import-data-btn', 'import-file-input', 'export-data-btn',
                'monthly-report-btn', 'annual-report-btn', 'monthly-report-modal', 'annual-report-modal',
                'desktop-dashboard-btn', 'desktop-creditcards-btn', 'desktop-investments-btn',
                'desktop-travelplanner-btn',
                'expenses-filter-btn', 'expenses-filter-popover', 'filter-payment-method', 'filter-spending-type', 'filter-category', 'filter-type', 'filter-recurring', 'filter-installment', 'filter-apply-btn', 'filter-clear-btn',
                'close-monthly-report-btn', 'close-annual-report-btn', 'add-goal-btn', 'goal-modal', 'close-goal-modal-btn',
                'goal-form', 'goals-container', 'financing-section'
            ];
            ids.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    // Mapeia para camelCase, mas garante nomes exatos para os campos críticos
                    if (id === 'installments-section') ui.installmentsSection = element;
                    else if (id === 'financing-section') ui.financingSection = element;
                    else ui[id.replace(/-./g, m => m[1].toUpperCase())] = element;
                }
            });
            // Attach click handlers for desktop quick links if available
            try {
                const dt = document.getElementById('desktop-travelplanner-btn'); if (dt) dt.addEventListener('click', () => changeView('travel-planner'));
            } catch(e) { /* ignore */ }
                // map new modal controls if present
                ui.applyToFuture = document.getElementById('apply-to-future');
                ui.previewFutureBtn = document.getElementById('preview-future-btn');
            ui.modalTypeToggles = document.querySelectorAll('.modal-type-toggle');
            // Map mobile bottom nav
            ui.mobileBottomNav = document.getElementById('mobile-bottom-nav');
            
            // Parcelamento - Toggle dos novos campos simplificados
            const installmentCheckbox = document.getElementById('is-installment');
            const installmentFields = document.getElementById('installment-fields');
            const installmentCount = document.getElementById('installment-count');
            const amountField = document.getElementById('amount');
            const previewCount = document.getElementById('installment-preview-count');
            const previewValue = document.getElementById('installment-preview-value');
            
            if (installmentCheckbox && installmentFields) {
                installmentCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        installmentFields.classList.remove('hidden');
                        updateInstallmentPreview();
                    } else {
                        installmentFields.classList.add('hidden');
                    }
                });
                
                // Atualizar preview quando mudar valor ou parcelas
                if (installmentCount && amountField && previewCount && previewValue) {
                    const updateInstallmentPreview = () => {
                        const count = parseInt(installmentCount.value) || 12;
                        const amount = parseLocaleNumber(amountField.value) || 0;
                        const installmentValue = count > 0 ? amount / count : 0;
                        
                        previewCount.textContent = count;
                        previewValue.textContent = formatCurrency(installmentValue);
                    };
                    
                    installmentCount.addEventListener('input', updateInstallmentPreview);
                    amountField.addEventListener('input', updateInstallmentPreview);
                }
            }
        }

        function bindEvents() {
            ui.prevMonthBtn.addEventListener('click', () => changeMonth(-1));
            ui.nextMonthBtn.addEventListener('click', () => changeMonth(1));
            ui.todayBtn.addEventListener('click', () => goToDate(new Date()));
            // Month picker interactions
            if (ui.currentMonthDisplay) ui.currentMonthDisplay.addEventListener('click', (e) => { e.stopPropagation(); openMonthPicker(); });
            if (ui.monthPickerCancel) ui.monthPickerCancel.addEventListener('click', closeMonthPicker);
            if (ui.monthPickerApply) ui.monthPickerApply.addEventListener('click', applyMonthPicker);
            // Close picker on outside click
            document.addEventListener('click', (e) => {
                const picker = ui.monthPicker;
                if (!picker) return;
                if (picker.classList.contains('hidden')) return;
                if (!picker.contains(e.target) && e.target !== ui.currentMonthDisplay) closeMonthPicker();
            });
            if (ui.addTransactionBtn) ui.addTransactionBtn.addEventListener('click', () => {
                // Always open the standard transaction modal from the global '+' button.
                openModal('expenses');
            });
            if (ui.closeTransactionModalBtn) ui.closeTransactionModalBtn.addEventListener('click', () => closeModal('transaction-modal'));
            // Require double-click on modal backdrop to avoid accidental closure
            const attachBackdropDoubleClickToClose = (modalEl, modalId, timeoutMs = 2000) => {
                if (!modalEl) return;
                let clickCount = 0;
                let timer = null;
                modalEl.addEventListener('click', (e) => {
                    if (e.target !== modalEl) return; // only backdrop clicks
                    clickCount++;
                    if (clickCount === 1) {
                        // first click - show subtle hint (optional) and start/reset timer
                        try { showToast('Clique novamente no fundo para fechar o modal', 'bg-gray-700'); } catch(e){}
                        timer = setTimeout(() => { clickCount = 0; timer = null; }, timeoutMs);
                        return;
                    }
                    if (clickCount >= 2) {
                        if (timer) { clearTimeout(timer); timer = null; }
                        clickCount = 0;
                        closeModal(modalId);
                    }
                });
            };
            attachBackdropDoubleClickToClose(ui.transactionModal, 'transaction-modal');
            attachBackdropDoubleClickToClose(ui.goalModal, 'goal-modal');
            attachBackdropDoubleClickToClose(ui.monthlyReportModal, 'monthly-report-modal');
            attachBackdropDoubleClickToClose(ui.annualReportModal, 'annual-report-modal');
            // Salary breakdown modal wiring (ensure backdrop double-click closes it)
            const salaryModalEl = document.getElementById('salary-breakdown-modal');
            if (salaryModalEl) {
                attachBackdropDoubleClickToClose(salaryModalEl, 'salary-breakdown-modal');
                const salaryCloseBtn = document.getElementById('close-salary-breakdown'); if (salaryCloseBtn) salaryCloseBtn.addEventListener('click', () => closeSalaryBreakdown());
            }
            ui.transactionForm.addEventListener('submit', (e) => handleFormSubmit(e));
            // Mostrar/ocultar seção Salário quando em Entradas
            const isSalaryCheckbox = document.getElementById('is-salary');
            const salaryFields = document.getElementById('salary-fields');
            // track if we auto-checked the salary box from the description field
            let autoCheckedSalary = false;
                if (isSalaryCheckbox) {
                // two-way sync handlers
                const amountInput = document.getElementById('amount');
                const salaryBaseInput = document.getElementById('salary-base');
                let amtToSalaryHandler = null;
                let salaryToAmtHandler = null;
                const attachSync = () => {
                    try {
                        if (amountInput && salaryBaseInput) {
                            amtToSalaryHandler = function() { salaryBaseInput.value = this.value || ''; };
                            salaryToAmtHandler = function() { amountInput.value = this.value || ''; };
                            amountInput.addEventListener('input', amtToSalaryHandler);
                            salaryBaseInput.addEventListener('input', salaryToAmtHandler);
                        }
                    } catch (e) { console.error('attachSync error', e); }
                };
                const detachSync = () => {
                    try {
                        if (amountInput && amtToSalaryHandler) amountInput.removeEventListener('input', amtToSalaryHandler);
                        if (salaryBaseInput && salaryToAmtHandler) salaryBaseInput.removeEventListener('input', salaryToAmtHandler);
                        amtToSalaryHandler = null; salaryToAmtHandler = null;
                    } catch (e) { console.error('detachSync error', e); }
                };

                isSalaryCheckbox.addEventListener('change', function() {
                    if (salaryFields) salaryFields.classList.toggle('hidden', !this.checked);
                    // expand modal when salary details are visible
                    try { const modal = document.getElementById('transaction-modal'); if (modal) modal.classList.toggle('modal-expanded', this.checked); } catch(e){}
                    if (this.checked) {
                        // ensure both fields reflect same value (prefer amount if salary-base empty)
                        try {
                            const a = parseFloat((amountInput || { value: '' }).value) || 0;
                            const s = parseFloat((salaryBaseInput || { value: '' }).value) || 0;
                            if (s === 0 && a > 0) salaryBaseInput.value = amountInput.value;
                            else if (a === 0 && s > 0) amountInput.value = salaryBaseInput.value;
                        } catch(e){}
                        attachSync();
                        // If the user checked 'É salário?', also mark transaction as recurring by default
                        const recurringCheckbox = document.getElementById('is-recurring');
                        if (recurringCheckbox) recurringCheckbox.checked = true;
                    } else {
                        detachSync();
                        // if user manually toggles off, clear auto flag
                        autoCheckedSalary = false;
                        try { const modal = document.getElementById('transaction-modal'); if (modal) modal.classList.remove('modal-expanded'); } catch(e){}
                    }
                });
            }

            // Auto-open salary options when description contains 'salário' (with or without accent)
            const descInput = document.getElementById('description');
            if (descInput) {
                const amountInput = document.getElementById('amount');
                let amountSyncAttached = false;
                let amountSyncHandler = null;
                descInput.addEventListener('input', function() {
                    try {
                        const raw = (this.value || '');
                        const v = raw.toLowerCase();
                        // Normalize to remove diacritics for exact-match checks
                        const normalized = raw.normalize('NFD').replace(/\p{Diacritic}/gu, '').toLowerCase();
                        // contain 'salari' to be flexible with accent/case
                        const hasSalaryWord = v.indexOf('salari') !== -1;
                        const isExactSalary = /^\s*salario?s?\s*$/i.test(normalized);

                        // Detect 'Serviço' prefix to reveal financing options for incomes
                        const isServicoPrefix = /^\s*servi\w*/i.test(normalized);

                        if (hasSalaryWord) {
                            // Ensure modal is in 'incomes' type so salary-section is visible
                            if (ui.transactionTypeInput && ui.transactionTypeInput.value !== 'incomes') {
                                toggleTransactionType('incomes');
                            }
                            if (isSalaryCheckbox && !isSalaryCheckbox.checked) {
                                isSalaryCheckbox.checked = true;
                                if (salaryFields) salaryFields.classList.remove('hidden');
                                autoCheckedSalary = true;
                                // ensure recurring is checked too
                                const recurringCheckbox = document.getElementById('is-recurring');
                                if (recurringCheckbox) recurringCheckbox.checked = true;
                                // attach two-way sync if not already attached
                                try { isSalaryCheckbox.dispatchEvent(new Event('change')); } catch(e){}
                            }
                        } else {
                            // If we auto-checked earlier and the keyword was removed, revert
                            if (autoCheckedSalary && isSalaryCheckbox) {
                                isSalaryCheckbox.checked = false;
                                if (salaryFields) salaryFields.classList.add('hidden');
                                autoCheckedSalary = false;
                            }
                        }

                        // If description is exactly 'Salário' (allow accents), force both salary and recurring and sync amount -> salary-base
                        const salaryBaseInput = document.getElementById('salary-base');
                        if (isExactSalary) {
                            const recurringCheckbox = document.getElementById('is-recurring');
                            if (isSalaryCheckbox && !isSalaryCheckbox.checked) {
                                isSalaryCheckbox.checked = true;
                                if (salaryFields) salaryFields.classList.remove('hidden');
                                autoCheckedSalary = true;
                                try { isSalaryCheckbox.dispatchEvent(new Event('change')); } catch(e){}
                            }
                            if (recurringCheckbox) recurringCheckbox.checked = true;
                        }
                        // If description starts with 'Serviço', ensure modal is in 'incomes' and show financing options
                        if (isServicoPrefix) {
                            if (ui.transactionTypeInput && ui.transactionTypeInput.value !== 'incomes') {
                                toggleTransactionType('incomes');
                            }
                            // Reveal installments option for 'Serviço' incomes (do not auto-check)
                            try {
                                const instSection = document.getElementById('installments-section'); if (instSection) instSection.classList.remove('hidden');
                            } catch(e){}
                        }
                        if (isExactSalary && amountInput) {
                            // copy current amount value immediately
                            if (salaryBaseInput) salaryBaseInput.value = amountInput.value || '';
                            // attach sync handler if not attached
                            if (!amountSyncAttached) {
                                amountSyncHandler = function() {
                                    try { if (salaryBaseInput) salaryBaseInput.value = this.value || ''; } catch(e){}
                                };
                                amountInput.addEventListener('input', amountSyncHandler);
                                amountSyncAttached = true;
                            }
                        } else {
                            // remove sync if previously attached
                            if (amountSyncAttached && amountInput && amountSyncHandler) {
                                amountInput.removeEventListener('input', amountSyncHandler);
                                amountSyncAttached = false;
                                amountSyncHandler = null;
                            }
                        }

                    } catch (e) { console.error('description auto-salary detect error', e); }
                });
            }
            ui.modalTypeToggles.forEach(btn => btn.addEventListener('click', (e) => toggleTransactionType(e.currentTarget.dataset.type)));
            
            ui.incomeTableBody.addEventListener('click', (e) => handleTableClick(e, 'incomes'));
            ui.expensesTableBody.addEventListener('click', (e) => handleTableClick(e, 'expenses'));
            ui.savingsTableBody.addEventListener('click', (e) => handleTableClick(e, 'savings'));

            ui.importDataBtn.addEventListener('click', () => ui.importFileInput.click());
            ui.importFileInput.addEventListener('change', handleImport);
            ui.exportDataBtn.addEventListener('click', handleExport);

            // Backup / Restore handlers
            try {
                const createBackupBtn = document.getElementById('create-backup-btn');
                const restoreBackupBtn = document.getElementById('restore-backup-btn');
                const backupModal = document.getElementById('backup-restore-modal');
                const backupsListEl = document.getElementById('backups-list');
                const backupPreviewEl = document.getElementById('backup-preview');
                const refreshBackupsBtn = document.getElementById('refresh-backups-btn');
                const closeBackupModalBtn = document.getElementById('close-backup-modal');
                const restoreSelectedBtn = document.getElementById('restore-selected-btn');
                const downloadPreviewBtn = document.getElementById('download-preview-btn');
                const deleteBackupBtn = document.getElementById('delete-backup-btn');
                
                let currentBackupId = null; // Armazena o ID do backup atualmente visualizado

                function formatTS(d) {
                    try {
                        const pad = (n,len=2) => String(n).padStart(len,'0');
                        const y = d.getFullYear(); const m = pad(d.getMonth()+1); const day = pad(d.getDate());
                        const hh = pad(d.getHours()); const mm = pad(d.getMinutes()); const ss = pad(d.getSeconds());
                        return `${y}${m}${day}_${hh}${mm}${ss}`;
                    } catch(e){ return String(Date.now()); }
                }

                async function createBackup() {
                    try {
                        showLoading();
                        const payload = JSON.parse(JSON.stringify(state.appData || {}));
                        const createdAt = Date.now();
                        // Build name: projeto-data
                        const project = (firebaseConfig && firebaseConfig.projectId) ? firebaseConfig.projectId : 'manual';
                        const name = `${project}-${formatTS(new Date(createdAt))}`;
                        const record = { name, createdAt, data: payload };
                        // Save under /backups using push() so we have stable ids
                        const ref = database.ref('/backups').push();
                        await ref.set(record);
                        hideLoading();
                        showToast('Backup criado com sucesso: ' + name, 'bg-green-600');
                        return record;
                    } catch (err) {
                        hideLoading();
                        showToast('Falha ao criar backup: ' + (err && err.message ? err.message : String(err)), 'bg-red-600');
                        throw err;
                    }
                }

                async function listBackups() {
                    try {
                        // Try server-side ordered query first (fast when index exists)
                        try {
                            const snapshot = await database.ref('/backups').orderByChild('createdAt').get();
                            const arr = [];
                            snapshot.forEach(s => { arr.push({ id: s.key, ...(s.val()||{}) }); });
                            // sort desc by createdAt
                            arr.sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
                            return arr;
                        } catch (innerErr) {
                            // If the error is about missing index, fallback to client-side sort
                            if (innerErr && innerErr.message && innerErr.message.indexOf && innerErr.message.indexOf('Index not defined') !== -1) {
                                // Friendly log + UI hint in Portuguese for maintainers
                                console.info('listBackups: índice ausente em "/backups.createdAt" — ordenação será feita localmente como fallback.');
                                try { showToast('Aviso: índice ausente em /backups.createdAt — listagem usando ordenação local. Para melhor performance adicione ".indexOn": ["createdAt"] nas regras do Realtime Database.', 'bg-yellow-600'); } catch(e){}
                            } else if (innerErr && innerErr.code && innerErr.code === 'permission-denied') {
                                // Permission issues should still be surfaced
                                throw innerErr;
                            } else if (innerErr && innerErr.message && innerErr.message.indexOf && innerErr.message.indexOf('.indexOn') !== -1) {
                                console.info('listBackups: índice ausente em "/backups.createdAt" — ordenação será feita localmente como fallback.');
                            } else {
                                // Other errors: rethrow
                                throw innerErr;
                            }
                            // fallback: read all backups and sort locally
                            const snapshot = await database.ref('/backups').once('value');
                            const arr = [];
                            snapshot.forEach(s => { arr.push({ id: s.key, ...(s.val()||{}) }); });
                            arr.sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
                            return arr;
                        }
                    } catch (e) { console.error('listBackups', e); return []; }
                }

                function renderBackupsList(list) {
                    if (!backupsListEl) return;
                    backupsListEl.innerHTML = '';
                    if (!list || list.length === 0) {
                        backupsListEl.innerHTML = '<div class="text-sm text-gray-500">Nenhum backup encontrado.</div>';
                        return;
                    }
                    list.forEach(item => {
                        const btn = document.createElement('button');
                        btn.className = 'w-full text-left p-2 rounded hover:bg-gray-50 flex justify-between items-center';
                        btn.dataset.backupid = item.id;
                        const left = document.createElement('div');
                        left.innerHTML = `<div style="font-weight:600">${escapeHtml(item.name||'Sem nome')}</div><div class="text-xs text-gray-500">${new Date(item.createdAt||0).toLocaleString()}</div>`;
                        const right = document.createElement('div');
                        right.innerHTML = '<span class="material-symbols-outlined text-gray-500">chevron_right</span>';
                        btn.appendChild(left); btn.appendChild(right);
                        btn.addEventListener('click', async () => {
                            // load preview
                            try {
                                showLoading();
                                const snap = await database.ref('/backups/' + item.id).get();
                                const val = snap.val();
                                hideLoading();
                                showBackupPreview(val, item.id);
                            } catch (err) { hideLoading(); showToast('Falha ao carregar backup: ' + (err && err.message ? err.message : err), 'bg-red-600'); }
                        });
                        backupsListEl.appendChild(btn);
                    });
                }

                function showBackupPreview(val, id) {
                    if (!backupPreviewEl) return;
                    currentBackupId = id; // Armazenar o ID do backup atual
                    if (!val) { backupPreviewEl.innerHTML = '<div class="text-sm text-gray-500">Sem dados de backup.</div>'; return; }
                    const meta = `<div class="text-sm text-gray-600 mb-2">Nome: <strong>${escapeHtml(val.name||'')}</strong> — Criado: ${new Date(val.createdAt||0).toLocaleString()}</div>`;
                    // render a small summary: years count and totals
                    let summary = '';
                    try {
                        const years = Object.keys(val.data && val.data.data ? val.data.data : (val.data || {}).data || {});
                        // Fallback when data stored directly in data property
                        const topData = val.data || {};
                        const countYears = topData.data ? Object.keys(topData.data).length : Object.keys(topData).length;
                        summary += `<div class="text-sm text-gray-700 mb-2">Anos: <strong>${countYears}</strong></div>`;
                    } catch(e) { summary += '<div class="text-sm text-gray-500">Resumo indisponível.</div>'; }
                    // Build preview area with a 'Preview' action that renders JSON as cards
                    backupPreviewEl.innerHTML = meta + summary + `
                        <div class="flex items-center gap-2 mb-2">
                            <button id="render-backup-cards-btn" class="px-3 py-1 rounded bg-blue-50 border text-sm text-blue-600">Preview</button>
                            <span class="text-xs text-gray-400">Visualizar conteúdo do backup como cards para comparação</span>
                        </div>
                        <div id="backup-cards-container" style="margin-bottom:8px"></div>
                        <pre id="backup-raw-json" style="white-space:pre-wrap;word-break:break-word;max-height:200px;overflow:auto;border-top:1px solid rgba(0,0,0,0.04);padding-top:8px">${escapeHtml(JSON.stringify(val.data || val, null, 2))}</pre>`;
                    // attach download/restore handlers
                    // attach preview button handler
                    const renderBtn = document.getElementById('render-backup-cards-btn');
                    const cardsContainer = document.getElementById('backup-cards-container');
                    if (renderBtn) {
                        renderBtn.addEventListener('click', function () {
                            try {
                                // try to get the payload that contains the app data
                                const payload = val.data || val;
                                renderBackupDataCards(payload, cardsContainer);
                            } catch (err) {
                                showToast('Falha ao renderizar preview: ' + (err && err.message ? err.message : err), 'bg-red-600');
                            }
                        });
                    }
                    downloadPreviewBtn.onclick = () => {
                        try {
                            const blob = new Blob([JSON.stringify(val.data || val, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a'); a.href = url; a.download = `${(val.name||'backup')}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                            showToast('Download iniciado', 'bg-gray-700');
                        } catch (e) { showToast('Falha ao baixar: ' + e.message, 'bg-red-600'); }
                    };
                    restoreSelectedBtn.onclick = async () => {
                        try {
                            try { const ok = await confirmAsync('Deseja restaurar este backup? Isso substituirá os dados atuais.', 'Restaurar backup'); if (!ok) return; } catch(e){ return; }
                            showLoading();
                            const payload = val.data || val;
                            // Overwrite current state and persist
                            state.appData = JSON.parse(JSON.stringify(payload));
                            await storage.saveData(state.appData);
                            hideLoading();
                            showToast('Restauração concluída. Recarregando...', 'bg-green-600');
                            setTimeout(() => location.reload(), 800);
                        } catch (err) { hideLoading(); showToast('Falha ao restaurar: ' + (err && err.message ? err.message : err), 'bg-red-600'); }
                    };
                }

                // Render backup data into simple comparison cards
                function renderBackupDataCards(payload, container) {
                    if (!container) return;
                    container.innerHTML = '';
                    // normalize payload to ensure payload.data exists in expected shape
                    const normalized = normalizeBackupPayload(payload);
                    if (!normalized || !normalized.data) {
                        container.innerHTML = '<div class="text-sm text-gray-500">Formato inesperado: conteúdo não contém propriedade "data" após normalização.</div>';
                        return;
                    }
                    // payload.data is expected as { year: { month: { incomes:[], expenses:[], savings:[] }}}
                    const years = Object.keys(normalized.data).sort((a,b) => b - a);
                    // render a quick diff comparing backup vs current state
                    const diffEl = document.createElement('div'); diffEl.className = 'mb-3';
                    diffEl.innerHTML = renderBackupVsCurrentSummary(normalized.data, state.appData && state.appData.data ? state.appData.data : {});
                    container.appendChild(diffEl);
                    years.forEach(year => {
                        const yearEl = document.createElement('div');
                        yearEl.className = 'mb-3';
                        const months = Object.keys(payload.data[year] || {}).sort((a,b) => b - a);
                        months.forEach(month => {
                            const m = normalized.data[year][month] || { incomes: [], expenses: [], savings: [] };
                            const incomes = Array.isArray(m.incomes) ? m.incomes : [];
                            const expenses = Array.isArray(m.expenses) ? m.expenses : [];
                            const savings = Array.isArray(m.savings) ? m.savings : [];
                            const sum = arr => (arr || []).reduce((s, it) => s + (Number(it.amount) || 0), 0);
                            const card = document.createElement('div');
                            card.className = 'p-3 rounded-lg border bg-white mb-2';
                            card.innerHTML = `
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-sm font-semibold">${escapeHtml(year)} / ${escapeHtml(month)}</div>
                                    <div class="text-xs text-gray-500">Lançamentos: ${incomes.length + expenses.length + savings.length}</div>
                                </div>
                                <div class="grid grid-cols-3 gap-2 text-sm mb-2">
                                    <div class="p-2 rounded bg-green-50">Entradas<br><strong>${formatCurrency(sum(incomes))}</strong></div>
                                    <div class="p-2 rounded bg-red-50">Despesas<br><strong>${formatCurrency(sum(expenses))}</strong></div>
                                    <div class="p-2 rounded bg-yellow-50">Reservas<br><strong>${formatCurrency(sum(savings))}</strong></div>
                                </div>
                                <div class="text-xs text-gray-600">
                                    <div><strong>Amostras:</strong></div>
                                    <div class="mt-1">
                                        ${renderSampleList(incomes, 'Entrada')}
                                        ${renderSampleList(expenses, 'Despesa')}
                                        ${renderSampleList(savings, 'Reserva')}
                                    </div>
                                </div>
                            `;
                            yearEl.appendChild(card);
                        });
                        container.appendChild(yearEl);
                    });
                }

                // Try to normalize common backup payload shapes into { data: { year: { month: {...} }}}
                function normalizeBackupPayload(p) {
                    if (!p) return null;
                    // if wrapped as { financeAppDB_v10: { data: ... } }
                    if (p.financeAppDB_v10 && p.financeAppDB_v10.data) return { data: p.financeAppDB_v10.data };
                    // if already { data: ... }
                    if (p.data && typeof p.data === 'object') return { data: p.data };
                    // if payload directly contains years (top-level years keys)
                    const maybeYears = Object.keys(p).filter(k => /^\d{4}$/.test(k));
                    if (maybeYears.length > 0) return { data: p };
                    // some backups might nest under data.data
                    if (p.data && p.data.data) return { data: p.data.data };
                    // fallback: try to find first prop that looks like years
                    for (const k in p) {
                        if (p[k] && typeof p[k] === 'object') {
                            const subKeys = Object.keys(p[k]);
                            if (subKeys.some(sk => /^\d{2}$/.test(sk) || /^\d{1,2}$/.test(sk))) {
                                return { data: p };
                            }
                        }
                    }
                    return null;
                }

                // Render a compact comparison summary between backupData and currentData
                function renderBackupVsCurrentSummary(backupData, currentData) {
                    // collect union of years and months
                    const years = Array.from(new Set([].concat(Object.keys(backupData||{}), Object.keys(currentData||{})))).sort((a,b) => b - a);
                    if (years.length === 0) return '<div class="text-sm text-gray-500">Sem dados para comparar.</div>';
                    let html = '<div class="text-sm font-medium mb-2">Resumo (Backup vs Atual)</div>';
                    html += '<div class="space-y-2">';
                    years.forEach(y => {
                        const months = Array.from(new Set([].concat(Object.keys((backupData[y]||{})), Object.keys((currentData[y]||{}))))).sort((a,b) => b - a);
                        months.forEach(m => {
                            const bM = (backupData[y] && backupData[y][m]) || { incomes:[], expenses:[], savings:[] };
                            const cM = (currentData[y] && currentData[y][m]) || { incomes:[], expenses:[], savings:[] };
                            const sum = arr => (Array.isArray(arr) ? arr.reduce((s,it)=> s + (Number(it.amount)||0), 0) : 0);
                            const bIn = sum(bM.incomes), bEx = sum(bM.expenses), bSa = sum(bM.savings);
                            const cIn = sum(cM.incomes), cEx = sum(cM.expenses), cSa = sum(cM.savings);
                            html += `<div class="flex items-center justify-between p-2 rounded bg-gray-50 border">
                                <div class="text-xs">${escapeHtml(y)} / ${escapeHtml(m)}</div>
                                <div class="text-xs grid grid-cols-3 gap-2 text-right" style="min-width:320px">
                                    <div class="text-xs">In: ${formatCurrency(bIn)} → ${formatCurrency(cIn)}</div>
                                    <div class="text-xs">Ex: ${formatCurrency(bEx)} → ${formatCurrency(cEx)}</div>
                                    <div class="text-xs">Sa: ${formatCurrency(bSa)} → ${formatCurrency(cSa)}</div>
                                </div>
                            </div>`;
                        });
                    });
                    html += '</div>';
                    return html;
                }

                function renderSampleList(arr, label) {
                    if (!Array.isArray(arr) || arr.length === 0) return '';
                    const items = arr.slice(0,3).map(it => `<div class="truncate">${escapeHtml(label + ': ' + (it.description || it.desc || it.label || '—') + ' — ' + (formatCurrency(Number(it.amount)||0)))}</div>`).join('');
                    return `<div class="mt-1 text-xs">${items}</div>`;
                }

                function formatCurrency(v) {
                    try { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(Number(v)||0); } catch(e) { return String(v); }
                }

                function escapeHtml(s) { return String(s||'').replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

                // open modal and list backups
                async function openBackupModal() {
                    if (!backupModal) return;
                    try { backupModal.showModal(); } catch(e) { backupModal.setAttribute('open',''); }
                    backupModal.classList.add('modal-expanded');
                    try { const list = await listBackups(); renderBackupsList(list); } catch(e) { renderBackupsList([]); }
                }
                
                // Função para excluir backup
                async function deleteBackup(backupId, backupName) {
                    if (!backupId) {
                        showToast('Nenhum backup selecionado para exclusão', 'bg-yellow-600');
                        return;
                    }
                    
                    try {
                        // Confirmar exclusão
                        const confirmed = confirm(`Tem certeza que deseja excluir permanentemente o backup "${backupName || 'sem nome'}"?\n\nEsta ação não pode ser desfeita.`);
                        if (!confirmed) return;
                        
                        showLoading();
                        
                        // Excluir do Firebase
                        await database.ref('/backups/' + backupId).remove();
                        
                        hideLoading();
                        showToast('Backup excluído com sucesso!', 'bg-green-600');
                        
                        // Limpar preview
                        if (backupPreviewEl) {
                            backupPreviewEl.innerHTML = '<div class="text-sm text-gray-500">Selecione um backup para visualizar.</div>';
                        }
                        currentBackupId = null;
                        
                        // Recarregar lista de backups
                        const list = await listBackups();
                        renderBackupsList(list);
                        
                    } catch (err) {
                        hideLoading();
                        showToast('Falha ao excluir backup: ' + (err && err.message ? err.message : String(err)), 'bg-red-600');
                        console.error('deleteBackup error:', err);
                    }
                }

                if (createBackupBtn) createBackupBtn.addEventListener('click', async () => { try { await createBackup(); } catch(e){} });
                if (restoreBackupBtn) restoreBackupBtn.addEventListener('click', () => openBackupModal());
                if (refreshBackupsBtn) refreshBackupsBtn.addEventListener('click', async () => { try { const list = await listBackups(); renderBackupsList(list); } catch(e){} });
                if (closeBackupModalBtn) closeBackupModalBtn.addEventListener('click', () => { try { backupModal.close(); } catch(e){ backupModal.removeAttribute('open'); } });
                
                // Event listener para o botão de exclusão
                if (deleteBackupBtn) {
                    deleteBackupBtn.addEventListener('click', async () => {
                        if (!currentBackupId) {
                            showToast('Nenhum backup selecionado', 'bg-yellow-600');
                            return;
                        }
                        
                        // Buscar nome do backup atual
                        try {
                            const snap = await database.ref('/backups/' + currentBackupId).get();
                            const val = snap.val();
                            const backupName = val && val.name ? val.name : 'sem nome';
                            await deleteBackup(currentBackupId, backupName);
                        } catch(e) {
                            showToast('Falha ao excluir: ' + (e && e.message ? e.message : String(e)), 'bg-red-600');
                        }
                    });
                }

            } catch(e) { console.error('attach backup handlers', e); }

            ui.expensesTableHead.addEventListener('click', (e) => {
                    const header = e.target.closest('.sortable-header');
                    if(header) {
                        // Toggle sort order if clicking same column
                        if (state.sort.key === header.dataset.sort) {
                            state.sort.order = state.sort.order === 'asc' ? 'desc' : 'asc';
                        } else {
                            state.sort.key = header.dataset.sort;
                            state.sort.order = 'asc';
                        }
                        renderExpenseTable();
                    }
            });
            document.querySelectorAll('.tab-button').forEach(button => button.addEventListener('click', (e) => changeView(e.currentTarget.dataset.view)));
            // 'more' swipe handlers removed to keep rows as standard table rows with inline action buttons
            // Mobile bottom nav interactions
            if (ui.mobileBottomNav) {
                const buttons = ui.mobileBottomNav.querySelectorAll('.mobile-nav-btn');
                function updateMobileNavVisibility() {
                    if (window.innerWidth <= 639) {
                        ui.mobileBottomNav.classList.add('active');
                    } else {
                        ui.mobileBottomNav.classList.remove('active');
                    }
                }
                updateMobileNavVisibility();
                window.addEventListener('resize', updateMobileNavVisibility);
                buttons.forEach(btn => btn.addEventListener('click', (e) => changeView(e.currentTarget.dataset.view)));
            }
            // Independent handler: installment checkbox only controls installments card
            ui.isInstallment.addEventListener('change', () => {
                try {
                    ui.installmentsFields.classList.toggle('active', ui.isInstallment.checked);
                } catch (e) { console.error('isInstallment change handler', e); }
            });

            // Independent handler: financing checkbox only controls financing card
            try {
                const financingCheckbox = document.getElementById('is-financing');
                if (financingCheckbox) {
                    financingCheckbox.addEventListener('change', () => {
                        try {
                            const ff = document.getElementById('financing-fields');
                            if (ff) ff.classList.toggle('active', financingCheckbox.checked);
                        } catch (e) { console.error('financing change handler', e); }
                    });
                }
            } catch (e) { console.error('bindEvents attach financing handler', e); }
            // Dashboard grouping controls removed: grouping is only available on the credit-cards (faturas) page.
            try {
                if (ui['toggleExpenseGrouped']) {
                    ui['toggleExpenseGrouped'].style.display = 'none';
                }
                if (ui.groupExpensesBtn) {
                    ui.groupExpensesBtn.style.display = 'none';
                }
                const wrapped = document.getElementById('expenses-grouped-container'); if (wrapped) wrapped.classList.add('hidden');
                // ensure state.showGroupedExpenses is not used on dashboard
                state.showGroupedExpenses = false;
            } catch(e) { /* silent */ }

                // Delegated handler: if any card's group-toggle is clicked, toggle grouping for ALL cards
                try {
                    if (ui.creditCardsContainer) {
                        ui.creditCardsContainer.addEventListener('click', (ev) => {
                            const toggle = ev.target.closest && ev.target.closest('.card-group-toggle');
                            if (!toggle) return;
                            ev.preventDefault();
                                const name = toggle.dataset.cardName;
                            // Determine new state as inverse of current state of clicked card
                            const newState = !state.cardGrouped[name];
                            // Apply to all cards
                            const container = document.getElementById('credit-cards-container');
                            if (!container) return;
                            const roots = Array.from(container.querySelectorAll('[data-card-root]'));
                                roots.forEach(r => {
                                const nm = r.dataset.cardRoot;
                                state.cardGrouped[nm] = newState;
                                // update per-card icon
                                try { const b = r.querySelector('.card-group-toggle .material-symbols-outlined'); if (b) b.textContent = newState ? 'vertical_split' : 'merge_type'; } catch(e){}
                                // repopulate each card using tolerant matching
                                try { const exps = (getCurrentMonthData().expenses || []).filter(e => paymentMatches(e.payment || '', nm)); populateCardExpenses(nm, exps); } catch(e){}
                            });
                        });
                    }
                } catch(e) { console.error('attach delegated card-group-toggle', e); }

            
            ui.paymentMethod.addEventListener('change', (e) => {
                toggleInstallmentSection(e.target.value);
                // Show recipient field for PIX and Transferência (tolerant matching)
                try {
                    const raw = (e.target.value || '').toString();
                    const normalize = s => (s || '').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
                    const nv = normalize(raw);
                    const recipientWrapper = document.getElementById('payment-recipient-wrapper');
                    const recipientInput = document.getElementById('payment-recipient');
                    const recipientHint = document.getElementById('payment-recipient-hint');
                    if (recipientWrapper && recipientInput) {
                        // match 'pix' exactly and any token containing 'transfer' for Transferência variants
                        const mustShow = (nv === 'pix' || nv.indexOf('transfer') !== -1 || nv === 'transferencia');
                        if (mustShow) {
                            recipientWrapper.classList.remove('hidden');
                            recipientWrapper.setAttribute('aria-hidden', 'false');
                            recipientInput.setAttribute('required', 'required');
                            try { recipientInput.focus(); } catch(_){}
                            if (recipientHint) { recipientHint.classList.remove('hidden'); recipientHint.setAttribute('aria-hidden', 'false'); }
                        } else {
                            recipientWrapper.classList.add('hidden');
                            recipientWrapper.setAttribute('aria-hidden', 'true');
                            recipientInput.removeAttribute('required');
                            if (recipientHint) { recipientHint.classList.add('hidden'); recipientHint.setAttribute('aria-hidden', 'true'); }
                        }
                    }
                } catch (recErr) { console.error('recipient toggle error', recErr); }
                try {
                    const pm = (e.target.value || '').toString();
                    const settings = state.appData.settings || {};
                    const expenseCategories = settings.expenseCategories || [];
                    const normalize = s => (s || '').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
                    const descEl = document.getElementById('description');
                    const descHint = document.getElementById('description-hint');
                    const catHint = document.getElementById('category-hint');

                    // clear hints by default
                    if (descHint) { descHint.textContent = ''; descHint.classList.add('hidden'); descHint.setAttribute('aria-hidden', 'true'); }
                    if (catHint) { catHint.textContent = ''; catHint.classList.add('hidden'); catHint.setAttribute('aria-hidden', 'true'); }

                    // VR enforcement: Alimentação / Essenciais
                    if (pm === 'VR') {
                        const foundAlim = expenseCategories.find(c => normalize(c).includes('aliment'));
                        if (foundAlim && ui.categoryExpense) {
                            ui.categoryExpense.value = foundAlim;
                            try { ui.categoryExpense.disabled = true; } catch(e){}
                        }
                        if (ui.expenseType) ui.expenseType.value = 'Essenciais';
                        // ensure description is editable for VR cases
                        try { if (descEl) descEl.disabled = false; } catch(e){}
                        // show hint explaining why category is locked
                        if (catHint) { catHint.textContent = 'Categoria padronizada para VR (Alimentação). Você pode alterar após salvar no gerenciamento de VR.'; catHint.classList.remove('hidden'); catHint.setAttribute('aria-hidden', 'false'); }
                        showToast('Pagamento via VR: categoria e tipo ajustados para Alimentação / Essencial.', 'bg-yellow-600');
                    }

                    // VT enforcement: Transporte (categoria obrigatória) + description forced to 'Abastecimento'
                    else if (pm === 'VT') {
                        const foundTransp = expenseCategories.find(c => normalize(c).includes('transport')) || expenseCategories.find(c => normalize(c).includes('transp')) || expenseCategories.find(c => normalize(c).includes('transporte'));
                        if (foundTransp && ui.categoryExpense) {
                            ui.categoryExpense.value = foundTransp;
                            try { ui.categoryExpense.disabled = true; } catch(e){}
                        }
                        if (ui.expenseType) ui.expenseType.value = 'Essenciais';
                        // Force description to 'Abastecimento' and make it readonly/disabled so it's mandatory
                        try { if (descEl) { descEl.value = 'Abastecimento'; descEl.disabled = true; } } catch(e){}
                        // show hint explaining why description and category are locked for VT
                        if (descHint) { descHint.textContent = 'Descrição obrigatória para VT: "Abastecimento". Caso precise outra descrição, registre como débito comum.'; descHint.classList.remove('hidden'); descHint.setAttribute('aria-hidden', 'false'); }
                        if (catHint) { catHint.textContent = 'Categoria padronizada para VT (Transporte). Para outras categorias, use método de pagamento diferente.'; catHint.classList.remove('hidden'); catHint.setAttribute('aria-hidden', 'false'); }
                        showToast('Pagamento via VT: categoria definida para Transporte e descrição definida para "Abastecimento".', 'bg-yellow-600');
                    }

                    // Otherwise, if changing away from VR/VT, re-enable category select and description
                    else {
                        try { if (ui.categoryExpense) ui.categoryExpense.disabled = false; } catch(e){}
                        try { if (descEl) descEl.disabled = false; } catch(e){}
                        // clear hints when normal payment selected
                        if (descHint) { descHint.textContent = ''; descHint.classList.add('hidden'); descHint.setAttribute('aria-hidden', 'true'); }
                        if (catHint) { catHint.textContent = ''; catHint.classList.add('hidden'); catHint.setAttribute('aria-hidden', 'true'); }
                    }
                } catch (err) { console.error('paymentMethod change enforcement error', err); }
            });

            ui.monthlyReportBtn.addEventListener('click', () => openMonthlyReport());
            // Desktop quick links: mirror mobile/nav tabs behavior
            if (ui.desktopDashboardBtn) ui.desktopDashboardBtn.addEventListener('click', () => changeView('dashboard'));
            if (ui.desktopCreditcardsBtn) ui.desktopCreditcardsBtn.addEventListener('click', () => changeView('credit-cards'));
            if (ui.desktopInvestmentsBtn) ui.desktopInvestmentsBtn.addEventListener('click', () => changeView('investments'));
            // Make VR KPI clickable: open Faturas (credit-cards) when clicked
            try {
                const kpiVr = document.getElementById('kpi-vr-card');
                if (kpiVr) {
                    kpiVr.style.cursor = 'pointer';
                    kpiVr.addEventListener('click', () => {
                        // Navigate to the credit-cards (faturas) view.
                        // NOTE: do NOT modify state.filters here to avoid applying filters automatically.
                        changeView('credit-cards');
                    });
                }
            } catch (e) { console.error('attach kpi-vr click handler', e); }
            try {
                const kpiVt = document.getElementById('kpi-vt-card');
                if (kpiVt) {
                    kpiVt.style.cursor = 'pointer';
                    kpiVt.addEventListener('click', () => {
                        // Navigate to the credit-cards (faturas) view.
                        // NOTE: do NOT modify state.filters here to avoid applying filters automatically.
                        changeView('credit-cards');
                    });
                }
            } catch (e) { console.error('attach kpi-vt click handler', e); }
            // Show import/export when hovering the monthly report icon/area
            const infrequent = document.getElementById('infrequent-controls');
            if (infrequent && ui.monthlyReportBtn) {
                let _hideTimer = null;
                ui.monthlyReportBtn.addEventListener('mouseenter', () => { clearTimeout(_hideTimer); infrequent.classList.add('visible'); });
                ui.monthlyReportBtn.addEventListener('mouseleave', () => { _hideTimer = setTimeout(() => infrequent.classList.remove('visible'), 250); });
                // Also keep visible when hovering the controls themselves
                infrequent.addEventListener('mouseenter', () => { clearTimeout(_hideTimer); infrequent.classList.add('visible'); });
                infrequent.addEventListener('mouseleave', () => { _hideTimer = setTimeout(() => infrequent.classList.remove('visible'), 250); });
            }
            // Mobile: toggle infrequent controls with a button (touch-friendly)
            const mobileToggle = document.getElementById('mobile-infrequent-toggle');
            if (mobileToggle && infrequent) {
                // Ensure the button is visible only on small screens
                mobileToggle.style.display = window.innerWidth <= 639 ? 'inline-flex' : 'none';
                mobileToggle.addEventListener('click', () => {
                    const isVisible = infrequent.classList.toggle('mobile-visible');
                    // Ensure we remove desktop hover-visible if toggling manually
                    if (isVisible) infrequent.classList.remove('visible');
                });
                // React to resize to show/hide the button appropriately
                window.addEventListener('resize', () => {
                    mobileToggle.style.display = window.innerWidth <= 639 ? 'inline-flex' : 'none';
                    if (window.innerWidth > 639) infrequent.classList.remove('mobile-visible');
                });
            }
                // Ensure charts resize on orientation change / resize
                window.addEventListener('resize', () => {
                    if (ui && ui.charts) {
                        Object.values(ui.charts).forEach(c => { try { if (c && typeof c.resize === 'function') c.resize(); } catch(e){} });
                    }
                });
            ui.annualReportBtn.addEventListener('click', () => openAnnualReport());
            ui.closeMonthlyReportBtn.addEventListener('click', () => closeModal('monthly-report-modal'));
            ui.closeAnnualReportBtn.addEventListener('click', () => closeModal('annual-report-modal'));
            ui.addGoalBtn.addEventListener('click', () => openGoalModal());
            ui.closeGoalModalBtn.addEventListener('click', () => closeModal('goal-modal'));
            ui.goalForm.addEventListener('submit', (e) => handleGoalFormSubmit(e));
            ui.searchDescription.addEventListener('input', (e) => {
                state.filters.searchTerm = e.target.value;
                renderExpenseTable();
            });

            // Expenses filter popover handlers
            if (ui.expensesFilterBtn && ui.expensesFilterPopover) {
                ui.expensesFilterBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // populate selects from settings
                    const payments = state.appData.settings.paymentMethods || [];
                    const paymentsSorted = sortStrings((payments || []).map(p => p.name || ''));
                    ui.filterPaymentMethod.innerHTML = '<option value="">Todos</option>' + paymentsSorted.map(n => `<option value="${n}">${n}</option>`).join('');
                    const cats = state.appData.settings.expenseCategories || [];
                    const catsSorted = sortStrings(cats);
                    ui.filterCategory.innerHTML = '<option value="">Todas</option>' + catsSorted.map(c => `<option value="${c}">${c}</option>`).join('');
                    // Pre-select current filters so the UI reflects programmatic filters
                    try {
                        const ef = state.filters.expenseFilters || {};
                        ui.filterPaymentMethod.value = ef.payment || '';
                        ui.filterSpendingType.value = ef.spendingType || '';
                        ui.filterCategory.value = ef.category || '';
                        ui.filterType.value = ef.type || '';
                        ui.filterRecurring.checked = !!ef.recurring;
                        ui.filterInstallment.checked = !!ef.installment;
                    } catch(e) { /* ignore */ }

                    // On small screens, show as mobile bottom-sheet using mobile-visible
                    if (window.innerWidth <= 639) {
                        ui.expensesFilterPopover.classList.remove('hidden');
                        ui.expensesFilterPopover.classList.add('mobile-visible');
                        ui.expensesFilterPopover.style.position = 'fixed';
                        ui.expensesFilterPopover.style.left = '0.6rem';
                        ui.expensesFilterPopover.style.right = '0.6rem';
                        ui.expensesFilterPopover.style.bottom = '4.5rem';
                        ui.expensesFilterPopover.style.top = 'auto';
                        ui.expensesFilterPopover.style.maxHeight = '40vh';
                        ui.expensesFilterPopover.style.overflow = 'auto';
                    } else {
                        // For desktop we temporarily move the popover to document.body so it won't cause scroll/layout shifts
                        try {
                            const rect = ui.expensesFilterBtn.getBoundingClientRect();
                            // Save original parent/next so we can restore later
                            if (!ui.expensesFilterPopover._origParent) {
                                ui.expensesFilterPopover._origParent = ui.expensesFilterPopover.parentNode;
                                ui.expensesFilterPopover._origNext = ui.expensesFilterPopover.nextSibling;
                            }
                            document.body.appendChild(ui.expensesFilterPopover);
                            ui.expensesFilterPopover.style.position = 'absolute';
                            ui.expensesFilterPopover.style.top = (rect.bottom + window.scrollY + 6) + 'px';
                            let left = (rect.left + window.scrollX - 160);
                            left = Math.max(8, Math.min(left, window.innerWidth - 280));
                            ui.expensesFilterPopover.style.left = left + 'px';
                            ui.expensesFilterPopover.style.right = '';
                            ui.expensesFilterPopover.classList.remove('hidden');
                            ui.expensesFilterPopover.classList.remove('mobile-visible');
                            ui.expensesFilterPopover.style.maxHeight = '';
                            ui.expensesFilterPopover.style.overflow = '';
                        } catch(e){ console.error('filter popover open error', e) }
                    }
                });

                // Close when clicking outside
                document.addEventListener('click', (ev) => {
                    if (!ui.expensesFilterPopover) return;
                    if (ui.expensesFilterPopover.classList.contains('hidden')) return;
                    if (ev.target === ui.expensesFilterBtn || ui.expensesFilterPopover.contains(ev.target)) return;
                    // hide and restore if detached
                    ui.expensesFilterPopover.classList.add('hidden');
                    ui.expensesFilterPopover.classList.remove('mobile-visible');
                    if (ui.expensesFilterPopover._origParent) {
                        try {
                            if (ui.expensesFilterPopover._origNext && ui.expensesFilterPopover._origNext.parentNode === ui.expensesFilterPopover._origParent) {
                                ui.expensesFilterPopover._origParent.insertBefore(ui.expensesFilterPopover, ui.expensesFilterPopover._origNext);
                            } else {
                                ui.expensesFilterPopover._origParent.appendChild(ui.expensesFilterPopover);
                            }
                        } catch(e) { console.error('restore popover error', e); }
                        ui.expensesFilterPopover._origParent = null; ui.expensesFilterPopover._origNext = null;
                    }
                });

                // Make expenses filter popover act as bottom-sheet on narrow screens
                function openExpensesFilterAsNeeded() {
                    try {
                        const rect = ui.expensesFilterBtn.getBoundingClientRect();
                        if (window.innerWidth <= 640) {
                            ui.expensesFilterPopover.classList.add('mobile-visible');
                            ui.expensesFilterPopover.classList.remove('hidden');
                        } else {
                            // existing positioning handled elsewhere
                        }
                    } catch(e) {}
                }

                // Update filter badge count
                function updateFilterBadge() {
                    try {
                        const badge = document.getElementById('expenses-filter-badge');
                        if (!badge) return;
                        const ef = state.filters.expenseFilters || {};
                        let count = 0;
                        if (ef.payment) count++;
                        if (ef.spendingType) count++;
                        if (ef.category) count++;
                        if (ef.type) count++;
                        if (ef.recurring) count++;
                        if (ef.installment) count++;
                        badge.textContent = String(count);
                        badge.style.display = count > 0 ? 'inline-flex' : 'none';
                    } catch(e) { }
                }

                // ensure badge is correct on load
                try { updateFilterBadge(); } catch(e) {}

                ui.filterApplyBtn.addEventListener('click', () => {
                    // Build filter object
                    state.filters.expenseFilters = state.filters.expenseFilters || {};
                    state.filters.expenseFilters.payment = ui.filterPaymentMethod.value || '';
                    state.filters.expenseFilters.spendingType = ui.filterSpendingType.value || '';
                    state.filters.expenseFilters.category = ui.filterCategory.value || '';
                    state.filters.expenseFilters.type = ui.filterType.value || '';
                    state.filters.expenseFilters.recurring = ui.filterRecurring.checked;
                    state.filters.expenseFilters.installment = ui.filterInstallment.checked;
                    ui.expensesFilterPopover.classList.add('hidden');
                    ui.expensesFilterPopover.classList.remove('mobile-visible');
                    if (ui.expensesFilterPopover._origParent) {
                        try {
                            if (ui.expensesFilterPopover._origNext && ui.expensesFilterPopover._origNext.parentNode === ui.expensesFilterPopover._origParent) {
                                ui.expensesFilterPopover._origParent.insertBefore(ui.expensesFilterPopover, ui.expensesFilterPopover._origNext);
                            } else {
                                ui.expensesFilterPopover._origParent.appendChild(ui.expensesFilterPopover);
                            }
                        } catch(e){}
                        ui.expensesFilterPopover._origParent = null; ui.expensesFilterPopover._origNext = null;
                    }
                    renderExpenseTable();
                    updateFilterBadge();
                });

                ui.filterClearBtn.addEventListener('click', () => {
                    ui.filterPaymentMethod.value = '';
                    ui.filterCategory.value = '';
                    ui.filterType.value = '';
                    ui.filterSpendingType.value = '';
                    ui.filterRecurring.checked = false;
                    ui.filterInstallment.checked = false;
                    state.filters.expenseFilters = {};
                    ui.expensesFilterPopover.classList.add('hidden');
                    ui.expensesFilterPopover.classList.remove('mobile-visible');
                    if (ui.expensesFilterPopover._origParent) {
                        try {
                            if (ui.expensesFilterPopover._origNext && ui.expensesFilterPopover._origNext.parentNode === ui.expensesFilterPopover._origParent) {
                                ui.expensesFilterPopover._origParent.insertBefore(ui.expensesFilterPopover, ui.expensesFilterPopover._origNext);
                            } else {
                                ui.expensesFilterPopover._origParent.appendChild(ui.expensesFilterPopover);
                            }
                        } catch(e){}
                        ui.expensesFilterPopover._origParent = null; ui.expensesFilterPopover._origNext = null;
                    }
                    renderExpenseTable();
                    updateFilterBadge();
                });
                // Preview future changes button (shows compact list of affected months/values)
                if (ui.previewFutureBtn) {
                    ui.previewFutureBtn.addEventListener('click', () => {
                        try {
                            const id = document.getElementById('transaction-id').value;
                            if (!id) return showToast('Abra uma transação existente para ver previsões.', 'bg-gray-600');
                            const type = ui.transactionTypeInput.value;
                            previewFutureChanges(id, type);
                        } catch(e) { console.error('previewFutureBtn click', e); }
                    });
                }
            }

            // Automação: se selecionar uma meta como categoria da reserva, preenche descrição automaticamente
            if (ui.categorySaving) {
                ui.categorySaving.addEventListener('change', function() {
                    const selected = this.value;
                    // Se for uma meta (exatamente igual ao nome de uma meta), preenche descrição
                    const goals = (state.appData.settings.goals || []).map(g => g.name);
                    // Se o valor selecionado for igual ao nome de uma meta, ou terminar com ' (Meta)', preenche
                    let metaName = null;
                    if (goals.includes(selected)) {
                        metaName = selected;
                    } else if (selected.endsWith(' (Meta)')) {
                        metaName = selected.replace(' (Meta)', '');
                    }
                    if (metaName) {
                        document.getElementById('description').value = metaName;
                    }
                });
            }
        }

        function handleExport() {
            if (!state.appData) {
                alert("Não há dados para exportar.");
                return;
            }

            // 1. Criar uma cópia profunda para não modificar o estado atual
            const appDataCopy = JSON.parse(JSON.stringify(state.appData));

            // 2. Transformar a estrutura de dados
            const transformedData = {};
            for (const year in appDataCopy.data) {
                if (Object.prototype.hasOwnProperty.call(appDataCopy.data, year)) {
                    for (const month in appDataCopy.data[year]) {
                        if (Object.prototype.hasOwnProperty.call(appDataCopy.data[year], month)) {
                            const newKey = `${year}-${month}`;
                            transformedData[newKey] = appDataCopy.data[year][month];
                        }
                    }
                }
            }
            appDataCopy.data = transformedData;

            // 3. Montar o objeto final para exportação
            const exportObject = {
                financeAppDB_v10: appDataCopy
            };

            // 4. Criar e baixar o arquivo JSON
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObject, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "import.json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            showToast("Dados exportados com sucesso!", 'bg-green-600');
        }

        function handleImport() {
            const fileInput = ui.importFileInput;
            const file = fileInput.files[0];
            if (!file) {
                return; // User cancelled file selection
            }

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const json = JSON.parse(event.target.result);
                    const dataToSave = json.financeAppDB_v10;

                    if (!dataToSave || !dataToSave.data) {
                        throw new Error('Estrutura do JSON inválida. Chave "financeAppDB_v10" ou "data" não encontrada.');
                    }

                    // Transform data structure from {"YYYY-MM":...} to {YYYY:{MM:...}}
                    const transformedData = {};
                    for (const key in dataToSave.data) {
                        if (Object.prototype.hasOwnProperty.call(dataToSave.data, key) && key.match(/^\d{4}-\d{2}$/)) {
                            const [year, month] = key.split('-');
                            if (!transformedData[year]) {
                                transformedData[year] = {};
                            }
                            transformedData[year][month] = dataToSave.data[key];
                        }
                    }
                    dataToSave.data = transformedData;

                    await storage.saveData(dataToSave);
                    alert('Dados importados com sucesso!');
                    location.reload();
                } catch (e) {
                    alert('Erro ao importar dados: ' + e.message);
                    console.error(e);
                } finally {
                    fileInput.value = ''; // Reset input
                }
            };
            reader.readAsText(file);
        }

        // --- RENDER FUNCTIONS ---

        function render() {
            // A verificação de `appData` no início da renderização é uma boa prática final.
            if (!state.appData) {
                console.error("Renderização abortada: state.appData não está disponível.");
                return;
            }
            propagateRecurringTransactions();
            renderMonthDisplay();
            
            switch (state.currentView) {
                case 'dashboard': renderDashboard(); break;
                case 'credit-cards': renderCreditCardView(); break;
                case 'investments': renderInvestmentsView(); break;
                case 'travel-planner': renderTravelPlannerView(); break;
            }
        }

        function changeView(view) {
            state.currentView = view;
            ['dashboard', 'credit-cards', 'investments', 'travel-planner'].forEach(v => {
                const el = document.getElementById(`${v}-view`);
                if (el) el.classList.toggle('hidden', view !== v);
                const tabBtn = document.querySelector(`.tab-button[data-view="${v}"]`);
                if (tabBtn) tabBtn.classList.toggle('tab-active', view === v);
            });
            const activeView = document.getElementById(`${view}-view`);
            activeView.classList.remove('animate-fade-in');
            void activeView.offsetWidth;
            activeView.classList.add('animate-fade-in');
            render();
        }

        function renderDashboard() {
            updateKPIs();
            renderAllTables();
            renderCharts();
        }

        function renderCreditCardView() {
            const container = ui.creditCardsContainer;
            container.innerHTML = '';
            const currentMonthData = getCurrentMonthData();
            const normalize = s => (s || '').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
            // Render real credit cards
            const creditCards = ((state.appData.settings.paymentMethods || []).filter(p => p.type === 'credit_card')).slice().sort((a,b) => {
                const A = (a && a.name || '').toLowerCase(); const B = (b && b.name || '').toLowerCase(); return A < B ? -1 : A > B ? 1 : 0;
            });
            // Default: start with all cards grouped unless explicitly set otherwise
            creditCards.forEach(c => { if (state.cardGrouped[c.name] === undefined) state.cardGrouped[c.name] = true; });
            creditCards.forEach(card => {
                let cardExpenses = (currentMonthData.expenses || []).filter(e => normalize((typeof getPaymentLabel === 'function' ? getPaymentLabel(e.payment || '') : (e.payment || ''))) === normalize(card.name || ''));
                // choose sort mode per-card: default alphabetical
                ui.cardSorts = ui.cardSorts || {};
                const sortMode = ui.cardSorts[card.name] || 'alf';
                // If grouped display is active for this card, defer ordering to populateCardExpenses
                if (!state.cardGrouped[card.name]) {
                    if (sortMode === 'alf') {
                        cardExpenses = cardExpenses.slice().sort((a,b) => { const A=(a.description||'').toLowerCase(); const B=(b.description||'').toLowerCase(); return A < B ? -1 : A > B ? 1 : 0; });
                    } else if (sortMode === 'value-desc') {
                        cardExpenses = cardExpenses.slice().sort((a,b) => (Number(b.amount)||0) - (Number(a.amount)||0));
                    } else if (sortMode === 'value-asc') {
                        cardExpenses = cardExpenses.slice().sort((a,b) => (Number(a.amount)||0) - (Number(b.amount)||0));
                    }
                }
                const totalBeforeAnticipation = cardExpenses.reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);
                // anticipation value (amount paid/anticipated to bank) stored per-month under cardAnticipations
                const y = String(state.currentDate.getFullYear()); const m = String(String(state.currentDate.getMonth()+1).padStart(2,'0'));
                if (!state.appData.data[y]) state.appData.data[y] = {};
                if (!state.appData.data[y][m]) state.appData.data[y][m] = { incomes: [], expenses: [], savings: [] };
                const cardAnticipations = state.appData.data[y][m].cardAnticipations || {};
                const anticipated = Number(cardAnticipations[card.name] || 0);
                const invoiceTotal = Math.round(((totalBeforeAnticipation - anticipated) + Number.EPSILON) * 100) / 100;
                const dueDate = new Date(state.currentDate);
                if (card.dueDay < 15) dueDate.setMonth(dueDate.getMonth() + 1);
                dueDate.setDate(card.dueDay || 1);
                container.innerHTML += `
                    <div class="card p-6 rounded-2xl shadow-sm flex flex-col" data-card-root="${card.name}">
                        <div class="flex-grow">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-3">
                                    <h3 class="text-xl font-semibold card-title-sortable cursor-pointer" data-card-name="${card.name}">${card.name}</h3>
                                    <div class="flex items-center text-sm text-gray-500" style="gap:6px;">
                                        <button class="card-sort-arrow" data-card-name="${card.name}" data-sort="value-desc" title="Ordenar por valor desc">▲</button>
                                        <button class="card-sort-arrow" data-card-name="${card.name}" data-sort="value-asc" title="Ordenar por valor asc">▼</button>
                                        <button class="card-group-toggle p-1 ml-1" data-card-name="${card.name}" title="Agrupar/Desagrupar"><span class="material-symbols-outlined">${state.cardGrouped[card.name] ? 'vertical_split' : 'merge_type'}</span></button>
                                    </div>
                                </div>
                                <span class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Venc. ${dueDate.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'})}</span>
                            </div>
                            <p class="text-3xl font-bold text-blue-600 mb-1">${formatCurrency(invoiceTotal)}</p>
                            <!-- small icon row under badges: due, anticipated, purchases -->
                            <div class="flex items-center gap-4 text-sm text-gray-500 mt-1 mb-2">
                                <div class="flex items-center gap-1"><span class="material-symbols-outlined" style="font-size:16px">calendar_today</span><span>Venc.</span></div>
                                <div class="flex items-center gap-1"><span class="material-symbols-outlined" style="font-size:16px">paid</span><span>Créd.</span></div>
                                <div class="flex items-center gap-1"><span class="material-symbols-outlined" style="font-size:16px">shopping_cart</span><span>${cardExpenses.length} compras</span></div>
                            </div>
                            <p class="text-sm text-green-600 mb-1">- <span class="anticipation-amount cursor-pointer" data-card-name="${card.name}">${formatCurrency(anticipated)}</span> antecipado</p>
                            <div class="space-y-1 max-h-48 overflow-y-auto pr-2 card-items-list" data-card-name="${card.name}"></div>
                        </div>
                        <div class="mt-6">
                            <div class="flex w-full items-center" style="gap:8px;">
                                ${(() => {
                                    const allPaid = cardExpenses.length > 0 && cardExpenses.every(e => e.isPaid);
                                    const btnText = allPaid ? 'Reaver Fatura' : 'Pagar Fatura';
                                    const btnClass = allPaid ? 'bg-gray-200 text-gray-800 hover:bg-gray-300' : 'bg-green-500 text-white hover:bg-green-600';
                                    return `<button data-card-name="${card.name}" class="pay-invoice-btn flex-grow ${btnClass} font-semibold py-2 px-4 rounded-lg transition-colors">${btnText}</button>`;
                                })()}
                                <button data-card-name="${card.name}" title="Adicionar despesa neste cartão" class="add-card-expense-btn flex-shrink-0 w-12 bg-blue-500 text-white font-semibold py-2 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center"> <span class="material-symbols-outlined" style="font-size:20px; line-height:1;">add</span></button>
                            </div>
                        </div>
                    </div>`;
                // After inserting the card HTML, populate the card items area (grouped or normal depending on state)
                try {
                    populateCardExpenses(card.name, cardExpenses);
                } catch(e) { console.error('populateCardExpenses error', e); }
            });

                // --- Render non-credit payment-method cards (e.g., Debito, Dinheiro, PIX, Transferência, Boleto, Apple Pay, Outro)
                try {
                    const currentMonthData = getCurrentMonthData();
                    const paymentsSettings = (state.appData.settings.paymentMethods || []);
                    // normalization helper to compare stored expense.payment with configured names
                    const normalize = s => (s || '').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
                    const nonCardPayments = (paymentsSettings || []).filter(p => ((p && p.type) || '').toString() !== 'credit_card');
                    nonCardPayments.forEach(pm => {
                        const pmName = (typeof getPaymentLabel === 'function') ? getPaymentLabel(pm) : ((typeof pm === 'string') ? pm : (pm.name || pm.label || pm.value || ''));
                        if (!pmName) return;
                        const pmNorm = normalize(pmName);
                        const pmExpenses = (currentMonthData.expenses || []).filter(e => normalize((typeof getPaymentLabel === 'function' ? getPaymentLabel(e.payment || '') : (e.payment || ''))) === pmNorm);
                        if (!pmExpenses || pmExpenses.length === 0) return; // only show if there's at least one expense with this payment
                        const totalPM = pmExpenses.reduce((s, e) => s + (Number(e && e.amount) || 0), 0);
                        container.innerHTML += `
                            <div class="card p-6 rounded-2xl shadow-sm flex flex-col" data-payment-method="${pmName}">
                                <div class="flex-grow">
                                    <div class="flex justify-between items-start mb-2">
                                        <h3 class="text-xl font-semibold">${pmName}</h3>
                                        <span class="text-xs font-medium bg-gray-100 text-gray-800 px-2 py-1 rounded-full">${pmExpenses.length} compras</span>
                                    </div>
                                    <p class="text-3xl font-bold text-gray-800 mb-1">${formatCurrency(totalPM)}</p>
                                    <div class="mt-3 text-sm text-gray-600">
                                        <div class="space-y-1 mt-2">
                                            ${pmExpenses.slice(0,8).map(u => `<div class="flex justify-between items-center text-sm"><div class="flex items-center"><span class="truncate pr-2">${(u.description||'Despesa')}</span></div><div class="flex items-center"><span class="font-medium mr-2">${formatCurrency(Number(u.amount)||0)}</span></div></div>`).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <div class="flex w-full items-center" style="gap:8px;">
                                        <button data-payment="${pmName}" class="view-payment-expenses-btn flex-grow bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg">Ver Despesas</button>
                                        <button data-payment="${pmName}" class="add-payment-expense-btn flex-shrink-0 w-12 bg-green-500 text-white font-semibold py-2 rounded-lg flex items-center justify-center"> <span class="material-symbols-outlined" style="font-size:20px; line-height:1;">add</span></button>
                                    </div>
                                </div>
                            </div>`;
                    });

                    // Attach handlers for the payment-method cards (same as previous behavior)
                    container.querySelectorAll('.view-payment-expenses-btn').forEach(btn => btn.addEventListener('click', (e) => {
                        const p = e.currentTarget.dataset.payment || e.target.dataset.payment;
                        state.filters.expenseFilters = state.filters.expenseFilters || {};
                        state.filters.expenseFilters.payment = p || '';
                        changeView('dashboard');
                        try { updateFilterBadge(); } catch(e){}
                        try { renderExpenseTable(); } catch(e){}
                    }));

                    container.querySelectorAll('.add-payment-expense-btn').forEach(btn => btn.addEventListener('click', (e) => {
                        const p = e.currentTarget.dataset.payment || e.target.dataset.payment;
                        const prefill = { payment: p, focusDescription: true };
                        try { if (ui.lastTransactionDefaults && ui.lastTransactionDefaults.category) prefill.category = ui.lastTransactionDefaults.category; } catch(e){}
                        openModal('expenses', null, prefill);
                    }));
                } catch (pmErr) { console.error('render non-credit payment-method cards error', pmErr); }

                // If there's VR ledger balance or VR activity, render VR as a card-like payment instrument
                const vrAmount = getMonthVRBalance(currentMonthData);
            // Show VR card if there's any VR ledger entry or usage for the month,
            // even if the current available balance (credited - used) is zero.
            const hasLedger = Array.isArray(currentMonthData.vrLedger) && currentMonthData.vrLedger.length > 0;
            const hasUsage = Array.isArray(currentMonthData.vrUsage) && currentMonthData.vrUsage.length > 0;
            if (vrAmount > 0 || hasLedger || hasUsage) {
                // Derive totals: credited (sum of vrLedger) and usage (sum of vrUsage)
                // Ensure numeric conversion for safety (some entries may be strings)
                const creditedTotal = (currentMonthData.vrLedger || []).reduce((s, l) => s + (Number(l && l.amount) || 0), 0);
                // Compute usage from vrUsage ledger entries
                let usageTotal = (currentMonthData.vrUsage || []).reduce((s, u) => s + (Number(u && u.amount) || 0), 0);
                // Also include any expenses in the same month that were paid via VR but not recorded in vrUsage (migration edge-cases)
                try {
                    const expensesVR = (currentMonthData.expenses || []).filter(e => paymentMatches(e.payment || '', 'VR'));
                    const expensesVRSum = expensesVR.reduce((s, e) => s + (Number(e && e.amount) || 0), 0);
                    if (expensesVRSum > 0) usageTotal = Math.round((usageTotal + expensesVRSum) * 100) / 100;
                } catch (e) { console.error('compute expenses vr usage', e); }
                // If there are no vrUsage entries and no VR expenses but usageTotal is still > 0, this indicates a data/parsing anomaly.
                if ((!Array.isArray(currentMonthData.vrUsage) || currentMonthData.vrUsage.length === 0) && (!Array.isArray(currentMonthData.expenses) || !(currentMonthData.expenses || []).some(ex => (ex.payment || '') === 'VR')) && usageTotal > 0) {
                    console.warn('[VR WARNING] usageTotal > 0 but no vrUsage or VR expenses found. Forcing usageTotal=0. Details:', { usageTotal, vrLedger: currentMonthData.vrLedger, vrUsage: currentMonthData.vrUsage, expenses: currentMonthData.expenses });
                    usageTotal = 0;
                }
                // Debug: log ledger and usage arrays when displayAmount is zero despite credited > 0
                try { /* VR debug disabled in cleanup pass */ } catch(e) {}
                // displayAmount is credited minus expenses already charged to VR
                const displayAmount = Math.max(0, Math.round((creditedTotal - usageTotal) * 100) / 100);
                // Derive a friendly limit from latest vrLedger salaryMeta if available (kept for auxiliary info)
                let vrLimit = vrAmount;
                try {
                    const latestLedger = (currentMonthData.vrLedger || []).slice().reverse().find(l => l && l.salaryMeta);
                    if (latestLedger && latestLedger.salaryMeta && latestLedger.salaryMeta.valorDesjejumDia) {
                        // compute monthly desjejum limit as desjejumDia * diasUteis
                        const desjejumDia = Number(latestLedger.salaryMeta.valorDesjejumDia) || 0;
                        const y = state.currentDate.getFullYear();
                        const m = state.currentDate.getMonth() + 1;
                        const dias = typeof diasUteisNoMes === 'function' ? diasUteisNoMes(y, m) : 22;
                        vrLimit = Math.max(vrAmount, desjejumDia * dias);
                    }
                } catch(e) { console.error('derive vr limit', e); }

                // compute last day of the PREVIOUS month relative to the currently displayed month
                // e.g. if viewing Outubro, show last day of Setembro (30/09)
                const displayYear = state.currentDate.getFullYear();
                // Use JS Date trick: day 0 of the displayed month -> last day of previous month
                const prevMonthLastDate = new Date(displayYear, state.currentDate.getMonth(), 0);
                const lastDay = prevMonthLastDate.getDate();
                const prevMonthNumber = prevMonthLastDate.getMonth() + 1; // 1-12
                const lastDayStr = String(lastDay).padStart(2,'0') + '/' + String(prevMonthNumber).padStart(2,'0');

                container.innerHTML += `
                    <div class="card p-6 rounded-2xl shadow-sm flex flex-col bg-gradient-to-br from-green-50 to-white border border-green-200">
                        <div class="flex-grow">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-semibold">VR</h3>
                                <!-- Badge shows: Créd. + Último dia do mês exibido (dd/MM) -->
                                <span class="text-xs font-medium bg-green-100 text-green-800 px-2 py-1 rounded-full">Créd. ${lastDayStr}</span>
                            </div>
                            <div class="vr-value-group" title="Usado: ${formatCurrency(usageTotal)}" style="position:relative; display:inline-block;">
                                <p class="text-3xl font-bold text-green-600 mb-4" style="margin:0;">${formatCurrency(displayAmount)}</p>
                                <p class="text-sm text-gray-500 vr-used" style="margin:0; opacity:0; transition: opacity 160ms ease;">Usado: ${formatCurrency(usageTotal)}</p>
                            </div>
                            <div class="mt-3 text-sm text-gray-600">
                                <h4 class="font-semibold text-sm text-gray-700 flex items-center gap-2">
                                    <span>Compras</span>
                                    <button id="add-vr-usage-btn" type="button" class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-white border border-gray-200 text-gray-700 hover:bg-gray-50" title="Adicionar compra VR">
                                        <span class="material-symbols-outlined" style="font-size:18px;">add</span>
                                    </button>
                                </h4>
                                ${(currentMonthData.vrUsage && currentMonthData.vrUsage.length > 0) ? (() => {
                                    const usagesSorted = (currentMonthData.vrUsage || []).slice().sort((a,b) => { const A=(a.description||'').toLowerCase(); const B=(b.description||'').toLowerCase(); return A < B ? -1 : A > B ? 1 : 0; });
                                    return `<div class="space-y-1 mt-2">${usagesSorted.map(u => `<div class="flex justify-between items-center text-sm"><div class="flex items-center"><span class="truncate pr-2 cursor-pointer edit-vr-usage-trigger" data-vr-usage-edit-id="${u.id}">${u.description || 'Despesa VR'}</span></div><div class="flex items-center"><span class="font-medium mr-2">${formatCurrency(Number(u.amount)||0)}</span><button data-vr-usage-edit-id="${u.id}" class="ml-1 text-gray-600 edit-vr-usage-btn" title="Editar"><span class="material-symbols-outlined">edit</span></button><button data-vr-usage-id="${u.id}" class="ml-3 text-red-600 delete-vr-usage-btn" title="Excluir"><span class="material-symbols-outlined">delete</span></button></div></div>`).join('')}</div>`;
                                })() : '<div class="text-sm text-gray-500 mt-1">Nenhuma compra registrada.</div>'}
                            </div>
                        </div>
                                <!-- Gerenciar VR button removed per UX: VR works as débito somente -->
                    </div>`;
            }
                    // VT: mirror VR card rendering if there is VT activity
                    const vtAmount = getMonthVTBalance(currentMonthData);
                    const hasVtLedger = Array.isArray(currentMonthData.vtLedger) && currentMonthData.vtLedger.length > 0;
                    const hasVtUsage = Array.isArray(currentMonthData.vtUsage) && currentMonthData.vtUsage.length > 0;
                    if (vtAmount > 0 || hasVtLedger || hasVtUsage) {
                        const vtCreditedTotal = (currentMonthData.vtLedger || []).reduce((s, l) => s + (Number(l && l.amount) || 0), 0);
                        let vtUsageTotal = (currentMonthData.vtUsage || []).reduce((s, u) => s + (Number(u && u.amount) || 0), 0);
                        try {
                            const expensesVT = (currentMonthData.expenses || []).filter(e => paymentMatches(e.payment || '', 'VT'));
                            const expensesVTSum = expensesVT.reduce((s, e) => s + (Number(e && e.amount) || 0), 0);
                            if (expensesVTSum > 0) vtUsageTotal = Math.round((vtUsageTotal + expensesVTSum) * 100) / 100;
                        } catch (e) { console.error('compute expenses vt usage', e); }
                        if ((!Array.isArray(currentMonthData.vtUsage) || currentMonthData.vtUsage.length === 0) && (!Array.isArray(currentMonthData.expenses) || !(currentMonthData.expenses || []).some(ex => (ex.payment || '') === 'VT')) && vtUsageTotal > 0) {
                            console.warn('[VT WARNING] usageTotal > 0 but no vtUsage or VT expenses found. Forcing vtUsageTotal=0.');
                            vtUsageTotal = 0;
                        }
                        const vtDisplayAmount = Math.max(0, Math.round((vtCreditedTotal - vtUsageTotal) * 100) / 100);
                        const latestVtLedger = (currentMonthData.vtLedger || []).slice().reverse().find(l => l && l.salaryMeta);
                        // For VT, display the 5th business day of the currently viewed month (not the previous month)
                        const vtYear = state.currentDate.getFullYear();
                        const vtMonthIndex = state.currentDate.getMonth(); // 0-based
                        const daysInMonth = new Date(vtYear, vtMonthIndex + 1, 0).getDate();
                        let businessCount = 0;
                        let vtDay = 1;
                        for (; vtDay <= daysInMonth; vtDay++) {
                            const d = new Date(vtYear, vtMonthIndex, vtDay);
                            const wd = d.getDay(); // 0 = Sun, 6 = Sat
                            if (wd !== 0 && wd !== 6) businessCount++;
                            if (businessCount >= 5) break;
                        }
                        // If month has fewer than 5 business days (very unlikely), vtDay will be last available business day
                        const lastDayVT = vtDay;
                        const prevMonthNumberVT = vtMonthIndex + 1; // display month number for the viewed month
                        const lastDayStrVT = String(lastDayVT).padStart(2,'0') + '/' + String(prevMonthNumberVT).padStart(2,'0');

                        container.innerHTML += `
                            <div class="card p-6 rounded-2xl shadow-sm flex flex-col bg-gradient-to-br from-yellow-50 to-white border border-yellow-200">
                                <div class="flex-grow">
                                    <div class="flex justify-between items-start mb-2">
                                        <h3 class="text-xl font-semibold">VT</h3>
                                        <span class="text-xs font-medium bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">Créd. ${lastDayStrVT}</span>
                                    </div>
                                    <div class="vr-value-group" title="Usado: ${formatCurrency(vtUsageTotal)}" style="position:relative; display:inline-block;">
                                        <p class="text-3xl font-bold text-yellow-600 mb-4" style="margin:0;">${formatCurrency(vtDisplayAmount)}</p>
                                        <p class="text-sm text-gray-500 vr-used" style="margin:0; opacity:0; transition: opacity 160ms ease;">Usado: ${formatCurrency(vtUsageTotal)}</p>
                                    </div>
                                    <div class="mt-3 text-sm text-gray-600">
                                        <h4 class="font-semibold text-sm text-gray-700 flex items-center gap-2">
                                            <span>Compras</span>
                                                <button id="open-vt-history-btn" type="button" class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 mr-1" title="Abrir histórico VT">
                                                    <span class="material-symbols-outlined" style="font-size:18px;">history</span>
                                                </button>
                                                <button id="add-vt-usage-btn" type="button" class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-white border border-gray-200 text-gray-700 hover:bg-gray-50" title="Adicionar compra VT">
                                                    <span class="material-symbols-outlined" style="font-size:18px;">add</span>
                                                </button>
                                        </h4>
                                        ${(currentMonthData.vtUsage && currentMonthData.vtUsage.length > 0) ? (() => {
                                            const usagesSorted = (currentMonthData.vtUsage || []).slice().sort((a,b) => { const A=(a.description||'').toLowerCase(); const B=(b.description||'').toLowerCase(); return A < B ? -1 : A > B ? 1 : 0; });
                                            return `<div class="space-y-1 mt-2">${usagesSorted.map(u => `<div class="flex justify-between items-center text-sm"><div class="flex items-center"><span class="truncate pr-2 cursor-pointer edit-vt-usage-trigger" data-vt-usage-edit-id="${u.id}">${u.description || 'Despesa VT'}</span></div><div class="flex items-center"><span class="font-medium mr-2">${formatCurrency(Number(u.amount)||0)}</span><button data-vt-usage-edit-id="${u.id}" class="ml-1 text-gray-600 edit-vt-usage-btn" title="Editar"><span class="material-symbols-outlined">edit</span></button><button data-vt-usage-id="${u.id}" class="ml-3 text-red-600 delete-vt-usage-btn" title="Excluir"><span class="material-symbols-outlined">delete</span></button></div></div>`).join('')}</div>`;
                                        })() : '<div class="text-sm text-gray-500 mt-1">Nenhuma compra registrada.</div>'}
                                    </div>
                                </div>
                            </div>`;
                    }
            // Attach handler to add VR usage from the VR card (open transaction modal with payment=VR)
                try {
                    const addVrBtn = container.querySelector('#add-vr-usage-btn');
                    if (addVrBtn) addVrBtn.addEventListener('click', (ev) => {
                        // Open transaction modal for expense and deterministically prefill payment=VR and focus description
                        openModal('expenses', null, { payment: 'VR', focusDescription: true });
                    });
                } catch(e) { console.error('attach add-vr-usage handler', e); }
            container.querySelectorAll('.pay-invoice-btn').forEach(btn => btn.addEventListener('click', (e) => payCardInvoice(e.target.dataset.cardName)));
            // Attach '+' handlers: open transaction modal prefilled with card payment and last used category (if any)
            container.querySelectorAll('.add-card-expense-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const cardName = e.currentTarget.dataset.cardName || e.target.dataset.cardName;
                const prefill = { payment: cardName, focusDescription: true };
                try {
                    if (ui.lastTransactionDefaults && ui.lastTransactionDefaults.category) prefill.category = ui.lastTransactionDefaults.category;
                } catch(e) { /* ignore */ }
                showToast(`Criando despesa para ${cardName}...`, 'bg-blue-600');
                openModal('expenses', null, prefill);
            }));
            // attach handlers for editing anticipation amounts
            container.querySelectorAll('.edit-anticipation-btn').forEach(btn => btn.addEventListener('click', (ev) => {
                ev.stopPropagation();
                const cardName = ev.currentTarget.dataset.cardName || ev.target.dataset.cardName;
                const y = String(state.currentDate.getFullYear()); const m = String(String(state.currentDate.getMonth()+1).padStart(2,'0'));
                if (!state.appData.data[y]) state.appData.data[y] = {};
                if (!state.appData.data[y][m]) state.appData.data[y][m] = { incomes: [], expenses: [], savings: [] };
                const md = state.appData.data[y][m];
                md.cardAnticipations = md.cardAnticipations || {};
                const currentVal = Number(md.cardAnticipations[cardName] || 0);
                const input = prompt(`Valor antecipado para ${cardName} (R$):`, currentVal || '0');
                if (input === null) return; // cancelled
                const v = parseFloat(String(input).replace(',', '.')) || 0;
                if (v <= 0) delete md.cardAnticipations[cardName]; else md.cardAnticipations[cardName] = Math.round((v + Number.EPSILON) * 100) / 100;
                try { storage.saveData(state.appData); showToast('Valor antecipado atualizado.', 'bg-green-600'); } catch(e) { console.error('save anticipation', e); showToast('Falha ao salvar antecipação.', 'bg-red-600'); }
                render();
            }));
            // Attach per-item delete and edit buttons for VR usages
                try {
                    container.querySelectorAll('.delete-vr-usage-btn').forEach(btn => btn.addEventListener('click', async (ev) => {
                    const id = ev.currentTarget.getAttribute('data-vr-usage-id');
                    if (!id) return;
                    try { const ok = await confirmAsync('Excluir este uso de VR?', 'Confirmar exclusão'); if (!ok) return; } catch(e){ return; }
                    const md = getCurrentMonthData();
                    if (!Array.isArray(md.vrUsage)) md.vrUsage = [];
                    const idx = md.vrUsage.findIndex(u => u.id === id);
                    if (idx > -1) md.vrUsage.splice(idx, 1);
                    try { await storage.saveData(state.appData); showToast('Uso de VR excluído.', 'bg-green-600'); } catch(e) { console.error('delete vr usage save', e); showToast('Falha ao salvar exclusão.', 'bg-red-600'); }
                    render();
                }));
                // VT handlers: add, edit, delete
                    try {
                        const addVtBtn = container.querySelector('#add-vt-usage-btn');
                        const openVtHistBtn = container.querySelector('#open-vt-history-btn');
                        if (openVtHistBtn) openVtHistBtn.addEventListener('click', (ev) => {
                            // Prefer the dedicated VT history/modal when available. If not available or it errors,
                            // show a friendly toast instead of opening the generic transaction modal unexpectedly.
                            if (typeof window.openVtFuelHistory === 'function') {
                                try { window.openVtFuelHistory(); return; } catch(e) { console.error('openVtFuelHistory failed', e); }
                            }
                            if (typeof window.openVtFuelModal === 'function') {
                                try { window.openVtFuelModal(null); return; } catch(e) { console.error('openVtFuelModal failed', e); }
                            }
                            showToast('Modal de VT indisponível no momento.', 'bg-yellow-600');
                        });
                        if (addVtBtn) addVtBtn.addEventListener('click', (ev) => {
                            // Open the dedicated VT fuel modal when available. If it's missing or errors, show a toast instead
                            if (typeof window.openVtFuelModal === 'function') {
                                try { window.openVtFuelModal(null); return; } catch(e) { console.error('openVtFuelModal failed', e); }
                            }
                            showToast('Modal de VT indisponível no momento.', 'bg-yellow-600');
                        });
                        container.querySelectorAll('.delete-vt-usage-btn').forEach(btn => btn.addEventListener('click', async (ev) => {
                        const id = ev.currentTarget.getAttribute('data-vt-usage-id');
                        if (!id) return;
                        try { const ok = await confirmAsync('Excluir este uso de VT?', 'Confirmar exclusão'); if (!ok) return; } catch(e) { return; }
                        const md = getCurrentMonthData();
                        if (!Array.isArray(md.vtUsage)) md.vtUsage = [];
                        const idx = md.vtUsage.findIndex(u => u.id === id);
                        if (idx > -1) md.vtUsage.splice(idx, 1);
                        try { await storage.saveData(state.appData); showToast('Uso de VT excluído.', 'bg-green-600'); } catch(e) { console.error('delete vt usage save', e); showToast('Falha ao salvar exclusão.', 'bg-red-600'); }
                        render();
                    }));
                    container.querySelectorAll('.edit-vt-usage-btn, .edit-vt-usage-trigger').forEach(el => el.addEventListener('click', (ev) => {
                        const id = ev.currentTarget.getAttribute('data-vt-usage-edit-id') || ev.currentTarget.closest('[data-vt-usage-edit-id]')?.getAttribute('data-vt-usage-edit-id');
                        if (!id) return;
                        openVTUsageEdit(id);
                    }));
                } catch(e) { console.error('attach vt usage item handlers', e); }
                // Edit triggers (icon and description clickable)
                container.querySelectorAll('.edit-vr-usage-btn, .edit-vr-usage-trigger').forEach(el => el.addEventListener('click', (ev) => {
                    const id = ev.currentTarget.getAttribute('data-vr-usage-edit-id') || ev.currentTarget.closest('[data-vr-usage-edit-id]')?.getAttribute('data-vr-usage-edit-id');
                    if (!id) return;
                    openVRUsageEdit(id);
                }));
            } catch(e) { console.error('attach vr usage item handlers', e); }
                // VR inline-edit bindings on card amounts
            try {
                container.querySelectorAll('.vr-amount').forEach(el => el.addEventListener('click', (e) => (typeof startInlineVREdit === 'function') ? startInlineVREdit(e.currentTarget, e.currentTarget.dataset.vrId) : null));
            } catch(e) { /* ignore if nothing to bind */ }

                // Clicking the amount opens the transaction modal for editing (centralized flow)
            try {
                container.querySelectorAll('.card-exp-amount').forEach(span => span.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    const expId = span.dataset.expId;
                    if (!expId) return;
                    openModal('expenses', expId);
                }));
            } catch(e) { console.error('attach card-exp-amount handlers', e); }

            // Attach handlers to last-installment spans inside card lists
            container.querySelectorAll('.last-installment-btn').forEach(el => el.addEventListener('click', (ev) => {
                const financingId = el.dataset.financingId || null;
                const installmentId = el.dataset.installmentId || null;
                goToLastInstallment({ financingId, installmentId });
            }));

            // Attach handlers for card sort via title click (toggle alphabetical) and arrow buttons (value asc/desc)
            container.querySelectorAll('.card-title-sortable').forEach(el => el.addEventListener('click', (ev) => {
                const cardName = ev.currentTarget.dataset.cardName;
                ui.cardSorts = ui.cardSorts || {};
                // toggle between alphabetical and value-desc when clicking title
                const current = ui.cardSorts[cardName] || 'alf';
                ui.cardSorts[cardName] = current === 'alf' ? 'value-desc' : 'alf';
                renderCreditCardView();
            }));
            container.querySelectorAll('.card-sort-arrow').forEach(btn => btn.addEventListener('click', (ev) => {
                ev.stopPropagation();
                const cardName = ev.currentTarget.dataset.cardName;
                const sort = ev.currentTarget.dataset.sort;
                ui.cardSorts = ui.cardSorts || {};
                ui.cardSorts[cardName] = sort;
                renderCreditCardView();
            }));
            // attach handlers for editing anticipation amounts by clicking the amount
            container.querySelectorAll('.anticipation-amount').forEach(el => el.addEventListener('click', (ev) => {
                ev.stopPropagation();
                const cardName = ev.currentTarget.dataset.cardName || ev.target.dataset.cardName;
                const y = String(state.currentDate.getFullYear()); const m = String(String(state.currentDate.getMonth()+1).padStart(2,'0'));
                if (!state.appData.data[y]) state.appData.data[y] = {};
                if (!state.appData.data[y][m]) state.appData.data[y][m] = { incomes: [], expenses: [], savings: [] };
                const md = state.appData.data[y][m];
                md.cardAnticipations = md.cardAnticipations || {};
                const currentVal = Number(md.cardAnticipations[cardName] || 0);
                const input = prompt(`Valor antecipado para ${cardName} (R$):`, currentVal || '0');
                if (input === null) return; // cancelled
                const v = parseFloat(String(input).replace(',', '.')) || 0;
                if (v <= 0) delete md.cardAnticipations[cardName]; else md.cardAnticipations[cardName] = Math.round((v + Number.EPSILON) * 100) / 100;
                try { storage.saveData(state.appData); showToast('Valor antecipado atualizado.', 'bg-green-600'); } catch(e) { console.error('save anticipation', e); showToast('Falha ao salvar antecipação.', 'bg-red-600'); }
                render();
            }));

            // attach handlers for collapsing/expanding grouped expense headers
            container.querySelectorAll('.group-header').forEach(h => h.addEventListener('click', (ev) => {
                const cardName = h.dataset.cardName;
                const desc = decodeURIComponent(h.dataset.descEnc || '');
                ui.cardGroups = ui.cardGroups || {};
                ui.cardGroups[cardName] = ui.cardGroups[cardName] || {};
                const current = ui.cardGroups[cardName][desc] || false;
                ui.cardGroups[cardName][desc] = !current;
                // simple DOM toggle for smoother UX (don't rerender entire view)
                const root = h.closest('.expense-group');
                if (root) {
                    const items = root.querySelector('.group-items');
                    const caret = root.querySelector('.group-caret');
                    if (items) items.classList.toggle('hidden');
                    if (caret) caret.textContent = (!current) ? '▸' : '▾';
                }
            }));

            // Show edit icon and remaining total on hover for card expense descriptions
            try {
                container.querySelectorAll('.desc-wrap').forEach(wrap => {
                    wrap.addEventListener('mouseenter', (ev) => {
                        const btn = wrap.querySelector('.edit-cat-btn');
                        const rem = wrap.querySelector('.remaining-total');
                        if (btn) btn.classList.remove('invisible');
                        if (rem) rem.classList.remove('hidden');
                    });
                    wrap.addEventListener('mouseleave', (ev) => {
                        const btn = wrap.querySelector('.edit-cat-btn');
                        const rem = wrap.querySelector('.remaining-total');
                        if (btn) btn.classList.add('invisible');
                        if (rem) rem.classList.add('hidden');
                    });
                });

                // Open transaction modal when clicking pencil: centralized editing flow
                container.querySelectorAll('.edit-cat-btn').forEach(btn => btn.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    const expId = btn.dataset.expId;
                    if (!expId) return;
                    // Reuse the main transaction modal to edit this expense
                    openModal('expenses', expId);
                }));
            } catch(e) { console.error('attach card desc hover/edit handlers', e); }
        }

        // Helper: populate the expenses area for a credit-card card either grouped or as full list
        function populateCardExpenses(cardName, cardExpenses) {
            try {
                const root = document.querySelector(`#credit-cards-container [data-card-root="${cardName}"]`);
                if (!root) return;
                const listEl = root.querySelector(`.card-items-list[data-card-name="${cardName}"]`);
                if (!listEl) return;
                listEl.innerHTML = '';
                // Build groups by description
                const groups = {};
                cardExpenses.forEach(exp => {
                    const key = (exp.description || '').trim() || (exp.category || 'Sem descrição');
                    groups[key] = groups[key] || [];
                    groups[key].push(exp);
                });
                const groupedKeys = [];
                const singleExpenses = [];
                Object.keys(groups).forEach(k => {
                    if (groups[k].length > 1) groupedKeys.push(k);
                    else singleExpenses.push(groups[k][0]);
                });

                const isGrouped = !!state.cardGrouped[cardName];
                // Update header toggle icon
                try {
                    const btn = root.querySelector('.card-group-toggle .material-symbols-outlined');
                    if (btn) btn.textContent = isGrouped ? 'vertical_split' : 'merge_type';
                } catch(e){}

                if (isGrouped) {
                    // Render group summaries
                    if (groupedKeys.length === 0) {
                        // No groups to aggregate; show a small message and render singles
                        listEl.innerHTML = '<p class="text-sm text-gray-500">Nenhum grupo com mais de 1 lançamento.</p>';
                    } else {
                        // Sort groups according to current sort settings:
                        // - for cards: ui.cardSorts[cardName] can be 'alf', 'value-desc', 'value-asc'
                        // - for safety fallback to alphabetical
                        try {
                            const cardSortMode = (ui.cardSorts && ui.cardSorts[cardName]) || 'alf';
                            if (cardSortMode === 'alf') groupedKeys.sort((a,b) => a.localeCompare(b));
                            else if (cardSortMode === 'value-desc') groupedKeys.sort((a,b) => {
                                const sa = groups[a].reduce((s,i) => s + (Number(i.amount)||0), 0);
                                const sb = groups[b].reduce((s,i) => s + (Number(i.amount)||0), 0);
                                return sb - sa;
                            });
                            else if (cardSortMode === 'value-asc') groupedKeys.sort((a,b) => {
                                const sa = groups[a].reduce((s,i) => s + (Number(i.amount)||0), 0);
                                const sb = groups[b].reduce((s,i) => s + (Number(i.amount)||0), 0);
                                return sa - sb;
                            });
                        } catch(e) {
                            groupedKeys.sort((a,b) => a.localeCompare(b));
                        }
                        // Build unified list and render interleaved compact rows
                        const unified = [];
                        groupedKeys.forEach(k => {
                            const items = groups[k];
                            const total = items.reduce((s,i) => s + (Number(i.amount)||0), 0);
                            unified.push({ type: 'group', key: k, items: items, total: total, count: items.length });
                        });
                        singleExpenses.forEach(exp => unified.push({ type: 'single', expense: exp, total: Number(exp.amount) || 0 }));

                        const cardSortMode = (ui.cardSorts && ui.cardSorts[cardName]) || 'alf';
                        if (cardSortMode === 'value-desc') unified.sort((a,b) => (Number(b.total)||0) - (Number(a.total)||0));
                        else if (cardSortMode === 'value-asc') unified.sort((a,b) => (Number(a.total)||0) - (Number(b.total)||0));
                        else unified.sort((a,b) => {
                            const aLabel = a.type === 'group' ? (a.key||'') : (a.expense && a.expense.description ? a.expense.description : '');
                            const bLabel = b.type === 'group' ? (b.key||'') : (b.expense && b.expense.description ? b.expense.description : '');
                            return aLabel.toString().toLowerCase().localeCompare(bLabel.toString().toLowerCase());
                        });

                        unified.forEach(item => {
                            if (item.type === 'group') {
                                const items = item.items;
                                const sum = item.total;
                                const count = item.count;
                                const key = item.key;
                                const row = document.createElement('div');
                                row.className = 'flex w-full justify-between text-sm items-center group-item py-0.5 grouped-row';
                                row._items = items;
                                row.title = items.map(it => `${formatCurrency(it.amount)} — ${escapeHtml(it.description || '')}`).join('\n');
                                row.innerHTML = `<div class="desc-wrap flex items-center truncate pr-2" data-group-key="${encodeURIComponent(key)}" style="gap:6px;"><span class="desc-text truncate">${escapeHtml(key)} <span class="text-xs text-gray-500">(${count} • ${formatCurrency(sum)})</span></span><button class="group-info-btn invisible ml-2" data-group-key="${encodeURIComponent(key)}" title="Detalhes do grupo"><span class="material-symbols-outlined" style="font-size:16px;">info</span></button></div><span class="card-exp-amount font-medium flex-shrink-0">${formatCurrency(sum)}</span>`;
                                row.addEventListener('click', () => { try { const lines = items.map(it => `${formatCurrency(it.amount)} — ${escapeHtml(it.description || '')}`); showModalList(`Detalhes: ${key}`, lines.join('\n')); } catch(e){console.error('group click', e);} });
                                // attach tooltip behavior to small info button synchronously to preserve ordering
                                const btn = row.querySelector('.group-info-btn');
                                if (btn) {
                                    let tt = null;
                                    function showTip() {
                                        if (tt) return;
                                        tt = document.createElement('div');
                                        tt.className = 'expense-tooltip';
                                        // build content safely without nested template braces
                                        const linesArr = items.map(it => `${formatCurrency(it.amount)} — ${escapeHtml(it.description || '')}`);
                                        const totalVal = items.reduce((s,i)=>s+(Number(i.amount)||0),0);
                                        tt.innerHTML = linesArr.join('<br>') + '<br><hr style="opacity:.12;margin:6px 0">' + '<strong>Total: ' + formatCurrency(totalVal) + '</strong>';
                                        document.body.appendChild(tt);
                                        const r = btn.getBoundingClientRect();
                                        tt.style.position = 'fixed';
                                        tt.style.left = (r.left + 8) + 'px';
                                        tt.style.top = (r.top + r.height + 6) + 'px';
                                        tt.style.zIndex = 4000;
                                    }
                                    function hideTip() { if (tt) { try { tt.remove(); } catch(e){} tt = null; } }
                                    btn.addEventListener('mouseenter', showTip);
                                    btn.addEventListener('mouseleave', hideTip);
                                    btn.addEventListener('click', (ev) => { ev.stopPropagation(); const lines = items.map(it => `${formatCurrency(it.amount)} — ${escapeHtml(it.description || '')}`); showModalList(`Detalhes: ${key}`, lines.join('\n')); });
                                }
                                listEl.appendChild(row);
                            } else {
                                const exp = item.expense;
                                const inst = exp.totalInstallments ? `<span class="text-xs text-gray-500">(${exp.currentInstallment}/<span class="last-installment-btn" data-installment-id="${exp.installmentId}" data-total="${exp.totalInstallments}">${exp.totalInstallments}</span>)</span>` : '';
                                const fin = (exp.financingId && exp.totalFinancing) ? `<span class="text-xs text-gray-500">(${exp.currentFinancing}/<span class="last-installment-btn" data-financing-id="${exp.financingId}" data-total="${exp.totalFinancing}">${exp.totalFinancing}</span>)</span>` : '';
                                const remainingHtml = exp.totalInstallments ? (() => { const remainingCount = (exp.totalInstallments - (exp.currentInstallment || 1) + 1); const remainingTotal = (Number(exp.amount) || 0) * remainingCount; return `<span class="remaining-total text-xs text-gray-500 ml-2 hidden">${formatCurrency(remainingTotal)}</span>`; })() : '';
                                const row = document.createElement('div');
                                row.className = 'flex w-full justify-between text-sm items-center group-item py-0.5';
                                row.innerHTML = `<div class="desc-wrap flex items-center truncate pr-2" data-exp-id="${exp.id}" style="gap:6px;"><span class="desc-text truncate">${escapeHtml(exp.description)} ${inst} ${fin}</span>${remainingHtml}<button class="edit-cat-btn invisible ml-2" data-exp-id="${exp.id}" title="Editar categoria"><span class="material-symbols-outlined" style="font-size:16px;">edit</span></button></div><span class="card-exp-amount font-medium flex-shrink-0" data-exp-id="${exp.id}">${formatCurrency(exp.amount)}</span>`;
                                listEl.appendChild(row);
                            }
                        });
                    }
                } else {
                    // Render full list (no grouping)
                    if (cardExpenses.length === 0) {
                        listEl.innerHTML = '<p class="text-sm text-gray-500">Nenhum gasto este mês.</p>';
                    } else {
                        cardExpenses.forEach(exp => {
                            const inst = exp.totalInstallments ? `<span class="text-xs text-gray-500">(${exp.currentInstallment}/<span class="last-installment-btn" data-installment-id="${exp.installmentId}" data-total="${exp.totalInstallments}">${exp.totalInstallments}</span>)</span>` : '';
                            const fin = (exp.financingId && exp.totalFinancing) ? `<span class="text-xs text-gray-500">(${exp.currentFinancing}/<span class="last-installment-btn" data-financing-id="${exp.financingId}" data-total="${exp.totalFinancing}">${exp.totalFinancing}</span>)</span>` : '';
                            const remainingHtml = exp.totalInstallments ? (() => {
                                const remainingCount = (exp.totalInstallments - (exp.currentInstallment || 1) + 1);
                                const remainingTotal = (Number(exp.amount) || 0) * remainingCount;
                                return `<span class="remaining-total text-xs text-gray-500 ml-2 hidden">${formatCurrency(remainingTotal)}</span>`;
                            })() : '';
                            const div = document.createElement('div');
                            div.className = 'flex w-full justify-between text-sm items-center group-item py-0.5';
                            div.innerHTML = `<div class="desc-wrap flex items-center truncate pr-2" data-exp-id="${exp.id}" style="gap:6px;"><span class="desc-text truncate">${escapeHtml(exp.description)} ${inst} ${fin}</span>${remainingHtml}<button class="edit-cat-btn invisible ml-2" data-exp-id="${exp.id}" title="Editar categoria"><span class="material-symbols-outlined" style="font-size:16px;">edit</span></button></div><span class="card-exp-amount font-medium flex-shrink-0" data-exp-id="${exp.id}">${formatCurrency(exp.amount)}</span>`;
                            listEl.appendChild(div);
                        });
                    }
                }

                // Attach hover handlers for edit button visibility and remaining-total toggles
                try {
                    listEl.querySelectorAll('.desc-wrap').forEach(wrap => {
                        wrap.addEventListener('mouseenter', (ev) => {
                            const btn = wrap.querySelector('.edit-cat-btn');
                            const rem = wrap.querySelector('.remaining-total');
                            if (btn) btn.classList.remove('invisible');
                            if (rem) rem.classList.remove('hidden');
                        });
                        wrap.addEventListener('mouseleave', (ev) => {
                            const btn = wrap.querySelector('.edit-cat-btn');
                            const rem = wrap.querySelector('.remaining-total');
                            if (btn) btn.classList.add('invisible');
                            if (rem) rem.classList.add('hidden');
                        });
                    });
                } catch(e) { console.error('attach desc hover handlers for card', e); }

                // Hook last-installment and edit buttons
                try {
                    listEl.querySelectorAll('.last-installment-btn').forEach(btn => btn.addEventListener('click', (ev) => {
                        const financingId = btn.dataset.financingId || null;
                        const installmentId = btn.dataset.installmentId || null;
                        goToLastInstallment({ financingId, installmentId });
                    }));
                    listEl.querySelectorAll('.edit-cat-btn').forEach(btn => btn.addEventListener('click', (ev) => {
                        ev.stopPropagation();
                        // If this button is attached to a grouped row, it will have data-group-key
                        const groupKeyEnc = btn.dataset.groupKey;
                        if (groupKeyEnc) {
                            const key = decodeURIComponent(groupKeyEnc);
                            // Prefer items stored on the nearest row, fallback to groups map
                            let row = btn.closest('.group-item');
                            let items = row && row._items;
                            if (!items) items = groups && groups[key] ? groups[key] : [];
                            if (items && items.length > 0) {
                                const lines = items.map(it => `${formatCurrency(it.amount)} — ${escapeHtml(it.description || '')}`);
                                showModalList(`Detalhes: ${key}`, lines.join('\n'));
                            } else {
                                showToast('Nenhum item encontrado para este grupo.', 'bg-yellow-600');
                            }
                            return;
                        }
                        const expId = btn.dataset.expId;
                        if (!expId) return;
                        openModal('expenses', expId);
                    }));
                } catch(e) { console.error('attach card action handlers', e); }

                // Attach toggle click for this card (if not already attached)
                try {
                    const toggle = root.querySelector('.card-group-toggle');
                    if (toggle && !toggle._attached) {
                        // Note: actual grouping toggle is handled via delegation on the credit-cards container
                        // keep a marker to avoid duplicate wiring
                        // (delegated handler will toggle all cards when any .card-group-toggle is clicked)
                        toggle._attached = true;
                    }
                } catch(e) { console.error('attach card toggle handler', e); }

            } catch(e) { console.error('populateCardExpenses', e); }
        }

        function renderInvestmentsView() {
            const allData = Object.values(state.appData.data).flatMap(year => Object.values(year));
            const allSavings = allData.flatMap(month => month.savings || []);
            const totalInvestedFromSavings = allSavings.reduce((sum, s) => sum + s.amount, 0);
            // include saved amounts from travel plans
            const travelSavedAll = (state.appData.settings.travelPlans || []).reduce((sum, p) => sum + (Number(p.saved) || 0), 0);
            const totalInvested = totalInvestedFromSavings + travelSavedAll;
            // current month savings should include saving entries plus travel plan saves whose date falls in current month
            const currentMonth = state.currentDate.getMonth() + 1; const currentYear = state.currentDate.getFullYear();
            const currentMonthSavings = (getCurrentMonthData().savings || []).reduce((sum, s) => sum + s.amount, 0) + (state.appData.settings.travelPlans || []).filter(p => {
                try { if (!p.date) return false; const d = new Date(p.date); return d.getFullYear() === currentYear && (d.getMonth() + 1) === currentMonth; } catch(e) { return false; }
            }).reduce((sum, p) => sum + (Number(p.saved) || 0), 0);
            const monthsWithSavings = allData.filter(m => ((m.savings || []).reduce((s, t) => s + t.amount, 0)) > 0);
            const avgMonthlyInvestment = monthsWithSavings.length > 0 ? totalInvested / monthsWithSavings.length : 0;
            
            document.getElementById('kpi-total-invested').textContent = formatCurrency(totalInvested);
            document.getElementById('kpi-monthly-investment').textContent = formatCurrency(currentMonthSavings);
            document.getElementById('kpi-avg-monthly-investment').textContent = formatCurrency(avgMonthlyInvestment);

            const futureValue = (pv, pmt, rate, periods) => {
                let fv = pv;
                for (let i = 0; i < periods; i++) { fv = (fv + pmt) * (1 + rate); }
                return fv;
            };
            const monthlyRate = (1 + 0.08)**(1/12) - 1;

            document.getElementById('projection-1y').textContent = formatCurrency(futureValue(totalInvested, avgMonthlyInvestment, monthlyRate, 12));
            document.getElementById('projection-5y').textContent = formatCurrency(futureValue(totalInvested, avgMonthlyInvestment, monthlyRate, 60));
            document.getElementById('projection-10y').textContent = formatCurrency(futureValue(totalInvested, avgMonthlyInvestment, monthlyRate, 120));
            
            renderGoals();
            renderMonthlySavingsChart();
            renderPortfolioCompositionChart();
        }

        // Legacy travel planner renderer replaced by new planner UI. Delegate rendering to the new planner functions when available.
        function renderTravelPlannerView() {
            try {
                if (window.tp && typeof window.tp.renderPlansList === 'function') {
                    return window.tp.renderPlansList();
                }
                // fallback: populate simple placeholder
                const container = document.getElementById('tp-plans');
                if (container) container.innerHTML = '<div class="text-sm text-gray-600">Planejadora inicializando...</div>';
            } catch (e) { console.error('renderTravelPlannerView (delegated)', e); }
        }

        // small helper: escape text for innerHTML usage
        function escapeHtml(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

        // --- Travel planner helpers ---
        // compute months remaining from today to target date string (YYYY-MM-DD)
        function computeMonthsRemaining(targetDateStr) {
            if (!targetDateStr) return 0;
            try {
                const today = new Date();
                const target = new Date(targetDateStr + 'T00:00:00');
                let months = (target.getFullYear() - today.getFullYear()) * 12 + (target.getMonth() - today.getMonth());
                // if target day is earlier in month than today, reduce one month (not a full month)
                if (target.getDate() < today.getDate()) months = months - 1;
                return Math.max(0, months);
            } catch (e) { return 0; }
        }

        // --- Goal <-> Savings synchronization helpers ---
        function sumSavingsForGoal(goalId) {
            try {
                const allSavings = Object.values(state.appData.data).flatMap(y => Object.values(y)).flatMap(m => m.savings || []);
                return allSavings.filter(s => s.goalId === goalId).reduce((sum, s) => sum + (Number(s.amount) || 0), 0);
            } catch (e) { return 0; }
        }

        // Apply a desired travelPlan.saved value into savings ledger by creating/updating/deleting entries
        // We will operate on savings entries that reference the goalId, adjusting newest entries first when reducing.
        function auditSync(action, details) {
            try {
                state.appData.metaSyncLog = state.appData.metaSyncLog || [];
                state.appData.metaSyncLog.push({ id: generateUUID(), ts: new Date().toISOString(), action: action, details });
            } catch (e) { console.error('auditSync error', e); }
        }

        async function applySavedToSavings(goalId, targetAmount) {
            try {
                const current = sumSavingsForGoal(goalId);
                const diff = Math.round((Number(targetAmount) || 0) * 100) / 100 - Math.round((current) * 100) / 100;
                if (Math.abs(diff) < 0.01) return { created:0, removed:0, adjusted:0 };

                if (diff > 0) {
                    // create additional saving in current month
                    const md = getCurrentMonthData(); if (!Array.isArray(md.savings)) md.savings = [];
                    const amt = Math.round(diff * 100) / 100;
                    const entry = { id: generateUUID(), description: `Aporte p/ meta`, category: (state.appData.settings.goals.find(g=>g.id===goalId)||{}).name || '', amount: amt, date: new Date().toISOString(), goalId };
                    md.savings.push(entry);
                    auditSync('create_saving', { goalId, amount: amt, entryId: entry.id });

                    // create undo token and push to global undo stack
                    window.__autoCreateUndoStack = window.__autoCreateUndoStack || [];
                    const undoItem = { createdEntries: [{ entryId: entry.id, year: state.currentDate.getFullYear(), month: (state.currentDate.getMonth()+1) }], ts: new Date().toISOString() };
                    window.__autoCreateUndoStack.push(undoItem);

                    // show toast with Undo action
                    if (typeof showToast === 'function') {
                        // build a temporary interactive toast: overwrite showToast behavior by adding a click handler to undo
                        const message = `Aporte automático de ${formatCurrency(amt)} criado para a meta. `;
                        showToast(message + 'Clique para desfazer.', 'bg-green-600');
                        try {
                            const toast = document.getElementById('toast');
                            if (toast) {
                                // make it clickable for undo
                                const clickHandler = async function(){
                                    try {
                                        // perform undo: remove created entries
                                        for (const e of undoItem.createdEntries) {
                                            const y = String(e.year);
                                            const m = String(e.month).padStart(2,'0');
                                            const md2 = (state.appData.data && state.appData.data[y] && state.appData.data[y][m]) ? state.appData.data[y][m] : null;
                                            if (md2 && Array.isArray(md2.savings)) {
                                                const idx = md2.savings.findIndex(s => s.id === e.entryId);
                                                if (idx >= 0) md2.savings.splice(idx,1);
                                            }
                                        }
                                        auditSync('undo_create_saving', { goalId, entryIds: undoItem.createdEntries.map(x=>x.entryId) });
                                        try { if (storage && storage.saveData) await storage.saveData(state.appData); } catch(e){}
                                        toast.style.display = 'none';
                                        render();
                                    } catch(err) { console.error('undo auto-create', err); }
                                };
                                toast.addEventListener('click', clickHandler, { once:true });
                                // auto-dismiss after 7s (leave existing toast timeout behavior too)
                                setTimeout(() => { try { toast.removeEventListener('click', clickHandler); } catch(e){} }, 7000);
                            }
                        } catch(e) { /* ignore toast wiring errors */ }
                    }
                    return { created:1, removed:0, adjusted:0 };
                } else {
                    // plan to remove/decrement entries: show confirm to the user
                    let remainingToRemove = Math.abs(diff);
                    // collect entries sorted by date descending
                    const entries = [];
                    Object.keys(state.appData.data).forEach(year => {
                        Object.keys(state.appData.data[year]).forEach(month => {
                            const md = state.appData.data[year][month];
                            if (Array.isArray(md.savings)) {
                                md.savings.forEach(s => { if (s.goalId === goalId) entries.push({ entry: s, md }); });
                            }
                        });
                    });
                    entries.sort((a,b) => { const da = new Date(a.entry.date || 0); const db = new Date(b.entry.date || 0); return db - da; });

                    // prepare a preview of intended removals
                    const plan = [];
                    let tempRem = remainingToRemove;
                    for (const item of entries) {
                        if (tempRem <= 0) break;
                        const amt = Number(item.entry.amount) || 0;
                        if (amt <= tempRem + 0.0001) {
                            plan.push({ type:'remove', id: item.entry.id, amount: amt, date: item.entry.date });
                            tempRem = Math.round((tempRem - amt) * 100) / 100;
                        } else {
                            plan.push({ type:'decrement', id: item.entry.id, from: amt, to: Math.round((amt - tempRem) * 100) / 100, date: item.entry.date });
                            tempRem = 0;
                        }
                    }

                    const summary = plan.map(p => p.type === 'remove' ? `Remover ${formatCurrency(p.amount)} (${p.date||'—'})` : `Reduzir ${formatCurrency(p.from)} → ${formatCurrency(p.to)} (${p.date||'—'})`).join('\n');
                    try {
                        const ok = await confirmAsync(`A meta está maior do que os aportes registrados. Aplicar ajustes automáticos?\n\n${summary}`, 'Ajustar aportes');
                        if (!ok) return { created:0, removed:0, adjusted:0 };
                    } catch(e) { return { created:0, removed:0, adjusted:0 }; }

                    // apply the plan
                    let removed = 0, adjusted = 0;
                    for (const p of plan) {
                        if (p.type === 'remove') {
                            // find and remove
                            for (const year of Object.keys(state.appData.data)) {
                                for (const month of Object.keys(state.appData.data[year])) {
                                    const md = state.appData.data[year][month];
                                    if (!Array.isArray(md.savings)) continue;
                                    const idx = md.savings.findIndex(x => x.id === p.id);
                                    if (idx >= 0) { md.savings.splice(idx,1); removed++; break; }
                                }
                            }
                        } else if (p.type === 'decrement') {
                            for (const year of Object.keys(state.appData.data)) {
                                for (const month of Object.keys(state.appData.data[year])) {
                                    const md = state.appData.data[year][month];
                                    if (!Array.isArray(md.savings)) continue;
                                    const e = md.savings.find(x => x.id === p.id);
                                    if (e) { e.amount = p.to; adjusted++; break; }
                                }
                            }
                        }
                    }
                    auditSync('adjust_savings', { goalId, removed, adjusted, plan });
                    if (typeof showToast === 'function') showToast(`Ajustes automáticos aplicados: removidos ${removed}, ajustados ${adjusted}.`, 'bg-yellow-600');
                    return { created:0, removed, adjusted };
                }
            } catch (e) { console.error('applySavedToSavings error', e); return { created:0, removed:0, adjusted:0 }; }
        }

        // Recompute total savings for a goal and update any travelPlans linked to that goal to reflect it
        async function updateTravelPlanSavedFromSavings(goalId) {
            try {
                const total = sumSavingsForGoal(goalId);
                const plans = (state.appData.settings.travelPlans || []).filter(p => p.goalId === goalId);
                let updated = false;
                
                plans.forEach(p => { 
                    const newSaved = Math.round((Number(total) + Number.EPSILON) * 100) / 100;
                    if (p.saved !== newSaved) {
                        p.saved = newSaved;
                        updated = true;
                    }
                });
                
                // Automatically save if any plan was updated
                if (updated && typeof saveTravelPlans === 'function') {
                    try {
                        await saveTravelPlans(state.appData.settings.travelPlans);
                    } catch(e) {
                        console.error('Erro ao salvar planos de viagem atualizados:', e);
                    }
                }
            } catch (e) { console.error('updateTravelPlanSavedFromSavings error', e); }
        }

        // Função para sincronizar todos os planos de viagem com as poupanças
        async function syncAllTravelPlansWithSavings() {
            try {
                const goals = state.appData.settings.goals || [];
                const travelPlans = state.appData.settings.travelPlans || [];
                
                for (const goal of goals) {
                    const linkedPlans = travelPlans.filter(p => p.goalId === goal.id);
                    if (linkedPlans.length > 0) {
                        await updateTravelPlanSavedFromSavings(goal.id);
                    }
                }
            } catch (e) {
                console.error('Erro na sincronização de planos de viagem:', e);
            }
        }

        function showFieldError(fieldId, msg) {
            try {
                const errEl = document.getElementById(fieldId + '-error');
                if (!errEl) return;
                if (msg) { errEl.textContent = msg; errEl.classList.remove('hidden'); }
                else { errEl.textContent = ''; errEl.classList.add('hidden'); }
            } catch (e) { /* ignore */ }
        }

        // Attach handlers to currency fields to format on blur and unformat on focus
        function attachCurrencyHandlers() {
            try {
                const curIds = ['tp-cost','tp-saved'];
                curIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (!el || el._currencyAttached) return;
                    el._currencyAttached = true;
                    el.addEventListener('focus', function() {
                        // unformat to plain number for easier editing; keep empty if value is zero to avoid showing '0'
                        const n = parseLocaleNumber(this.value);
                        if (Number.isFinite(n) && !isNaN(n) && n !== 0) this.value = (n % 1 === 0 ? String(n) : String(n)); else this.value = '';
                    });
                    // realtime input handler: keep only digits, comma and dot; format thousands as user types
                    el.addEventListener('input', function(e) {
                        const pos = this.selectionStart;
                        let v = this.value || '';
                        // replace NBSP
                        v = v.replace(/\u00A0/g, ' ');
                        // remove everything except digits, comma, dot and minus
                        v = v.replace(/[^0-9,\.\-]/g, '');
                        // if both comma and dot present, assume dot is thousand and comma decimal -> normalize
                        if (v.indexOf('.') !== -1 && v.indexOf(',') !== -1) {
                            v = v.replace(/\./g, '').replace(/,/g, '.');
                        }
                        // split decimals
                        const parts = v.split(/[,\.]/);
                        let intPart = parts[0] || '';
                        let decPart = parts.length > 1 ? parts.slice(1).join('') : '';
                        // remove leading zeros
                        intPart = intPart.replace(/^0+(?=\d)/, '') || '0';
                        // insert thousands separator for display (dot)
                        intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                        // rebuild value with comma as decimal separator (if decimals exist)
                        this.value = decPart ? (intPart + ',' + decPart.slice(0,2)) : intPart;
                        // try to restore caret (approximate)
                        try { this.selectionStart = this.selectionEnd = this.value.length; } catch(e) {}
                    });
                    el.addEventListener('blur', function() {
                        const n = parseLocaleNumber(this.value);
                        if (Number.isFinite(n) && !isNaN(n)) this.value = formatCurrency(n); else this.value = '';
                    });
                    // initial format if there's a value
                    const init = parseLocaleNumber(el.value);
                    if (Number.isFinite(init) && !isNaN(init)) el.value = formatCurrency(init);
                });
            } catch (e) { console.error('attachCurrencyHandlers', e); }
        }

        // Simple handler for paying a card invoice (placeholder)
        async function payCardInvoice(cardName) {
            try {
                if (!cardName) return;
                const monthData = getCurrentMonthData();
                const cardExpenses = (monthData.expenses || []).filter(exp => exp.payment === cardName);
                if (cardExpenses.length === 0) return;
                const allPaid = cardExpenses.every(exp => exp.isPaid);
                // Toggle: if all paid -> revert (unmark), else mark all as paid
                cardExpenses.forEach(exp => { exp.isPaid = !allPaid; });
                try {
                    await storage.saveData(state.appData);
                    if (allPaid) showToast(`Fatura ${cardName} revertida (desmarcada).`, 'bg-gray-600');
                    else showToast(`Fatura ${cardName} marcada como paga neste mês.`, 'bg-green-600');
                } catch (e) {
                    console.error('Erro ao salvar status da fatura:', e);
                    showToast('Falha ao salvar status da fatura no Firebase.', 'bg-red-600');
                }
                render();
            } catch (e) { console.error('payCardInvoice', e); }
        }

        async function deleteGoal(id) {
            if (!id) return;
            try { const ok = await confirmAsync('Tem certeza que deseja excluir esta meta?', 'Confirmar exclusão'); if (!ok) return; } catch(e){ return; }
            const idx = (state.appData.settings.goals || []).findIndex(g => g.id === id);
            if (idx > -1) {
                state.appData.settings.goals.splice(idx, 1);
                try {
                    await storage.saveData(state.appData);
                    showToast('Meta excluída', 'bg-red-600');
                } catch (e) {
                    console.error('Erro ao excluir meta:', e);
                    showToast('Falha ao excluir meta no Firebase.', 'bg-red-600');
                }
                renderInvestmentsView();
            }
        }

        function renderPortfolioCompositionChart() {
            try {
                destroyChart('portfolio-composition-chart');
                const allSavings = Object.values(state.appData.data).flatMap(y => Object.values(y)).flatMap(m => m.savings || []);
                const portfolio = allSavings.reduce((acc, s) => { acc[s.category] = (acc[s.category]||0) + (s.amount||0); return acc; }, {});
                const ctx = document.getElementById('portfolio-composition-chart'); if (!ctx) return;
                ui.charts['portfolio-composition-chart'] = new Chart(ctx.getContext('2d'), { type:'doughnut', data:{ labels:Object.keys(portfolio), datasets:[{ data:Object.values(portfolio), backgroundColor:['#059669','#EA580C','#65A30D','#C026D3','#2563EB','#E11D48'] }] }, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}} });
            } catch(e){console.error('renderPortfolioCompositionChart', e)}
        }

        /**
         * Retorna o número de dias úteis (segunda a sexta) de um mês específico.
         * year - ano (ex: 2025)
         * month - mês 1-12
         */
        function diasUteisNoMes(year, month) {
            // month 1-12
            const m = month - 1;
            const primeiro = new Date(year, m, 1);
            const ultimo = new Date(year, m + 1, 0);
            let diasUteis = 0;
            for (let d = 1; d <= ultimo.getDate(); d++) {
                const dt = new Date(year, m, d);
                const dia = dt.getDay(); // 0 domingo, 6 sabado
                if (dia !== 0 && dia !== 6) diasUteis++;
            }
            return diasUteis;
        }

        /**
         * calcularSalarioLiquido(params)
         * Calcula salário líquido e detalhamento conforme regras fornecidas (INSS/IRRF 2025).
         * Parâmetro params (obj):
         *  - salarioBase (number)
         *  - percentualPericulosidade (number) - ex: 30
         *  - outrosProventosTributaveis (number) - default 0
         *  - numeroDependentes (int) - default 0
         *  - valorDesjejumDia (number) - default 0
         *  - valorTransporteDia (number) - default 0
         *  - diasTrabalhados (int) - default 22 (pode ser calculado por year/month)
         *  - horasExtrasSabado (number horas) - default 0
         *  - horasExtrasDomingo (number horas) - default 0
         *  - jornadaMensalHoras (number) - default 220
         *  - hourlyRate (number) - valor por hora, opcional
         *  - hoursWorked (number) - horas trabalhadas no mês, opcional
         *  - year, month (opcionais) para calcular dias úteis automaticamente
         * Retorna objeto JSON com resumo e detalhamento.
         */
        function calcularSalarioLiquido(params = {}) {
            const p = Object.assign({
                salarioBase: 0,
                percentualPericulosidade: 0,
                outrosProventosTributaveis: 0,
                numeroDependentes: 0,
                valorDesjejumDia: 0,
                valorTransporteDia: 0,
                diasTrabalhados: undefined,
                horasExtrasSabado: 0,
                horasExtrasDomingo: 0,
                jornadaMensalHoras: 220,
                // hourlyRate/hoursWorked removed - valorHora will be derived from salarioBase / jornadaMensalHoras or salary-horas-trabalhadas input
                year: undefined,
                month: undefined
            }, params);

            // If hoursWorked provided explicitly, use it; otherwise default to jornadaMensalHoras
            if (!p.hoursTrabalhadas || p.hoursTrabalhadas === 0) {
                // allow external callers to pass hoursTrabalhadas into params; default to jornadaMensalHoras
                p.hoursTrabalhadas = p.jornadaMensalHoras;
            }
            // Dias trabalhados padrão: dias úteis do mês (quando year/month fornecidos).
            // Se o usuário forneceu 'hoursTrabalhadas', derivamos dias trabalhados a partir da jornada mensal e dias úteis.
            const baseDiasUteis = (p.year && p.month) ? diasUteisNoMes(p.year, p.month) : 22;
            if ((typeof p.diasTrabalhados === 'undefined' || p.diasTrabalhados === null) && p.hoursTrabalhadas && p.hoursTrabalhadas > 0) {
                // hora por dia = jornadaMensalHoras / baseDiasUteis
                const horasPorDia = p.jornadaMensalHoras > 0 ? (p.jornadaMensalHoras / baseDiasUteis) : 8;
                // derive diasTrabalhados as fractional value (do not round) so we can compute prorata correctly from hours
                p.diasTrabalhados = p.hoursTrabalhadas / horasPorDia;
                // keep a rounded copy for display in the modal where an integer day count is shown
                p._diasTrabalhadosRoundedForDisplay = Math.round(p.diasTrabalhados);
            }
            if ((typeof p.diasTrabalhados === 'undefined' || p.diasTrabalhados === null) && p.year && p.month) {
                p.diasTrabalhados = baseDiasUteis;
            }
            // Fallback padrão
            if (typeof p.diasTrabalhados === 'undefined' || p.diasTrabalhados === null) p.diasTrabalhados = 22;

            // Constantes 2025
            const INSS_BRACKETS = [
                { upTo: 1518.00, rate: 0.075 },
                { upTo: 2793.88, rate: 0.09 },
                { upTo: 4190.83, rate: 0.12 },
                { upTo: 8157.41, rate: 0.14 }
            ];
            // IRRF 2025 (mensal) — conforme tabela fornecida
            const IRRF_BRACKETS = [
                { upTo: 2259.20, rate: 0.0, deduction: 0.00 },
                { upTo: 2826.65, rate: 0.075, deduction: 169.44 },
                { upTo: 3751.05, rate: 0.15, deduction: 381.44 },
                { upTo: 4664.68, rate: 0.225, deduction: 662.77 },
                { upTo: Infinity, rate: 0.275, deduction: 896.00 }
            ];
            const DEPENDENT_DEDUCTION = 189.59;

            // 1) Salário bruto tributável
            // If the employee worked fewer days/hours than the full month, prorate salárioBase and periculosidade
            const fullMonthDias = (p.year && p.month) ? diasUteisNoMes(p.year, p.month) : 22;
            const diasWorked = (typeof p.diasTrabalhados !== 'undefined' && p.diasTrabalhados !== null) ? p.diasTrabalhados : fullMonthDias;
            const proporcao = (fullMonthDias > 0) ? Math.min(1, diasWorked / fullMonthDias) : 1;
            // Also consider horas trabalhadas if provided: derive proportion from hours.
            // When hoursTrabalhadas is explicitly provided, prefer the hours-based proportion to match payroll (holerite) behavior.
            let proporcaoHoras = 1;
            if (p.hoursTrabalhadas && p.hoursTrabalhadas > 0) {
                proporcaoHoras = Math.min(1, p.hoursTrabalhadas / p.jornadaMensalHoras);
            }
            // If hours were provided, use hours proportion; otherwise use days proportion
            const finalProporcao = (p.hoursTrabalhadas && p.hoursTrabalhadas > 0) ? proporcaoHoras : proporcao;

            const salarioBaseProrata = p.salarioBase * finalProporcao;
            const adicionalPericulosidade = (salarioBaseProrata * (p.percentualPericulosidade || 0)) / 100;
            const brutoTributavelSemExtras = salarioBaseProrata + adicionalPericulosidade + (p.outrosProventosTributaveis || 0);

            // 2) Horas extras: calcular valor hora com base no salário base já pro-rata (para que horas extras reflitam efetivamente o que foi ganho)
            // valorHora = salarioBaseProrata / jornadaMensalHoras (se jornadaMensalHoras > 0). Isso garante que, se o funcionário trabalhou menos horas, o valor/hora fique proporcional.
            const valorHora = (p.jornadaMensalHoras > 0) ? (salarioBaseProrata / p.jornadaMensalHoras) : ((p.hoursTrabalhadas && p.hoursTrabalhadas > 0) ? (salarioBaseProrata / p.hoursTrabalhadas) : 0);
            // Sábado 50% (ou seja, 1.5 * hora normal), Domingo 100% (2.0 * hora normal)
            const valorHorasExtras = (p.horasExtrasSabado || 0) * (valorHora * 1.5) + (p.horasExtrasDomingo || 0) * (valorHora * 2.0);

            const salarioBrutoTributavel = brutoTributavelSemExtras + valorHorasExtras;

            // 3) Cálculo do INSS progressivo
            let remaining = salarioBrutoTributavel;
            let inssTotal = 0;
            const inssPorFaixa = [];
            let lower = 0;
            for (let i = 0; i < INSS_BRACKETS.length; i++) {
                const faixa = INSS_BRACKETS[i];
                const upper = faixa.upTo;
                const taxable = Math.max(0, Math.min(remaining, upper - lower));
                const desconto = taxable * faixa.rate;
                inssPorFaixa.push({ lower: lower + 0.01, upper, taxable: round(taxable), rate: faixa.rate, desconto: round(desconto) });
                inssTotal += desconto;
                remaining -= taxable;
                lower = upper;
                if (remaining <= 0) break;
            }
            inssTotal = round(inssTotal);

            // 4) Base de cálculo IRRF
            const totalDependenteDeduction = (p.numeroDependentes || 0) * DEPENDENT_DEDUCTION;
            const baseIRRF = Math.max(0, salarioBrutoTributavel - inssTotal - totalDependenteDeduction);

            // 5) Cálculo IRRF
            let irrfRate = 0, irrfDeduction = 0, irrfValue = 0;
            for (let i = 0; i < IRRF_BRACKETS.length; i++) {
                const b = IRRF_BRACKETS[i];
                if (baseIRRF <= b.upTo) {
                    irrfRate = b.rate;
                    irrfDeduction = b.deduction;
                    break;
                }
            }
            irrfValue = round(Math.max(0, baseIRRF * irrfRate - irrfDeduction));

            // 6) Salário líquido
            const totalDescontos = round(inssTotal + irrfValue);
            const salarioLiquido = round(salarioBrutoTributavel - totalDescontos);

            // 7) Benefícios não tributáveis
            // Base para benefícios: quando year/month fornecidos, usar dias úteis do mês + 1 (regras do produto);
            // caso contrário, cair back para diasTrabalhados (pró-rata) ou fullMonthDias.
            const beneficiosDiasBase = (p.year && p.month) ? (diasUteisNoMes(p.year, p.month) + 1) : (p.diasTrabalhados || fullMonthDias);
            // Calcular separadamente VR (desjejum) e VT (transporte)
            const beneficiosVR = round((p.valorDesjejumDia || 0) * (beneficiosDiasBase || 0));
            const beneficiosVT = round((p.valorTransporteDia || 0) * (beneficiosDiasBase || 0));
            // Para o resumo (lado esquerdo), apenas o VT deve ser considerado (VT é pago junto com o salário)
            const beneficiosTotaisResumo = beneficiosVT;
            // Total combinado (VR + VT) mantido no detalhe para o uso no card direito
            const beneficiosTotaisCombined = round(beneficiosVR + beneficiosVT);

            // 8) Remuneração total mensal: Salário líquido + VT (apenas VT é pago junto com o salário)
            const remuneracaoTotal = round(salarioLiquido + beneficiosVT);

            // 9) FGTS (8% sobre o bruto tributável) - encargo do empregador
            const fgts = round(0.08 * salarioBrutoTributavel);

            // Monta retorno detalhado
            const result = {
                resumo: {
                    salarioBase: formatNumber(salarioBaseProrata),
                    adicionalPericulosidade: formatNumber(adicionalPericulosidade),
                    valorHorasExtras: formatNumber(valorHorasExtras),
                    salarioBrutoTributavel: formatNumber(salarioBrutoTributavel),
                    totalDescontos: formatNumber(totalDescontos),
                    salarioLiquido: formatNumber(salarioLiquido),
                    beneficiosTotais: formatNumber(beneficiosTotaisResumo),
                    remuneracaoTotal: formatNumber(remuneracaoTotal),
                    fgts: formatNumber(fgts)
                },
                detalhe: {
                    proventos: {
                        salarioBase: formatNumber(salarioBaseProrata),
                        adicionalPericulosidade: formatNumber(adicionalPericulosidade),
                        outrosProventosTributaveis: formatNumber(p.outrosProventosTributaveis || 0),
                        valorHorasExtras: formatNumber(valorHorasExtras)
                    },
                    descontos: {
                        inssPorFaixa,
                        inssTotal: formatNumber(inssTotal),
                        baseIRRF: formatNumber(baseIRRF),
                        irrfRate,
                        irrfDeduction: formatNumber(irrfDeduction),
                        irrfValue: formatNumber(irrfValue)
                    },
                    beneficios: {
                        valorDesjejumDia: formatNumber(p.valorDesjejumDia || 0),
                        valorTransporteDia: formatNumber(p.valorTransporteDia || 0),
                        diasTrabalhados: p.diasTrabalhados,
                        diasBaseParaBeneficios: beneficiosDiasBase,
                        beneficiosVR: formatNumber(beneficiosVR),
                        beneficiosVT: formatNumber(beneficiosVT),
                        beneficiosTotais: formatNumber(beneficiosTotaisCombined)
                    },
                    encargos: {
                        fgts: formatNumber(fgts)
                    }
                }
            };

            return result;

            // helpers
            function round(v) { return Math.round((v + Number.EPSILON) * 100) / 100; }
            function formatNumber(v) { return (typeof v === 'number') ? v.toFixed(2) : Number(v || 0).toFixed(2); }
        }

        function renderAllTables() {
            renderIncomeTable();
            renderExpenseTable();
            renderSavingsTable();
            // Attach salary tooltip handlers after tables render
            try { attachSalaryTooltipHandlers(); } catch(e) { /* ignore */ }
        }

        // Salary tooltip: builds a floating card showing bruto tributável, INSS, IRRF, descontos totais and remuneração total
        (function(){
            let salaryTooltipEl = null;
            function ensureTooltip() {
                if (salaryTooltipEl) return salaryTooltipEl;
                salaryTooltipEl = document.createElement('div');
                salaryTooltipEl.className = 'salary-tooltip';
                salaryTooltipEl.innerHTML = `<h4>Resumo do Salário</h4>
                    <div class="row"><div class="label">Bruto tributável</div><div class="value" data-key="bruto">R$ 0,00</div></div>
                    <div class="row"><div class="label">INSS</div><div class="value negative" data-key="inss">R$ 0,00</div></div>
                    <div class="row"><div class="label">IRRF</div><div class="value negative" data-key="irrf">R$ 0,00</div></div>
                    <div class="divider"></div>
                    <div class="row"><div class="label">Total de descontos</div><div class="value negative" data-key="descontos">R$ 0,00</div></div>
                    <div class="divider"></div>
                    <div class="row summary"><div class="label">Remuneração total</div><div class="value positive" data-key="remuneracao">R$ 0,00</div></div>`;
                document.body.appendChild(salaryTooltipEl);
                return salaryTooltipEl;
            }

            // position tooltip near element (to the top-right of the hovered element when possible)
            function positionTooltip(target, el) {
                const rect = target.getBoundingClientRect();
                const tooltipRect = el.getBoundingClientRect();
                // default position: above the element, right-aligned
                let top = window.scrollY + rect.top - tooltipRect.height - 8;
                let left = window.scrollX + rect.right - tooltipRect.width;
                // if not enough space above, place below
                if (top < window.scrollY + 8) top = window.scrollY + rect.bottom + 8;
                // keep inside viewport horizontally
                left = Math.max(window.scrollX + 8, Math.min(left, window.scrollX + document.documentElement.clientWidth - tooltipRect.width - 8));
                el.style.top = top + 'px';
                el.style.left = left + 'px';
            }

            window.attachSalaryTooltipHandlers = function attachSalaryTooltipHandlers() {
                const el = ensureTooltip();
                // Remove any previous listeners by cloning the node list
                const items = Array.from(document.querySelectorAll('.salary-breakdown-hidden'));
                items.forEach(item => {
                    // clear existing handlers to avoid duplication
                    item.onmouseenter = null; item.onmouseleave = null; item.onmousemove = null;
                    item.addEventListener('mouseenter', (ev) => {
                        try {
                            const id = item.dataset.id;
                            // try to find the income object by id in current month
                            const md = getCurrentMonthData();
                            let income = null;
                            if (md && Array.isArray(md.incomes)) income = md.incomes.find(i => i.id === id) || null;

                            // Build a cache key that includes month and year so results are month-specific
                            const y = (state.currentDate && state.currentDate.getFullYear()) ? state.currentDate.getFullYear() : (new Date()).getFullYear();
                            const m = (state.currentDate && typeof state.currentDate.getMonth === 'function') ? (state.currentDate.getMonth() + 1) : ((new Date()).getMonth() + 1);
                            const cacheKey = id ? `${id}@${y}-${m}` : null;
                            // Prefer cached calc (user may already have opened the breakdown modal for this month)
                            let calc = (window.salaryCalcCache && cacheKey && window.salaryCalcCache[cacheKey]) ? window.salaryCalcCache[cacheKey] : null;

                            // If not cached, build params from income.salaryMeta (or fallback to amount) and compute
                            if (!calc) {
                                let params = null;
                                if (income && income.salaryMeta) params = Object.assign({}, income.salaryMeta);
                                else if (income && income.amount) params = { salarioBase: income.amount };
                                // Ensure month/year are provided so dias úteis and benefícios use correct month
                                if (params) {
                                    params.year = y;
                                    params.month = m;
                                }
                                // Normalize possible hours fields and parse HH:MM strings
                                const parseHours = (v) => {
                                    if (v === undefined || v === null || v === '') return undefined;
                                    if (typeof v === 'number') return v;
                                    let s = String(v).trim();
                                    const mcol = /^\s*-?\d{1,3}:[0-5]?\d\s*$/.exec(s);
                                    if (mcol) {
                                        const parts = s.split(':');
                                        const hh = parseInt(parts[0], 10) || 0;
                                        const mm = parseInt(parts[1], 10) || 0;
                                        return hh + (mm / 60);
                                    }
                                    s = s.replace(',', '.');
                                    const fv = parseFloat(s);
                                    return isNaN(fv) ? undefined : fv;
                                };
                                if (params) {
                                    // Try multiple property names that might exist in salaryMeta
                                    const rawHours = params.hoursTrabalhadas || params.horasTrabalhadas || params.hoursWorked || params.hours || params.horasTrabalhadasRaw || '';
                                    const ph = parseHours(rawHours);
                                    if (typeof ph !== 'undefined') params.hoursTrabalhadas = ph;
                                    // ensure jornadaMensalHoras fallback
                                    if (typeof params.jornadaMensalHoras === 'undefined' || params.jornadaMensalHoras === null) params.jornadaMensalHoras = 220;
                                }
                                if (params && typeof calcularSalarioLiquido === 'function') {
                                    calc = calcularSalarioLiquido(params);
                                    // store in cache per month-year
                                    try { window.salaryCalcCache = window.salaryCalcCache || {}; if (cacheKey) window.salaryCalcCache[cacheKey] = calc; } catch(e){}
                                }
                            }

                            if (!calc) return;

                            // Extract canonical values: bruto tributável, INSS total, IRRF value, total descontos and remuneracao total
                            const brutoVal = Number((calc.resumo && (calc.resumo.salarioBrutoTributavel || calc.resumo.salarioBruto)) || 0);
                            const inssVal = Number((calc.detalhe && calc.detalhe.descontos && (Number(calc.detalhe.descontos.inssTotal) || 0)) || (Number(calc.resumo && calc.resumo.inssTotal) || 0));
                            const irrfVal = Number((calc.detalhe && calc.detalhe.descontos && (Number(calc.detalhe.descontos.irrfValue) || 0)) || (Number(calc.resumo && calc.resumo.irrfValue) || 0));
                            const descontosVal = Number((calc.resumo && (Number(calc.resumo.totalDescontos) || 0)) || (inssVal + irrfVal));
                            const remuneracaoVal = Number((calc.resumo && (Number(calc.resumo.remuneracaoTotal) || Number(calc.resumo.remuneracao) || 0)) || 0);

                            const map = { bruto: brutoVal, inss: inssVal, irrf: irrfVal, descontos: descontosVal, remuneracao: remuneracaoVal };
                            Object.keys(map).forEach(k => {
                                const node = el.querySelector(`[data-key="${k}"]`);
                                if (node) node.textContent = formatCurrency(Number(map[k] || 0));
                            });
                            el.style.display = 'block';
                            positionTooltip(item, el);
                        } catch (e) { console.error('salary tooltip show', e); }
                    });
                    item.addEventListener('mouseleave', () => { try { el.style.display = 'none'; } catch(e){} });
                    item.addEventListener('mousemove', (ev) => { try { positionTooltip(item, el); } catch(e){} });
                });
            };
        })();

        function renderIncomeTable() {
            // Inicializa array de entradas para evitar erro
            const monthData = getCurrentMonthData();
            if (!Array.isArray(monthData.incomes)) monthData.incomes = [];
            if (!Array.isArray(monthData.vrLedger)) monthData.vrLedger = [];
            if (!Array.isArray(monthData.vrUsage)) monthData.vrUsage = [];
            const incomes = monthData.incomes;
            ui.incomeTableBody.innerHTML = '';
            if (incomes.length > 0) {
                // Exclude benefit entries (VR/VT) from the standard incomes list; they are shown as ledger rows below
                incomes.filter(i => (i.source || '').toString() !== 'benefit-vr' && (i.source || '').toString() !== 'benefit-vt').forEach(income => renderIncomeRow(income));
            } else {
                ui.incomeTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-4">Nenhuma entrada registrada.</td></tr>';
            }
            // Render benefit ledgers (VR and VT) in a generic way so Entradas shows them consistently
            try {
                function renderBenefitLedgerRows(type) {
                    const md = monthData;
                    const keyLedger = (type === 'vt') ? 'vtLedger' : 'vrLedger';
                    const ledger = Array.isArray(md[keyLedger]) ? md[keyLedger] : [];
                    ledger.forEach(l => {
                        const r = ui.incomeTableBody.insertRow();
                        r.dataset[`${type}Id`] = l.id || '';
                        // colorize row by type: VR = green, VT = yellow
                        const baseClass = (type === 'vt') ? 'border-b border-gray-100 bg-yellow-50 text-yellow-700' : 'border-b border-gray-100 bg-green-50 text-green-700';
                        r.className = baseClass + ' animate-fade-in';
                        const descDefault = (type === 'vt') ? 'Benefício - VT' : 'Benefício - VR';
                        const recurringIcon = l.isRecurring ? '<span class="material-symbols-outlined text-xs text-gray-400" title="Recorrente">autorenew</span>' : '';
                        const amountSpan = (type === 'vt') ? `<span class="vt-amount" data-vt-id="${l.id}">${formatCurrency(l.amount || 0)}</span>` : `<span class="vr-amount" data-vr-id="${l.id}">${formatCurrency(l.amount || 0)}</span>`;
                        const editBtn = (type === 'vt') ? `<button class="edit-vt-btn text-gray-500 hover:text-blue-600" data-vt-id="${l.id}"><span class="material-symbols-outlined text-xl">edit</span></button>` : `<button class="edit-vr-btn text-gray-500 hover:text-blue-600" data-vr-id="${l.id}"><span class="material-symbols-outlined text-xl">edit</span></button>`;
                        const deleteBtn = (type === 'vt') ? `<button class="delete-vt-btn text-gray-500 hover:text-red-600" data-vt-id="${l.id}"><span class="material-symbols-outlined text-xl">delete</span></button>` : `<button class="delete-vr-btn text-gray-500 hover:text-red-600" data-vr-id="${l.id}"><span class="material-symbols-outlined text-xl">delete</span></button>`;
                        r.innerHTML = `
                            <td class="py-2 px-3">${l.description || descDefault} ${recurringIcon}</td>
                            <td class="py-2 px-3 font-medium">${amountSpan}</td>
                            <td class="py-2 px-3 text-right actions-cell">${editBtn}${deleteBtn}</td>`;
                    });
                }
                // Render VR and VT ledger rows
                renderBenefitLedgerRows('vr');
                renderBenefitLedgerRows('vt');

                // attach inline edit handlers for amounts and edit/delete actions for VR and VT
                ui.incomeTableBody.querySelectorAll('.vr-amount').forEach(el => el.addEventListener('click', (e) => (typeof startInlineVREdit === 'function') ? startInlineVREdit(e.currentTarget, e.currentTarget.dataset.vrId) : null));
                ui.incomeTableBody.querySelectorAll('.edit-vr-btn').forEach(b => b.addEventListener('click', (e) => { const id = e.currentTarget.dataset.vrId; openVREdit(id); }));
                ui.incomeTableBody.querySelectorAll('.delete-vr-btn').forEach(b => b.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.vrId;
                    if (!id) return;
                    const md = getCurrentMonthData();
                    const entry = (md.vrLedger || []).find(v => v.id === id) || null;
                    if (!entry) return;
                    try {
                        if (entry.isRecurring && entry.recurringId) {
                            const delAll = await confirmAsync('Este benefício é recorrente. Deseja excluir este e todas as recorrências futuras?', 'Confirmar exclusão');
                            if (!delAll) return;
                            await deleteVRLedgerEntry(id);
                            render();
                        } else {
                            const ok = await confirmAsync('Excluir lançamento de VR?', 'Confirmar exclusão');
                            if (!ok) return;
                            await deleteVRLedgerEntry(id);
                            render();
                        }
                    } catch (e) { return; }
                }));
                // VT handlers
                ui.incomeTableBody.querySelectorAll('.vt-amount').forEach(el => el.addEventListener('click', (e) => (typeof startInlineVTEdit === 'function') ? startInlineVTEdit(e.currentTarget, e.currentTarget.dataset.vtId) : null));
                ui.incomeTableBody.querySelectorAll('.edit-vt-btn').forEach(b => b.addEventListener('click', (e) => { const id = e.currentTarget.dataset.vtId; openVTEdit(id); }));
                ui.incomeTableBody.querySelectorAll('.delete-vt-btn').forEach(b => b.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.vtId;
                    if (!id) return;
                    const md = getCurrentMonthData();
                    const entry = (md.vtLedger || []).find(v => v.id === id) || null;
                    if (!entry) return;
                    try {
                        if (entry.isRecurring && entry.recurringId) {
                            const delAll = await confirmAsync('Este benefício é recorrente. Deseja excluir este e todas as recorrências futuras?', 'Confirmar exclusão');
                            if (!delAll) return;
                            await deleteVTLedgerEntry(id);
                            render();
                        } else {
                            const ok = await confirmAsync('Excluir lançamento de VT?', 'Confirmar exclusão');
                            if (!ok) return;
                            await deleteVTLedgerEntry(id);
                            render();
                        }
                    } catch (e) { return; }
                }));
            } catch(e) { console.error('renderIncomeTable benefit rows', e); }
        }

        function getMonthVRBalance(monthData) {
            if (!monthData) monthData = getCurrentMonthData();
            const ledger = Array.isArray(monthData.vrLedger) ? monthData.vrLedger : [];
            const usage = Array.isArray(monthData.vrUsage) ? monthData.vrUsage : [];
            // Ensure numeric conversion (some entries may contain strings)
            const sumLedger = ledger.reduce((s, l) => s + (Number(l && l.amount) || 0), 0);
            const sumUsage = usage.reduce((s, u) => s + (Number(u && u.amount) || 0), 0);
            // Round to 2 decimals
            const bal = Math.round((sumLedger - sumUsage + Number.EPSILON) * 100) / 100;
            return Math.max(0, bal);
        }

        // VT balance helper (mirror VR)
        function getMonthVTBalance(monthData) {
            if (!monthData) monthData = getCurrentMonthData();
            const ledger = Array.isArray(monthData.vtLedger) ? monthData.vtLedger : [];
            const usage = Array.isArray(monthData.vtUsage) ? monthData.vtUsage : [];
            const sumLedger = ledger.reduce((s, l) => s + (Number(l && l.amount) || 0), 0);
            const sumUsage = usage.reduce((s, u) => s + (Number(u && u.amount) || 0), 0);
            const bal = Math.round((sumLedger - sumUsage + Number.EPSILON) * 100) / 100;
            return Math.max(0, bal);
        }

        // Utility: sort array of strings alphabetically (case-insensitive)
        function sortStrings(arr) {
            if (!Array.isArray(arr)) return [];
            return arr.slice().sort((a,b) => {
                const sa = (a||'').toString().toLowerCase();
                const sb = (b||'').toString().toLowerCase();
                return sa < sb ? -1 : sa > sb ? 1 : 0;
            });
        }

        function renderExpenseTable() {
            // Inicializa array de despesas para evitar erro
            let expenses = Array.isArray(getCurrentMonthData().expenses) ? [...getCurrentMonthData().expenses] : [];
            if (state.filters.searchTerm) {
                expenses = expenses.filter(exp => exp.description.toLowerCase().includes(state.filters.searchTerm.toLowerCase()));
            }
            // Apply advanced expense filters if present
            const ef = state.filters.expenseFilters || {};
            if (ef) {
                // helper normalizer
                const norm = s => (s || '').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
                if (ef.payment) {
                    const want = norm(ef.payment);
                    // allow tolerant match (some payments may include extra labels)
                    expenses = expenses.filter(exp => (norm(exp.payment) || '').includes(want));
                }
                if (ef.category) {
                    const wantCat = norm(ef.category);
                    // tolerant: match when category contains selected value (handles appended meta labels)
                    expenses = expenses.filter(exp => (norm(exp.category) || '').includes(wantCat));
                }
                if (ef.type) {
                    // type filter: 'expense' (regular expense) or 'saving' (reservas stored as savings entries or flagged)
                    if (ef.type === 'expense') expenses = expenses.filter(exp => !exp.isSaving && (exp.source || '') !== 'saving');
                    if (ef.type === 'saving') expenses = expenses.filter(exp => !!exp.isSaving || (state.appData && state.appData.settings && Array.isArray(state.appData.settings.savingCategories) && state.appData.settings.savingCategories.map(c=>norm(c)).includes(norm(exp.category))));
                }
                if (ef.recurring) expenses = expenses.filter(exp => !!exp.isRecurring);
                if (ef.installment) expenses = expenses.filter(exp => !!exp.installmentId || !!exp.financingId || !!exp.totalInstallments || !!exp.totalFinancing || !!exp.isInstallment);
                // Spending type filter: essencial / nao-essencial / reserva
                if (ef.spendingType) {
                    const settings = state.appData && state.appData.settings ? state.appData.settings : {};
                    const groups = settings.categoryGroups || {};
                    let essencials = groups.essencial || groups.essenciais || [];
                    let reservas = groups.reserva || groups.reservas || [];
                    if (!essencials || essencials.length === 0) {
                        essencials = ['Contas','Mercado','Saúde','Transporte','Assinaturas'];
                    }
                    if (!reservas || reservas.length === 0) {
                        reservas = settings.savingCategories || ['Reserva de Emergência','Poupança'];
                    }
                    // Prefer explicit expense.type when present (edited inline), otherwise fall back to category-group mapping
                    // normalize the group lists
                    const normArr = arr => (Array.isArray(arr) ? arr.map(x => (x||'').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '')) : []);
                    essencials = normArr(essencials);
                    reservas = normArr(reservas);

                    const expTypeCheck = (exp) => {
                        if (exp && exp.type && typeof exp.type === 'string') return norm(exp.type);
                        return null;
                    };

                    if (ef.spendingType === 'essencial') {
                        expenses = expenses.filter(exp => {
                            const t = expTypeCheck(exp);
                            if (t) return t.includes('essencial');
                            return essencials.includes(norm(exp.category));
                        });
                    } else if (ef.spendingType === 'nao-essencial') {
                        expenses = expenses.filter(exp => {
                            const t = expTypeCheck(exp);
                            if (t) {
                                if (t.includes('essencial')) return false;
                                if (t.includes('reserva') || t.includes('saving')) return false;
                                return true;
                            }
                            const catNorm = norm(exp.category);
                            return (!essencials.includes(catNorm) && !reservas.includes(catNorm));
                        });
                    } else if (ef.spendingType === 'reserva') {
                        expenses = expenses.filter(exp => {
                            const t = expTypeCheck(exp);
                            if (t) return t.includes('reserva') || t.includes('saving');
                            return reservas.includes(norm(exp.category));
                        });
                    }
                }
            }
            expenses.sort((a, b) => {
                const key = state.sort.key;
                const order = state.sort.order === 'asc' ? 1 : -1;
                if (key === 'amount') return (a.amount - b.amount) * order;
                if (key === 'isPaid') {
                    // true > false (pagas primeiro se asc, não pagas primeiro se desc)
                    return ((!!a.isPaid) - (!!b.isPaid)) * order;
                }
                const valA = a[key] || '';
                const valB = b[key] || '';
                return valA.localeCompare(valB) * order;
            });
            // Dashboard: grouping is intentionally disabled here (grouping only applies to invoice cards)
            ui.expensesTableBody.innerHTML = '';
            if (expenses.length > 0) {
                expenses.forEach(expense => renderExpenseRow(expense));
            } else {
                ui.expensesTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-4">Nenhuma despesa registrada.</td></tr>';
            }
            updateSortHeaders();
        }

        // Render expenses grouped by description (or category if description empty)
        function renderExpenseGroupedView(expenses) {
            // Ensure grouped container is available
            const groupsEl = document.getElementById('expenses-groups');
            const wrapper = document.getElementById('expenses-grouped-container');
            if (!groupsEl || !wrapper) return;
            // Prepare table wrapper reference
            const tableWrapper = ui.expensesTableBody ? ui.expensesTableBody.closest('.overflow-x-auto') : null;
            groupsEl.innerHTML = '';
            if (!expenses || expenses.length === 0) {
                groupsEl.innerHTML = '<div class="text-sm text-gray-500">Nenhuma despesa registrada.</div>';
                // ensure table hidden
                if (tableWrapper) tableWrapper.style.display = 'none';
                wrapper.classList.toggle('hidden', !state.showGroupedExpenses);
                return;
            }
            // Group by normalized description (fallback to category)
            const normalize = v => (v || '').toString().trim();
            const byDesc = {};
            expenses.forEach(exp => {
                const key = normalize(exp.description) || normalize(exp.category) || 'Sem descrição';
                if (!byDesc[key]) byDesc[key] = [];
                byDesc[key].push(exp);
            });

            // Separate into groups (count>1) and singles
            const groupedKeys = [];
            const singleExpenses = [];
            Object.keys(byDesc).forEach(k => {
                if (byDesc[k].length > 1) groupedKeys.push(k);
                else singleExpenses.push(byDesc[k][0]);
            });

            // Build a unified list of groups and single expenses so they can be sorted together
            const unified = [];
            groupedKeys.forEach(k => {
                const items = byDesc[k];
                const total = items.reduce((s,i) => s + (Number(i.amount) || 0), 0);
                unified.push({ type: 'group', key: k, items: items, total: total, count: items.length });
            });
            singleExpenses.forEach(exp => unified.push({ type: 'single', expense: exp, total: Number(exp.amount) || 0 }));

            // Sort unified list according to current state.sort
            try {
                if (state.sort && state.sort.key === 'amount') {
                    if (state.sort.order === 'asc') unified.sort((a,b) => (Number(a.total)||0) - (Number(b.total)||0));
                    else unified.sort((a,b) => (Number(b.total)||0) - (Number(a.total)||0));
                } else {
                    // alphabetical by label (group key or expense description)
                    unified.sort((a,b) => {
                        const aLabel = a.type === 'group' ? (a.key||'') : (a.expense && a.expense.description ? a.expense.description : '');
                        const bLabel = b.type === 'group' ? (b.key||'') : (b.expense && b.expense.description ? b.expense.description : '');
                        const cmp = aLabel.toString().toLowerCase().localeCompare(bLabel.toString().toLowerCase());
                        return (state.sort && state.sort.order === 'desc') ? -cmp : cmp;
                    });
                }
            } catch(e) {
                // fallback alphabetical
                unified.sort((a,b) => {
                    const al = a.type === 'group' ? (a.key||'') : (a.expense && a.expense.description ? a.expense.description : '');
                    const bl = b.type === 'group' ? (b.key||'') : (b.expense && b.expense.description ? b.expense.description : '');
                    return al.toString().toLowerCase().localeCompare(bl.toString().toLowerCase());
                });
            }

            // Render unified list inside the grouped container so groups and singles are interleaved visually
            groupsEl.innerHTML = '';
            // We'll render single items as compact rows inside the same container (instead of the table) to allow interleaving
            unified.forEach(item => {
                if (item.type === 'group') {
                    const items = item.items;
                    const total = item.total;
                    const count = item.count;
                    const key = item.key;
                    // compact grouped row
                    const row = document.createElement('div');
                    row.className = 'flex w-full justify-between text-sm items-center group-item py-0.5 grouped-row';
                    row._items = items;
                    const breakdown = items.map(it => `${formatCurrency(it.amount)} — ${escapeHtml(it.description || '')}`).join('\n');
                    row.title = breakdown; // small native tooltip on hover
                    const groupIcon = (typeof getIconFor === 'function') ? getIconFor('category', key) : '';
                    const groupLabel = (groupIcon && typeof iconHtml === 'function') ? iconHtml(groupIcon, 'text-sm text-gray-500') + `<span class="desc-text truncate">${escapeHtml(key)} <span class="text-xs text-gray-500">(${count} • ${formatCurrency(total)})</span></span>` : `<span class="desc-text truncate">${escapeHtml(key)} <span class="text-xs text-gray-500">(${count} • ${formatCurrency(total)})</span></span>`;
                    row.innerHTML = `<div class="desc-wrap flex items-center truncate pr-2" data-group-key="${encodeURIComponent(key)}" style="gap:6px;">${groupLabel}<button class="group-info-btn invisible ml-2" data-group-key="${encodeURIComponent(key)}" title="Detalhes do grupo"><span class="material-symbols-outlined" style="font-size:16px;">info</span></button></div><span class="card-exp-amount font-medium flex-shrink-0">${formatCurrency(total)}</span>`;
                    row.addEventListener('click', () => { try { const lines = items.map(it => `${formatCurrency(it.amount)} — ${escapeHtml(it.description || '')} (${escapeHtml(it.payment || it.category || '')})`); showModalList(`Detalhes: ${key}`, lines.join('\n')); } catch(e) { console.error('group click', e); } });
                    // add hover tooltip on the small info button
                    setTimeout(() => {
                        const infoBtn = row.querySelector('.group-info-btn');
                        if (!infoBtn) { groupsEl.appendChild(row); return; }
                        let tt = null;
                        function showTT() {
                            if (tt) return;
                            tt = document.createElement('div');
                            tt.className = 'expense-tooltip';
                            const lines = items.map(it => `${formatCurrency(it.amount)} — ${escapeHtml(it.description || '')}`);
                            const totalLine = `<strong>Total: ${formatCurrency(items.reduce((s,i)=>s+(Number(i.amount)||0),0))}</strong>`;
                            tt.innerHTML = lines.join('<br>') + '<br><hr style="opacity:.12;margin:6px 0">' + totalLine;
                            document.body.appendChild(tt);
                            const r = infoBtn.getBoundingClientRect();
                            tt.style.position = 'fixed';
                            tt.style.left = (r.left + 8) + 'px';
                            tt.style.top = (r.top + r.height + 6) + 'px';
                            tt.style.zIndex = 4000;
                        }
                        function hideTT() { if (tt) { try { tt.remove(); } catch(e){} tt = null; } }
                        infoBtn.addEventListener('mouseenter', showTT);
                        infoBtn.addEventListener('mouseleave', hideTT);
                        infoBtn.addEventListener('click', (ev) => { ev.stopPropagation(); const lines = items.map(it => `${formatCurrency(it.amount)} — ${escapeHtml(it.description || '')} (${escapeHtml(it.payment || it.category || '')})`); showModalList(`Detalhes: ${key}`, lines.join('\n')); });
                        groupsEl.appendChild(row);
                    }, 0);
                } else {
                    const exp = item.expense;
                    const inst = exp.totalInstallments ? `<span class="text-xs text-gray-500">(${exp.currentInstallment}/<span class="last-installment-btn" data-installment-id="${exp.installmentId}" data-total="${exp.totalInstallments}">${exp.totalInstallments}</span>)</span>` : '';
                    const fin = (exp.financingId && exp.totalFinancing) ? `<span class="text-xs text-gray-500">(${exp.currentFinancing}/<span class="last-installment-btn" data-financing-id="${exp.financingId}" data-total="${exp.totalFinancing}">${exp.totalFinancing}</span>)</span>` : '';
                    const remainingHtml = exp.totalInstallments ? (() => { const remainingCount = (exp.totalInstallments - (exp.currentInstallment || 1) + 1); const remainingTotal = (Number(exp.amount) || 0) * remainingCount; return `<span class="remaining-total text-xs text-gray-500 ml-2 hidden">${formatCurrency(remainingTotal)}</span>`; })() : '';
                    const row = document.createElement('div');
                    row.className = 'flex justify-between text-sm items-center group-item py-0.5';
                    row.dataset.expId = exp.id || '';
                    const smallCatIcon = (typeof getIconFor === 'function') ? getIconFor('category', exp.category || '') : '';
                    const leftLabel = (smallCatIcon && typeof iconHtml === 'function') ? iconHtml(smallCatIcon, 'text-sm text-gray-500') + `<span class="desc-text truncate">${escapeHtml(exp.description)} ${inst} ${fin}</span>` : `<span class="desc-text truncate">${escapeHtml(exp.description)} ${inst} ${fin}</span>`;
                    row.innerHTML = `<div class="desc-wrap flex items-center truncate pr-2" data-exp-id="${exp.id}" style="gap:6px;">${leftLabel}${remainingHtml}<button class="edit-cat-btn invisible ml-2" data-exp-id="${exp.id}" title="Editar categoria"><span class="material-symbols-outlined" style="font-size:16px;">edit</span></button></div><span class="card-exp-amount font-medium flex-shrink-0" data-exp-id="${exp.id}">${formatCurrency(exp.amount)}</span>`;
                    groupsEl.appendChild(row);
                }
            });

            // Since singles are rendered inside the grouped container now, hide the traditional table wrapper
            if (tableWrapper) tableWrapper.style.display = 'none';
            wrapper.classList.toggle('hidden', !state.showGroupedExpenses);

            // Attach hover handlers and action buttons for the single rows inside groupsEl
            try {
                groupsEl.querySelectorAll('.desc-wrap').forEach(wrap => {
                    wrap.addEventListener('mouseenter', (ev) => {
                        const btn = wrap.querySelector('.edit-cat-btn');
                        const rem = wrap.querySelector('.remaining-total');
                        if (btn) btn.classList.remove('invisible');
                        if (rem) rem.classList.remove('hidden');
                    });
                    wrap.addEventListener('mouseleave', (ev) => {
                        const btn = wrap.querySelector('.edit-cat-btn');
                        const rem = wrap.querySelector('.remaining-total');
                        if (btn) btn.classList.add('invisible');
                        if (rem) rem.classList.add('hidden');
                    });
                });
                groupsEl.querySelectorAll('.last-installment-btn').forEach(btn => btn.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    const financingId = btn.dataset.financingId || null;
                    const installmentId = btn.dataset.installmentId || null;
                    goToLastInstallment({ financingId, installmentId });
                }));
                groupsEl.querySelectorAll('.edit-cat-btn').forEach(btn => btn.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    const groupKeyEnc = btn.dataset.groupKey;
                    if (groupKeyEnc) {
                        const key = decodeURIComponent(groupKeyEnc);
                        let row = btn.closest('.group-item');
                        let items = row && row._items;
                        if (!items) items = byDesc && byDesc[key] ? byDesc[key] : [];
                        if (items && items.length > 0) {
                            const lines = items.map(it => `${formatCurrency(it.amount)} — ${escapeHtml(it.description || '')}`);
                            showModalList(`Detalhes: ${key}`, lines.join('\n'));
                        } else {
                            showToast('Nenhum item encontrado para este grupo.', 'bg-yellow-600');
                        }
                        return;
                    }
                    const expId = btn.dataset.expId;
                    if (!expId) return;
                    openModal('expenses', expId);
                }));
            } catch(e) { console.error('attach grouped view handlers', e); }
        }

        // Simple helper to escape HTML for text insertion
        function escapeHtml(str) {
            return (str || '').toString().replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]; });
        }

        // Small modal-list helper (reuses transaction modal if present, otherwise falls back to alert)
        function showModalList(title, content) {
            try {
                const modal = document.getElementById('transaction-modal');
                if (!modal) { alert(title + '\n\n' + content); return; }
                // Populate a simple container inside modal (create if missing)
                let container = modal.querySelector('.group-modal-content');
                if (!container) {
                    container = document.createElement('div');
                    container.className = 'group-modal-content p-4';
                    container.style.maxHeight = '60vh';
                    container.style.overflow = 'auto';
                    const body = modal.querySelector('.modal-body') || modal;
                    body.appendChild(container);
                }
                container.innerHTML = `<h3 class="text-lg font-semibold mb-2">${escapeHtml(title)}</h3><pre style="white-space:pre-wrap">${escapeHtml(content)}</pre>`;
                openModal();
            } catch(e) { alert(title + '\n\n' + content); }
        }

        function renderSavingsTable() {
            // Inicializa array de reservas para evitar erro
            const savings = Array.isArray(getCurrentMonthData().savings) ? getCurrentMonthData().savings : [];
            ui.savingsTableBody.innerHTML = '';
            if(savings.length > 0) {
                savings.forEach(saving => renderSavingRow(saving));
            } else {
                ui.savingsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-4">Nenhuma reserva registrada.</td></tr>';
            }
        }

        function renderIncomeRow(income) {
            const row = ui.incomeTableBody.insertRow();
            row.dataset.id = income.id;
            row.className = 'border-b border-gray-200 hover:bg-gray-50 animate-fade-in';
            // If this income looks like a salary (explicit flag, salaryMeta or description contains 'salari'), attach a hidden click access
            const isSalary = !!income.isSalary || !!income.salaryMeta || /salari/i.test(String(income.description || ''));
            // Keep the exact same visual as before: span with same typography (no underline). Access is 'hidden' but clickable.
            const amountHtml = `<span class="amount salary-breakdown-hidden text-green-600 font-medium" data-id="${income.id}">${formatCurrency(income.amount)}</span>`;
            const payIcon = (typeof getIconFor === 'function') ? getIconFor('payment', income.payment || '') : '';
            const descLabel = (payIcon && typeof iconHtml === 'function') ? iconHtml(payIcon, 'text-sm text-gray-500') + `<span>${escapeHtml(income.description || '')}</span>` : escapeHtml(income.description || '');

            // Render standard table cells (desktop-style). Keep same structure on all sizes so each transaction is a normal table row.
            {
                row.innerHTML = `
                    <td class="py-3 px-3 description-cell" data-label="Descrição" title="${escapeHtml(income.description)}">${descLabel} ${income.isRecurring ? '<span class="material-symbols-outlined text-xs text-gray-400" title="Recorrente">autorenew</span>' : ''}</td>
                    <td class="py-3 px-3" data-label="Valor">${amountHtml}</td>
                    <td class="py-3 px-3 text-right actions-cell">
                        <button class="edit-btn text-gray-500 hover:text-blue-600" title="Editar" aria-label="Editar transação"><span class="material-symbols-outlined text-xl">edit</span></button>
                        <button class="delete-btn text-gray-500 hover:text-red-600" title="Excluir"><span class="material-symbols-outlined text-xl">delete</span></button>
                    </td>`;
            }

            // Attach click handler to the hidden span if this is a salary entry
            if (isSalary) {
                try {
                    const span = row.querySelector('.salary-breakdown-hidden');
                    if (span) span.addEventListener('click', (ev) => { ev.preventDefault(); openSalaryBreakdown(income); });
                } catch (e) { console.error('attach salary breakdown click', e); }
            }
        }

        function renderExpenseRow(expense) {
            const row = ui.expensesTableBody.insertRow();
            row.dataset.id = expense.id;
            row.className = `border-b border-gray-200 hover:bg-gray-50 animate-fade-in ${expense.isPaid ? 'opacity-60' : ''}`;
            // Build the installments/financing display with a clickable total that jumps to last installment
            // Use a plain span for the clickable area so it inherits all typography and spacing
            const installmentHtml = expense.totalInstallments ? `<span class="text-xs text-gray-500">(${expense.currentInstallment}/<span class="last-installment-btn" data-installment-id="${expense.installmentId}" data-total="${expense.totalInstallments}">${expense.totalInstallments}</span>)</span>` : '';
            const financingHtml = (expense.financingId && expense.totalFinancing) ? `<span class="text-xs text-gray-500">(${expense.currentFinancing}/<span class="last-installment-btn" data-financing-id="${expense.financingId}" data-total="${expense.totalFinancing}">${expense.totalFinancing}</span>)</span>` : '';

            // Render payment and category with icons when possible. Use tolerant label lookup so stored values show nicely.
            const displayPaymentLabel = (typeof getPaymentLabel === 'function') ? getPaymentLabel(expense.payment || '') : (expense.payment || '');
            const paymentIcon = (typeof getIconFor === 'function') ? getIconFor('payment', displayPaymentLabel || expense.payment || '') : '';
            const categoryIcon = (typeof getIconFor === 'function') ? getIconFor('category', expense.category || '') : '';
            const paymentHtml = (typeof iconHtml === 'function' && paymentIcon) ? iconHtml(paymentIcon, 'text-sm text-gray-500') + `<span>${escapeHtml(displayPaymentLabel || expense.payment || '')}</span>` : escapeHtml(displayPaymentLabel || expense.payment || '');
            const categoryHtml = (typeof iconHtml === 'function' && categoryIcon) ? iconHtml(categoryIcon, 'text-sm text-gray-500') + `<span>${escapeHtml(expense.category || '')}</span>` : escapeHtml(expense.category || '');

            // Render standard table cells so each expense is one normal table row (works on all sizes)
            {
                row.innerHTML = `
                    <td class="py-3 px-3 checkbox-cell" data-label="Pago"><input type="checkbox" class="paid-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer" ${expense.isPaid ? 'checked' : ''}></td>
                    <td class="py-3 px-3 description-cell" data-label="Descrição" title="${escapeHtml(expense.description)}">${escapeHtml(expense.description)} ${expense.isRecurring ? '<span class="material-symbols-outlined text-xs text-gray-400" title="Recorrente">autorenew</span>' : ''} ${installmentHtml} ${financingHtml}</td>

                    <td class="py-3 px-3 text-gray-600" data-label="Pagamento">${paymentHtml}</td>
                    <td class="py-3 px-3 text-gray-600" data-label="Categoria">${categoryHtml}</td>
                    <td class="py-3 px-3 text-red-600 font-medium" data-label="Valor">${formatCurrency(expense.amount)}</td>
                    <td class="py-3 px-3 text-right actions-cell align-middle">
                        <button class="edit-btn text-gray-500 hover:text-blue-600 disabled:opacity-30 disabled:cursor-not-allowed" title="Editar" aria-label="Editar despesa" ${expense.installmentId ? 'disabled' : ''}><span class="material-symbols-outlined text-xl">${expense.installmentId ? 'lock' : 'edit'}</span></button>
                        <button class="delete-btn text-gray-500 hover:text-red-600" title="Excluir"><span class="material-symbols-outlined text-xl">delete</span></button>
                    </td>`;
            }

            // Attach click handler to jump to last installment when present (span will be visually identical)
            const lastBtn = row.querySelector('.last-installment-btn');
            if (lastBtn) {
                lastBtn.addEventListener('click', (ev) => {
                    const financingId = lastBtn.dataset.financingId || null;
                    const installmentId = lastBtn.dataset.installmentId || null;
                    goToLastInstallment({ financingId, installmentId });
                });
            }
        }

        function renderSavingRow(saving) {
            const row = ui.savingsTableBody.insertRow();
            row.dataset.id = saving.id;
            row.className = 'border-b border-gray-200 hover:bg-gray-50 animate-fade-in';
            const catIcon = (typeof getIconFor === 'function') ? getIconFor('category', saving.category || '') : '';
            const catLabel = (state.appData.settings.goals||[]).some(g=>g.name===saving.category) ? 'Meta' : escapeHtml(saving.category || '');
            const catHtml = (catIcon && typeof iconHtml === 'function') ? iconHtml(catIcon, 'text-sm text-gray-500') + `<span>${catLabel}</span>` : catLabel;
            row.innerHTML = `
                <td class="py-3 px-3" data-label="Descrição">${escapeHtml(saving.description)} ${saving.isRecurring ? '<span class="material-symbols-outlined text-xs text-gray-400" title="Recorrente">autorenew</span>' : ''}</td>
                <td class="py-3 px-3 text-gray-600" data-label="Categoria">${catHtml}</td>
                <td class="py-3 px-3 font-medium text-indigo-600" data-label="Valor">${formatCurrency(saving.amount)}</td>
                <td class="py-3 px-3 text-right actions-cell align-middle">
                    <button class="edit-btn text-gray-500 hover:text-blue-600" title="Editar" aria-label="Editar transação"><span class="material-symbols-outlined text-xl">edit</span></button>
                    <button class="delete-btn text-gray-500 hover:text-red-600" title="Excluir"><span class="material-symbols-outlined text-xl">delete</span></button>
                </td>`;
        }

        function renderGoals() {
            const container = ui.goalsContainer;
            const goals = (state.appData.settings.goals || []).slice().sort((a,b) => { const A=(a.name||'').toLowerCase(); const B=(b.name||'').toLowerCase(); return A < B ? -1 : A > B ? 1 : 0; });
            const allSavings = Object.values(state.appData.data).flatMap(y => Object.values(y)).flatMap(m => m.savings || []);

            // Removido o subtítulo "Metas" conforme solicitação
            container.innerHTML = ``;

            if (goals.length === 0) container.innerHTML += '<p class="text-center text-gray-500">Nenhuma meta definida.</p>';

            goals.forEach(goal => {
                // sum of savings items that target this goal (category == goal.name OR explicit goalId link)
                const totalFromSavings = allSavings.filter(s => ((s.category === goal.name) || (s.goalId && s.goalId === goal.id))).reduce((sum, s) => sum + s.amount, 0);
                // include amounts saved in travel plans linked to this goal
                const linkedPlans = (state.appData.settings.travelPlans || []).filter(p => p.goalId === goal.id);
                const travelPlanSaved = linkedPlans.reduce((sum, p) => sum + (Number(p.saved) || 0), 0);
                // If the goal is linked to one or more travel plans, prefer the travel-plan 'saved' value as authoritative
                // so the meta shows the same "Já poupado" value as the trip(s). Otherwise fall back to explicit savings entries.
                const totalSavedForGoal = (linkedPlans.length > 0) ? travelPlanSaved : totalFromSavings;
                const percentage = Math.min((totalSavedForGoal / goal.amount) * 100, 100);
                const isCompleted = percentage >= 100;
                if (isCompleted) {
                    showToast(`Meta atingida: ${goal.name}! Parabéns!`, 'bg-green-600');
                    if (window.confetti) window.confetti();
                }
                container.innerHTML += `
                    <div class="goal-item">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold">${goal.name} ${isCompleted ? '🎉' : ''}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-600">${formatCurrency(totalSavedForGoal)} / ${formatCurrency(goal.amount)}</span>
                                <button data-id="${goal.id}" class="quick-add-goal-btn p-1.5 text-green-600 hover:text-green-700 hover:bg-green-50 rounded transition-colors" title="Adicionar valor">
                                    <span class="material-symbols-outlined text-lg">add_circle</span>
                                </button>
                                <button data-id="${goal.id}" class="delete-goal-btn p-1 text-gray-400 hover:text-red-500"><span class="material-symbols-outlined text-lg">delete</span></button>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="bg-green-500" style="width: ${percentage}%"></div>
                        </div>
                    </div>`;
            });
            container.querySelectorAll('.delete-goal-btn').forEach(btn => btn.addEventListener('click', (e) => deleteGoal(e.currentTarget.dataset.id)));
            
            // Adicionar event listener para o botão de adição rápida - abre modal de transação
            container.querySelectorAll('.quick-add-goal-btn').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const goalId = e.currentTarget.dataset.id;
                const goal = (state.appData.settings.goals || []).find(g => g.id === goalId);
                if (!goal) return;
                
                // Abrir modal de transação em modo Reserva com categoria pré-selecionada
                try {
                    const modal = document.getElementById('transaction-modal');
                    if (!modal) return;
                    
                    // Resetar o formulário
                    if (typeof resetTransactionForm === 'function') resetTransactionForm();
                    
                    // Abrir o modal primeiro
                    if (typeof modal.showModal === 'function') {
                        modal.showModal();
                    } else {
                        modal.setAttribute('open', '');
                    }
                    
                    // Aguardar o modal abrir e então configurar
                    setTimeout(() => {
                        // Selecionar tipo "Reserva"
                        const savingsTypeBtn = document.querySelector('[data-type="savings"]');
                        if (savingsTypeBtn) {
                            savingsTypeBtn.click();
                            
                            // Aguardar o updateModalTypeUI popular os selects
                            setTimeout(() => {
                                const categorySelect = document.getElementById('category-saving');
                                if (categorySelect) {
                                    // Procurar pela opção que corresponde à meta
                                    let found = false;
                                    for (let i = 0; i < categorySelect.options.length; i++) {
                                        const optionValue = categorySelect.options[i].value;
                                        const optionText = categorySelect.options[i].text;
                                        
                                        // Comparação mais robusta
                                        if (optionValue === goal.name || 
                                            optionText === goal.name ||
                                            optionText.includes(goal.name) ||
                                            optionValue.includes(goal.name)) {
                                            categorySelect.selectedIndex = i;
                                            categorySelect.value = optionValue;
                                            // Disparar evento change para atualizar ícones se houver
                                            categorySelect.dispatchEvent(new Event('change', { bubbles: true }));
                                            found = true;
                                            break;
                                        }
                                    }
                                    
                                    if (!found) {
                                        console.warn('Meta não encontrada no select:', goal.name);
                                    }
                                } else {
                                    console.error('Select category-saving não encontrado!');
                                }
                                
                                // Preencher descrição automaticamente
                                const descInput = document.getElementById('description');
                                if (descInput && !descInput.value) {
                                    descInput.value = `Reserva para ${goal.name}`;
                                }
                                
                                // Focar no campo de valor
                                const amountInput = document.getElementById('amount');
                                if (amountInput) {
                                    amountInput.focus();
                                    amountInput.select();
                                }
                            }, 200); // Delay maior para garantir população do select
                        }
                    }, 50); // Pequeno delay inicial para modal abrir
                    
                } catch(error) {
                    console.error('Erro ao abrir modal de transação:', error);
                    showToast('Erro ao abrir formulário de reserva', 'bg-red-600');
                }
            }));

            // audit log feature removed
        }

        // --- KPIs, Feedback and Charts ---
    function updateKPIs() {
            try {
                const monthData = getCurrentMonthData();
                const totalIncome = (monthData.incomes || []).reduce((s, t) => s + (t.amount || 0), 0);
                // Compute total paid expenses but treat full-paid credit-card invoices as (sum of card expenses - anticipated)
                const expensesAll = monthData.expenses || [];
                const paymentMethods = (state.appData.settings && state.appData.settings.paymentMethods) || [];
                const cardMethods = paymentMethods.filter(p => p.type === 'credit_card');
                const cardAnticipations = monthData.cardAnticipations || {};
                const byPayment = expensesAll.reduce((acc, e) => { const k = (typeof getPaymentLabel === 'function') ? getPaymentLabel(e.payment || '') : (e.payment || '_none_'); (acc[k] = acc[k] || []).push(e); return acc; }, {});
                let totalExpenses = 0;
                for (const [payment, group] of Object.entries(byPayment)) {
                    // payment here is a display label (getPaymentLabel). Check tolerant match against cardMethods
                    const isCardPayment = cardMethods.some(c => paymentMatches(payment || '', c.name));
                    if (isCardPayment) {
                        const paidCount = group.filter(g => g.isPaid).length;
                        if (group.length > 0 && paidCount === group.length) {
                            // full invoice paid: count invoice total (sum - antecipado)
                            const sumAll = group.reduce((s, x) => s + (Number(x.amount) || 0), 0);
                            const anticipatedForCard = Number(cardAnticipations[payment] || 0);
                            totalExpenses += Math.round((sumAll - anticipatedForCard + Number.EPSILON) * 100) / 100;
                        } else {
                            // partial payments: count only paid items
                            totalExpenses += group.filter(g => g.isPaid).reduce((s, x) => s + (Number(x.amount) || 0), 0);
                        }
                    } else {
                        totalExpenses += group.filter(g => g.isPaid).reduce((s, x) => s + (Number(x.amount) || 0), 0);
                    }
                }
                const totalSavings = (monthData.savings || []).reduce((s, t) => s + (t.amount || 0), 0);
                const balance = totalIncome - totalExpenses - totalSavings;

        // Update DOM with animated numbers
        animateKPINumber('kpi-total-income', totalIncome);
        animateKPINumber('kpi-total-expenses', totalExpenses);
        animateKPINumber('kpi-total-savings', totalSavings);
        animateKPINumber('kpi-balance', balance);

                // Projected balance (consider all expenses but subtract card anticipations so invoice totals are used)
                const totalProjectedExpenses = (monthData.expenses || []).reduce((s, e) => s + (Number(e && e.amount) || 0), 0);
                // Sum anticipations stored per-card for this month (new: monthData.cardAnticipations = { cardName: amount })
                const totalAnticipations = Object.values(monthData.cardAnticipations || {}).reduce((s, a) => s + (Number(a) || 0), 0);
                // Adjust projected expenses by subtracting anticipations so the KPI reflects invoice totals (sum - antecipado)
                const adjustedProjectedExpenses = totalProjectedExpenses - totalAnticipations;
                const projectedBalance = totalIncome - adjustedProjectedExpenses - totalSavings;
                const projEl = document.getElementById('kpi-projected-balance'); if (projEl) { animateKPINumber('kpi-projected-balance', projectedBalance); projEl.classList.toggle('text-red-600', projectedBalance < 0); projEl.classList.toggle('text-green-600', projectedBalance >= 0); }
                // Populate Despesas Projetadas KPI (shows total of all expenses minus anticipations so invoice totals are used)
                const projExpEl = document.getElementById('kpi-projected-expenses'); if (projExpEl) animateKPINumber('kpi-projected-expenses', adjustedProjectedExpenses);

                // Percentual de cada despesa do mês (agrupado por descrição, soma valores e conta ocorrências)
                const expenses = monthData.expenses || [];
                const totalMonthExpenses = expenses.reduce((s, exp) => s + (Number(exp.amount) || 0), 0);
                const container = document.getElementById('kpi-expense-percentuals');
                if (container) {
                    container.innerHTML = '';
                    if (!expenses || expenses.length === 0 || totalMonthExpenses === 0) {
                        container.innerHTML = '<span class="text-gray-400 text-xs">Nenhuma despesa registrada.</span>';
                    } else {
                        // Group by normalized description (fall back to category or 'Sem descrição')
                        const groupsMap = new Map();
                        expenses.forEach(exp => {
                            const rawDesc = (exp.description || exp.category || 'Sem descrição').toString().trim();
                            const key = rawDesc.toLowerCase();
                            const amount = Number(exp.amount) || 0;
                            if (!groupsMap.has(key)) groupsMap.set(key, { description: rawDesc, amount: 0, count: 0 });
                            const g = groupsMap.get(key);
                            g.amount += amount;
                            g.count += 1;
                        });

                        // Turn into array and compute percent
                        const grouped = Array.from(groupsMap.values()).map(g => ({
                            description: g.description,
                            amount: g.amount,
                            count: g.count,
                            percent: totalMonthExpenses > 0 ? (g.amount / totalMonthExpenses) * 100 : 0
                        }));

                        // Sort descending by percent (largest contributors first)
                        grouped.sort((a,b) => b.percent - a.percent);

                        // Render each group: Description (count)  — percent%  • formatted currency
                        grouped.forEach(g => {
                            const percentStr = g.percent.toFixed(1);
                            const countStr = g.count > 1 ? ` <span class="text-gray-400">(${g.count})</span>` : '';
                            const left = `${escapeHtml(g.description)}${countStr}`;
                            const right = `<span class="text-sm text-gray-600">${percentStr}%</span> <span class="ml-3 font-medium">${formatCurrency(g.amount)}</span>`;
                            container.innerHTML += `<div class="flex justify-between items-center text-sm"> <div class="truncate pr-4">${left}</div><div class="flex items-center">${right}</div></div>`;
                        });
                    }
                }

                getFeedback(totalIncome, totalExpenses, totalSavings);

                // VR KPI: compute credited and used totals for current month
                try {
                    const creditedTotal = (monthData.vrLedger || []).reduce((s, l) => s + (Number(l && l.amount) || 0), 0);
                    let usedTotal = (monthData.vrUsage || []).reduce((s, u) => s + (Number(u && u.amount) || 0), 0);
                    // include legacy expenses paid with VR (edge-cases)
                    try { const expensesVR = (monthData.expenses || []).filter(e => paymentMatches(e.payment || '', 'VR')); usedTotal += expensesVR.reduce((s, e) => s + (Number(e && e.amount) || 0), 0); } catch(e) {}
                    const usedRounded = Math.round((usedTotal + Number.EPSILON) * 100) / 100;
                    const creditRounded = Math.round((creditedTotal + Number.EPSILON) * 100) / 100;
                    // displayAmount = available (credited - used) — same shown in Faturas card
                    const displayAmount = Math.max(0, Math.round((creditRounded - usedRounded) * 100) / 100);
                    const valuesEl = document.getElementById('kpi-vr-values'); if (valuesEl) valuesEl.textContent = formatCurrency(displayAmount);
                    const progressEl = document.getElementById('kpi-vr-progress');
                    const barTextEl = document.getElementById('kpi-vr-bar-text');
                    if (progressEl) {
                        const pctRaw = creditRounded > 0 ? (usedRounded / creditRounded) : 0;
                        const pct = Math.min(1, Math.max(0, pctRaw));
                        progressEl.style.width = `${Math.round(pct * 100)}%`;
                        // Color thresholds: green <75%, yellow 75-99%, red >=100%
                        progressEl.classList.remove('bg-green-500','bg-yellow-400','bg-red-500');
                        if (pctRaw >= 1) progressEl.classList.add('bg-red-500');
                        else if (pctRaw >= 0.75) progressEl.classList.add('bg-yellow-400');
                        else progressEl.classList.add('bg-green-500');
                        // tooltip with percent
                        try { progressEl.title = `${Math.round((pctRaw)*100)}% utilizado (${formatCurrency(usedRounded)} de ${formatCurrency(creditRounded)})`; } catch(e){}
                    }
                    if (barTextEl) {
                        // show spent amount centered over the bar with percentage used
                        const pctDisplay = Math.round((creditRounded > 0 ? (usedRounded / creditRounded) : 0) * 100);
                        barTextEl.textContent = `${formatCurrency(usedRounded)} (${pctDisplay}% gasto)`;
                    }
                } catch(e) { console.error('updateKPIs vr kpi', e); }
                // VT KPI: mirror VR logic for VT
                try {
                    const vtCredited = (monthData.vtLedger || []).reduce((s, l) => s + (Number(l && l.amount) || 0), 0);
                    let vtUsed = (monthData.vtUsage || []).reduce((s, u) => s + (Number(u && u.amount) || 0), 0);
                    try { const expensesVT = (monthData.expenses || []).filter(e => paymentMatches(e.payment || '', 'VT')); vtUsed += expensesVT.reduce((s,e) => s + (Number(e && e.amount) || 0), 0); } catch(e){}
                    const vtUsedRounded = Math.round((vtUsed + Number.EPSILON) * 100) / 100;
                    const vtCreditRounded = Math.round((vtCredited + Number.EPSILON) * 100) / 100;
                    const vtDisplay = Math.max(0, Math.round((vtCreditRounded - vtUsedRounded) * 100) / 100);
                    const vtValuesEl = document.getElementById('kpi-vt-values'); if (vtValuesEl) vtValuesEl.textContent = formatCurrency(vtDisplay);
                    const vtProgressEl = document.getElementById('kpi-vt-progress');
                    const vtBarTextEl = document.getElementById('kpi-vt-bar-text');
                    if (vtProgressEl) {
                        const pctRaw = vtCreditRounded > 0 ? (vtUsedRounded / vtCreditRounded) : 0;
                        const pct = Math.min(1, Math.max(0, pctRaw));
                        vtProgressEl.style.width = `${Math.round(pct * 100)}%`;
                        vtProgressEl.classList.remove('bg-yellow-500','bg-yellow-400','bg-red-500');
                        if (pctRaw >= 1) vtProgressEl.classList.add('bg-red-500');
                        else if (pctRaw >= 0.75) vtProgressEl.classList.add('bg-yellow-500');
                        else vtProgressEl.classList.add('bg-yellow-400');
                        try { vtProgressEl.title = `${Math.round((pctRaw)*100)}% utilizado (${formatCurrency(vtUsedRounded)} de ${formatCurrency(vtCreditRounded)})`; } catch(e){}
                    }
                    if (vtBarTextEl) {
                        const pctDisplayVT = Math.round((vtCreditRounded > 0 ? (vtUsedRounded / vtCreditRounded) : 0) * 100);
                        vtBarTextEl.textContent = `${formatCurrency(vtUsedRounded)} (${pctDisplayVT}% gasto)`;
                    }
                } catch(e) { console.error('updateKPIs vt kpi', e); }
            } catch (e) {
                console.error('updateKPIs error', e);
            }
        }

        function getFeedback(income, expenses, savings) {
            try {
                const settings = state.appData && state.appData.settings ? state.appData.settings : {};
                const feedbackMessages = settings.feedbackMessages || [];
                const spendingGoals = settings.spendingGoals || [];
                let feedbackId = 'B'; // default

                if (income > 0) {
                    const savingGoal = (spendingGoals.find(g => g.type === 'Reserva') || {}).goal || 0;
                    const nonEssentialGoal = (spendingGoals.find(g => g.type === 'Não Essenciais') || {}).goal || 0;
                    const essentialGoal = (spendingGoals.find(g => g.type === 'Essenciais') || {}).goal || 0;

                    if ((income - expenses - savings) < 0) feedbackId = 'F';
                    else if (savings < income * savingGoal) feedbackId = 'E';
                    else if (expenses > income * (nonEssentialGoal + essentialGoal)) feedbackId = 'C';
                    else feedbackId = 'B';
                }

                const msg = (feedbackMessages.find(m => m.id === feedbackId) || {}).text || '';
                if (ui.feedbackMessage) ui.feedbackMessage.textContent = msg;
            } catch (e) {
                console.error('getFeedback error', e);
            }
        }

        function animateKPINumber(id, newValue) {
            const el = document.getElementById(id);
            if (!el) return;
            const last = typeof el._lastValue === 'number' ? el._lastValue : (parseFloat((el.textContent || '0').replace(/[\D]/g, '').replace(',', '.')) || 0);
            const duration = 700;
            const frameRate = 30;
            const steps = Math.max(1, Math.round(duration / (1000 / frameRate)));
            let step = 0;
            const diff = newValue - last;

            // Add animation class
            if (diff > 0) {
                el.classList.add('kpi-animate-up');
            } else if (diff < 0) {
                el.classList.add('kpi-animate-down');
            } else {
                el.classList.add('kpi-animate');
            }

            const animate = () => {
                step++;
                const val = last + diff * (step / steps);
                el.textContent = formatCurrency(val);
                if (step < steps) {
                    setTimeout(animate, 1000 / frameRate);
                } else {
                    el.textContent = formatCurrency(newValue);
                    el._lastValue = newValue;
                    el.classList.remove('kpi-animate');
                    el.classList.remove('kpi-animate-up');
                    el.classList.remove('kpi-animate-down');
                }
            };
            animate();
        }

        function destroyChart(chartId) {
            if (ui.charts && ui.charts[chartId]) {
                try { ui.charts[chartId].destroy(); } catch(e) { /* ignore */ }
                delete ui.charts[chartId];
            }
        }

        function renderCharts() {
            // Defensive: if Chart is not available, skip rendering charts
            if (typeof Chart === 'undefined') return;
            // renderSpendingGoalsChart(); // removed (Metas de Gastos removed)
            renderCategorySpendingChart();
            renderPaymentMethodChart();
            renderAnnualSummaryChart();
        }

        // renderSpendingGoalsChart removed (Metas de Gastos KPI no longer used)

        function renderCategorySpendingChart() {
            try {
                destroyChart('category-spending-chart');
                const monthData = getCurrentMonthData();
                const expenses = monthData.expenses || [];
                const categorySpending = expenses.reduce((acc, exp) => { acc[exp.category] = (acc[exp.category] || 0) + (exp.amount || 0); return acc; }, {});
                const ctx = document.getElementById('category-spending-chart'); if (!ctx) return;
                ui.charts['category-spending-chart'] = new Chart(ctx.getContext('2d'), { type:'pie', data:{ labels:Object.keys(categorySpending), datasets:[{ data:Object.values(categorySpending), backgroundColor:['#EF4444','#F97316','#84CC16','#22C55E','#14B8A6','#06B6D4','#6366F1','#D946EF'] }] }, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}} });
            } catch(e){console.error('renderCategorySpendingChart', e)}
        }

        function renderPaymentMethodChart() {
            try {
                destroyChart('payment-method-chart');
                const monthData = getCurrentMonthData();
                const expenses = monthData.expenses || [];
                const paymentSpending = expenses.reduce((acc, exp) => { const k = (typeof getPaymentLabel === 'function') ? getPaymentLabel(exp.payment || '') : (exp.payment || ''); acc[k] = (acc[k] || 0) + (exp.amount || 0); return acc; }, {});
                const ctx = document.getElementById('payment-method-chart'); if (!ctx) return;
                ui.charts['payment-method-chart'] = new Chart(ctx.getContext('2d'), { type:'pie', data:{ labels:Object.keys(paymentSpending), datasets:[{ data:Object.values(paymentSpending), backgroundColor:['#6D28D9','#BE185D','#047857','#B45309','#1E3A8A'] }] }, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}} });
            } catch(e){console.error('renderPaymentMethodChart', e)}
        }

        // helper: compute month outcome using card invoice totals (to keep annual totals consistent with faturas)
        function invoiceAwareOutcomeForMonth(year, month, monthData) {
            try {
                const expenses = (monthData && monthData.expenses) || [];
                const savingsSum = (monthData && monthData.savings || []).reduce((s,t)=>s+(t.amount||0),0);
                const paymentMethods = (state.appData.settings && state.appData.settings.paymentMethods) || [];
                const cardMethods = paymentMethods.filter(p => p.type === 'credit_card');
                // non-card expenses: any expense that does not match a configured card (tolerant match)
                const nonCardExpensesSum = expenses.filter(e => !cardMethods.some(c => paymentMatches(e.payment || '', c.name))).reduce((s,t)=>s+(t.amount||0),0);
                const cardAnticipations = (state.appData.data[year] && state.appData.data[year][month] && state.appData.data[year][month].cardAnticipations) || {};
                let totalInvoices = 0;
                cardMethods.forEach(card => {
                    const cardExpenses = expenses.filter(e => paymentMatches(e.payment || '', card.name));
                    const totalBeforeAnticipation = cardExpenses.reduce((s,t)=>s+(t.amount||0),0);
                    const anticipated = Number(cardAnticipations[card.name] || 0);
                    const invoiceTotal = Math.round(((totalBeforeAnticipation - anticipated) + Number.EPSILON) * 100) / 100;
                    totalInvoices += invoiceTotal;
                });
                return nonCardExpensesSum + totalInvoices + savingsSum;
            } catch(e) { console.error('invoiceAwareOutcomeForMonth', e); return ((monthData.expenses||[]).reduce((s,t)=>s+(t.amount||0),0)) + ((monthData.savings||[]).reduce((s,t)=>s+(t.amount||0),0)); }
        }

        function renderAnnualSummaryChart() {
            try {
                const year = state.currentDate.getFullYear();
                destroyChart('annual-summary-chart');
                const yearData = state.appData.data[state.currentDate.getFullYear()] || {};
                const months = Array.from({length:12},(_,i)=>String(i+1).padStart(2,'0'));
                const monthlyTotals = { incomes: [], expenses: [], balance: [] };
                months.forEach(month => {
                    const monthData = yearData[month] || {};
                    const income = (monthData.incomes || []).reduce((s,t)=>s+(t.amount||0),0);
                    const expense = invoiceAwareOutcomeForMonth(year, month, monthData);
                    monthlyTotals.incomes.push(income); monthlyTotals.expenses.push(expense); monthlyTotals.balance.push(income-expense);
                });
                const ctx = document.getElementById('annual-summary-chart'); if (!ctx) return;
                const asData = {
                    labels: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],
                    datasets: [
                        { label: 'Entradas', data: monthlyTotals.incomes, backgroundColor: '#22C55E' },
                        { label: 'Saídas', data: monthlyTotals.expenses, backgroundColor: '#EF4444' }
                    ]
                };
                const asOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                generateLabels: function(chart){
                                    try {
                                        const ds = chart.data.datasets || [];
                                        return ds.map((d, idx) => {
                                            const sum = (d.data || []).reduce((s, v) => s + (v || 0), 0);
                                            return { text: d.label + ' (' + formatCurrency(sum) + ')', fillStyle: d.backgroundColor, hidden: chart.getDatasetMeta(idx).hidden, index: idx };
                                        });
                                    } catch (e) {
                                        return Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: { stacked: true, ticks: { callback: function(v){ return formatCurrency(v); } }, beginAtZero: true }
                    },
                    elements: { bar: { borderRadius: 6 } },
                    layout: { padding: { top: 6, bottom: 6 } }
                };
                ui.charts['annual-summary-chart'] = new Chart(ctx.getContext('2d'), { type: 'bar', data: asData, options: asOptions });
            } catch(e){console.error('renderAnnualSummaryChart', e)}
        }

        // Report-specific charts
        function renderMonthlyReportCategoryChart() {
            try {
                destroyChart('mr-category-breakdown-chart');
                const monthData = getCurrentMonthData();
                const expenses = monthData.expenses || [];
                const byCategory = expenses.reduce((acc, e) => { acc[e.category] = (acc[e.category]||0) + (e.amount||0); return acc; }, {});
                const entries = Object.keys(byCategory).map(k => ({ category: k, value: byCategory[k] }));
                // sort descending by value so legend and pie render from largest to smallest
                entries.sort((a,b) => (b.value||0) - (a.value||0));
                const labels = entries.map(e => e.category);
                const dataVals = entries.map(e => e.value);
                const colors = ['#EF4444','#F97316','#84CC16','#22C55E','#14B8A6','#06B6D4','#6366F1','#D946EF'];
                const ctx = document.getElementById('mr-category-breakdown-chart'); if (!ctx || labels.length === 0 || typeof Chart === 'undefined') return;
                const mrData = { labels: labels, datasets: [{ data: dataVals, backgroundColor: colors.slice(0, labels.length) }] };
                const mrOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                generateLabels: function(chart){
                                    try {
                                        const data = chart.data;
                                        const ds = (data.datasets && data.datasets[0] && data.datasets[0].data) || [];
                                        const total = ds.reduce((s,v)=>s+(v||0),0) || 1;
                                        return (data.labels || []).map((lab, i) => {
                                            const val = ds[i] || 0;
                                            const pct = Math.round((val/total)*100);
                                            return { text: lab + ' (' + pct + '%)', fillStyle: (data.datasets[0].backgroundColor||[])[i], hidden: chart.getDataVisibility(i) === false, index: i };
                                        });
                                    } catch (e) {
                                        return Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                    }
                                }
                            }
                        }
                    }
                };
                ui.charts['mr-category-breakdown-chart'] = new Chart(ctx.getContext('2d'), { type: 'pie', data: mrData, options: mrOptions });
            } catch(e){console.error('renderMonthlyReportCategoryChart', e)}
        }

        function renderAnnualBalanceEvolutionChart() {
            try {
                destroyChart('ar-balance-evolution-chart');
                const year = state.currentDate.getFullYear();
                const yearData = state.appData.data[year] || {};
                const months = Array.from({length:12},(_,i)=>String(i+1).padStart(2,'0'));
                const balances = months.map(m => {
                    const md = yearData[m] || { incomes: [], expenses: [], savings: [] };
                    const inc = (md.incomes || []).reduce((s,t)=>s+(t.amount||0),0);
                    const out = invoiceAwareOutcomeForMonth(year, m, md);
                    return inc - out;
                });
                const ctx = document.getElementById('ar-balance-evolution-chart'); if (!ctx || typeof Chart === 'undefined') return;
                const arData = {
                    labels: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],
                    datasets: [{ label: 'Saldo Mensal', data: balances, borderColor: '#2563EB', tension: 0.2, pointRadius: 3, pointHoverRadius: 6 }]
                };
                const arOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                generateLabels: function(chart){
                                    try{
                                        const d = chart.data.datasets && chart.data.datasets[0];
                                        const last = (d && d.data && d.data.length) ? d.data[d.data.length-1] : 0;
                                        return [{ text: d.label + ' (último: ' + formatCurrency(last) + ')', fillStyle: d.borderColor, hidden: chart.getDatasetMeta(0).hidden, index: 0 }];
                                    }catch(e){
                                        return Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                    }
                                }
                            }
                        }
                    },
                    scales: { y: { ticks: { callback: function(v){ return formatCurrency(v); } } }, x: { ticks: { maxRotation: 0, autoSkip: true } } },
                    elements: { line: { tension: 0.2 } },
                    layout: { padding: { top: 8, bottom: 6 } }
                };
                ui.charts['ar-balance-evolution-chart'] = new Chart(ctx.getContext('2d'), { type: 'line', data: arData, options: arOptions });
            } catch(e){console.error('renderAnnualBalanceEvolutionChart', e)}
        }

        function renderAnnualAvgCategoryChart() {
            try {
                destroyChart('ar-avg-category-spending-chart');
                const year = state.currentDate.getFullYear();
                const yearData = state.appData.data[year] || {};
                // compute average monthly spending per category
                const categories = {};
                const months = Object.keys(yearData);
                months.forEach(m => {
                    const md = yearData[m] || { expenses: [] };
                    (md.expenses || []).forEach(e => { categories[e.category] = (categories[e.category]||0) + (e.amount||0); });
                });
                const avg = {};
                months.forEach(() => {});
                Object.keys(categories).forEach(cat => { avg[cat] = categories[cat] / Math.max(1, months.length); });
                const ctx = document.getElementById('ar-avg-category-spending-chart'); if (!ctx || Object.keys(avg).length === 0 || typeof Chart === 'undefined') return;
                const acData = { labels: Object.keys(avg), datasets: [{ label: 'Média Mensal', data: Object.values(avg), backgroundColor: '#F59E0B' }] };
                const acOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                generateLabels: function(chart){
                                    try{
                                        const d = chart.data.datasets && chart.data.datasets[0];
                                        const sum = (d && d.data) ? d.data.reduce((s,v)=>s+(v||0),0) : 0;
                                        return [{ text: d.label + ' (' + formatCurrency(sum) + ')', fillStyle: d.backgroundColor, hidden: chart.getDatasetMeta(0).hidden, index: 0 }];
                                    }catch(e){
                                        return Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                    }
                                }
                            }
                        }
                    },
                    scales: { y: { ticks: { callback: function(v){ return formatCurrency(v); } }, beginAtZero: true }, x: { ticks: { autoSkip: true } } },
                    layout: { padding: { top: 6, bottom: 6 } }
                };
                ui.charts['ar-avg-category-spending-chart'] = new Chart(ctx.getContext('2d'), { type: 'bar', data: acData, options: acOptions });
            } catch(e){console.error('renderAnnualAvgCategoryChart', e)}
        }

        // end KPIs & charts

        function renderMonthDisplay() {
            ui.currentMonthDisplay.textContent = state.currentDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase());
        }

        // Month picker helpers
        function populateMonthPicker() {
            try {
                const yearSelect = ui.monthPickerYear;
                if (!yearSelect) return;
                yearSelect.innerHTML = '';
                const currentYear = state.currentDate.getFullYear();
                // show a range of years: currentYear -5 .. currentYear +5
                for (let y = currentYear - 5; y <= currentYear + 5; y++) {
                    const opt = document.createElement('option');
                    opt.value = y;
                    opt.textContent = y;
                    yearSelect.appendChild(opt);
                }
                // set selects to current date
                if (ui.monthPickerMonth) ui.monthPickerMonth.value = String(state.currentDate.getMonth());
                yearSelect.value = String(currentYear);
            } catch (e) { console.error('populateMonthPicker', e); }
        }

        // We'll move the picker to document.body when opened to avoid stacking context issues
        (function(){
            let _originalParent = null;
            let _originalNext = null;
            window.__monthPickerDetached = false;
            function _attachToBody(picker, trigger) {
                if (!picker) return;
                if (!_originalParent) {
                    _originalParent = picker.parentNode;
                    _originalNext = picker.nextSibling;
                }
                document.body.appendChild(picker);
                // On mobile, center the picker fixed to avoid off-screen clipping. On desktop keep absolute aligned to trigger.
                if (window.innerWidth <= 639) {
                    picker.style.position = 'fixed';
                    picker.style.left = '50%';
                    picker.style.top = '18%';
                    picker.style.transform = 'translateX(-50%)';
                    picker.style.width = 'calc(100% - 2rem)';
                    picker.style.maxWidth = '360px';
                    picker.style.right = '';
                } else {
                    picker.style.position = 'absolute';
                    // compute position to align under trigger (right aligned)
                    try {
                        const rect = trigger.getBoundingClientRect();
                        const top = rect.bottom + window.scrollY + 8; // small gap
                        const right = window.innerWidth - (rect.right + window.scrollX);
                        picker.style.top = top + 'px';
                        picker.style.right = right + 'px';
                        picker.style.transform = '';
                    } catch (e) { /* ignore */ }
                }
                window.__monthPickerDetached = true;
            }
            function _restoreParent(picker) {
                if (!picker || !_originalParent) return;
                picker.style.position = '';
                picker.style.top = '';
                picker.style.right = '';
                picker.style.zIndex = '';
                if (_originalNext && _originalNext.parentNode === _originalParent) {
                    _originalParent.insertBefore(picker, _originalNext);
                } else {
                    _originalParent.appendChild(picker);
                }
                _originalParent = null; _originalNext = null; window.__monthPickerDetached = false;
            }

            window.openMonthPicker = function() {
                try {
                    const picker = ui.monthPicker;
                    if (!picker || !ui.currentMonthDisplay) return;
                    populateMonthPicker();
                    _attachToBody(picker, ui.currentMonthDisplay);
                    picker.classList.remove('hidden');
                    setTimeout(() => { if (ui.monthPickerMonth) ui.monthPickerMonth.focus(); }, 50);
                } catch (e) { console.error('openMonthPicker', e); }
            };

            window.closeMonthPicker = function() {
                try {
                    const picker = ui.monthPicker;
                    if (!picker) return;
                    picker.classList.add('hidden');
                    if (window.__monthPickerDetached) _restoreParent(picker);
                } catch (e) { console.error('closeMonthPicker', e); }
            };
        })();

        function closeMonthPicker() {
            try { if (ui.monthPicker) ui.monthPicker.classList.add('hidden'); } catch (e) { console.error('closeMonthPicker', e); }
        }

        function applyMonthPicker() {
            try {
                if (!ui.monthPickerMonth || !ui.monthPickerYear) return;
                const month = parseInt(ui.monthPickerMonth.value, 10);
                const year = parseInt(ui.monthPickerYear.value, 10);
                if (isNaN(month) || isNaN(year)) return;
                state.currentDate = new Date(year, month, 1);
                render();
                closeMonthPicker();
            } catch (e) { console.error('applyMonthPicker', e); }
        }

        function updateSortHeaders() {
            ui.expensesTableHead.querySelectorAll('.sortable-header').forEach(header => {
                const icon = header.querySelector('.sort-icon');
                if (!icon) return; // skip if icon not present
                if (header.dataset.sort === state.sort.key) {
                    header.classList.add('sorted');
                    icon.textContent = state.sort.order === 'asc' ? 'arrow_upward' : 'arrow_downward';
                } else {
                    header.classList.remove('sorted');
                    icon.textContent = '';
                }
            });
        }

        // --- DATA & STATE MANAGEMENT ---

        function goToDate(date) {
            state.currentDate = new Date(date.getFullYear(), date.getMonth(), 1);
            render();
        }

        function changeMonth(direction) {
            state.currentDate.setMonth(state.currentDate.getMonth() + direction);
            render();
               }

        // Jump to the month of the last installment of a financing/installment group
        function goToLastInstallment({ financingId = null, installmentId = null } = {}) {
            try {
                // Collect all matching installments and find the one with the latest date
                let last = null; // { year, month, id }
                // Iterate over state data to find the last installment
                Object.keys(state.appData.data).forEach(year => {
                    Object.keys(state.appData.data[year]).forEach(month => {
                        const monthData = state.appData.data[year][month];
                        const expenses = monthData.expenses || [];
                        expenses.forEach(exp => {
                            if (financingId && exp.financingId === financingId) {
                                const candidate = { year: Number(year), month: Number(month) };
                                if (!last || candidate.year > last.year || (candidate.year === last.year && candidate.month > last.month)) {
                                    last = { year: candidate.year, month: candidate.month, id: exp.id };
                                }
                            } else if (installmentId && exp.installmentId === installmentId) {
                                const candidate = { year: Number(year), month: Number(month) };
                                if (!last || candidate.year > last.year || (candidate.year === last.year && candidate.month > last.month)) {
                                    last = { year: candidate.year, month: candidate.month, id: exp.id };
                                }
                            }
                        });
                    });
                });

                if (!last) return; // nothing found

                // Navigate to that month
                const target = new Date(last.year, last.month - 1, 1);
                goToDate(target);
                // After render, highlight the row briefly
                requestAnimationFrame(() => {
                    const row = ui.expensesTableBody.querySelector(`tr[data-id="${last.id}"]`);
                    if (row) {
                        row.classList.add('ring-2', 'ring-blue-300');
                        setTimeout(() => row.classList.remove('ring-2', 'ring-blue-300'), 2000);
                        // Scroll the page to top so the month header is visible
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                });
            } catch (e) {
                console.error('goToLastInstallment error', e);
            }
        }

        function getCurrentMonthData(date = state.currentDate) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            
            // Com a nova `loadData`, state.appData.data sempre existirá.
            // Apenas precisamos garantir que o mês/ano específico exista para evitar erros.
            if (!state.appData.data[year]) {
                state.appData.data[year] = {};
            }
            if (!state.appData.data[year][month]) {
                state.appData.data[year][month] = { incomes: [], expenses: [], savings: [] };
            }
            
            return state.appData.data[year][month];
        }
        
        function handleSort(key) {
            if (state.sort.key === key) {
                state.sort.order = state.sort.order === 'asc' ? 'desc' : 'asc';
            } else {
                state.sort.key = key;
                state.sort.order = 'asc';
            }
            renderExpenseTable();
        }

        function handleTableClick(event, type) {
            const row = event.target.closest('tr');
            if (!row) return;
            const id = row.dataset.id;
            if (event.target.closest('.edit-btn') && !event.target.closest('.edit-btn').disabled) {
                openModal(type, id);
            } else if (event.target.closest('.delete-btn')) {
                deleteTransaction(type, id);
            } else if (event.target.classList.contains('paid-checkbox')) {
                togglePaidStatus(id);
            }
        }

        async function togglePaidStatus(id) {
            const expense = getCurrentMonthData().expenses.find(exp => exp.id === id);
            if (expense) {
                expense.isPaid = !expense.isPaid;
                try {
                    await storage.saveData(state.appData);
                } catch (e) {
                    console.error('Erro ao atualizar status pago:', e);
                    showToast('Falha ao atualizar status no Firebase.', 'bg-red-600');
                }
                render();
            }
        }

        // --- MODALS & UI HELPERS (implementações defensivas) ---
        // openModal now accepts an optional prefill object: { payment, description, amount, focusDescription }
        function openModal(type, id = null, prefill = null) {
            try {
                const modal = ui.transactionModal;
                if (!modal) return;
                // Reset and populate
                if (ui.transactionForm) ui.transactionForm.reset();
                clearTransactionError();
                if (document.getElementById('transaction-id')) document.getElementById('transaction-id').value = '';
                populateDropdowns();
                toggleTransactionType(type || 'expenses');
                // If editing, populate fields
                if (id) {
                    document.getElementById('modal-title').textContent = 'Editar Transação';
                    populateModal(type, id);
                } else {
                    document.getElementById('modal-title').textContent = 'Nova Transação';
                    // Apply session-aware defaults: prefer last used in-session values when present
                    if (!prefill) prepareModalForNextEntry();
                }
                // Show modal
                modal.showModal();

                // Apply optional prefill values deterministically (no timeouts)
                try {
                    if (prefill && typeof prefill === 'object') {
                        const pm = document.getElementById('payment-method');
                        const desc = document.getElementById('description');
                        const cat = document.getElementById('category-expense');

                        if (pm && prefill.payment) {
                            pm.value = prefill.payment;
                            // Dispatch change so existing handlers (which enforce VR/VT rules) run
                            try { pm.dispatchEvent(new Event('change', { bubbles: true })); } catch (e) { try { pm.dispatchEvent(new Event('change')); } catch(e){} }
                        }

                        // If prefill provided a category explicitly, set it
                        if (cat && prefill.category) {
                            try { cat.value = prefill.category; } catch(e){}
                        }

                        // If payment is VT and no explicit description provided, enforce 'Abastecimento'
                        if ((prefill.payment === 'VT') && desc && (prefill.description === undefined || prefill.description === null || prefill.description === '')) {
                            try { desc.value = 'Abastecimento'; } catch(e){}
                        } else if (desc && (prefill.description !== undefined)) {
                            desc.value = prefill.description;
                        }

                        if (prefill.amount !== undefined) {
                            const amt = document.getElementById('amount'); if (amt) amt.value = prefill.amount;
                        }
                        // prefill recipient if provided
                        if (prefill.recipient) {
                            const r = document.getElementById('payment-recipient');
                            if (r) r.value = prefill.recipient;
                        }
                        // If requested, focus and select description
                        if (desc && (prefill.focusDescription || prefill.description !== undefined)) {
                            try { desc.focus(); desc.select(); } catch (_) {}
                        }
                    }
                } catch (e) { console.error('openModal apply prefill', e); }

                // Run description detector once to auto-open salary options if description already contains 'salário'
                try {
                    const descInput = document.getElementById('description');
                    if (descInput) {
                        const ev = new Event('input', { bubbles: true });
                        descInput.dispatchEvent(ev);
                    }
                } catch (e) { console.error('openModal run description detector', e); }
            } catch (e) { console.error('openModal', e); }
        }

        function closeModal(modalId) {
            try {
                const el = document.getElementById(modalId);
                if (el && typeof el.close === 'function') el.close();
                // clear any inline error when closing
                clearTransactionError();
                // remove dynamic buttons if present
                const btn = document.getElementById('conclude-financing-btn'); if (btn && btn.parentNode) btn.parentNode.removeChild(btn);
            } catch (e) { console.error('closeModal', e); }
        }

        function populateDropdowns() {
            try {
                const settings = state.appData.settings || {};
                const paymentMethods = settings.paymentMethods || [];
                // If current month has VR balance registered, add a virtual payment method 'VR'
                const md = getCurrentMonthData();
                const vrAmount = md ? getMonthVRBalance(md) : 0;
                // VR as a selectable paymentMethod should be an object with type 'vr'
                const vrOptionObj = { name: 'VR', type: 'vr', available: vrAmount };
                // Merge payments but avoid duplicate VR entries
                const mergedPayments = (paymentMethods || []).slice();
                if (!mergedPayments.find(p => (p && p.name) === 'VR')) mergedPayments.push(vrOptionObj);
                // VT: same approach as VR
                const vtAmount = md ? getMonthVTBalance(md) : 0;
                const vtOptionObj = { name: 'VT', type: 'vt', available: vtAmount };
                if (!mergedPayments.find(p => (p && p.name) === 'VT')) mergedPayments.push(vtOptionObj);
                const expenseCategories = settings.expenseCategories || [];
                const savingCategories = settings.savingCategories || [];
                const goals = settings.goals || [];
                // Ensure Alimentação category exists in settings so it's available in the dropdown
                const normalize = s => (s || '').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
                const hasAlim = expenseCategories.some(c => normalize(c).includes('aliment'));
                if (!hasAlim) {
                    try {
                        // Add Alimentação to settings and persist once
                        settings.expenseCategories = settings.expenseCategories || [];
                        settings.expenseCategories.push('Alimentação');
                        state.appData.settings = settings;
                        // Save asynchronously but do not block UI
                        storage.saveData(state.appData).then(() => { showToast('Categoria Alimentação adicionada às configurações.', 'bg-green-600'); }).catch(() => {});
                    } catch (e) { console.error('failed to persist alimentação category', e); }
                }
                // Sort lists alphabetically for consistent UX
                const paymentsSorted = sortStrings((mergedPayments || []).map(p => p.name || ''));
                const expenseCatsSorted = sortStrings(expenseCategories || []);
                const savingCatsSorted = sortStrings(savingCategories || []);
                const goalsSorted = sortStrings(goals.map(g => g.name || ''));
                // Build payment method options from mergedPayments so VR is always present
                if (ui.paymentMethod) {
                    ui.paymentMethod.innerHTML = paymentsSorted.map(n => `<option value="${n}">${n}</option>`).join('');
                    // If a visual icon-select overlay exists, refresh its list so the visible UI stays in sync
                    try { if (typeof ui.paymentMethod._refreshIconSelect === 'function') ui.paymentMethod._refreshIconSelect(); } catch(e){}
                    // Ensure recipient visibility reflects the (possibly new) selected payment
                    try { if (window.toggleRecipientForPayment) window.toggleRecipientForPayment(ui.paymentMethod.value); } catch(e){}
                }
                if (ui.categoryExpense) ui.categoryExpense.innerHTML = expenseCatsSorted.map(c => `<option value="${c}">${c}</option>`).join('');
                if (ui.categorySaving) {
                    let savingOptions = savingCatsSorted.map(c => `<option value="${c}">${c}</option>`);
                    if (goalsSorted.length) savingOptions = savingOptions.concat(goalsSorted.map(g => `<option value="${g}">${g} (Meta)</option>`));
                    ui.categorySaving.innerHTML = savingOptions.join('');
                }
                // attempt to refresh other icon-select overlays if present
                try { if (ui.categoryExpense && typeof ui.categoryExpense._refreshIconSelect === 'function') ui.categoryExpense._refreshIconSelect(); } catch(e){}
                try { if (ui.categorySaving && typeof ui.categorySaving._refreshIconSelect === 'function') ui.categorySaving._refreshIconSelect(); } catch(e){}
                try { const fpm = document.getElementById('filter-payment-method'); if (fpm && typeof fpm._refreshIconSelect === 'function') fpm._refreshIconSelect(); } catch(e){}
                try { const fcat = document.getElementById('filter-category'); if (fcat && typeof fcat._refreshIconSelect === 'function') fcat._refreshIconSelect(); } catch(e){}
            } catch (e) { console.error('populateDropdowns', e); }
        }

        function toggleTransactionType(type) {
            try {
                if (!ui.transactionTypeInput) return;
                ui.transactionTypeInput.value = type;
                if (ui.modalTypeToggles) ui.modalTypeToggles.forEach(btn => btn.classList.toggle('tab-active', btn.dataset.type === type));
                if (ui.expenseFields) {
                    ui.expenseFields.classList.toggle('hidden', type !== 'expenses');
                    ui.expenseFields.classList.toggle('section-hidden-smooth', type !== 'expenses');
                }
                if (ui.savingFields) {
                    ui.savingFields.classList.toggle('hidden', type !== 'savings');
                    ui.savingFields.classList.toggle('section-hidden-smooth', type !== 'savings');
                }
                // Show salary section only for incomes
                const salarySection = document.getElementById('salary-section');
                const isSalaryCheckbox = document.getElementById('is-salary');
                const salaryFields = document.getElementById('salary-fields');
                if (salarySection) salarySection.classList.toggle('hidden', type !== 'incomes');
                // When switching types away from incomes, reset salary checkbox and hide fields
                if (type !== 'incomes' && isSalaryCheckbox) {
                    isSalaryCheckbox.checked = false;
                    if (salaryFields) salaryFields.classList.add('hidden');
                    try { const modal = document.getElementById('transaction-modal'); if (modal) modal.classList.remove('modal-expanded'); } catch(e){}
                }
                // If switching to incomes and the salary checkbox exists and is checked, expand modal
                if (type === 'incomes' && isSalaryCheckbox && isSalaryCheckbox.checked) {
                    try { const modal = document.getElementById('transaction-modal'); if (modal) modal.classList.add('modal-expanded'); } catch(e){}
                }
                if (ui.advancedOptions) ui.advancedOptions.classList.remove('hidden');
                if (ui.installmentsSection) ui.installmentsSection.classList.toggle('hidden', type !== 'expenses');
                // Adjust financing visibility
                if (ui.financingSection) ui.financingSection.classList.toggle('hidden', type !== 'expenses');
            } catch (e) { console.error('toggleTransactionType', e); }
        }

        // Salary breakdown modal helpers
        function openSalaryBreakdown(income) {
            try {
                const modal = document.getElementById('salary-breakdown-modal');
                const contentEl = document.getElementById('salary-breakdown-content');
                const titleEl = document.getElementById('salary-breakdown-title');
                if (!modal || !contentEl || !titleEl) return;

                // Always compute for the currently viewed month
                const year = state.currentDate.getFullYear();
                const month = state.currentDate.getMonth() + 1;
                // Prefer salaryMeta coming from the currently viewed month (so hours/days reflect that month).
                // Fallback: use income.salaryMeta only if no salaryMeta exists in the current month's data.
                const md = getCurrentMonthData();
                let meta = null;
                try {
                    const combined = [];
                    if (Array.isArray(md.incomes)) combined.push(...md.incomes);
                    if (Array.isArray(md.vrLedger)) combined.push(...md.vrLedger);
                    if (Array.isArray(md.vtLedger)) combined.push(...md.vtLedger);
                    const found = combined.slice().reverse().find(x => x && x.salaryMeta);
                    if (found) meta = found.salaryMeta;
                } catch (e) { /* ignore search errors */ }
                // fallback to the income's meta if nothing found for this month
                if (!meta && income && income.salaryMeta) meta = income.salaryMeta;
                if (!meta) meta = {};

                // helper: parse hours input which may be a number (decimal) or string like "117:20"
                function parseHoursRaw(v) {
                    if (v === undefined || v === null || v === '') return undefined;
                    if (typeof v === 'number') return v;
                    const s = String(v).trim();
                    // support HH:MM
                    const m = /^\s*(\d{1,3}):([0-5]?\d)\s*$/.exec(s);
                    if (m) {
                        const hh = parseInt(m[1], 10);
                        const mm = parseInt(m[2], 10);
                        return hh + (mm / 60);
                    }
                    // support decimal with comma or dot
                    const dec = parseFloat(s.replace(/,/g, '.'));
                    if (!isNaN(dec)) return dec;
                    return undefined;
                }
                const parsedHours = parseHoursRaw(meta.hoursTrabalhadas || meta.horasTrabalhadas || meta.hoursWorked || meta.hours || '');
                const params = {
                    salarioBase: Number(meta.salarioBase || income.amount || 0),
                    percentualPericulosidade: Number(meta.percentualPericulosidade || 0),
                    outrosProventosTributaveis: Number(meta.outrosProventosTributaveis || 0),
                    numeroDependentes: Number(meta.numeroDependentes || 0),
                    valorDesjejumDia: Number(meta.valorDesjejumDia || 0),
                    valorTransporteDia: Number(meta.valorTransporteDia || 0),
                    diasTrabalhados: (typeof meta.diasTrabalhados !== 'undefined') ? Number(meta.diasTrabalhados) : undefined,
                    horasExtrasSabado: Number(meta.horasExtrasSabado || 0),
                    horasExtrasDomingo: Number(meta.horasExtrasDomingo || 0),
                    jornadaMensalHoras: Number(meta.jornadaMensalHoras || 220),
                    // pass month-specific hours if available (this impacts diasTrabalhados and valorHora)
                    hoursTrabalhadas: parsedHours,
                    year,
                    month
                };

                const calc = calcularSalarioLiquido(params);
                // Cache the calculated result by income id for tooltip reuse
                try { window.salaryCalcCache = window.salaryCalcCache || {}; if (income && income.id) window.salaryCalcCache[income.id] = calc; } catch(e){}
                const resumo = calc.resumo || {};
                const detalhe = calc.detalhe || {};

                // Insert navigation arrows similar to main header so user can move months while modal is open
                try {
                    // Abbreviated month with first letter uppercase (e.g. "Out 2025")
                    const _d = state.currentDate || new Date();
                    const monthNamesAbbrev = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
                    const monthLabel = `${monthNamesAbbrev[_d.getMonth()]} ${_d.getFullYear()}`;
                    // Title: keep only the income description and the abbreviated month; nav controls will be appended at the end
                    titleEl.innerHTML = `${income.description || 'Salário'} — <span id="salary-breakdown-month-label">${monthLabel}</span>`;
                    // create nav buttons container at the end of the title (grouped)
                    let navWrap = document.getElementById('salary-breakdown-nav-wrap');
                    if (!navWrap) {
                        navWrap = document.createElement('span');
                        navWrap.id = 'salary-breakdown-nav-wrap';
                        navWrap.className = 'ml-3 inline-flex items-center';
                        // append to title
                        titleEl.appendChild(navWrap);
                    }
                    // left, today, right buttons
                    let leftBtn = document.getElementById('salary-breakdown-prev');
                    let todayBtn = document.getElementById('salary-breakdown-today');
                    let rightBtn = document.getElementById('salary-breakdown-next');
                    if (!leftBtn) {
                        leftBtn = document.createElement('button');
                        leftBtn.id = 'salary-breakdown-prev';
                        leftBtn.className = 'p-1.5 rounded-full transition-colors hover:bg-gray-200 active:bg-gray-300';
                        leftBtn.title = 'Mês anterior';
                        leftBtn.innerHTML = '<span class="material-symbols-outlined">chevron_left</span>';
                        navWrap.appendChild(leftBtn);
                    }
                    if (!todayBtn) {
                        todayBtn = document.createElement('button');
                        todayBtn.id = 'salary-breakdown-today';
                        todayBtn.className = 'p-1.5 rounded-full transition-colors hover:bg-gray-200 active:bg-gray-300 mx-1';
                        todayBtn.title = 'Voltar para o mês atual';
                        todayBtn.innerHTML = '<span class="material-symbols-outlined">today</span>';
                        navWrap.appendChild(todayBtn);
                    }
                    if (!rightBtn) {
                        rightBtn = document.createElement('button');
                        rightBtn.id = 'salary-breakdown-next';
                        rightBtn.className = 'p-1.5 rounded-full transition-colors hover:bg-gray-200 active:bg-gray-300';
                        rightBtn.title = 'Próximo mês';
                        rightBtn.innerHTML = '<span class="material-symbols-outlined">chevron_right</span>';
                        navWrap.appendChild(rightBtn);
                    }
                    // handler to refresh modal content for new current month
                    const refreshModalForCurrentMonth = () => {
                        try {
                            // recompute using the same meta/income but with updated state.currentDate
                            const yearNow = state.currentDate.getFullYear();
                            const monthNow = state.currentDate.getMonth() + 1;
                            // update label
                            const lbl = document.getElementById('salary-breakdown-month-label');
                            if (lbl) lbl.textContent = state.currentDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                            // rebuild params and recalc: reuse meta and income
                            const parsedHoursNow = parseHoursRaw(meta.hoursTrabalhadas || meta.horasTrabalhadas || meta.hoursWorked || meta.hours || '');
                            const paramsNow = Object.assign({}, params, { year: yearNow, month: monthNow, hoursTrabalhadas: parsedHoursNow });
                            const newCalc = calcularSalarioLiquido(paramsNow);
                            // replace content by recursively calling the original builder: easiest is to set income and call openSalaryBreakdown again
                            // but to avoid stacking handlers, call content builder code path by updating params and re-executing this function's body up to contentEl.innerHTML
                            // Simple approach: set contentEl.innerHTML = '' and call openSalaryBreakdown(income) to rebuild modal
                            contentEl.innerHTML = '';
                            // slight delay to allow closing operations and avoid duplicate element IDs
                            setTimeout(() => openSalaryBreakdown(income), 0);
                        } catch (e) { console.error('refreshModalForCurrentMonth', e); }
                    };

                    // attach click handlers
                    leftBtn.onclick = (ev) => { ev.preventDefault(); changeMonth(-1); refreshModalForCurrentMonth(); };
                    rightBtn.onclick = (ev) => { ev.preventDefault(); changeMonth(1); refreshModalForCurrentMonth(); };
                    todayBtn.onclick = (ev) => { ev.preventDefault(); const now = new Date(); state.currentDate = new Date(now.getFullYear(), now.getMonth(), 1); refreshModalForCurrentMonth(); };
                } catch(e){ console.error('build modal title with nav', e); }

                // Determine whether VR/VT were previously edited (persisted) for this month so we only show the edit icon when relevant
                const roundLocal = (v) => Math.round((Number(v) + Number.EPSILON) * 100) / 100;
                // find ledger entries matching this salary meta (if present) or by description fallback
                const findVREntry = (Array.isArray(md.vrLedger) ? md.vrLedger.find(l => l && l.salaryMeta && JSON.stringify(l.salaryMeta) === JSON.stringify(meta)) : null) || (Array.isArray(md.vrLedger) ? md.vrLedger.find(l => l && (l.description || '').toLowerCase().includes('benefício') && (l.description || '').toLowerCase().includes('vr')) : null);
                const findVTEntry = (Array.isArray(md.vtLedger) ? md.vtLedger.find(l => l && l.salaryMeta && JSON.stringify(l.salaryMeta) === JSON.stringify(meta)) : null) || (Array.isArray(md.vtLedger) ? md.vtLedger.find(l => l && (l.description || '').toLowerCase().includes('benefício') && (l.description || '').toLowerCase().includes('vt')) : null);
                // compute defaults used for comparison before checking if persisted ledgers were edited
                const benDiasBase = diasUteisNoMes(year, month) + 1;
                const vrPerDay = Number(detalhe.beneficios && detalhe.beneficios.valorDesjejumDia || params.valorDesjejumDia || 0);
                const vtPerDay = Number(detalhe.beneficios && detalhe.beneficios.valorTransporteDia || params.valorTransporteDia || 0);
                const vrDefault = Math.round((vrPerDay * benDiasBase + Number.EPSILON) * 100) / 100;
                const vtDefault = Math.round((vtPerDay * benDiasBase + Number.EPSILON) * 100) / 100;
                const vrEdited = !!findVREntry && roundLocal(Number(findVREntry.amount || 0)) !== roundLocal(vrDefault);
                const vtEdited = !!findVTEntry && roundLocal(Number(findVTEntry.amount || 0)) !== roundLocal(vtDefault);
                const showDaysIcon = vrEdited || vtEdited;

                const pencilSvg = '<svg class="inline-block ml-1" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 21v-3.75L14.81 5.44a1.5 1.5 0 0 1 2.12 0l1.63 1.63a1.5 1.5 0 0 1 0 2.12L6.75 21H3z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                const vrIconHtml = vrEdited ? pencilSvg : '';
                const vtIconHtml = vtEdited ? pencilSvg : '';
                const daysIconHtml = showDaysIcon ? pencilSvg : '';

                // Build card-based layout for clarity
                let html = '';
                html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">`;

                // Left column: resumo (salário, descontos, líquido, remuneração, FGTS)
                html += `<div class="p-3 bg-white rounded shadow-sm">`;
                html += `<h4 class="font-semibold mb-2">Resumo</h4>`;
                html += `<div class="mb-1"><strong>Salário base:</strong> ${formatCurrency(Number(params.salarioBase) || 0)}</div>`;
                if (typeof params.hoursTrabalhadas !== 'undefined') {
                    // show hours used (decimal + HH:MM)
                    const hh = Math.floor(params.hoursTrabalhadas);
                    const mm = Math.round((params.hoursTrabalhadas - hh) * 60);
                    const mmPadded = String(mm).padStart(2, '0');
                    html += `<div class="mb-1 text-sm text-gray-600">Horas consideradas: ${params.hoursTrabalhadas.toFixed(2)} h (${hh}:${mmPadded})</div>`;
                }
                // Periculosidade (if present on the salary meta)
                const perc = Number(params.percentualPericulosidade || 0);
                if (perc && perc > 0) {
                    try {
                        const percVal = roundLocal((Number(params.salarioBase || 0) * perc) / 100);
                        html += `<div class="mb-1"><strong>Periculosidade (${perc}%):</strong> ${formatCurrency(percVal)}</div>`;
                    } catch(e) { /* ignore periculosidade render errors */ }
                }
                html += `<div class="mb-1"><strong>Salário bruto tributável:</strong> ${formatCurrency(Number(resumo.salarioBrutoTributavel || 0))}</div>`;
                // INSS: show total and effective percent relative to bruto
                const inssTotal = Number(detalhe.descontos && detalhe.descontos.inssTotal || detalhe.inssTotal || 0);
                const inssPercent = resumo.salarioBrutoTributavel ? ((inssTotal / Number(resumo.salarioBrutoTributavel)) * 100) : 0;
                html += `<div class="mb-1"><strong>INSS (total):</strong> ${formatCurrency(inssTotal)} (${inssPercent.toFixed(2)}%)</div>`;
                // IRRF
                const irrfValue = Number(detalhe.descontos && detalhe.descontos.irrfValue || detalhe.irrfValue || 0);
                html += `<div class="mb-1"><strong>IRRF:</strong> ${formatCurrency(irrfValue)}</div>`;
                html += `<div class="mb-1"><strong>Total descontos:</strong> ${formatCurrency(Number(resumo.totalDescontos || 0))}</div>`;
                html += `<div class="mb-2"><strong>Salário líquido:</strong> <span class="text-indigo-600 font-semibold">${formatCurrency(Number(resumo.salarioLiquido || 0))}</span></div>`;
                html += `<div class="mb-1"><strong>Benefícios (total):</strong> ${formatCurrency(Number(resumo.beneficiosTotais || 0))}</div>`;
                html += `<div class="mb-1"><strong>Remuneração total:</strong> ${formatCurrency(Number(resumo.remuneracaoTotal || 0))}</div>`;
                html += `<div class="mt-2 text-xs text-gray-500">FGTS (8% sobre o bruto tributável): ${formatCurrency(Number(detalhe.encargos && detalhe.encargos.fgts || 0))}</div>`;
                html += `</div>`;

                // Right column: cards for VR and VT benefits and detalhe de descontos
                html += `<div class="space-y-3">`;
                // base days and defaults are computed earlier (to support icon/display logic)

                html += `<div class="p-3 bg-white rounded shadow-sm">`;
                html += `<h4 class="font-semibold mb-2">Benefício VR (Desjejum)</h4>`;
                html += `<div class="mb-1">Valor por dia: ${formatCurrency(vrPerDay)}</div>`;
                html += `<div class="mb-1">Dias considerados: <span id="salary-days" class="text-indigo-600 cursor-pointer inline-block ml-2">${benDiasBase}${daysIconHtml ? ' ' + daysIconHtml : ''}</span></div>`;
                // show total VR as clickable value (click to edit)
                html += `<div class="mb-1"><label class="text-sm text-gray-600 inline">Total VR:</label> <span id="salary-vr-total" class="font-semibold text-indigo-600 cursor-pointer inline-block ml-2">${formatCurrency(vrDefault)}${vrIconHtml ? ' ' + vrIconHtml : ''}</span></div>`;
                html += `</div>`;

                html += `<div class="p-3 bg-white rounded shadow-sm">`;
                html += `<h4 class="font-semibold mb-2">Benefício VT (Transporte)</h4>`;
                html += `<div class="mb-1">Valor por dia: ${formatCurrency(vtPerDay)}</div>`;
                html += `<div class="mb-1">Dias considerados: <span class="salary-days-display text-indigo-600 cursor-pointer inline-block ml-2">${benDiasBase}${daysIconHtml ? ' ' + daysIconHtml : ''}</span></div>`;
                html += `<div class="mb-1"><label class="text-sm text-gray-600 inline">Total VT:</label> <span id="salary-vt-total" class="font-semibold text-indigo-600 cursor-pointer inline-block ml-2">${formatCurrency(vtDefault)}${vtIconHtml ? ' ' + vtIconHtml : ''}</span></div>`;
                html += `</div>`;

                // Combined benefits card
                html += `<div class="p-3 bg-white rounded shadow-sm">`;
                html += `<h4 class="font-semibold mb-2">Benefícios - Total</h4>`;
                html += `<div class="mb-1 font-semibold">VR + VT = <span id="salary-benefits-total">${formatCurrency(Math.round((vrDefault + vtDefault) * 100) / 100)}</span></div>`;
                html += `</div>`;

                html += `</div>`; // end right column

                html += `</div>`; // end grid

                contentEl.innerHTML = html;

                // wire up click-to-edit for VR/VT totals and days; support quick inline edit and persist
                try {
                    const vrEl = document.getElementById('salary-vr-total');
                    const vtEl = document.getElementById('salary-vt-total');
                    const daysEl = document.getElementById('salary-days');
                    const benefitsTotalEl = document.getElementById('salary-benefits-total');

                    const roundMoney = (v) => Math.round((Number(v) + Number.EPSILON) * 100) / 100;

                    const getNumericFromSpan = (el, fallback) => {
                        if (!el) return fallback || 0;
                        const txt = (el.textContent || '').replace(/[R$\s\.]/g, '').replace(',', '.');
                        const n = parseFloat(txt);
                        return isNaN(n) ? (fallback || 0) : n;
                    };

                    const setSpanCurrency = (el, value) => { if (!el) return; el.textContent = formatCurrency(roundMoney(value)); };
                    const setDaysDisplay = (v) => { const els = document.querySelectorAll('.salary-days-display'); els.forEach(e => { e.textContent = String(v); }); if (daysEl) daysEl.textContent = String(v); };

                    const recalcBenefitsTotal = () => {
                        const vr = getNumericFromSpan(vrEl, vrDefault);
                        const vt = getNumericFromSpan(vtEl, vtDefault);
                        if (benefitsTotalEl) benefitsTotalEl.textContent = formatCurrency(roundMoney(vr + vt));
                    };

                    const upsertLedger = async (typeName, amount) => {
                        try {
                            const mdNow = getCurrentMonthData();
                            if (!mdNow) return;
                            if (typeName === 'VR') {
                                if (!Array.isArray(mdNow.vrLedger)) mdNow.vrLedger = [];
                                let entry = mdNow.vrLedger.find(l => l && l.salaryMeta && JSON.stringify(l.salaryMeta) === JSON.stringify(meta));
                                if (!entry) entry = mdNow.vrLedger.find(l => l && (l.description || '').toLowerCase().includes('benefício') && (l.description || '').toLowerCase().includes('vr'));
                                if (entry) entry.amount = roundMoney(amount); else mdNow.vrLedger.push({ id: generateUUID(), description: 'Benefício - VR', amount: roundMoney(amount), recurringId: null, isRecurring: false, salaryMeta: meta || null });
                            } else if (typeName === 'VT') {
                                if (!Array.isArray(mdNow.vtLedger)) mdNow.vtLedger = [];
                                let entry = mdNow.vtLedger.find(l => l && l.salaryMeta && JSON.stringify(l.salaryMeta) === JSON.stringify(meta));
                                if (!entry) entry = mdNow.vtLedger.find(l => l && (l.description || '').toLowerCase().includes('benefício') && (l.description || '').toLowerCase().includes('vt'));
                                if (entry) entry.amount = roundMoney(amount); else mdNow.vtLedger.push({ id: generateUUID(), description: 'Benefício - VT', amount: roundMoney(amount), recurringId: null, isRecurring: false, salaryMeta: meta || null });
                            }
                            try { await storage.saveData(state.appData); showToast('Benefício salvo para o mês.', 'bg-green-600'); } catch(e){ console.error('save benefit', e); showToast('Falha ao salvar benefício.', 'bg-red-600'); }
                            render();
                        } catch(e) { console.error('upsertLedger', e); }
                    };

                    const makeEditor = (anchorEl, initialValue, onCommit, opts) => {
                        opts = opts || {};
                        if (!anchorEl) return;
                        const input = document.createElement('input');
                        input.type = opts.type === 'number' ? 'number' : 'text';
                        if (opts.step) input.step = opts.step;
                        input.value = initialValue;
                        input.className = 'inline-edit-input border px-1 py-0 rounded text-right';
                        input.style.minWidth = '80px';
                        // keep a reference to anchor id and classes so we can restore a similar element after commit
                        const anchorId = anchorEl.id || '';
                        const anchorClass = anchorEl.className || '';
                        const anchorParent = anchorEl.parentNode;
                        anchorEl.replaceWith(input);
                        input.focus();
                        input.select();
                        const commit = async () => {
                            let v = input.value;
                            try {
                                if (opts.type === 'number') v = parseFloat(String(v).replace(',', '.')) || 0; else v = v;
                            } catch(e) { /* pass */ }
                            let commitResult = null;
                            try { commitResult = await onCommit(v); } catch(e){ console.error('onCommit editor', e); }
                            // Build a replacement span to restore the UI where possible (text + optional icon)
                            try {
                                const displayText = (opts.type === 'number') ? (typeof commitResult === 'object' && commitResult.display ? commitResult.display : formatCurrency(Number(v) || 0)) : String(v);
                                const span = document.createElement('span');
                                if (anchorId) span.id = anchorId;
                                span.className = anchorClass;
                                span.style.minWidth = input.style.minWidth;
                                span.textContent = displayText;
                                // append icon HTML if provided by commitResult
                                if (commitResult && commitResult.showIconHtml) {
                                    const wrap = document.createElement('span');
                                    wrap.innerHTML = ' ' + commitResult.showIconHtml;
                                    // append icon node
                                    if (wrap.firstChild) span.appendChild(wrap.firstChild);
                                }
                                if (anchorParent) anchorParent.replaceChild(span, input);
                                // invoke optional restore handler so callers can re-attach click listeners
                                if (opts.onRestore && typeof opts.onRestore === 'function') {
                                    try { opts.onRestore(span, v, commitResult); } catch(e) { console.error('onRestore', e); }
                                }
                            } catch(e) { console.error('restore anchor after edit', e); }
                            render();
                        };
                        input.addEventListener('blur', commit);
                        input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); input.blur(); } if (e.key === 'Escape') { render(); } });
                    };

                    if (vrEl) {
                        const attachVREdit = (el) => {
                            try {
                                el.addEventListener('click', (ev) => {
                                    ev.preventDefault();
                                    const cur = getNumericFromSpan(el, vrDefault);
                                    makeEditor(el, String(cur), async (newVal) => {
                                        const num = parseFloat(String(newVal).replace(',', '.')) || 0;
                                        // persist
                                        await upsertLedger('VR', num);
                                        // return display and icon for restoration
                                        return { display: formatCurrency(num), showIconHtml: pencilSvg };
                                    }, {
                                        type: 'number', step: '0.01',
                                        onRestore: (span) => {
                                            // reattach edit handler to restored span
                                            attachVREdit(span);
                                            // update totals display
                                            try { setSpanCurrency(document.getElementById('salary-vr-total'), parseFloat((span.textContent||'').replace(/[R$\s\.]/g,'').replace(',', '.'))||0); } catch(e){}
                                            recalcBenefitsTotal();
                                        }
                                    });
                                });
                            } catch(e) { console.error('attachVREdit', e); }
                        };
                        attachVREdit(vrEl);
                    }

                    if (vtEl) {
                        const attachVTEdit = (el) => {
                            try {
                                el.addEventListener('click', (ev) => {
                                    ev.preventDefault();
                                    const cur = getNumericFromSpan(el, vtDefault);
                                    makeEditor(el, String(cur), async (newVal) => {
                                        const num = parseFloat(String(newVal).replace(',', '.')) || 0;
                                        await upsertLedger('VT', num);
                                        return { display: formatCurrency(num), showIconHtml: pencilSvg };
                                    }, {
                                        type: 'number', step: '0.01',
                                        onRestore: (span) => {
                                            attachVTEdit(span);
                                            try { setSpanCurrency(document.getElementById('salary-vt-total'), parseFloat((span.textContent||'').replace(/[R$\s\.]/g,'').replace(',', '.'))||0); } catch(e){}
                                            recalcBenefitsTotal();
                                        }
                                    });
                                });
                            } catch(e) { console.error('attachVTEdit', e); }
                        };
                        attachVTEdit(vtEl);
                    }

                    // attach the days editor to both the main #salary-days and any .salary-days-display elements (VT card)
                    const daysDisplays = [];
                    if (daysEl) daysDisplays.push(daysEl);
                    document.querySelectorAll('.salary-days-display').forEach(d => daysDisplays.push(d));
                    daysDisplays.forEach(dd => {
                        try {
                            const attachDaysEdit = (el) => {
                                el.addEventListener('click', (ev) => {
                                    ev.preventDefault();
                                    const cur = parseInt((el.textContent || String(benDiasBase)).replace(/[^0-9\-]/g, ''), 10) || benDiasBase;
                                    makeEditor(el, String(cur), async (newVal) => {
                                        const num = parseInt(String(newVal).replace(/[^0-9\-]/g, ''), 10) || benDiasBase;
                                        // compute new totals
                                        const vrPer = vrPerDay || 0;
                                        const vtPer = vtPerDay || 0;
                                        const newVR = Math.round((vrPer * num + Number.EPSILON) * 100) / 100;
                                        const newVT = Math.round((vtPer * num + Number.EPSILON) * 100) / 100;
                                        // persist both ledgers
                                        await upsertLedger('VR', newVR);
                                        await upsertLedger('VT', newVT);
                                        // return display for days and signal icon
                                        return { display: String(num), showIconHtml: pencilSvg };
                                    }, {
                                        type: 'number', step: '1',
                                        onRestore: (span, v, commitResult) => {
                                            // restore click handler
                                            attachDaysEdit(span);
                                            // update displayed VR/VT spans from persisted ledgers (or from computed values)
                                            try {
                                                const mdNow = getCurrentMonthData();
                                                const vrEntry = (Array.isArray(mdNow.vrLedger) ? mdNow.vrLedger.find(l => l && l.salaryMeta && JSON.stringify(l.salaryMeta) === JSON.stringify(meta)) : null) || (Array.isArray(mdNow.vrLedger) ? mdNow.vrLedger.find(l => l && (l.description||'').toLowerCase().includes('vr')) : null);
                                                const vtEntry = (Array.isArray(mdNow.vtLedger) ? mdNow.vtLedger.find(l => l && l.salaryMeta && JSON.stringify(l.salaryMeta) === JSON.stringify(meta)) : null) || (Array.isArray(mdNow.vtLedger) ? mdNow.vtLedger.find(l => l && (l.description||'').toLowerCase().includes('vt')) : null);
                                                if (vrEntry) setSpanCurrency(document.getElementById('salary-vr-total'), Number(vrEntry.amount || 0));
                                                if (vtEntry) setSpanCurrency(document.getElementById('salary-vt-total'), Number(vtEntry.amount || 0));
                                            } catch(e) { console.error('restore days display', e); }
                                            recalcBenefitsTotal();
                                        }
                                    });
                                });
                            };
                            attachDaysEdit(dd);
                        } catch(e) { console.error('attach days editor', e); }
                    });

                    // initial totals
                    recalcBenefitsTotal();
                } catch (e) { console.error('wire salary vr/vt click-to-edit', e); }

                try { modal.showModal(); } catch(e){ console.error('openSalaryBreakdown show', e); }
            } catch (e) { console.error('openSalaryBreakdown', e); }
        }

        function closeSalaryBreakdown() {
            try { const m = document.getElementById('salary-breakdown-modal'); if (m && typeof m.close === 'function') m.close(); } catch(e) { console.error('closeSalaryBreakdown', e); }
        }

        function toggleInstallmentSection(paymentMethodName) {
            try {
                const method = (state.appData.settings.paymentMethods || []).find(p => p.name === paymentMethodName);
                if (ui.installmentsSection) ui.installmentsSection.classList.toggle('hidden', !method || method.type !== 'credit_card');
                // financing section only for expenses
                if (ui.financingSection && ui.transactionTypeInput && ui.transactionTypeInput.value === 'expenses') {
                    ui.financingSection.classList.remove('hidden');
                    const financingCheckbox = document.getElementById('is-financing');
                    if (financingCheckbox) {
                        // Use addEventListener to avoid overwriting other handlers and ensure independence
                        financingCheckbox.addEventListener && financingCheckbox.addEventListener('change', function() {
                            const ff = document.getElementById('financing-fields'); if (ff) ff.classList.toggle('active', this.checked);
                        });
                    }
                }
            } catch (e) { console.error('toggleInstallmentSection', e); }
        }

        // Reset transaction modal inputs to sensible defaults
        function resetTransactionModalDefaults() {
            try {
                // Default payment: first debit method if available, else first paymentMethod
                const payments = (state.appData.settings && state.appData.settings.paymentMethods) || [];
                let defaultPayment = '';
                try {
                    const debit = payments.find(p => (p.type || '').toString().toLowerCase() === 'debit');
                    if (debit) defaultPayment = debit.name;
                } catch(e) {}
                if (!defaultPayment && payments.length) defaultPayment = payments[0].name || '';
                // Fallbacks
                if (!defaultPayment) defaultPayment = 'Pix';
                if (document.getElementById('payment-method')) document.getElementById('payment-method').value = defaultPayment;
                // Default category: Contas if exists, else first expense category
                const expenseCats = (state.appData.settings && state.appData.settings.expenseCategories) || [];
                let defaultCat = expenseCats.find(c => (c||'').toString().toLowerCase().includes('conta')) || expenseCats[0] || 'Contas';
                if (document.getElementById('category-expense')) document.getElementById('category-expense').value = defaultCat;
                // Reset recurring and hide installment/financing fields but do not force-uncheck the checkboxes
                const recurring = document.getElementById('is-recurring'); if (recurring) recurring.checked = false;
                const instFields = document.getElementById('installments-fields'); if (instFields) instFields.classList.remove('active');
                const financFields = document.getElementById('financing-fields'); if (financFields) financFields.classList.remove('active');
                // Clear description and amount inputs
                const desc = document.getElementById('description'); if (desc) desc.value = '';
                const amt = document.getElementById('amount'); if (amt) amt.value = '';
                // Reset modal-expanded class
                try { const modal = document.getElementById('transaction-modal'); if (modal) modal.classList.remove('modal-expanded'); } catch(e){}
            } catch (e) { console.error('resetTransactionModalDefaults', e); }
        }

        // Prepare modal inputs for the next entry: prefer session last-used values when present
        function prepareModalForNextEntry() {
            try {
                // If session has last defaults, use them
                if (ui.lastTransactionDefaults && typeof ui.lastTransactionDefaults === 'object') {
                    const d = ui.lastTransactionDefaults;
                    if (document.getElementById('payment-method') && d.payment) document.getElementById('payment-method').value = d.payment;
                    if (document.getElementById('category-expense') && d.category) document.getElementById('category-expense').value = d.category;
                    return;
                }
                // otherwise apply global defaults
                resetTransactionModalDefaults();
            } catch (e) { console.error('prepareModalForNextEntry', e); }
        }

        function populateModal(type, id) {
            try {
                const transaction = getCurrentMonthData()[type].find(t => t.id === id);
                if (!transaction) return;
                document.getElementById('transaction-id').value = transaction.id || '';
                document.getElementById('description').value = transaction.description || '';
                document.getElementById('amount').value = transaction.amount || '';
                document.getElementById('is-recurring').checked = !!transaction.isRecurring;
                // If this transaction is recurring, enable the apply-to-future checkbox default to false (user decides)
                try { if (ui.applyToFuture) ui.applyToFuture.checked = false; } catch(e) {}
                if (type === 'expenses') {
                    if (document.getElementById('payment-method')) document.getElementById('payment-method').value = transaction.payment || '';
                    if (document.getElementById('category-expense')) document.getElementById('category-expense').value = transaction.category || '';
                    if (transaction.financingId) {
                        const financingCheckbox = document.getElementById('is-financing');
                        if (financingCheckbox) {
                            financingCheckbox.checked = true;
                            // ensure the financing fields are shown (some handlers show/hide on change)
                            if (typeof financingCheckbox.onchange === 'function') financingCheckbox.onchange();
                            const ff = document.getElementById('financing-fields'); if (ff) ff.classList.add('active');
                        }
                        const ft = document.getElementById('financing-total'); if (ft) ft.value = transaction.totalFinancing || '';
                        const fc = document.getElementById('financing-current'); if (fc) fc.value = transaction.currentFinancing || '';
                    }
                } else if (type === 'savings') {
                    if (document.getElementById('category-saving')) document.getElementById('category-saving').value = transaction.category || '';
                } else if (type === 'incomes') {
                    // If this income was created as part of a salary breakdown, it may carry salaryMeta
                    if (transaction.source && transaction.salaryMeta) {
                        // Open salary section and prefill fields
                        const isSalaryCheckbox = document.getElementById('is-salary');
                        const salaryFields = document.getElementById('salary-fields');
                        try {
                            if (isSalaryCheckbox) {
                                isSalaryCheckbox.checked = true;
                                if (salaryFields) salaryFields.classList.remove('hidden');
                                // expand modal when editing salary-related income
                                const modal = document.getElementById('transaction-modal'); if (modal) modal.classList.add('modal-expanded');
                            }
                        } catch(e){}
                        const meta = transaction.salaryMeta || {};
                        // Only fill main salary inputs when source is 'salary' (salary líquido)
                        if (transaction.source === 'salary') {
                            document.getElementById('salary-base').value = meta.salarioBase || '';
                            document.getElementById('salary-periculosidade').value = meta.percentualPericulosidade || '';
                            document.getElementById('salary-outros-proventos').value = meta.outrosProventosTributaveis || '';
                            document.getElementById('salary-dependentes').value = meta.numeroDependentes || '';
                            document.getElementById('salary-desjejum-dia').value = meta.valorDesjejumDia || '';
                            document.getElementById('salary-transporte-dia').value = meta.valorTransporteDia || '';
                            document.getElementById('salary-dias-trabalhados').value = meta.diasTrabalhados || '';
                            document.getElementById('salary-jornada-horas').value = meta.jornadaMensalHoras || '';
                            document.getElementById('salary-horas-trabalhadas').value = meta.horasTrabalhadasRaw || meta.horasTrabalhadas || '';
                        }
                        // For benefit entries (VT/VR) we keep them editable per-month (they are not auto-recurring when edited)
                        // but we still show salary meta so user can edit if needed.
                    }
                }
            } catch (e) { console.error('populateModal', e); }
        }

        function openGoalModal(id = null) {
            try {
                const modal = ui.goalModal;
                if (!modal) return;
                const form = ui.goalForm;
                if (form) form.reset();
                if (id) {
                    const goal = (state.appData.settings.goals || []).find(g => g.id === id);
                    if (goal) {
                        document.getElementById('goal-id').value = goal.id;
                        document.getElementById('goal-name').value = goal.name || '';
                        document.getElementById('goal-amount').value = goal.amount || '';
                        document.getElementById('goal-modal-title').textContent = 'Editar Meta';
                    }
                } else {
                    document.getElementById('goal-modal-title').textContent = 'Nova Meta';
                }
                modal.showModal();
            } catch (e) { console.error('openGoalModal', e); }
        }

        // Monthly and Annual report helpers
        function openMonthlyReport() {
            try {
                // Build and show monthly report modal
                const monthData = getCurrentMonthData();
                const totalIncome = (monthData.incomes || []).reduce((s,t)=>s+(t.amount||0),0);
                // Recalculate outcomes using invoice (fatura) totals for credit cards to avoid divergence.
                const expenses = monthData.expenses || [];
                const year = state.currentDate.getFullYear();
                const month = String(state.currentDate.getMonth() + 1).padStart(2, '0');
                const paymentMethods = (state.appData.settings && state.appData.settings.paymentMethods) || [];
                const cardMethods = paymentMethods.filter(p => p.type === 'credit_card');
                // Sum expenses that are NOT paid with cards (tolerant matching)
                const nonCardExpensesSum = expenses.filter(e => !cardMethods.some(c => paymentMatches(e.payment || '', c.name))).reduce((s,t)=>s+(t.amount||0),0);
                // Sum invoice totals per-card (total of card expenses minus any anticipations)
                const cardAnticipations = (state.appData.data[year] && state.appData.data[year][month] && state.appData.data[year][month].cardAnticipations) || {};
                let totalInvoices = 0;
                cardMethods.forEach(card => {
                    const cardExpenses = expenses.filter(e => paymentMatches(e.payment || '', card.name));
                    const totalBeforeAnticipation = cardExpenses.reduce((s,t)=>s+(t.amount||0),0);
                    const anticipated = Number(cardAnticipations[card.name] || 0);
                    const invoiceTotal = Math.round(((totalBeforeAnticipation - anticipated) + Number.EPSILON) * 100) / 100;
                    totalInvoices += invoiceTotal;
                });
                const savingsSum = (monthData.savings || []).reduce((s,t)=>s+(t.amount||0),0);
                const totalOutcome = nonCardExpensesSum + totalInvoices + savingsSum;
                const finalBalance = totalIncome - totalOutcome;
                const title = document.getElementById('monthly-report-title'); if (title) title.textContent = state.currentDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                const inEl = document.getElementById('mr-total-income'); if (inEl) inEl.textContent = formatCurrency(totalIncome);
                const outEl = document.getElementById('mr-total-outcome'); if (outEl) outEl.textContent = formatCurrency(totalOutcome);
                const finEl = document.getElementById('mr-final-balance'); if (finEl) finEl.textContent = formatCurrency(finalBalance);
                renderMonthlySavingsChart();
                renderMonthlyReportCategoryChart();
                // Populate top expenses list (include card invoices as single entries)
                try {
                    const topList = document.getElementById('mr-top-expenses-list');
                    if (topList) {
                        topList.innerHTML = '';
                        const contributors = [];
                        // add non-card individual expenses (tolerant matching)
                        (expenses || []).filter(e => !cardMethods.some(c => paymentMatches(e.payment || '', c.name))).forEach(e => {
                            contributors.push({ id: `exp-${generateUUID()}`, label: e.description || 'Despesa', amount: Number(e.amount)||0, count: 1, kind: 'expense' });
                        });
                        // add one entry per card: invoice total
                        cardMethods.forEach(card => {
                            const cardExpenses = (expenses || []).filter(e => paymentMatches(e.payment || '', card.name));
                            const totalBeforeAnticipation = cardExpenses.reduce((s,t)=>s+(t.amount||0),0);
                            const anticipated = Number(cardAnticipations[card.name] || 0);
                            const invoiceTotal = Math.round(((totalBeforeAnticipation - anticipated) + Number.EPSILON) * 100) / 100;
                            // Only include card invoice if it contributes something (non-zero) or there are expenses
                            if ((invoiceTotal !== 0) || cardExpenses.length > 0) {
                                contributors.push({ id: `card-${card.name}`, label: `Fatura ${card.name}`, amount: invoiceTotal, count: cardExpenses.length, kind: 'invoice' });
                            }
                        });
                        // sort contributors by amount desc and take top 8
                        const topContributors = contributors.slice().sort((a,b) => (b.amount||0) - (a.amount||0)).slice(0,8);
                        if (topContributors.length === 0) topList.innerHTML = '<li class="text-gray-500">Nenhuma despesa registrada.</li>';
                        topContributors.forEach(c => {
                            const li = document.createElement('li');
                            li.className = 'flex justify-between items-center gap-3';
                            const left = document.createElement('span');
                            left.className = 'flex items-center gap-2';
                            // determine icon: invoice -> payment/card icon, expense -> category icon
                            let iconName = '';
                            if (c.kind === 'invoice') {
                                // extract card name from label 'Fatura <cardName>' or id
                                const m = c.id && c.id.startsWith('card-') ? c.id.replace(/^card-/, '') : (c.label || '').replace(/^Fatura\s*/i, '');
                                iconName = (typeof getIconFor === 'function') ? getIconFor('payment', m) : '';
                            } else if (c.kind === 'expense') {
                                // try to find an expense entry that matches this label to get category
                                const match = (expenses || []).find(e => (e.description || '').toString() === c.label || (c.label || '').indexOf(e.description || '') !== -1);
                                iconName = (typeof getIconFor === 'function') ? getIconFor('category', match ? match.category : '') : '';
                            }
                            if (iconName && typeof iconHtml === 'function') {
                                left.innerHTML = iconHtml(iconName, 'text-sm text-gray-500') + escapeHtml(c.count > 1 && c.kind === 'invoice' ? `${c.label} (${c.count})` : c.label);
                            } else {
                                left.textContent = c.count > 1 && c.kind === 'invoice' ? `${c.label} (${c.count})` : c.label;
                            }
                            const right = document.createElement('span');
                            right.className = 'font-medium';
                            right.textContent = formatCurrency(c.amount);
                            li.appendChild(left);
                            li.appendChild(right);
                            topList.appendChild(li);
                        });
                    }
                } catch(e){console.error('populate top expenses', e)}
                const modal = ui.monthlyReportModal; if (modal) modal.showModal();
            } catch(e){console.error('openMonthlyReport', e)}
        }

        function openAnnualReport() {
            try {
                const year = state.currentDate.getFullYear();
                document.getElementById('annual-report-title').textContent = year;
                // compute yearly totals
                const yearData = state.appData.data[year] || {};
                const months = Object.keys(yearData);
                let totalInc = 0, totalOut = 0;
                months.forEach(m => {
                    const md = yearData[m] || { incomes: [], expenses: [], savings: [] };
                    totalInc += (md.incomes || []).reduce((s,t)=>s+(t.amount||0),0);
                    totalOut += invoiceAwareOutcomeForMonth(year, m, md);
                });
                const final = totalInc - totalOut;
                const inEl = document.getElementById('ar-total-income'); if (inEl) inEl.textContent = formatCurrency(totalInc);
                const outEl = document.getElementById('ar-total-outcome'); if (outEl) outEl.textContent = formatCurrency(totalOut);
                const finEl = document.getElementById('ar-final-balance'); if (finEl) finEl.textContent = formatCurrency(final);
                // Render annual charts
                renderAnnualBalanceEvolutionChart();
                renderAnnualAvgCategoryChart();
                const modal = ui.annualReportModal; if (modal) modal.showModal();
            } catch(e){console.error('openAnnualReport', e)}
        }

        function renderMonthlySavingsChart() {
            try {
                destroyChart('monthly-savings-chart');
                const yearData = state.appData.data[state.currentDate.getFullYear()] || {};
                const months = Array.from({ length: 12 }, (_, i) => String(i + 1).padStart(2, '0'));
                const monthlySavings = months.map(month => (yearData[month]?.savings || []).reduce((s,t)=>s+(t.amount||0),0));
                const ctx = document.getElementById('monthly-savings-chart'); if (!ctx || typeof Chart === 'undefined') return;
                ui.charts['monthly-savings-chart'] = new Chart(ctx.getContext('2d'), { type:'line', data:{ labels:['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'], datasets:[{ label:'Aportes Mensais', data: monthlySavings, borderColor:'#4F46E5', tension:0.1 }] }, options:{responsive:true, maintainAspectRatio:false} });
            } catch(e){console.error('renderMonthlySavingsChart', e)}
        }

        async function handleGoalFormSubmit(e) {
            try {
                e.preventDefault();
                const id = document.getElementById('goal-id').value;
                const name = document.getElementById('goal-name').value;
                const amount = parseLocaleNumber(document.getElementById('goal-amount').value) || 0;
                if (!state.appData.settings.goals) state.appData.settings.goals = [];
                if (id) {
                    const g = state.appData.settings.goals.find(x=>x.id===id);
                    if (g) { g.name = name; g.amount = amount; }
                } else {
                    state.appData.settings.goals.push({ id: generateUUID(), name, amount });
                }
                try {
                    await storage.saveData(state.appData);
                } catch (e) {
                    console.error('Erro ao salvar meta:', e);
                    showToast('Falha ao salvar meta no Firebase.', 'bg-red-600');
                }
                closeModal('goal-modal');
                renderInvestmentsView();
            } catch(e){console.error('handleGoalFormSubmit', e)}
        }

        // --- LÓGICA DE TRANSAÇÕES (Adicionar, Editar, Excluir) ---

        // Funções auxiliares (definidas antes do uso para evitar ReferenceError)
        async function updateFutureRecurrences(recurringId, newTransaction, type) {
            const affectedGoals = new Set(); // Track goalIds from affected savings
            
            Object.keys(state.appData.data).forEach(year => {
                Object.keys(state.appData.data[year]).forEach(month => {
                    const monthData = state.appData.data[year][month];
                    if (monthData[type] && Array.isArray(monthData[type])) {
                        monthData[type] = monthData[type].map(item => {
                            const itemDate = new Date(year, month - 1);
                            if (item.recurringId === recurringId && itemDate > state.currentDate) {
                                // Track goalId if this is a savings entry
                                if (type === 'savings' && (item.goalId || newTransaction.goalId)) {
                                    if (item.goalId) affectedGoals.add(item.goalId);
                                    if (newTransaction.goalId) affectedGoals.add(newTransaction.goalId);
                                }
                                
                                return { 
                                    ...item, 
                                    description: newTransaction.description,
                                    amount: newTransaction.amount,
                                    category: newTransaction.category,
                                    payment: newTransaction.payment,
                                    type: newTransaction.type,
                                    goalId: newTransaction.goalId || item.goalId // Preserve or update goalId
                                };
                            }
                            return item;
                        });
                    }
                });
            });
            
            // Update travel plans for affected goals
            if (type === 'savings') {
                for (const goalId of affectedGoals) {
                    try {
                        await updateTravelPlanSavedFromSavings(goalId);
                    } catch(e) {
                        console.error('Erro ao sincronizar plano de viagem após atualização de recorrência:', e);
                    }
                }
            }
        }

        // Rebuild future financing installments when the user edits an installment.
        // This will remove future installments (after the original edited one) and
        // recreate them starting from the edited installment's month using the
        // edited currentFinancing and totalFinancing values. This keeps numbering
        // and dates consistent with user's edit (e.g. changing current installment
        // to a different number will shift the schedule).
        function updateAllFinancing(financingId, originalCurrentFinancing, newTransaction) {
            try {
                const newCurrent = Number(newTransaction.currentFinancing) || originalCurrentFinancing;
                const newTotal = Number(newTransaction.totalFinancing) || null;
                if (!newTotal || newTotal < newCurrent) return;

                // Edited installment month (we edit the transaction in the currently viewed month)
                const editedMonthStart = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), 1);

                // 1) Remove any future installments that belong to this financing and are scheduled after the edited month
                Object.keys(state.appData.data).forEach(year => {
                    Object.keys(state.appData.data[year]).forEach(month => {
                        const monthStart = new Date(Number(year), Number(month) - 1, 1);
                        const monthData = state.appData.data[year][month];
                        if (monthData.expenses && Array.isArray(monthData.expenses)) {
                            monthData.expenses = monthData.expenses.filter(exp => {
                                if (exp.financingId !== financingId) return true;
                                // keep installments that are in or before the edited month; remove those after
                                return monthStart <= editedMonthStart;
                            });
                        }
                    });
                });

                // 2) Recreate installments from newCurrent+1 .. newTotal starting from edited month + 1
                for (let k = newCurrent + 1; k <= newTotal; k++) {
                    const monthOffset = k - newCurrent; // 1 => next month
                    const targetDate = new Date(editedMonthStart);
                    targetDate.setMonth(editedMonthStart.getMonth() + monthOffset);
                    const targetMonthData = getCurrentMonthData(targetDate);
                    if (!Array.isArray(targetMonthData.expenses)) targetMonthData.expenses = [];

                    const newInst = {
                        ...newTransaction,
                        id: generateUUID(),
                        financingId: financingId,
                        currentFinancing: k,
                        totalFinancing: newTotal,
                        isPaid: false
                    };

                    targetMonthData.expenses.push(newInst);
                }
            } catch (e) {
                console.error('updateAllFinancing (rebuild) error', e);
            }
        }
        
    // createInstallments(baseTransaction, count, start) - start: current installment number (default 1)
    async function createInstallments(baseTransaction, count, start = 1) {
            const installmentId = generateUUID();
            // If a start/current installment > 1 is provided, the user is registering
            // an in-progress parcel and expects the provided amount to be the
            // per-installment value (do NOT divide by total). Otherwise divide
            // the provided amount evenly across total installments.
            let installmentAmount;
            const rawAmount = parseFloat(baseTransaction.amount) || 0;
            if (start && start > 1) {
                installmentAmount = parseFloat(rawAmount.toFixed(2));
            } else {
                installmentAmount = parseFloat((rawAmount / count).toFixed(2));
            }
            // Do not create previous installments automatically.

            // create installments numbered start..count (inclusive)
            for (let i = start; i <= count; i++) {
                // Determine month offset: installment i corresponds to month offset (i - start)
                const monthOffset = i - start;
                const installmentDate = new Date(state.currentDate);
                installmentDate.setMonth(state.currentDate.getMonth() + monthOffset);
                const futureMonthData = getCurrentMonthData(installmentDate);
                // If payment method is VR, store as vrUsage entry instead of expenses
                    if ((baseTransaction.payment || '') === 'VR') {
                    if (!Array.isArray(futureMonthData.vrUsage)) futureMonthData.vrUsage = [];
                    futureMonthData.vrUsage.push({ id: generateUUID(), amount: installmentAmount, description: baseTransaction.description || 'Despesa VR', date: new Date(installmentDate).toISOString(), installmentId, currentInstallment: i, totalInstallments: count, isPaid: i < start ? true : false });
                }
                // If payment method is VT, mirror VR behavior and store in vtUsage ledger
                else if ((baseTransaction.payment || '') === 'VT') {
                    if (!Array.isArray(futureMonthData.vtUsage)) futureMonthData.vtUsage = [];
                    futureMonthData.vtUsage.push({ id: generateUUID(), amount: installmentAmount, description: baseTransaction.description || 'Despesa VT', date: new Date(installmentDate).toISOString(), installmentId, currentInstallment: i, totalInstallments: count, isPaid: i < start ? true : false });
                } else {
                    if (!Array.isArray(futureMonthData.expenses)) futureMonthData.expenses = [];
                    futureMonthData.expenses.push({ 
                        ...baseTransaction, 
                        id: generateUUID(), 
                        amount: installmentAmount, 
                        installmentId, 
                        currentInstallment: i, 
                        totalInstallments: count, 
                        isPaid: i < start ? true : false 
                     });
                }
            }
            try {
                await storage.saveData(state.appData);
                showToast(`${count} parcelas criadas com sucesso!`, 'bg-green-600');
            } catch (e) {
                console.error('Erro ao criar parcelas:', e);
                showToast('Falha ao salvar parcelas no Firebase.', 'bg-red-600');
            }
        }

    async function createFinancing(baseTransaction, total, current) {
            const financingId = generateUUID();
            for (let i = current; i <= total; i++) {
                const installmentDate = new Date(state.currentDate);
                installmentDate.setMonth(state.currentDate.getMonth() + (i - current));
                const futureMonthData = getCurrentMonthData(installmentDate);
                if ((baseTransaction.payment || '') === 'VR') {
                    if (!Array.isArray(futureMonthData.vrUsage)) futureMonthData.vrUsage = [];
                    futureMonthData.vrUsage.push({ id: generateUUID(), amount: parseFloat(baseTransaction.amount) || 0, description: baseTransaction.description || 'Despesa VR', date: new Date(installmentDate).toISOString(), financingId, currentFinancing: i, totalFinancing: total });
                }
                else if ((baseTransaction.payment || '') === 'VT') {
                    if (!Array.isArray(futureMonthData.vtUsage)) futureMonthData.vtUsage = [];
                    futureMonthData.vtUsage.push({ id: generateUUID(), amount: parseFloat(baseTransaction.amount) || 0, description: baseTransaction.description || 'Despesa VT', date: new Date(installmentDate).toISOString(), financingId, currentFinancing: i, totalFinancing: total });
                } else {
                    if (!Array.isArray(futureMonthData.expenses)) futureMonthData.expenses = [];
                    futureMonthData.expenses.push({
                        ...baseTransaction,
                        id: generateUUID(),
                        financingId,
                        currentFinancing: i,
                        totalFinancing: total
                    });
                }
            }
            try {
                await storage.saveData(state.appData);
                showToast(`Financiamento de ${total} parcelas criado!`, 'bg-green-600');
            } catch (e) {
                console.error('Erro ao criar financiamento:', e);
                showToast('Falha ao salvar financiamento no Firebase.', 'bg-red-600');
            }
        }

        // Create financing entries for incomes (receivables)
        async function createIncomeFinancing(baseTransaction, total, current) {
            const financingId = generateUUID();
            for (let i = current; i <= total; i++) {
                const installmentDate = new Date(state.currentDate);
                installmentDate.setMonth(state.currentDate.getMonth() + (i - current));
                const futureMonthData = getCurrentMonthData(installmentDate);
                if (!Array.isArray(futureMonthData.incomes)) futureMonthData.incomes = [];
                futureMonthData.incomes.push({ ...baseTransaction, id: generateUUID(), financingId, currentFinancing: i, totalFinancing: total, isPaid: false });
            }
            try { await storage.saveData(state.appData); showToast(`Financiamento de entrada criado (${total}x).`, 'bg-green-600'); } catch(e) { console.error('createIncomeFinancing save', e); showToast('Falha ao salvar financiamento de entrada.', 'bg-red-600'); }
        }

        // Create income installments (parcelada) across months when user marks an income as installment
        async function createIncomeInstallments(baseTransaction, count, start = 1) {
            const installmentId = generateUUID();
            // If start > 1, assume provided amount is per-installment; otherwise divide by count
            let installmentAmount;
            const rawAmount = parseFloat(baseTransaction.amount) || 0;
            if (start && start > 1) installmentAmount = parseFloat(rawAmount.toFixed(2));
            else installmentAmount = parseFloat((rawAmount / count).toFixed(2));

            for (let i = start; i <= count; i++) {
                const monthOffset = i - start;
                const d = new Date(state.currentDate);
                d.setMonth(state.currentDate.getMonth() + monthOffset);
                const md = getCurrentMonthData(d);
                if (!Array.isArray(md.incomes)) md.incomes = [];
                md.incomes.push({ id: generateUUID(), description: baseTransaction.description || 'Serviço', amount: installmentAmount, installmentId, currentInstallment: i, totalInstallments: count, isPaid: false, isRecurring: !!baseTransaction.isRecurring });
            }
            try { await storage.saveData(state.appData); showToast(`${count} parcelas de entrada criadas.`, 'bg-green-600'); } catch(e) { console.error('createIncomeInstallments save', e); showToast('Falha ao salvar parcelas de entrada.', 'bg-red-600'); }
        }

        async function deleteFutureInstallments(installmentId, currentInstallment) {
            const deletedSavingsGoals = new Set(); // Track goalIds from deleted savings
            
            Object.keys(state.appData.data).forEach(year => {
                Object.keys(state.appData.data[year]).forEach(month => {
                    const monthData = state.appData.data[year][month];
                    
                    // Handle expenses
                    if (monthData.expenses && Array.isArray(monthData.expenses)) {
                        monthData.expenses = monthData.expenses.filter(exp => 
                            !(exp.installmentId === installmentId && exp.currentInstallment >= currentInstallment)
                        );
                    }
                    
                    // Handle savings - collect goalIds before deletion for sync
                    if (monthData.savings && Array.isArray(monthData.savings)) {
                        monthData.savings.forEach(saving => {
                            if (saving.installmentId === installmentId && 
                                saving.currentInstallment >= currentInstallment && 
                                saving.goalId) {
                                deletedSavingsGoals.add(saving.goalId);
                            }
                        });
                        
                        monthData.savings = monthData.savings.filter(saving => 
                            !(saving.installmentId === installmentId && saving.currentInstallment >= currentInstallment)
                        );
                    }
                });
            });
            
            // Update travel plans for affected goals
            for (const goalId of deletedSavingsGoals) {
                try {
                    await updateTravelPlanSavedFromSavings(goalId);
                } catch(e) {
                    console.error('Erro ao sincronizar plano de viagem após exclusão de parcelas:', e);
                }
            }
        }

        async function deleteFutureFinancing(financingId, fromCurrentFinancing) {
            const deletedSavingsGoals = new Set(); // Track goalIds from deleted savings
            
            Object.keys(state.appData.data).forEach(year => {
                Object.keys(state.appData.data[year]).forEach(month => {
                    const monthData = state.appData.data[year][month];
                    
                    // Handle expenses
                    if (monthData.expenses && Array.isArray(monthData.expenses)) {
                        monthData.expenses = monthData.expenses.filter(exp => 
                            !(exp.financingId === financingId && (exp.currentFinancing || 0) >= fromCurrentFinancing)
                        );
                    }
                    
                    // Handle incomes
                    if (monthData.incomes && Array.isArray(monthData.incomes)) {
                        monthData.incomes = monthData.incomes.filter(inc => 
                            !(inc.financingId === financingId && (inc.currentFinancing || 0) >= fromCurrentFinancing)
                        );
                    }
                    
                    // Handle savings - collect goalIds before deletion for sync
                    if (monthData.savings && Array.isArray(monthData.savings)) {
                        monthData.savings.forEach(saving => {
                            if (saving.financingId === financingId && 
                                (saving.currentFinancing || 0) >= fromCurrentFinancing && 
                                saving.goalId) {
                                deletedSavingsGoals.add(saving.goalId);
                            }
                        });
                        
                        monthData.savings = monthData.savings.filter(saving => 
                            !(saving.financingId === financingId && (saving.currentFinancing || 0) >= fromCurrentFinancing)
                        );
                    }
                });
            });
            
            // Update travel plans for affected goals
            for (const goalId of deletedSavingsGoals) {
                try {
                    await updateTravelPlanSavedFromSavings(goalId);
                } catch(e) {
                    console.error('Erro ao sincronizar plano de viagem após exclusão de financiamentos:', e);
                }
            }
        }

        async function deleteFutureRecurrences(recurringId) {
            const currentMonthStart = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), 1);
            const deletedSavingsGoals = new Set(); // Track goalIds from deleted savings
            
            Object.keys(state.appData.data).forEach(year => {
                Object.keys(state.appData.data[year]).forEach(month => {
                    const monthStart = new Date(year, month - 1, 1);
                    if (monthStart >= currentMonthStart) {
                        const monthData = state.appData.data[year][month];
                        ['incomes', 'expenses', 'savings'].forEach(type => {
                            if (monthData[type] && Array.isArray(monthData[type])) {
                                // Collect goalIds from savings before deletion for sync
                                if (type === 'savings') {
                                    monthData[type].forEach(item => {
                                        if (item.recurringId === recurringId && item.goalId) {
                                            deletedSavingsGoals.add(item.goalId);
                                        }
                                    });
                                }
                                monthData[type] = monthData[type].filter(item => item.recurringId !== recurringId);
                            }
                        });
                    }
                });
            });
            
            // Update travel plans for affected goals
            for (const goalId of deletedSavingsGoals) {
                try {
                    await updateTravelPlanSavedFromSavings(goalId);
                } catch(e) {
                    console.error('Erro ao sincronizar plano de viagem após exclusão de recorrência:', e);
                }
            }
        }

        // Função principal para salvar (adicionar ou editar)
        async function saveTransaction(transaction, type, id) {
            const currentMonthData = getCurrentMonthData();
            if (!Array.isArray(currentMonthData[type])) currentMonthData[type] = [];

            if (id) { // Editando
                const index = currentMonthData[type].findIndex(t => t.id === id);
                if (index > -1) {
                    const originalTransaction = currentMonthData[type][index];
                    
                    // Preserva IDs importantes que não devem mudar na edição
                    transaction.recurringId = originalTransaction.recurringId;
                    transaction.financingId = originalTransaction.financingId;
                    transaction.installmentId = originalTransaction.installmentId;

                    // If there's a recurringId or financingId, consult the 'apply-to-future' checkbox (if present)
                    const applyToFutureChecked = (ui.applyToFuture && ui.applyToFuture.checked) ? true : null;
                            if (originalTransaction.recurringId) {
                        if (applyToFutureChecked === true) {
                            await updateFutureRecurrences(originalTransaction.recurringId, transaction, type);
                        } else if (applyToFutureChecked === null) {
                            // fallback to old confirm dialog when checkbox not available
                            try {
                                const ok = await confirmAsync('Esta é uma transação recorrente. Deseja atualizar as futuras também?', 'Aplicar às futuras');
                                if (ok) await updateFutureRecurrences(originalTransaction.recurringId, transaction, type);
                            } catch(e) { /* user cancelled */ }
                        }
                    }

                    if (originalTransaction.financingId) {
                        if (applyToFutureChecked === true) {
                            updateAllFinancing(originalTransaction.financingId, originalTransaction.currentFinancing, transaction);
                        } else if (applyToFutureChecked === null) {
                            try {
                                const okf = await confirmAsync('Esta é uma transação de financiamento. Deseja atualizar as parcelas futuras também?', 'Aplicar às futuras parcelas');
                                if (okf) updateAllFinancing(originalTransaction.financingId, originalTransaction.currentFinancing, transaction);
                            } catch(e) { /* cancelled */ }
                        }
                    }

                    // If editing a savings entry, try to preserve or update the goal link
                    if (type === 'savings') {
                        try {
                            // preserve existing goalId unless the category/description indicates another goal
                            const goals = state.appData.settings.goals || [];
                            let linkedGoalId = originalTransaction.goalId || null;
                            // Try to detect a goal by category first
                            if (transaction.category) {
                                const g = goals.find(x => (x.name || '').toString().toLowerCase() === (transaction.category || '').toString().toLowerCase());
                                if (g) linkedGoalId = g.id;
                            }
                            // If still not found, try matching by description text
                            if (!linkedGoalId && transaction.description) {
                                const desc = (transaction.description || '').toString().toLowerCase();
                                const g2 = goals.find(x => desc.indexOf((x.name || '').toString().toLowerCase()) !== -1 || (transaction.description||'').toString().trim() === (x.name||''));
                                if (g2) linkedGoalId = g2.id;
                            }
                            if (linkedGoalId) transaction.goalId = linkedGoalId;
                        } catch (e) { /* ignore linking errors */ }
                    }

                    currentMonthData[type][index] = { ...originalTransaction, ...transaction };
                    try {
                        await storage.saveData(state.appData);
                        showToast('Transação editada com sucesso!', 'bg-green-600');
                        // If this was a savings entry linked to a goal, synchronize travelPlan.saved
                        try {
                            if (type === 'savings' && currentMonthData[type][index] && currentMonthData[type][index].goalId) {
                                await updateTravelPlanSavedFromSavings(currentMonthData[type][index].goalId);
                            }
                        } catch(e) { /* ignore sync errors */ }
                    } catch (e) {
                        console.error('Erro ao salvar transação editada:', e);
                        showToast('Falha ao salvar transação no Firebase.', 'bg-red-600');
                    }
                }
            } else { // Adicionando
                if (transaction.isRecurring) {
                    transaction.recurringId = generateUUID();
                }
                // For savings entries, attempt to auto-link to a goal by category or description
                if (type === 'savings') {
                    try {
                        const goals = state.appData.settings.goals || [];
                        let linked = null;
                        if (transaction.category) {
                            linked = goals.find(g => (g.name || '').toString().toLowerCase() === (transaction.category || '').toString().toLowerCase());
                        }
                        if (!linked && transaction.description) {
                            const desc = (transaction.description || '').toString().toLowerCase();
                            linked = goals.find(g => desc.indexOf((g.name || '').toString().toLowerCase()) !== -1 || (transaction.description||'').toString().trim() === (g.name||''));
                        }
                        if (linked) transaction.goalId = linked.id;
                    } catch (e) { /* ignore */ }
                }

                currentMonthData[type].push(transaction);
                try {
                    await storage.saveData(state.appData);
                    showToast('Transação salva com sucesso!', 'bg-green-600');
                    // If this is a savings transaction linked to a goal, synchronize travelPlan.saved
                    try {
                        if (type === 'savings' && transaction.goalId) {
                            await updateTravelPlanSavedFromSavings(transaction.goalId);
                        }
                    } catch(e) { /* ignore sync errors */ }
                    // Persist session 'last used' payment/category for faster subsequent entries (in-memory only)
                    try {
                        const lastPayment = document.getElementById('payment-method') ? document.getElementById('payment-method').value : null;
                        const lastCat = document.getElementById('category-expense') ? document.getElementById('category-expense').value : null;
                        ui.lastTransactionDefaults = { payment: lastPayment, category: lastCat };
                    } catch(e) { /* ignore */ }
                    // Prepare modal for next entry using session defaults (will fall back to app defaults on reload)
                    try { prepareModalForNextEntry(); } catch(e) { console.error('prepare next after save', e); }
                } catch (e) {
                    console.error('Erro ao salvar nova transação:', e);
                    showToast('Falha ao salvar transação no Firebase.', 'bg-red-600');
                }
            }
        }

        // Show a compact preview of which future months would be affected by applying changes
        function previewFutureChanges(id, type) {
            try {
                if (!id) return showToast('ID da transação não informado para pré-visualização.', 'bg-gray-600');
                const affected = [];
                Object.keys(state.appData.data || {}).forEach(year => {
                    Object.keys(state.appData.data[year] || {}).forEach(month => {
                        const md = state.appData.data[year][month];
                        if (!md || !Array.isArray(md[type])) return;
                        md[type].forEach(item => {
                            if (!item) return;
                            if (item.recurringId && item.recurringId === id) affected.push({ year: Number(year), month: Number(month), amount: item.amount });
                            if (item.financingId && item.financingId === id) affected.push({ year: Number(year), month: Number(month), amount: item.amount });
                        });
                    });
                });
                if (affected.length === 0) return showToast('Nenhuma recorrência futura encontrada para esta transação.', 'bg-gray-600');
                const lines = affected.slice(0, 20).map(a => `${String(a.month).padStart(2,'0')}/${a.year}: ${formatCurrency(a.amount)}`);
                const more = affected.length > 20 ? `\n...e mais ${affected.length - 20} meses` : '';
                alert('Recorrências afetadas:\n' + lines.join('\n') + more);
            } catch (e) { console.error('previewFutureChanges', e); showToast('Erro ao gerar pré-visualização.', 'bg-red-600'); }
        }

    // Função principal para excluir
    async function deleteTransaction(type, id) {
            const currentMonthData = getCurrentMonthData();
            if (!Array.isArray(currentMonthData[type])) return;
            
            const transaction = currentMonthData[type].find(t => t.id === id);
            if (!transaction) return;

            let confirmMessage = 'Tem certeza que deseja excluir esta transação?';
            let action = () => {
                const index = currentMonthData[type].findIndex(t => t.id === id);
                if (index > -1) currentMonthData[type].splice(index, 1);
                return 'Transação excluída com sucesso!';
            };

            if (transaction.installmentId) {
                // Ask the user whether to delete only this installment or this + future installments
                try {
                    const deleteOnlyThis = await confirmAsync('Esta é uma transação parcelada. Deseja excluir apenas esta parcela? (OK = Sim, Cancel = Não)', 'Excluir parcela');
                    if (deleteOnlyThis) {
                        confirmMessage = 'Confirma exclusão desta parcela?';
                        action = () => {
                            const index = currentMonthData[type].findIndex(t => t.id === id);
                            if (index > -1) currentMonthData[type].splice(index, 1);
                            return 'Parcela excluída com sucesso!';
                        };
                    } else {
                        const deleteFuture = await confirmAsync('Deseja excluir esta e todas as parcelas futuras? (OK = Sim, Cancel = Não)', 'Excluir parcelas futuras');
                        if (deleteFuture) {
                            confirmMessage = 'Confirma exclusão desta e das parcelas futuras?';
                            action = async () => {
                                await deleteFutureInstallments(transaction.installmentId, transaction.currentInstallment);
                                return 'Parcelas excluídas com sucesso!';
                            };
                        } else {
                            // user cancelled
                            return;
                        }
                    }
                } catch(e) { return; }
            } else if (transaction.financingId) {
                // Financing case: offer to delete only this financing installment or this + future financing installments
                try {
                    const delOnly = await confirmAsync('Esta é uma parcela de financiamento. Deseja excluir apenas esta parcela? (OK = Sim, Cancel = Não)', 'Excluir parcela de financiamento');
                    if (delOnly) {
                        confirmMessage = 'Confirma exclusão desta parcela?';
                        action = () => {
                            const index = currentMonthData[type].findIndex(t => t.id === id);
                            if (index > -1) currentMonthData[type].splice(index, 1);
                            return 'Parcela excluída com sucesso!';
                        };
                    } else {
                        const delFuture = await confirmAsync('Deseja excluir esta e todas as parcelas futuras do financiamento? (OK = Sim, Cancel = Não)', 'Excluir parcelas de financiamento futuras');
                        if (delFuture) {
                            confirmMessage = 'Confirma exclusão desta e das parcelas futuras do financiamento?';
                            action = async () => {
                                await deleteFutureFinancing(transaction.financingId, transaction.currentFinancing);
                                return 'Parcelas de financiamento excluídas com sucesso!';
                            };
                        } else {
                            return;
                        }
                    }
                } catch(e) { return; }
            } else if (transaction.recurringId) {
                confirmMessage = 'Esta é uma transação recorrente. Deseja excluir esta e todas as futuras recorrências (a partir deste mês)?';
                action = async () => {
                    await deleteFutureRecurrences(transaction.recurringId);
                    return 'Recorrências excluídas com sucesso!';
                };
            }

            try {
                const ok = await confirmAsync(confirmMessage, 'Confirmar exclusão');
                if (!ok) return;
                
                // Store goalId before deletion for travel plan synchronization
                const goalIdToSync = (type === 'savings' && transaction.goalId) ? transaction.goalId : null;
                
                const toastMessage = await action();
                try {
                    await storage.saveData(state.appData);
                    showToast(toastMessage, 'bg-red-600');
                    
                    // If we deleted a savings entry linked to a goal, update the travel plan
                    if (goalIdToSync) {
                        try {
                            await updateTravelPlanSavedFromSavings(goalIdToSync);
                        } catch(e) { 
                            console.error('Erro ao sincronizar plano de viagem após exclusão:', e); 
                        }
                    }
                } catch (e) {
                    console.error('Erro ao excluir transação:', e);
                    showToast('Falha ao salvar exclusão no Firebase.', 'bg-red-600');
                }
                render();
            } catch(e) { return; }
        }

        // Ponto de entrada do formulário
        async function handleFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('transaction-id').value;
            const type = ui.transactionTypeInput.value;

            const transactionData = {
                description: document.getElementById('description').value,
                amount: parseLocaleNumber(document.getElementById('amount').value) || 0,
                isRecurring: document.getElementById('is-recurring').checked
            };

            if (!id) transactionData.id = generateUUID();

            if (type === 'expenses') {
                Object.assign(transactionData, {
                    payment: document.getElementById('payment-method').value,
                    category: document.getElementById('category-expense').value,
                    type: document.getElementById('expense-type').value,
                    isPaid: false
                });
                // Attach recipient when present
                try {
                    const pmVal = (transactionData.payment || '').toString();
                    const recipientEl = document.getElementById('payment-recipient');
                    if ((pmVal === 'PIX' || pmVal === 'Transferência') && recipientEl) {
                        const recVal = (recipientEl.value || '').toString().trim();
                        if (!recVal) {
                            setTransactionError('Informe o destinatário para PIX ou Transferência.');
                            return; // block save
                        }
                        transactionData.recipient = recVal;
                    } else if (recipientEl && recipientEl.value) {
                        // include if user filled for other methods (optional)
                        transactionData.recipient = recipientEl.value;
                    }
                } catch (rErr) { console.error('recipient collect error', rErr); }
                // If financing fields are present in the modal, include them
                const financingCheckbox = document.getElementById('is-financing');
                if (financingCheckbox && financingCheckbox.checked) {
                    const totalFin = parseInt(document.getElementById('financing-total').value, 10);
                    const currentFin = parseInt(document.getElementById('financing-current').value, 10);
                    if (!isNaN(totalFin)) transactionData.totalFinancing = totalFin;
                    if (!isNaN(currentFin)) transactionData.currentFinancing = currentFin;
                    // Keep financingId if editing
                    const existingFId = document.getElementById('transaction-id').value;
                    if (existingFId) transactionData.financingId = currentFin ? (transactionData.financingId || null) : transactionData.financingId;
                }
                // If payment method is VR, ensure category is Alimentação (or equivalent), mark as paid and record usage in current month's vrUsage ledger
                const pm = transactionData.payment || '';
                if (pm === 'VR') {
                    // Mark VR expenses as already paid (VR behaves like debit)
                    transactionData.isPaid = true;
                    const settings = state.appData.settings || {};
                    const expenseCategories = settings.expenseCategories || [];
                    // try to find an 'Alimentação' category (case-insensitive, accent-insensitive)
                    const normalize = s => (s || '').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
                    const foundAlim = expenseCategories.find(c => normalize(c).includes('aliment'));
                    const currentCat = transactionData.category || '';
                    if (!normalize(currentCat).includes('aliment')) {
                        if (foundAlim) {
                            // Auto-set to the found Alimentação category
                            transactionData.category = foundAlim;
                            showToast('Pagamento via VR: categoria ajustada para Alimentação.', 'bg-yellow-600');
                        } else {
                            // Warn user but allow save
                            try {
                                const ok = await confirmAsync('Você selecionou VR como forma de pagamento, mas a categoria não parece ser Alimentação. Deseja prosseguir?', 'Confirmar VR');
                                if (!ok) return;
                            } catch(e) { return; }
                        }
                    }
                    // Force type to Essenciais when paying with VR
                    try { transactionData.type = 'Essenciais'; } catch(e) { /* ignore */ }
                    // Validate VR balance: do not allow expense > available VR balance for current month
                    const mdCheck = getCurrentMonthData();
                    let availableVR = getMonthVRBalance(mdCheck);
                    // If editing an existing VR expense, add back the original amount so the validation allows reducing/increasing within the original envelope
                    if (id) {
                        try {
                            const existing = mdCheck.expenses && mdCheck.expenses.find(e => e.id === id);
                            if (existing && existing.payment === 'VR') {
                                availableVR = Math.round((availableVR + (Number(existing.amount) || 0)) * 100) / 100;
                            }
                        } catch (e) { console.error('adjust availableVR for edit', e); }
                    }
                    const spendAmount = Number(transactionData.amount) || 0;
                    if (spendAmount > availableVR) {
                        // Show inline error in modal so the user can immediately see the problem
                        setTransactionError('Valor superior ao saldo disponível de VR para este mês. Verifique o saldo no card de VR.');
                        return; // block save
                    } else {
                        clearTransactionError();
                    }
                        // Instead of saving this as a normal expense, store it in the month's vrUsage ledger
                        const md = getCurrentMonthData();
                        if (!Array.isArray(md.vrUsage)) md.vrUsage = [];
                        const usageEntry = { id: generateUUID(), amount: Number(transactionData.amount) || 0, description: transactionData.description || '', date: new Date().toISOString() };
                        md.vrUsage.push(usageEntry);
                        // Persist immediately and bail out of the normal expense save flow
                        try {
                            await storage.saveData(state.appData);
                            showToast('Despesa registrada no VR (lançamento separado).', 'bg-green-600');
                        } catch (e) {
                            console.error('Erro ao salvar uso de VR:', e);
                            showToast('Falha ao salvar uso de VR no Firebase.', 'bg-red-600');
                        }
                        // Close modal and re-render instead of continuing to add to expenses
                        closeModal('transaction-modal');
                        render();
                        return;
                }
                // VT mirror of VR: store VT purchases in vtUsage ledger (do not add to expenses)
                if (pm === 'VT') {
                    // Mark VT purchases similar to VR (treated as immediate debit)
                    transactionData.isPaid = true;
                    // Ensure category is Transporte (if not already)
                    try {
                        const settings = state.appData.settings || {};
                        const expenseCategories = settings.expenseCategories || [];
                        const normalize = s => (s || '').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
                        const foundTransp = expenseCategories.find(c => normalize(c).includes('transport')) || expenseCategories.find(c => normalize(c).includes('transp')) || expenseCategories.find(c => normalize(c).includes('transporte'));
                        const currentCat = transactionData.category || '';
                        if (!normalize(currentCat).includes('transp') && foundTransp) {
                            transactionData.category = foundTransp;
                            showToast('Pagamento via VT: categoria ajustada para Transporte.', 'bg-yellow-600');
                        }
                    } catch (e) { console.error('vt category enforcement', e); }

                    // If description empty, set to Abastecimento
                    if (!transactionData.description || transactionData.description.trim() === '') {
                        transactionData.description = 'Abastecimento';
                    }

                    // Validate VT balance similar to VR
                    const mdCheck = getCurrentMonthData();
                    let availableVT = getMonthVTBalance(mdCheck);
                    if (id) {
                        try {
                            const existing = (mdCheck.expenses || []).find(e => e.id === id);
                            if (existing && existing.payment === 'VT') {
                                availableVT = Math.round((availableVT + (Number(existing.amount) || 0)) * 100) / 100;
                            }
                        } catch (e) { console.error('adjust availableVT for edit', e); }
                    }
                    const spendAmount = Number(transactionData.amount) || 0;
                    if (spendAmount > availableVT) {
                        setTransactionError('Valor superior ao saldo disponível de VT para este mês. Verifique o saldo no card de VT.');
                        return;
                    } else {
                        clearTransactionError();
                    }

                    // Note: opening the dedicated VT modal from the transaction flow was removed to avoid multiple access
                    // points. The VT modal should be opened only from the '+' button inside the VT card. Fall back to
                    // storing a minimal vtUsage entry immediately.
                    const md = getCurrentMonthData();
                    if (!Array.isArray(md.vtUsage)) md.vtUsage = [];
                    const usageEntry = { id: generateUUID(), amount: Number(transactionData.amount) || 0, description: transactionData.description || '', date: new Date().toISOString() };
                    md.vtUsage.push(usageEntry);
                    try {
                        await storage.saveData(state.appData);
                        showToast('Despesa registrada no VT (lançamento separado).', 'bg-green-600');
                    } catch (e) {
                        console.error('Erro ao salvar uso de VT:', e);
                        showToast('Falha ao salvar uso de VT no Firebase.', 'bg-red-600');
                    }
                    closeModal('transaction-modal');
                    render();
                    return;
                }
            } else if (type === 'savings') {
                // Use selected saving category; goal linking removed (not functional)
                try { transactionData.category = document.getElementById('category-saving').value; } catch(e) { transactionData.category = '' }
                delete transactionData.goalId;
            }

            const isInstallment = document.getElementById('is-installment').checked;
            const installmentsCount = parseInt(document.getElementById('installment-count')?.value || document.getElementById('installments-count')?.value, 10);
            const isFinancing = document.getElementById('is-financing').checked;
            const financingTotal = parseInt(document.getElementById('financing-total').value, 10);
            const financingCurrent = parseInt(document.getElementById('financing-current').value, 10);

            try {
                const currentMonthData = getCurrentMonthData();
                // If editing an existing expense and user converted it to installments/financing, handle conversion
                if (id && type === 'expenses') {
                    const original = currentMonthData.expenses.find(t => t.id === id);
                    if (original) {
                        // Convert single expense -> installments
                        if (isInstallment && installmentsCount > 1 && !original.installmentId && !original.financingId) {
                            // remove original single transaction
                            const idx = currentMonthData.expenses.findIndex(t => t.id === id);
                            if (idx > -1) currentMonthData.expenses.splice(idx, 1);
                            const startInstallment = parseInt(document.getElementById('installment-start')?.value || document.getElementById('installments-current')?.value || '1', 10) || 1;
                            await createInstallments(transactionData, installmentsCount, startInstallment);
                            // done
                            closeModal('transaction-modal');
                            render();
                            return;
                        }
                        // Convert single expense -> financing
                        if (isFinancing && financingTotal > 1 && financingCurrent >= 1 && !original.financingId && !original.installmentId) {
                            const idx = currentMonthData.expenses.findIndex(t => t.id === id);
                            if (idx > -1) currentMonthData.expenses.splice(idx, 1);
                            await createFinancing(transactionData, financingTotal, financingCurrent);
                            closeModal('transaction-modal');
                            render();
                            return;
                        }
                    }
                }

                // Default flows for creating new or simple edits
                    if (type === 'expenses' && isInstallment && installmentsCount > 1 && !id) {
                    // console.debug('[handleFormSubmit] creating installments (new)', installmentsCount /*, transactionData */);
                    const startInstallment = parseInt(document.getElementById('installment-start')?.value || document.getElementById('installments-current')?.value || '1', 10) || 1;
                    await createInstallments(transactionData, installmentsCount, startInstallment);
                } else if (type === 'expenses' && isFinancing && financingTotal > 1 && financingCurrent >= 1 && !id) {
                    // console.debug('[handleFormSubmit] creating financing (new)', financingTotal, financingCurrent /*, transactionData */);
                    await createFinancing(transactionData, financingTotal, financingCurrent);
                } else if (type === 'incomes' && isFinancing && financingTotal > 1 && financingCurrent >= 1 && !id) {
                    // Creating financing for incomes (receivable financing)
                    await createIncomeFinancing(transactionData, financingTotal, financingCurrent);
                } else if (type === 'incomes' && isInstallment && installmentsCount > 1 && !id) {
                    // Creating parcelada (installments) for incomes (Serviço)
                    const startInstallment = parseInt(document.getElementById('installment-start')?.value || document.getElementById('installments-current')?.value || '1', 10) || 1;
                    await createIncomeInstallments(transactionData, installmentsCount, startInstallment);
                } else if (type === 'incomes' && document.getElementById('is-salary') && document.getElementById('is-salary').checked) {
                // Special handling for salary: calculate breakdown and update/create entries
                try {
                        const year = state.currentDate.getFullYear();
                        const month = state.currentDate.getMonth() + 1;
                        // If salary-base not provided, prefer the main 'amount' field when description indicates salary
                        const amountFieldVal = parseLocaleNumber((document.getElementById('amount') || { value: 0 }).value) || 0;
                        const providedSalaryBase = parseLocaleNumber((document.getElementById('salary-base') || { value: 0 }).value) || 0;
                        const salarioBaseToUse = providedSalaryBase > 0 ? providedSalaryBase : amountFieldVal;

                        // read current recurring checkbox value at submit time
                        const isRecurringNow = document.getElementById('is-recurring') ? document.getElementById('is-recurring').checked : !!transactionData.isRecurring;

                        // Helper: parse hours input which may be decimal or HH:MM (e.g. "117:20")
                        const parseHoursString = (raw) => {
                            try {
                                if (raw === undefined || raw === null) return 0;
                                if (typeof raw === 'number') return raw;
                                let s = String(raw).trim();
                                if (s === '') return 0;
                                // If contains colon, treat as H:MM or HH:MM
                                const colonMatch = s.match(/^(-?\d+):([0-5]?\d)$/);
                                if (colonMatch) {
                                    const h = parseInt(colonMatch[1], 10) || 0;
                                    const m = parseInt(colonMatch[2], 10) || 0;
                                    const totalMinutes = h * 60 + (h < 0 ? -m : m);
                                    return Math.round((totalMinutes / 60) * 1000000) / 1000000; // keep reasonable precision
                                }
                                // Replace comma with dot for locales that use comma
                                s = s.replace(',', '.');
                                const fv = parseFloat(s);
                                return isNaN(fv) ? 0 : fv;
                            } catch (e) { return 0; }
                        };

                        const rawHoursRaw = (document.getElementById('salary-horas-trabalhadas') || { value: '' }).value;
                        const params = {
                            salarioBase: salarioBaseToUse,
                            percentualPericulosidade: parseLocaleNumber((document.getElementById('salary-periculosidade') || { value: 0 }).value) || 0,
                            outrosProventosTributaveis: parseLocaleNumber((document.getElementById('salary-outros-proventos') || { value: 0 }).value) || 0,
                            numeroDependentes: parseInt((document.getElementById('salary-dependentes') || { value: 0 }).value, 10) || 0,
                            valorDesjejumDia: parseLocaleNumber((document.getElementById('salary-desjejum-dia') || { value: 0 }).value) || 0,
                            valorTransporteDia: parseLocaleNumber((document.getElementById('salary-transporte-dia') || { value: 0 }).value) || 0,
                            diasTrabalhados: parseInt((document.getElementById('salary-dias-trabalhados') || { value: '' }).value, 10) || undefined,
                            // hoursTrabalhadas accepts decimal or HH:MM (e.g. "117:20"). Minutes will be converted to fractional hours.
                            hoursTrabalhadas: parseHoursString(rawHoursRaw) || 0,
                            // preserve the original string (e.g. "117:20") so we can store it in salaryMeta and show/edit later
                            horasTrabalhadasRaw: rawHoursRaw || '',
                            horasExtrasSabado: parseHoursString((document.getElementById('salary-h-extra-sab') || { value: 0 }).value) || 0,
                            horasExtrasDomingo: parseHoursString((document.getElementById('salary-h-extra-dom') || { value: 0 }).value) || 0,
                            jornadaMensalHoras: parseHoursString((document.getElementById('salary-jornada-horas') || { value: 220 }).value) || 220,
                            // hoursTrabalhadas will be set/used inside calcularSalarioLiquido when needed
                            year, month
                        };
                        const calc = calcularSalarioLiquido(params);
                        // parse formatted numbers back to numeric values
                        const parseNum = (s) => { try { return typeof s === 'number' ? s : parseFloat(String(s).replace(/\./g, '').replace(',', '.')) || parseFloat(s); } catch(e){ return parseFloat(s) || 0; } };
                        // The function currently returns formatted strings in resumo; they use dot as decimal separator (toFixed)
                        const salarioLiquido = parseFloat(calc.resumo.salarioLiquido) || 0;
                        const beneficiosTotais = parseFloat(calc.resumo.beneficiosTotais) || 0;
                        const valorHorasExtras = parseFloat(calc.resumo.valorHorasExtras) || 0;

                        // create helper to build values for a given month
                        const buildValuesFor = (pMonthly) => {
                            const calcMonth = calcularSalarioLiquido(pMonthly);
                            const salarioLiquidoM = parseFloat(calcMonth.resumo.salarioLiquido) || 0;
                            const valorHorasExtrasM = parseFloat(calcMonth.resumo.valorHorasExtras) || 0;
                            // Benefits refer to the following month
                            const nextDate = new Date(pMonthly.year, pMonthly.month, 1);
                            const nextY2 = nextDate.getFullYear();
                            const nextM2 = nextDate.getMonth() + 1;
                            const roundLocal = (v) => Math.round((v + Number.EPSILON) * 100) / 100;
                            // VT: transporte benefit per requirement - use dias úteis do MÊS SELECIONADO + 1
                            const beneficiosVTM = roundLocal((pMonthly.valorTransporteDia || 0) * (diasUteisNoMes(pMonthly.year, pMonthly.month) + 1));
                            // VR: desjejum benefit per requirement - use dias úteis do MÊS SELECIONADO + 1
                            const beneficiosVRM = roundLocal((pMonthly.valorDesjejumDia || 0) * (diasUteisNoMes(pMonthly.year, pMonthly.month) + 1));
                            return { salarioLiquido: salarioLiquidoM, beneficiosVT: beneficiosVTM, beneficiosVR: beneficiosVRM, valorHorasExtras: valorHorasExtrasM };
                        };

                        // helper to remove previous salary-generated items in a month by recurringId or by salaryMeta
                        const removeSalaryItemsFromMonth = (monthDataObj, opts) => {
                            if (!monthDataObj) return;
                            const oldMetaStr = opts.oldMetaStr || null;
                            const rid = opts.recurringId || null;
                            if (!Array.isArray(monthDataObj.incomes)) monthDataObj.incomes = [];
                            // Ensure ledgers exist
                            if (!Array.isArray(monthDataObj.vrLedger)) monthDataObj.vrLedger = [];
                            if (!Array.isArray(monthDataObj.vtLedger)) monthDataObj.vtLedger = [];
                            // Remove incomes and ledger entries that belong to the recurringId when provided
                            if (rid) {
                                monthDataObj.incomes = monthDataObj.incomes.filter(i => i.recurringId !== rid);
                                monthDataObj.vrLedger = monthDataObj.vrLedger.filter(l => l.recurringId !== rid);
                                monthDataObj.vtLedger = monthDataObj.vtLedger.filter(l => l.recurringId !== rid);
                            } else if (oldMetaStr) {
                                monthDataObj.incomes = monthDataObj.incomes.filter(i => !(i.salaryMeta && JSON.stringify(i.salaryMeta) === oldMetaStr));
                                monthDataObj.vrLedger = monthDataObj.vrLedger.filter(l => !(l.salaryMeta && JSON.stringify(l.salaryMeta) === oldMetaStr));
                                monthDataObj.vtLedger = monthDataObj.vtLedger.filter(l => !(l.salaryMeta && JSON.stringify(l.salaryMeta) === oldMetaStr));
                            }
                        };

                        // pushEntriesToMonth re-used (keeps salaryMeta on created items)
                        const pushEntriesToMonth = (monthDataObj, rId, values, meta) => {
                            if (!Array.isArray(monthDataObj.incomes)) monthDataObj.incomes = [];
                            if (!Array.isArray(monthDataObj.vrLedger)) monthDataObj.vrLedger = [];
                            if (!Array.isArray(monthDataObj.vtLedger)) monthDataObj.vtLedger = [];
                            const toPush = [];
                            if (values.salarioLiquido > 0) toPush.push({ id: generateUUID(), description: `Salário (Líquido)`, amount: values.salarioLiquido, isRecurring: !!transactionData.isRecurring, recurringId: rId, source: 'salary', salaryMeta: meta || null });
                            // VT should be stored in vtLedger (mirror VR implementation) to avoid showing twice in incomes
                            if (values.beneficiosVT > 0) {
                                monthDataObj.vtLedger.push({ id: generateUUID(), description: 'Benefício - VT', amount: values.beneficiosVT, recurringId: rId || null, isRecurring: !!rId, salaryMeta: meta || null });
                            }
                            if (values.beneficiosVR > 0) {
                                monthDataObj.vrLedger.push({ id: generateUUID(), description: 'Benefício - VR', amount: values.beneficiosVR, recurringId: rId || null, isRecurring: !!rId, salaryMeta: meta || null });
                            }
                            if (values.valorHorasExtras > 0) toPush.push({ id: generateUUID(), description: `Horas Extras`, amount: values.valorHorasExtras, isRecurring: !!transactionData.isRecurring, recurringId: rId, source: 'overtime', salaryMeta: meta || null });
                            toPush.forEach(en => monthDataObj.incomes.push(en));
                        };

                        // Now handle editing vs creating
                        if (id) {
                            // Editing an existing income: try to find the original salary income
                            const original = currentMonthData.incomes.find(t => t.id === id);
                            const oldMetaStr = original && original.salaryMeta ? JSON.stringify(original.salaryMeta) : null;
                            const origRecurringId = original && original.recurringId ? original.recurringId : null;
                            let applyToFuture = false;
                            if (origRecurringId) {
                                try { applyToFuture = await confirmAsync('Essa é uma entrada recorrente. Deseja aplicar as alterações às recorrências futuras? (OK = Sim)', 'Aplicar às futuras'); } catch(e) { applyToFuture = false; }
                            }

                            if (origRecurringId && applyToFuture) {
                                // Update this and future months for this recurringId
                                Object.keys(state.appData.data).forEach(yearKey => {
                                    Object.keys(state.appData.data[yearKey]).forEach(monthKey => {
                                        const monthStart = new Date(Number(yearKey), Number(monthKey) - 1, 1);
                                        const editedMonthStart = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), 1);
                                        if (monthStart >= editedMonthStart) {
                                            const md = state.appData.data[yearKey][monthKey];
                                            // remove old recurring entries
                                            removeSalaryItemsFromMonth(md, { recurringId: origRecurringId });
                                            // compute pMonthly for this month
                                            const pMonthly = Object.assign({}, params, { year: Number(yearKey), month: Number(monthKey) });
                                            const vals = buildValuesFor(pMonthly);
                                            const meta = { salarioBase: pMonthly.salarioBase, percentualPericulosidade: pMonthly.percentualPericulosidade, outrosProventosTributaveis: pMonthly.outrosProventosTributaveis, numeroDependentes: pMonthly.numeroDependentes, valorDesjejumDia: pMonthly.valorDesjejumDia, valorTransporteDia: pMonthly.valorTransporteDia, diasTrabalhados: pMonthly.diasTrabalhados, horasTrabalhadas: pMonthly.hoursTrabalhadas, jornadaMensalHoras: pMonthly.jornadaMensalHoras };
                                            pushEntriesToMonth(md, origRecurringId, vals, meta);
                                        }
                                    });
                                });
                            } else {
                                // Update only current month
                                removeSalaryItemsFromMonth(currentMonthData, { oldMetaStr, recurringId: origRecurringId && !applyToFuture ? origRecurringId : null });
                                const pMonthlyNow = Object.assign({}, params, { year: state.currentDate.getFullYear(), month: state.currentDate.getMonth() + 1 });
                                const valsNow = buildValuesFor(pMonthlyNow);
                                const metaNow = { salarioBase: pMonthlyNow.salarioBase, percentualPericulosidade: pMonthlyNow.percentualPericulosidade, outrosProventosTributaveis: pMonthlyNow.outrosProventosTributaveis, numeroDependentes: pMonthlyNow.numeroDependentes, valorDesjejumDia: pMonthlyNow.valorDesjejumDia, valorTransporteDia: pMonthlyNow.valorTransporteDia, diasTrabalhados: pMonthlyNow.diasTrabalhados, horasTrabalhadas: pMonthlyNow.hoursTrabalhadas, jornadaMensalHoras: pMonthlyNow.jornadaMensalHoras };
                                // Keep original recurringId on this month if it existed
                                const targetRid = origRecurringId || (transactionData.isRecurring ? generateUUID() : null);
                                pushEntriesToMonth(currentMonthData, targetRid, valsNow, metaNow);
                            }

                            try { await storage.saveData(state.appData); showToast('Salário atualizado com sucesso!', 'bg-green-600'); } catch(e){ console.error('save edited salary', e); showToast('Falha ao salvar salário editado.', 'bg-red-600'); }
                        } else {
                            // Creating new salary entries (no id provided)
                            const recurringId = transactionData.isRecurring ? generateUUID() : null;
                            if (transactionData.isRecurring) {
                                const rId = recurringId;
                                for (let i = 0; i < 12; i++) {
                                    const d = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() + i, 1);
                                    const y = d.getFullYear();
                                    const m = d.getMonth() + 1;
                                    const pMonthly = Object.assign({}, params, { year: y, month: m });
                                    const vals = buildValuesFor(pMonthly);
                                    const md = getCurrentMonthData(new Date(y, m - 1, 1));
                                    const meta = { salarioBase: pMonthly.salarioBase, percentualPericulosidade: pMonthly.percentualPericulosidade, outrosProventosTributaveis: pMonthly.outrosProventosTributaveis, numeroDependentes: pMonthly.numeroDependentes, valorDesjejumDia: pMonthly.valorDesjejumDia, valorTransporteDia: pMonthly.valorTransporteDia, diasTrabalhados: pMonthly.diasTrabalhados, horasTrabalhadas: pMonthly.hoursTrabalhadas, jornadaMensalHoras: pMonthly.jornadaMensalHoras };
                                    pushEntriesToMonth(md, rId, vals, meta);
                                }
                            } else {
                                const pMonthlyNow = Object.assign({}, params, { year: state.currentDate.getFullYear(), month: state.currentDate.getMonth() + 1 });
                                const valsNow = buildValuesFor(pMonthlyNow);
                                const metaNow = { salarioBase: pMonthlyNow.salarioBase, percentualPericulosidade: pMonthlyNow.percentualPericulosidade, outrosProventosTributaveis: pMonthlyNow.outrosProventosTributaveis, numeroDependentes: pMonthlyNow.numeroDependentes, valorDesjejumDia: pMonthlyNow.valorDesjejumDia, valorTransporteDia: pMonthlyNow.valorTransporteDia, diasTrabalhados: pMonthlyNow.diasTrabalhados, horasTrabalhadas: pMonthlyNow.hoursTrabalhadas, jornadaMensalHoras: pMonthlyNow.jornadaMensalHoras };
                                pushEntriesToMonth(currentMonthData, null, valsNow, metaNow);
                            }
                            try { await storage.saveData(state.appData); showToast('Salário salvo com sucesso!', 'bg-green-600'); } catch(e){ console.error('save new salary', e); showToast('Falha ao salvar salário no Firebase.', 'bg-red-600'); }
                        }

                        try {
                            await storage.saveData(state.appData);
                            showToast('Salário salvo com sucesso!', 'bg-green-600');
                        } catch (err) {
                            console.error('Erro ao salvar salário:', err);
                            showToast('Falha ao salvar salário no Firebase.', 'bg-red-600');
                        }

                        // Optionally show a quick details toast with totals (short)
                        // showToast(`Líquido: ${formatCurrency(salarioLiquido)} • Benefícios: ${formatCurrency(beneficiosTotais)} • Extras: ${formatCurrency(valorHorasExtras)}`, 'bg-blue-600');

                    } catch (err) {
                        console.error('Erro no processamento do salário:', err);
                        showToast('Erro ao processar salário: ' + (err && err.message ? err.message : ''), 'bg-red-600');
                    }
                } else {
                    await saveTransaction(transactionData, type, id);
                }
            } catch (e) {
                console.error('Erro ao processar formulário:', e);
                showToast('Erro ao salvar transação: ' + (e && e.message ? e.message : ''), 'bg-red-600');
            }

            closeModal('transaction-modal');
            render();
        }

            // --- VR inline-edit helpers ---
            function startInlineVREdit(el, vrId) {
                try {
                    if (!el) return;
                    const current = el.textContent || '';
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = '0.01';
                    input.value = parseFloat(String(current).replace(/[R$\.\s]/g, '').replace(',', '.')) || 0;
                    input.className = 'inline-vr-input border px-1 py-0 rounded text-right';
                    input.style.minWidth = '80px';
                    el.replaceWith(input);
                    input.focus();
                    input.select();
                    const commit = async () => {
                        const v = parseFloat(input.value) || 0;
                        await commitInlineVREdit(vrId, v, input);
                    };
                    input.addEventListener('blur', commit);
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') { input.blur(); }
                        if (e.key === 'Escape') { render(); }
                    });
                } catch(e){ console.error('startInlineVREdit', e); }
            }

            async function commitInlineVREdit(vrId, newAmount, inputEl) {
                try {
                    const md = getCurrentMonthData();
                    if (!Array.isArray(md.vrLedger)) md.vrLedger = [];
                    const idx = md.vrLedger.findIndex(l => l.id === vrId);
                    if (idx === -1) return render();
                    const entry = md.vrLedger[idx];
                    const oldAmount = entry.amount || 0;
                    entry.amount = Math.round((Number(newAmount) + Number.EPSILON) * 100) / 100;
                    try { await storage.saveData(state.appData); } catch(e){ console.error('commitInlineVREdit save', e); }
                    // Inline edits should not forcibly apply to future recurrences; explicit action via modal will allow that.
                    render();
                } catch(e){ console.error('commitInlineVREdit', e); }
            }

            function applyToFutureVREntries(recurringId, newAmount) {
                try {
                    Object.keys(state.appData.data).forEach(year => {
                        Object.keys(state.appData.data[year]).forEach(month => {
                            const md = state.appData.data[year][month];
                            if (!md || !Array.isArray(md.vrLedger)) return;
                            md.vrLedger = md.vrLedger.map(l => {
                                if (l.recurringId === recurringId) {
                                    return { ...l, amount: newAmount };
                                }
                                return l;
                            });
                        });
                    });
                    try { storage.saveData(state.appData); } catch(e){ console.error('applyToFutureVREntries save', e); }
                    showToast('Alterações aplicadas às recorrências futuras.', 'bg-green-600');
                } catch(e){ console.error('applyToFutureVREntries', e); }
            }

                // --- VT inline-edit helpers (mirror of VR) ---
                function startInlineVTEdit(el, vtId) {
                    try {
                        if (!el) return;
                        const current = el.textContent || '';
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.step = '0.01';
                        input.value = parseFloat(String(current).replace(/[R$\.\s]/g, '').replace(',', '.')) || 0;
                        input.className = 'inline-vt-input border px-1 py-0 rounded text-right';
                        input.style.minWidth = '80px';
                        el.replaceWith(input);
                        input.focus();
                        input.select();
                        const commit = async () => {
                            const v = parseFloat(input.value) || 0;
                            await commitInlineVTEdit(vtId, v, input);
                        };
                        input.addEventListener('blur', commit);
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') { input.blur(); }
                            if (e.key === 'Escape') { render(); }
                        });
                    } catch(e){ console.error('startInlineVTEdit', e); }
                }

                async function commitInlineVTEdit(vtId, newAmount, inputEl) {
                    try {
                        const md = getCurrentMonthData();
                        if (!Array.isArray(md.vtLedger)) md.vtLedger = [];
                        const idx = md.vtLedger.findIndex(l => l.id === vtId);
                        if (idx === -1) return render();
                        const entry = md.vtLedger[idx];
                        const oldAmount = entry.amount || 0;
                        entry.amount = Math.round((Number(newAmount) + Number.EPSILON) * 100) / 100;
                        try { await storage.saveData(state.appData); } catch(e){ console.error('commitInlineVTEdit save', e); }
                        render();
                    } catch(e){ console.error('commitInlineVTEdit', e); }
                }

                function applyToFutureVTEntries(recurringId, newAmount) {
                    try {
                        Object.keys(state.appData.data).forEach(year => {
                            Object.keys(state.appData.data[year]).forEach(month => {
                                const md = state.appData.data[year][month];
                                if (!md || !Array.isArray(md.vtLedger)) return;
                                md.vtLedger = md.vtLedger.map(l => {
                                    if (l.recurringId === recurringId) {
                                        return { ...l, amount: newAmount };
                                    }
                                    return l;
                                });
                            });
                        });
                        try { storage.saveData(state.appData); } catch(e){ console.error('applyToFutureVTEntries save', e); }
                        showToast('Alterações aplicadas às recorrências futuras.', 'bg-green-600');
                    } catch(e){ console.error('applyToFutureVTEntries', e); }
                }

            // Delete a VR ledger entry by id. If it's recurring, ask to remove future recurrences as well.
            async function deleteVRLedgerEntry(id, yearContext, monthContext) {
                try {
                    if (!id) return;
                    const y = yearContext || state.currentDate.getFullYear();
                    const m = monthContext || (state.currentDate.getMonth() + 1);
                    const monthData = getCurrentMonthData(new Date(y, m - 1, 1));
                    if (!monthData || !Array.isArray(monthData.vrLedger)) return;
                    const idx = monthData.vrLedger.findIndex(v => v.id === id);
                    if (idx === -1) return;
                    const entry = monthData.vrLedger[idx];
                    let removeFuture = false;
                    if (entry && entry.recurringId) {
                        try { removeFuture = await confirmAsync('Este VR é recorrente. Deseja excluir também as recorrências futuras? (OK = Sim)', 'Excluir recorrências VR'); } catch(e) { removeFuture = false; }
                    }
                    // remove this entry from current month
                    monthData.vrLedger.splice(idx, 1);
                    // if removeFuture and entry.recurringId, sweep future months
                    if (removeFuture && entry && entry.recurringId) {
                        const rid = entry.recurringId;
                        const currentMonthStart = new Date(y, m - 1, 1);
                        Object.keys(state.appData.data).forEach(yearKey => {
                            Object.keys(state.appData.data[yearKey]).forEach(monthKey => {
                                const yearNum = Number(yearKey);
                                const monthNum = Number(monthKey);
                                const candidate = new Date(yearNum, monthNum - 1, 1);
                                if (candidate >= currentMonthStart) {
                                    const md = state.appData.data[yearKey][monthKey];
                                    if (md && Array.isArray(md.vrLedger)) {
                                        md.vrLedger = md.vrLedger.filter(v => v.recurringId !== rid);
                                    }
                                }
                            });
                        });
                    }
                    try { await storage.saveData(state.appData); showToast('VR excluído.'); } catch (e) { console.error('delete vr save', e); showToast('Falha ao excluir VR.', 'bg-red-600'); }
                } catch (e) { console.error('deleteVRLedgerEntry', e); }
            }

            // Delete VT ledger entry by id (mirror VR behavior)
            async function deleteVTLedgerEntry(id, yearContext, monthContext) {
                try {
                    if (!id) return;
                    const y = yearContext || state.currentDate.getFullYear();
                    const m = monthContext || (state.currentDate.getMonth() + 1);
                    const monthData = getCurrentMonthData(new Date(y, m - 1, 1));
                    if (!monthData || !Array.isArray(monthData.vtLedger)) return;
                    const idx = monthData.vtLedger.findIndex(v => v.id === id);
                    if (idx === -1) return;
                    const entry = monthData.vtLedger[idx];
                    let removeFuture = false;
                    if (entry && entry.recurringId) {
                        try { removeFuture = await confirmAsync('Este VT é recorrente. Deseja excluir também as recorrências futuras? (OK = Sim)', 'Excluir recorrências VT'); } catch(e) { removeFuture = false; }
                    }
                    monthData.vtLedger.splice(idx, 1);
                    if (removeFuture && entry && entry.recurringId) {
                        const rid = entry.recurringId;
                        const currentMonthStart = new Date(y, m - 1, 1);
                        Object.keys(state.appData.data).forEach(yearKey => {
                            Object.keys(state.appData.data[yearKey]).forEach(monthKey => {
                                const yearNum = Number(yearKey);
                                const monthNum = Number(monthKey);
                                const candidate = new Date(yearNum, monthNum - 1, 1);
                                if (candidate >= currentMonthStart) {
                                    const md = state.appData.data[yearKey][monthKey];
                                    if (md && Array.isArray(md.vtLedger)) {
                                        md.vtLedger = md.vtLedger.filter(v => v.recurringId !== rid);
                                    }
                                }
                            });
                        });
                    }
                    try { await storage.saveData(state.appData); showToast('VT excluído.'); } catch (e) { console.error('delete vt save', e); showToast('Falha ao excluir VT.', 'bg-red-600'); }
                } catch (e) { console.error('deleteVTLedgerEntry', e); }
            }

            // Open the VR modal to edit a ledger entry
            function openVREdit(id) {
                try {
                    const modal = document.getElementById('vr-modal');
                    if (!modal) return;
                    const md = getCurrentMonthData();
                    const entry = (md.vrLedger || []).find(v => v.id === id) || null;
                    if (entry) {
                        document.getElementById('vr-entry-id').value = entry.id || '';
                        document.getElementById('vr-entry-desc').value = entry.description || 'Benefício - VR';
                        document.getElementById('vr-entry-amount').value = entry.amount || 0;
                    } else {
                        document.getElementById('vr-entry-id').value = '';
                        document.getElementById('vr-entry-desc').value = 'Benefício - VR';
                        document.getElementById('vr-entry-amount').value = '';
                    }
                    try { modal.showModal(); } catch(e){ console.error('openVREdit showModal', e); }
                } catch (e) { console.error('openVREdit', e); }
            }

            function closeVRModal() {
                try { const m = document.getElementById('vr-modal'); if (m && typeof m.close === 'function') m.close(); } catch(e) { console.error('closeVRModal', e); }
            }

            async function saveVRLedgerEntry() {
                try {
                    const id = document.getElementById('vr-entry-id').value;
                    const desc = document.getElementById('vr-entry-desc').value || 'Benefício - VR';
                    const amount = parseLocaleNumber(document.getElementById('vr-entry-amount').value) || 0;
                    const md = getCurrentMonthData();
                    if (!Array.isArray(md.vrLedger)) md.vrLedger = [];
                    if (id) {
                        const idx = md.vrLedger.findIndex(v => v.id === id);
                        if (idx > -1) {
                            // Update only this month. VR edits are independent by default.
                            md.vrLedger[idx].description = desc;
                            md.vrLedger[idx].amount = amount;
                        }
                    } else {
                        md.vrLedger.push({ id: generateUUID(), description: desc, amount: amount, recurringId: null, isRecurring: false });
                    }
                    await storage.saveData(state.appData);
                    closeVRModal();
                    render();
                    showToast('VR salvo.', 'bg-green-600');
                } catch (e) { console.error('saveVRLedgerEntry', e); showToast('Falha ao salvar VR.', 'bg-red-600'); }
            }

            // VR Usage edit helpers
            function openVRUsageEdit(id) {
                try {
                    const md = getCurrentMonthData();
                    const entry = (md.vrUsage || []).find(u => u.id === id);
                    const modal = document.getElementById('vr-usage-modal');
                    if (!modal) return;
                    if (entry) {
                        document.getElementById('vr-usage-id').value = entry.id || '';
                        document.getElementById('vr-usage-desc').value = entry.description || '';
                        document.getElementById('vr-usage-amount').value = entry.amount || 0;
                    } else {
                        document.getElementById('vr-usage-id').value = '';
                        document.getElementById('vr-usage-desc').value = '';
                        document.getElementById('vr-usage-amount').value = '';
                    }
                    try { modal.showModal(); } catch(e) { console.error('openVRUsageEdit showModal', e); }
                } catch(e) { console.error('openVRUsageEdit', e); }
            }

            function closeVRUsageModal() {
                try { const m = document.getElementById('vr-usage-modal'); if (m && typeof m.close === 'function') m.close(); } catch(e) { console.error('closeVRUsageModal', e); }
            }

            async function saveVRUsageEdit(e) {
                try {
                    if (e && typeof e.preventDefault === 'function') e.preventDefault();
                    const id = document.getElementById('vr-usage-id').value;
                    const desc = document.getElementById('vr-usage-desc').value || '';
                    const amount = parseLocaleNumber(document.getElementById('vr-usage-amount').value) || 0;
                    const md = getCurrentMonthData();
                    if (!Array.isArray(md.vrUsage)) md.vrUsage = [];
                    // Validate against available VR balance for this month.
                    const ledgerTotal = (Array.isArray(md.vrLedger) ? md.vrLedger.reduce((s,l) => s + (Number(l && l.amount) || 0), 0) : 0);
                    const currentUsageExcludingThis = (md.vrUsage || []).reduce((s,u) => s + (Number(u && u.amount) || 0), 0) - ((id && md.vrUsage.find(u => u.id === id)) ? Number(md.vrUsage.find(u => u.id === id).amount || 0) : 0);
                    const projectedUsage = Math.round((currentUsageExcludingThis + amount) * 100) / 100;
                    if (projectedUsage > Math.round((ledgerTotal + Number.EPSILON) * 100) / 100) {
                        // Exceeds available VR balance — show inline error and abort
                        // Use transaction error area if transaction modal is open, otherwise toast
                        try {
                            setTransactionError('Valor superior ao saldo disponível de VR para este mês. Verifique o saldo no card de VR.');
                        } catch(e) { /* ignore */ }
                        showToast('Saldo de VR insuficiente para esta edição.', 'bg-red-600');
                        return; // abort save
                    }

                    if (id) {
                        const idx = md.vrUsage.findIndex(u => u.id === id);
                        if (idx > -1) {
                            md.vrUsage[idx].description = desc;
                            md.vrUsage[idx].amount = amount;
                        }
                    } else {
                        md.vrUsage.push({ id: generateUUID(), description: desc, amount: amount, date: new Date().toISOString() });
                    }
                    try { await storage.saveData(state.appData); showToast('Compra VR salva.', 'bg-green-600'); } catch(e) { console.error('saveVRUsageEdit save', e); showToast('Falha ao salvar compra VR.', 'bg-red-600'); }
                    closeVRUsageModal();
                    render();
                } catch(e) { console.error('saveVRUsageEdit', e); }
            }

            // VT Ledger helpers
            function openVTEdit(id) {
                try {
                    const modal = document.getElementById('vt-modal');
                    if (!modal) return;
                    const md = getCurrentMonthData();
                    const entry = (md.vtLedger || []).find(v => v.id === id) || null;
                    if (entry) {
                        document.getElementById('vt-entry-id').value = entry.id || '';
                        document.getElementById('vt-entry-desc').value = entry.description || 'Benefício - VT';
                        document.getElementById('vt-entry-amount').value = entry.amount || 0;
                    } else {
                        document.getElementById('vt-entry-id').value = '';
                        document.getElementById('vt-entry-desc').value = 'Benefício - VT';
                        document.getElementById('vt-entry-amount').value = '';
                    }
                    try { modal.showModal(); } catch(e){ console.error('openVTEdit showModal', e); }
                } catch (e) { console.error('openVTEdit', e); }
            }

            function closeVTModal() {
                try { const m = document.getElementById('vt-modal'); if (m && typeof m.close === 'function') m.close(); } catch(e) { console.error('closeVTModal', e); }
            }

            async function saveVTLedgerEntry() {
                try {
                    const id = document.getElementById('vt-entry-id').value;
                    const desc = document.getElementById('vt-entry-desc').value || 'Benefício - VT';
                    const amount = parseLocaleNumber(document.getElementById('vt-entry-amount').value) || 0;
                    const md = getCurrentMonthData();
                    if (!Array.isArray(md.vtLedger)) md.vtLedger = [];
                    if (id) {
                        const idx = md.vtLedger.findIndex(v => v.id === id);
                        if (idx > -1) {
                            md.vtLedger[idx].description = desc;
                            md.vtLedger[idx].amount = amount;
                        }
                    } else {
                        md.vtLedger.push({ id: generateUUID(), description: desc, amount: amount, recurringId: null, isRecurring: false });
                    }
                    await storage.saveData(state.appData);
                    closeVTModal();
                    render();
                    showToast('VT salvo.', 'bg-green-600');
                } catch (e) { console.error('saveVTLedgerEntry', e); showToast('Falha ao salvar VT.', 'bg-red-600'); }
            }

            // VT Usage edit helpers
            function openVTUsageEdit(id) {
                try {
                    const md = getCurrentMonthData();
                    const entry = (md.vtUsage || []).find(u => u.id === id);
                    const modal = document.getElementById('vt-usage-modal');
                    if (!modal) return;
                    if (entry) {
                        document.getElementById('vt-usage-id').value = entry.id || '';
                        document.getElementById('vt-usage-desc').value = entry.description || '';
                        document.getElementById('vt-usage-amount').value = entry.amount || 0;
                    } else {
                        document.getElementById('vt-usage-id').value = '';
                        document.getElementById('vt-usage-desc').value = '';
                        document.getElementById('vt-usage-amount').value = '';
                    }
                    try { modal.showModal(); } catch(e) { console.error('openVTUsageEdit showModal', e); }
                } catch(e) { console.error('openVTUsageEdit', e); }
            }

            function closeVTUsageModal() {
                try { const m = document.getElementById('vt-usage-modal'); if (m && typeof m.close === 'function') m.close(); } catch(e) { console.error('closeVTUsageModal', e); }
            }

            async function saveVTUsageEdit(e) {
                try {
                    if (e && typeof e.preventDefault === 'function') e.preventDefault();
                    const id = document.getElementById('vt-usage-id').value;
                    const desc = document.getElementById('vt-usage-desc').value || '';
                    const amount = parseLocaleNumber(document.getElementById('vt-usage-amount').value) || 0;
                    const md = getCurrentMonthData();
                    if (!Array.isArray(md.vtUsage)) md.vtUsage = [];
                    // Validate against available VT balance for this month.
                    const ledgerTotal = (Array.isArray(md.vtLedger) ? md.vtLedger.reduce((s,l) => s + (Number(l && l.amount) || 0), 0) : 0);
                    const currentUsageExcludingThis = (md.vtUsage || []).reduce((s,u) => s + (Number(u && u.amount) || 0), 0) - ((id && md.vtUsage.find(u => u.id === id)) ? Number(md.vtUsage.find(u => u.id === id).amount || 0) : 0);
                    const projectedUsage = Math.round((currentUsageExcludingThis + amount) * 100) / 100;
                    if (projectedUsage > Math.round((ledgerTotal + Number.EPSILON) * 100) / 100) {
                        try { setTransactionError('Valor superior ao saldo disponível de VT para este mês. Verifique o saldo no card de VT.'); } catch(e) {}
                        showToast('Saldo de VT insuficiente para esta edição.', 'bg-red-600');
                        return; // abort save
                    }

                    if (id) {
                        const idx = md.vtUsage.findIndex(u => u.id === id);
                        if (idx > -1) {
                            md.vtUsage[idx].description = desc;
                            md.vtUsage[idx].amount = amount;
                        }
                    } else {
                        md.vtUsage.push({ id: generateUUID(), description: desc, amount: amount, date: new Date().toISOString() });
                    }
                    try { await storage.saveData(state.appData); showToast('Compra VT salva.', 'bg-green-600'); } catch(e) { console.error('saveVTUsageEdit save', e); showToast('Falha ao salvar compra VT.', 'bg-red-600'); }
                    closeVTUsageModal();
                    render();
                } catch(e) { console.error('saveVTUsageEdit', e); }
            }

        // Export public API
        return {
            init,
            // VR helpers
            openVRUsageEdit,
            closeVRUsageModal,
            saveVRUsageEdit,
            saveVRLedgerEntry,
            closeVRModal,
            // VT helpers
            openVTUsageEdit,
            closeVTUsageModal,
            saveVTUsageEdit,
            saveVTLedgerEntry,
            closeVTModal,
            openVTEdit
        };
    })(); // Close App IIFE and assign to App

    // Inicializa a aplicação quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
        if (App && typeof App.init === 'function') {
            App.init();
            // Attach VR modal buttons after init so elements are available
            try {
                const vrSaveBtn = document.getElementById('vr-entry-save'); if (vrSaveBtn) vrSaveBtn.addEventListener('click', (e) => { e.preventDefault(); App.saveVRLedgerEntry(); });
                const vrCancel = document.getElementById('vr-entry-cancel'); if (vrCancel) vrCancel.addEventListener('click', (e) => { e.preventDefault(); document.getElementById('vr-entry-id').value = ''; document.getElementById('vr-entry-desc').value = ''; document.getElementById('vr-entry-amount').value = ''; });
                const vrClose = document.getElementById('close-vr-modal'); if (vrClose) vrClose.addEventListener('click', () => App.closeVRModal());
                const vruSave = document.getElementById('vr-usage-save'); if (vruSave) vruSave.addEventListener('click', (e) => { e.preventDefault(); App.saveVRUsageEdit(e); });
                const vruCancel = document.getElementById('vr-usage-cancel'); if (vruCancel) vruCancel.addEventListener('click', (e) => { e.preventDefault(); App.closeVRUsageModal(); });
                const vruClose = document.getElementById('vr-usage-close'); if (vruClose) vruClose.addEventListener('click', () => App.closeVRUsageModal());
                // Ensure form submission (Enter key) does not trigger a full page submit
                const vruForm = document.getElementById('vr-usage-form'); if (vruForm) vruForm.addEventListener('submit', (e) => { e.preventDefault(); App.saveVRUsageEdit(e); });
                // Also protect VR ledger form (vr-entry-form) from default submit behavior
                const vrEntryForm = document.getElementById('vr-entry-form'); if (vrEntryForm) vrEntryForm.addEventListener('submit', (e) => { e.preventDefault(); App.saveVRLedgerEntry(); });
                // VT modal bindings
                const vtSaveBtn = document.getElementById('vt-entry-save'); if (vtSaveBtn) vtSaveBtn.addEventListener('click', (e) => { e.preventDefault(); App.saveVTLedgerEntry(); });
                const vtCancel = document.getElementById('vt-entry-cancel'); if (vtCancel) vtCancel.addEventListener('click', (e) => { e.preventDefault(); document.getElementById('vt-entry-id').value = ''; document.getElementById('vt-entry-desc').value = ''; document.getElementById('vt-entry-amount').value = ''; });
                const vtClose = document.getElementById('close-vt-modal'); if (vtClose) vtClose.addEventListener('click', () => App.closeVTModal());
                const vtuSave = document.getElementById('vt-usage-save'); if (vtuSave) vtuSave.addEventListener('click', (e) => { e.preventDefault(); App.saveVTUsageEdit(e); });
                const vtuCancel = document.getElementById('vt-usage-cancel'); if (vtuCancel) vtuCancel.addEventListener('click', (e) => { e.preventDefault(); App.closeVTUsageModal(); });
                const vtuClose = document.getElementById('vt-usage-close'); if (vtuClose) vtuClose.addEventListener('click', () => App.closeVTUsageModal());
                const vtuForm = document.getElementById('vt-usage-form'); if (vtuForm) vtuForm.addEventListener('submit', (e) => { e.preventDefault(); App.saveVTUsageEdit(e); });
                const vtEntryForm = document.getElementById('vt-entry-form'); if (vtEntryForm) vtEntryForm.addEventListener('submit', (e) => { e.preventDefault(); App.saveVTLedgerEntry(); });
                // ...salary modal wiring moved to bindEvents to ensure helper is in scope
                // Mobile FAB: delegate to existing add-transaction button to preserve behavior
                try {
                    const mobileFab = document.getElementById('mobile-add-transaction-fab');
                    const desktopAddBtn = document.getElementById('add-transaction-btn');
                    if (mobileFab && desktopAddBtn) {
                        mobileFab.addEventListener('click', (e) => {
                            // If on mobile, simulate click on the main add button which opens the modal
                            if (window.innerWidth <= 639) {
                                try { desktopAddBtn.click(); } catch (err) { openModal('expenses'); }
                            } else {
                                // hide mobile FAB on desktop
                                mobileFab.style.display = 'none';
                            }
                        });
                    }
                } catch(e) { console.error('attach mobile FAB', e); }
            } catch(e) { console.error('attach vr modal buttons', e); }
        }
    });
    </script>
    <!-- Toasts -->
    <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded shadow-lg hidden" style="z-index: 2147483647 !important;" role="status" aria-live="polite"></div>
    <!-- Confirm Modal (generic) -->
    <dialog id="confirm-dialog" class="p-4 rounded-2xl shadow-2xl card w-full max-w-md">
        <div class="mb-3">
            <h3 id="confirm-dialog-title" class="text-lg font-semibold">Confirmar</h3>
        </div>
        <div id="confirm-dialog-body" class="text-sm text-gray-700 mb-4">Tem certeza?</div>
        <div class="flex justify-end gap-2">
            <button id="confirm-dialog-cancel" class="px-3 py-1 rounded bg-gray-100">Cancelar</button>
            <button id="confirm-dialog-ok" class="px-3 py-1 rounded bg-red-600 text-white">Excluir</button>
        </div>
    </dialog>
    <!-- Legacy inline tp-modal removed to avoid duplicate IDs and conflicts with the new travel-planner modal above. -->
    <script>
    (function(){
        // Wire confirm dialog buttons if present
        function initConfirmDialog() {
            try {
                const dlg = document.getElementById('confirm-dialog');
                const ok = document.getElementById('confirm-dialog-ok');
                const cancel = document.getElementById('confirm-dialog-cancel');
                if (!dlg || !ok || !cancel) return;
                ok.addEventListener('click', function(){ try { dlg.returnValue = 'ok'; dlg.close('ok'); } catch(e){} });
                cancel.addEventListener('click', function(){ try { dlg.returnValue = 'cancel'; dlg.close('cancel'); } catch(e){} });
            } catch(e) { console.error('initConfirmDialog', e); }
        }
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initConfirmDialog); else initConfirmDialog();

        window.showConfirm = function(message, title) {
            return new Promise(function(resolve){
                try {
                    const dlg = document.getElementById('confirm-dialog');
                    if (!dlg) { resolve(window.confirm(message)); return; }
                    const body = document.getElementById('confirm-dialog-body');
                    const titleEl = document.getElementById('confirm-dialog-title');
                    body.textContent = message || 'Tem certeza?';
                    if (title && titleEl) titleEl.textContent = title;
                    dlg.showModal();
                    function onClose() {
                        try { resolve(dlg.returnValue === 'ok'); } catch(e) { resolve(false); }
                        dlg.removeEventListener('close', onClose);
                    }
                    dlg.addEventListener('close', onClose);
                } catch(e) { console.error('showConfirm', e); resolve(false); }
            });
        };

        // audit log feature removed
    })();
    </script>
    <!-- Mobile Bottom Navigation -->
    <nav id="mobile-bottom-nav" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-white rounded-full shadow-lg px-3 py-2 z-50 gap-3 hidden">
        <button data-view="dashboard" class="mobile-nav-btn p-2 rounded-full" title="Visão Geral"><span class="material-symbols-outlined">dashboard</span></button>
        <button data-view="credit-cards" class="mobile-nav-btn p-2 rounded-full" title="Faturas"><span class="material-symbols-outlined">credit_card</span></button>
    <button data-view="investments" class="mobile-nav-btn p-2 rounded-full" title="Investimentos"><span class="material-symbols-outlined">trending_up</span></button>
    <button data-view="travel-planner" class="mobile-nav-btn p-2 rounded-full" title="Planejadora"><span class="material-symbols-outlined">flight</span></button>
    </nav>
    <!-- Mobile Action Sheet (hidden until FAB tapped) -->
    <div id="mobile-action-sheet" class="hidden fixed inset-x-0 bottom-0 z-60 flex items-end justify-center">
        <div id="mas-backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,0.4);" aria-hidden="true"></div>
        <div id="mas-sheet" role="dialog" aria-modal="true" class="w-full max-w-2xl bg-white rounded-t-xl shadow-2xl p-4" style="transform:translateY(100%);transition:transform .32s cubic-bezier(.2,.9,.3,1);">
            <div class="sheet-handle" style="width:56px;height:6px;background:#e5e7eb;border-radius:999px;margin:6px auto 10px;"></div>
            <div class="grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
                <button id="mas-new-transaction" class="mobile-sheet-btn" style="padding:14px;border-radius:12px;background:linear-gradient(180deg,#06b6d4,#0369a1);color:#fff;font-weight:600;">Nova transação</button>
                <button id="mas-new-income" class="mobile-sheet-btn" style="padding:14px;border-radius:12px;background:linear-gradient(180deg,#10b981,#059669);color:#fff;font-weight:600;">Nova receita</button>
                <button id="mas-new-expense" class="mobile-sheet-btn" style="padding:14px;border-radius:12px;background:linear-gradient(180deg,#f97316,#dc2626);color:#fff;font-weight:600;">Nova despesa</button>
                <button id="mas-import" class="mobile-sheet-btn" style="padding:14px;border-radius:12px;background:#f3f4f6;color:#111;font-weight:600;">Importar planilha</button>
            </div>
            <div style="margin-top:12px;text-align:center;"><button id="mas-cancel" style="padding:10px 14px;border-radius:10px;background:#fff;border:1px solid #e5e7eb;">Fechar</button></div>
        </div>
    </div>
    <!-- Mobile Floating Add Transaction Button -->
    <button id="mobile-add-transaction-fab" aria-label="Adicionar transação" title="Nova transação">+
    </button>

    <!-- Mobile-only enhancements: CSS + JS (do not change desktop) -->
    <style id="mobile-enhancements">
    /* Scope to small screens only so desktop is unchanged */
    @media (max-width: 768px) {
        /* Gentle global typography scaling and spacing for mobile */
        html, body { font-size: 16px !important; -webkit-font-smoothing:antialiased; }
        body { padding-bottom: 6.5rem !important; /* avoid bottom nav overlap */ }

        /* Make main layout use full viewport width with comfortable horizontal padding */
        /* Target common wrapper/container names; these selectors are safe because they're scoped to mobile only */
        .container, .app-container, .main, .content, .page, .panel, .wrap, #app {
            width: calc(100vw - 1.5rem) !important;
            max-width: calc(100vw - 1.5rem) !important;
            margin-left: auto !important;
            margin-right: auto !important;
            padding-left: 0.75rem !important;
            padding-right: 0.75rem !important;
        }

        /* Make bottom nav more prominent and finger-friendly */
        #mobile-bottom-nav {
            display: flex !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            bottom: 0.8rem !important;
            padding: 0.45rem 0.75rem !important;
            gap: 8px !important;
            border-radius: 9999px !important;
            box-shadow: 0 10px 30px rgba(2,6,23,0.12) !important;
            z-index: 140000 !important;
        }
        #mobile-bottom-nav .mobile-nav-btn { width:48px; height:48px; display:inline-flex; align-items:center; justify-content:center; }

        /* Floating action button: larger, high-contrast, positioned above bottom-nav with smooth shadow */
        #mobile-add-transaction-fab {
            display: inline-flex !important;
            position: fixed !important;
            right: 1rem !important;
            bottom: 5.8rem !important; /* above bottom nav */
            width: 64px !important;
            height: 64px !important;
            border-radius: 9999px !important;
            background: linear-gradient(180deg,#06b6d4,#0369a1) !important;
            color: #fff !important;
            font-size: 34px !important;
            align-items: center !important;
            justify-content: center !important;
            box-shadow: 0 14px 34px rgba(3,105,161,0.18) !important;
            z-index: 150000 !important;
            border: none !important;
            -webkit-tap-highlight-color: transparent;
            transition: transform .14s ease, box-shadow .14s ease;
        }
        #mobile-add-transaction-fab:active { transform: scale(.96); box-shadow: 0 8px 18px rgba(3,105,161,0.12) !important; }

        /* Mobile action sheet styles */
        #mobile-action-sheet { display: none; }
        #mobile-action-sheet.show { display: flex; }
        #mas-sheet.open { transform: translateY(0%); }

        /* Make modal dialogs full-screen and easier to scroll on mobile */
        dialog[open] {
            width: 100vw !important;
            height: 100vh !important;
            left: 0 !important;
            right: 0 !important;
            top: 0 !important;
            bottom: 0 !important;
            margin: 0 !important;
            border-radius: 12px !important;
            padding: 0.75rem !important;
            overflow: auto !important;
            -webkit-overflow-scrolling: touch !important;
            display: flex !important; flex-direction: column !important;
        }
        dialog::backdrop { background: rgba(0,0,0,0.6) !important; }
        dialog .modal-body, dialog .dialog-body, dialog .content { width: calc(100vw - 2rem) !important; margin: 0 auto !important; }

    /* Keep cards and panels full-bleed where intended, but keep tables as normal rows to avoid horizontal scroll on mobile */
    .dashboard-card, .fatura-card, .transaction-card, .card, .panel { width: calc(100vw - 1.5rem) !important; max-width: calc(100vw - 1.5rem) !important; margin: 0.6rem auto !important; border-radius: 12px !important; box-shadow: 0 10px 30px rgba(2,6,23,0.06) !important; padding: 12px !important; background: linear-gradient(180deg,#ffffff,#fbfbff); }

    /* Tables: keep natural table layout (rows stacked vertically). Use subtle dividers between rows for mobile readability. */
    .responsive-table, .responsive-table table { width: 100% !important; max-width: 100% !important; }
    /* Prevent fixed col widths from forcing horizontal scroll on mobile */
    .responsive-table colgroup col { width: auto !important; }
    .responsive-table tr { display: table-row !important; margin: 0 !important; border-radius: 0 !important; background: transparent !important; box-shadow: none !important; padding: 0 !important; }
    .responsive-table td { display: table-cell !important; vertical-align: middle !important; padding: 10px 8px !important; border: none !important; border-bottom: 1px solid rgba(0,0,0,0.06) !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .responsive-table td .material-symbols-outlined { margin-right: 8px !important; }

        /* Forms and inputs take full width like the transaction modal */
        form, .form-row, .field, .form-group { width: calc(100vw - 2rem) !important; max-width: calc(100vw - 2rem) !important; margin: 0.4rem auto !important; }
        input, select, textarea, .select-wrapper, .icon-select-button { display: block !important; width: 100% !important; box-sizing: border-box !important; font-size: 16px !important; padding: 12px !important; border-radius: 10px !important; }
        label { display:block; margin-bottom:6px; color:#374151; font-weight:600; }
        .field small, .hint { display:block; color:#6b7280; margin-top:6px; }

        /* Buttons full width in dialogs and action groups */
        .modal-actions, .dialog-actions, .action-row { display:flex; flex-direction:column; gap:10px; }
        .modal-actions button, .dialog-actions button, .modal-action-btn { width:100% !important; }

        /* Dashboard compactness and legibility */
        .dashboard-grid { grid-template-columns: 1fr !important; gap: 10px !important; }

        /* Compact, tappable action buttons and inputs */
        .actions-cell button { min-width: 48px !important; height:48px !important; }
        input, select, textarea { font-size: 16px !important; padding: 12px !important; }

        /* Improve focus outlines for keyboard and accessibility on mobile */
        :focus { outline: 3px solid rgba(6, 182, 212, 0.18); outline-offset: 3px; }
    }
    </style>

    <script>
    (function(){
        // Mobile runtime enhancements (no changes for desktop)
        function isMobile() { return window.innerWidth <= 768 || /iPhone|Android/.test(navigator.userAgent || ''); }

        document.addEventListener('DOMContentLoaded', function(){
            try {
                // Show mobile bottom nav when appropriate
                const mobileNav = document.getElementById('mobile-bottom-nav');
                if (mobileNav && isMobile()) mobileNav.classList.remove('hidden');

                // Action sheet elements
                const actionSheet = document.getElementById('mobile-action-sheet');
                const masSheet = document.getElementById('mas-sheet');
                const masBackdrop = document.getElementById('mas-backdrop');
                const masCancel = document.getElementById('mas-cancel');
                const masNewTransaction = document.getElementById('mas-new-transaction');
                const masNewIncome = document.getElementById('mas-new-income');
                const masNewExpense = document.getElementById('mas-new-expense');
                const masImport = document.getElementById('mas-import');

                function openActionSheet(){
                    if (!actionSheet || !masSheet) return;
                    actionSheet.classList.add('show');
                    // open with slight delay so transition works
                    requestAnimationFrame(()=> masSheet.classList.add('open'));
                    // prevent background scroll
                    document.documentElement.style.overflow = 'hidden';
                }
                function closeActionSheet(){
                    if (!actionSheet || !masSheet) return;
                    masSheet.classList.remove('open');
                    setTimeout(()=>{ actionSheet.classList.remove('show'); document.documentElement.style.overflow = ''; }, 280);
                }

                // Ensure mobile FAB is visible on small screens and focusable; override to open action sheet
                const fab = document.getElementById('mobile-add-transaction-fab');
                const addBtn = document.getElementById('add-transaction-btn');
                if (fab && isMobile()) {
                    fab.style.display = 'inline-flex';
                    fab.setAttribute('role','button');
                    fab.setAttribute('aria-pressed','false');
                    fab.addEventListener('click', function(e){ e.preventDefault(); try { openActionSheet(); } catch(err) { try { if (addBtn) addBtn.click(); else openModal && openModal('expenses'); } catch(e){} } });
                }

                // Wire sheet buttons to existing handlers where possible
                if (masCancel) masCancel.addEventListener('click', closeActionSheet);
                if (masBackdrop) masBackdrop.addEventListener('click', closeActionSheet);
                if (masNewTransaction) masNewTransaction.addEventListener('click', function(){ closeActionSheet(); setTimeout(()=>{ try { if (addBtn) addBtn.click(); else openModal && openModal('expenses'); } catch(e){} }, 260); });
                if (masNewIncome) masNewIncome.addEventListener('click', function(){ closeActionSheet(); setTimeout(()=>{ try { const inc = document.getElementById('add-income-btn'); if (inc) inc.click(); else openModal && openModal('incomes'); } catch(e){} }, 260); });
                if (masNewExpense) masNewExpense.addEventListener('click', function(){ closeActionSheet(); setTimeout(()=>{ try { const exp = document.getElementById('add-expense-btn'); if (exp) exp.click(); else openModal && openModal('expenses'); } catch(e){} }, 260); });
                if (masImport) masImport.addEventListener('click', function(){ closeActionSheet(); setTimeout(()=>{ try { const imp = document.getElementById('open-import-modal-btn'); if (imp) imp.click(); else { const el = document.getElementById('import-spreadsheet-modal'); if (el && typeof el.showModal === 'function') el.showModal(); } } catch(e){} }, 260); });

                // Make bottom nav buttons navigate views (reuse existing changeView bindings)
                try {
                    const nav = document.getElementById('mobile-bottom-nav');
                    if (nav) {
                        nav.querySelectorAll('.mobile-nav-btn').forEach(b => b.addEventListener('click', function(){ const v = this.dataset.view; try { changeView(v); } catch(e){ const ev = new Event('click'); const el = document.querySelector(`.tab-button[data-view="${v}"]`); if (el) el.dispatchEvent(ev); } }));
                    }
                } catch(e){}

                // Swipe to change month (touch gestures) - DESABILITADO conforme solicitação do usuário
                // O usuário não quer que ao arrastar o site para direita e esquerda mude o calendário
                /* (function(){
                    let startX = 0, startY = 0, startTime = 0;
                    const threshold = 60; // px to consider swipe
                    const restraint = 80; // max vertical movement
                    const allowedTime = 500; // ms
                    document.addEventListener('touchstart', function(e){
                        const t = e.changedTouches[0]; startX = t.pageX; startY = t.pageY; startTime = new Date().getTime();
                    }, { passive: true });
                    document.addEventListener('touchend', function(e){
                        try {
                            const t = e.changedTouches[0]; const distX = t.pageX - startX; const distY = t.pageY - startY; const elapsed = new Date().getTime() - startTime;
                            if (elapsed <= allowedTime && Math.abs(distX) >= threshold && Math.abs(distY) <= restraint) {
                                // left swipe = next month, right swipe = prev month
                                if (distX < 0) { const next = document.getElementById('next-month-btn'); if (next) next.click(); }
                                else { const prev = document.getElementById('prev-month-btn'); if (prev) prev.click(); }
                            }
                        } catch(e) {}
                    }, { passive: true });
                })(); */

                // Improve modal backdrop tap-to-close responsiveness on mobile (single tap closes)
                try {
                    document.querySelectorAll('dialog').forEach(d => {
                        d.addEventListener('click', function(e){ if (e.target === d && isMobile()) { try { d.close(); } catch(_) { d.removeAttribute('open'); } } });
                    });
                } catch(e) {}

                // Prevent accidental focus loss when keyboard opens on iOS by ensuring inputs are scrolled into view
                try {
                    document.body.addEventListener('focusin', function(e){ if (!isMobile()) return; try { setTimeout(()=>{ e.target.scrollIntoView({ block: 'center', behavior: 'smooth' }); }, 240); } catch(_){} });
                } catch(e) {}

                // Reduce motion for mobile to keep interactions snappy
                try { if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) document.documentElement.classList.add('reduced-motion'); } catch(e) {}

                // Swipe/ARIA-init removed: transactions use inline action buttons now
            } catch(e) { console.error('mobile-enhancements init', e); }
        });
    })();
    </script>
    <!-- Swipe-to-reveal behavior removed: rows are standard table rows with inline action buttons -->
    <!-- Travel Planner Modal + logic -->
    <dialog id="travel-planner-modal" class="p-4 rounded-2xl shadow-2xl card w-full max-w-7xl" aria-modal="true" role="dialog" style="max-height: 95vh; overflow-y: auto;">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold flex items-center gap-3"><span class="material-symbols-outlined">flight</span> Planejadora de Viagens</h3>
            <div>
                <button id="tp-close" class="px-2 py-1 rounded bg-gray-100">Fechar</button>
            </div>
        </div>
        <input type="hidden" id="tp-id" />
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-1 space-y-3">
                <div class="p-3 rounded bg-white border">
                    <label class="text-xs text-gray-500">Destino</label>
                    <div class="relative">
                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">place</span>
                        <input id="tp-modal-destination" class="w-full border-2 rounded-lg px-3 py-2 mt-1 pl-10" placeholder="Destino — Ex: Gramado, RS" />
                    </div>
                    <label class="text-xs text-gray-500 mt-2">Data alvo</label>
                    <div class="relative">
                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">event</span>
                        <input id="tp-modal-date" type="date" class="w-full border-2 rounded-lg px-3 py-2 mt-1 pl-10" />
                    </div>
                    <label class="text-xs text-gray-500 mt-2">Orçamento total estimado (R$)</label>
                    <div class="relative">
                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">attach_money</span>
                        <input id="tp-modal-estimated" class="w-full border-2 rounded-lg px-3 py-2 mt-1 pl-10" placeholder="R$ 0,00" />
                    </div>
                    <label class="text-xs text-gray-500 mt-2">Já poupado (R$)</label>
                    <div class="relative">
                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">savings</span>
                        <input id="tp-modal-saved" class="w-full border-2 rounded-lg px-3 py-2 mt-1 pl-10" placeholder="R$ 0,00" />
                    </div>
                    <div class="flex gap-2 mt-3">
                        <button id="tp-modal-save" class="modal-action-btn save-type-incomes btn-primary px-3 py-2 rounded inline-flex items-center gap-2"><span class="material-symbols-outlined">save</span> Salvar Plano</button>
                        <button id="tp-modal-new" class="px-3 py-1 rounded bg-gray-100">Novo</button>
                    </div>
                </div>
                <div class="p-3 rounded bg-white border">
                    <h4 class="text-sm font-semibold">Resumo do Plano</h4>
                    <div class="mt-2 text-sm text-gray-600">Destino: <span id="tp-summary-destination">—</span></div>
                    <div class="text-sm text-gray-600">Data: <span id="tp-summary-date">—</span></div>
                    <div class="text-sm text-gray-600">Total transportes: <span id="tp-summary-transports">0</span></div>
                    <div class="text-sm text-gray-600 mt-2">Custo estimado: <strong id="tp-summary-cost">R$ 0,00</strong></div>
                </div>
            </div>
            <div class="lg:col-span-2">
                <!-- Sistema de Abas para Planejador -->
                <div class="travel-planner-tabs-container">
                    <div class="travel-planner-tabs">
                        <button class="travel-tab active" data-tab="transportes">
                            <span class="material-symbols-outlined">directions_car</span>
                            <span>Transportes</span>
                        </button>
                        <button class="travel-tab" data-tab="hospedagem">
                            <span class="material-symbols-outlined">hotel</span>
                            <span>Hospedagem</span>
                        </button>
                        <button class="travel-tab" data-tab="passeios">
                            <span class="material-symbols-outlined">tour</span>
                            <span>Atividades</span>
                        </button>
                        <button class="travel-tab" data-tab="roteiro">
                            <span class="material-symbols-outlined">event_note</span>
                            <span>Roteiro</span>
                        </button>
                        <button class="travel-tab" data-tab="checklist">
                            <span class="material-symbols-outlined">checklist</span>
                            <span>Checklist</span>
                        </button>
                    </div>
                </div>

                <!-- Aba de Transportes -->
                <div class="travel-tab-content active" id="tab-transportes">
                <div class="p-3 rounded bg-white border mb-3">
                    <div class="flex items-center justify-between">
                        <h4 class="text-sm font-semibold">Transportes</h4>
                        <button id="tp-transport-new" class="px-2 py-1 rounded bg-indigo-600 text-white inline-flex items-center gap-2"><span class="material-symbols-outlined">directions_car</span>Novo Transporte</button>
                    </div>
                    <div id="tp-transport-form" class="mt-3 hidden p-3 border rounded bg-gray-50">
                        <input type="hidden" id="tp-transport-id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs text-gray-500">Tipo</label>
                                <div class="relative select-with-icon">
                                    <span class="material-symbols-outlined select-icon text-gray-400">directions_car</span>
                                    <select id="tp-transport-type" class="w-full border-2 rounded-lg px-3 py-2 mt-1 pl-10">
                                        <option value="carro" data-icon="directions_car" selected>Carro/Moto</option>
                                        <option value="voo" data-icon="flight">Voos</option>
                                        <option value="aluguel" data-icon="car_rental">Aluguel de Carro</option>
                                        <option value="uber" data-icon="local_taxi">Uber/Taxi</option>
                                        <option value="publico" data-icon="directions_bus">Transportes Públicos</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Descrição</label>
                                <input id="tp-transport-desc" class="w-full border rounded p-2 mt-1" placeholder="Ex: Aluguel de carro 3 dias" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Distância (km)</label>
                                <input id="tp-transport-distance" class="w-full border rounded p-2 mt-1" placeholder="km total" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Tempo médio de viagem (horas)</label>
                                <input id="tp-transport-duration" type="number" step="0.5" class="w-full border rounded p-2 mt-1" placeholder="Ex: 10.5" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Consumo (km/L) — eficiência</label>
                                <input id="tp-transport-efficiency" class="w-full border rounded p-2 mt-1" placeholder="Ex: 12,5" />
                                <p id="tp-transport-efficiency-error" class="text-xs text-red-600 hidden"></p>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Preço combustível (R$/L)</label>
                                <input id="tp-transport-fuelprice" class="w-full border rounded p-2 mt-1" placeholder="Ex: 5,49" />
                                <p id="tp-transport-fuelprice-error" class="text-xs text-red-600 hidden"></p>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Pedágios / Taxas (R$)</label>
                                <input id="tp-transport-tolls" class="w-full border rounded p-2 mt-1" placeholder="R$ 0,00" />
                                <p id="tp-transport-tolls-error" class="text-xs text-red-600 hidden"></p>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Aluguel / Locação (R$)</label>
                                <input id="tp-transport-rental" class="w-full border rounded p-2 mt-1" placeholder="R$ 0,00" />
                                <p id="tp-transport-rental-error" class="text-xs text-red-600 hidden"></p>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 flex items-center gap-2">
                                    Link para aluguel
                                    <a href="https://www.localiza.com/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 text-green-600 hover:text-green-700 transition-colors" title="Ir para Localiza">
                                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
                                        </svg>
                                        Localiza
                                    </a>
                                </label>
                                <input id="tp-transport-link" class="w-full border rounded p-2 mt-1" placeholder="https://..." />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Manutenção / Seguro (R$)</label>
                                <input id="tp-transport-maint" class="w-full border rounded p-2 mt-1" placeholder="R$ 0,00" />
                                <p id="tp-transport-maint-error" class="text-xs text-red-600 hidden"></p>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Atividades (R$)</label>
                                <input id="tp-transport-transfers" class="w-full border rounded p-2 mt-1" placeholder="R$ 0,00" />
                                <p id="tp-transport-transfers-error" class="text-xs text-red-600 hidden"></p>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="inline-flex items-center gap-2 mt-2">
                                    <input type="checkbox" id="tp-transport-paid" />
                                    <span class="text-sm text-gray-600">Pago</span>
                                </label>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mt-3">
                            <button id="tp-transport-save" class="px-3 py-1 rounded bg-green-600 text-white">Salvar Transporte</button>
                            <button id="tp-transport-cancel" class="px-3 py-1 rounded bg-gray-100">Cancelar</button>
                        </div>
                        <div id="tp-transport-calculations" class="mt-3 text-sm text-gray-700"></div>
                    </div>

                    <div id="tp-transport-list" class="mt-4 space-y-2"></div>
                </div>
                </div>
                <!-- FIM Aba de Transportes -->

                <!-- Aba de Hospedagem -->
                <div class="travel-tab-content" id="tab-hospedagem">
                <div class="p-3 rounded bg-white border mb-3">
                    <div class="flex items-center justify-between">
                        <h4 class="text-sm font-semibold">Hospedagem</h4>
                        <button id="tp-accommodation-new" class="px-2 py-1 rounded bg-pink-600 text-white inline-flex items-center gap-2"><span class="material-symbols-outlined">hotel</span>Nova Hospedagem</button>
                    </div>
                    <div id="tp-accommodation-form" class="mt-3 hidden p-3 border rounded bg-gray-50">
                        <input type="hidden" id="tp-accommodation-id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs text-gray-500">Nome do Estabelecimento</label>
                                <input id="tp-accommodation-name" class="w-full border rounded p-2 mt-1" placeholder="Ex: Hotel Vista Mar" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Tipo</label>
                                <select id="tp-accommodation-type" class="w-full border rounded p-2 mt-1">
                                    <option value="hotel">Hotel/Hostel</option>
                                    <option value="airbnb">Airbnb</option>
                                    <option value="reserva">Reserva</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-xs text-gray-500">Endereço / Localização</label>
                                <input id="tp-accommodation-address" class="w-full border rounded p-2 mt-1" placeholder="Ex: Av. Beira Mar, 123" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Check-in</label>
                                <input type="date" id="tp-accommodation-checkin" class="w-full border rounded p-2 mt-1" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Hora Check-in</label>
                                <input type="time" id="tp-accommodation-checkin-time" class="w-full border rounded p-2 mt-1" placeholder="14:00" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Check-out</label>
                                <input type="date" id="tp-accommodation-checkout" class="w-full border rounded p-2 mt-1" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Hora Check-out</label>
                                <input type="time" id="tp-accommodation-checkout-time" class="w-full border rounded p-2 mt-1" placeholder="12:00" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Número de Diárias</label>
                                <input type="number" id="tp-accommodation-nights" class="w-full border rounded p-2 mt-1" placeholder="Ex: 5" min="1" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Preço por Diária (R$)</label>
                                <input id="tp-accommodation-price" class="w-full border rounded p-2 mt-1" placeholder="R$ 0,00" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 flex items-center gap-2">
                                    Link da Propriedade
                                    <a href="https://www.airbnb.com.br/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 text-pink-600 hover:text-pink-700 transition-colors" title="Ir para Airbnb">
                                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 1.95c-5.52 0-10 4.48-10 10s4.48 10 10 10 10-4.48 10-10-4.48-10-10-10zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
                                        </svg>
                                        Airbnb
                                    </a>
                                </label>
                                <input id="tp-accommodation-link" class="w-full border rounded p-2 mt-1" placeholder="https://..." />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Total da Hospedagem (R$)</label>
                                <input id="tp-accommodation-total" class="w-full border rounded p-2 mt-1 bg-gray-100" placeholder="R$ 0,00" readonly />
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="inline-flex items-center gap-2 mt-2">
                                    <input type="checkbox" id="tp-accommodation-paid" />
                                    <span class="text-sm text-gray-600">Pago</span>
                                </label>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mt-3">
                            <button id="tp-accommodation-save" class="px-3 py-1 rounded bg-green-600 text-white">Salvar Hospedagem</button>
                            <button id="tp-accommodation-cancel" class="px-3 py-1 rounded bg-gray-100">Cancelar</button>
                        </div>
                        <div id="tp-accommodation-calculations" class="mt-3 text-sm text-gray-700"></div>
                    </div>
                    <div id="tp-accommodation-list" class="mt-4 space-y-2"></div>
                </div>
                </div>
                <!-- FIM Aba de Hospedagem -->

                <!-- Aba de Atividades -->
                <div class="travel-tab-content" id="tab-passeios">
                <div class="p-3 rounded bg-white border mb-3">
                    <div class="flex items-center justify-between">
                        <h4 class="text-sm font-semibold">Atividades e Eventos</h4>
                        <button id="tp-activity-new" class="px-2 py-1 rounded bg-teal-600 text-white inline-flex items-center gap-2"><span class="material-symbols-outlined">tour</span>Nova Atividade</button>
                    </div>
                    <div id="tp-activity-form" class="mt-3 hidden p-3 border rounded bg-gray-50">
                        <input type="hidden" id="tp-activity-id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs text-gray-500">Nome da Atividade</label>
                                <input id="tp-activity-name" class="w-full border rounded p-2 mt-1" placeholder="Ex: City Tour, Show, Ingresso" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Tipo</label>
                                <div class="relative select-with-icon">
                                    <span class="material-symbols-outlined select-icon text-gray-400">tour</span>
                                    <select id="tp-activity-type" class="w-full border-2 rounded-lg px-3 py-2 mt-1 pl-10">
                                        <option value="passeio" data-icon="tour" selected>Passeio</option>
                                        <option value="ingresso" data-icon="confirmation_number">Ingresso (Museu, Atração)</option>
                                        <option value="evento" data-icon="event">Evento/Show</option>
                                        <option value="compras" data-icon="shopping_bag">Compras</option>
                                        <option value="restaurante" data-icon="restaurant">Restaurante</option>
                                        <option value="experiencia" data-icon="stars">Experiência</option>
                                        <option value="esporte" data-icon="sports_soccer">Atividade Esportiva</option>
                                        <option value="cultura" data-icon="museum">Atividade Cultural</option>
                                        <option value="tour" data-icon="map">Tour</option>
                                        <option value="outro" data-icon="local_activity">Outro</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Data</label>
                                <input type="date" id="tp-activity-date" class="w-full border rounded p-2 mt-1" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Horário</label>
                                <input type="time" id="tp-activity-time" class="w-full border rounded p-2 mt-1" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Duração (horas)</label>
                                <input type="number" id="tp-activity-duration" class="w-full border rounded p-2 mt-1" placeholder="Ex: 3" step="0.5" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Preço Total (R$)</label>
                                <input id="tp-activity-price" class="w-full border rounded p-2 mt-1" placeholder="R$ 0,00" />
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-xs text-gray-500">Observações</label>
                                <textarea id="tp-activity-notes" class="w-full border rounded p-2 mt-1" rows="2" placeholder="Notas adicionais..."></textarea>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="inline-flex items-center gap-2 mt-2">
                                    <input type="checkbox" id="tp-activity-paid" />
                                    <span class="text-sm text-gray-600">Pago</span>
                                </label>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mt-3">
                            <button id="tp-activity-save" class="px-3 py-1 rounded bg-green-600 text-white">Salvar Atividade</button>
                            <button id="tp-activity-cancel" class="px-3 py-1 rounded bg-gray-100">Cancelar</button>
                        </div>
                    </div>
                    <div id="tp-activity-list" class="mt-4 space-y-2"></div>
                </div>
                </div>
                <!-- FIM Aba de Atividades -->

                <!-- Aba de Roteiro -->
                <div class="travel-tab-content" id="tab-roteiro">
                <div class="p-3 rounded bg-white border mb-3">
                    <div class="flex items-center justify-between">
                        <h4 class="text-sm font-semibold">Roteiro Dia a Dia</h4>
                        <button id="tp-itinerary-new" class="px-2 py-1 rounded bg-purple-600 text-white inline-flex items-center gap-2"><span class="material-symbols-outlined">event_note</span>Nova Atividade</button>
                    </div>
                    <div id="tp-itinerary-form" class="mt-3 hidden p-3 border rounded bg-gray-50">
                        <input type="hidden" id="tp-itinerary-id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs text-gray-500">Dia da Viagem</label>
                                <input type="number" id="tp-itinerary-day" class="w-full border rounded p-2 mt-1" placeholder="Ex: 1" min="1" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Data</label>
                                <input type="date" id="tp-itinerary-date" class="w-full border rounded p-2 mt-1" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Horário</label>
                                <input type="time" id="tp-itinerary-time" class="w-full border rounded p-2 mt-1" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Local / Ponto</label>
                                <input id="tp-itinerary-location" class="w-full border rounded p-2 mt-1" placeholder="Ex: Centro Histórico" />
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-xs text-gray-500">Atividade / Descrição</label>
                                <input id="tp-itinerary-activity" class="w-full border rounded p-2 mt-1" placeholder="Ex: Visita ao Museu" />
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-xs text-gray-500">Notas / Observações</label>
                                <textarea id="tp-itinerary-notes" class="w-full border rounded p-2 mt-1" rows="2" placeholder="Informações adicionais..."></textarea>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mt-3">
                            <button id="tp-itinerary-save" class="px-3 py-1 rounded bg-green-600 text-white">Salvar no Roteiro</button>
                            <button id="tp-itinerary-cancel" class="px-3 py-1 rounded bg-gray-100">Cancelar</button>
                        </div>
                    </div>
                    <div id="tp-itinerary-list" class="mt-4 space-y-2"></div>
                </div>
                </div>
                <!-- FIM Aba de Roteiro -->

                <!-- Aba de Checklist -->
                <div class="travel-tab-content" id="tab-checklist">
                <div class="p-3 rounded bg-white border mb-3">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-semibold">Checklist de Viagem</h4>
                        <div class="flex gap-2">
                            <button id="tp-checklist-groups" class="px-2 py-1 rounded bg-teal-600 text-white inline-flex items-center gap-2 text-sm" title="Gerenciar grupos salvos"><span class="material-symbols-outlined">folder_open</span>Grupos</button>
                            <button id="tp-checklist-suggestions" class="px-2 py-1 rounded bg-purple-600 text-white inline-flex items-center gap-2 text-sm"><span class="material-symbols-outlined">lightbulb</span>Sugestões</button>
                            <button id="tp-checklist-new" class="px-2 py-1 rounded bg-orange-600 text-white inline-flex items-center gap-2"><span class="material-symbols-outlined">checklist</span>Novo Item</button>
                        </div>
                    </div>
                    
                    <!-- Painel de Grupos Salvos -->
                    <div id="tp-checklist-groups-panel" class="hidden mb-3 p-4 border-2 border-teal-200 rounded-lg bg-teal-50 max-h-96 overflow-y-auto">
                        <div class="flex items-center justify-between mb-3 sticky top-0 bg-teal-50 pb-2 z-10">
                            <h5 class="font-bold text-teal-900 flex items-center gap-2">
                                <span class="material-symbols-outlined">folder_open</span>
                                Grupos Salvos de Checklist
                            </h5>
                            <button id="tp-close-groups" class="text-teal-600 hover:text-teal-800">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>
                        
                        <!-- Botão para salvar grupo atual -->
                        <div class="mb-3 p-3 bg-white rounded-lg border border-teal-300">
                            <button id="tp-save-current-group" class="w-full px-3 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined">save</span>
                                Salvar Checklist Atual como Grupo
                            </button>
                            <p class="text-xs text-gray-600 mt-2">Salve todos os itens atuais do checklist para reutilizar em outros planos de viagem</p>
                        </div>
                        
                        <!-- Lista de grupos salvos -->
                        <div id="tp-saved-groups-container">
                            <p class="text-sm text-gray-500 text-center py-4">Nenhum grupo salvo ainda</p>
                        </div>
                    </div>
                    
                    <!-- Painel de Sugestões (Catálogo Expandido com 250+ itens) -->
                    <div id="tp-checklist-suggestions-panel" class="hidden mb-3 p-4 border-2 border-purple-200 rounded-lg bg-purple-50 max-h-96 overflow-y-auto">
                        <div class="flex items-center justify-between mb-3 sticky top-0 bg-purple-50 pb-2 z-10">
                            <h5 class="font-bold text-purple-900 flex items-center gap-2">
                                <span class="material-symbols-outlined">auto_awesome</span>
                                Catálogo de Sugestões (250+ itens)
                            </h5>
                            <button id="tp-close-suggestions" class="text-purple-600 hover:text-purple-800">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>
                        <p class="text-xs text-purple-700 mb-3">Clique nos itens para adicionar rapidamente ao seu checklist com peso e quantidade pré-definidos:</p>
                        
                        <!-- Formulário para Adicionar Sugestão Personalizada -->
                        <div id="tp-custom-suggestion-form" class="hidden mb-3 p-3 border-2 border-yellow-400 rounded-lg bg-yellow-50">
                            <div class="flex items-center justify-between mb-2">
                                <h6 class="font-bold text-yellow-900 flex items-center gap-1 text-sm">
                                    <span class="material-symbols-outlined" style="font-size:16px">add_circle</span>
                                    Nova Sugestão Personalizada
                                </h6>
                                <button onclick="hideCustomSuggestionForm()" class="text-yellow-700 hover:text-yellow-900">
                                    <span class="material-symbols-outlined" style="font-size:18px">close</span>
                                </button>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="col-span-2">
                                    <label class="text-xs text-gray-700 font-semibold">Nome do Item*</label>
                                    <input type="text" id="tp-custom-suggestion-item" class="w-full border rounded p-2 mt-1 text-sm" placeholder="Ex: Repelente extra forte" />
                                </div>
                                <div>
                                    <label class="text-xs text-gray-700 font-semibold">Categoria</label>
                                    <select id="tp-custom-suggestion-category" class="w-full border rounded p-2 mt-1 text-sm">
                                        <option value="Documentos">Documentos</option>
                                        <option value="Roupas">Roupas</option>
                                        <option value="Higiene">Higiene</option>
                                        <option value="Eletrônicos">Eletrônicos</option>
                                        <option value="Medicamentos">Medicamentos</option>
                                        <option value="Acessórios">Acessórios</option>
                                        <option value="Diversos">Diversos</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-700 font-semibold">Quantidade</label>
                                    <input type="number" id="tp-custom-suggestion-quantity" class="w-full border rounded p-2 mt-1 text-sm" value="1" min="1" />
                                </div>
                                <div class="col-span-2">
                                    <label class="text-xs text-gray-700 font-semibold">Peso Estimado (kg)</label>
                                    <input type="number" id="tp-custom-suggestion-weight" class="w-full border rounded p-2 mt-1 text-sm" value="0.1" step="0.01" min="0" />
                                </div>
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button onclick="saveCustomSuggestion()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-semibold flex items-center gap-1">
                                    <span class="material-symbols-outlined" style="font-size:16px">save</span>
                                    Adicionar ao Catálogo
                                </button>
                                <button onclick="hideCustomSuggestionForm()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 text-sm">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Container dinâmico que será preenchido via JavaScript -->
                        <div id="tp-checklist-suggestions-container"></div>
                        
                        <div class="mt-3 p-2 bg-purple-100 rounded text-xs text-purple-800">
                            <strong>💡 Dica:</strong> Os itens adicionados via sugestões já vêm com categoria, quantidade e peso estimado pré-definidos. Você pode editá-los depois! <strong>Itens em amarelo</strong> são suas sugestões personalizadas. Use o botão <strong>"Nova Sugestão"</strong> em cada categoria para adicionar itens próprios ao catálogo!
                        </div>
                    </div>
                    
                    <!-- Modal para Salvar Grupo de Checklist -->
                    <div id="tp-save-group-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-teal-900 flex items-center gap-2">
                                    <span class="material-symbols-outlined">save</span>
                                    Salvar Grupo de Checklist
                                </h3>
                                <button onclick="closeSaveGroupModal()" class="text-gray-500 hover:text-gray-700">
                                    <span class="material-symbols-outlined">close</span>
                                </button>
                            </div>
                            
                            <div class="mb-4">
                                <label class="text-sm font-semibold text-gray-700 mb-2 block">Nome do Grupo*</label>
                                <input type="text" id="tp-group-name" class="w-full border rounded p-3 text-sm" placeholder="Ex: Viagem de Praia, Mochilão Europa, etc." />
                                <p class="text-xs text-gray-500 mt-1">Dê um nome descritivo para encontrar facilmente depois</p>
                            </div>
                            
                            <div class="mb-4">
                                <label class="text-sm font-semibold text-gray-700 mb-2 block">Descrição (opcional)</label>
                                <textarea id="tp-group-description" class="w-full border rounded p-3 text-sm" rows="2" placeholder="Adicione uma descrição ou notas sobre este grupo..."></textarea>
                            </div>
                            
                            <div class="bg-teal-50 border border-teal-200 rounded p-3 mb-4">
                                <p class="text-xs text-teal-800">
                                    <strong>📋 Será salvo:</strong> <span id="tp-group-items-count">0 itens</span> do checklist atual
                                </p>
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="confirmSaveGroup()" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 font-semibold flex items-center justify-center gap-2">
                                    <span class="material-symbols-outlined">save</span>
                                    Salvar Grupo
                                </button>
                                <button onclick="closeSaveGroupModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tp-checklist-form" class="mt-3 hidden p-3 border rounded bg-gray-50">
                        <input type="hidden" id="tp-checklist-id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs text-gray-500">Item</label>
                                <input id="tp-checklist-item" class="w-full border rounded p-2 mt-1" placeholder="Ex: Protetor solar" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Categoria</label>
                                <select id="tp-checklist-category" class="w-full border rounded p-2 mt-1">
                                    <option value="documentos">Documentos</option>
                                    <option value="roupas">Roupas</option>
                                    <option value="higiene">Higiene Pessoal</option>
                                    <option value="eletronicos">Eletrônicos</option>
                                    <option value="medicamentos">Medicamentos</option>
                                    <option value="acessorios">Acessórios</option>
                                    <option value="outros">Outros</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Quantidade</label>
                                <input type="number" id="tp-checklist-quantity" class="w-full border rounded p-2 mt-1" placeholder="1" min="1" value="1" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Peso Estimado (kg)</label>
                                <input type="number" id="tp-checklist-weight" class="w-full border rounded p-2 mt-1" placeholder="0" step="0.1" />
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="inline-flex items-center gap-2 mt-2">
                                    <input type="checkbox" id="tp-checklist-packed" />
                                    <span class="text-sm text-gray-600">Já empacotado</span>
                                </label>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mt-3">
                            <button id="tp-checklist-save" class="px-3 py-1 rounded bg-green-600 text-white">Salvar Item</button>
                            <button id="tp-checklist-cancel" class="px-3 py-1 rounded bg-gray-100">Cancelar</button>
                        </div>
                    </div>
                    <div id="tp-checklist-list" class="mt-4 space-y-2"></div>
                </div>
                </div>
                <!-- FIM Aba de Checklist -->

                <!-- DASHBOARDS VISUAIS -->
                <div class="mt-4 mb-4 space-y-4">
                    <!-- Dashboard do Checklist -->
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-4 border border-purple-200">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-lg font-bold text-purple-900 flex items-center gap-2">
                                <span class="material-symbols-outlined">checklist</span>
                                Checklist da Viagem
                            </h4>
                            <div id="tp-checklist-progress-badge" class="px-3 py-1 bg-white rounded-full text-sm font-semibold text-purple-700 border border-purple-300">
                                0/0
                            </div>
                        </div>
                        
                        <!-- Barra de Progresso Principal -->
                        <div class="mb-3">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-xs font-semibold text-purple-800">Progresso Geral</span>
                                <span class="text-xs font-bold text-purple-700" id="tp-checklist-percentage">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                                <div id="tp-checklist-progress-bar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-4 rounded-full transition-all duration-500 flex items-center justify-end" style="width: 0%">
                                    <span class="text-white text-xs font-bold mr-2" id="tp-checklist-progress-text"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Grid de Métricas Detalhadas -->
                        <div id="tp-checklist-summary" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
                            <div class="bg-white rounded-lg p-3 border border-purple-100">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-xs text-gray-600">Total Itens</span>
                                    <span class="material-symbols-outlined text-purple-600" style="font-size:16px">inventory_2</span>
                                </div>
                                <div class="text-2xl font-bold text-purple-700" id="tp-checklist-total">0</div>
                                <div class="text-xs text-gray-500 mt-1">itens cadastrados</div>
                            </div>
                            
                            <div class="bg-white rounded-lg p-3 border border-green-100">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-xs text-gray-600">Prontos</span>
                                    <span class="material-symbols-outlined text-green-600" style="font-size:16px">check_circle</span>
                                </div>
                                <div class="text-2xl font-bold text-green-700" id="tp-checklist-packed">0</div>
                                <div class="text-xs text-gray-500 mt-1" id="tp-checklist-packed-weight">0 kg empacotado</div>
                            </div>
                            
                            <div class="bg-white rounded-lg p-3 border border-orange-100">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-xs text-gray-600">Pendentes</span>
                                    <span class="material-symbols-outlined text-orange-600" style="font-size:16px">pending</span>
                                </div>
                                <div class="text-2xl font-bold text-orange-700" id="tp-checklist-pending">0</div>
                                <div class="text-xs text-gray-500 mt-1" id="tp-checklist-pending-weight">0 kg faltando</div>
                            </div>
                            
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-xs text-gray-600">Peso Total</span>
                                    <span class="material-symbols-outlined text-blue-600" style="font-size:16px">scale</span>
                                </div>
                                <div class="text-2xl font-bold text-blue-700" id="tp-checklist-weight">0 kg</div>
                                <div class="text-xs text-gray-500 mt-1" id="tp-checklist-weight-avg">média por item</div>
                            </div>
                        </div>
                        
                        <!-- Resumo por Categorias -->
                        <div class="bg-white rounded-lg p-3 border border-purple-100">
                            <h6 class="text-xs font-bold text-gray-700 mb-2 flex items-center gap-1">
                                <span class="material-symbols-outlined" style="font-size:14px">category</span>
                                Resumo por Categorias
                            </h6>
                            <div id="tp-checklist-categories" class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                <!-- Preenchido dinamicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Dashboard do Roteiro -->
                    <div class="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-4 border border-blue-200">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-lg font-bold text-blue-900 flex items-center gap-2">
                                <span class="material-symbols-outlined">event_note</span>
                                Roteiro da Viagem
                            </h4>
                            <div id="tp-itinerary-badge" class="px-3 py-1 bg-white rounded-full text-sm font-semibold text-blue-700 border border-blue-300">
                                0 eventos
                            </div>
                        </div>
                        <div id="tp-itinerary-timeline" class="space-y-1 mb-3">
                            <!-- Timeline será preenchida dinamicamente -->
                        </div>
                        
                        <!-- Resumo por Tipo -->
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                            <div class="bg-white rounded-lg p-2 border border-orange-100 text-center">
                                <div class="text-xs text-gray-600 flex items-center justify-center gap-1"><span class="material-symbols-outlined text-sm">tour</span>Atividades</div>
                                <div class="text-lg font-bold text-orange-700" id="tp-itinerary-activities">0</div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border border-pink-100 text-center">
                                <div class="text-xs text-gray-600 flex items-center justify-center gap-1"><span class="material-symbols-outlined text-sm">hotel</span>Hospedagens</div>
                                <div class="text-lg font-bold text-pink-700" id="tp-itinerary-accommodations">0</div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border border-blue-100 text-center">
                                <div class="text-xs text-gray-600 flex items-center justify-center gap-1"><span class="material-symbols-outlined text-sm">flight</span>Transportes</div>
                                <div class="text-lg font-bold text-blue-700" id="tp-itinerary-transports">0</div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border border-green-100 text-center">
                                <div class="text-xs text-gray-600 flex items-center justify-center gap-1"><span class="material-symbols-outlined text-sm">event</span>Manuais</div>
                                <div class="text-lg font-bold text-green-700" id="tp-itinerary-manual">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Custos Totais (visível em todas as abas) -->
                <div class="travel-planner-costs">
                    <h4 class="travel-costs-title">Custos Totais</h4>
                    <div class="mt-3">
                        <!-- Top KPIs melhorados -->
                        <div class="travel-kpis-container">
                            <div class="travel-kpi-item estimated">
                                <div class="travel-kpi-label">Orçado</div>
                                <div class="travel-kpi-value" id="tp-kpi-estimated">R$ 0,00</div>
                                <div class="travel-kpi-description">Planejado para gastar</div>
                            </div>
                            <div class="travel-kpi-item realized">
                                <div class="travel-kpi-label">Realizado</div>
                                <div class="travel-kpi-value" id="tp-kpi-realized">R$ 0,00</div>
                                <div class="travel-kpi-description">Cadastrado como transação de reserva (meta)</div>
                            </div>
                            <div class="travel-kpi-item paid">
                                <div class="travel-kpi-label">Pago</div>
                                <div class="travel-kpi-value" id="tp-kpi-paid">R$ 0,00</div>
                                <div class="travel-kpi-description">Seções já pagas</div>
                            </div>
                        </div>

                        <!-- Progress bar melhorada -->
                        <div class="travel-progress-container">
                            <div class="travel-progress-label">
                                <span>Progresso do Plano</span>
                                <span class="text-xs font-medium" id="tp-progress-percentage">0%</span>
                            </div>
                            <div class="travel-progress-bar">
                                <div id="tp-kpi-progress" class="travel-progress-fill" style="width:0%;"></div>
                            </div>
                        </div>

                        <!-- Blocos de custos melhorados -->
                        <div id="tp-cost-blocks" class="travel-cost-blocks"></div>

                        <!-- Resumo final melhorado -->
                        <div class="travel-final-summary">
                            <div class="travel-summary-item costs">
                                <div class="travel-kpi-label">Custos</div>
                                <div class="travel-kpi-value" id="tp-kpi-costs">R$ 0,00</div>
                                <div class="travel-kpi-description">Soma de todas as seções do plano</div>
                            </div>
                            <div class="travel-summary-item remaining">
                                <div class="travel-kpi-label">Restante</div>
                                <div class="travel-kpi-value" id="tp-kpi-remaining">R$ 0,00</div>
                                <div class="travel-kpi-description">Valor a ser poupado</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>
    <script>
    (function(){
        // Helpers
        function q(id){ return document.getElementById(id); }
        function parseBRNumber(v){ 
            try { 
                if (v===undefined||v===null) return 0; 
                if (typeof v === 'number') return v; 
                let s = String(v).trim(); 
                if (!s) return 0; 
                
                // Remove currency symbols and spaces
                s = s.replace(/[R$\s\u00A0]/g,'');
                
                // Detect format: if there's a comma followed by 1-2 digits at the end, it's BR format (123.456,78)
                // Otherwise, if there's a dot followed by 1-2 digits at the end, it's US format (123,456.78)
                const hasBRDecimal = /,\d{1,2}$/.test(s); // ends with ,XX or ,X
                const hasUSDecimal = /\.\d{1,2}$/.test(s); // ends with .XX or .X
                
                if (hasBRDecimal) {
                    // Brazilian format: 1.234.567,89 -> remove dots, replace comma with dot
                    s = s.replace(/\./g,'').replace(',','.');
                } else if (hasUSDecimal) {
                    // US format: 1,234,567.89 -> remove commas, keep dot
                    s = s.replace(/,/g,'');
                } else {
                    // No clear decimal separator, or integer - just remove all separators
                    s = s.replace(/[.,]/g,'');
                }
                
                // Remove any remaining non-numeric characters except dot and minus
                s = s.replace(/[^0-9.\-]/g,'');
                const n = parseFloat(s); 
                return isNaN(n)?0:n; 
            } catch(e){return 0;} 
        }
        function formatBR(v){ try { return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(Number(v)||0); } catch(e){ return String(v); } }
        // Local escape helper for planner (avoid relying on global definitions that may be inside other scopes)
        function escapeHtml(s){ return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    // Storage helpers: keep travelPlans inside state.appData.settings.travelPlans (consistent with the rest of the app)
    function loadTravelPlans(){ try { const s = (window.state && window.state.appData && window.state.appData.settings) ? window.state.appData.settings : null; return (s && Array.isArray(s.travelPlans)) ? s.travelPlans : []; } catch(e){ return []; } }
    async function saveTravelPlans(plans){ try { window.state = window.state || {}; window.state.appData = window.state.appData || {}; window.state.appData.settings = window.state.appData.settings || {}; window.state.appData.settings.travelPlans = plans; if (storage && typeof storage.saveData === 'function') await storage.saveData(window.state.appData); } catch(e){ console.error('saveTravelPlans', e); } }

        // ===== MIGRAÇÃO DE DADOS (CORREÇÃO DE VALORES MULTIPLICADOS) =====
        async function migrateTravelPlanValues() {
            try {
                const plans = loadTravelPlans();
                if (!plans || plans.length === 0) return;
                
                let migrated = false;
                
                plans.forEach(plan => {
                    // Detectar valores incorretos e corrigir
                    // Um valor está incorreto se for > 10000 para hospedagens comuns ou transportes curtos
                    
                    // Migrar transportes
                    if (plan.transports && Array.isArray(plan.transports)) {
                        plan.transports.forEach(t => {
                            // Se subtotal > 50000, provavelmente está multiplicado por 100
                            if (t.subtotal && t.subtotal > 50000) {
                                t.subtotal = t.subtotal / 100;
                                t.fuelCost = t.fuelCost ? t.fuelCost / 100 : t.fuelCost;
                                t.tolls = t.tolls ? t.tolls / 100 : t.tolls;
                                t.rental = t.rental ? t.rental / 100 : t.rental;
                                t.maint = t.maint ? t.maint / 100 : t.maint;
                                t.transfers = t.transfers ? t.transfers / 100 : t.transfers;
                                t.fuelPrice = t.fuelPrice ? t.fuelPrice / 100 : t.fuelPrice;
                                migrated = true;
                            }
                        });
                    }
                    
                    // Migrar hospedagens
                    if (plan.accommodations && Array.isArray(plan.accommodations)) {
                        plan.accommodations.forEach(a => {
                            // Se price > 10000 ou total > 50000, provavelmente está multiplicado por 100
                            if ((a.price && a.price > 10000) || (a.total && a.total > 50000)) {
                                a.price = a.price ? a.price / 100 : a.price;
                                a.total = a.total ? a.total / 100 : a.total;
                                migrated = true;
                            }
                        });
                    }
                    
                    // Migrar atividades
                    if (plan.activities && Array.isArray(plan.activities)) {
                        plan.activities.forEach(a => {
                            // Se price > 10000, provavelmente está multiplicado por 100
                            if (a.price && a.price > 10000) {
                                a.price = a.price / 100;
                                migrated = true;
                            }
                        });
                    }
                    
                    // Migrar estimativa do plano
                    if (plan.estimated && plan.estimated > 100000) {
                        plan.estimated = plan.estimated / 100;
                        migrated = true;
                    }
                    
                    if (plan.saved && plan.saved > 100000) {
                        plan.saved = plan.saved / 100;
                        migrated = true;
                    }
                });
                
                if (migrated) {
                    await saveTravelPlans(plans);
                    showToast('Dados migrados com sucesso! Valores corrigidos.', 'bg-green-600');
                    console.log('✅ Migração concluída: valores divididos por 100');
                    return true;
                }
                return false;
            } catch(e) {
                console.error('Erro na migração:', e);
                return false;
            }
        }

        // ===== SISTEMA DE ABAS =====
        function initTravelTabs() {
            const tabs = document.querySelectorAll('.travel-tab');
            const tabContents = document.querySelectorAll('.travel-tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;
                    
                    // Remove active de todas as abas
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Adiciona active na aba clicada
                    this.classList.add('active');
                    const targetContent = document.getElementById(`tab-${targetTab}`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                });
            });
        }
        
        // Inicializar abas quando modal abrir
        try {
            initTravelTabs();
        } catch(e) {
            console.error('Erro ao inicializar abas:', e);
        }

        // Modal elements
    // Wire both the desktop header button and the in-view "Adicionar Viagem" button
    const openBtn = document.getElementById('desktop-travelplanner-btn');
    const addPlanBtn = document.getElementById('tp-add-plan-btn');
        const modal = document.getElementById('travel-planner-modal');
        const closeBtn = document.getElementById('tp-close');

        function openModal(){ 
            try { 
                if (!modal) return; 
                if (typeof modal.showModal === 'function') modal.showModal(); 
                else modal.setAttribute('open',''); 
                
                // Se não há plano selecionado (tp-id vazio), limpar tudo
                const planId = q('tp-id')?.value;
                if (!planId) {
                    clearPlanForm();
                }
                
                renderPlansList(); 
            } catch(e){ 
                console.error('openModal', e); 
            } 
        }
        function closeModal(){ try { if (!modal) return; if (typeof modal.close === 'function') modal.close(); else modal.removeAttribute('open'); } catch(e){ console.error('closeModal', e); } }
    if (openBtn) openBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        try {
            if (typeof changeView === 'function') return changeView('travel-planner');
            // fallback: activate the tab button or render directly
            const tb = document.querySelector('.tab-button[data-view="travel-planner"]');
            if (tb) { tb.click(); return; }
            if (typeof window.tp === 'object' && typeof window.tp.renderPlansList === 'function') { window.tp.renderPlansList(); }
        } catch (err) { console.error('openBtn click fallback', err); }
    });
    // also wire the in-view "Adicionar Viagem" button (visible in the travel-planner view)
    // Clear any previously filled values before opening so the user starts with a blank form
    if (addPlanBtn) addPlanBtn.addEventListener('click', (e)=>{ 
        e.preventDefault(); 
        try { 
            clearPlanForm(); // Isso já limpa tudo agora, incluindo todas as listas
        } catch(_){} 
        openModal(); 
    });
        if (closeBtn) closeBtn.addEventListener('click', closeModal);

        // Main plan form
        const tpSave = q('tp-modal-save'); const tpNew = q('tp-modal-new');
        const tpDestination = q('tp-modal-destination'); const tpDate = q('tp-modal-date'); const tpEstimated = q('tp-modal-estimated'); const tpSaved = q('tp-modal-saved');
        const tpSummaryDestination = q('tp-summary-destination'); const tpSummaryDate = q('tp-summary-date'); const tpSummaryCost = q('tp-summary-cost'); const tpSummaryTransports = q('tp-summary-transports');

        function clearAllPlanLists() {
            // Ocultar todos os formulários
            const transportForm = q('tp-transport-form');
            if (transportForm) transportForm.classList.add('hidden');
            
            const accommodationForm = q('tp-accommodation-form');
            if (accommodationForm) accommodationForm.classList.add('hidden');
            
            const activityForm = q('tp-activity-form');
            if (activityForm) activityForm.classList.add('hidden');
            
            const itineraryForm = q('tp-itinerary-form');
            if (itineraryForm) itineraryForm.classList.add('hidden');
            
            const checklistForm = q('tp-checklist-form');
            if (checklistForm) checklistForm.classList.add('hidden');
            
            const suggestionsPanel = q('tp-checklist-suggestions-panel');
            if (suggestionsPanel) suggestionsPanel.classList.add('hidden');
            
            const customSuggestionForm = q('tp-custom-suggestion-form');
            if (customSuggestionForm) customSuggestionForm.classList.add('hidden');
            
            // Limpar lista de transportes
            const transportsListEl = q('tp-transport-list');
            // Limpar lista de atividadesportsListEl.innerHTML = '<p class="text-sm text-gray-500">Nenhum transporte cadastrado.</p>';
            
            // Limpar lista de hospedagens
            const accommodationsListEl = q('tp-accommodation-list');
            if (accommodationsListEl) accommodationsListEl.innerHTML = '<p class="text-sm text-gray-500">Nenhuma hospedagem cadastrada.</p>';
            
            // Limpar lista de passeios
            const activitiesListEl = q('tp-activity-list');
            if (activitiesListEl) activitiesListEl.innerHTML = '<p class="text-sm text-gray-500">Nenhuma atividade cadastrada.</p>';
            
            // Limpar lista de roteiro
            const itineraryListEl = q('tp-itinerary-list');
            if (itineraryListEl) itineraryListEl.innerHTML = '<p class="text-sm text-gray-500">Nenhum item de roteiro cadastrado.</p>';
            
            // Limpar lista de checklist
            const checklistListEl = q('tp-checklist-list');
            if (checklistListEl) checklistListEl.innerHTML = '<p class="text-sm text-gray-500">Nenhum item no checklist.</p>';
            
            // Limpar dashboards
            const checklistProgressBar = q('tp-checklist-progress-bar');
            if (checklistProgressBar) checklistProgressBar.style.width = '0%';
            
            const checklistProgressBadge = q('tp-checklist-progress-badge');
            if (checklistProgressBadge) checklistProgressBadge.textContent = '0/0';
            
            const checklistPercentage = q('tp-checklist-percentage');
            if (checklistPercentage) checklistPercentage.textContent = '0%';
            
            const checklistTotal = q('tp-checklist-total');
            if (checklistTotal) checklistTotal.textContent = '0';
            
            const checklistPacked = q('tp-checklist-packed');
            if (checklistPacked) checklistPacked.textContent = '0';
            
            const checklistPackedWeight = q('tp-checklist-packed-weight');
            if (checklistPackedWeight) checklistPackedWeight.textContent = '0 kg empacotado';
            
            const checklistPending = q('tp-checklist-pending');
            if (checklistPending) checklistPending.textContent = '0';
            
            const checklistPendingWeight = q('tp-checklist-pending-weight');
            if (checklistPendingWeight) checklistPendingWeight.textContent = '0 kg faltando';
            
            const checklistWeight = q('tp-checklist-weight');
            if (checklistWeight) checklistWeight.textContent = '0 kg';
            
            const checklistWeightAvg = q('tp-checklist-weight-avg');
            if (checklistWeightAvg) checklistWeightAvg.textContent = 'média por item';
            
            const checklistCategories = q('tp-checklist-categories');
            if (checklistCategories) checklistCategories.innerHTML = '';
            
            // Limpar dashboard do roteiro
            const itineraryBadge = q('tp-itinerary-badge');
            if (itineraryBadge) itineraryBadge.textContent = '0 eventos';
            
            const itineraryTimeline = q('tp-itinerary-timeline');
            if (itineraryTimeline) itineraryTimeline.innerHTML = '<p class="text-sm text-gray-500">Nenhum evento no roteiro.</p>';
            
            const itineraryAccommodations = q('tp-itinerary-accommodations');
            if (itineraryAccommodations) itineraryAccommodations.textContent = '0';
            
            const itineraryActivities = q('tp-itinerary-activities');
            if (itineraryActivities) itineraryActivities.textContent = '0';
            
            const itineraryTransports = q('tp-itinerary-transports');
            if (itineraryTransports) itineraryTransports.textContent = '0';
            
            const itineraryManual = q('tp-itinerary-manual');
            if (itineraryManual) itineraryManual.textContent = '0';
            
            // Limpar KPIs de custos
            const kpiEstimated = q('tp-kpi-estimated');
            if (kpiEstimated) kpiEstimated.textContent = formatBR(0);
            
            const kpiRealized = q('tp-kpi-realized');
            if (kpiRealized) kpiRealized.textContent = formatBR(0);
            
            const kpiPaid = q('tp-kpi-paid');
            if (kpiPaid) kpiPaid.textContent = formatBR(0);
            
            const kpiCosts = q('tp-kpi-costs');
            if (kpiCosts) kpiCosts.textContent = formatBR(0);
            
            const kpiRemaining = q('tp-kpi-remaining');
            if (kpiRemaining) kpiRemaining.textContent = formatBR(0);
            
            const kpiProgress = q('tp-kpi-progress');
            if (kpiProgress) kpiProgress.style.width = '0%';
            
            const progressPercentage = q('tp-progress-percentage');
            if (progressPercentage) progressPercentage.textContent = '0%';
            
            const costBlocks = q('tp-cost-blocks');
            if (costBlocks) costBlocks.innerHTML = '';
        }

        function clearPlanForm(){ 
            if (!tpDestination) return; 
            q('tp-id').value=''; 
            tpDestination.value=''; 
            tpDate.value=''; 
            tpEstimated.value=''; 
            tpSaved.value=''; 
            tpSummaryDestination.textContent='—'; 
            tpSummaryDate.textContent='—'; 
            // Limpar custo total exibido
            if (tpSummaryCost) tpSummaryCost.textContent = formatBR(0);
            // Limpar número de transportes
            if (tpSummaryTransports) tpSummaryTransports.textContent = '0';
            
            // Limpar TODAS as listas e dashboards
            clearAllPlanLists();
        }
        tpNew && tpNew.addEventListener('click', (e)=>{ e.preventDefault(); clearPlanForm(); });
        tpSave && tpSave.addEventListener('click', async (e)=>{
            e.preventDefault();
            const dest = tpDestination.value.trim(); if (!dest) { showToast('Informe o destino', 'bg-yellow-600'); return; }
            const date = tpDate.value || null; const est = parseBRNumber(tpEstimated.value); const saved = parseBRNumber(tpSaved.value);
            const plans = loadTravelPlans(); let id = q('tp-id').value || '';
            if (id) {
                const existing = plans.find(p=>p.id===id);
                if (existing) {
                    existing.destination = dest; existing.date = date; existing.estimated = est; existing.saved = saved; existing.transports = existing.transports || [];
                } else {
                    // if id present but not found, create new
                    plans.unshift({ id, destination: dest, date, estimated: est, saved, transports: [] });
                }
            } else {
                id = 'tp-'+Math.random().toString(36).slice(2,9);
                plans.unshift({ id, destination: dest, date, estimated: est, saved, transports: [] });
                q('tp-id').value = id;
            }
            // Persist plans
            await saveTravelPlans(plans);
            // Ensure there's a matching goal in settings.goals so investments reflect this plan's saved amount
            try {
                window.state = window.state || {}; window.state.appData = window.state.appData || {}; window.state.appData.settings = window.state.appData.settings || {};
                const goals = window.state.appData.settings.goals = window.state.appData.settings.goals || [];
                // find by destination+date as heuristic
                let goal = goals.find(g => (g.linkedTravelPlanId && g.linkedTravelPlanId === id) || (g.name === dest && g.targetDate === date));
                if (!goal) {
                    goal = { id: 'goal-'+Math.random().toString(36).slice(2,8), name: dest, amount: est || 0, linkedTravelPlanId: id };
                    goals.push(goal);
                    try { await storage.saveData(window.state.appData); } catch(e) { console.error('persist goal after tp save', e); }
                } else {
                    // update goal amount if changed
                    if (goal.amount !== est) { goal.amount = est || 0; try { await storage.saveData(window.state.appData); } catch(e){} }
                }
                try { if (typeof renderInvestmentsView === 'function') renderInvestmentsView(); } catch(e) {}
            } catch(e) { console.error('ensure goal for travel plan', e); }
            showToast('Plano salvo', 'bg-green-600');
            renderPlansList();
            // open plan details view for the saved plan so user can add transports
            renderPlanDetails(id);
        });

        // Transports CRUD
    const transportNewBtn = q('tp-transport-new'); const transportForm = q('tp-transport-form');
    const tId = q('tp-transport-id'); const tType = q('tp-transport-type'); const tDesc = q('tp-transport-desc'); const tDist = q('tp-transport-distance'); const tDuration = q('tp-transport-duration'); const tEff = q('tp-transport-efficiency'); const tFuelP = q('tp-transport-fuelprice'); const tTolls = q('tp-transport-tolls'); const tRental = q('tp-transport-rental'); const tMaint = q('tp-transport-maint'); const tTransfers = q('tp-transport-transfers'); const tPaid = q('tp-transport-paid');
    const tSave = q('tp-transport-save'); const tCancel = q('tp-transport-cancel'); const tCalcBox = q('tp-transport-calculations');

        function currentPlan(){ const plans = loadTravelPlans(); const pid = q('tp-id').value; if (!pid) return null; return plans.find(p=>p.id===pid) || null; }

        function showTransportForm(edit){ if (!transportForm) return; transportForm.classList.remove('hidden'); if (!edit){ tId.value=''; tType.value='car'; tDesc.value=''; tDist.value=''; tEff.value=''; tFuelP.value=''; tTolls.value=''; tRental.value=''; tMaint.value=''; tTransfers.value=''; tCalcBox.innerHTML=''; } else { tId.value=edit.id||''; tType.value=edit.type||'car'; tDesc.value=edit.description||''; tDist.value=edit.distance||''; tEff.value=edit.efficiency||''; tFuelP.value=edit.fuelPrice||''; tTolls.value=edit.tolls||''; tRental.value=edit.rental||''; tMaint.value=edit.maint||''; tTransfers.value=edit.transfers||''; computeTransportCalc(); } }
    function showTransportForm(edit){ 
        if (!transportForm) return; 
        transportForm.classList.remove('hidden'); 
        if (!edit){ 
            tId.value=''; 
            tType.value='car'; 
            tDesc.value=''; 
            tDist.value=''; 
            tDuration.value=''; 
            tEff.value=''; 
            tFuelP.value=''; 
            tTolls.value=''; 
            tRental.value=''; 
            tMaint.value=''; 
            tTransfers.value=''; 
            const tLink = q('tp-transport-link');
            if(tLink) tLink.value='';
            if (tPaid) tPaid.checked = false; 
            tCalcBox.innerHTML=''; 
        } else { 
            tId.value=edit.id||''; 
            tType.value=edit.type||'car'; 
            tDesc.value=edit.description||''; 
            tDist.value=edit.distance||''; 
            tDuration.value=edit.duration||''; 
            tEff.value=edit.efficiency||''; 
            tFuelP.value=edit.fuelPrice||''; 
            tTolls.value=edit.tolls||''; 
            tRental.value=edit.rental||''; 
            tMaint.value=edit.maint||''; 
            tTransfers.value=edit.transfers||''; 
            const tLink = q('tp-transport-link');
            if(tLink) tLink.value=edit.link||'';
            if (tPaid) tPaid.checked = !!edit.paid; 
            computeTransportCalc(); 
        } 
    }
        if (transportNewBtn) transportNewBtn.addEventListener('click', ()=>{ showTransportForm(null); });
        if (tCancel) tCancel.addEventListener('click', (e)=>{ e.preventDefault(); transportForm.classList.add('hidden'); });

        function computeTransportCalc(){ try {
            const dist = parseBRNumber(tDist.value); const eff = parseBRNumber(tEff.value); const fuelP = parseBRNumber(tFuelP.value); const tolls = parseBRNumber(tTolls.value); const rental = parseBRNumber(tRental.value); const maint = parseBRNumber(tMaint.value); const transfers = parseBRNumber(tTransfers.value);
            let fuelLiters = 0; let fuelCost = 0;
            if (eff > 0) { fuelLiters = dist / eff; fuelCost = fuelLiters * fuelP; }
            const subTotal = fuelCost + tolls + rental + maint + transfers;
            const html = `<div class="text-sm text-gray-700">Consumo estimado: <strong class="text-gray-900">${fuelLiters.toFixed(2)} L</strong> — Custo combustível: <strong class="text-gray-900">${formatBR(fuelCost)}</strong></div><div class="mt-1 text-sm">Subtotal transporte: <strong class="text-gray-900">${formatBR(subTotal)}</strong></div>`;
            tCalcBox.innerHTML = html;
            return { fuelLiters, fuelCost, subtotal: subTotal };
        } catch(e){ console.error('computeTransportCalc', e); return { fuelLiters:0, fuelCost:0, subtotal:0 }; } }

        // recompute live on input
        ['input','change'].forEach(evt => { [tDist,tEff,tFuelP,tTolls,tRental,tMaint,tTransfers].forEach(el=>{ if (el) el.addEventListener(evt, computeTransportCalc); }); });

        async function saveTransport(){ try {
            const pid = q('tp-id').value; if (!pid) { showToast('Salve o plano antes de adicionar transportes', 'bg-yellow-600'); return; }
            const plans = loadTravelPlans(); const plan = plans.find(p=>p.id===pid); if (!plan) return;
            const obj = { 
                id: tId.value || ('tr-'+Math.random().toString(36).slice(2,9)), 
                type: tType.value, 
                description: tDesc.value, 
                distance: parseBRNumber(tDist.value), 
                duration: parseFloat(tDuration.value) || 0, 
                efficiency: parseBRNumber(tEff.value), 
                fuelPrice: parseBRNumber(tFuelP.value), 
                tolls: parseBRNumber(tTolls.value), 
                rental: parseBRNumber(tRental.value), 
                maint: parseBRNumber(tMaint.value), 
                transfers: parseBRNumber(tTransfers.value), 
                link: q('tp-transport-link')?.value || '',
                paid: (tPaid && !!tPaid.checked) 
            };
            const calc = computeTransportCalc(); obj.fuelLiters = calc.fuelLiters; obj.fuelCost = calc.fuelCost; obj.subtotal = calc.subtotal;
            plan.transports = plan.transports || [];
            const idx = plan.transports.findIndex(t=>t.id===obj.id);
            if (idx === -1) plan.transports.push(obj); else plan.transports[idx] = obj;
            
            // Sincronizar viagem IDA/VOLTA com roteiro (apenas para tipo Carro)
            if(obj.type === 'carro' && obj.duration > 0){
                if(plan.accommodations && plan.accommodations.length > 0){
                    syncTravelToItinerary(plan, obj);
                }
            }
            
            await saveTravelPlans(plans);
            
            // Mensagem personalizada
            if(obj.type === 'carro' && obj.duration > 0 && (!plan.accommodations || plan.accommodations.length === 0)){
                showToast('Transporte salvo! Cadastre a hospedagem para ver IDA/VOLTA no roteiro.', 'bg-blue-600');
            } else {
                showToast('Transporte salvo', 'bg-green-600');
            }
            transportForm.classList.add('hidden');
            renderPlanDetails(plan.id);
        } catch(e){ console.error('saveTransport', e); showToast('Erro ao salvar transporte', 'bg-red-600'); } }
        if (tSave) tSave.addEventListener('click', (e)=>{ e.preventDefault(); saveTransport(); });

        // ===== HOSPEDAGEM CRUD =====
        const accommodationNewBtn = q('tp-accommodation-new'); const accommodationForm = q('tp-accommodation-form');
        const aId = q('tp-accommodation-id'); const aName = q('tp-accommodation-name'); const aType = q('tp-accommodation-type'); const aAddress = q('tp-accommodation-address'); const aCheckin = q('tp-accommodation-checkin'); const aCheckinTime = q('tp-accommodation-checkin-time'); const aCheckout = q('tp-accommodation-checkout'); const aCheckoutTime = q('tp-accommodation-checkout-time'); const aNights = q('tp-accommodation-nights'); const aPrice = q('tp-accommodation-price'); const aTotal = q('tp-accommodation-total'); const aPaid = q('tp-accommodation-paid');
        const aSave = q('tp-accommodation-save'); const aCancel = q('tp-accommodation-cancel');

        function showAccommodationForm(edit){ 
            if (!accommodationForm) return; 
            accommodationForm.classList.remove('hidden'); 
            if (!edit){ 
                if(aId) aId.value=''; 
                if(aName) aName.value=''; 
                if(aType) aType.value='hotel'; 
                if(aAddress) aAddress.value=''; 
                if(aCheckin) aCheckin.value=''; 
                if(aCheckinTime) aCheckinTime.value=''; 
                if(aCheckout) aCheckout.value=''; 
                if(aCheckoutTime) aCheckoutTime.value=''; 
                if(aNights) aNights.value=''; 
                if(aPrice) aPrice.value=''; 
                if(aTotal) aTotal.value='R$ 0,00'; 
                const aLink = q('tp-accommodation-link');
                if(aLink) aLink.value='';
                if (aPaid) aPaid.checked = false; 
            } else { 
                if(aId) aId.value=edit.id||''; 
                if(aName) aName.value=edit.name||''; 
                if(aType) aType.value=edit.type||'hotel'; 
                if(aAddress) aAddress.value=edit.address||''; 
                if(aCheckin) aCheckin.value=edit.checkin||''; 
                if(aCheckinTime) aCheckinTime.value=edit.checkinTime||''; 
                if(aCheckout) aCheckout.value=edit.checkout||''; 
                if(aCheckoutTime) aCheckoutTime.value=edit.checkoutTime||''; 
                if(aNights) aNights.value=edit.nights||''; 
                if(aPrice) aPrice.value=edit.price||''; 
                const aLink = q('tp-accommodation-link');
                if(aLink) aLink.value=edit.link||'';
                computeAccommodationTotal(); 
                if (aPaid) aPaid.checked = !!edit.paid; 
            } 
        }
        if (accommodationNewBtn) accommodationNewBtn.addEventListener('click', ()=>{ showAccommodationForm(null); });
        if (aCancel) aCancel.addEventListener('click', (e)=>{ e.preventDefault(); accommodationForm.classList.add('hidden'); });

        // Calcula número de diárias automaticamente baseado nas datas
        function computeAccommodationNights(){ try { if(!aCheckin || !aCheckout || !aNights) return; const cin = new Date(aCheckin.value); const cout = new Date(aCheckout.value); if(cin && cout && cout > cin){ const diffTime = Math.abs(cout - cin); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if(aNights) aNights.value = diffDays; computeAccommodationTotal(); } } catch(e){ console.error('computeAccommodationNights', e); } }
        if(aCheckin) aCheckin.addEventListener('change', computeAccommodationNights);
        if(aCheckout) aCheckout.addEventListener('change', computeAccommodationNights);

        function computeAccommodationTotal(){ 
            try { 
                const nights = parseInt(aNights?.value) || 0; 
                const price = parseBRNumber(aPrice?.value || '0'); 
                const total = nights * price; 
                if (aTotal) aTotal.value = formatBR(total); 
                return total; 
            } catch(e){ 
                return 0; 
            } 
        }
        ['input','change'].forEach(evt => { [aNights,aPrice].forEach(el=>{ if (el) el.addEventListener(evt, computeAccommodationTotal); }); });

        async function saveAccommodation(){ try {
            const pid = q('tp-id')?.value; if (!pid) { showToast('Salve o plano antes de adicionar hospedagem', 'bg-yellow-600'); return; }
            const plans = loadTravelPlans(); const plan = plans.find(p=>p.id===pid); if (!plan) return;
            const obj = { 
                id: aId?.value || ('acc-'+Math.random().toString(36).slice(2,9)), 
                name: aName?.value || '', 
                type: aType?.value || 'hotel', 
                address: aAddress?.value || '', 
                checkin: aCheckin?.value || '', 
                checkinTime: aCheckinTime?.value || '', 
                checkout: aCheckout?.value || '', 
                checkoutTime: aCheckoutTime?.value || '', 
                nights: parseInt(aNights?.value)||0, 
                price: parseBRNumber(aPrice?.value || '0'), 
                total: computeAccommodationTotal(), 
                link: q('tp-accommodation-link')?.value || '',
                paid: (aPaid && !!aPaid.checked) 
            };
            plan.accommodations = plan.accommodations || [];
            const idx = plan.accommodations.findIndex(a=>a.id===obj.id);
            if (idx === -1) plan.accommodations.push(obj); else plan.accommodations[idx] = obj;
            
            // Sincronizar com roteiro
            syncAccommodationToItinerary(plan, obj);
            
            // RE-SINCRONIZAR todos os transportes tipo 'carro' com duração
            // (caso o transporte tenha sido cadastrado antes da hospedagem)
            if (plan.transports && plan.transports.length > 0) {
                plan.transports.forEach(transport => {
                    if (transport.type === 'carro' && transport.duration > 0) {
                        syncTravelToItinerary(plan, transport);
                    }
                });
            }
            
            await saveTravelPlans(plans);
            showToast('Hospedagem salva', 'bg-green-600');
            if(accommodationForm) accommodationForm.classList.add('hidden');
            renderPlanDetails(plan.id);
        } catch(e){ console.error('saveAccommodation', e); showToast('Erro ao salvar hospedagem', 'bg-red-600'); } }
        if (aSave) aSave.addEventListener('click', (e)=>{ e.preventDefault(); saveAccommodation(); });
        
        // Função para sincronizar hospedagem com o roteiro
        function syncAccommodationToItinerary(plan, accommodation) {
            try {
                if (!plan || !accommodation) return;
                
                plan.itinerary = plan.itinerary || [];
                
                // Mapeamento de rótulos para tipos de hospedagem
                const accommodationTypeLabels = {
                    'hotel': 'Hotel/Hostel',
                    'airbnb': 'Airbnb',
                    'reserva': 'Reserva'
                };
                const accLabel = accommodationTypeLabels[accommodation.type] || accommodation.type;
                
                // Criar/atualizar entrada de check-in no roteiro
                if (accommodation.checkin) {
                    const checkinId = `acc-checkin-${accommodation.id}`;
                    const checkinTime = accommodation.checkinTime || '14:00'; // Hora padrão de check-in
                    const checkinEntry = {
                        id: checkinId,
                        date: accommodation.checkin,
                        time: checkinTime,
                        activity: `Check-in: ${accommodation.name}`,
                        location: accommodation.address || accommodation.name,
                        notes: `Tipo: ${accLabel}`,
                        type: 'accommodation-checkin',
                        linkedId: accommodation.id,
                        autoSync: true
                    };
                    
                    const existingCheckinIdx = plan.itinerary.findIndex(i => i.id === checkinId);
                    if (existingCheckinIdx === -1) {
                        plan.itinerary.push(checkinEntry);
                    } else {
                        plan.itinerary[existingCheckinIdx] = checkinEntry;
                    }
                }
                
                // Criar/atualizar entrada de check-out no roteiro
                if (accommodation.checkout) {
                    const checkoutId = `acc-checkout-${accommodation.id}`;
                    const checkoutTime = accommodation.checkoutTime || '12:00'; // Hora padrão de check-out
                    const checkoutEntry = {
                        id: checkoutId,
                        date: accommodation.checkout,
                        time: checkoutTime,
                        activity: `Check-out: ${accommodation.name}`,
                        location: accommodation.address || accommodation.name,
                        notes: `Tipo: ${accLabel}`,
                        type: 'accommodation-checkout',
                        linkedId: accommodation.id,
                        autoSync: true
                    };
                    
                    const existingCheckoutIdx = plan.itinerary.findIndex(i => i.id === checkoutId);
                    if (existingCheckoutIdx === -1) {
                        plan.itinerary.push(checkoutEntry);
                    } else {
                        plan.itinerary[existingCheckoutIdx] = checkoutEntry;
                    }
                }
                
                // Ordenar roteiro por data e hora
                plan.itinerary.sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + (a.time || '00:00'));
                    const dateB = new Date(b.date + ' ' + (b.time || '00:00'));
                    return dateA - dateB;
                });
                
            } catch(e) {
                console.error('syncAccommodationToItinerary', e);
            }
        }

        // Função para sincronizar viagem IDA/VOLTA com o roteiro (apenas Carro)
        function syncTravelToItinerary(plan, transport) {
            try {
                if (!plan || !transport || transport.type !== 'carro' || !transport.duration) {
                    return;
                }
                
                plan.itinerary = plan.itinerary || [];
                
                // Encontrar primeira hospedagem (check-in mais cedo)
                const firstAccommodation = (plan.accommodations || [])
                    .filter(a => a.checkin)
                    .sort((a, b) => new Date(a.checkin) - new Date(b.checkin))[0];
                
                // Encontrar última hospedagem (check-out mais tarde)
                const lastAccommodation = (plan.accommodations || [])
                    .filter(a => a.checkout)
                    .sort((a, b) => new Date(b.checkout) - new Date(a.checkout))[0];
                
                if (!firstAccommodation || !lastAccommodation) {
                    return;
                }
                
                // Calcular horário de partida IDA (subtrair duração da viagem do check-in)
                const checkinDateTime = new Date(firstAccommodation.checkin + ' ' + (firstAccommodation.checkinTime || '14:00'));
                const departureDateTime = new Date(checkinDateTime.getTime() - (transport.duration * 60 * 60 * 1000));
                const departureDate = departureDateTime.toISOString().split('T')[0];
                const departureTime = departureDateTime.toTimeString().slice(0, 5);
                
                // Calcular horário de chegada VOLTA (adicionar duração da viagem ao check-out)
                const checkoutDateTime = new Date(lastAccommodation.checkout + ' ' + (lastAccommodation.checkoutTime || '12:00'));
                const arrivalDateTime = new Date(checkoutDateTime.getTime() + (transport.duration * 60 * 60 * 1000));
                const arrivalDate = arrivalDateTime.toISOString().split('T')[0];
                const arrivalTime = arrivalDateTime.toTimeString().slice(0, 5);
                
                // Calcular distância de IDA e VOLTA (metade da distância total cada)
                const halfDistance = Math.round((transport.distance || 0) / 2);
                
                // Criar/atualizar entrada de IDA no roteiro
                const departureId = `transport-departure-${transport.id}`;
                const departureEntry = {
                    id: departureId,
                    date: departureDate,
                    time: departureTime,
                    activity: `🚗 IDA - ${transport.description || 'Viagem de carro'}`,
                    location: `Duração estimada: ${transport.duration}h • ${halfDistance}km`,
                    notes: `Partida para ${firstAccommodation.name}. Chegada prevista: ${firstAccommodation.checkinTime || '14:00'}`,
                    type: 'transport-departure',
                    linkedId: transport.id,
                    autoSync: true
                };
                
                const existingDepartureIdx = plan.itinerary.findIndex(i => i.id === departureId);
                if (existingDepartureIdx === -1) {
                    plan.itinerary.push(departureEntry);
                } else {
                    plan.itinerary[existingDepartureIdx] = departureEntry;
                }
                
                // Criar/atualizar entrada de VOLTA no roteiro
                const returnId = `transport-return-${transport.id}`;
                const returnEntry = {
                    id: returnId,
                    date: arrivalDate,
                    time: arrivalTime,
                    activity: `🚗 VOLTA - ${transport.description || 'Viagem de carro'}`,
                    location: `Duração estimada: ${transport.duration}h • ${halfDistance}km`,
                    notes: `Retorno de ${lastAccommodation.name}. Saída: ${lastAccommodation.checkoutTime || '12:00'}`,
                    type: 'transport-return',
                    linkedId: transport.id,
                    autoSync: true
                };
                
                const existingReturnIdx = plan.itinerary.findIndex(i => i.id === returnId);
                if (existingReturnIdx === -1) {
                    plan.itinerary.push(returnEntry);
                } else {
                    plan.itinerary[existingReturnIdx] = returnEntry;
                }
                
                // Ordenar roteiro por data e hora
                plan.itinerary.sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + (a.time || '00:00'));
                    const dateB = new Date(b.date + ' ' + (b.time || '00:00'));
                    return dateA - dateB;
                });
                
            } catch(e) {
                console.error('syncTravelToItinerary', e);
            }
        }

        // ===== ATIVIDADES CRUD =====
        const activityNewBtn = q('tp-activity-new'); const activityForm = q('tp-activity-form');
        const acId = q('tp-activity-id'); const acName = q('tp-activity-name'); const acType = q('tp-activity-type'); const acDate = q('tp-activity-date'); const acTime = q('tp-activity-time'); const acDuration = q('tp-activity-duration'); const acPrice = q('tp-activity-price'); const acPaid = q('tp-activity-paid');
        const acSave = q('tp-activity-save'); const acCancel = q('tp-activity-cancel');

        function showActivityForm(edit){ if (!activityForm) return; activityForm.classList.remove('hidden'); if (!edit){ acId.value=''; acName.value=''; acType.value='passeio'; acDate.value=''; acTime.value=''; acDuration.value=''; acPrice.value=''; if (acPaid) acPaid.checked = false; } else { acId.value=edit.id||''; acName.value=edit.name||''; acType.value=edit.type||'passeio'; acDate.value=edit.date||''; acTime.value=edit.time||''; acDuration.value=edit.duration||''; acPrice.value=edit.price||''; if (acPaid) acPaid.checked = !!edit.paid; } }
        if (activityNewBtn) activityNewBtn.addEventListener('click', ()=>{ showActivityForm(null); });
        if (acCancel) acCancel.addEventListener('click', (e)=>{ e.preventDefault(); activityForm.classList.add('hidden'); });

        async function saveActivity(){ try {
            const pid = q('tp-id').value; if (!pid) { showToast('Salve o plano antes de adicionar atividades', 'bg-yellow-600'); return; }
            const plans = loadTravelPlans(); const plan = plans.find(p=>p.id===pid); if (!plan) return;
            const obj = { id: acId.value || ('act-'+Math.random().toString(36).slice(2,9)), name: acName.value, type: acType.value, date: acDate.value, time: acTime.value, duration: acDuration.value, price: parseBRNumber(acPrice.value), paid: (acPaid && !!acPaid.checked) };
            plan.activities = plan.activities || [];
            const idx = plan.activities.findIndex(a=>a.id===obj.id);
            if (idx === -1) plan.activities.push(obj); else plan.activities[idx] = obj;
            await saveTravelPlans(plans);
            showToast('Passeio salvo', 'bg-green-600');
            activityForm.classList.add('hidden');
            renderPlanDetails(plan.id);
        } catch(e){ console.error('saveActivity', e); showToast('Erro ao salvar passeio', 'bg-red-600'); } }
        if (acSave) acSave.addEventListener('click', (e)=>{ e.preventDefault(); saveActivity(); });

        // ===== ROTEIRO CRUD =====
        const itineraryNewBtn = q('tp-itinerary-new'); const itineraryForm = q('tp-itinerary-form');
        const iId = q('tp-itinerary-id'); const iDay = q('tp-itinerary-day'); const iDate = q('tp-itinerary-date'); const iTime = q('tp-itinerary-time'); const iActivity = q('tp-itinerary-activity'); const iLocation = q('tp-itinerary-location'); const iNotes = q('tp-itinerary-notes');
        const iSave = q('tp-itinerary-save'); const iCancel = q('tp-itinerary-cancel');

        function showItineraryForm(edit){ if (!itineraryForm) return; itineraryForm.classList.remove('hidden'); if (!edit){ iId.value=''; iDay.value=''; iDate.value=''; iTime.value=''; iActivity.value=''; iLocation.value=''; iNotes.value=''; } else { iId.value=edit.id||''; iDay.value=edit.day||''; iDate.value=edit.date||''; iTime.value=edit.time||''; iActivity.value=edit.activity||''; iLocation.value=edit.location||''; iNotes.value=edit.notes||''; } }
        if (itineraryNewBtn) itineraryNewBtn.addEventListener('click', ()=>{ showItineraryForm(null); });
        if (iCancel) iCancel.addEventListener('click', (e)=>{ e.preventDefault(); itineraryForm.classList.add('hidden'); });

        async function saveItinerary(){ try {
            const pid = q('tp-id').value; if (!pid) { showToast('Salve o plano antes de adicionar roteiro', 'bg-yellow-600'); return; }
            const plans = loadTravelPlans(); const plan = plans.find(p=>p.id===pid); if (!plan) return;
            const obj = { id: iId.value || ('itin-'+Math.random().toString(36).slice(2,9)), day: parseInt(iDay.value)||1, date: iDate.value, time: iTime.value, activity: iActivity.value, location: iLocation.value, notes: iNotes.value };
            plan.itinerary = plan.itinerary || [];
            const idx = plan.itinerary.findIndex(i=>i.id===obj.id);
            if (idx === -1) plan.itinerary.push(obj); else plan.itinerary[idx] = obj;
            await saveTravelPlans(plans);
            showToast('Roteiro salvo', 'bg-green-600');
            itineraryForm.classList.add('hidden');
            renderPlanDetails(plan.id);
        } catch(e){ console.error('saveItinerary', e); showToast('Erro ao salvar roteiro', 'bg-red-600'); } }
        if (iSave) iSave.addEventListener('click', (e)=>{ e.preventDefault(); saveItinerary(); });

        // ===== CHECKLIST CRUD =====
        const checklistNewBtn = q('tp-checklist-new'); const checklistForm = q('tp-checklist-form');
        const cId = q('tp-checklist-id'); const cItem = q('tp-checklist-item'); const cCategory = q('tp-checklist-category'); const cQuantity = q('tp-checklist-quantity'); const cWeight = q('tp-checklist-weight'); const cPacked = q('tp-checklist-packed');
        const cSave = q('tp-checklist-save'); const cCancel = q('tp-checklist-cancel');

        function showChecklistForm(edit){ if (!checklistForm) return; checklistForm.classList.remove('hidden'); if (!edit){ cId.value=''; cItem.value=''; cCategory.value='roupas'; cQuantity.value='1'; cWeight.value=''; if(cPacked) cPacked.checked = false; } else { cId.value=edit.id||''; cItem.value=edit.item||''; cCategory.value=edit.category||'roupas'; cQuantity.value=edit.quantity||'1'; cWeight.value=edit.weight||''; if(cPacked) cPacked.checked = !!edit.packed; } }
        if (checklistNewBtn) checklistNewBtn.addEventListener('click', ()=>{ showChecklistForm(null); });
        if (cCancel) cCancel.addEventListener('click', (e)=>{ e.preventDefault(); checklistForm.classList.add('hidden'); });

        async function saveChecklist(){ try {
            const pid = q('tp-id').value; if (!pid) { showToast('Salve o plano antes de adicionar checklist', 'bg-yellow-600'); return; }
            const plans = loadTravelPlans(); const plan = plans.find(p=>p.id===pid); if (!plan) return;
            const obj = { id: cId.value || ('chk-'+Math.random().toString(36).slice(2,9)), item: cItem.value, category: cCategory.value, quantity: parseInt(cQuantity.value)||1, weight: parseBRNumber(cWeight.value), packed: (cPacked && !!cPacked.checked) };
            plan.checklist = plan.checklist || [];
            const idx = plan.checklist.findIndex(c=>c.id===obj.id);
            if (idx === -1) plan.checklist.push(obj); else plan.checklist[idx] = obj;
            await saveTravelPlans(plans);
            showToast('Item salvo', 'bg-green-600');
            checklistForm.classList.add('hidden');
            renderPlanDetails(plan.id);
        } catch(e){ console.error('saveChecklist', e); showToast('Erro ao salvar item', 'bg-red-600'); } }
        if (cSave) cSave.addEventListener('click', (e)=>{ e.preventDefault(); saveChecklist(); });

        // ===== SISTEMA DE SUGESTÕES DO CHECKLIST (CATÁLOGO EXPANDIDO) =====
        
        // Catálogo padrão expandido de sugestões (144 itens)
        const DEFAULT_CHECKLIST_CATALOG = [
            // Documentos (18 itens)
            {item: 'Passaporte', category: 'Documentos', weight: 0.1, quantity: 1},
            {item: 'Visto', category: 'Documentos', weight: 0.05, quantity: 1},
            {item: 'Carteira de Identidade (RG)', category: 'Documentos', weight: 0.05, quantity: 1},
            {item: 'CPF', category: 'Documentos', weight: 0.01, quantity: 1},
            {item: 'CNH (Carteira de Motorista)', category: 'Documentos', weight: 0.05, quantity: 1},
            {item: 'Cartão de Crédito', category: 'Documentos', weight: 0.01, quantity: 2},
            {item: 'Cartão de Débito', category: 'Documentos', weight: 0.01, quantity: 1},
            {item: 'Dinheiro em Espécie (Real)', category: 'Documentos', weight: 0.05, quantity: 1},
            {item: 'Moeda Estrangeira', category: 'Documentos', weight: 0.05, quantity: 1},
            {item: 'Seguro Viagem (Apólice)', category: 'Documentos', weight: 0.05, quantity: 1},
            {item: 'Vouchers de Hotel', category: 'Documentos', weight: 0.05, quantity: 1},
            {item: 'Passagens Aéreas (Impressas)', category: 'Documentos', weight: 0.1, quantity: 1},
            {item: 'Carteira de Vacinação', category: 'Documentos', weight: 0.05, quantity: 1},
            {item: 'Certificado Vacinação COVID-19', category: 'Documentos', weight: 0.02, quantity: 1},
            {item: 'Cartão do Plano de Saúde', category: 'Documentos', weight: 0.01, quantity: 1},
            {item: 'Carteirinha de Estudante', category: 'Documentos', weight: 0.01, quantity: 1},
            {item: 'PID (Permissão Internacional p/ Dirigir)', category: 'Documentos', weight: 0.05, quantity: 1},
            {item: 'Cópias de Documentos (Digital/Impressa)', category: 'Documentos', weight: 0.1, quantity: 1},
            
            // Roupas (35 itens)
            {item: 'Camisetas Básicas', category: 'Roupas', weight: 0.2, quantity: 5},
            {item: 'Camisetas Manga Longa', category: 'Roupas', weight: 0.25, quantity: 2},
            {item: 'Polo/Camisa Social', category: 'Roupas', weight: 0.3, quantity: 2},
            {item: 'Regata', category: 'Roupas', weight: 0.15, quantity: 3},
            {item: 'Calças Jeans', category: 'Roupas', weight: 0.5, quantity: 2},
            {item: 'Calças de Tecido', category: 'Roupas', weight: 0.4, quantity: 2},
            {item: 'Legging/Calça Esportiva', category: 'Roupas', weight: 0.3, quantity: 2},
            {item: 'Shorts/Bermudas', category: 'Roupas', weight: 0.25, quantity: 3},
            {item: 'Vestidos Casuais', category: 'Roupas', weight: 0.3, quantity: 2},
            {item: 'Vestido de Festa', category: 'Roupas', weight: 0.4, quantity: 1},
            {item: 'Saia', category: 'Roupas', weight: 0.25, quantity: 2},
            {item: 'Casaco/Blazer', category: 'Roupas', weight: 0.8, quantity: 1},
            {item: 'Jaqueta Impermeável', category: 'Roupas', weight: 0.6, quantity: 1},
            {item: 'Moletom/Blusa de Frio', category: 'Roupas', weight: 0.5, quantity: 2},
            {item: 'Suéter/Cardigã', category: 'Roupas', weight: 0.4, quantity: 1},
            {item: 'Jaqueta Corta-Vento', category: 'Roupas', weight: 0.35, quantity: 1},
            {item: 'Roupa de Banho/Biquíni', category: 'Roupas', weight: 0.15, quantity: 2},
            {item: 'Sunga/Maiô', category: 'Roupas', weight: 0.12, quantity: 1},
            {item: 'Saída de Praia/Canga', category: 'Roupas', weight: 0.2, quantity: 1},
            {item: 'Pijama', category: 'Roupas', weight: 0.3, quantity: 2},
            {item: 'Roupão', category: 'Roupas', weight: 0.6, quantity: 1},
            {item: 'Meias Curtas', category: 'Roupas', weight: 0.05, quantity: 5},
            {item: 'Meias Longas', category: 'Roupas', weight: 0.08, quantity: 3},
            {item: 'Roupas Íntimas (Calcinha/Cueca)', category: 'Roupas', weight: 0.05, quantity: 7},
            {item: 'Sutiãs', category: 'Roupas', weight: 0.1, quantity: 3},
            {item: 'Roupa de Ginástica', category: 'Roupas', weight: 0.25, quantity: 2},
            {item: 'Tênis Casual', category: 'Roupas', weight: 0.5, quantity: 1},
            {item: 'Tênis Esportivo', category: 'Roupas', weight: 0.55, quantity: 1},
            {item: 'Sapato Social', category: 'Roupas', weight: 0.6, quantity: 1},
            {item: 'Sandálias', category: 'Roupas', weight: 0.3, quantity: 1},
            {item: 'Rasteirinha', category: 'Roupas', weight: 0.2, quantity: 1},
            {item: 'Chinelo/Havaianas', category: 'Roupas', weight: 0.2, quantity: 1},
            {item: 'Bota/Coturno', category: 'Roupas', weight: 0.8, quantity: 1},
            {item: 'Cinto', category: 'Roupas', weight: 0.15, quantity: 1},
            {item: 'Pijama/Roupa para Dormir', category: 'Roupas', weight: 0.25, quantity: 2},
            
            // Higiene e Beleza (28 itens)
            {item: 'Escova de Dentes', category: 'Higiene', weight: 0.03, quantity: 1},
            {item: 'Pasta de Dente', category: 'Higiene', weight: 0.15, quantity: 1},
            {item: 'Fio Dental', category: 'Higiene', weight: 0.02, quantity: 1},
            {item: 'Enxaguante Bucal', category: 'Higiene', weight: 0.25, quantity: 1},
            {item: 'Shampoo', category: 'Higiene', weight: 0.3, quantity: 1},
            {item: 'Condicionador', category: 'Higiene', weight: 0.3, quantity: 1},
            {item: 'Máscara Capilar', category: 'Higiene', weight: 0.25, quantity: 1},
            {item: 'Leave-in', category: 'Higiene', weight: 0.15, quantity: 1},
            {item: 'Sabonete Líquido', category: 'Higiene', weight: 0.2, quantity: 1},
            {item: 'Sabonete em Barra', category: 'Higiene', weight: 0.1, quantity: 2},
            {item: 'Desodorante', category: 'Higiene', weight: 0.15, quantity: 1},
            {item: 'Perfume/Colônia', category: 'Higiene', weight: 0.2, quantity: 1},
            {item: 'Protetor Solar (Corpo)', category: 'Higiene', weight: 0.25, quantity: 1},
            {item: 'Protetor Solar (Rosto)', category: 'Higiene', weight: 0.1, quantity: 1},
            {item: 'Hidratante Corporal', category: 'Higiene', weight: 0.25, quantity: 1},
            {item: 'Hidratante Facial', category: 'Higiene', weight: 0.15, quantity: 1},
            {item: 'Repelente de Insetos', category: 'Higiene', weight: 0.15, quantity: 1},
            {item: 'Toalha de Banho', category: 'Higiene', weight: 0.6, quantity: 1},
            {item: 'Toalha de Rosto', category: 'Higiene', weight: 0.3, quantity: 1},
            {item: 'Toalha de Praia', category: 'Higiene', weight: 0.5, quantity: 1},
            {item: 'Pente/Escova de Cabelo', category: 'Higiene', weight: 0.1, quantity: 1},
            {item: 'Secador de Cabelo', category: 'Higiene', weight: 0.6, quantity: 1},
            {item: 'Chapinha/Babyliss', category: 'Higiene', weight: 0.4, quantity: 1},
            {item: 'Lâmina/Aparelho de Barbear', category: 'Higiene', weight: 0.05, quantity: 1},
            {item: 'Espuma/Gel de Barbear', category: 'Higiene', weight: 0.15, quantity: 1},
            {item: 'Absorventes', category: 'Higiene', weight: 0.2, quantity: 1},
            {item: 'Cotonete', category: 'Higiene', weight: 0.05, quantity: 1},
            {item: 'Necessaire/Estojo', category: 'Higiene', weight: 0.2, quantity: 1},
            
            // Eletrônicos (15 itens)
            {item: 'Smartphone', category: 'Eletrônicos', weight: 0.2, quantity: 1},
            {item: 'Carregador de Celular', category: 'Eletrônicos', weight: 0.1, quantity: 1},
            {item: 'Cabo USB Extra', category: 'Eletrônicos', weight: 0.05, quantity: 1},
            {item: 'Notebook/Tablet', category: 'Eletrônicos', weight: 2.0, quantity: 1},
            {item: 'Carregador de Notebook', category: 'Eletrônicos', weight: 0.4, quantity: 1},
            {item: 'Mouse', category: 'Eletrônicos', weight: 0.1, quantity: 1},
            {item: 'Câmera Fotográfica', category: 'Eletrônicos', weight: 0.5, quantity: 1},
            {item: 'GoPro/Action Cam', category: 'Eletrônicos', weight: 0.2, quantity: 1},
            {item: 'Fones de Ouvido', category: 'Eletrônicos', weight: 0.1, quantity: 1},
            {item: 'Fone Bluetooth/Airpods', category: 'Eletrônicos', weight: 0.05, quantity: 1},
            {item: 'Adaptador Universal de Tomada', category: 'Eletrônicos', weight: 0.15, quantity: 1},
            {item: 'Power Bank (Bateria Portátil)', category: 'Eletrônicos', weight: 0.3, quantity: 1},
            {item: 'Smartwatch', category: 'Eletrônicos', weight: 0.08, quantity: 1},
            {item: 'Kindle/E-reader', category: 'Eletrônicos', weight: 0.2, quantity: 1},
            {item: 'Cartão de Memória Extra', category: 'Eletrônicos', weight: 0.01, quantity: 1},
            {item: 'Hub USB', category: 'Eletrônicos', weight: 0.08, quantity: 1},
            {item: 'Adaptador HDMI', category: 'Eletrônicos', weight: 0.05, quantity: 1},
            {item: 'Cabo USB-C', category: 'Eletrônicos', weight: 0.05, quantity: 1},
            {item: 'Cabo Lightning (iPhone)', category: 'Eletrônicos', weight: 0.05, quantity: 1},
            {item: 'Cabo Micro-USB', category: 'Eletrônicos', weight: 0.05, quantity: 1},
            {item: 'Adaptador USB-C para USB-A', category: 'Eletrônicos', weight: 0.02, quantity: 1},
            {item: 'Cabo Auxiliar (P2/AUX)', category: 'Eletrônicos', weight: 0.05, quantity: 1},
            {item: 'Adaptador Bluetooth', category: 'Eletrônicos', weight: 0.03, quantity: 1},
            {item: 'Leitor de Cartão SD/microSD', category: 'Eletrônicos', weight: 0.03, quantity: 1},
            {item: 'Pen Drive', category: 'Eletrônicos', weight: 0.01, quantity: 1},
            {item: 'HD Externo Portátil', category: 'Eletrônicos', weight: 0.15, quantity: 1},
            {item: 'SSD Externo', category: 'Eletrônicos', weight: 0.08, quantity: 1},
            {item: 'Case Protetor (Notebook)', category: 'Eletrônicos', weight: 0.3, quantity: 1},
            {item: 'Case Protetor (Tablet)', category: 'Eletrônicos', weight: 0.15, quantity: 1},
            {item: 'Película Protetora Extra', category: 'Eletrônicos', weight: 0.01, quantity: 1},
            {item: 'Estabilizador de Imagem (Gimbal)', category: 'Eletrônicos', weight: 0.5, quantity: 1},
            {item: 'Microfone de Lapela', category: 'Eletrônicos', weight: 0.05, quantity: 1},
            {item: 'Webcam Portátil', category: 'Eletrônicos', weight: 0.1, quantity: 1},
            {item: 'Ring Light Portátil', category: 'Eletrônicos', weight: 0.3, quantity: 1},
            {item: 'Controle Remoto Bluetooth', category: 'Eletrônicos', weight: 0.05, quantity: 1},
            {item: 'GPS Portátil', category: 'Eletrônicos', weight: 0.12, quantity: 1},
            {item: 'Rádio Portátil', category: 'Eletrônicos', weight: 0.2, quantity: 1},
            {item: 'Lanterna LED Potente', category: 'Eletrônicos', weight: 0.15, quantity: 1},
            {item: 'Lanterna de Cabeça (Headlamp)', category: 'Eletrônicos', weight: 0.1, quantity: 1},
            
            // Medicamentos e Saúde (18 itens)
            {item: 'Analgésico (Dipirona/Paracetamol)', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Anti-inflamatório', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Antialérgico', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Antitérmico', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Antigripal', category: 'Medicamentos', weight: 0.08, quantity: 1},
            {item: 'Remédio para Enjoo', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Antidiarreico', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Antiácido', category: 'Medicamentos', weight: 0.1, quantity: 1},
            {item: 'Remédios de Uso Contínuo', category: 'Medicamentos', weight: 0.1, quantity: 1},
            {item: 'Receitas Médicas', category: 'Medicamentos', weight: 0.02, quantity: 1},
            {item: 'Vitaminas/Suplementos', category: 'Medicamentos', weight: 0.15, quantity: 1},
            {item: 'Band-Aid/Curativos', category: 'Medicamentos', weight: 0.02, quantity: 1},
            {item: 'Termômetro Digital', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Álcool em Gel', category: 'Medicamentos', weight: 0.1, quantity: 1},
            {item: 'Máscara Descartável (PFF2/N95)', category: 'Medicamentos', weight: 0.05, quantity: 5},
            {item: 'Pomada para Queimadura', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Colírio', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Kit Primeiros Socorros', category: 'Medicamentos', weight: 0.3, quantity: 1},
            
            // MEDICAMENTOS EXTRAS (mais 30 itens para completar 50 total)
            {item: 'Soro Fisiológico 0,9%', category: 'Medicamentos', weight: 0.15, quantity: 2},
            {item: 'Gaze Estéril', category: 'Medicamentos', weight: 0.02, quantity: 5},
            {item: 'Esparadrapo', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Atadura Elástica', category: 'Medicamentos', weight: 0.08, quantity: 2},
            {item: 'Micropore', category: 'Medicamentos', weight: 0.03, quantity: 1},
            {item: 'Tesoura sem Ponta (Primeiros Socorros)', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Pinça', category: 'Medicamentos', weight: 0.03, quantity: 1},
            {item: 'Luvas Descartáveis', category: 'Medicamentos', weight: 0.05, quantity: 5},
            {item: 'Água Oxigenada 10 volumes', category: 'Medicamentos', weight: 0.1, quantity: 1},
            {item: 'Álcool 70%', category: 'Medicamentos', weight: 0.1, quantity: 1},
            {item: 'Mertiolate/Iodo', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Pomada Antibiótica', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Pomada Anti-inflamatória', category: 'Medicamentos', weight: 0.08, quantity: 1},
            {item: 'Spray Anestésico', category: 'Medicamentos', weight: 0.1, quantity: 1},
            {item: 'Sache de Gelo Instantâneo', category: 'Medicamentos', weight: 0.1, quantity: 2},
            {item: 'Protetor Labial Medicinal', category: 'Medicamentos', weight: 0.02, quantity: 1},
            {item: 'Pastilha para Garganta', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Xarope para Tosse', category: 'Medicamentos', weight: 0.15, quantity: 1},
            {item: 'Descongestionante Nasal', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Soro Nasal', category: 'Medicamentos', weight: 0.1, quantity: 1},
            {item: 'Probiótico', category: 'Medicamentos', weight: 0.08, quantity: 1},
            {item: 'Enzimas Digestivas', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Laxante', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Supositório/Laxativo Infantil', category: 'Medicamentos', weight: 0.03, quantity: 1},
            {item: 'Simeticona (Gases)', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Sal de Fruta/Eno', category: 'Medicamentos', weight: 0.08, quantity: 1},
            {item: 'Sais de Reidratação Oral', category: 'Medicamentos', weight: 0.05, quantity: 3},
            {item: 'Carvão Ativado', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Repelente em Spray', category: 'Medicamentos', weight: 0.12, quantity: 1},
            {item: 'Repelente em Loção', category: 'Medicamentos', weight: 0.15, quantity: 1},
            
            // Acessórios (20 itens)
            {item: 'Óculos de Sol', category: 'Acessórios', weight: 0.1, quantity: 1},
            {item: 'Óculos de Grau (Sobressalente)', category: 'Acessórios', weight: 0.1, quantity: 1},
            {item: 'Estojo de Óculos', category: 'Acessórios', weight: 0.05, quantity: 1},
            {item: 'Boné', category: 'Acessórios', weight: 0.12, quantity: 1},
            {item: 'Chapéu de Praia', category: 'Acessórios', weight: 0.2, quantity: 1},
            {item: 'Bolsa de Mão', category: 'Acessórios', weight: 0.4, quantity: 1},
            {item: 'Mochila/Backpack', category: 'Acessórios', weight: 0.6, quantity: 1},
            {item: 'Necessaire de Viagem', category: 'Acessórios', weight: 0.2, quantity: 1},
            {item: 'Mala de Mão', category: 'Acessórios', weight: 2.5, quantity: 1},
            {item: 'Mala Despachada', category: 'Acessórios', weight: 3.5, quantity: 1},
            {item: 'Organizador de Mala', category: 'Acessórios', weight: 0.15, quantity: 3},
            {item: 'Saco para Roupa Suja', category: 'Acessórios', weight: 0.05, quantity: 2},
            {item: 'Guarda-Chuva Compacto', category: 'Acessórios', weight: 0.3, quantity: 1},
            {item: 'Capa de Chuva', category: 'Acessórios', weight: 0.2, quantity: 1},
            {item: 'Cadeado para Mala', category: 'Acessórios', weight: 0.15, quantity: 2},
            {item: 'Etiqueta de Bagagem', category: 'Acessórios', weight: 0.02, quantity: 2},
            {item: 'Garrafa de Água Reutilizável', category: 'Acessórios', weight: 0.2, quantity: 1},
            {item: 'Squeeze/Cantil', category: 'Acessórios', weight: 0.15, quantity: 1},
            {item: 'Travesseiro de Pescoço', category: 'Acessórios', weight: 0.25, quantity: 1},
            {item: 'Máscara de Dormir', category: 'Acessórios', weight: 0.02, quantity: 1},
            
            // Documentos EXTRAS (mais 12 itens)
            {item: 'Carta de Motorista Internacional', category: 'Documentos', weight: 0.05, quantity: 1},
            {item: 'Comprovante de Residência', category: 'Documentos', weight: 0.02, quantity: 1},
            {item: 'Fotos 3x4', category: 'Documentos', weight: 0.01, quantity: 4},
            {item: 'Certidão de Nascimento/Casamento', category: 'Documentos', weight: 0.05, quantity: 1},
            {item: 'Cartão de Embarque (Digital)', category: 'Documentos', weight: 0.01, quantity: 1},
            {item: 'Confirmação de Reservas', category: 'Documentos', weight: 0.05, quantity: 1},
            {item: 'Contrato de Aluguel de Carro', category: 'Documentos', weight: 0.02, quantity: 1},
            {item: 'Cartão de Fidelidade (Companhias)', category: 'Documentos', weight: 0.01, quantity: 1},
            {item: 'Número de Emergência Anotado', category: 'Documentos', weight: 0.01, quantity: 1},
            {item: 'Procuração (se necessário)', category: 'Documentos', weight: 0.02, quantity: 1},
            {item: 'Carta Convite (Visto)', category: 'Documentos', weight: 0.05, quantity: 1},
            {item: 'Comprovante de Vacina Febre Amarela', category: 'Documentos', weight: 0.02, quantity: 1},
            
            // Roupas EXTRAS (mais 25 itens)
            {item: 'Cueca Boxer', category: 'Roupas', weight: 0.06, quantity: 5},
            {item: 'Calcinha Confortável', category: 'Roupas', weight: 0.05, quantity: 5},
            {item: 'Meia-calça', category: 'Roupas', weight: 0.08, quantity: 2},
            {item: 'Top Esportivo', category: 'Roupas', weight: 0.12, quantity: 2},
            {item: 'Shorts para Dormir', category: 'Roupas', weight: 0.15, quantity: 2},
            {item: 'Camisa de Botão', category: 'Roupas', weight: 0.28, quantity: 2},
            {item: 'Blusa de Lã', category: 'Roupas', weight: 0.45, quantity: 1},
            {item: 'Colete', category: 'Roupas', weight: 0.35, quantity: 1},
            {item: 'Calça de Moletom', category: 'Roupas', weight: 0.4, quantity: 1},
            {item: 'Jardineira/Macacão', category: 'Roupas', weight: 0.5, quantity: 1},
            {item: 'Kimono/Roupão de Praia', category: 'Roupas', weight: 0.3, quantity: 1},
            {item: 'Luvas (Frio)', category: 'Roupas', weight: 0.08, quantity: 1},
            {item: 'Cachecol', category: 'Roupas', weight: 0.15, quantity: 1},
            {item: 'Gorro/Touca', category: 'Roupas', weight: 0.08, quantity: 1},
            {item: 'Sapato Impermeável', category: 'Roupas', weight: 0.7, quantity: 1},
            {item: 'Sapatênis', category: 'Roupas', weight: 0.55, quantity: 1},
            {item: 'Alpargatas', category: 'Roupas', weight: 0.25, quantity: 1},
            {item: 'Botas de Trilha', category: 'Roupas', weight: 1.0, quantity: 1},
            {item: 'Chinelo de Quarto', category: 'Roupas', weight: 0.15, quantity: 1},
            {item: 'Meias de Compressão (Voo)', category: 'Roupas', weight: 0.1, quantity: 1},
            {item: 'Lenço/Bandana', category: 'Roupas', weight: 0.05, quantity: 2},
            {item: 'Gravata/Laço', category: 'Roupas', weight: 0.08, quantity: 1},
            {item: 'Suspensório', category: 'Roupas', weight: 0.1, quantity: 1},
            {item: 'Conjunto de Lingerie', category: 'Roupas', weight: 0.12, quantity: 2},
            {item: 'Roupa Térmica (Frio Extremo)', category: 'Roupas', weight: 0.35, quantity: 2},
            
            // ROUPAS EXTRAS ADICIONAIS (mais 40 itens para completar 100 total)
            {item: 'Camisa Polo Feminina', category: 'Roupas', weight: 0.22, quantity: 2},
            {item: 'Camisa Regata Esportiva', category: 'Roupas', weight: 0.14, quantity: 3},
            {item: 'Body/Maiô com Bojo', category: 'Roupas', weight: 0.18, quantity: 1},
            {item: 'Top Cropped', category: 'Roupas', weight: 0.1, quantity: 2},
            {item: 'Calça Cargo', category: 'Roupas', weight: 0.55, quantity: 1},
            {item: 'Calça Capri', category: 'Roupas', weight: 0.35, quantity: 1},
            {item: 'Bermuda Tactel', category: 'Roupas', weight: 0.2, quantity: 2},
            {item: 'Short Saia', category: 'Roupas', weight: 0.18, quantity: 1},
            {item: 'Saia Midi', category: 'Roupas', weight: 0.28, quantity: 1},
            {item: 'Saia Longa', category: 'Roupas', weight: 0.32, quantity: 1},
            {item: 'Macaquinho', category: 'Roupas', weight: 0.35, quantity: 1},
            {item: 'Macacão Longo', category: 'Roupas', weight: 0.48, quantity: 1},
            {item: 'Vestido Longo', category: 'Roupas', weight: 0.45, quantity: 1},
            {item: 'Vestido Midi', category: 'Roupas', weight: 0.35, quantity: 1},
            {item: 'Kimono Curto', category: 'Roupas', weight: 0.25, quantity: 1},
            {item: 'Cardigan Longo', category: 'Roupas', weight: 0.5, quantity: 1},
            {item: 'Poncho', category: 'Roupas', weight: 0.4, quantity: 1},
            {item: 'Capa de Chuva com Capuz', category: 'Roupas', weight: 0.35, quantity: 1},
            {item: 'Jaqueta Jeans', category: 'Roupas', weight: 0.7, quantity: 1},
            {item: 'Jaqueta de Couro', category: 'Roupas', weight: 0.9, quantity: 1},
            {item: 'Parka', category: 'Roupas', weight: 1.1, quantity: 1},
            {item: 'Trench Coat', category: 'Roupas', weight: 0.85, quantity: 1},
            {item: 'Sobretudo', category: 'Roupas', weight: 1.2, quantity: 1},
            {item: 'Xale/Echarpe', category: 'Roupas', weight: 0.2, quantity: 1},
            {item: 'Pashmina', category: 'Roupas', weight: 0.15, quantity: 1},
            {item: 'Turbante', category: 'Roupas', weight: 0.05, quantity: 1},
            {item: 'Tiara/Headband', category: 'Roupas', weight: 0.03, quantity: 2},
            {item: 'Viseira', category: 'Roupas', weight: 0.08, quantity: 1},
            {item: 'Gola Alta Destacável', category: 'Roupas', weight: 0.08, quantity: 1},
            {item: 'Polainas/Caneleira', category: 'Roupas', weight: 0.1, quantity: 1},
            {item: 'Joelheira', category: 'Roupas', weight: 0.12, quantity: 2},
            {item: 'Cotoveleira', category: 'Roupas', weight: 0.1, quantity: 2},
            {item: 'Munhequeira', category: 'Roupas', weight: 0.05, quantity: 2},
            {item: 'Faixa de Cabeça (Esporte)', category: 'Roupas', weight: 0.03, quantity: 1},
            {item: 'Camiseta UV (Proteção Solar)', category: 'Roupas', weight: 0.2, quantity: 2},
            {item: 'Wetsuit/Roupa de Neoprene', category: 'Roupas', weight: 1.5, quantity: 1},
            {item: 'Roupa de Ciclismo', category: 'Roupas', weight: 0.3, quantity: 1},
            {item: 'Roupa de Corrida', category: 'Roupas', weight: 0.25, quantity: 1},
            {item: 'Roupa de Yoga', category: 'Roupas', weight: 0.28, quantity: 1},
            {item: 'Short de Compressão', category: 'Roupas', weight: 0.15, quantity: 1},
            {item: 'Calça de Compressão', category: 'Roupas', weight: 0.25, quantity: 1},
            {item: 'Top de Compressão', category: 'Roupas', weight: 0.12, quantity: 1},
            {item: 'Camisa de Compressão', category: 'Roupas', weight: 0.18, quantity: 1},
            {item: 'Meias de Trekking', category: 'Roupas', weight: 0.12, quantity: 3},
            {item: 'Meias Térmicas', category: 'Roupas', weight: 0.15, quantity: 2},
            {item: 'Polaina de Neve', category: 'Roupas', weight: 0.2, quantity: 1},
            
            // Higiene EXTRAS (mais 17 itens)
            {item: 'Aparelho de Barbear Elétrico', category: 'Higiene', weight: 0.3, quantity: 1},
            {item: 'Pinça', category: 'Higiene', weight: 0.02, quantity: 1},
            {item: 'Cortador de Unha', category: 'Higiene', weight: 0.03, quantity: 1},
            {item: 'Lixa de Unha', category: 'Higiene', weight: 0.01, quantity: 1},
            {item: 'Removedor de Maquiagem', category: 'Higiene', weight: 0.12, quantity: 1},
            {item: 'Maquiagem (Base/Batom/Rímel)', category: 'Higiene', weight: 0.2, quantity: 1},
            {item: 'Perfume de Bolsa (Travel Size)', category: 'Higiene', weight: 0.08, quantity: 1},
            {item: 'Desodorante Antitranspirante', category: 'Higiene', weight: 0.12, quantity: 1},
            {item: 'Talco', category: 'Higiene', weight: 0.15, quantity: 1},
            {item: 'Loção Pós-Sol', category: 'Higiene', weight: 0.2, quantity: 1},
            {item: 'Óleo Corporal', category: 'Higiene', weight: 0.18, quantity: 1},
            {item: 'Esmalte de Unha', category: 'Higiene', weight: 0.05, quantity: 1},
            {item: 'Removedor de Esmalte', category: 'Higiene', weight: 0.08, quantity: 1},
            {item: 'Modelador de Cachos', category: 'Higiene', weight: 0.35, quantity: 1},
            {item: 'Gel/Pomada para Cabelo', category: 'Higiene', weight: 0.12, quantity: 1},
            {item: 'Shampoo Seco', category: 'Higiene', weight: 0.15, quantity: 1},
            {item: 'Lenço Demaquilante', category: 'Higiene', weight: 0.08, quantity: 1},
            
            // HIGIENE EXTRAS ADICIONAIS (mais 35 itens para completar 80 total)
            {item: 'Enxaguante Bucal Travel Size', category: 'Higiene', weight: 0.1, quantity: 1},
            {item: 'Fio Dental Portátil', category: 'Higiene', weight: 0.01, quantity: 1},
            {item: 'Bochecho Antisséptico', category: 'Higiene', weight: 0.12, quantity: 1},
            {item: 'Limpador de Língua', category: 'Higiene', weight: 0.02, quantity: 1},
            {item: 'Fita Dental', category: 'Higiene', weight: 0.02, quantity: 1},
            {item: 'Creme Dental Clareador', category: 'Higiene', weight: 0.1, quantity: 1},
            {item: 'Pente Fino (Piolho)', category: 'Higiene', weight: 0.05, quantity: 1},
            {item: 'Escova de Cabelo Dobrável', category: 'Higiene', weight: 0.12, quantity: 1},
            {item: 'Reparador de Pontas', category: 'Higiene', weight: 0.08, quantity: 1},
            {item: 'Sérum Capilar', category: 'Higiene', weight: 0.1, quantity: 1},
            {item: 'Máscara de Tratamento Capilar', category: 'Higiene', weight: 0.2, quantity: 1},
            {item: 'Ampola de Tratamento', category: 'Higiene', weight: 0.05, quantity: 3},
            {item: 'Tônico Capilar', category: 'Higiene', weight: 0.15, quantity: 1},
            {item: 'Spray Fixador de Cabelo', category: 'Higiene', weight: 0.2, quantity: 1},
            {item: 'Mousse para Cabelo', category: 'Higiene', weight: 0.15, quantity: 1},
            {item: 'Cera/Pomada Modeladora', category: 'Higiene', weight: 0.08, quantity: 1},
            {item: 'Touca de Banho', category: 'Higiene', weight: 0.03, quantity: 1},
            {item: 'Prendedor de Cabelo', category: 'Higiene', weight: 0.02, quantity: 5},
            {item: 'Rede para Cabelo', category: 'Higiene', weight: 0.02, quantity: 2},
            {item: 'Toalha de Microfibra (Cabelo)', category: 'Higiene', weight: 0.15, quantity: 1},
            {item: 'Difusor de Secador', category: 'Higiene', weight: 0.1, quantity: 1},
            {item: 'Máquina de Cortar Cabelo', category: 'Higiene', weight: 0.4, quantity: 1},
            {item: 'Tesoura de Cabelo', category: 'Higiene', weight: 0.08, quantity: 1},
            {item: 'Navalha de Barbear', category: 'Higiene', weight: 0.05, quantity: 1},
            {item: 'Pós-Barba/Aftershave', category: 'Higiene', weight: 0.15, quantity: 1},
            {item: 'Óleo de Barba', category: 'Higiene', weight: 0.08, quantity: 1},
            {item: 'Bálsamo para Barba', category: 'Higiene', weight: 0.1, quantity: 1},
            {item: 'Pente para Barba', category: 'Higiene', weight: 0.03, quantity: 1},
            {item: 'Escova para Barba', category: 'Higiene', weight: 0.05, quantity: 1},
            {item: 'Kit Manicure', category: 'Higiene', weight: 0.15, quantity: 1},
            {item: 'Alicate de Cutícula', category: 'Higiene', weight: 0.05, quantity: 1},
            {item: 'Palito de Unha', category: 'Higiene', weight: 0.01, quantity: 10},
            {item: 'Base para Unhas', category: 'Higiene', weight: 0.05, quantity: 1},
            {item: 'Top Coat (Finalizador Unha)', category: 'Higiene', weight: 0.05, quantity: 1},
            {item: 'Algodão/Disco de Algodão', category: 'Higiene', weight: 0.05, quantity: 1},
            {item: 'Hastes Flexíveis (Cotonete)', category: 'Higiene', weight: 0.05, quantity: 1},
            
            // Eletrônicos EXTRAS (mais 10 itens)
            {item: 'Tablet', category: 'Eletrônicos', weight: 0.5, quantity: 1},
            {item: 'E-reader (Kindle)', category: 'Eletrônicos', weight: 0.19, quantity: 1},
            {item: 'Cabo HDMI', category: 'Eletrônicos', weight: 0.08, quantity: 1},
            {item: 'Hub USB', category: 'Eletrônicos', weight: 0.06, quantity: 1},
            {item: 'Pen Drive', category: 'Eletrônicos', weight: 0.01, quantity: 1},
            {item: 'HD Externo', category: 'Eletrônicos', weight: 0.15, quantity: 1},
            {item: 'Caixa de Som Bluetooth', category: 'Eletrônicos', weight: 0.3, quantity: 1},
            {item: 'Tripé para Câmera/Celular', category: 'Eletrônicos', weight: 0.4, quantity: 1},
            {item: 'Drone', category: 'Eletrônicos', weight: 0.8, quantity: 1},
            {item: 'Console de Videogame Portátil', category: 'Eletrônicos', weight: 0.35, quantity: 1},
            
            // Medicamentos EXTRAS (mais 12 itens)
            {item: 'Antiespasmódico', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Laxante', category: 'Medicamentos', weight: 0.08, quantity: 1},
            {item: 'Descongestionante Nasal', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Pastilhas para Garganta', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Antiácido Efervescente', category: 'Medicamentos', weight: 0.12, quantity: 1},
            {item: 'Pomada Anti-inflamatória', category: 'Medicamentos', weight: 0.08, quantity: 1},
            {item: 'Gaze e Esparadrapo', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Atadura Elástica', category: 'Medicamentos', weight: 0.08, quantity: 1},
            {item: 'Soro Fisiológico', category: 'Medicamentos', weight: 0.1, quantity: 1},
            {item: 'Protetor Labial', category: 'Medicamentos', weight: 0.02, quantity: 1},
            {item: 'Comprimido para Mal de Altitude', category: 'Medicamentos', weight: 0.05, quantity: 1},
            {item: 'Pomada para Picada de Inseto', category: 'Medicamentos', weight: 0.05, quantity: 1},
            
            // Acessórios EXTRAS (mais 20 itens)
            {item: 'Relógio de Pulso', category: 'Acessórios', weight: 0.08, quantity: 1},
            {item: 'Pulseiras/Colares', category: 'Acessórios', weight: 0.05, quantity: 3},
            {item: 'Brincos', category: 'Acessórios', weight: 0.02, quantity: 3},
            {item: 'Carteira', category: 'Acessórios', weight: 0.15, quantity: 1},
            {item: 'Porta-Documentos', category: 'Acessórios', weight: 0.1, quantity: 1},
            {item: 'Pochete', category: 'Acessórios', weight: 0.15, quantity: 1},
            {item: 'Porta-Passaporte', category: 'Acessórios', weight: 0.05, quantity: 1},
            {item: 'Cinto Porta-Dinheiro', category: 'Acessórios', weight: 0.08, quantity: 1},
            {item: 'Saco Estanque (Praia)', category: 'Acessórios', weight: 0.1, quantity: 1},
            {item: 'Organizador de Cabos', category: 'Acessórios', weight: 0.05, quantity: 1},
            {item: 'Lenço de Papel', category: 'Acessórios', weight: 0.05, quantity: 3},
            {item: 'Lanche/Barra de Cereal', category: 'Acessórios', weight: 0.15, quantity: 5},
            {item: 'Chiclete/Bala', category: 'Acessórios', weight: 0.05, quantity: 1},
            {item: 'Protetor Auricular (Silicone)', category: 'Acessórios', weight: 0.01, quantity: 2},
            {item: 'Tapa-Olho para Dormir', category: 'Acessórios', weight: 0.02, quantity: 1},
            {item: 'Spray de Ambiente', category: 'Acessórios', weight: 0.1, quantity: 1},
            {item: 'Varal Portátil', category: 'Acessórios', weight: 0.08, quantity: 1},
            {item: 'Pregadores de Roupa', category: 'Acessórios', weight: 0.05, quantity: 6},
            {item: 'Saco de Compressão (Roupas)', category: 'Acessórios', weight: 0.05, quantity: 2},
            {item: 'Isqueiro/Fósforos', category: 'Acessórios', weight: 0.03, quantity: 1},
            
            // ACESSÓRIOS EXTRAS ADICIONAIS (mais 60 itens para completar 100 total)
            {item: 'Mochila Daypack (Passeio)', category: 'Acessórios', weight: 0.4, quantity: 1},
            {item: 'Bolsa Tiracolo', category: 'Acessórios', weight: 0.3, quantity: 1},
            {item: 'Bolsa de Cintura (Fanny Pack)', category: 'Acessórios', weight: 0.2, quantity: 1},
            {item: 'Mala de Bordo Rígida', category: 'Acessórios', weight: 3.0, quantity: 1},
            {item: 'Mochila de Trekking', category: 'Acessórios', weight: 1.5, quantity: 1},
            {item: 'Sacola de Praia', category: 'Acessórios', weight: 0.25, quantity: 1},
            {item: 'Nécessaire Grande', category: 'Acessórios', weight: 0.3, quantity: 1},
            {item: 'Nécessaire Pequena', category: 'Acessórios', weight: 0.15, quantity: 1},
            {item: 'Estojo para Joias', category: 'Acessórios', weight: 0.1, quantity: 1},
            {item: 'Porta-Relógio', category: 'Acessórios', weight: 0.08, quantity: 1},
            {item: 'Cinto de Couro', category: 'Acessórios', weight: 0.25, quantity: 1},
            {item: 'Cinto de Tecido', category: 'Acessórios', weight: 0.15, quantity: 1},
            {item: 'Suspensório Ajustável', category: 'Acessórios', weight: 0.12, quantity: 1},
            {item: 'Gravata Clássica', category: 'Acessórios', weight: 0.1, quantity: 2},
            {item: 'Gravata Borboleta', category: 'Acessórios', weight: 0.05, quantity: 1},
            {item: 'Lenço de Bolso (Pocket Square)', category: 'Acessórios', weight: 0.02, quantity: 2},
            {item: 'Abotoaduras', category: 'Acessórios', weight: 0.03, quantity: 1},
            {item: 'Clip de Gravata', category: 'Acessórios', weight: 0.02, quantity: 1},
            {item: 'Anel', category: 'Acessórios', weight: 0.01, quantity: 3},
            {item: 'Piercing Extra', category: 'Acessórios', weight: 0.01, quantity: 2},
            {item: 'Corrente/Cordão', category: 'Acessórios', weight: 0.05, quantity: 1},
            {item: 'Tornozeleira', category: 'Acessórios', weight: 0.02, quantity: 1},
            {item: 'Prendedor de Cabelo Decorativo', category: 'Acessórios', weight: 0.05, quantity: 3},
            {item: 'Tiara com Strass', category: 'Acessórios', weight: 0.08, quantity: 1},
            {item: 'Scrunchie (Elástico Volumoso)', category: 'Acessórios', weight: 0.02, quantity: 5},
            {item: 'Óculos de Natação', category: 'Acessórios', weight: 0.1, quantity: 1},
            {item: 'Touca de Natação', category: 'Acessórios', weight: 0.05, quantity: 1},
            {item: 'Óculos de Mergulho', category: 'Acessórios', weight: 0.3, quantity: 1},
            {item: 'Óculos de Ski/Snowboard', category: 'Acessórios', weight: 0.25, quantity: 1},
            {item: 'Óculos de Proteção (Esporte)', category: 'Acessórios', weight: 0.12, quantity: 1},
            {item: 'Óculos de Leitura (+1.0 a +3.0)', category: 'Acessórios', weight: 0.08, quantity: 1},
            {item: 'Cordinha para Óculos', category: 'Acessórios', weight: 0.02, quantity: 1},
            {item: 'Kit Limpeza de Óculos', category: 'Acessórios', weight: 0.05, quantity: 1},
            {item: 'Pano de Microfibra (Óculos)', category: 'Acessórios', weight: 0.01, quantity: 2},
            {item: 'Chapéu Panamá', category: 'Acessórios', weight: 0.18, quantity: 1},
            {item: 'Chapéu Bucket', category: 'Acessórios', weight: 0.15, quantity: 1},
            {item: 'Chapéu Fedora', category: 'Acessórios', weight: 0.2, quantity: 1},
            {item: 'Boina', category: 'Acessórios', weight: 0.1, quantity: 1},
            {item: 'Gorro de Lã', category: 'Acessórios', weight: 0.12, quantity: 1},
            {item: 'Cachecol', category: 'Acessórios', weight: 0.25, quantity: 1},
            {item: 'Luvas de Lã', category: 'Acessórios', weight: 0.15, quantity: 1},
            {item: 'Luvas de Couro', category: 'Acessórios', weight: 0.2, quantity: 1},
            {item: 'Luvas Térmicas (Ski)', category: 'Acessórios', weight: 0.3, quantity: 1},
            {item: 'Luvas Touch Screen', category: 'Acessórios', weight: 0.1, quantity: 1},
            {item: 'Aquecedor de Mãos Descartável', category: 'Acessórios', weight: 0.05, quantity: 4},
            {item: 'Protetor de Pescoço (Neck Gaiter)', category: 'Acessórios', weight: 0.08, quantity: 1},
            {item: 'Balaclava', category: 'Acessórios', weight: 0.1, quantity: 1},
            {item: 'Joelheira/Cotoveleira', category: 'Acessórios', weight: 0.15, quantity: 2},
            {item: 'Munhequeira', category: 'Acessórios', weight: 0.05, quantity: 2},
            {item: 'Cinta Lombar', category: 'Acessórios', weight: 0.2, quantity: 1},
            {item: 'Faixa Elástica (Exercício)', category: 'Acessórios', weight: 0.1, quantity: 1},
            {item: 'Tapete de Yoga Dobrável', category: 'Acessórios', weight: 0.5, quantity: 1},
            {item: 'Toalha de Yoga/Esporte', category: 'Acessórios', weight: 0.2, quantity: 1},
            {item: 'Squeeze com Infusor', category: 'Acessórios', weight: 0.25, quantity: 1},
            {item: 'Caneca Térmica', category: 'Acessórios', weight: 0.3, quantity: 1},
            {item: 'Thermos/Garrafa Térmica Pequena', category: 'Acessórios', weight: 0.4, quantity: 1},
            {item: 'Porta-Comprimidos Semanal', category: 'Acessórios', weight: 0.08, quantity: 1},
            {item: 'Porta-Cartão de Visita', category: 'Acessórios', weight: 0.05, quantity: 1},
            {item: 'RFID Blocker (Cartões)', category: 'Acessórios', weight: 0.02, quantity: 3},
            
            // Diversos (mais 20 itens = 30 total)
            {item: 'Guia/Mapa da Cidade', category: 'Diversos', weight: 0.2, quantity: 1},
            {item: 'Caderno/Diário de Viagem', category: 'Diversos', weight: 0.3, quantity: 1},
            {item: 'Caneta/Lápis', category: 'Diversos', weight: 0.02, quantity: 2},
            {item: 'Livro/Revista', category: 'Diversos', weight: 0.4, quantity: 2},
            {item: 'Baralho/Jogos de Tabuleiro', category: 'Diversos', weight: 0.2, quantity: 1},
            {item: 'Snacks/Petiscos para Viagem', category: 'Diversos', weight: 0.3, quantity: 1},
            {item: 'Saco/Sacola Reutilizável', category: 'Diversos', weight: 0.05, quantity: 2},
            {item: 'Lanterna', category: 'Diversos', weight: 0.1, quantity: 1},
            {item: 'Multitool/Canivete Suíço', category: 'Diversos', weight: 0.15, quantity: 1},
            {item: 'Almofada Inflável', category: 'Diversos', weight: 0.2, quantity: 1},
            {item: 'Corda/Barbante', category: 'Diversos', weight: 0.1, quantity: 1},
            {item: 'Fita Adesiva', category: 'Diversos', weight: 0.05, quantity: 1},
            {item: 'Tesoura Pequena', category: 'Diversos', weight: 0.05, quantity: 1},
            {item: 'Adesivo Decorativo/Patches', category: 'Diversos', weight: 0.02, quantity: 5},
            {item: 'Marcador de Página', category: 'Diversos', weight: 0.01, quantity: 2},
            {item: 'Post-it/Bloco de Notas', category: 'Diversos', weight: 0.03, quantity: 1},
            {item: 'Binóculo', category: 'Diversos', weight: 0.5, quantity: 1},
            {item: 'Bússola', category: 'Diversos', weight: 0.08, quantity: 1},
            {item: 'Apito de Emergência', category: 'Diversos', weight: 0.02, quantity: 1},
            {item: 'Sacos Ziplock (Diversos Tamanhos)', category: 'Diversos', weight: 0.05, quantity: 5},
            {item: 'Ímã de Geladeira (Souvenir)', category: 'Diversos', weight: 0.05, quantity: 3},
            {item: 'Cartão Postal', category: 'Diversos', weight: 0.02, quantity: 10},
            {item: 'Presente/Lembrancinha', category: 'Diversos', weight: 0.3, quantity: 3},
            {item: 'Papel Alumínio', category: 'Diversos', weight: 0.08, quantity: 1},
            {item: 'Saco de Lixo', category: 'Diversos', weight: 0.03, quantity: 5},
            {item: 'Grampo de Cabelo/Presilha', category: 'Diversos', weight: 0.02, quantity: 5},
            {item: 'Elástico de Cabelo', category: 'Diversos', weight: 0.01, quantity: 10},
            {item: 'Papel Filme/Plástico', category: 'Diversos', weight: 0.05, quantity: 1},
            {item: 'Filme para Câmera Instantânea', category: 'Diversos', weight: 0.1, quantity: 2},
            {item: 'Bateria AAA Extra', category: 'Diversos', weight: 0.05, quantity: 4},
            {item: 'Bateria AA Extra', category: 'Diversos', weight: 0.05, quantity: 4},
            {item: 'Pilha Botão (Relógio)', category: 'Diversos', weight: 0.01, quantity: 2},
            {item: 'Adaptador de Áudio 3.5mm', category: 'Diversos', weight: 0.01, quantity: 1},
            {item: 'Etiqueta Adesiva', category: 'Diversos', weight: 0.02, quantity: 1},
            {item: 'Marcador Permanente', category: 'Diversos', weight: 0.02, quantity: 2},
            {item: 'Clips/Prendedor de Papel', category: 'Diversos', weight: 0.01, quantity: 10},
            {item: 'Grampeador Mini', category: 'Diversos', weight: 0.05, quantity: 1},
            {item: 'Cola Bastão', category: 'Diversos', weight: 0.03, quantity: 1},
            {item: 'Régua Pequena', category: 'Diversos', weight: 0.02, quantity: 1},
            {item: 'Calculadora', category: 'Diversos', weight: 0.08, quantity: 1},
            {item: 'Agenda/Planner', category: 'Diversos', weight: 0.25, quantity: 1},
            {item: 'Calendário de Bolso', category: 'Diversos', weight: 0.02, quantity: 1},
            {item: 'Apontador de Lápis', category: 'Diversos', weight: 0.02, quantity: 1},
            {item: 'Borracha', category: 'Diversos', weight: 0.01, quantity: 2},
            {item: 'Lápis de Cor/Canetinha', category: 'Diversos', weight: 0.1, quantity: 1},
            {item: 'Quebra-Cabeça Portátil', category: 'Diversos', weight: 0.15, quantity: 1},
            {item: 'Cubo Mágico', category: 'Diversos', weight: 0.08, quantity: 1},
            {item: 'Ioiô', category: 'Diversos', weight: 0.05, quantity: 1},
            {item: 'Pipa Compacta', category: 'Diversos', weight: 0.08, quantity: 1},
            {item: 'Bola Inflável (Praia)', category: 'Diversos', weight: 0.1, quantity: 1},
            {item: 'Frisbee', category: 'Diversos', weight: 0.15, quantity: 1},
            {item: 'Raquete de Frescobol', category: 'Diversos', weight: 0.3, quantity: 2},
            {item: 'Boia de Braço', category: 'Diversos', weight: 0.08, quantity: 2},
            {item: 'Boia Inflável', category: 'Diversos', weight: 0.15, quantity: 1},
            {item: 'Snorkel e Máscara', category: 'Diversos', weight: 0.4, quantity: 1},
            {item: 'Nadadeiras', category: 'Diversos', weight: 0.5, quantity: 1},
            {item: 'Touca de Natação', category: 'Diversos', weight: 0.05, quantity: 1},
            {item: 'Óculos de Natação', category: 'Diversos', weight: 0.05, quantity: 1},
            {item: 'Protetor de Ouvido (Natação)', category: 'Diversos', weight: 0.02, quantity: 1},
            {item: 'Clipe de Nariz (Natação)', category: 'Diversos', weight: 0.01, quantity: 1},
            {item: 'Prancha de Natação', category: 'Diversos', weight: 0.3, quantity: 1},
            {item: 'Colete Salva-Vidas', category: 'Diversos', weight: 0.6, quantity: 1},
            {item: 'Cooler Térmico Pequeno', category: 'Diversos', weight: 0.5, quantity: 1},
            {item: 'Bolsa Térmica', category: 'Diversos', weight: 0.2, quantity: 1},
            {item: 'Gelo Reutilizável', category: 'Diversos', weight: 0.15, quantity: 3},
            {item: 'Caneca Térmica', category: 'Diversos', weight: 0.25, quantity: 1},
            {item: 'Garrafa Térmica', category: 'Diversos', weight: 0.4, quantity: 1},
            {item: 'Chopeira Portátil', category: 'Diversos', weight: 1.2, quantity: 1},
            {item: 'Abridor de Garrafa', category: 'Diversos', weight: 0.05, quantity: 1},
            {item: 'Saca-Rolhas', category: 'Diversos', weight: 0.08, quantity: 1},
            {item: 'Canudo Reutilizável', category: 'Diversos', weight: 0.02, quantity: 2},
            {item: 'Talheres de Plástico', category: 'Diversos', weight: 0.05, quantity: 10},
            {item: 'Talheres Reutilizáveis (Kit)', category: 'Diversos', weight: 0.15, quantity: 1},
            {item: 'Prato de Plástico', category: 'Diversos', weight: 0.05, quantity: 5},
            {item: 'Copo de Plástico', category: 'Diversos', weight: 0.03, quantity: 10},
            {item: 'Guardanapo de Papel', category: 'Diversos', weight: 0.08, quantity: 1},
            {item: 'Papel Toalha', category: 'Diversos', weight: 0.15, quantity: 1},
            {item: 'Detergente Biodegradável', category: 'Diversos', weight: 0.2, quantity: 1},
            {item: 'Esponja de Lavar Louça', category: 'Diversos', weight: 0.03, quantity: 2},
            {item: 'Pano de Prato', category: 'Diversos', weight: 0.1, quantity: 2},
            {item: 'Luva de Lavar Louça', category: 'Diversos', weight: 0.08, quantity: 1},
            {item: 'Escorredor de Louça Dobrável', category: 'Diversos', weight: 0.3, quantity: 1},
            {item: 'Tábua de Corte Portátil', category: 'Diversos', weight: 0.2, quantity: 1},
            {item: 'Faca de Cozinha', category: 'Diversos', weight: 0.15, quantity: 1},
            {item: 'Descascador de Legumes', category: 'Diversos', weight: 0.05, quantity: 1},
            {item: 'Abridor de Lata', category: 'Diversos', weight: 0.05, quantity: 1},
            {item: 'Ralador Portátil', category: 'Diversos', weight: 0.1, quantity: 1},
            {item: 'Espremedor de Limão', category: 'Diversos', weight: 0.08, quantity: 1},
            {item: 'Peneira Pequena', category: 'Diversos', weight: 0.08, quantity: 1},
            {item: 'Pote Hermético (Pequeno)', category: 'Diversos', weight: 0.1, quantity: 3},
            {item: 'Pote Hermético (Médio)', category: 'Diversos', weight: 0.15, quantity: 2},
            {item: 'Pote Hermético (Grande)', category: 'Diversos', weight: 0.2, quantity: 1},
            {item: 'Marmita Térmica', category: 'Diversos', weight: 0.4, quantity: 1},
            {item: 'Tupperware Variados', category: 'Diversos', weight: 0.3, quantity: 3},
            {item: 'Saco para Gelo', category: 'Diversos', weight: 0.05, quantity: 5},
            {item: 'Forma de Gelo Dobrável', category: 'Diversos', weight: 0.1, quantity: 1},
        ];
        
        // Gerenciamento de catálogo personalizado
        function getCustomCatalog() {
            if (!window.state?.appData?.settings) return [];
            return window.state.appData.settings.customChecklistCatalog || [];
        }
        
        function saveCustomCatalog(catalog) {
            if (!window.state?.appData?.settings) return;
            window.state.appData.settings.customChecklistCatalog = catalog;
            if (typeof storage !== 'undefined' && typeof storage.saveData === 'function') {
                storage.saveData(window.state.appData).catch(e => console.error('saveCustomCatalog', e));
            }
        }
        
        function getDeletedSuggestions() {
            if (!window.state?.appData?.settings) return [];
            return window.state.appData.settings.deletedSuggestions || [];
        }
        
        function saveDeletedSuggestions(deleted) {
            if (!window.state?.appData?.settings) return;
            window.state.appData.settings.deletedSuggestions = deleted;
            if (typeof storage !== 'undefined' && typeof storage.saveData === 'function') {
                storage.saveData(window.state.appData).catch(e => console.error('saveDeletedSuggestions', e));
            }
        }
        
        function deleteSuggestionPermanently(itemName, category) {
            const deleted = getDeletedSuggestions();
            const key = `${category}::${itemName}`;
            if (!deleted.includes(key)) {
                deleted.push(key);
                saveDeletedSuggestions(deleted);
            }
            renderChecklistSuggestionsPanel();
            showToast('Sugestão removida permanentemente', 'bg-red-600');
        }
        
        function isSuggestionDeleted(itemName, category) {
            const deleted = getDeletedSuggestions();
            const key = `${category}::${itemName}`;
            return deleted.includes(key);
        }
        
        function addCustomSuggestion(item, category, weight, quantity) {
            const catalog = getCustomCatalog();
            catalog.push({item, category, weight, quantity, custom: true});
            saveCustomCatalog(catalog);
            renderChecklistSuggestionsPanel();
        }
        
        function removeCustomSuggestion(index) {
            const catalog = getCustomCatalog();
            catalog.splice(index, 1);
            saveCustomCatalog(catalog);
            renderChecklistSuggestionsPanel();
        }
        
        function renderChecklistSuggestionsPanel() {
            const container = q('tp-checklist-suggestions-container');
            if (!container) return;
            
            // Filtrar itens deletados
            const allSuggestions = [...DEFAULT_CHECKLIST_CATALOG, ...getCustomCatalog()]
                .filter(s => !isSuggestionDeleted(s.item, s.category));
            
            const categories = [...new Set(allSuggestions.map(s => s.category))];
            
            let html = '';
            let totalItems = 0;
            
            categories.forEach(cat => {
                const items = allSuggestions.filter(s => s.category === cat);
                totalItems += items.length;
                
                html += `<div class="mb-4 bg-white rounded-lg p-3 border border-purple-200">
                    <h6 class="text-xs font-bold text-purple-800 mb-2 flex items-center justify-between">
                        <span class="flex items-center gap-1">
                            <span class="material-symbols-outlined" style="font-size:14px">category</span>${cat} (${items.length})
                        </span>
                        <button class="add-custom-suggestion-btn text-xs px-2 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center gap-1" data-category="${cat}">
                            <span class="material-symbols-outlined" style="font-size:12px">add</span>
                            Nova Sugestão
                        </button>
                    </h6>
                    <div class="grid grid-cols-1 gap-1">`;
                items.forEach(s => {
                    const isCustom = s.custom ? ' bg-yellow-100 border-yellow-400' : ' bg-white border-purple-200';
                    html += `<div class="flex items-center gap-1">
                        <button class="checklist-suggestion flex-1 text-xs px-2 py-1.5 rounded border${isCustom} hover:bg-purple-100 text-left flex items-center gap-1" 
                            data-item="${escapeHtml(s.item)}" data-category="${escapeHtml(s.category)}" data-weight="${s.weight}" data-quantity="${s.quantity}">
                            <span class="material-symbols-outlined" style="font-size:14px">add_circle</span>
                            <span class="truncate flex-1">${escapeHtml(s.item)} <span class="text-gray-500">(${s.quantity}x, ${s.weight}kg)</span></span>
                        </button>
                        <button class="delete-suggestion-btn px-2 py-1.5 rounded bg-red-50 hover:bg-red-100 text-red-700 border border-red-200" 
                            data-item="${escapeHtml(s.item)}" data-category="${escapeHtml(s.category)}" title="Excluir permanentemente">
                            <span class="material-symbols-outlined" style="font-size:16px">delete</span>
                        </button>
                    </div>`;
                });
                html += `</div></div>`;
            });
            
            container.innerHTML = html;
            
            // Atualizar título do painel com contagem
            const panelTitle = document.querySelector('#tp-checklist-suggestions-panel h5');
            if (panelTitle) {
                panelTitle.innerHTML = `<span class="material-symbols-outlined">auto_awesome</span> Catálogo de Sugestões (${totalItems} itens)`;
            }
            
            // Adicionar event listeners para os botões de adicionar sugestão personalizada
            document.querySelectorAll('.add-custom-suggestion-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const category = btn.dataset.category;
                    showCustomSuggestionForm(category);
                });
            });
            
            // Adicionar event listeners para os botões de exclusão
            document.querySelectorAll('.delete-suggestion-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const item = btn.dataset.item;
                    const category = btn.dataset.category;
                    
                    if (confirm(`Tem certeza que deseja excluir permanentemente "${item}" do catálogo?\n\nEsta ação não pode ser desfeita.`)) {
                        deleteSuggestionPermanently(item, category);
                    }
                });
            });
        }
        
        // Modal/Form para adicionar sugestão personalizada
        function showCustomSuggestionForm(category) {
            const form = q('tp-custom-suggestion-form');
            const categoryInput = q('tp-custom-suggestion-category');
            
            if (!form || !categoryInput) return;
            
            // Resetar form
            q('tp-custom-suggestion-item').value = '';
            categoryInput.value = category || 'Documentos';
            q('tp-custom-suggestion-weight').value = '0.1';
            q('tp-custom-suggestion-quantity').value = '1';
            
            // Mostrar form
            form.classList.remove('hidden');
            q('tp-custom-suggestion-item').focus();
        }
        
        function hideCustomSuggestionForm() {
            const form = q('tp-custom-suggestion-form');
            if (form) form.classList.add('hidden');
        }
        
        function saveCustomSuggestion() {
            const item = q('tp-custom-suggestion-item')?.value?.trim();
            const category = q('tp-custom-suggestion-category')?.value;
            const weight = parseFloat(q('tp-custom-suggestion-weight')?.value) || 0.1;
            const quantity = parseInt(q('tp-custom-suggestion-quantity')?.value) || 1;
            
            if (!item) {
                showToast('Digite o nome do item', 'bg-yellow-600');
                return;
            }
            
            // Verificar duplicata
            const allSuggestions = [...DEFAULT_CHECKLIST_CATALOG, ...getCustomCatalog()];
            const exists = allSuggestions.find(s => s.item.toLowerCase() === item.toLowerCase() && s.category === category);
            
            if (exists) {
                showToast('Item já existe no catálogo', 'bg-yellow-600');
                return;
            }
            
            addCustomSuggestion(item, category, weight, quantity);
            hideCustomSuggestionForm();
            showToast('Sugestão personalizada adicionada!', 'bg-green-600');
        }
        
        const suggestionsBtn = q('tp-checklist-suggestions');
        const suggestionsPanel = q('tp-checklist-suggestions-panel');
        const closeSuggestionsBtn = q('tp-close-suggestions');
        
        if (suggestionsBtn) {
            suggestionsBtn.addEventListener('click', () => {
                if (suggestionsPanel) {
                    suggestionsPanel.classList.toggle('hidden');
                    // Renderizar sugestões quando abrir o painel
                    if (!suggestionsPanel.classList.contains('hidden')) {
                        renderChecklistSuggestionsPanel();
                    }
                }
            });
        }
        
        // ========== SISTEMA DE GRUPOS SALVOS DE CHECKLIST ==========
        
        // Gerenciamento de grupos salvos
        function getSavedGroups() {
            if (!window.state?.appData?.settings) return [];
            return window.state.appData.settings.checklistGroups || [];
        }
        
        function saveSavedGroups(groups) {
            if (!window.state?.appData?.settings) return;
            window.state.appData.settings.checklistGroups = groups;
            if (typeof storage !== 'undefined' && typeof storage.saveData === 'function') {
                storage.saveData(window.state.appData).catch(e => console.error('saveSavedGroups', e));
            }
        }
        
        // Abrir modal para salvar grupo atual
        function openSaveGroupModal() {
            const planId = q('travel-plan-id')?.value;
            if (!planId) {
                showToast('Selecione um plano de viagem primeiro', 'bg-yellow-600');
                return;
            }
            
            const plan = window.state.appData.plans.find(p => p.id === planId);
            if (!plan || !plan.checklist || plan.checklist.length === 0) {
                showToast('Nenhum item no checklist para salvar', 'bg-yellow-600');
                return;
            }
            
            const modal = q('tp-save-group-modal');
            if (!modal) return;
            
            // Atualizar contador de itens
            const itemsCount = q('tp-group-items-count');
            if (itemsCount) {
                itemsCount.textContent = `${plan.checklist.length} ${plan.checklist.length === 1 ? 'item' : 'itens'}`;
            }
            
            // Limpar campos
            q('tp-group-name').value = '';
            q('tp-group-description').value = '';
            
            modal.classList.remove('hidden');
            q('tp-group-name').focus();
        }
        
        function closeSaveGroupModal() {
            const modal = q('tp-save-group-modal');
            if (modal) modal.classList.add('hidden');
        }
        
        function confirmSaveGroup() {
            const name = q('tp-group-name')?.value?.trim();
            const description = q('tp-group-description')?.value?.trim() || '';
            
            if (!name) {
                showToast('Digite um nome para o grupo', 'bg-yellow-600');
                return;
            }
            
            const planId = q('travel-plan-id')?.value;
            const plan = window.state.appData.plans.find(p => p.id === planId);
            
            if (!plan || !plan.checklist || plan.checklist.length === 0) {
                showToast('Nenhum item no checklist', 'bg-yellow-600');
                return;
            }
            
            // Criar cópia dos itens do checklist (sem IDs para evitar conflitos)
            const items = plan.checklist.map(item => ({
                item: item.item,
                category: item.category,
                quantity: item.quantity,
                weight: item.weight,
                ready: false,
                packed: false
            }));
            
            const groups = getSavedGroups();
            const newGroup = {
                id: Date.now().toString(),
                name: name,
                description: description,
                items: items,
                createdAt: new Date().toISOString(),
                itemCount: items.length
            };
            
            groups.push(newGroup);
            saveSavedGroups(groups);
            
            closeSaveGroupModal();
            renderSavedGroupsPanel();
            showToast(`Grupo "${name}" salvo com sucesso!`, 'bg-green-600');
        }
        
        // Carregar grupo no checklist atual
        function loadGroup(groupId) {
            const planId = q('travel-plan-id')?.value;
            if (!planId) {
                showToast('Selecione um plano de viagem primeiro', 'bg-yellow-600');
                return;
            }
            
            const groups = getSavedGroups();
            const group = groups.find(g => g.id === groupId);
            
            if (!group) {
                showToast('Grupo não encontrado', 'bg-red-600');
                return;
            }
            
            const plan = window.state.appData.plans.find(p => p.id === planId);
            if (!plan) return;
            
            // Confirmar se quer sobrescrever ou adicionar
            const hasItems = plan.checklist && plan.checklist.length > 0;
            let action = 'add';
            
            if (hasItems) {
                const choice = confirm(
                    `O checklist atual já possui ${plan.checklist.length} ${plan.checklist.length === 1 ? 'item' : 'itens'}.\n\n` +
                    `Clique OK para ADICIONAR os ${group.itemCount} itens do grupo "${group.name}".\n` +
                    `Clique CANCELAR para SUBSTITUIR completamente o checklist atual.`
                );
                action = choice ? 'add' : 'replace';
            }
            
            // Criar novos itens com IDs únicos
            const newItems = group.items.map(item => ({
                ...item,
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                ready: false,
                packed: false
            }));
            
            if (action === 'replace') {
                plan.checklist = newItems;
            } else {
                plan.checklist = [...(plan.checklist || []), ...newItems];
            }
            
            if (typeof storage !== 'undefined' && typeof storage.saveData === 'function') {
                storage.saveData(window.state.appData).catch(e => console.error('loadGroup', e));
            }
            
            loadChecklist();
            showToast(`Grupo "${group.name}" carregado (${newItems.length} itens)!`, 'bg-green-600');
        }
        
        // Deletar grupo salvo
        function deleteGroup(groupId) {
            const groups = getSavedGroups();
            const group = groups.find(g => g.id === groupId);
            
            if (!group) return;
            
            if (!confirm(`Tem certeza que deseja excluir o grupo "${group.name}"?\n\nEsta ação não pode ser desfeita.`)) {
                return;
            }
            
            const updatedGroups = groups.filter(g => g.id !== groupId);
            saveSavedGroups(updatedGroups);
            renderSavedGroupsPanel();
            showToast(`Grupo "${group.name}" excluído`, 'bg-red-600');
        }
        
        // Renderizar painel de grupos salvos
        function renderSavedGroupsPanel() {
            const container = q('tp-saved-groups-container');
            if (!container) return;
            
            const groups = getSavedGroups();
            
            if (groups.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Nenhum grupo salvo ainda</p>';
                return;
            }
            
            let html = '';
            groups.forEach(group => {
                const date = new Date(group.createdAt).toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                
                html += `
                    <div class="bg-white rounded-lg border border-teal-200 p-3 mb-2 hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <h6 class="font-bold text-teal-900 flex items-center gap-2">
                                    <span class="material-symbols-outlined" style="font-size:18px">folder</span>
                                    ${escapeHtml(group.name)}
                                </h6>
                                ${group.description ? `<p class="text-xs text-gray-600 mt-1">${escapeHtml(group.description)}</p>` : ''}
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-3 text-xs text-gray-600 mb-3">
                            <span class="flex items-center gap-1">
                                <span class="material-symbols-outlined" style="font-size:14px">checklist</span>
                                ${group.itemCount} ${group.itemCount === 1 ? 'item' : 'itens'}
                            </span>
                            <span class="flex items-center gap-1">
                                <span class="material-symbols-outlined" style="font-size:14px">calendar_today</span>
                                ${date}
                            </span>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="loadGroup('${group.id}')" class="flex-1 px-3 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 text-sm font-semibold flex items-center justify-center gap-1">
                                <span class="material-symbols-outlined" style="font-size:16px">download</span>
                                Carregar Grupo
                            </button>
                            <button onclick="deleteGroup('${group.id}')" class="px-3 py-2 bg-red-50 text-red-700 rounded hover:bg-red-100 border border-red-200" title="Excluir grupo">
                                <span class="material-symbols-outlined" style="font-size:16px">delete</span>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Event listeners para o painel de grupos
        const groupsBtn = q('tp-checklist-groups');
        const groupsPanel = q('tp-checklist-groups-panel');
        const closeGroupsBtn = q('tp-close-groups');
        const saveCurrentGroupBtn = q('tp-save-current-group');
        
        if (groupsBtn) {
            groupsBtn.addEventListener('click', () => {
                if (groupsPanel) {
                    groupsPanel.classList.toggle('hidden');
                    if (!groupsPanel.classList.contains('hidden')) {
                        renderSavedGroupsPanel();
                    }
                }
            });
        }
        
        if (closeGroupsBtn) {
            closeGroupsBtn.addEventListener('click', () => {
                if (groupsPanel) groupsPanel.classList.add('hidden');
            });
        }
        
        if (saveCurrentGroupBtn) {
            saveCurrentGroupBtn.addEventListener('click', openSaveGroupModal);
        }
        
        // ========== FIM DO SISTEMA DE GRUPOS SALVOS ==========

        
        if (closeSuggestionsBtn) {
            closeSuggestionsBtn.addEventListener('click', () => {
                if (suggestionsPanel) {
                    suggestionsPanel.classList.add('hidden');
                }
            });
        }
        
        // Event delegation para todos os botões de sugestão
        document.addEventListener('click', async function(e) {
            if (e.target.classList.contains('checklist-suggestion') || e.target.closest('.checklist-suggestion')) {
                const btn = e.target.classList.contains('checklist-suggestion') ? e.target : e.target.closest('.checklist-suggestion');
                
                const item = btn.dataset.item;
                const category = btn.dataset.category;
                const weight = parseFloat(btn.dataset.weight) || 0;
                const quantity = parseInt(btn.dataset.quantity) || 1;
                
                // Adicionar item diretamente ao checklist
                try {
                    const pid = q('tp-id')?.value;
                    if (!pid) {
                        showToast('Salve o plano antes de adicionar itens', 'bg-yellow-600');
                        return;
                    }
                    
                    const plans = loadTravelPlans();
                    const plan = plans.find(p => p.id === pid);
                    if (!plan) return;
                    
                    // Verificar se item já existe
                    const exists = (plan.checklist || []).find(c => c.item === item);
                    if (exists) {
                        showToast(`"${item}" já está no checklist`, 'bg-yellow-600');
                        return;
                    }
                    
                    const obj = {
                        id: 'chk-' + Math.random().toString(36).slice(2, 9),
                        item: item,
                        category: category,
                        quantity: quantity,
                        weight: weight,
                        packed: false
                    };
                    
                    plan.checklist = plan.checklist || [];
                    plan.checklist.push(obj);
                    
                    await saveTravelPlans(plans);
                    
                    // Feedback visual no botão
                    btn.innerHTML = '✓ Adicionado';
                    btn.classList.add('bg-green-100', 'text-green-800', 'font-semibold');
                    btn.disabled = true;
                    
                    setTimeout(() => {
                        btn.innerHTML = btn.dataset.item;
                        btn.classList.remove('bg-green-100', 'text-green-800', 'font-semibold');
                        btn.disabled = false;
                    }, 2000);
                    
                    renderPlanDetails(plan.id);
                    showToast(`"${item}" adicionado ao checklist`, 'bg-green-600');
                    
                } catch(e) {
                    console.error('Erro ao adicionar sugestão:', e);
                    showToast('Erro ao adicionar item', 'bg-red-600');
                }
            }
        });

        // Render functions
        function renderPlansList(){ try {
            const container = document.getElementById('tp-plans'); if (!container) return; container.innerHTML=''; const plans = loadTravelPlans(); if (!plans || !plans.length) { container.innerHTML='<div class="text-sm text-gray-500">Nenhum plano criado.</div>'; return; }
            plans.forEach(p=>{
                const el = document.createElement('div'); el.className='p-3 border rounded bg-white flex items-center justify-between hover:bg-blue-50 transition-colors cursor-pointer';
                const left = document.createElement('div'); left.innerHTML = `<div class="font-semibold">${p.destination}</div><div class="text-xs text-gray-500">${p.date||'Sem data'} — ${formatBR(p.estimated||0)}</div>`;
                const right = document.createElement('div'); right.className='flex gap-2';
                
                // Botão Ver Dashboard
                const view = document.createElement('button'); 
                view.className='px-3 py-1.5 rounded bg-indigo-600 text-white font-medium hover:bg-indigo-700 transition-colors flex items-center gap-1'; 
                view.innerHTML='<span class="material-symbols-outlined text-sm">visibility</span><span>Ver</span>'; 
                view.addEventListener('click', (e)=>{ 
                    e.stopPropagation(); 
                    renderPlanDashboard(p.id); 
                });
                
                // Botão Editar (abre modal)
                const edit = document.createElement('button'); 
                edit.className='px-2 py-1.5 rounded bg-blue-50 text-blue-700 hover:bg-blue-100 transition-colors'; 
                edit.innerHTML='<span class="material-symbols-outlined text-sm">edit</span>'; 
                edit.title='Editar plano';
                edit.addEventListener('click', (e)=>{ 
                    e.stopPropagation();
                    q('tp-id').value=p.id; tpDestination.value=p.destination||''; tpDate.value=p.date||''; tpEstimated.value=p.estimated||''; tpSaved.value=p.saved||''; renderPlanDetails(p.id); openModal(); 
                });
                
                // Botão Excluir
                const del = document.createElement('button'); 
                del.className='px-2 py-1.5 rounded bg-red-50 text-red-700 hover:bg-red-100 transition-colors'; 
                del.innerHTML='<span class="material-symbols-outlined text-sm">delete</span>';
                del.title='Excluir plano';
                del.addEventListener('click', async (e)=>{ 
                    e.stopPropagation();
                    if (!confirm('Excluir plano?')) return; 
                    const plans2 = loadTravelPlans().filter(x=>x.id!==p.id);
                    await saveTravelPlans(plans2);
                    // remove linked goal if present
                    try {
                        window.state = window.state || {}; window.state.appData = window.state.appData || {}; window.state.appData.settings = window.state.appData.settings || {};
                        const goals = window.state.appData.settings.goals = window.state.appData.settings.goals || [];
                        const gIdx = goals.findIndex(g => g.linkedTravelPlanId === p.id);
                        if (gIdx !== -1) { goals.splice(gIdx,1); try { await storage.saveData(window.state.appData); } catch(e){} }
                        try { if (typeof renderInvestmentsView === 'function') renderInvestmentsView(); } catch(e){}
                    } catch(e) { console.error('remove linked goal', e); }
                    
                    // Fechar dashboard se este plano estiver aberto
                    const dashContainer = document.getElementById('tp-selected-dashboard');
                    if(dashContainer && !dashContainer.classList.contains('hidden')){
                        dashContainer.classList.add('hidden');
                    }
                    
                    // Limpar persistência se for o plano excluído
                    const lastSelectedPlanId = localStorage.getItem('lastSelectedTravelPlan');
                    if(lastSelectedPlanId === p.id){
                        localStorage.removeItem('lastSelectedTravelPlan');
                    }
                    
                    renderPlansList(); 
                    showToast('Plano excluído','bg-green-600'); 
                });
                
                // Click no card também abre o dashboard
                el.addEventListener('click', ()=>{ renderPlanDashboard(p.id); });
                
                right.appendChild(view); right.appendChild(edit); right.appendChild(del);
                el.appendChild(left); el.appendChild(right); container.appendChild(el);
            });
            
            // Carregar automaticamente o último plano selecionado
            const lastSelectedPlanId = localStorage.getItem('lastSelectedTravelPlan');
            if(lastSelectedPlanId && plans.find(p => p.id === lastSelectedPlanId)){
                // Carregar sem scroll automático
                setTimeout(() => renderPlanDashboard(lastSelectedPlanId, false), 300);
            }
        } catch(e){ console.error('renderPlansList', e); } }

        // Função para renderizar dashboard do plano na tela principal
        function renderPlanDashboard(planId, autoScroll = true){ try {
            const plans = loadTravelPlans(); 
            const plan = plans.find(p=>p.id===planId); 
            if (!plan) return;
            
            const dashContainer = document.getElementById('tp-selected-dashboard');
            if(!dashContainer) return;
            
            // Salvar último plano selecionado
            localStorage.setItem('lastSelectedTravelPlan', planId);
            
            // Mostrar dashboard
            dashContainer.classList.remove('hidden');
            
            // Scroll suave até o dashboard (apenas se não for carregamento automático)
            if(autoScroll){
                setTimeout(()=>{ dashContainer.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
            }
            
            // Cabeçalho
            document.getElementById('tp-dash-title').textContent = plan.destination || 'Destino';
            document.getElementById('tp-dash-subtitle').textContent = plan.date ? new Date(plan.date + 'T00:00:00').toLocaleDateString('pt-BR', {weekday:'long', year:'numeric', month:'long', day:'numeric'}) : 'Data não definida';
            
            // Calcular totais
            const totalTransports = (plan.transports||[]).reduce((sum, t)=>sum+(t.subtotal||0), 0);
            const totalAccommodations = (plan.accommodations||[]).reduce((sum, a)=>sum+(a.total||0), 0);
            const totalActivities = (plan.activities||[]).reduce((sum, a)=>sum+(a.price||0), 0);
            const totalCosts = totalTransports + totalAccommodations + totalActivities;
            
            const paidTransports = (plan.transports||[]).filter(t=>t.paid).reduce((sum, t)=>sum+(t.subtotal||0), 0);
            const paidAccommodations = (plan.accommodations||[]).filter(a=>a.paid).reduce((sum, a)=>sum+(a.total||0), 0);
            const paidActivities = (plan.activities||[]).filter(a=>a.paid).reduce((sum, a)=>sum+(a.price||0), 0);
            const totalPaid = paidTransports + paidAccommodations + paidActivities;
            
            const budgeted = plan.estimated || 0;
            const realized = plan.saved || 0;
            const remaining = budgeted - realized;
            
            // Cards financeiros
            document.getElementById('tp-dash-budget').textContent = formatBR(budgeted);
            document.getElementById('tp-dash-realized').textContent = formatBR(realized);
            document.getElementById('tp-dash-paid').textContent = formatBR(totalPaid);
            document.getElementById('tp-dash-remaining').textContent = formatBR(remaining);
            
            // Progresso
            const progress = budgeted > 0 ? Math.min(Math.round((realized / budgeted) * 100), 100) : 0;
            document.getElementById('tp-dash-progress-pct').textContent = `${progress}%`;
            document.getElementById('tp-dash-progress-bar').style.width = `${progress}%`;
            
            // Breakdown de custos
            const costsContainer = document.getElementById('tp-dash-costs');
            costsContainer.innerHTML = `
                <div class="p-3 rounded-lg border border-sky-200" style="background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="material-symbols-outlined text-sm" style="color: #0284C7;">directions_car</span>
                        <span class="text-xs font-semibold text-gray-600">TRANSPORTES</span>
                    </div>
                    <div class="text-lg font-bold" style="color: #0284C7;">${formatBR(totalTransports)}</div>
                </div>
                <div class="p-3 rounded-lg border border-rose-200" style="background: linear-gradient(135deg, #ffffff 0%, #fff1f2 100%);">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="material-symbols-outlined text-sm" style="color: #E11D48;">hotel</span>
                        <span class="text-xs font-semibold text-gray-600">HOSPEDAGEM</span>
                    </div>
                    <div class="text-lg font-bold" style="color: #E11D48;">${formatBR(totalAccommodations)}</div>
                </div>
                <div class="p-3 rounded-lg border border-purple-200" style="background: linear-gradient(135deg, #ffffff 0%, #faf5ff 100%);">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="material-symbols-outlined text-sm" style="color: #9333EA;">attractions</span>
                        <span class="text-xs font-semibold text-gray-600">ATIVIDADES</span>
                    </div>
                    <div class="text-lg font-bold" style="color: #9333EA;">${formatBR(totalActivities)}</div>
                </div>
                <div class="p-3 rounded-lg border border-green-200" style="background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="material-symbols-outlined text-sm" style="color: #059669;">account_balance_wallet</span>
                        <span class="text-xs font-semibold text-gray-600">TOTAL</span>
                    </div>
                    <div class="text-lg font-bold" style="color: #059669;">${formatBR(totalCosts)}</div>
                </div>
            `;
            
            // Roteiro
            const itineraryContainer = document.getElementById('tp-dash-itinerary');
            const autoItems = [];
            
            // Mapeamento de ícones por tipo de atividade
            const activityIcons = {
                'passeio': 'tour',
                'ingresso': 'confirmation_number',
                'evento': 'event',
                'compras': 'shopping_bag',
                'restaurante': 'restaurant',
                'experiencia': 'stars',
                'esporte': 'sports_soccer',
                'cultura': 'museum',
                'tour': 'map',
                'outro': 'local_activity'
            };
            
            // Mapeamento de rótulos em title case
            const activityLabels = {
                'passeio': 'Passeio',
                'ingresso': 'Ingresso',
                'evento': 'Evento',
                'compras': 'Compras',
                'restaurante': 'Restaurante',
                'experiencia': 'Experiência',
                'esporte': 'Esporte',
                'cultura': 'Cultura',
                'tour': 'Tour',
                'outro': 'Outro'
            };
            
            // Processar itens do roteiro
            (plan.activities||[]).forEach(act=>{
                const actIcon = activityIcons[act.type] || 'tour';
                const actLabel = activityLabels[act.type] || act.type;
                if(act.date) autoItems.push({ date: act.date, time: act.time||'09:00', type: 'activity', icon: actIcon, color: 'purple', title: act.name, location: `${actLabel}${act.duration?' • '+act.duration:''}` });
            });
            
            // Mapeamento de rótulos para tipos de transporte
            const transportTypeLabels = {
                'carro': 'Carro/Moto',
                'voo': 'Voo',
                'aluguel': 'Aluguel de Carro',
                'uber': 'Uber/Taxi',
                'publico': 'Transporte Público'
            };
            
            (plan.transports||[]).forEach(tr=>{
                const transportLabel = transportTypeLabels[tr.type] || tr.type;
                const displayText = tr.description || transportLabel;
                if(tr.departureDate) autoItems.push({ date: tr.departureDate, time: tr.departureTime||'00:00', type: 'transport', icon: 'flight_takeoff', color: 'blue', title: displayText, location: 'Partida' });
                if(tr.returnDate) autoItems.push({ date: tr.returnDate, time: tr.returnTime||'00:00', type: 'transport', icon: 'flight_land', color: 'blue', title: displayText, location: 'Retorno' });
            });
            
            (plan.itinerary||[]).forEach(i=>{ 
                if(i.type === 'accommodation-checkin'){
                    autoItems.push({ date: i.date, time: i.time, type: 'accommodation', icon: 'login', color: 'red', title: i.activity, location: i.location });
                } else if(i.type === 'accommodation-checkout'){
                    autoItems.push({ date: i.date, time: i.time, type: 'accommodation', icon: 'logout', color: 'red', title: i.activity, location: i.location });
                } else if(i.type === 'transport-departure'){
                    autoItems.push({ date: i.date, time: i.time, type: 'transport', icon: 'directions_car', color: 'blue', title: i.activity, location: i.location });
                } else if(i.type === 'transport-return'){
                    autoItems.push({ date: i.date, time: i.time, type: 'transport', icon: 'directions_car', color: 'blue', title: i.activity, location: i.location });
                } else {
                    autoItems.push({ date: i.date, time: i.time, type: 'manual', icon: 'event', color: 'green', title: i.activity, location: i.location });
                }
            });
            
            const sortedItin = autoItems.filter(x=>x.date).sort((a,b)=>{ const dateA = new Date(a.date + ' ' + (a.time||'00:00')); const dateB = new Date(b.date + ' ' + (b.time||'00:00')); return dateA - dateB; });
            
            document.getElementById('tp-dash-events-count').textContent = `${sortedItin.length} eventos`;
            
            if(sortedItin.length === 0){
                itineraryContainer.innerHTML = '<div class="text-sm text-gray-500 p-4 text-center">Nenhum evento no roteiro</div>';
            } else {
                itineraryContainer.innerHTML = '';
                sortedItin.forEach(i=>{
                    const item = document.createElement('div');
                    item.className = 'p-3 rounded-lg border border-gray-200 bg-white hover:shadow-md transition-shadow flex items-center gap-3';
                    const iconColors = { blue: '#0EA5E9', green: '#10B981', purple: '#A855F7', orange: '#F97316' };
                    item.innerHTML = `
                        <span class="material-symbols-outlined" style="color: ${iconColors[i.color] || '#6B7280'};">${i.icon}</span>
                        <div class="flex-1">
                            <div class="font-medium text-sm text-gray-800">${i.time} - ${escapeHtml(i.title)}</div>
                            <div class="text-xs text-gray-600 mt-0.5">${escapeHtml(i.location||'')}</div>
                        </div>
                    `;
                    itineraryContainer.appendChild(item);
                });
            }
            
            // Transportes
            const transportsContainer = document.getElementById('tp-dash-transports');
            document.getElementById('tp-dash-transport-count').textContent = (plan.transports||[]).length;
            
            if(!plan.transports || plan.transports.length === 0){
                transportsContainer.innerHTML = '<div class="text-xs text-gray-500 text-center py-4">Nenhum transporte</div>';
            } else {
                transportsContainer.innerHTML = '';
                plan.transports.forEach(t=>{
                    const item = document.createElement('div');
                    item.className = 'p-3 rounded-lg border border-gray-200 bg-white hover:shadow-md transition-shadow';
                    const paidBadge = t.paid ? '<span class="text-xs px-2 py-0.5 rounded ml-1" style="background-color: #D1FAE5; color: #065F46;">✓ Pago</span>' : '';
                    const transportLabel = transportTypeLabels[t.type] || t.type;
                    const displayText = t.description || transportLabel;
                    const linkBtn = t.link ? `<a href="${escapeHtml(t.link)}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-700 ml-1" title="Abrir link"><span class="material-symbols-outlined" style="font-size:16px;">open_in_new</span></a>` : '';
                    item.innerHTML = `
                        <div class="font-medium text-sm text-gray-800 flex items-center gap-1">${escapeHtml(displayText)}${paidBadge}${linkBtn}</div>
                        <div class="text-xs text-gray-600 mt-1">${t.distance||0} km • ${formatBR(t.subtotal||0)}</div>
                    `;
                    transportsContainer.appendChild(item);
                });
            }
            
            // Hospedagens
            const accommodationsContainer = document.getElementById('tp-dash-accommodations');
            document.getElementById('tp-dash-accommodation-count').textContent = (plan.accommodations||[]).length;
            if(!plan.accommodations || plan.accommodations.length === 0){
                accommodationsContainer.innerHTML = '<div class="text-xs text-gray-500 text-center py-4">Nenhuma hospedagem</div>';
            } else {
                accommodationsContainer.innerHTML = '';
                plan.accommodations.forEach(a=>{
                    const item = document.createElement('div');
                    item.className = 'p-3 rounded-lg border border-gray-200 bg-white hover:shadow-md transition-shadow';
                    const paidBadge = a.paid ? '<span class="text-xs px-2 py-0.5 rounded ml-1" style="background-color: #D1FAE5; color: #065F46;">✓ Pago</span>' : '';
                    const linkBtn = a.link ? `<a href="${escapeHtml(a.link)}" target="_blank" rel="noopener noreferrer" class="text-pink-600 hover:text-pink-700 ml-1" title="Abrir link da propriedade"><span class="material-symbols-outlined" style="font-size:16px;">open_in_new</span></a>` : '';
                    item.innerHTML = `
                        <div class="font-medium text-sm text-gray-800 flex items-center gap-1">${escapeHtml(a.name)}${paidBadge}${linkBtn}</div>
                        <div class="text-xs text-gray-600 mt-1">${a.nights} diárias • ${formatBR(a.total||0)}</div>
                    `;
                    accommodationsContainer.appendChild(item);
                });
            }
            
            // Atividades
            const activitiesContainer = document.getElementById('tp-dash-activities');
            document.getElementById('tp-dash-activity-count').textContent = (plan.activities||[]).length;
            if(!plan.activities || plan.activities.length === 0){
                activitiesContainer.innerHTML = '<div class="text-xs text-gray-500 text-center py-4">Nenhuma atividade</div>';
            } else {
                activitiesContainer.innerHTML = '';
                plan.activities.forEach(a=>{
                    const item = document.createElement('div');
                    item.className = 'p-3 rounded-lg border border-gray-200 bg-white hover:shadow-md transition-shadow';
                    const paidBadge = a.paid ? '<span class="text-xs px-2 py-0.5 rounded ml-1" style="background-color: #D1FAE5; color: #065F46;">✓ Pago</span>' : '';
                    const actLabel = activityLabels[a.type] || a.type;
                    item.innerHTML = `
                        <div class="font-medium text-sm">${escapeHtml(a.name)}${paidBadge}</div>
                        <div class="text-xs text-gray-600">${actLabel} • ${formatBR(a.price||0)}</div>
                    `;
                    activitiesContainer.appendChild(item);
                });
            }
            
            // Checklist
            const checklistContainer = document.getElementById('tp-dash-checklist');
            const checklist = plan.checklist || [];
            const completedItems = checklist.filter(item => item.checked).length;
            const checklistProgress = checklist.length > 0 ? Math.round((completedItems / checklist.length) * 100) : 0;
            
            document.getElementById('tp-dash-checklist-progress').textContent = `${checklistProgress}%`;
            
            if(checklist.length === 0){
                checklistContainer.innerHTML = '<div class="text-sm text-gray-500 text-center py-4">Nenhum item no checklist</div>';
            } else {
                checklistContainer.innerHTML = '';
                checklist.slice(0, 10).forEach(item=>{
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2 p-2 rounded';
                    div.style.backgroundColor = '#f9fafb';
                    const iconColor = item.checked ? '#10b981' : '#9ca3af';
                    const textClass = item.checked ? 'line-through text-gray-500' : 'text-gray-700';
                    div.innerHTML = `
                        <span class="material-symbols-outlined text-sm" style="color: ${iconColor};">${item.checked ? 'check_circle' : 'radio_button_unchecked'}</span>
                        <span class="text-sm ${textClass}">${escapeHtml(item.item)}</span>
                    `;
                    checklistContainer.appendChild(div);
                });
                if(checklist.length > 10){
                    const more = document.createElement('div');
                    more.className = 'text-xs text-gray-500 text-center py-2';
                    more.textContent = `+ ${checklist.length - 10} itens`;
                    checklistContainer.appendChild(more);
                }
            }
            
            // Botão fechar (apenas oculta, mas mantém a persistência)
            const closeBtn = document.getElementById('tp-dash-close');
            closeBtn.onclick = ()=>{ dashContainer.classList.add('hidden'); };
            
        } catch(e){ console.error('renderPlanDashboard', e); } }

        async function renderPlanDetails(planId){ try {
            const plans = loadTravelPlans(); const plan = plans.find(p=>p.id===planId); if (!plan) return; tpSummaryDestination.textContent = plan.destination||'—'; tpSummaryDate.textContent = plan.date||'—'; tpSummaryTransports.textContent = (plan.transports||[]).length || 0;
            
            // Garantir que o painel de sugestões esteja inicializado
            try { renderChecklistSuggestionsPanel(); } catch(e){ console.error('renderChecklistSuggestionsPanel', e); }
            
            // transports list - COM TOGGLE DE PAGO
            const list = document.getElementById('tp-transport-list'); list.innerHTML='';
            
            // Mapeamento de rótulos para tipos de transporte
            const transportTypeLabels = {
                'carro': 'Carro/Moto',
                'voo': 'Voo',
                'aluguel': 'Aluguel de Carro',
                'uber': 'Uber/Taxi',
                'publico': 'Transporte Público'
            };
            
            (plan.transports||[]).forEach(t=>{
                const row = document.createElement('div'); row.className='p-2 border rounded flex items-center justify-between';
                const left = document.createElement('div');
                const paidBadge = (t && t.paid) ? `<span class="ml-2 inline-block text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded">✓ Pago</span>` : '';
                const durationInfo = (t && t.duration && t.type === 'carro') ? `<div class="text-xs text-blue-600 mt-1">⏱️ Tempo de viagem: ${t.duration}h (ida)</div>` : '';
                const transportLabel = transportTypeLabels[t.type] || t.type;
                const displayText = t.description || transportLabel;
                const linkBtn = t.link ? `<a href="${escapeHtml(t.link)}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 text-blue-600 hover:text-blue-700 text-xs ml-2" title="Abrir link"><span class="material-symbols-outlined" style="font-size:14px;">open_in_new</span>Link</a>` : '';
                left.innerHTML = `<div class="font-medium">${escapeHtml(displayText)} ${paidBadge}${linkBtn}</div><div class="text-xs text-gray-500">${t.distance||0} km • ${formatBR(t.subtotal||0)}</div>${durationInfo}`;
                const right = document.createElement('div');
                const toggle = document.createElement('button'); toggle.className='px-2 py-1 rounded '+(t.paid?'bg-green-50 text-green-700':'bg-gray-50 text-gray-700')+' mr-2'; toggle.innerHTML='<span class="material-symbols-outlined">'+(t.paid?'paid':'payments')+'</span>'; toggle.title=(t.paid?'Marcar como não pago':'Marcar como pago'); toggle.addEventListener('click', async ()=>{ t.paid = !t.paid; await saveTravelPlans(plans); renderPlanDetails(plan.id); });
                const expense = document.createElement('button'); expense.className='px-2 py-1 rounded bg-purple-50 text-purple-700 mr-2'; expense.innerHTML='<span class="material-symbols-outlined">receipt_long</span>'; expense.title='Criar despesa financeira'; expense.addEventListener('click', ()=>{ createExpenseFromTransport(plan.id, t.id); });
                const edit = document.createElement('button'); edit.className='px-2 py-1 rounded bg-yellow-50 text-yellow-700 mr-2'; edit.innerHTML='<span class="material-symbols-outlined">edit</span>'; edit.addEventListener('click', ()=>{ q('tp-id').value = plan.id; showTransportForm(t); });
                const del = document.createElement('button'); del.className='px-2 py-1 rounded bg-red-50 text-red-700'; del.innerHTML='<span class="material-symbols-outlined">delete</span>'; del.addEventListener('click', async ()=>{ if (!confirm('Excluir transporte?')) return; const trId = t.id; plan.transports = (plan.transports||[]).filter(x=>x.id!==trId); plan.itinerary = (plan.itinerary||[]).filter(i=>i.linkedId!==trId); await saveTravelPlans(plans); renderPlanDetails(plan.id); showToast('Transporte excluído','bg-green-600'); });
                right.appendChild(toggle); right.appendChild(expense); right.appendChild(edit); right.appendChild(del);
                row.appendChild(left); row.appendChild(right); list.appendChild(row);
            });

            // accommodations list - COM TOGGLE DE PAGO
            const accList = document.getElementById('tp-accommodation-list'); if (accList) { accList.innerHTML='';
            
            // Mapeamento de rótulos para tipos de hospedagem
            const accommodationTypeLabels = {
                'hotel': 'Hotel/Hostel',
                'airbnb': 'Airbnb',
                'reserva': 'Reserva'
            };
            
            (plan.accommodations||[]).forEach(a=>{
                const row = document.createElement('div'); row.className='p-2 border rounded flex items-center justify-between';
                const left = document.createElement('div');
                const paidBadge = (a && a.paid) ? `<span class="ml-2 inline-block text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded">✓ Pago</span>` : '';
                const checkinInfo = a.checkin ? `Check-in: ${new Date(a.checkin).toLocaleDateString('pt-BR')}${a.checkinTime ? ' às ' + a.checkinTime : ''}` : '';
                const checkoutInfo = a.checkout ? `Check-out: ${new Date(a.checkout).toLocaleDateString('pt-BR')}${a.checkoutTime ? ' às ' + a.checkoutTime : ''}` : '';
                const datesInfo = checkinInfo && checkoutInfo ? `${checkinInfo} • ${checkoutInfo}` : (checkinInfo || checkoutInfo);
                const accLabel = accommodationTypeLabels[a.type] || a.type;
                const linkBtn = a.link ? `<a href="${escapeHtml(a.link)}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 text-pink-600 hover:text-pink-700 text-xs ml-2" title="Abrir link da propriedade"><span class="material-symbols-outlined" style="font-size:14px;">open_in_new</span>Link</a>` : '';
                left.innerHTML = `<div class="font-medium">${escapeHtml(a.name)} ${paidBadge}${linkBtn}</div><div class="text-xs text-gray-500">${accLabel} • ${a.nights} diárias • ${formatBR(a.total||0)}</div>${datesInfo ? `<div class="text-xs text-blue-600 mt-1">📅 ${datesInfo}</div>` : ''}`;
                const right = document.createElement('div');
                const toggle = document.createElement('button'); toggle.className='px-2 py-1 rounded '+(a.paid?'bg-green-50 text-green-700':'bg-gray-50 text-gray-700')+' mr-2'; toggle.innerHTML='<span class="material-symbols-outlined">'+(a.paid?'paid':'payments')+'</span>'; toggle.title=(a.paid?'Marcar como não pago':'Marcar como pago'); toggle.addEventListener('click', async ()=>{ a.paid = !a.paid; await saveTravelPlans(plans); renderPlanDetails(plan.id); });
                const expense = document.createElement('button'); expense.className='px-2 py-1 rounded bg-purple-50 text-purple-700 mr-2'; expense.innerHTML='<span class="material-symbols-outlined">receipt_long</span>'; expense.title='Criar despesa financeira'; expense.addEventListener('click', ()=>{ createExpenseFromAccommodation(plan.id, a.id); });
                const edit = document.createElement('button'); edit.className='px-2 py-1 rounded bg-yellow-50 text-yellow-700 mr-2'; edit.innerHTML='<span class="material-symbols-outlined">edit</span>'; edit.addEventListener('click', ()=>{ q('tp-id').value = plan.id; showAccommodationForm(a); });
                const del = document.createElement('button'); del.className='px-2 py-1 rounded bg-red-50 text-red-700'; del.innerHTML='<span class="material-symbols-outlined">delete</span>'; del.addEventListener('click', async ()=>{ 
                    if (!confirm('Excluir hospedagem?')) return; 
                    const accId = a.id; 
                    plan.accommodations = (plan.accommodations||[]).filter(x=>x.id!==accId); 
                    plan.itinerary = (plan.itinerary||[]).filter(i=>i.linkedId!==accId); 
                    
                    // Re-sincronizar transportes tipo carro após exclusão de hospedagem
                    if (plan.transports && plan.transports.length > 0) {
                        // Remover todos os itens de transporte IDA/VOLTA antigos
                        plan.itinerary = (plan.itinerary||[]).filter(i=>i.type !== 'transport-departure' && i.type !== 'transport-return');
                        
                        // Re-sincronizar cada transporte tipo carro com as hospedagens restantes
                        plan.transports.forEach(transport => {
                            if (transport.type === 'carro' && transport.duration > 0) {
                                syncTravelToItinerary(plan, transport);
                            }
                        });
                    }
                    
                    await saveTravelPlans(plans); 
                    renderPlanDetails(plan.id); 
                    showToast('Hospedagem excluída','bg-green-600'); 
                });
                right.appendChild(toggle); right.appendChild(expense); right.appendChild(edit); right.appendChild(del);
                row.appendChild(left); row.appendChild(right); accList.appendChild(row);
            }); }

            // activities list - COM TOGGLE DE PAGO
            const actList = document.getElementById('tp-activity-list'); if (actList) { actList.innerHTML='';
            (plan.activities||[]).forEach(a=>{
                const row = document.createElement('div'); row.className='p-2 border rounded flex items-center justify-between';
                const left = document.createElement('div');
                const paidBadge = (a && a.paid) ? `<span class="ml-2 inline-block text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded">✓ Pago</span>` : '';
                const activityTypeLabels = {
                    'passeio': 'Passeio', 'ingresso': 'Ingresso', 'evento': 'Evento',
                    'compras': 'Compras', 'restaurante': 'Restaurante', 'experiencia': 'Experiência',
                    'esporte': 'Esporte', 'cultura': 'Cultura', 'tour': 'Tour', 'outro': 'Outro'
                };
                const actLabel = activityTypeLabels[a.type] || a.type;
                left.innerHTML = `<div class="font-medium">${escapeHtml(a.name)} ${paidBadge}</div><div class="text-xs text-gray-500">${actLabel} • ${a.date||'Sem data'} ${a.time||''} • ${formatBR(a.price||0)}</div>`;
                const right = document.createElement('div');
                const toggle = document.createElement('button'); toggle.className='px-2 py-1 rounded '+(a.paid?'bg-green-50 text-green-700':'bg-gray-50 text-gray-700')+' mr-2'; toggle.innerHTML='<span class="material-symbols-outlined">'+(a.paid?'paid':'payments')+'</span>'; toggle.title=(a.paid?'Marcar como não pago':'Marcar como pago'); toggle.addEventListener('click', async ()=>{ a.paid = !a.paid; await saveTravelPlans(plans); renderPlanDetails(plan.id); });
                const expense = document.createElement('button'); expense.className='px-2 py-1 rounded bg-purple-50 text-purple-700 mr-2'; expense.innerHTML='<span class="material-symbols-outlined">receipt_long</span>'; expense.title='Criar despesa financeira'; expense.addEventListener('click', ()=>{ createExpenseFromActivity(plan.id, a.id); });
                const edit = document.createElement('button'); edit.className='px-2 py-1 rounded bg-yellow-50 text-yellow-700 mr-2'; edit.innerHTML='<span class="material-symbols-outlined">edit</span>'; edit.addEventListener('click', ()=>{ q('tp-id').value = plan.id; showActivityForm(a); });
                const del = document.createElement('button'); del.className='px-2 py-1 rounded bg-red-50 text-red-700'; del.innerHTML='<span class="material-symbols-outlined">delete</span>'; del.addEventListener('click', async ()=>{ if (!confirm('Excluir passeio?')) return; plan.activities = (plan.activities||[]).filter(x=>x.id!==a.id); await saveTravelPlans(plans); renderPlanDetails(plan.id); showToast('Passeio excluído','bg-green-600'); });
                right.appendChild(toggle); right.appendChild(expense); right.appendChild(edit); right.appendChild(del);
                row.appendChild(left); row.appendChild(right); actList.appendChild(row);
            }); }

            // itinerary list - COM INTEGRAÇÃO AUTOMÁTICA
            const itinList = document.getElementById('tp-itinerary-list'); if (itinList) { itinList.innerHTML='';
            
            // Mapeamento de ícones por tipo de atividade
            const activityIcons = {
                'passeio': 'tour',
                'ingresso': 'confirmation_number',
                'evento': 'event',
                'compras': 'shopping_bag',
                'restaurante': 'restaurant',
                'experiencia': 'stars',
                'esporte': 'sports_soccer',
                'cultura': 'museum',
                'tour': 'map',
                'outro': 'local_activity'
            };
            
            // Mapeamento de rótulos em title case
            const activityLabels = {
                'passeio': 'Passeio',
                'ingresso': 'Ingresso',
                'evento': 'Evento',
                'compras': 'Compras',
                'restaurante': 'Restaurante',
                'experiencia': 'Experiência',
                'esporte': 'Esporte',
                'cultura': 'Cultura',
                'tour': 'Tour',
                'outro': 'Outro'
            };
            
            // Gerar itens automáticos do roteiro baseado em atividades e transportes
            const autoItems = [];
            
            // NÃO adicionar hospedagens aqui - elas já são sincronizadas via syncAccommodationToItinerary
            // que salva diretamente em plan.itinerary com autoSync: true
            
            // Adicionar atividades
            (plan.activities||[]).forEach(act=>{
                const actIcon = activityIcons[act.type] || 'tour';
                const actLabel = activityLabels[act.type] || act.type;
                if(act.date) autoItems.push({ date: act.date, time: act.time||'09:00', type: 'activity', icon: actIcon, color: 'purple', title: act.name, location: `${actLabel}${act.duration?' • '+act.duration:''}`, auto: true, linkedId: act.id });
            });
            
            // Adicionar transportes com datas (voos, aluguéis)
            // Mapeamento de rótulos para tipos de transporte
            const transportTypeLabels = {
                'carro': 'Carro/Moto',
                'voo': 'Voo',
                'aluguel': 'Aluguel de Carro',
                'uber': 'Uber/Taxi',
                'publico': 'Transporte Público'
            };
            
            (plan.transports||[]).forEach(tr=>{
                const transportLabel = transportTypeLabels[tr.type] || tr.type;
                const displayText = tr.description || transportLabel;
                if(tr.departureDate) autoItems.push({ date: tr.departureDate, time: tr.departureTime||'00:00', type: 'transport', subtype: 'departure', icon: 'flight_takeoff', color: 'blue', title: displayText, location: 'Partida', auto: true, linkedId: tr.id });
                if(tr.returnDate) autoItems.push({ date: tr.returnDate, time: tr.returnTime||'00:00', type: 'transport', subtype: 'return', icon: 'flight_land', color: 'blue', title: displayText, location: 'Retorno', auto: true, linkedId: tr.id });
            });
            
            // Adicionar itens do roteiro (incluindo hospedagens sincronizadas e itens manuais)
            (plan.itinerary||[]).forEach(i=>{ 
                // Se for item de hospedagem sincronizado, usar estética vermelha
                if(i.type === 'accommodation-checkin'){
                    autoItems.push({ date: i.date, time: i.time, type: 'accommodation', subtype: 'checkin', icon: 'login', color: 'red', title: i.activity, location: i.location, notes: i.notes, id: i.id, auto: true, autoSync: i.autoSync, linkedId: i.linkedId });
                } else if(i.type === 'accommodation-checkout'){
                    autoItems.push({ date: i.date, time: i.time, type: 'accommodation', subtype: 'checkout', icon: 'logout', color: 'red', title: i.activity, location: i.location, notes: i.notes, id: i.id, auto: true, autoSync: i.autoSync, linkedId: i.linkedId });
                } else if(i.type === 'transport-departure'){
                    // IDA - Transporte tipo carro
                    autoItems.push({ date: i.date, time: i.time, type: 'transport', subtype: 'departure', icon: 'directions_car', color: 'blue', title: i.activity, location: i.location, notes: i.notes, id: i.id, auto: true, autoSync: i.autoSync, linkedId: i.linkedId });
                } else if(i.type === 'transport-return'){
                    // VOLTA - Transporte tipo carro
                    autoItems.push({ date: i.date, time: i.time, type: 'transport', subtype: 'return', icon: 'directions_car', color: 'blue', title: i.activity, location: i.location, notes: i.notes, id: i.id, auto: true, autoSync: i.autoSync, linkedId: i.linkedId });
                } else {
                    // Item manual
                    autoItems.push({ date: i.date, time: i.time, day: i.day, type: 'manual', icon: 'event', color: 'green', title: i.activity, location: i.location, notes: i.notes, id: i.id, auto: false });
                }
            });
            
            // Ordenar por data e hora
            const sortedItin = autoItems.filter(x=>x.date).sort((a,b)=>{ const dateA = new Date(a.date + ' ' + (a.time||'00:00')); const dateB = new Date(b.date + ' ' + (b.time||'00:00')); return dateA - dateB; });
            
            if(sortedItin.length === 0){ itinList.innerHTML = '<div class="text-sm text-gray-500 p-4">Nenhum item no roteiro. Adicione hospedagens, atividades ou itens manuais.</div>'; } else {
                let currentDate = null;
                sortedItin.forEach(i=>{
                    // Separador de data
                    if(currentDate !== i.date){ currentDate = i.date; const dateHeader = document.createElement('div'); dateHeader.className='text-xs font-bold text-gray-600 mt-3 mb-1 px-2'; const d = new Date(i.date + 'T00:00:00'); dateHeader.textContent = d.toLocaleDateString('pt-BR', {weekday:'long', year:'numeric', month:'long', day:'numeric'}); itinList.appendChild(dateHeader); }
                    
                    const row = document.createElement('div'); row.className=`p-3 border-l-4 border-${i.color}-500 bg-${i.color}-50 rounded mb-2 ${i.auto?'opacity-90':''}`;
                    const content = document.createElement('div'); content.className='flex items-start justify-between';
                    const left = document.createElement('div'); left.className='flex items-start gap-2 flex-1';
                    const iconEl = document.createElement('span'); iconEl.className=`material-symbols-outlined text-${i.color}-600 text-xl`; iconEl.textContent=i.icon;
                    const info = document.createElement('div'); info.className='flex-1';
                    const timeTag = i.time ? `<span class="inline-block bg-gray-700 text-white text-xs px-2 py-0.5 rounded mr-2">${i.time}</span>` : '';
                    const autoTag = i.auto ? `<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded ml-2">Auto</span>` : '';
                    info.innerHTML = `<div class="font-medium text-gray-900">${timeTag}${escapeHtml(i.title)}${autoTag}</div><div class="text-xs text-gray-600 mt-1">${escapeHtml(i.location||'')}</div>${i.notes?'<div class="text-xs text-gray-500 mt-1 italic">'+escapeHtml(i.notes)+'</div>':''}`;
                    left.appendChild(iconEl); left.appendChild(info);
                    
                    // Botões para itens manuais
                    if(!i.auto && i.id){
                        const right = document.createElement('div'); right.className='flex gap-1';
                        const edit = document.createElement('button'); edit.className='px-2 py-1 rounded bg-yellow-50 text-yellow-700 hover:bg-yellow-100'; edit.innerHTML='<span class="material-symbols-outlined text-sm">edit</span>'; edit.addEventListener('click', ()=>{ q('tp-id').value = plan.id; showItineraryForm(plan.itinerary.find(x=>x.id===i.id)); });
                        const del = document.createElement('button'); del.className='px-2 py-1 rounded bg-red-50 text-red-700 hover:bg-red-100'; del.innerHTML='<span class="material-symbols-outlined text-sm">delete</span>'; del.addEventListener('click', async ()=>{ if (!confirm('Excluir item do roteiro?')) return; plan.itinerary = (plan.itinerary||[]).filter(x=>x.id!==i.id); await saveTravelPlans(plans); renderPlanDetails(plan.id); showToast('Item excluído','bg-green-600'); });
                        right.appendChild(edit); right.appendChild(del);
                        content.appendChild(left); content.appendChild(right);
                    } 
                    // Botão de edição para itens automáticos com linkedId
                    else if(i.auto && i.linkedId){
                        const right = document.createElement('div'); right.className='flex gap-1';
                        const edit = document.createElement('button'); edit.className='px-2 py-1 rounded bg-yellow-50 text-yellow-700 hover:bg-yellow-100'; edit.innerHTML='<span class="material-symbols-outlined text-sm">edit</span>'; 
                        edit.addEventListener('click', ()=>{ 
                            q('tp-id').value = plan.id;
                            // Identifica o tipo e abre o formulário apropriado
                            if(i.type === 'accommodation' || i.subtype === 'checkin' || i.subtype === 'checkout'){
                                const acc = (plan.accommodations||[]).find(x=>x.id===i.linkedId);
                                if(acc) showAccommodationForm(acc);
                            } else if(i.type === 'activity'){
                                const act = (plan.activities||[]).find(x=>x.id===i.linkedId);
                                if(act) showActivityForm(act);
                            } else if(i.type === 'transport'){
                                const tr = (plan.transports||[]).find(x=>x.id===i.linkedId);
                                if(tr) showTransportForm(tr);
                            }
                        });
                        right.appendChild(edit);
                        content.appendChild(left); content.appendChild(right);
                    } else { 
                        content.appendChild(left); 
                    }
                    
                    row.appendChild(content); itinList.appendChild(row);
                });
            }
            }

            // checklist list
            const chkList = document.getElementById('tp-checklist-list'); if (chkList) { chkList.innerHTML='';
            (plan.checklist||[]).forEach(c=>{
                const row = document.createElement('div'); row.className='p-2 border rounded flex items-center justify-between';
                const left = document.createElement('div');
                const packedBadge = (c && c.packed) ? `<span class="ml-2 inline-block text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded">✓ Pronto</span>` : '';
                left.innerHTML = `<div class="font-medium">${escapeHtml(c.item)} ${packedBadge}</div><div class="text-xs text-gray-500">${c.category} • Qtd: ${c.quantity||1} • ${c.weight||0} kg</div>`;
                const right = document.createElement('div');
                const toggle = document.createElement('button'); toggle.className='px-2 py-1 rounded '+(c.packed?'bg-green-50 text-green-700':'bg-gray-50 text-gray-700')+' mr-2'; toggle.innerHTML='<span class="material-symbols-outlined">'+(c.packed?'check_circle':'radio_button_unchecked')+'</span>'; toggle.addEventListener('click', async ()=>{ c.packed = !c.packed; await saveTravelPlans(plans); renderPlanDetails(plan.id); });
                const edit = document.createElement('button'); edit.className='px-2 py-1 rounded bg-yellow-50 text-yellow-700 mr-2'; edit.innerHTML='<span class="material-symbols-outlined">edit</span>'; edit.addEventListener('click', ()=>{ q('tp-id').value = plan.id; showChecklistForm(c); });
                const del = document.createElement('button'); del.className='px-2 py-1 rounded bg-red-50 text-red-700'; del.innerHTML='<span class="material-symbols-outlined">delete</span>'; del.addEventListener('click', async ()=>{ if (!confirm('Excluir item?')) return; plan.checklist = (plan.checklist||[]).filter(x=>x.id!==c.id); await saveTravelPlans(plans); renderPlanDetails(plan.id); showToast('Item excluído','bg-green-600'); });
                right.appendChild(toggle); right.appendChild(edit); right.appendChild(del);
                row.appendChild(left); row.appendChild(right); chkList.appendChild(row);
            }); }

            // update totals (sections)
            let totFuel = 0, totRental = 0, totTransfers = 0, totTolls = 0;
            (plan.transports||[]).forEach(t=>{ totFuel += Number(t.fuelCost || 0); totRental += Number(t.rental || 0) + Number(t.maint || 0); totTransfers += Number(t.transfers || 0); totTolls += Number(t.tolls || 0); });
            
            // Add accommodation and activities costs
            let totAccommodation = 0;
            (plan.accommodations||[]).forEach(a=>{ totAccommodation += Number(a.total || 0); });
            let totActivities = 0;
            (plan.activities||[]).forEach(a=>{ totActivities += Number(a.price || 0); });
            
            // Custos: sum of all sections
            const costs = totFuel + totRental + totTransfers + totTolls + totAccommodation + totActivities;
            // Orçado (planejado para gastar)
            const estimated = Number(plan.estimated || 0);
            
            // Realizado: amount saved / registered as reserve (meta) + poupanças vinculadas
            let realized = Number(plan.saved || 0);
            
            // Adiciona valores das poupanças vinculadas à meta (goalId) deste plano
            try {
                // Primeiro tenta buscar pela goalId se existir
                if (plan.goalId && typeof sumSavingsForGoal === 'function') {
                    const savingsForGoal = sumSavingsForGoal(plan.goalId);
                    realized = Math.round((Number(savingsForGoal) + Number.EPSILON) * 100) / 100;
                } else {
                    // Fallback: Tenta encontrar a meta pelo nome (destination do plano)
                    const goals = (window.state && window.state.appData && window.state.appData.settings && window.state.appData.settings.goals) || [];
                    const matchingGoal = goals.find(g => {
                        const goalName = (g.name || '').toLowerCase().trim();
                        const planDest = (plan.destination || '').toLowerCase().trim();
                        return goalName === planDest || goalName.includes(planDest) || planDest.includes(goalName);
                    });
                    
                    if (matchingGoal && matchingGoal.id) {
                        // Vincula o plano à meta automaticamente
                        plan.goalId = matchingGoal.id;
                        
                        if (typeof sumSavingsForGoal === 'function') {
                            const savingsForGoal = sumSavingsForGoal(matchingGoal.id);
                            realized = Math.round((Number(savingsForGoal) + Number.EPSILON) * 100) / 100;
                        } else {
                            // Cálculo manual das poupanças
                            let totalSavings = 0;
                            if (window.state && window.state.appData && window.state.appData.data) {
                                Object.values(window.state.appData.data).forEach(yearData => {
                                    Object.values(yearData).forEach(monthData => {
                                        if (monthData.savings && Array.isArray(monthData.savings)) {
                                            monthData.savings.forEach(saving => {
                                                if (saving.goalId === matchingGoal.id) {
                                                    totalSavings += Number(saving.amount || 0);
                                                }
                                            });
                                        }
                                    });
                                });
                                realized = Math.round((Number(totalSavings) + Number.EPSILON) * 100) / 100;
                            }
                        }
                        
                        // Salva a vinculação automaticamente
                        try {
                            if (typeof saveTravelPlans === 'function') {
                                await saveTravelPlans(plans);
                            }
                        } catch(e) {
                            console.error('Erro ao salvar vinculação automática da meta:', e);
                        }
                    }
                }
            } catch(e) {
                console.error('Erro ao calcular poupanças vinculadas à meta:', e);
            }
            
            // Pago: sum of sections already paid -- transport/accommodation/activity objects may include a 'paid' boolean
            let paid = 0;
            paid += (plan.transports || []).reduce((s,t) => s + ((t && t.paid) ? Number(t.subtotal || 0) : 0), 0);
            paid += (plan.accommodations || []).reduce((s,a) => s + ((a && a.paid) ? Number(a.total || 0) : 0), 0);
            paid += (plan.activities || []).reduce((s,a) => s + ((a && a.paid) ? Number(a.price || 0) : 0), 0);

            // ===== CÁLCULO DO RESTANTE COM LÓGICA MELHORADA =====
            // Se o valor Realizado for maior que o Orçado, usa Realizado como base
            // Caso contrário, usa Orçado como base (comportamento padrão)
            let remaining = 0;
            if (realized > estimated) {
                // Meta superada! Usa o valor Realizado como base para calcular o restante
                remaining = Math.max(0, realized - costs);
            } else {
                // Meta ainda não superada, usa o Orçado como base (padrão)
                remaining = Math.max(0, estimated - costs);
            }

            // Build smart cost blocks (only non-zero subtotals)
            try {
                const costBlocksEl = document.getElementById('tp-cost-blocks');
                if (costBlocksEl) {
                    costBlocksEl.innerHTML = '';
                    const blocks = [
                        { id: 'tp-total-fuel', label: 'Combustível', icon: 'local_gas_station', value: totFuel },
                        { id: 'tp-total-rental', label: 'Aluguel / Manutenção', icon: 'home_repair_service', value: totRental },
                        { id: 'tp-total-transfers', label: 'Atividades', icon: 'tour', value: totTransfers },
                        { id: 'tp-total-tolls', label: 'Pedágios / Taxas', icon: 'pay', value: totTolls },
                        { id: 'tp-total-accommodation', label: 'Hospedagem', icon: 'hotel', value: totAccommodation },
                        { id: 'tp-total-activities', label: 'Atividades', icon: 'explore', value: totActivities }
                    ];
                    const nonZero = blocks.filter(b => Number(b.value) && Number(b.value) !== 0);
                    if (nonZero.length === 0) {
                        costBlocksEl.innerHTML = '<div class="text-sm text-gray-500">Nenhum custo registrado.</div>';
                    } else {
                        nonZero.forEach(b => {
                            const item = document.createElement('div'); item.className = 'travel-cost-block';
                            const iconSpan = document.createElement('span'); iconSpan.className = 'material-symbols-outlined'; iconSpan.style.fontSize = '20px'; iconSpan.style.color = '#3b82f6'; iconSpan.style.marginBottom = '8px'; iconSpan.textContent = b.icon;
                            const labelDiv = document.createElement('div'); labelDiv.className = 'travel-cost-block-label'; labelDiv.textContent = b.label;
                            const valueDiv = document.createElement('div'); valueDiv.className = 'travel-cost-block-value'; valueDiv.id = b.id; valueDiv.textContent = formatBR(b.value);
                            item.appendChild(iconSpan); item.appendChild(labelDiv); item.appendChild(valueDiv);
                            costBlocksEl.appendChild(item);
                        });
                    }
                }
            } catch (e) { console.error('build cost blocks', e); }

            // Animate/update subtotals and total
            try {
                if (typeof animateKPINumber === 'function') {
                    // animate only targets that exist (created above)
                    ['tp-total-fuel','tp-total-rental','tp-total-transfers','tp-total-tolls','tp-kpi-costs','tp-total-trip','tp-kpi-estimated','tp-kpi-realized','tp-kpi-paid','tp-kpi-remaining'].forEach(id => {
                        const valMap = {
                            'tp-total-fuel': totFuel,
                            'tp-total-rental': totRental,
                            'tp-total-transfers': totTransfers,
                            'tp-total-tolls': totTolls,
                            'tp-kpi-costs': costs,
                            'tp-total-trip': costs,
                            'tp-kpi-estimated': estimated,
                            'tp-kpi-realized': realized,
                            'tp-kpi-paid': paid,
                            'tp-kpi-remaining': remaining
                        };
                        if (document.getElementById(id)) animateKPINumber(id, valMap[id]);
                    });
                } else {
                    if (document.getElementById('tp-total-fuel')) document.getElementById('tp-total-fuel').textContent = formatBR(totFuel);
                    if (document.getElementById('tp-total-rental')) document.getElementById('tp-total-rental').textContent = formatBR(totRental);
                    if (document.getElementById('tp-total-transfers')) document.getElementById('tp-total-transfers').textContent = formatBR(totTransfers);
                    if (document.getElementById('tp-total-tolls')) document.getElementById('tp-total-tolls').textContent = formatBR(totTolls);
                    if (q('tp-total-trip')) q('tp-total-trip').textContent = formatBR(costs);
                    if (tpSummaryCost) tpSummaryCost.textContent = formatBR(estimated);
                    const estEl = document.getElementById('tp-kpi-estimated'); const realEl = document.getElementById('tp-kpi-realized'); const paidEl = document.getElementById('tp-kpi-paid'); const costsEl = document.getElementById('tp-kpi-costs'); const remEl = document.getElementById('tp-kpi-remaining');
                    if (estEl) estEl.textContent = formatBR(estimated);
                    if (realEl) realEl.textContent = formatBR(realized);
                    if (paidEl) paidEl.textContent = formatBR(paid);
                    if (costsEl) costsEl.textContent = formatBR(costs);
                    if (remEl) remEl.textContent = formatBR(remaining);
                }
            } catch(e) { console.error('animate planner numbers', e); }

            // Progress bar: width + color thresholds + percentage display
            try {
                const progEl = document.getElementById('tp-kpi-progress');
                const pctEl = document.getElementById('tp-progress-percentage');
                if (progEl) {
                    const pctRaw = estimated > 0 ? (costs / estimated) * 100 : 0;
                    const pct = estimated > 0 ? Math.min(100, Math.round(pctRaw)) : 0;
                    progEl.style.width = pct + '%';
                    
                    // Update percentage display
                    if (pctEl) {
                        pctEl.textContent = Math.round(pctRaw) + '%';
                        // Color the percentage based on progress
                        if (pctRaw > 100) pctEl.style.color = '#ef4444';
                        else if (pctRaw >= 75) pctEl.style.color = '#f59e0b';
                        else pctEl.style.color = '#10b981';
                    }
                    
                    // set aria / title for accessibility
                    progEl.setAttribute('role', 'progressbar');
                    progEl.setAttribute('aria-valuemin', '0');
                    progEl.setAttribute('aria-valuemax', '100');
                    progEl.setAttribute('aria-valuenow', String(Math.round(pctRaw)));
                    progEl.title = `${Math.round(pctRaw)}% realizado (${formatBR(costs)} de ${formatBR(estimated)})`;
                    
                    // Update gradient color based on progress
                    if (pctRaw > 100) {
                        progEl.style.background = 'linear-gradient(90deg, #ef4444 0%, #f87171 50%, #fca5a5 100%)';
                    } else if (pctRaw >= 75) {
                        progEl.style.background = 'linear-gradient(90deg, #f59e0b 0%, #fbbf24 50%, #fcd34d 100%)';
                    } else {
                        progEl.style.background = 'linear-gradient(90deg, #10b981 0%, #34d399 50%, #6ee7b7 100%)';
                    }
                }
            } catch(e) { console.error('planner progress update', e); }
            // Pre-format displayed plan fields for editing convenience
            try { tpEstimated.value = formatBR(estimated); tpSaved.value = formatBR(Number(plan.saved||0)); } catch(e){}
            
            // ===== ATUALIZAR DASHBOARDS VISUAIS =====
            try {
                // Dashboard do Checklist - VERSÃO DETALHADA
                const checklistItems = plan.checklist || [];
                const totalItems = checklistItems.length;
                const packedItems = checklistItems.filter(c => c.packed).length;
                const pendingItems = totalItems - packedItems;
                
                // Cálculo de pesos detalhado
                const totalWeight = checklistItems.reduce((sum, c) => sum + ((parseFloat(c.weight) || 0) * (parseInt(c.quantity) || 1)), 0);
                const packedWeight = checklistItems.filter(c => c.packed).reduce((sum, c) => sum + ((parseFloat(c.weight) || 0) * (parseInt(c.quantity) || 1)), 0);
                const pendingWeight = totalWeight - packedWeight;
                const avgWeight = totalItems > 0 ? totalWeight / totalItems : 0;
                
                const progressPct = totalItems > 0 ? Math.round((packedItems / totalItems) * 100) : 0;
                
                // Atualizar elementos principais
                const checklistBadge = document.getElementById('tp-checklist-progress-badge');
                const checklistBar = document.getElementById('tp-checklist-progress-bar');
                const checklistPercentage = document.getElementById('tp-checklist-percentage');
                const checklistProgressText = document.getElementById('tp-checklist-progress-text');
                const checklistTotal = document.getElementById('tp-checklist-total');
                const checklistPacked = document.getElementById('tp-checklist-packed');
                const checklistPending = document.getElementById('tp-checklist-pending');
                const checklistWeight = document.getElementById('tp-checklist-weight');
                const checklistPackedWeight = document.getElementById('tp-checklist-packed-weight');
                const checklistPendingWeight = document.getElementById('tp-checklist-pending-weight');
                const checklistWeightAvg = document.getElementById('tp-checklist-weight-avg');
                
                if(checklistBadge) checklistBadge.textContent = `${packedItems}/${totalItems}`;
                if(checklistBar) checklistBar.style.width = progressPct + '%';
                if(checklistPercentage) checklistPercentage.textContent = progressPct + '%';
                if(checklistProgressText && progressPct > 15) checklistProgressText.textContent = progressPct + '%';
                if(checklistTotal) checklistTotal.textContent = totalItems;
                if(checklistPacked) checklistPacked.textContent = packedItems;
                if(checklistPending) checklistPending.textContent = pendingItems;
                if(checklistWeight) checklistWeight.textContent = totalWeight.toFixed(1) + ' kg';
                if(checklistPackedWeight) checklistPackedWeight.textContent = packedWeight.toFixed(1) + ' kg empacotado';
                if(checklistPendingWeight) checklistPendingWeight.textContent = pendingWeight.toFixed(1) + ' kg faltando';
                if(checklistWeightAvg) checklistWeightAvg.textContent = avgWeight.toFixed(2) + ' kg/item';
                
                // Resumo por categorias
                const categoriesEl = document.getElementById('tp-checklist-categories');
                if(categoriesEl) {
                    const categoryStats = {};
                    const categoryNames = {
                        documentos: { name: 'Documentos', icon: 'description', color: 'blue' },
                        roupas: { name: 'Roupas', icon: 'checkroom', color: 'pink' },
                        higiene: { name: 'Higiene', icon: 'soap', color: 'green' },
                        eletronicos: { name: 'Eletrônicos', icon: 'devices', color: 'purple' },
                        medicamentos: { name: 'Medicamentos', icon: 'medication', color: 'red' },
                        acessorios: { name: 'Acessórios', icon: 'shopping_bag', color: 'orange' },
                        outros: { name: 'Outros', icon: 'more_horiz', color: 'gray' }
                    };
                    
                    checklistItems.forEach(item => {
                        const cat = item.category || 'outros';
                        if(!categoryStats[cat]) categoryStats[cat] = { total: 0, packed: 0, weight: 0 };
                        categoryStats[cat].total++;
                        if(item.packed) categoryStats[cat].packed++;
                        categoryStats[cat].weight += (parseFloat(item.weight) || 0) * (parseInt(item.quantity) || 1);
                    });
                    
                    categoriesEl.innerHTML = '';
                    Object.keys(categoryStats).forEach(catKey => {
                        const cat = categoryStats[catKey];
                        const info = categoryNames[catKey] || categoryNames.outros;
                        const catPct = cat.total > 0 ? Math.round((cat.packed / cat.total) * 100) : 0;
                        
                        const catEl = document.createElement('div');
                        catEl.className = 'text-xs p-2 bg-gray-50 rounded border border-gray-200';
                        catEl.innerHTML = `
                            <div class="flex items-center gap-1 mb-1">
                                <span class="material-symbols-outlined text-${info.color}-600" style="font-size:14px">${info.icon}</span>
                                <span class="font-semibold text-gray-700">${info.name}</span>
                            </div>
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-gray-600">${cat.packed}/${cat.total}</span>
                                <span class="font-bold text-${info.color}-600">${catPct}%</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">${cat.weight.toFixed(1)} kg</div>
                        `;
                        categoriesEl.appendChild(catEl);
                    });
                    
                    if(Object.keys(categoryStats).length === 0) {
                        categoriesEl.innerHTML = '<div class="text-xs text-gray-500 col-span-full text-center py-2">Nenhum item no checklist</div>';
                    }
                }
                
                // Dashboard do Roteiro
                const accommodations = plan.accommodations || [];
                const activities = plan.activities || [];
                const transports = plan.transports || [];
                const manualItinerary = plan.itinerary || [];
                
                const totalEvents = (accommodations.length * 2) + activities.length + manualItinerary.length;
                
                const itineraryBadge = document.getElementById('tp-itinerary-badge');
                const itineraryAccommodations = document.getElementById('tp-itinerary-accommodations');
                const itineraryActivities = document.getElementById('tp-itinerary-activities');
                const itineraryTransports = document.getElementById('tp-itinerary-transports');
                const itineraryManual = document.getElementById('tp-itinerary-manual');
                
                if(itineraryBadge) itineraryBadge.textContent = `${totalEvents} eventos`;
                if(itineraryAccommodations) itineraryAccommodations.textContent = accommodations.length;
                if(itineraryActivities) itineraryActivities.textContent = activities.length;
                if(itineraryTransports) itineraryTransports.textContent = transports.length;
                if(itineraryManual) itineraryManual.textContent = manualItinerary.length;
                
                // Timeline compacta do roteiro (próximos 3 eventos)
                const timelineEl = document.getElementById('tp-itinerary-timeline');
                if(timelineEl) {
                    timelineEl.innerHTML = '';
                    const allEvents = [];
                    
                    accommodations.forEach(acc => {
                        if(acc.checkin) allEvents.push({ date: acc.checkin, time: '14:00', title: `Check-in: ${acc.name}`, icon: 'hotel', color: 'pink' });
                    });
                    activities.forEach(act => {
                        if(act.date) allEvents.push({ date: act.date, time: act.time || '09:00', title: act.name, icon: 'tour', color: 'purple' });
                    });
                    manualItinerary.forEach(it => {
                        if(it.date) allEvents.push({ date: it.date, time: it.time || '00:00', title: it.activity, icon: 'event', color: 'green' });
                    });
                    
                    allEvents.sort((a, b) => {
                        const dateA = new Date(a.date + ' ' + a.time);
                        const dateB = new Date(b.date + ' ' + b.time);
                        return dateA - dateB;
                    });
                    
                    const nextEvents = allEvents.slice(0, 3);
                    if(nextEvents.length === 0) {
                        timelineEl.innerHTML = '<div class="text-xs text-gray-500 text-center py-2">Nenhum evento agendado</div>';
                    } else {
                        nextEvents.forEach(evt => {
                            const item = document.createElement('div');
                            item.className = `flex items-center gap-2 p-2 bg-white rounded border border-${evt.color}-200 text-xs`;
                            const d = new Date(evt.date + 'T00:00:00');
                            const dateStr = d.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                            item.innerHTML = `<span class="material-symbols-outlined text-${evt.color}-600" style="font-size:16px">${evt.icon}</span><span class="font-semibold text-gray-700">${dateStr}</span><span class="text-gray-600">${evt.time}</span><span class="flex-1 truncate text-gray-800">${escapeHtml(evt.title)}</span>`;
                            timelineEl.appendChild(item);
                        });
                    }
                }
            } catch(e) { console.error('update dashboards', e); }
        } catch(e){ console.error('renderPlanDetails', e); } }

        // Attach currency handlers for planner money fields and basic validation
        function attachPlannerCurrencyAndValidation() {
            try {
                const moneyIds = ['tp-transport-fuelprice','tp-transport-tolls','tp-transport-rental','tp-transport-maint','tp-transport-transfers','tp-modal-estimated','tp-modal-saved','tp-accommodation-price','tp-activity-price','tp-checklist-weight'];
                moneyIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    if (el._plannerCurrencyAttached) return; el._plannerCurrencyAttached = true;
                    el.addEventListener('focus', function(){ const n = parseBRNumber(this.value); if (Number.isFinite(n) && !isNaN(n) && n !== 0) this.value = (n%1===0?String(n):String(n)); else this.value = ''; });
                    el.addEventListener('input', function(){ this.value = this.value.replace(/[^0-9,\.\-\s\u00A0]/g,''); });
                    el.addEventListener('blur', function(){ const n = parseBRNumber(this.value); if (Number.isFinite(n) && !isNaN(n)) this.value = formatBR(n); else this.value = ''; });
                });
            } catch(e) { console.error('attachPlannerCurrencyAndValidation', e); }
        }

        // Simple inline validation for transport form fields
        function validateTransportForm() {
            let ok = true;
            try {
                // clear all errors
                ['tp-transport-distance','tp-transport-efficiency','tp-transport-fuelprice','tp-transport-tolls','tp-transport-rental','tp-transport-maint','tp-transport-transfers'].forEach(id=> showFieldError(id, ''));
                const dist = parseBRNumber(tDist.value); const eff = parseBRNumber(tEff.value); const fuelP = parseBRNumber(tFuelP.value);
                if (!dist || dist <= 0) { showFieldError('tp-transport-distance','Informe distância válida'); ok = false; }
                if (!eff || eff <= 0) { showFieldError('tp-transport-efficiency','Informe eficiência (km/L) válida'); ok = false; }
                if (!fuelP || fuelP <= 0) { showFieldError('tp-transport-fuelprice','Informe preço combustível válido'); ok = false; }
            } catch(e){ console.error('validateTransportForm', e); ok = false; }
            return ok;
        }

        // Focus trap for travel planner modal
        function trapFocusForPlanner(e) {
            try {
                if (!modal || !modal.open) return; const focusable = modal.querySelectorAll('a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'); if (!focusable.length) return; const first = focusable[0]; const last = focusable[focusable.length-1]; if (e.key === 'Tab') { if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); } else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); } } else if (e.key === 'Escape') { e.preventDefault(); closeModal(); }
            } catch(e){}
        }

        // ===== CRIAR TRANSAÇÕES FINANCEIRAS A PARTIR DO PLANO =====
        
        // Labels para tipos (usados na criação de despesas)
        // Expostos globalmente para serem acessíveis nos event handlers
        window.transportTypeLabels = {
            'carro': 'Carro/Moto',
            'voo': 'Voo',
            'aluguel': 'Aluguel de Carro',
            'uber': 'Uber/Taxi',
            'publico': 'Transporte Público'
        };
        
        window.accommodationTypeLabels = {
            'hotel': 'Hotel/Hostel',
            'airbnb': 'Airbnb',
            'reserva': 'Reserva'
        };
        
        window.activityLabels = {
            'passeio': 'Passeio Turístico',
            'ingresso': 'Ingresso/Show',
            'evento': 'Evento',
            'compras': 'Compras',
            'restaurante': 'Restaurante',
            'experiencia': 'Experiência',
            'esporte': 'Esporte/Aventura',
            'cultura': 'Cultura',
            'natureza': 'Natureza',
            'diversao': 'Diversão'
        };
        
        async function createExpenseFromTransport(planId, transportId) {
            try {
                const plans = loadTravelPlans();
                const plan = plans.find(p => p.id === planId);
                if (!plan) return;
                
                const transport = (plan.transports || []).find(t => t.id === transportId);
                if (!transport) return;
                
                // Descrição do transporte (Nome do Destino)
                const typeLabel = window.transportTypeLabels[transport.type] || transport.type;
                
                // Abrir modal de transação preenchido
                await openExpenseModalFromTravelItem({
                    description: `${typeLabel} (${plan.destination})`,
                    amount: transport.subtotal || 0,
                    category: 'Transporte',
                    date: plan.date,
                    linkedTo: { planId, itemType: 'transport', itemId: transportId }
                });
            } catch(e) {
                console.error('createExpenseFromTransport', e);
                showToast('Erro ao criar despesa', 'bg-red-600');
            }
        }
        
        async function createExpenseFromAccommodation(planId, accommodationId) {
            try {
                const plans = loadTravelPlans();
                const plan = plans.find(p => p.id === planId);
                if (!plan) return;
                
                const accommodation = (plan.accommodations || []).find(a => a.id === accommodationId);
                if (!accommodation) return;
                
                // Nome do estabelecimento (Nome do Destino)
                await openExpenseModalFromTravelItem({
                    description: `${accommodation.name} (${plan.destination})`,
                    amount: accommodation.total || 0,
                    category: 'Viagem',
                    date: accommodation.checkin || plan.date,
                    linkedTo: { planId, itemType: 'accommodation', itemId: accommodationId }
                });
            } catch(e) {
                console.error('createExpenseFromAccommodation', e);
                showToast('Erro ao criar despesa', 'bg-red-600');
            }
        }
        async function createExpenseFromActivity(planId, activityId) {
            try {
                const plans = loadTravelPlans();
                const plan = plans.find(p => p.id === planId);
                if (!plan) return;
                
                const activity = (plan.activities || []).find(a => a.id === activityId);
                if (!activity) return;
                
                // Nome da Atividade (Nome do Destino)
                await openExpenseModalFromTravelItem({
                    description: `${activity.name} (${plan.destination})`,
                    amount: activity.price || 0,
                    category: 'Compras',
                    date: activity.date || plan.date,
                    linkedTo: { planId, itemType: 'activity', itemId: activityId }
                });
            } catch(e) {
                console.error('createExpenseFromActivity', e);
                showToast('Erro ao criar despesa', 'bg-red-600');
            }
        }
        
        // Função auxiliar para abrir modal de transação com dados preenchidos
        async function openExpenseModalFromTravelItem(data) {
            try {
                // Verificar se já existe transação vinculada
                const existingTransaction = findLinkedTransaction(data.linkedTo);
                if (existingTransaction) {
                    showToast('Já existe uma despesa vinculada a este item', 'bg-yellow-600');
                    return;
                }
                
                // Fechar modal do travel planner
                closeModal();
                
                // Aguardar um momento para o modal fechar
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Abrir modal de transação
                if (typeof openTransactionModal === 'function') {
                    openTransactionModal('expenses');
                    
                    // Aguardar modal abrir
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    // Preencher campos
                    const descField = document.getElementById('description');
                    const amountField = document.getElementById('amount');
                    const categoryField = document.getElementById('category-expense');
                    const dateField = document.getElementById('date');
                    
                    if (descField) descField.value = data.description || '';
                    if (amountField) amountField.value = data.amount || 0;
                    if (categoryField && data.category) categoryField.value = data.category;
                    if (dateField && data.date) dateField.value = data.date;
                    
                    // Armazenar vínculo temporário para salvar depois
                    window._tempTravelLink = data.linkedTo;
                    
                    showToast('Preencha os detalhes e salve a despesa', 'bg-blue-600');
                } else {
                    showToast('Módulo de transações não disponível', 'bg-red-600');
                }
            } catch(e) {
                console.error('openExpenseModalFromTravelItem', e);
                showToast('Erro ao abrir modal de despesa', 'bg-red-600');
            }
        }
        
        // Verificar se já existe transação vinculada
        function findLinkedTransaction(linkedTo) {
            try {
                if (!window.state || !window.state.appData || !window.state.appData.data) return null;
                
                const data = window.state.appData.data;
                for (const year in data) {
                    for (const month in data[year]) {
                        const expenses = data[year][month].expenses || [];
                        const found = expenses.find(e => 
                            e.travelLink && 
                            e.travelLink.planId === linkedTo.planId && 
                            e.travelLink.itemId === linkedTo.itemId
                        );
                        if (found) return found;
                    }
                }
                return null;
            } catch(e) {
                return null;
            }
        }

        // Seed helper for demo plan
        window.seedTravelPlanner = async function(){ try {
            const plans = loadTravelPlans(); const id = 'seed-'+Math.random().toString(36).slice(2,8); const plan = { id, destination: 'Gramado, RS', date: new Date().toISOString().slice(0,10), estimated: 2000, saved: 250, transports: [{ id: id+'-t1', type:'car', description:'Aluguel 3 dias', distance:300, efficiency:12.5, fuelPrice:5.79, tolls:60, rental:350, maint:0, transfers:0, fuelLiters:24, fuelCost:24*5.79, subtotal:24*5.79+60+350 }] };
            plans.unshift(plan); await saveTravelPlans(plans); showToast('Plano de exemplo criado', 'bg-green-600'); renderPlansList(); renderPlanDetails(plan.id);
        } catch(e){ console.error('seedTravelPlanner', e); showToast('Falha ao criar plano de exemplo','bg-red-600'); }};

        // Wire planner helpers after DOM ready
        document.addEventListener('DOMContentLoaded', async function(){ 
            attachPlannerCurrencyAndValidation(); 
            // Executar migração automática ao carregar
            await migrateTravelPlanValues();
            try { document.addEventListener('keydown', trapFocusForPlanner); } catch(e){} 
        });

        // When modal opens, ensure plans are listed
        document.addEventListener('DOMContentLoaded', function(){ renderPlansList();
            // expose API for legacy callers
            window.tp = window.tp || {};
            window.tp.renderPlansList = renderPlansList;
            window.tp.renderPlanDetails = renderPlanDetails;
            window.tp.saveTravelPlans = saveTravelPlans;
        });
    })();
    </script>

    <!-- ===== MICROINTERAÇÕES E MELHORIAS UX ===== -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Intersection Observer para animações de entrada
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver(function(entries) {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);

        // Animar elementos quando entram na viewport
        function initScrollAnimations() {
            const animatedElements = document.querySelectorAll('.animate-slide-up, .animate-fade-in, .animate-scale-in');
            animatedElements.forEach(el => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(20px)';
                el.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
                observer.observe(el);
            });
        }

        // Melhorar feedback dos botões
        function enhanceButtonFeedback() {
            const buttons = document.querySelectorAll('.modern-btn, .kpi-card, .modern-card');
            buttons.forEach(button => {
                button.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                });
                
                button.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
                
                button.addEventListener('mousedown', function() {
                    this.style.transform = 'translateY(0) scale(0.98)';
                });
                
                button.addEventListener('mouseup', function() {
                    this.style.transform = 'translateY(-2px) scale(1)';
                });
            });
        }

        // Animação de números (contadores)
        function animateNumbers() {
            const numbers = document.querySelectorAll('.kpi-value');
            numbers.forEach(numberEl => {
                const observer = new IntersectionObserver(function(entries) {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const text = entry.target.textContent;
                            const matches = text.match(/[\d.,]+/);
                            if (matches) {
                                const numStr = matches[0].replace(/[.,]/g, '');
                                const targetNum = parseInt(numStr);
                                if (!isNaN(targetNum) && targetNum > 0) {
                                    animateCounter(entry.target, 0, targetNum, text);
                                }
                            }
                            observer.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.5 });
                
                observer.observe(numberEl);
            });
        }

        function animateCounter(element, start, end, originalText) {
            const duration = 1500;
            const increment = end / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= end) {
                    current = end;
                    clearInterval(timer);
                }
                
                // Manter formato original
                const formattedValue = originalText.replace(/[\d.,]+/, Math.floor(current).toLocaleString('pt-BR'));
                element.textContent = formattedValue;
            }, 16);
        }

        // Melhorar experiência de loading
        function enhanceLoadingStates() {
            // Adicionar skeleton loading para tabelas
            const tables = document.querySelectorAll('.modern-table tbody');
            tables.forEach(tbody => {
                if (tbody.children.length === 0) {
                    const skeletonRows = 3;
                    for (let i = 0; i < skeletonRows; i++) {
                        const tr = document.createElement('tr');
                        const td = document.createElement('td');
                        td.colSpan = 6;
                        td.innerHTML = '<div class="loading-shimmer h-4 rounded"></div>';
                        tr.appendChild(td);
                        tbody.appendChild(tr);
                    }
                }
            });
        }

        // Toast notifications melhoradas
        function enhanceToasts() {
            const originalShowToast = window.showToast;
            if (originalShowToast) {
                window.showToast = function(message, bgClass = 'bg-gray-800') {
                    // Criar toast moderno
                    const toast = document.createElement('div');
                    toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg text-white shadow-lg transform translate-x-full transition-transform duration-300 ${bgClass}`;
                    toast.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined">check_circle</span>
                            <span>${message}</span>
                        </div>
                    `;
                    
                    document.body.appendChild(toast);
                    
                    // Animar entrada
                    setTimeout(() => {
                        toast.style.transform = 'translateX(0)';
                    }, 100);
                    
                    // Auto remover
                    setTimeout(() => {
                        toast.style.transform = 'translateX(full)';
                        setTimeout(() => toast.remove(), 300);
                    }, 3000);
                };
            }
        }

        // Smooth scroll para links internos
        function enhanceSmoothScroll() {
            const links = document.querySelectorAll('a[href^="#"]');
            links.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
        }

        // Melhorar acessibilidade do teclado
        function enhanceKeyboardNavigation() {
            // Adicionar navegação por teclado para cards clicáveis
            const clickableCards = document.querySelectorAll('.kpi-card, .modern-card[onclick], .modern-card[data-click]');
            clickableCards.forEach(card => {
                card.setAttribute('tabindex', '0');
                card.setAttribute('role', 'button');
                
                card.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
            });
        }

        // Detectar se é mobile para ajustes específicos
        function isMobile() {
            return window.innerWidth <= 768;
        }

        // Melhorar performance em mobile
        function optimizeForMobile() {
            if (isMobile()) {
                // Reduzir animações complexas
                document.documentElement.style.setProperty('--transition-normal', '200ms ease');
                document.documentElement.style.setProperty('--transition-slow', '300ms ease');
                
                // Adicionar classe para CSS específico de mobile
                document.body.classList.add('mobile-device');
            }
        }

        // Adicionar estados de hover para touch devices
        function enhanceTouchSupport() {
            if ('ontouchstart' in window) {
                document.body.classList.add('touch-device');
                
                // Simular hover em dispositivos touch
                const hoverElements = document.querySelectorAll('.modern-btn, .kpi-card, .modern-card');
                hoverElements.forEach(el => {
                    el.addEventListener('touchstart', function() {
                        this.classList.add('touch-hover');
                    });
                    
                    el.addEventListener('touchend', function() {
                        setTimeout(() => {
                            this.classList.remove('touch-hover');
                        }, 300);
                    });
                });
            }
        }

        // Inicializar todas as melhorias
        try {
            initScrollAnimations();
            enhanceButtonFeedback();
            animateNumbers();
            enhanceLoadingStates();
            enhanceToasts();
            enhanceSmoothScroll();
            enhanceKeyboardNavigation();
            optimizeForMobile();
            enhanceTouchSupport();
        } catch (error) {
            console.warn('Erro ao inicializar melhorias UX:', error);
        }

        // Re-aplicar melhorias quando o DOM for atualizado (para conteúdo dinâmico)
        const domObserver = new MutationObserver(function(mutations) {
            let shouldReapply = false;
            mutations.forEach(mutation => {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === Node.ELEMENT_NODE && 
                            (node.classList?.contains('kpi-card') || 
                             node.classList?.contains('modern-card') || 
                             node.classList?.contains('modern-btn'))) {
                            shouldReapply = true;
                        }
                    });
                }
            });
            
            if (shouldReapply) {
                setTimeout(() => {
                    initScrollAnimations();
                    enhanceButtonFeedback();
                    enhanceKeyboardNavigation();
                }, 100);
            }
        });

        domObserver.observe(document.body, {
            childList: true,
            subtree: true
        });
    });
    </script>
</body>
</html>
